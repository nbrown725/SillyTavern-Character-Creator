import*as e from"../../../../power-user.js";import*as t from"../../../../../script.js";import*as n from"../../../../world-info.js";import*as r from"../../../../instruct-mode.js";import*as o from"../../../../chats.js";import*as i from"../../../../openai.js";import*as a from"../../../../authors-note.js";import*as s from"../../../../group-chats.js";import*as l from"../../../regex/engine.js";import*as c from"../../../../utils.js";import*as u from"../../../../slash-commands/SlashCommandCommonEnumsProvider.js";var p={639:(e,t,n)=>{function r(e){return e&&e.__esModule?e:{default:e}}t.__esModule=!0;var o=r(n(261)),i=r(n(919)),a=n(27),s=n(127),l=r(n(727)),c=r(n(350)),u=r(n(148)),p=o.default.create;function h(){var e=p();return e.compile=function(t,n){return s.compile(t,n,e)},e.precompile=function(t,n){return s.precompile(t,n,e)},e.AST=i.default,e.Compiler=s.Compiler,e.JavaScriptCompiler=l.default,e.Parser=a.parser,e.parse=a.parse,e.parseWithoutProcessing=a.parseWithoutProcessing,e}var d=h();d.create=h,u.default(d),d.Visitor=c.default,d.default=d,t.default=d,e.exports=t.default},261:(e,t,n)=>{function r(e){return e&&e.__esModule?e:{default:e}}function o(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}t.__esModule=!0;var i=o(n(871)),a=r(n(613)),s=r(n(769)),l=o(n(849)),c=o(n(624)),u=r(n(148));function p(){var e=new i.HandlebarsEnvironment;return l.extend(e,i),e.SafeString=a.default,e.Exception=s.default,e.Utils=l,e.escapeExpression=l.escapeExpression,e.VM=c,e.template=function(t){return c.template(t,e)},e}var h=p();h.create=p,u.default(h),h.default=h,t.default=h,e.exports=t.default},871:(e,t,n)=>{function r(e){return e&&e.__esModule?e:{default:e}}t.__esModule=!0,t.HandlebarsEnvironment=p;var o=n(849),i=r(n(769)),a=n(277),s=n(940),l=r(n(566)),c=n(865);t.VERSION="4.7.8";t.COMPILER_REVISION=8;t.LAST_COMPATIBLE_COMPILER_REVISION=7;t.REVISION_CHANGES={1:"<= 1.0.rc.2",2:"== 1.0.0-rc.3",3:"== 1.0.0-rc.4",4:"== 1.x.x",5:"== 2.0.0-alpha.x",6:">= 2.0.0-beta.1",7:">= 4.0.0 <4.3.0",8:">= 4.3.0"};var u="[object Object]";function p(e,t,n){this.helpers=e||{},this.partials=t||{},this.decorators=n||{},a.registerDefaultHelpers(this),s.registerDefaultDecorators(this)}p.prototype={constructor:p,logger:l.default,log:l.default.log,registerHelper:function(e,t){if(o.toString.call(e)===u){if(t)throw new i.default("Arg not supported with multiple helpers");o.extend(this.helpers,e)}else this.helpers[e]=t},unregisterHelper:function(e){delete this.helpers[e]},registerPartial:function(e,t){if(o.toString.call(e)===u)o.extend(this.partials,e);else{if(void 0===t)throw new i.default('Attempting to register a partial called "'+e+'" as undefined');this.partials[e]=t}},unregisterPartial:function(e){delete this.partials[e]},registerDecorator:function(e,t){if(o.toString.call(e)===u){if(t)throw new i.default("Arg not supported with multiple decorators");o.extend(this.decorators,e)}else this.decorators[e]=t},unregisterDecorator:function(e){delete this.decorators[e]},resetLoggedPropertyAccesses:function(){c.resetLoggedProperties()}};var h=l.default.log;t.log=h,t.createFrame=o.createFrame,t.logger=l.default},919:(e,t)=>{t.__esModule=!0;var n={helpers:{helperExpression:function(e){return"SubExpression"===e.type||("MustacheStatement"===e.type||"BlockStatement"===e.type)&&!!(e.params&&e.params.length||e.hash)},scopedId:function(e){return/^\.|this\b/.test(e.original)},simpleId:function(e){return 1===e.parts.length&&!n.helpers.scopedId(e)&&!e.depth}}};t.default=n,e.exports=t.default},27:(e,t,n)=>{function r(e){return e&&e.__esModule?e:{default:e}}t.__esModule=!0,t.parseWithoutProcessing=c,t.parse=function(e,t){var n=c(e,t);return new i.default(t).accept(n)};var o=r(n(201)),i=r(n(915)),a=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(n(425)),s=n(849);t.parser=o.default;var l={};function c(e,t){return"Program"===e.type?e:(o.default.yy=l,l.locInfo=function(e){return new l.SourceLocation(t&&t.srcName,e)},o.default.parse(e))}s.extend(l,a)},632:(e,t,n)=>{t.__esModule=!0;var r=n(849),o=void 0;try{}catch(e){}function i(e,t,n){if(r.isArray(e)){for(var o=[],i=0,a=e.length;i<a;i++)o.push(t.wrap(e[i],n));return o}return"boolean"==typeof e||"number"==typeof e?e+"":e}function a(e){this.srcFile=e,this.source=[]}o||((o=function(e,t,n,r){this.src="",r&&this.add(r)}).prototype={add:function(e){r.isArray(e)&&(e=e.join("")),this.src+=e},prepend:function(e){r.isArray(e)&&(e=e.join("")),this.src=e+this.src},toStringWithSourceMap:function(){return{code:this.toString()}},toString:function(){return this.src}}),a.prototype={isEmpty:function(){return!this.source.length},prepend:function(e,t){this.source.unshift(this.wrap(e,t))},push:function(e,t){this.source.push(this.wrap(e,t))},merge:function(){var e=this.empty();return this.each((function(t){e.add(["  ",t,"\n"])})),e},each:function(e){for(var t=0,n=this.source.length;t<n;t++)e(this.source[t])},empty:function(){var e=this.currentLocation||{start:{}};return new o(e.start.line,e.start.column,this.srcFile)},wrap:function(e){var t=arguments.length<=1||void 0===arguments[1]?this.currentLocation||{start:{}}:arguments[1];return e instanceof o?e:(e=i(e,this,t),new o(t.start.line,t.start.column,this.srcFile,e))},functionCall:function(e,t,n){return n=this.generateList(n),this.wrap([e,t?"."+t+"(":"(",n,")"])},quotedString:function(e){return'"'+(e+"").replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")+'"'},objectLiteral:function(e){var t=this,n=[];Object.keys(e).forEach((function(r){var o=i(e[r],t);"undefined"!==o&&n.push([t.quotedString(r),":",o])}));var r=this.generateList(n);return r.prepend("{"),r.add("}"),r},generateList:function(e){for(var t=this.empty(),n=0,r=e.length;n<r;n++)n&&t.add(","),t.add(i(e[n],this));return t},generateArray:function(e){var t=this.generateList(e);return t.prepend("["),t.add("]"),t}},t.default=a,e.exports=t.default},127:(e,t,n)=>{function r(e){return e&&e.__esModule?e:{default:e}}t.__esModule=!0,t.Compiler=l,t.precompile=function(e,t,n){if(null==e||"string"!=typeof e&&"Program"!==e.type)throw new o.default("You must pass a string or Handlebars AST to Handlebars.precompile. You passed "+e);"data"in(t=t||{})||(t.data=!0);t.compat&&(t.useDepths=!0);var r=n.parse(e,t),i=(new n.Compiler).compile(r,t);return(new n.JavaScriptCompiler).compile(i,t)},t.compile=function(e,t,n){void 0===t&&(t={});if(null==e||"string"!=typeof e&&"Program"!==e.type)throw new o.default("You must pass a string or Handlebars AST to Handlebars.compile. You passed "+e);"data"in(t=i.extend({},t))||(t.data=!0);t.compat&&(t.useDepths=!0);var r=void 0;function a(){var r=n.parse(e,t),o=(new n.Compiler).compile(r,t),i=(new n.JavaScriptCompiler).compile(o,t,void 0,!0);return n.template(i)}function s(e,t){return r||(r=a()),r.call(this,e,t)}return s._setup=function(e){return r||(r=a()),r._setup(e)},s._child=function(e,t,n,o){return r||(r=a()),r._child(e,t,n,o)},s};var o=r(n(769)),i=n(849),a=r(n(919)),s=[].slice;function l(){}function c(e,t){if(e===t)return!0;if(i.isArray(e)&&i.isArray(t)&&e.length===t.length){for(var n=0;n<e.length;n++)if(!c(e[n],t[n]))return!1;return!0}}function u(e){if(!e.path.parts){var t=e.path;e.path={type:"PathExpression",data:!1,depth:0,parts:[t.original+""],original:t.original+"",loc:t.loc}}}l.prototype={compiler:l,equals:function(e){var t=this.opcodes.length;if(e.opcodes.length!==t)return!1;for(var n=0;n<t;n++){var r=this.opcodes[n],o=e.opcodes[n];if(r.opcode!==o.opcode||!c(r.args,o.args))return!1}t=this.children.length;for(n=0;n<t;n++)if(!this.children[n].equals(e.children[n]))return!1;return!0},guid:0,compile:function(e,t){return this.sourceNode=[],this.opcodes=[],this.children=[],this.options=t,this.stringParams=t.stringParams,this.trackIds=t.trackIds,t.blockParams=t.blockParams||[],t.knownHelpers=i.extend(Object.create(null),{helperMissing:!0,blockHelperMissing:!0,each:!0,if:!0,unless:!0,with:!0,log:!0,lookup:!0},t.knownHelpers),this.accept(e)},compileProgram:function(e){var t=(new this.compiler).compile(e,this.options),n=this.guid++;return this.usePartial=this.usePartial||t.usePartial,this.children[n]=t,this.useDepths=this.useDepths||t.useDepths,n},accept:function(e){if(!this[e.type])throw new o.default("Unknown type: "+e.type,e);this.sourceNode.unshift(e);var t=this[e.type](e);return this.sourceNode.shift(),t},Program:function(e){this.options.blockParams.unshift(e.blockParams);for(var t=e.body,n=t.length,r=0;r<n;r++)this.accept(t[r]);return this.options.blockParams.shift(),this.isSimple=1===n,this.blockParams=e.blockParams?e.blockParams.length:0,this},BlockStatement:function(e){u(e);var t=e.program,n=e.inverse;t=t&&this.compileProgram(t),n=n&&this.compileProgram(n);var r=this.classifySexpr(e);"helper"===r?this.helperSexpr(e,t,n):"simple"===r?(this.simpleSexpr(e),this.opcode("pushProgram",t),this.opcode("pushProgram",n),this.opcode("emptyHash"),this.opcode("blockValue",e.path.original)):(this.ambiguousSexpr(e,t,n),this.opcode("pushProgram",t),this.opcode("pushProgram",n),this.opcode("emptyHash"),this.opcode("ambiguousBlockValue")),this.opcode("append")},DecoratorBlock:function(e){var t=e.program&&this.compileProgram(e.program),n=this.setupFullMustacheParams(e,t,void 0),r=e.path;this.useDecorators=!0,this.opcode("registerDecorator",n.length,r.original)},PartialStatement:function(e){this.usePartial=!0;var t=e.program;t&&(t=this.compileProgram(e.program));var n=e.params;if(n.length>1)throw new o.default("Unsupported number of partial arguments: "+n.length,e);n.length||(this.options.explicitPartialContext?this.opcode("pushLiteral","undefined"):n.push({type:"PathExpression",parts:[],depth:0}));var r=e.name.original,i="SubExpression"===e.name.type;i&&this.accept(e.name),this.setupFullMustacheParams(e,t,void 0,!0);var a=e.indent||"";this.options.preventIndent&&a&&(this.opcode("appendContent",a),a=""),this.opcode("invokePartial",i,r,a),this.opcode("append")},PartialBlockStatement:function(e){this.PartialStatement(e)},MustacheStatement:function(e){this.SubExpression(e),e.escaped&&!this.options.noEscape?this.opcode("appendEscaped"):this.opcode("append")},Decorator:function(e){this.DecoratorBlock(e)},ContentStatement:function(e){e.value&&this.opcode("appendContent",e.value)},CommentStatement:function(){},SubExpression:function(e){u(e);var t=this.classifySexpr(e);"simple"===t?this.simpleSexpr(e):"helper"===t?this.helperSexpr(e):this.ambiguousSexpr(e)},ambiguousSexpr:function(e,t,n){var r=e.path,o=r.parts[0],i=null!=t||null!=n;this.opcode("getContext",r.depth),this.opcode("pushProgram",t),this.opcode("pushProgram",n),r.strict=!0,this.accept(r),this.opcode("invokeAmbiguous",o,i)},simpleSexpr:function(e){var t=e.path;t.strict=!0,this.accept(t),this.opcode("resolvePossibleLambda")},helperSexpr:function(e,t,n){var r=this.setupFullMustacheParams(e,t,n),i=e.path,s=i.parts[0];if(this.options.knownHelpers[s])this.opcode("invokeKnownHelper",r.length,s);else{if(this.options.knownHelpersOnly)throw new o.default("You specified knownHelpersOnly, but used the unknown helper "+s,e);i.strict=!0,i.falsy=!0,this.accept(i),this.opcode("invokeHelper",r.length,i.original,a.default.helpers.simpleId(i))}},PathExpression:function(e){this.addDepth(e.depth),this.opcode("getContext",e.depth);var t=e.parts[0],n=a.default.helpers.scopedId(e),r=!e.depth&&!n&&this.blockParamIndex(t);r?this.opcode("lookupBlockParam",r,e.parts):t?e.data?(this.options.data=!0,this.opcode("lookupData",e.depth,e.parts,e.strict)):this.opcode("lookupOnContext",e.parts,e.falsy,e.strict,n):this.opcode("pushContext")},StringLiteral:function(e){this.opcode("pushString",e.value)},NumberLiteral:function(e){this.opcode("pushLiteral",e.value)},BooleanLiteral:function(e){this.opcode("pushLiteral",e.value)},UndefinedLiteral:function(){this.opcode("pushLiteral","undefined")},NullLiteral:function(){this.opcode("pushLiteral","null")},Hash:function(e){var t=e.pairs,n=0,r=t.length;for(this.opcode("pushHash");n<r;n++)this.pushParam(t[n].value);for(;n--;)this.opcode("assignToHash",t[n].key);this.opcode("popHash")},opcode:function(e){this.opcodes.push({opcode:e,args:s.call(arguments,1),loc:this.sourceNode[0].loc})},addDepth:function(e){e&&(this.useDepths=!0)},classifySexpr:function(e){var t=a.default.helpers.simpleId(e.path),n=t&&!!this.blockParamIndex(e.path.parts[0]),r=!n&&a.default.helpers.helperExpression(e),o=!n&&(r||t);if(o&&!r){var i=e.path.parts[0],s=this.options;s.knownHelpers[i]?r=!0:s.knownHelpersOnly&&(o=!1)}return r?"helper":o?"ambiguous":"simple"},pushParams:function(e){for(var t=0,n=e.length;t<n;t++)this.pushParam(e[t])},pushParam:function(e){var t=null!=e.value?e.value:e.original||"";if(this.stringParams)t.replace&&(t=t.replace(/^(\.?\.\/)*/g,"").replace(/\//g,".")),e.depth&&this.addDepth(e.depth),this.opcode("getContext",e.depth||0),this.opcode("pushStringParam",t,e.type),"SubExpression"===e.type&&this.accept(e);else{if(this.trackIds){var n=void 0;if(!e.parts||a.default.helpers.scopedId(e)||e.depth||(n=this.blockParamIndex(e.parts[0])),n){var r=e.parts.slice(1).join(".");this.opcode("pushId","BlockParam",n,r)}else(t=e.original||t).replace&&(t=t.replace(/^this(?:\.|$)/,"").replace(/^\.\//,"").replace(/^\.$/,"")),this.opcode("pushId",e.type,t)}this.accept(e)}},setupFullMustacheParams:function(e,t,n,r){var o=e.params;return this.pushParams(o),this.opcode("pushProgram",t),this.opcode("pushProgram",n),e.hash?this.accept(e.hash):this.opcode("emptyHash",r),o},blockParamIndex:function(e){for(var t=0,n=this.options.blockParams.length;t<n;t++){var r=this.options.blockParams[t],o=r&&i.indexOf(r,e);if(r&&o>=0)return[t,o]}}}},425:(e,t,n)=>{t.__esModule=!0,t.SourceLocation=function(e,t){this.source=e,this.start={line:t.first_line,column:t.first_column},this.end={line:t.last_line,column:t.last_column}},t.id=function(e){return/^\[.*\]$/.test(e)?e.substring(1,e.length-1):e},t.stripFlags=function(e,t){return{open:"~"===e.charAt(2),close:"~"===t.charAt(t.length-3)}},t.stripComment=function(e){return e.replace(/^\{\{~?!-?-?/,"").replace(/-?-?~?\}\}$/,"")},t.preparePath=function(e,t,n){n=this.locInfo(n);for(var r=e?"@":"",o=[],a=0,s=0,l=t.length;s<l;s++){var c=t[s].part,u=t[s].original!==c;if(r+=(t[s].separator||"")+c,u||".."!==c&&"."!==c&&"this"!==c)o.push(c);else{if(o.length>0)throw new i.default("Invalid path: "+r,{loc:n});".."===c&&a++}}return{type:"PathExpression",data:e,depth:a,parts:o,original:r,loc:n}},t.prepareMustache=function(e,t,n,r,o,i){var a=r.charAt(3)||r.charAt(2),s="{"!==a&&"&"!==a;return{type:/\*/.test(r)?"Decorator":"MustacheStatement",path:e,params:t,hash:n,escaped:s,strip:o,loc:this.locInfo(i)}},t.prepareRawBlock=function(e,t,n,r){a(e,n),r=this.locInfo(r);var o={type:"Program",body:t,strip:{},loc:r};return{type:"BlockStatement",path:e.path,params:e.params,hash:e.hash,program:o,openStrip:{},inverseStrip:{},closeStrip:{},loc:r}},t.prepareBlock=function(e,t,n,r,o,s){r&&r.path&&a(e,r);var l=/\*/.test(e.open);t.blockParams=e.blockParams;var c=void 0,u=void 0;if(n){if(l)throw new i.default("Unexpected inverse block on decorator",n);n.chain&&(n.program.body[0].closeStrip=r.strip),u=n.strip,c=n.program}o&&(o=c,c=t,t=o);return{type:l?"DecoratorBlock":"BlockStatement",path:e.path,params:e.params,hash:e.hash,program:t,inverse:c,openStrip:e.strip,inverseStrip:u,closeStrip:r&&r.strip,loc:this.locInfo(s)}},t.prepareProgram=function(e,t){if(!t&&e.length){var n=e[0].loc,r=e[e.length-1].loc;n&&r&&(t={source:n.source,start:{line:n.start.line,column:n.start.column},end:{line:r.end.line,column:r.end.column}})}return{type:"Program",body:e,strip:{},loc:t}},t.preparePartialBlock=function(e,t,n,r){return a(e,n),{type:"PartialBlockStatement",name:e.path,params:e.params,hash:e.hash,program:t,openStrip:e.strip,closeStrip:n&&n.strip,loc:this.locInfo(r)}};var r,o=n(769),i=(r=o)&&r.__esModule?r:{default:r};function a(e,t){if(t=t.path?t.path.original:t,e.path.original!==t){var n={loc:e.path.loc};throw new i.default(e.path.original+" doesn't match "+t,n)}}},727:(e,t,n)=>{function r(e){return e&&e.__esModule?e:{default:e}}t.__esModule=!0;var o=n(871),i=r(n(769)),a=n(849),s=r(n(632));function l(e){this.value=e}function c(){}c.prototype={nameLookup:function(e,t){return this.internalNameLookup(e,t)},depthedLookup:function(e){return[this.aliasable("container.lookup"),"(depths, ",JSON.stringify(e),")"]},compilerInfo:function(){var e=o.COMPILER_REVISION;return[e,o.REVISION_CHANGES[e]]},appendToBuffer:function(e,t,n){return a.isArray(e)||(e=[e]),e=this.source.wrap(e,t),this.environment.isSimple?["return ",e,";"]:n?["buffer += ",e,";"]:(e.appendToBuffer=!0,e)},initializeBuffer:function(){return this.quotedString("")},internalNameLookup:function(e,t){return this.lookupPropertyFunctionIsUsed=!0,["lookupProperty(",e,",",JSON.stringify(t),")"]},lookupPropertyFunctionIsUsed:!1,compile:function(e,t,n,r){this.environment=e,this.options=t,this.stringParams=this.options.stringParams,this.trackIds=this.options.trackIds,this.precompile=!r,this.name=this.environment.name,this.isChild=!!n,this.context=n||{decorators:[],programs:[],environments:[]},this.preamble(),this.stackSlot=0,this.stackVars=[],this.aliases={},this.registers={list:[]},this.hashes=[],this.compileStack=[],this.inlineStack=[],this.blockParams=[],this.compileChildren(e,t),this.useDepths=this.useDepths||e.useDepths||e.useDecorators||this.options.compat,this.useBlockParams=this.useBlockParams||e.useBlockParams;var o=e.opcodes,a=void 0,s=void 0,l=void 0,c=void 0;for(l=0,c=o.length;l<c;l++)a=o[l],this.source.currentLocation=a.loc,s=s||a.loc,this[a.opcode].apply(this,a.args);if(this.source.currentLocation=s,this.pushSource(""),this.stackSlot||this.inlineStack.length||this.compileStack.length)throw new i.default("Compile completed with content left on stack");this.decorators.isEmpty()?this.decorators=void 0:(this.useDecorators=!0,this.decorators.prepend(["var decorators = container.decorators, ",this.lookupPropertyFunctionVarDeclaration(),";\n"]),this.decorators.push("return fn;"),r?this.decorators=Function.apply(this,["fn","props","container","depth0","data","blockParams","depths",this.decorators.merge()]):(this.decorators.prepend("function(fn, props, container, depth0, data, blockParams, depths) {\n"),this.decorators.push("}\n"),this.decorators=this.decorators.merge()));var u=this.createFunctionContext(r);if(this.isChild)return u;var p={compiler:this.compilerInfo(),main:u};this.decorators&&(p.main_d=this.decorators,p.useDecorators=!0);var h=this.context,d=h.programs,f=h.decorators;for(l=0,c=d.length;l<c;l++)d[l]&&(p[l]=d[l],f[l]&&(p[l+"_d"]=f[l],p.useDecorators=!0));return this.environment.usePartial&&(p.usePartial=!0),this.options.data&&(p.useData=!0),this.useDepths&&(p.useDepths=!0),this.useBlockParams&&(p.useBlockParams=!0),this.options.compat&&(p.compat=!0),r?p.compilerOptions=this.options:(p.compiler=JSON.stringify(p.compiler),this.source.currentLocation={start:{line:1,column:0}},p=this.objectLiteral(p),t.srcName?(p=p.toStringWithSourceMap({file:t.destName})).map=p.map&&p.map.toString():p=p.toString()),p},preamble:function(){this.lastContext=0,this.source=new s.default(this.options.srcName),this.decorators=new s.default(this.options.srcName)},createFunctionContext:function(e){var t=this,n="",r=this.stackVars.concat(this.registers.list);r.length>0&&(n+=", "+r.join(", "));var o=0;Object.keys(this.aliases).forEach((function(e){var r=t.aliases[e];r.children&&r.referenceCount>1&&(n+=", alias"+ ++o+"="+e,r.children[0]="alias"+o)})),this.lookupPropertyFunctionIsUsed&&(n+=", "+this.lookupPropertyFunctionVarDeclaration());var i=["container","depth0","helpers","partials","data"];(this.useBlockParams||this.useDepths)&&i.push("blockParams"),this.useDepths&&i.push("depths");var a=this.mergeSource(n);return e?(i.push(a),Function.apply(this,i)):this.source.wrap(["function(",i.join(","),") {\n  ",a,"}"])},mergeSource:function(e){var t=this.environment.isSimple,n=!this.forceBuffer,r=void 0,o=void 0,i=void 0,a=void 0;return this.source.each((function(e){e.appendToBuffer?(i?e.prepend("  + "):i=e,a=e):(i&&(o?i.prepend("buffer += "):r=!0,a.add(";"),i=a=void 0),o=!0,t||(n=!1))})),n?i?(i.prepend("return "),a.add(";")):o||this.source.push('return "";'):(e+=", buffer = "+(r?"":this.initializeBuffer()),i?(i.prepend("return buffer + "),a.add(";")):this.source.push("return buffer;")),e&&this.source.prepend("var "+e.substring(2)+(r?"":";\n")),this.source.merge()},lookupPropertyFunctionVarDeclaration:function(){return"\n      lookupProperty = container.lookupProperty || function(parent, propertyName) {\n        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {\n          return parent[propertyName];\n        }\n        return undefined\n    }\n    ".trim()},blockValue:function(e){var t=this.aliasable("container.hooks.blockHelperMissing"),n=[this.contextName(0)];this.setupHelperArgs(e,0,n);var r=this.popStack();n.splice(1,0,r),this.push(this.source.functionCall(t,"call",n))},ambiguousBlockValue:function(){var e=this.aliasable("container.hooks.blockHelperMissing"),t=[this.contextName(0)];this.setupHelperArgs("",0,t,!0),this.flushInline();var n=this.topStack();t.splice(1,0,n),this.pushSource(["if (!",this.lastHelper,") { ",n," = ",this.source.functionCall(e,"call",t),"}"])},appendContent:function(e){this.pendingContent?e=this.pendingContent+e:this.pendingLocation=this.source.currentLocation,this.pendingContent=e},append:function(){if(this.isInline())this.replaceStack((function(e){return[" != null ? ",e,' : ""']})),this.pushSource(this.appendToBuffer(this.popStack()));else{var e=this.popStack();this.pushSource(["if (",e," != null) { ",this.appendToBuffer(e,void 0,!0)," }"]),this.environment.isSimple&&this.pushSource(["else { ",this.appendToBuffer("''",void 0,!0)," }"])}},appendEscaped:function(){this.pushSource(this.appendToBuffer([this.aliasable("container.escapeExpression"),"(",this.popStack(),")"]))},getContext:function(e){this.lastContext=e},pushContext:function(){this.pushStackLiteral(this.contextName(this.lastContext))},lookupOnContext:function(e,t,n,r){var o=0;r||!this.options.compat||this.lastContext?this.pushContext():this.push(this.depthedLookup(e[o++])),this.resolvePath("context",e,o,t,n)},lookupBlockParam:function(e,t){this.useBlockParams=!0,this.push(["blockParams[",e[0],"][",e[1],"]"]),this.resolvePath("context",t,1)},lookupData:function(e,t,n){e?this.pushStackLiteral("container.data(data, "+e+")"):this.pushStackLiteral("data"),this.resolvePath("data",t,0,!0,n)},resolvePath:function(e,t,n,r,o){var i=this;if(this.options.strict||this.options.assumeObjects)this.push(function(e,t,n,r,o){var i=t.popStack(),a=n.length;e&&a--;for(;r<a;r++)i=t.nameLookup(i,n[r],o);return e?[t.aliasable("container.strict"),"(",i,", ",t.quotedString(n[r]),", ",JSON.stringify(t.source.currentLocation)," )"]:i}(this.options.strict&&o,this,t,n,e));else for(var a=t.length;n<a;n++)this.replaceStack((function(o){var a=i.nameLookup(o,t[n],e);return r?[" && ",a]:[" != null ? ",a," : ",o]}))},resolvePossibleLambda:function(){this.push([this.aliasable("container.lambda"),"(",this.popStack(),", ",this.contextName(0),")"])},pushStringParam:function(e,t){this.pushContext(),this.pushString(t),"SubExpression"!==t&&("string"==typeof e?this.pushString(e):this.pushStackLiteral(e))},emptyHash:function(e){this.trackIds&&this.push("{}"),this.stringParams&&(this.push("{}"),this.push("{}")),this.pushStackLiteral(e?"undefined":"{}")},pushHash:function(){this.hash&&this.hashes.push(this.hash),this.hash={values:{},types:[],contexts:[],ids:[]}},popHash:function(){var e=this.hash;this.hash=this.hashes.pop(),this.trackIds&&this.push(this.objectLiteral(e.ids)),this.stringParams&&(this.push(this.objectLiteral(e.contexts)),this.push(this.objectLiteral(e.types))),this.push(this.objectLiteral(e.values))},pushString:function(e){this.pushStackLiteral(this.quotedString(e))},pushLiteral:function(e){this.pushStackLiteral(e)},pushProgram:function(e){null!=e?this.pushStackLiteral(this.programExpression(e)):this.pushStackLiteral(null)},registerDecorator:function(e,t){var n=this.nameLookup("decorators",t,"decorator"),r=this.setupHelperArgs(t,e);this.decorators.push(["fn = ",this.decorators.functionCall(n,"",["fn","props","container",r])," || fn;"])},invokeHelper:function(e,t,n){var r=this.popStack(),o=this.setupHelper(e,t),i=[];n&&i.push(o.name),i.push(r),this.options.strict||i.push(this.aliasable("container.hooks.helperMissing"));var a=["(",this.itemsSeparatedBy(i,"||"),")"],s=this.source.functionCall(a,"call",o.callParams);this.push(s)},itemsSeparatedBy:function(e,t){var n=[];n.push(e[0]);for(var r=1;r<e.length;r++)n.push(t,e[r]);return n},invokeKnownHelper:function(e,t){var n=this.setupHelper(e,t);this.push(this.source.functionCall(n.name,"call",n.callParams))},invokeAmbiguous:function(e,t){this.useRegister("helper");var n=this.popStack();this.emptyHash();var r=this.setupHelper(0,e,t),o=["(","(helper = ",this.lastHelper=this.nameLookup("helpers",e,"helper")," || ",n,")"];this.options.strict||(o[0]="(helper = ",o.push(" != null ? helper : ",this.aliasable("container.hooks.helperMissing"))),this.push(["(",o,r.paramsInit?["),(",r.paramsInit]:[],"),","(typeof helper === ",this.aliasable('"function"')," ? ",this.source.functionCall("helper","call",r.callParams)," : helper))"])},invokePartial:function(e,t,n){var r=[],o=this.setupParams(t,1,r);e&&(t=this.popStack(),delete o.name),n&&(o.indent=JSON.stringify(n)),o.helpers="helpers",o.partials="partials",o.decorators="container.decorators",e?r.unshift(t):r.unshift(this.nameLookup("partials",t,"partial")),this.options.compat&&(o.depths="depths"),o=this.objectLiteral(o),r.push(o),this.push(this.source.functionCall("container.invokePartial","",r))},assignToHash:function(e){var t=this.popStack(),n=void 0,r=void 0,o=void 0;this.trackIds&&(o=this.popStack()),this.stringParams&&(r=this.popStack(),n=this.popStack());var i=this.hash;n&&(i.contexts[e]=n),r&&(i.types[e]=r),o&&(i.ids[e]=o),i.values[e]=t},pushId:function(e,t,n){"BlockParam"===e?this.pushStackLiteral("blockParams["+t[0]+"].path["+t[1]+"]"+(n?" + "+JSON.stringify("."+n):"")):"PathExpression"===e?this.pushString(t):"SubExpression"===e?this.pushStackLiteral("true"):this.pushStackLiteral("null")},compiler:c,compileChildren:function(e,t){for(var n=e.children,r=void 0,o=void 0,i=0,a=n.length;i<a;i++){r=n[i],o=new this.compiler;var s=this.matchExistingProgram(r);if(null==s){this.context.programs.push("");var l=this.context.programs.length;r.index=l,r.name="program"+l,this.context.programs[l]=o.compile(r,t,this.context,!this.precompile),this.context.decorators[l]=o.decorators,this.context.environments[l]=r,this.useDepths=this.useDepths||o.useDepths,this.useBlockParams=this.useBlockParams||o.useBlockParams,r.useDepths=this.useDepths,r.useBlockParams=this.useBlockParams}else r.index=s.index,r.name="program"+s.index,this.useDepths=this.useDepths||s.useDepths,this.useBlockParams=this.useBlockParams||s.useBlockParams}},matchExistingProgram:function(e){for(var t=0,n=this.context.environments.length;t<n;t++){var r=this.context.environments[t];if(r&&r.equals(e))return r}},programExpression:function(e){var t=this.environment.children[e],n=[t.index,"data",t.blockParams];return(this.useBlockParams||this.useDepths)&&n.push("blockParams"),this.useDepths&&n.push("depths"),"container.program("+n.join(", ")+")"},useRegister:function(e){this.registers[e]||(this.registers[e]=!0,this.registers.list.push(e))},push:function(e){return e instanceof l||(e=this.source.wrap(e)),this.inlineStack.push(e),e},pushStackLiteral:function(e){this.push(new l(e))},pushSource:function(e){this.pendingContent&&(this.source.push(this.appendToBuffer(this.source.quotedString(this.pendingContent),this.pendingLocation)),this.pendingContent=void 0),e&&this.source.push(e)},replaceStack:function(e){var t=["("],n=void 0,r=void 0,o=void 0;if(!this.isInline())throw new i.default("replaceStack on non-inline");var a=this.popStack(!0);if(a instanceof l)t=["(",n=[a.value]],o=!0;else{r=!0;var s=this.incrStack();t=["((",this.push(s)," = ",a,")"],n=this.topStack()}var c=e.call(this,n);o||this.popStack(),r&&this.stackSlot--,this.push(t.concat(c,")"))},incrStack:function(){return this.stackSlot++,this.stackSlot>this.stackVars.length&&this.stackVars.push("stack"+this.stackSlot),this.topStackName()},topStackName:function(){return"stack"+this.stackSlot},flushInline:function(){var e=this.inlineStack;this.inlineStack=[];for(var t=0,n=e.length;t<n;t++){var r=e[t];if(r instanceof l)this.compileStack.push(r);else{var o=this.incrStack();this.pushSource([o," = ",r,";"]),this.compileStack.push(o)}}},isInline:function(){return this.inlineStack.length},popStack:function(e){var t=this.isInline(),n=(t?this.inlineStack:this.compileStack).pop();if(!e&&n instanceof l)return n.value;if(!t){if(!this.stackSlot)throw new i.default("Invalid stack pop");this.stackSlot--}return n},topStack:function(){var e=this.isInline()?this.inlineStack:this.compileStack,t=e[e.length-1];return t instanceof l?t.value:t},contextName:function(e){return this.useDepths&&e?"depths["+e+"]":"depth"+e},quotedString:function(e){return this.source.quotedString(e)},objectLiteral:function(e){return this.source.objectLiteral(e)},aliasable:function(e){var t=this.aliases[e];return t?(t.referenceCount++,t):((t=this.aliases[e]=this.source.wrap(e)).aliasable=!0,t.referenceCount=1,t)},setupHelper:function(e,t,n){var r=[];return{params:r,paramsInit:this.setupHelperArgs(t,e,r,n),name:this.nameLookup("helpers",t,"helper"),callParams:[this.aliasable(this.contextName(0)+" != null ? "+this.contextName(0)+" : (container.nullContext || {})")].concat(r)}},setupParams:function(e,t,n){var r={},o=[],i=[],a=[],s=!n,l=void 0;s&&(n=[]),r.name=this.quotedString(e),r.hash=this.popStack(),this.trackIds&&(r.hashIds=this.popStack()),this.stringParams&&(r.hashTypes=this.popStack(),r.hashContexts=this.popStack());var c=this.popStack(),u=this.popStack();(u||c)&&(r.fn=u||"container.noop",r.inverse=c||"container.noop");for(var p=t;p--;)l=this.popStack(),n[p]=l,this.trackIds&&(a[p]=this.popStack()),this.stringParams&&(i[p]=this.popStack(),o[p]=this.popStack());return s&&(r.args=this.source.generateArray(n)),this.trackIds&&(r.ids=this.source.generateArray(a)),this.stringParams&&(r.types=this.source.generateArray(i),r.contexts=this.source.generateArray(o)),this.options.data&&(r.data="data"),this.useBlockParams&&(r.blockParams="blockParams"),r},setupHelperArgs:function(e,t,n,r){var o=this.setupParams(e,t,n);return o.loc=JSON.stringify(this.source.currentLocation),o=this.objectLiteral(o),r?(this.useRegister("options"),n.push("options"),["options=",o]):n?(n.push(o),""):o}},function(){for(var e="break else new var case finally return void catch for switch while continue function this with default if throw delete in try do instanceof typeof abstract enum int short boolean export interface static byte extends long super char final native synchronized class float package throws const goto private transient debugger implements protected volatile double import public let yield await null true false".split(" "),t=c.RESERVED_WORDS={},n=0,r=e.length;n<r;n++)t[e[n]]=!0}(),c.isValidJavaScriptVariableName=function(e){return!c.RESERVED_WORDS[e]&&/^[a-zA-Z_$][0-9a-zA-Z_$]*$/.test(e)},t.default=c,e.exports=t.default},201:(e,t)=>{t.__esModule=!0;var n=function(){var e={trace:function(){},yy:{},symbols_:{error:2,root:3,program:4,EOF:5,program_repetition0:6,statement:7,mustache:8,block:9,rawBlock:10,partial:11,partialBlock:12,content:13,COMMENT:14,CONTENT:15,openRawBlock:16,rawBlock_repetition0:17,END_RAW_BLOCK:18,OPEN_RAW_BLOCK:19,helperName:20,openRawBlock_repetition0:21,openRawBlock_option0:22,CLOSE_RAW_BLOCK:23,openBlock:24,block_option0:25,closeBlock:26,openInverse:27,block_option1:28,OPEN_BLOCK:29,openBlock_repetition0:30,openBlock_option0:31,openBlock_option1:32,CLOSE:33,OPEN_INVERSE:34,openInverse_repetition0:35,openInverse_option0:36,openInverse_option1:37,openInverseChain:38,OPEN_INVERSE_CHAIN:39,openInverseChain_repetition0:40,openInverseChain_option0:41,openInverseChain_option1:42,inverseAndProgram:43,INVERSE:44,inverseChain:45,inverseChain_option0:46,OPEN_ENDBLOCK:47,OPEN:48,mustache_repetition0:49,mustache_option0:50,OPEN_UNESCAPED:51,mustache_repetition1:52,mustache_option1:53,CLOSE_UNESCAPED:54,OPEN_PARTIAL:55,partialName:56,partial_repetition0:57,partial_option0:58,openPartialBlock:59,OPEN_PARTIAL_BLOCK:60,openPartialBlock_repetition0:61,openPartialBlock_option0:62,param:63,sexpr:64,OPEN_SEXPR:65,sexpr_repetition0:66,sexpr_option0:67,CLOSE_SEXPR:68,hash:69,hash_repetition_plus0:70,hashSegment:71,ID:72,EQUALS:73,blockParams:74,OPEN_BLOCK_PARAMS:75,blockParams_repetition_plus0:76,CLOSE_BLOCK_PARAMS:77,path:78,dataName:79,STRING:80,NUMBER:81,BOOLEAN:82,UNDEFINED:83,NULL:84,DATA:85,pathSegments:86,SEP:87,$accept:0,$end:1},terminals_:{2:"error",5:"EOF",14:"COMMENT",15:"CONTENT",18:"END_RAW_BLOCK",19:"OPEN_RAW_BLOCK",23:"CLOSE_RAW_BLOCK",29:"OPEN_BLOCK",33:"CLOSE",34:"OPEN_INVERSE",39:"OPEN_INVERSE_CHAIN",44:"INVERSE",47:"OPEN_ENDBLOCK",48:"OPEN",51:"OPEN_UNESCAPED",54:"CLOSE_UNESCAPED",55:"OPEN_PARTIAL",60:"OPEN_PARTIAL_BLOCK",65:"OPEN_SEXPR",68:"CLOSE_SEXPR",72:"ID",73:"EQUALS",75:"OPEN_BLOCK_PARAMS",77:"CLOSE_BLOCK_PARAMS",80:"STRING",81:"NUMBER",82:"BOOLEAN",83:"UNDEFINED",84:"NULL",85:"DATA",87:"SEP"},productions_:[0,[3,2],[4,1],[7,1],[7,1],[7,1],[7,1],[7,1],[7,1],[7,1],[13,1],[10,3],[16,5],[9,4],[9,4],[24,6],[27,6],[38,6],[43,2],[45,3],[45,1],[26,3],[8,5],[8,5],[11,5],[12,3],[59,5],[63,1],[63,1],[64,5],[69,1],[71,3],[74,3],[20,1],[20,1],[20,1],[20,1],[20,1],[20,1],[20,1],[56,1],[56,1],[79,2],[78,1],[86,3],[86,1],[6,0],[6,2],[17,0],[17,2],[21,0],[21,2],[22,0],[22,1],[25,0],[25,1],[28,0],[28,1],[30,0],[30,2],[31,0],[31,1],[32,0],[32,1],[35,0],[35,2],[36,0],[36,1],[37,0],[37,1],[40,0],[40,2],[41,0],[41,1],[42,0],[42,1],[46,0],[46,1],[49,0],[49,2],[50,0],[50,1],[52,0],[52,2],[53,0],[53,1],[57,0],[57,2],[58,0],[58,1],[61,0],[61,2],[62,0],[62,1],[66,0],[66,2],[67,0],[67,1],[70,1],[70,2],[76,1],[76,2]],performAction:function(e,t,n,r,o,i,a){var s=i.length-1;switch(o){case 1:return i[s-1];case 2:this.$=r.prepareProgram(i[s]);break;case 3:case 4:case 5:case 6:case 7:case 8:case 20:case 27:case 28:case 33:case 34:case 40:case 41:this.$=i[s];break;case 9:this.$={type:"CommentStatement",value:r.stripComment(i[s]),strip:r.stripFlags(i[s],i[s]),loc:r.locInfo(this._$)};break;case 10:this.$={type:"ContentStatement",original:i[s],value:i[s],loc:r.locInfo(this._$)};break;case 11:this.$=r.prepareRawBlock(i[s-2],i[s-1],i[s],this._$);break;case 12:this.$={path:i[s-3],params:i[s-2],hash:i[s-1]};break;case 13:this.$=r.prepareBlock(i[s-3],i[s-2],i[s-1],i[s],!1,this._$);break;case 14:this.$=r.prepareBlock(i[s-3],i[s-2],i[s-1],i[s],!0,this._$);break;case 15:this.$={open:i[s-5],path:i[s-4],params:i[s-3],hash:i[s-2],blockParams:i[s-1],strip:r.stripFlags(i[s-5],i[s])};break;case 16:case 17:this.$={path:i[s-4],params:i[s-3],hash:i[s-2],blockParams:i[s-1],strip:r.stripFlags(i[s-5],i[s])};break;case 18:this.$={strip:r.stripFlags(i[s-1],i[s-1]),program:i[s]};break;case 19:var l=r.prepareBlock(i[s-2],i[s-1],i[s],i[s],!1,this._$),c=r.prepareProgram([l],i[s-1].loc);c.chained=!0,this.$={strip:i[s-2].strip,program:c,chain:!0};break;case 21:this.$={path:i[s-1],strip:r.stripFlags(i[s-2],i[s])};break;case 22:case 23:this.$=r.prepareMustache(i[s-3],i[s-2],i[s-1],i[s-4],r.stripFlags(i[s-4],i[s]),this._$);break;case 24:this.$={type:"PartialStatement",name:i[s-3],params:i[s-2],hash:i[s-1],indent:"",strip:r.stripFlags(i[s-4],i[s]),loc:r.locInfo(this._$)};break;case 25:this.$=r.preparePartialBlock(i[s-2],i[s-1],i[s],this._$);break;case 26:this.$={path:i[s-3],params:i[s-2],hash:i[s-1],strip:r.stripFlags(i[s-4],i[s])};break;case 29:this.$={type:"SubExpression",path:i[s-3],params:i[s-2],hash:i[s-1],loc:r.locInfo(this._$)};break;case 30:this.$={type:"Hash",pairs:i[s],loc:r.locInfo(this._$)};break;case 31:this.$={type:"HashPair",key:r.id(i[s-2]),value:i[s],loc:r.locInfo(this._$)};break;case 32:this.$=r.id(i[s-1]);break;case 35:this.$={type:"StringLiteral",value:i[s],original:i[s],loc:r.locInfo(this._$)};break;case 36:this.$={type:"NumberLiteral",value:Number(i[s]),original:Number(i[s]),loc:r.locInfo(this._$)};break;case 37:this.$={type:"BooleanLiteral",value:"true"===i[s],original:"true"===i[s],loc:r.locInfo(this._$)};break;case 38:this.$={type:"UndefinedLiteral",original:void 0,value:void 0,loc:r.locInfo(this._$)};break;case 39:this.$={type:"NullLiteral",original:null,value:null,loc:r.locInfo(this._$)};break;case 42:this.$=r.preparePath(!0,i[s],this._$);break;case 43:this.$=r.preparePath(!1,i[s],this._$);break;case 44:i[s-2].push({part:r.id(i[s]),original:i[s],separator:i[s-1]}),this.$=i[s-2];break;case 45:this.$=[{part:r.id(i[s]),original:i[s]}];break;case 46:case 48:case 50:case 58:case 64:case 70:case 78:case 82:case 86:case 90:case 94:this.$=[];break;case 47:case 49:case 51:case 59:case 65:case 71:case 79:case 83:case 87:case 91:case 95:case 99:case 101:i[s-1].push(i[s]);break;case 98:case 100:this.$=[i[s]]}},table:[{3:1,4:2,5:[2,46],6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{1:[3]},{5:[1,4]},{5:[2,2],7:5,8:6,9:7,10:8,11:9,12:10,13:11,14:[1,12],15:[1,20],16:17,19:[1,23],24:15,27:16,29:[1,21],34:[1,22],39:[2,2],44:[2,2],47:[2,2],48:[1,13],51:[1,14],55:[1,18],59:19,60:[1,24]},{1:[2,1]},{5:[2,47],14:[2,47],15:[2,47],19:[2,47],29:[2,47],34:[2,47],39:[2,47],44:[2,47],47:[2,47],48:[2,47],51:[2,47],55:[2,47],60:[2,47]},{5:[2,3],14:[2,3],15:[2,3],19:[2,3],29:[2,3],34:[2,3],39:[2,3],44:[2,3],47:[2,3],48:[2,3],51:[2,3],55:[2,3],60:[2,3]},{5:[2,4],14:[2,4],15:[2,4],19:[2,4],29:[2,4],34:[2,4],39:[2,4],44:[2,4],47:[2,4],48:[2,4],51:[2,4],55:[2,4],60:[2,4]},{5:[2,5],14:[2,5],15:[2,5],19:[2,5],29:[2,5],34:[2,5],39:[2,5],44:[2,5],47:[2,5],48:[2,5],51:[2,5],55:[2,5],60:[2,5]},{5:[2,6],14:[2,6],15:[2,6],19:[2,6],29:[2,6],34:[2,6],39:[2,6],44:[2,6],47:[2,6],48:[2,6],51:[2,6],55:[2,6],60:[2,6]},{5:[2,7],14:[2,7],15:[2,7],19:[2,7],29:[2,7],34:[2,7],39:[2,7],44:[2,7],47:[2,7],48:[2,7],51:[2,7],55:[2,7],60:[2,7]},{5:[2,8],14:[2,8],15:[2,8],19:[2,8],29:[2,8],34:[2,8],39:[2,8],44:[2,8],47:[2,8],48:[2,8],51:[2,8],55:[2,8],60:[2,8]},{5:[2,9],14:[2,9],15:[2,9],19:[2,9],29:[2,9],34:[2,9],39:[2,9],44:[2,9],47:[2,9],48:[2,9],51:[2,9],55:[2,9],60:[2,9]},{20:25,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:36,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{4:37,6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],39:[2,46],44:[2,46],47:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{4:38,6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],44:[2,46],47:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{15:[2,48],17:39,18:[2,48]},{20:41,56:40,64:42,65:[1,43],72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{4:44,6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],47:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{5:[2,10],14:[2,10],15:[2,10],18:[2,10],19:[2,10],29:[2,10],34:[2,10],39:[2,10],44:[2,10],47:[2,10],48:[2,10],51:[2,10],55:[2,10],60:[2,10]},{20:45,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:46,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:47,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:41,56:48,64:42,65:[1,43],72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{33:[2,78],49:49,65:[2,78],72:[2,78],80:[2,78],81:[2,78],82:[2,78],83:[2,78],84:[2,78],85:[2,78]},{23:[2,33],33:[2,33],54:[2,33],65:[2,33],68:[2,33],72:[2,33],75:[2,33],80:[2,33],81:[2,33],82:[2,33],83:[2,33],84:[2,33],85:[2,33]},{23:[2,34],33:[2,34],54:[2,34],65:[2,34],68:[2,34],72:[2,34],75:[2,34],80:[2,34],81:[2,34],82:[2,34],83:[2,34],84:[2,34],85:[2,34]},{23:[2,35],33:[2,35],54:[2,35],65:[2,35],68:[2,35],72:[2,35],75:[2,35],80:[2,35],81:[2,35],82:[2,35],83:[2,35],84:[2,35],85:[2,35]},{23:[2,36],33:[2,36],54:[2,36],65:[2,36],68:[2,36],72:[2,36],75:[2,36],80:[2,36],81:[2,36],82:[2,36],83:[2,36],84:[2,36],85:[2,36]},{23:[2,37],33:[2,37],54:[2,37],65:[2,37],68:[2,37],72:[2,37],75:[2,37],80:[2,37],81:[2,37],82:[2,37],83:[2,37],84:[2,37],85:[2,37]},{23:[2,38],33:[2,38],54:[2,38],65:[2,38],68:[2,38],72:[2,38],75:[2,38],80:[2,38],81:[2,38],82:[2,38],83:[2,38],84:[2,38],85:[2,38]},{23:[2,39],33:[2,39],54:[2,39],65:[2,39],68:[2,39],72:[2,39],75:[2,39],80:[2,39],81:[2,39],82:[2,39],83:[2,39],84:[2,39],85:[2,39]},{23:[2,43],33:[2,43],54:[2,43],65:[2,43],68:[2,43],72:[2,43],75:[2,43],80:[2,43],81:[2,43],82:[2,43],83:[2,43],84:[2,43],85:[2,43],87:[1,50]},{72:[1,35],86:51},{23:[2,45],33:[2,45],54:[2,45],65:[2,45],68:[2,45],72:[2,45],75:[2,45],80:[2,45],81:[2,45],82:[2,45],83:[2,45],84:[2,45],85:[2,45],87:[2,45]},{52:52,54:[2,82],65:[2,82],72:[2,82],80:[2,82],81:[2,82],82:[2,82],83:[2,82],84:[2,82],85:[2,82]},{25:53,38:55,39:[1,57],43:56,44:[1,58],45:54,47:[2,54]},{28:59,43:60,44:[1,58],47:[2,56]},{13:62,15:[1,20],18:[1,61]},{33:[2,86],57:63,65:[2,86],72:[2,86],80:[2,86],81:[2,86],82:[2,86],83:[2,86],84:[2,86],85:[2,86]},{33:[2,40],65:[2,40],72:[2,40],80:[2,40],81:[2,40],82:[2,40],83:[2,40],84:[2,40],85:[2,40]},{33:[2,41],65:[2,41],72:[2,41],80:[2,41],81:[2,41],82:[2,41],83:[2,41],84:[2,41],85:[2,41]},{20:64,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{26:65,47:[1,66]},{30:67,33:[2,58],65:[2,58],72:[2,58],75:[2,58],80:[2,58],81:[2,58],82:[2,58],83:[2,58],84:[2,58],85:[2,58]},{33:[2,64],35:68,65:[2,64],72:[2,64],75:[2,64],80:[2,64],81:[2,64],82:[2,64],83:[2,64],84:[2,64],85:[2,64]},{21:69,23:[2,50],65:[2,50],72:[2,50],80:[2,50],81:[2,50],82:[2,50],83:[2,50],84:[2,50],85:[2,50]},{33:[2,90],61:70,65:[2,90],72:[2,90],80:[2,90],81:[2,90],82:[2,90],83:[2,90],84:[2,90],85:[2,90]},{20:74,33:[2,80],50:71,63:72,64:75,65:[1,43],69:73,70:76,71:77,72:[1,78],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{72:[1,79]},{23:[2,42],33:[2,42],54:[2,42],65:[2,42],68:[2,42],72:[2,42],75:[2,42],80:[2,42],81:[2,42],82:[2,42],83:[2,42],84:[2,42],85:[2,42],87:[1,50]},{20:74,53:80,54:[2,84],63:81,64:75,65:[1,43],69:82,70:76,71:77,72:[1,78],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{26:83,47:[1,66]},{47:[2,55]},{4:84,6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],39:[2,46],44:[2,46],47:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{47:[2,20]},{20:85,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{4:86,6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],47:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{26:87,47:[1,66]},{47:[2,57]},{5:[2,11],14:[2,11],15:[2,11],19:[2,11],29:[2,11],34:[2,11],39:[2,11],44:[2,11],47:[2,11],48:[2,11],51:[2,11],55:[2,11],60:[2,11]},{15:[2,49],18:[2,49]},{20:74,33:[2,88],58:88,63:89,64:75,65:[1,43],69:90,70:76,71:77,72:[1,78],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{65:[2,94],66:91,68:[2,94],72:[2,94],80:[2,94],81:[2,94],82:[2,94],83:[2,94],84:[2,94],85:[2,94]},{5:[2,25],14:[2,25],15:[2,25],19:[2,25],29:[2,25],34:[2,25],39:[2,25],44:[2,25],47:[2,25],48:[2,25],51:[2,25],55:[2,25],60:[2,25]},{20:92,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:74,31:93,33:[2,60],63:94,64:75,65:[1,43],69:95,70:76,71:77,72:[1,78],75:[2,60],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:74,33:[2,66],36:96,63:97,64:75,65:[1,43],69:98,70:76,71:77,72:[1,78],75:[2,66],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:74,22:99,23:[2,52],63:100,64:75,65:[1,43],69:101,70:76,71:77,72:[1,78],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:74,33:[2,92],62:102,63:103,64:75,65:[1,43],69:104,70:76,71:77,72:[1,78],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{33:[1,105]},{33:[2,79],65:[2,79],72:[2,79],80:[2,79],81:[2,79],82:[2,79],83:[2,79],84:[2,79],85:[2,79]},{33:[2,81]},{23:[2,27],33:[2,27],54:[2,27],65:[2,27],68:[2,27],72:[2,27],75:[2,27],80:[2,27],81:[2,27],82:[2,27],83:[2,27],84:[2,27],85:[2,27]},{23:[2,28],33:[2,28],54:[2,28],65:[2,28],68:[2,28],72:[2,28],75:[2,28],80:[2,28],81:[2,28],82:[2,28],83:[2,28],84:[2,28],85:[2,28]},{23:[2,30],33:[2,30],54:[2,30],68:[2,30],71:106,72:[1,107],75:[2,30]},{23:[2,98],33:[2,98],54:[2,98],68:[2,98],72:[2,98],75:[2,98]},{23:[2,45],33:[2,45],54:[2,45],65:[2,45],68:[2,45],72:[2,45],73:[1,108],75:[2,45],80:[2,45],81:[2,45],82:[2,45],83:[2,45],84:[2,45],85:[2,45],87:[2,45]},{23:[2,44],33:[2,44],54:[2,44],65:[2,44],68:[2,44],72:[2,44],75:[2,44],80:[2,44],81:[2,44],82:[2,44],83:[2,44],84:[2,44],85:[2,44],87:[2,44]},{54:[1,109]},{54:[2,83],65:[2,83],72:[2,83],80:[2,83],81:[2,83],82:[2,83],83:[2,83],84:[2,83],85:[2,83]},{54:[2,85]},{5:[2,13],14:[2,13],15:[2,13],19:[2,13],29:[2,13],34:[2,13],39:[2,13],44:[2,13],47:[2,13],48:[2,13],51:[2,13],55:[2,13],60:[2,13]},{38:55,39:[1,57],43:56,44:[1,58],45:111,46:110,47:[2,76]},{33:[2,70],40:112,65:[2,70],72:[2,70],75:[2,70],80:[2,70],81:[2,70],82:[2,70],83:[2,70],84:[2,70],85:[2,70]},{47:[2,18]},{5:[2,14],14:[2,14],15:[2,14],19:[2,14],29:[2,14],34:[2,14],39:[2,14],44:[2,14],47:[2,14],48:[2,14],51:[2,14],55:[2,14],60:[2,14]},{33:[1,113]},{33:[2,87],65:[2,87],72:[2,87],80:[2,87],81:[2,87],82:[2,87],83:[2,87],84:[2,87],85:[2,87]},{33:[2,89]},{20:74,63:115,64:75,65:[1,43],67:114,68:[2,96],69:116,70:76,71:77,72:[1,78],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{33:[1,117]},{32:118,33:[2,62],74:119,75:[1,120]},{33:[2,59],65:[2,59],72:[2,59],75:[2,59],80:[2,59],81:[2,59],82:[2,59],83:[2,59],84:[2,59],85:[2,59]},{33:[2,61],75:[2,61]},{33:[2,68],37:121,74:122,75:[1,120]},{33:[2,65],65:[2,65],72:[2,65],75:[2,65],80:[2,65],81:[2,65],82:[2,65],83:[2,65],84:[2,65],85:[2,65]},{33:[2,67],75:[2,67]},{23:[1,123]},{23:[2,51],65:[2,51],72:[2,51],80:[2,51],81:[2,51],82:[2,51],83:[2,51],84:[2,51],85:[2,51]},{23:[2,53]},{33:[1,124]},{33:[2,91],65:[2,91],72:[2,91],80:[2,91],81:[2,91],82:[2,91],83:[2,91],84:[2,91],85:[2,91]},{33:[2,93]},{5:[2,22],14:[2,22],15:[2,22],19:[2,22],29:[2,22],34:[2,22],39:[2,22],44:[2,22],47:[2,22],48:[2,22],51:[2,22],55:[2,22],60:[2,22]},{23:[2,99],33:[2,99],54:[2,99],68:[2,99],72:[2,99],75:[2,99]},{73:[1,108]},{20:74,63:125,64:75,65:[1,43],72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{5:[2,23],14:[2,23],15:[2,23],19:[2,23],29:[2,23],34:[2,23],39:[2,23],44:[2,23],47:[2,23],48:[2,23],51:[2,23],55:[2,23],60:[2,23]},{47:[2,19]},{47:[2,77]},{20:74,33:[2,72],41:126,63:127,64:75,65:[1,43],69:128,70:76,71:77,72:[1,78],75:[2,72],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{5:[2,24],14:[2,24],15:[2,24],19:[2,24],29:[2,24],34:[2,24],39:[2,24],44:[2,24],47:[2,24],48:[2,24],51:[2,24],55:[2,24],60:[2,24]},{68:[1,129]},{65:[2,95],68:[2,95],72:[2,95],80:[2,95],81:[2,95],82:[2,95],83:[2,95],84:[2,95],85:[2,95]},{68:[2,97]},{5:[2,21],14:[2,21],15:[2,21],19:[2,21],29:[2,21],34:[2,21],39:[2,21],44:[2,21],47:[2,21],48:[2,21],51:[2,21],55:[2,21],60:[2,21]},{33:[1,130]},{33:[2,63]},{72:[1,132],76:131},{33:[1,133]},{33:[2,69]},{15:[2,12],18:[2,12]},{14:[2,26],15:[2,26],19:[2,26],29:[2,26],34:[2,26],47:[2,26],48:[2,26],51:[2,26],55:[2,26],60:[2,26]},{23:[2,31],33:[2,31],54:[2,31],68:[2,31],72:[2,31],75:[2,31]},{33:[2,74],42:134,74:135,75:[1,120]},{33:[2,71],65:[2,71],72:[2,71],75:[2,71],80:[2,71],81:[2,71],82:[2,71],83:[2,71],84:[2,71],85:[2,71]},{33:[2,73],75:[2,73]},{23:[2,29],33:[2,29],54:[2,29],65:[2,29],68:[2,29],72:[2,29],75:[2,29],80:[2,29],81:[2,29],82:[2,29],83:[2,29],84:[2,29],85:[2,29]},{14:[2,15],15:[2,15],19:[2,15],29:[2,15],34:[2,15],39:[2,15],44:[2,15],47:[2,15],48:[2,15],51:[2,15],55:[2,15],60:[2,15]},{72:[1,137],77:[1,136]},{72:[2,100],77:[2,100]},{14:[2,16],15:[2,16],19:[2,16],29:[2,16],34:[2,16],44:[2,16],47:[2,16],48:[2,16],51:[2,16],55:[2,16],60:[2,16]},{33:[1,138]},{33:[2,75]},{33:[2,32]},{72:[2,101],77:[2,101]},{14:[2,17],15:[2,17],19:[2,17],29:[2,17],34:[2,17],39:[2,17],44:[2,17],47:[2,17],48:[2,17],51:[2,17],55:[2,17],60:[2,17]}],defaultActions:{4:[2,1],54:[2,55],56:[2,20],60:[2,57],73:[2,81],82:[2,85],86:[2,18],90:[2,89],101:[2,53],104:[2,93],110:[2,19],111:[2,77],116:[2,97],119:[2,63],122:[2,69],135:[2,75],136:[2,32]},parseError:function(e,t){throw new Error(e)},parse:function(e){var t=this,n=[0],r=[null],o=[],i=this.table,a="",s=0,l=0,c=0;this.lexer.setInput(e),this.lexer.yy=this.yy,this.yy.lexer=this.lexer,this.yy.parser=this,void 0===this.lexer.yylloc&&(this.lexer.yylloc={});var u=this.lexer.yylloc;o.push(u);var p=this.lexer.options&&this.lexer.options.ranges;"function"==typeof this.yy.parseError&&(this.parseError=this.yy.parseError);for(var h,d,f,m,g,v,y,b,x,w,S={};;){if(f=n[n.length-1],this.defaultActions[f]?m=this.defaultActions[f]:(null==h&&(w=void 0,"number"!=typeof(w=t.lexer.lex()||1)&&(w=t.symbols_[w]||w),h=w),m=i[f]&&i[f][h]),void 0===m||!m.length||!m[0]){var _="";if(!c){for(v in x=[],i[f])this.terminals_[v]&&v>2&&x.push("'"+this.terminals_[v]+"'");_=this.lexer.showPosition?"Parse error on line "+(s+1)+":\n"+this.lexer.showPosition()+"\nExpecting "+x.join(", ")+", got '"+(this.terminals_[h]||h)+"'":"Parse error on line "+(s+1)+": Unexpected "+(1==h?"end of input":"'"+(this.terminals_[h]||h)+"'"),this.parseError(_,{text:this.lexer.match,token:this.terminals_[h]||h,line:this.lexer.yylineno,loc:u,expected:x})}}if(m[0]instanceof Array&&m.length>1)throw new Error("Parse Error: multiple actions possible at state: "+f+", token: "+h);switch(m[0]){case 1:n.push(h),r.push(this.lexer.yytext),o.push(this.lexer.yylloc),n.push(m[1]),h=null,d?(h=d,d=null):(l=this.lexer.yyleng,a=this.lexer.yytext,s=this.lexer.yylineno,u=this.lexer.yylloc,c>0&&c--);break;case 2:if(y=this.productions_[m[1]][1],S.$=r[r.length-y],S._$={first_line:o[o.length-(y||1)].first_line,last_line:o[o.length-1].last_line,first_column:o[o.length-(y||1)].first_column,last_column:o[o.length-1].last_column},p&&(S._$.range=[o[o.length-(y||1)].range[0],o[o.length-1].range[1]]),void 0!==(g=this.performAction.call(S,a,l,s,this.yy,m[1],r,o)))return g;y&&(n=n.slice(0,-1*y*2),r=r.slice(0,-1*y),o=o.slice(0,-1*y)),n.push(this.productions_[m[1]][0]),r.push(S.$),o.push(S._$),b=i[n[n.length-2]][n[n.length-1]],n.push(b);break;case 3:return!0}}return!0}},t=function(){var e={EOF:1,parseError:function(e,t){if(!this.yy.parser)throw new Error(e);this.yy.parser.parseError(e,t)},setInput:function(e){return this._input=e,this._more=this._less=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this.options.ranges&&(this.yylloc.range=[0,0]),this.offset=0,this},input:function(){var e=this._input[0];return this.yytext+=e,this.yyleng++,this.offset++,this.match+=e,this.matched+=e,e.match(/(?:\r\n?|\n).*/g)?(this.yylineno++,this.yylloc.last_line++):this.yylloc.last_column++,this.options.ranges&&this.yylloc.range[1]++,this._input=this._input.slice(1),e},unput:function(e){var t=e.length,n=e.split(/(?:\r\n?|\n)/g);this._input=e+this._input,this.yytext=this.yytext.substr(0,this.yytext.length-t-1),this.offset-=t;var r=this.match.split(/(?:\r\n?|\n)/g);this.match=this.match.substr(0,this.match.length-1),this.matched=this.matched.substr(0,this.matched.length-1),n.length-1&&(this.yylineno-=n.length-1);var o=this.yylloc.range;return this.yylloc={first_line:this.yylloc.first_line,last_line:this.yylineno+1,first_column:this.yylloc.first_column,last_column:n?(n.length===r.length?this.yylloc.first_column:0)+r[r.length-n.length].length-n[0].length:this.yylloc.first_column-t},this.options.ranges&&(this.yylloc.range=[o[0],o[0]+this.yyleng-t]),this},more:function(){return this._more=!0,this},less:function(e){this.unput(this.match.slice(e))},pastInput:function(){var e=this.matched.substr(0,this.matched.length-this.match.length);return(e.length>20?"...":"")+e.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var e=this.match;return e.length<20&&(e+=this._input.substr(0,20-e.length)),(e.substr(0,20)+(e.length>20?"...":"")).replace(/\n/g,"")},showPosition:function(){var e=this.pastInput(),t=new Array(e.length+1).join("-");return e+this.upcomingInput()+"\n"+t+"^"},next:function(){if(this.done)return this.EOF;var e,t,n,r,o;this._input||(this.done=!0),this._more||(this.yytext="",this.match="");for(var i=this._currentRules(),a=0;a<i.length&&(!(n=this._input.match(this.rules[i[a]]))||t&&!(n[0].length>t[0].length)||(t=n,r=a,this.options.flex));a++);return t?((o=t[0].match(/(?:\r\n?|\n).*/g))&&(this.yylineno+=o.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:o?o[o.length-1].length-o[o.length-1].match(/\r?\n?/)[0].length:this.yylloc.last_column+t[0].length},this.yytext+=t[0],this.match+=t[0],this.matches=t,this.yyleng=this.yytext.length,this.options.ranges&&(this.yylloc.range=[this.offset,this.offset+=this.yyleng]),this._more=!1,this._input=this._input.slice(t[0].length),this.matched+=t[0],e=this.performAction.call(this,this.yy,this,i[r],this.conditionStack[this.conditionStack.length-1]),this.done&&this._input&&(this.done=!1),e||void 0):""===this._input?this.EOF:this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var e=this.next();return void 0!==e?e:this.lex()},begin:function(e){this.conditionStack.push(e)},popState:function(){return this.conditionStack.pop()},_currentRules:function(){return this.conditions[this.conditionStack[this.conditionStack.length-1]].rules},topState:function(){return this.conditionStack[this.conditionStack.length-2]},pushState:function(e){this.begin(e)},options:{},performAction:function(e,t,n,r){function o(e,n){return t.yytext=t.yytext.substring(e,t.yyleng-n+e)}switch(n){case 0:if("\\\\"===t.yytext.slice(-2)?(o(0,1),this.begin("mu")):"\\"===t.yytext.slice(-1)?(o(0,1),this.begin("emu")):this.begin("mu"),t.yytext)return 15;break;case 1:case 5:return 15;case 2:return this.popState(),15;case 3:return this.begin("raw"),15;case 4:return this.popState(),"raw"===this.conditionStack[this.conditionStack.length-1]?15:(o(5,9),"END_RAW_BLOCK");case 6:case 22:return this.popState(),14;case 7:return 65;case 8:return 68;case 9:return 19;case 10:return this.popState(),this.begin("raw"),23;case 11:return 55;case 12:return 60;case 13:return 29;case 14:return 47;case 15:case 16:return this.popState(),44;case 17:return 34;case 18:return 39;case 19:return 51;case 20:case 23:return 48;case 21:this.unput(t.yytext),this.popState(),this.begin("com");break;case 24:return 73;case 25:case 26:case 41:return 72;case 27:return 87;case 28:break;case 29:return this.popState(),54;case 30:return this.popState(),33;case 31:return t.yytext=o(1,2).replace(/\\"/g,'"'),80;case 32:return t.yytext=o(1,2).replace(/\\'/g,"'"),80;case 33:return 85;case 34:case 35:return 82;case 36:return 83;case 37:return 84;case 38:return 81;case 39:return 75;case 40:return 77;case 42:return t.yytext=t.yytext.replace(/\\([\\\]])/g,"$1"),72;case 43:return"INVALID";case 44:return 5}},rules:[/^(?:[^\x00]*?(?=(\{\{)))/,/^(?:[^\x00]+)/,/^(?:[^\x00]{2,}?(?=(\{\{|\\\{\{|\\\\\{\{|$)))/,/^(?:\{\{\{\{(?=[^/]))/,/^(?:\{\{\{\{\/[^\s!"#%-,\.\/;->@\[-\^`\{-~]+(?=[=}\s\/.])\}\}\}\})/,/^(?:[^\x00]+?(?=(\{\{\{\{)))/,/^(?:[\s\S]*?--(~)?\}\})/,/^(?:\()/,/^(?:\))/,/^(?:\{\{\{\{)/,/^(?:\}\}\}\})/,/^(?:\{\{(~)?>)/,/^(?:\{\{(~)?#>)/,/^(?:\{\{(~)?#\*?)/,/^(?:\{\{(~)?\/)/,/^(?:\{\{(~)?\^\s*(~)?\}\})/,/^(?:\{\{(~)?\s*else\s*(~)?\}\})/,/^(?:\{\{(~)?\^)/,/^(?:\{\{(~)?\s*else\b)/,/^(?:\{\{(~)?\{)/,/^(?:\{\{(~)?&)/,/^(?:\{\{(~)?!--)/,/^(?:\{\{(~)?![\s\S]*?\}\})/,/^(?:\{\{(~)?\*?)/,/^(?:=)/,/^(?:\.\.)/,/^(?:\.(?=([=~}\s\/.)|])))/,/^(?:[\/.])/,/^(?:\s+)/,/^(?:\}(~)?\}\})/,/^(?:(~)?\}\})/,/^(?:"(\\["]|[^"])*")/,/^(?:'(\\[']|[^'])*')/,/^(?:@)/,/^(?:true(?=([~}\s)])))/,/^(?:false(?=([~}\s)])))/,/^(?:undefined(?=([~}\s)])))/,/^(?:null(?=([~}\s)])))/,/^(?:-?[0-9]+(?:\.[0-9]+)?(?=([~}\s)])))/,/^(?:as\s+\|)/,/^(?:\|)/,/^(?:([^\s!"#%-,\.\/;->@\[-\^`\{-~]+(?=([=~}\s\/.)|]))))/,/^(?:\[(\\\]|[^\]])*\])/,/^(?:.)/,/^(?:$)/],conditions:{mu:{rules:[7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44],inclusive:!1},emu:{rules:[2],inclusive:!1},com:{rules:[6],inclusive:!1},raw:{rules:[3,4,5],inclusive:!1},INITIAL:{rules:[0,1,44],inclusive:!0}}};return e}();function n(){this.yy={}}return e.lexer=t,n.prototype=e,e.Parser=n,new n}();t.default=n,e.exports=t.default},350:(e,t,n)=>{t.__esModule=!0;var r,o=n(769),i=(r=o)&&r.__esModule?r:{default:r};function a(){this.parents=[]}function s(e){this.acceptRequired(e,"path"),this.acceptArray(e.params),this.acceptKey(e,"hash")}function l(e){s.call(this,e),this.acceptKey(e,"program"),this.acceptKey(e,"inverse")}function c(e){this.acceptRequired(e,"name"),this.acceptArray(e.params),this.acceptKey(e,"hash")}a.prototype={constructor:a,mutating:!1,acceptKey:function(e,t){var n=this.accept(e[t]);if(this.mutating){if(n&&!a.prototype[n.type])throw new i.default('Unexpected node type "'+n.type+'" found when accepting '+t+" on "+e.type);e[t]=n}},acceptRequired:function(e,t){if(this.acceptKey(e,t),!e[t])throw new i.default(e.type+" requires "+t)},acceptArray:function(e){for(var t=0,n=e.length;t<n;t++)this.acceptKey(e,t),e[t]||(e.splice(t,1),t--,n--)},accept:function(e){if(e){if(!this[e.type])throw new i.default("Unknown type: "+e.type,e);this.current&&this.parents.unshift(this.current),this.current=e;var t=this[e.type](e);return this.current=this.parents.shift(),!this.mutating||t?t:!1!==t?e:void 0}},Program:function(e){this.acceptArray(e.body)},MustacheStatement:s,Decorator:s,BlockStatement:l,DecoratorBlock:l,PartialStatement:c,PartialBlockStatement:function(e){c.call(this,e),this.acceptKey(e,"program")},ContentStatement:function(){},CommentStatement:function(){},SubExpression:s,PathExpression:function(){},StringLiteral:function(){},NumberLiteral:function(){},BooleanLiteral:function(){},UndefinedLiteral:function(){},NullLiteral:function(){},Hash:function(e){this.acceptArray(e.pairs)},HashPair:function(e){this.acceptRequired(e,"value")}},t.default=a,e.exports=t.default},915:(e,t,n)=>{t.__esModule=!0;var r,o=n(350),i=(r=o)&&r.__esModule?r:{default:r};function a(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];this.options=e}function s(e,t,n){void 0===t&&(t=e.length);var r=e[t-1],o=e[t-2];return r?"ContentStatement"===r.type?(o||!n?/\r?\n\s*?$/:/(^|\r?\n)\s*?$/).test(r.original):void 0:n}function l(e,t,n){void 0===t&&(t=-1);var r=e[t+1],o=e[t+2];return r?"ContentStatement"===r.type?(o||!n?/^\s*?\r?\n/:/^\s*?(\r?\n|$)/).test(r.original):void 0:n}function c(e,t,n){var r=e[null==t?0:t+1];if(r&&"ContentStatement"===r.type&&(n||!r.rightStripped)){var o=r.value;r.value=r.value.replace(n?/^\s+/:/^[ \t]*\r?\n?/,""),r.rightStripped=r.value!==o}}function u(e,t,n){var r=e[null==t?e.length-1:t-1];if(r&&"ContentStatement"===r.type&&(n||!r.leftStripped)){var o=r.value;return r.value=r.value.replace(n?/\s+$/:/[ \t]+$/,""),r.leftStripped=r.value!==o,r.leftStripped}}a.prototype=new i.default,a.prototype.Program=function(e){var t=!this.options.ignoreStandalone,n=!this.isRootSeen;this.isRootSeen=!0;for(var r=e.body,o=0,i=r.length;o<i;o++){var a=r[o],p=this.accept(a);if(p){var h=s(r,o,n),d=l(r,o,n),f=p.openStandalone&&h,m=p.closeStandalone&&d,g=p.inlineStandalone&&h&&d;p.close&&c(r,o,!0),p.open&&u(r,o,!0),t&&g&&(c(r,o),u(r,o)&&"PartialStatement"===a.type&&(a.indent=/([ \t]+$)/.exec(r[o-1].original)[1])),t&&f&&(c((a.program||a.inverse).body),u(r,o)),t&&m&&(c(r,o),u((a.inverse||a.program).body))}}return e},a.prototype.BlockStatement=a.prototype.DecoratorBlock=a.prototype.PartialBlockStatement=function(e){this.accept(e.program),this.accept(e.inverse);var t=e.program||e.inverse,n=e.program&&e.inverse,r=n,o=n;if(n&&n.chained)for(r=n.body[0].program;o.chained;)o=o.body[o.body.length-1].program;var i={open:e.openStrip.open,close:e.closeStrip.close,openStandalone:l(t.body),closeStandalone:s((r||t).body)};if(e.openStrip.close&&c(t.body,null,!0),n){var a=e.inverseStrip;a.open&&u(t.body,null,!0),a.close&&c(r.body,null,!0),e.closeStrip.open&&u(o.body,null,!0),!this.options.ignoreStandalone&&s(t.body)&&l(r.body)&&(u(t.body),c(r.body))}else e.closeStrip.open&&u(t.body,null,!0);return i},a.prototype.Decorator=a.prototype.MustacheStatement=function(e){return e.strip},a.prototype.PartialStatement=a.prototype.CommentStatement=function(e){var t=e.strip||{};return{inlineStandalone:!0,open:t.open,close:t.close}},t.default=a,e.exports=t.default},940:(e,t,n)=>{t.__esModule=!0,t.registerDefaultDecorators=function(e){i.default(e)};var r,o=n(430),i=(r=o)&&r.__esModule?r:{default:r}},430:(e,t,n)=>{t.__esModule=!0;var r=n(849);t.default=function(e){e.registerDecorator("inline",(function(e,t,n,o){var i=e;return t.partials||(t.partials={},i=function(o,i){var a=n.partials;n.partials=r.extend({},a,t.partials);var s=e(o,i);return n.partials=a,s}),t.partials[o.args[0]]=o.fn,i}))},e.exports=t.default},769:(e,t)=>{t.__esModule=!0;var n=["description","fileName","lineNumber","endLineNumber","message","name","number","stack"];function r(e,t){var o=t&&t.loc,i=void 0,a=void 0,s=void 0,l=void 0;o&&(i=o.start.line,a=o.end.line,s=o.start.column,l=o.end.column,e+=" - "+i+":"+s);for(var c=Error.prototype.constructor.call(this,e),u=0;u<n.length;u++)this[n[u]]=c[n[u]];Error.captureStackTrace&&Error.captureStackTrace(this,r);try{o&&(this.lineNumber=i,this.endLineNumber=a,Object.defineProperty?(Object.defineProperty(this,"column",{value:s,enumerable:!0}),Object.defineProperty(this,"endColumn",{value:l,enumerable:!0})):(this.column=s,this.endColumn=l))}catch(e){}}r.prototype=new Error,t.default=r,e.exports=t.default},277:(e,t,n)=>{function r(e){return e&&e.__esModule?e:{default:e}}t.__esModule=!0,t.registerDefaultHelpers=function(e){o.default(e),i.default(e),a.default(e),s.default(e),l.default(e),c.default(e),u.default(e)},t.moveHelperToHooks=function(e,t,n){e.helpers[t]&&(e.hooks[t]=e.helpers[t],n||delete e.helpers[t])};var o=r(n(97)),i=r(n(785)),a=r(n(353)),s=r(n(355)),l=r(n(300)),c=r(n(466)),u=r(n(908))},97:(e,t,n)=>{t.__esModule=!0;var r=n(849);t.default=function(e){e.registerHelper("blockHelperMissing",(function(t,n){var o=n.inverse,i=n.fn;if(!0===t)return i(this);if(!1===t||null==t)return o(this);if(r.isArray(t))return t.length>0?(n.ids&&(n.ids=[n.name]),e.helpers.each(t,n)):o(this);if(n.data&&n.ids){var a=r.createFrame(n.data);a.contextPath=r.appendContextPath(n.data.contextPath,n.name),n={data:a}}return i(t,n)}))},e.exports=t.default},785:(e,t,n)=>{t.__esModule=!0;var r,o=n(849),i=n(769),a=(r=i)&&r.__esModule?r:{default:r};t.default=function(e){e.registerHelper("each",(function(e,t){if(!t)throw new a.default("Must pass iterator to #each");var n,r=t.fn,i=t.inverse,s=0,l="",c=void 0,u=void 0;function p(t,n,i){c&&(c.key=t,c.index=n,c.first=0===n,c.last=!!i,u&&(c.contextPath=u+t)),l+=r(e[t],{data:c,blockParams:o.blockParams([e[t],t],[u+t,null])})}if(t.data&&t.ids&&(u=o.appendContextPath(t.data.contextPath,t.ids[0])+"."),o.isFunction(e)&&(e=e.call(this)),t.data&&(c=o.createFrame(t.data)),e&&"object"==typeof e)if(o.isArray(e))for(var h=e.length;s<h;s++)s in e&&p(s,s,s===e.length-1);else if("function"==typeof Symbol&&e[Symbol.iterator]){for(var d=[],f=e[Symbol.iterator](),m=f.next();!m.done;m=f.next())d.push(m.value);for(h=(e=d).length;s<h;s++)p(s,s,s===e.length-1)}else n=void 0,Object.keys(e).forEach((function(e){void 0!==n&&p(n,s-1),n=e,s++})),void 0!==n&&p(n,s-1,!0);return 0===s&&(l=i(this)),l}))},e.exports=t.default},353:(e,t,n)=>{t.__esModule=!0;var r,o=n(769),i=(r=o)&&r.__esModule?r:{default:r};t.default=function(e){e.registerHelper("helperMissing",(function(){if(1!==arguments.length)throw new i.default('Missing helper: "'+arguments[arguments.length-1].name+'"')}))},e.exports=t.default},355:(e,t,n)=>{t.__esModule=!0;var r,o=n(849),i=n(769),a=(r=i)&&r.__esModule?r:{default:r};t.default=function(e){e.registerHelper("if",(function(e,t){if(2!=arguments.length)throw new a.default("#if requires exactly one argument");return o.isFunction(e)&&(e=e.call(this)),!t.hash.includeZero&&!e||o.isEmpty(e)?t.inverse(this):t.fn(this)})),e.registerHelper("unless",(function(t,n){if(2!=arguments.length)throw new a.default("#unless requires exactly one argument");return e.helpers.if.call(this,t,{fn:n.inverse,inverse:n.fn,hash:n.hash})}))},e.exports=t.default},300:(e,t)=>{t.__esModule=!0,t.default=function(e){e.registerHelper("log",(function(){for(var t=[void 0],n=arguments[arguments.length-1],r=0;r<arguments.length-1;r++)t.push(arguments[r]);var o=1;null!=n.hash.level?o=n.hash.level:n.data&&null!=n.data.level&&(o=n.data.level),t[0]=o,e.log.apply(e,t)}))},e.exports=t.default},466:(e,t)=>{t.__esModule=!0,t.default=function(e){e.registerHelper("lookup",(function(e,t,n){return e?n.lookupProperty(e,t):e}))},e.exports=t.default},908:(e,t,n)=>{t.__esModule=!0;var r,o=n(849),i=n(769),a=(r=i)&&r.__esModule?r:{default:r};t.default=function(e){e.registerHelper("with",(function(e,t){if(2!=arguments.length)throw new a.default("#with requires exactly one argument");o.isFunction(e)&&(e=e.call(this));var n=t.fn;if(o.isEmpty(e))return t.inverse(this);var r=t.data;return t.data&&t.ids&&((r=o.createFrame(t.data)).contextPath=o.appendContextPath(t.data.contextPath,t.ids[0])),n(e,{data:r,blockParams:o.blockParams([e],[r&&r.contextPath])})}))},e.exports=t.default},726:(e,t,n)=>{t.__esModule=!0,t.createNewLookupObject=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return r.extend.apply(void 0,[Object.create(null)].concat(t))};var r=n(849)},865:(e,t,n)=>{t.__esModule=!0,t.createProtoAccessControl=function(e){var t=Object.create(null);t.constructor=!1,t.__defineGetter__=!1,t.__defineSetter__=!1,t.__lookupGetter__=!1;var n=Object.create(null);return n.__proto__=!1,{properties:{whitelist:o.createNewLookupObject(n,e.allowedProtoProperties),defaultValue:e.allowProtoPropertiesByDefault},methods:{whitelist:o.createNewLookupObject(t,e.allowedProtoMethods),defaultValue:e.allowProtoMethodsByDefault}}},t.resultIsAllowed=function(e,t,n){return l("function"==typeof e?t.methods:t.properties,n)},t.resetLoggedProperties=function(){Object.keys(s).forEach((function(e){delete s[e]}))};var r,o=n(726),i=n(566),a=(r=i)&&r.__esModule?r:{default:r},s=Object.create(null);function l(e,t){return void 0!==e.whitelist[t]?!0===e.whitelist[t]:void 0!==e.defaultValue?e.defaultValue:(function(e){!0!==s[e]&&(s[e]=!0,a.default.log("error",'Handlebars: Access has been denied to resolve the property "'+e+'" because it is not an "own property" of its parent.\nYou can add a runtime option to disable the check or this warning:\nSee https://handlebarsjs.com/api-reference/runtime-options.html#options-to-control-prototype-access for details'))}(t),!1)}},614:(e,t)=>{t.__esModule=!0,t.wrapHelper=function(e,t){if("function"!=typeof e)return e;return function(){return arguments[arguments.length-1]=t(arguments[arguments.length-1]),e.apply(this,arguments)}}},566:(e,t,n)=>{t.__esModule=!0;var r=n(849),o={methodMap:["debug","info","warn","error"],level:"info",lookupLevel:function(e){if("string"==typeof e){var t=r.indexOf(o.methodMap,e.toLowerCase());e=t>=0?t:parseInt(e,10)}return e},log:function(e){if(e=o.lookupLevel(e),"undefined"!=typeof console&&o.lookupLevel(o.level)<=e){var t=o.methodMap[e];console[t]||(t="log");for(var n=arguments.length,r=Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];console[t].apply(console,r)}}};t.default=o,e.exports=t.default},148:(e,t)=>{t.__esModule=!0,t.default=function(e){"object"!=typeof globalThis&&(Object.prototype.__defineGetter__("__magic__",(function(){return this})),__magic__.globalThis=__magic__,delete Object.prototype.__magic__);var t=globalThis.Handlebars;e.noConflict=function(){return globalThis.Handlebars===e&&(globalThis.Handlebars=t),e}},e.exports=t.default},624:(e,t,n)=>{t.__esModule=!0,t.checkRevision=function(e){var t=e&&e[0]||1,n=s.COMPILER_REVISION;if(t>=s.LAST_COMPATIBLE_COMPILER_REVISION&&t<=s.COMPILER_REVISION)return;if(t<s.LAST_COMPATIBLE_COMPILER_REVISION){var r=s.REVISION_CHANGES[n],o=s.REVISION_CHANGES[t];throw new a.default("Template was precompiled with an older version of Handlebars than the current runtime. Please update your precompiler to a newer version ("+r+") or downgrade your runtime to an older version ("+o+").")}throw new a.default("Template was precompiled with a newer version of Handlebars than the current runtime. Please update your runtime to a newer version ("+e[1]+").")},t.template=function(e,t){if(!t)throw new a.default("No environment passed to template");if(!e||!e.main)throw new a.default("Unknown template object: "+typeof e);e.main.decorator=e.main_d,t.VM.checkRevision(e.compiler);var n=e.compiler&&7===e.compiler[0];var r={strict:function(e,t,n){if(!e||!(t in e))throw new a.default('"'+t+'" not defined in '+e,{loc:n});return r.lookupProperty(e,t)},lookupProperty:function(e,t){var n=e[t];return null==n||Object.prototype.hasOwnProperty.call(e,t)||u.resultIsAllowed(n,r.protoAccessControl,t)?n:void 0},lookup:function(e,t){for(var n=e.length,o=0;o<n;o++){if(null!=(e[o]&&r.lookupProperty(e[o],t)))return e[o][t]}},lambda:function(e,t){return"function"==typeof e?e.call(t):e},escapeExpression:o.escapeExpression,invokePartial:function(n,r,i){i.hash&&(r=o.extend({},r,i.hash),i.ids&&(i.ids[0]=!0)),n=t.VM.resolvePartial.call(this,n,r,i);var s=o.extend({},i,{hooks:this.hooks,protoAccessControl:this.protoAccessControl}),l=t.VM.invokePartial.call(this,n,r,s);if(null==l&&t.compile&&(i.partials[i.name]=t.compile(n,e.compilerOptions,t),l=i.partials[i.name](r,s)),null!=l){if(i.indent){for(var c=l.split("\n"),u=0,p=c.length;u<p&&(c[u]||u+1!==p);u++)c[u]=i.indent+c[u];l=c.join("\n")}return l}throw new a.default("The partial "+i.name+" could not be compiled when running in runtime-only mode")},fn:function(t){var n=e[t];return n.decorator=e[t+"_d"],n},programs:[],program:function(e,t,n,r,o){var i=this.programs[e],a=this.fn(e);return t||o||r||n?i=p(this,e,a,t,n,r,o):i||(i=this.programs[e]=p(this,e,a)),i},data:function(e,t){for(;e&&t--;)e=e._parent;return e},mergeIfNeeded:function(e,t){var n=e||t;return e&&t&&e!==t&&(n=o.extend({},t,e)),n},nullContext:Object.seal({}),noop:t.VM.noop,compilerInfo:e.compiler};function i(t){var n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],o=n.data;i._setup(n),!n.partial&&e.useData&&(o=function(e,t){t&&"root"in t||((t=t?s.createFrame(t):{}).root=e);return t}(t,o));var a=void 0,l=e.useBlockParams?[]:void 0;function c(t){return""+e.main(r,t,r.helpers,r.partials,o,l,a)}return e.useDepths&&(a=n.depths?t!=n.depths[0]?[t].concat(n.depths):n.depths:[t]),(c=d(e.main,c,r,n.depths||[],o,l))(t,n)}return i.isTop=!0,i._setup=function(i){if(i.partial)r.protoAccessControl=i.protoAccessControl,r.helpers=i.helpers,r.partials=i.partials,r.decorators=i.decorators,r.hooks=i.hooks;else{var a=o.extend({},t.helpers,i.helpers);!function(e,t){Object.keys(e).forEach((function(n){var r=e[n];e[n]=function(e,t){var n=t.lookupProperty;return c.wrapHelper(e,(function(e){return o.extend({lookupProperty:n},e)}))}(r,t)}))}(a,r),r.helpers=a,e.usePartial&&(r.partials=r.mergeIfNeeded(i.partials,t.partials)),(e.usePartial||e.useDecorators)&&(r.decorators=o.extend({},t.decorators,i.decorators)),r.hooks={},r.protoAccessControl=u.createProtoAccessControl(i);var s=i.allowCallsToHelperMissing||n;l.moveHelperToHooks(r,"helperMissing",s),l.moveHelperToHooks(r,"blockHelperMissing",s)}},i._child=function(t,n,o,i){if(e.useBlockParams&&!o)throw new a.default("must pass block params");if(e.useDepths&&!i)throw new a.default("must pass parent depths");return p(r,t,e[t],n,0,o,i)},i},t.wrapProgram=p,t.resolvePartial=function(e,t,n){e?e.call||n.name||(n.name=e,e=n.partials[e]):e="@partial-block"===n.name?n.data["partial-block"]:n.partials[n.name];return e},t.invokePartial=function(e,t,n){var r=n.data&&n.data["partial-block"];n.partial=!0,n.ids&&(n.data.contextPath=n.ids[0]||n.data.contextPath);var i=void 0;n.fn&&n.fn!==h&&function(){n.data=s.createFrame(n.data);var e=n.fn;i=n.data["partial-block"]=function(t){var n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return n.data=s.createFrame(n.data),n.data["partial-block"]=r,e(t,n)},e.partials&&(n.partials=o.extend({},n.partials,e.partials))}();void 0===e&&i&&(e=i);if(void 0===e)throw new a.default("The partial "+n.name+" could not be found");if(e instanceof Function)return e(t,n)},t.noop=h;var r,o=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(n(849)),i=n(769),a=(r=i)&&r.__esModule?r:{default:r},s=n(871),l=n(277),c=n(614),u=n(865);function p(e,t,n,r,o,i,a){function s(t){var o=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],s=a;return!a||t==a[0]||t===e.nullContext&&null===a[0]||(s=[t].concat(a)),n(e,t,e.helpers,e.partials,o.data||r,i&&[o.blockParams].concat(i),s)}return(s=d(n,s,e,a,r,i)).program=t,s.depth=a?a.length:0,s.blockParams=o||0,s}function h(){return""}function d(e,t,n,r,i,a){if(e.decorator){var s={};t=e.decorator(t,s,n,r&&r[0],i,a,r),o.extend(t,s)}return t}},613:(e,t)=>{function n(e){this.string=e}t.__esModule=!0,n.prototype.toString=n.prototype.toHTML=function(){return""+this.string},t.default=n,e.exports=t.default},849:(e,t)=>{t.__esModule=!0,t.extend=a,t.indexOf=function(e,t){for(var n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1},t.escapeExpression=function(e){if("string"!=typeof e){if(e&&e.toHTML)return e.toHTML();if(null==e)return"";if(!e)return e+"";e=""+e}if(!o.test(e))return e;return e.replace(r,i)},t.isEmpty=function(e){return!e&&0!==e||!(!c(e)||0!==e.length)},t.createFrame=function(e){var t=a({},e);return t._parent=e,t},t.blockParams=function(e,t){return e.path=t,e},t.appendContextPath=function(e,t){return(e?e+".":"")+t};var n={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;","=":"&#x3D;"},r=/[&<>"'`=]/g,o=/[&<>"'`=]/;function i(e){return n[e]}function a(e){for(var t=1;t<arguments.length;t++)for(var n in arguments[t])Object.prototype.hasOwnProperty.call(arguments[t],n)&&(e[n]=arguments[t][n]);return e}var s=Object.prototype.toString;t.toString=s;var l=function(e){return"function"==typeof e};l(/x/)&&(t.isFunction=l=function(e){return"function"==typeof e&&"[object Function]"===s.call(e)}),t.isFunction=l;var c=Array.isArray||function(e){return!(!e||"object"!=typeof e)&&"[object Array]"===s.call(e)};t.isArray=c}},h={};function d(e){var t=h[e];if(void 0!==t)return t.exports;var n=h[e]={exports:{}};return p[e](n,n.exports,d),n.exports}d.d=(e,t)=>{for(var n in t)d.o(t,n)&&!d.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},d.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);class f extends Error{data;constructor(e,t){super(e),this.data=t}toString(){return this.message}}async function m(e,t){const n=SillyTavern.getContext(),r=new FormData;r.append("avatar",new Blob([JSON.stringify(e)],{type:"application/json"}),"character.json"),r.append("file_type","json");const o=n.getRequestHeaders();delete o["Content-Type"];const i=await fetch("/api/characters/import",{method:"POST",headers:o,body:r,cache:"no-cache"});if(!i.ok)throw new f(i.statusText,i);(t??1)&&await n.getCharacters()}class g{settingsKey;defaultSettings;constructor(e,t){this.settingsKey=e,this.defaultSettings=t}async initializeSettings(e={}){const{strategy:t="recursive"}=e,n=this.defaultSettings.version,r=this.defaultSettings.formatVersion,o=SillyTavern.getContext().extensionSettings[this.settingsKey],i={version:{changed:!1,new:n??""},formatVersion:{changed:!1,new:r??""},oldSettings:null,newSettings:this.defaultSettings};if(!o)return SillyTavern.getContext().extensionSettings[this.settingsKey]=this.defaultSettings,this.saveSettings(),i;const a={...i,oldSettings:structuredClone(o),version:{changed:!1,old:o.version,new:o.version},formatVersion:{changed:!1,old:o.formatVersion,new:o.formatVersion}};if("recursive"===t){function s(e,t){let n=!1;for(const r of Object.keys(t))void 0===e[r]?(e[r]=t[r],n=!0):"object"==typeof t[r]&&null!==t[r]&&(e[r]=e[r]||{},s(e[r],t[r])&&(n=!0));return n}n&&o.version!==n&&(a.version.changed=!0,a.version.new=n,o.version=n),r&&"*"!==r&&o.formatVersion!==r&&(a.formatVersion.changed=!0,a.formatVersion.new=r,o.formatVersion=r),(s(o,this.defaultSettings)||a.version.changed||a.formatVersion.changed)&&this.saveSettings()}else if(Array.isArray(t)){n&&!o.version&&(o.version=n,a.version.changed=!0,a.version.new=n),r&&!o.formatVersion&&(o.formatVersion=r,a.formatVersion.changed=!0,a.formatVersion.new=r);let l=structuredClone(o),c=o.formatVersion;try{let u;do{u=!1;let p=t.find((e=>e.from===c));if(p&&p.to>c)l=await p.action(l),c=p.to,l.formatVersion=p.to,u=!0;else for(const h of t)if("*"===h.from&&h.to>c&&c!==h.to){l=await h.action(l),c=h.to,l.formatVersion=h.to,u=!0;break}}while(u);if(c!==o.formatVersion){a.formatVersion.changed=!0,a.formatVersion.new=c;const d=this.defaultSettings.version;d&&(l.version=d)}if(a.formatVersion.changed){for(const f of Object.keys(o))delete o[f];Object.assign(o,l),this.saveSettings()}}catch(m){throw console.error("Failed to apply version changes:",m),new Error(`Version migration failed: ${m instanceof Error?m.message:m}`,{cause:m})}}return a.newSettings=o,a}getSettings(){return SillyTavern.getContext().extensionSettings[this.settingsKey]}updateSetting(e,t){SillyTavern.getContext().extensionSettings[this.settingsKey][e]=t,this.saveSettings()}saveSettings(){SillyTavern.getContext().saveSettingsDebounced()}resetSettings(){SillyTavern.getContext().extensionSettings[this.settingsKey]=this.defaultSettings,this.saveSettings()}}function v(e){return Array.isArray?Array.isArray(e):"[object Array]"===E(e)}function y(e){return"string"==typeof e}function b(e){return"number"==typeof e}function x(e){return!0===e||!1===e||function(e){return w(e)&&null!==e}(e)&&"[object Boolean]"==E(e)}function w(e){return"object"==typeof e}function S(e){return null!=e}function _(e){return!e.trim().length}function E(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":Object.prototype.toString.call(e)}const k=Object.prototype.hasOwnProperty;class C{constructor(e){this._keys=[],this._keyMap={};let t=0;e.forEach((e=>{let n=P(e);this._keys.push(n),this._keyMap[n.id]=n,t+=n.weight})),this._keys.forEach((e=>{e.weight/=t}))}get(e){return this._keyMap[e]}keys(){return this._keys}toJSON(){return JSON.stringify(this._keys)}}function P(e){let t=null,n=null,r=null,o=1,i=null;if(y(e)||v(e))r=e,t=N(e),n=A(e);else{if(!k.call(e,"name"))throw new Error((e=>`Missing ${e} property in key`)("name"));const a=e.name;if(r=a,k.call(e,"weight")&&(o=e.weight,o<=0))throw new Error((e=>`Property 'weight' in key '${e}' must be a positive integer`)(a));t=N(a),n=A(a),i=e.getFn}return{path:t,id:n,weight:o,src:r,getFn:i}}function N(e){return v(e)?e:e.split(".")}function A(e){return v(e)?e.join("."):e}const O={useExtendedSearch:!1,getFn:function(e,t){let n=[],r=!1;const o=(e,t,i)=>{if(S(e))if(t[i]){const a=e[t[i]];if(!S(a))return;if(i===t.length-1&&(y(a)||b(a)||x(a)))n.push(function(e){return null==e?"":function(e){if("string"==typeof e)return e;let t=e+"";return"0"==t&&1/e==-1/0?"-0":t}(e)}(a));else if(v(a)){r=!0;for(let e=0,n=a.length;e<n;e+=1)o(a[e],t,i+1)}else t.length&&o(a,t,i+1)}else n.push(e)};return o(e,y(t)?t.split("."):t,0),r?n:n[0]},ignoreLocation:!1,ignoreFieldNorm:!1,fieldNormWeight:1};var D={isCaseSensitive:!1,ignoreDiacritics:!1,includeScore:!1,keys:[],shouldSort:!0,sortFn:(e,t)=>e.score===t.score?e.idx<t.idx?-1:1:e.score<t.score?-1:1,includeMatches:!1,findAllMatches:!1,minMatchCharLength:1,location:0,threshold:.6,distance:100,...O};const I=/[^ ]+/g;class T{constructor({getFn:e=D.getFn,fieldNormWeight:t=D.fieldNormWeight}={}){this.norm=function(e=1,t=3){const n=new Map,r=Math.pow(10,t);return{get(t){const o=t.match(I).length;if(n.has(o))return n.get(o);const i=1/Math.pow(o,.5*e),a=parseFloat(Math.round(i*r)/r);return n.set(o,a),a},clear(){n.clear()}}}(t,3),this.getFn=e,this.isCreated=!1,this.setIndexRecords()}setSources(e=[]){this.docs=e}setIndexRecords(e=[]){this.records=e}setKeys(e=[]){this.keys=e,this._keysMap={},e.forEach(((e,t)=>{this._keysMap[e.id]=t}))}create(){!this.isCreated&&this.docs.length&&(this.isCreated=!0,y(this.docs[0])?this.docs.forEach(((e,t)=>{this._addString(e,t)})):this.docs.forEach(((e,t)=>{this._addObject(e,t)})),this.norm.clear())}add(e){const t=this.size();y(e)?this._addString(e,t):this._addObject(e,t)}removeAt(e){this.records.splice(e,1);for(let t=e,n=this.size();t<n;t+=1)this.records[t].i-=1}getValueForItemAtKeyId(e,t){return e[this._keysMap[t]]}size(){return this.records.length}_addString(e,t){if(!S(e)||_(e))return;let n={v:e,i:t,n:this.norm.get(e)};this.records.push(n)}_addObject(e,t){let n={i:t,$:{}};this.keys.forEach(((t,r)=>{let o=t.getFn?t.getFn(e):this.getFn(e,t.path);if(S(o))if(v(o)){let e=[];const t=[{nestedArrIndex:-1,value:o}];for(;t.length;){const{nestedArrIndex:n,value:r}=t.pop();if(S(r))if(y(r)&&!_(r)){let t={v:r,i:n,n:this.norm.get(r)};e.push(t)}else v(r)&&r.forEach(((e,n)=>{t.push({nestedArrIndex:n,value:e})}))}n.$[r]=e}else if(y(o)&&!_(o)){let e={v:o,n:this.norm.get(o)};n.$[r]=e}})),this.records.push(n)}toJSON(){return{keys:this.keys,records:this.records}}}function L(e,t,{getFn:n=D.getFn,fieldNormWeight:r=D.fieldNormWeight}={}){const o=new T({getFn:n,fieldNormWeight:r});return o.setKeys(e.map(P)),o.setSources(t),o.create(),o}function F(e,{errors:t=0,currentLocation:n=0,expectedLocation:r=0,distance:o=D.distance,ignoreLocation:i=D.ignoreLocation}={}){const a=t/e.length;if(i)return a;const s=Math.abs(r-n);return o?a+s/o:s?1:a}const M=32;function j(e,t,n,{location:r=D.location,distance:o=D.distance,threshold:i=D.threshold,findAllMatches:a=D.findAllMatches,minMatchCharLength:s=D.minMatchCharLength,includeMatches:l=D.includeMatches,ignoreLocation:c=D.ignoreLocation}={}){if(t.length>M)throw new Error(`Pattern length exceeds max of ${M}.`);const u=t.length,p=e.length,h=Math.max(0,Math.min(r,p));let d=i,f=h;const m=s>1||l,g=m?Array(p):[];let v;for(;(v=e.indexOf(t,f))>-1;){let e=F(t,{currentLocation:v,expectedLocation:h,distance:o,ignoreLocation:c});if(d=Math.min(e,d),f=v+u,m){let e=0;for(;e<u;)g[v+e]=1,e+=1}}f=-1;let y=[],b=1,x=u+p;const w=1<<u-1;for(let r=0;r<u;r+=1){let i=0,s=x;for(;i<s;){F(t,{errors:r,currentLocation:h+s,expectedLocation:h,distance:o,ignoreLocation:c})<=d?i=s:x=s,s=Math.floor((x-i)/2+i)}x=s;let l=Math.max(1,h-s+1),v=a?p:Math.min(h+s,p)+u,S=Array(v+2);S[v+1]=(1<<r)-1;for(let i=v;i>=l;i-=1){let a=i-1,s=n[e.charAt(a)];if(m&&(g[a]=+!!s),S[i]=(S[i+1]<<1|1)&s,r&&(S[i]|=(y[i+1]|y[i])<<1|1|y[i+1]),S[i]&w&&(b=F(t,{errors:r,currentLocation:a,expectedLocation:h,distance:o,ignoreLocation:c}),b<=d)){if(d=b,f=a,f<=h)break;l=Math.max(1,2*h-f)}}if(F(t,{errors:r+1,currentLocation:h,expectedLocation:h,distance:o,ignoreLocation:c})>d)break;y=S}const S={isMatch:f>=0,score:Math.max(.001,b)};if(m){const e=function(e=[],t=D.minMatchCharLength){let n=[],r=-1,o=-1,i=0;for(let a=e.length;i<a;i+=1){let a=e[i];a&&-1===r?r=i:a||-1===r||(o=i-1,o-r+1>=t&&n.push([r,o]),r=-1)}return e[i-1]&&i-r>=t&&n.push([r,i-1]),n}(g,s);e.length?l&&(S.indices=e):S.isMatch=!1}return S}function B(e){let t={};for(let n=0,r=e.length;n<r;n+=1){const o=e.charAt(n);t[o]=(t[o]||0)|1<<r-n-1}return t}const R=String.prototype.normalize?e=>e.normalize("NFD").replace(/[\u0300-\u036F\u0483-\u0489\u0591-\u05BD\u05BF\u05C1\u05C2\u05C4\u05C5\u05C7\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06DC\u06DF-\u06E4\u06E7\u06E8\u06EA-\u06ED\u0711\u0730-\u074A\u07A6-\u07B0\u07EB-\u07F3\u07FD\u0816-\u0819\u081B-\u0823\u0825-\u0827\u0829-\u082D\u0859-\u085B\u08D3-\u08E1\u08E3-\u0903\u093A-\u093C\u093E-\u094F\u0951-\u0957\u0962\u0963\u0981-\u0983\u09BC\u09BE-\u09C4\u09C7\u09C8\u09CB-\u09CD\u09D7\u09E2\u09E3\u09FE\u0A01-\u0A03\u0A3C\u0A3E-\u0A42\u0A47\u0A48\u0A4B-\u0A4D\u0A51\u0A70\u0A71\u0A75\u0A81-\u0A83\u0ABC\u0ABE-\u0AC5\u0AC7-\u0AC9\u0ACB-\u0ACD\u0AE2\u0AE3\u0AFA-\u0AFF\u0B01-\u0B03\u0B3C\u0B3E-\u0B44\u0B47\u0B48\u0B4B-\u0B4D\u0B56\u0B57\u0B62\u0B63\u0B82\u0BBE-\u0BC2\u0BC6-\u0BC8\u0BCA-\u0BCD\u0BD7\u0C00-\u0C04\u0C3E-\u0C44\u0C46-\u0C48\u0C4A-\u0C4D\u0C55\u0C56\u0C62\u0C63\u0C81-\u0C83\u0CBC\u0CBE-\u0CC4\u0CC6-\u0CC8\u0CCA-\u0CCD\u0CD5\u0CD6\u0CE2\u0CE3\u0D00-\u0D03\u0D3B\u0D3C\u0D3E-\u0D44\u0D46-\u0D48\u0D4A-\u0D4D\u0D57\u0D62\u0D63\u0D82\u0D83\u0DCA\u0DCF-\u0DD4\u0DD6\u0DD8-\u0DDF\u0DF2\u0DF3\u0E31\u0E34-\u0E3A\u0E47-\u0E4E\u0EB1\u0EB4-\u0EB9\u0EBB\u0EBC\u0EC8-\u0ECD\u0F18\u0F19\u0F35\u0F37\u0F39\u0F3E\u0F3F\u0F71-\u0F84\u0F86\u0F87\u0F8D-\u0F97\u0F99-\u0FBC\u0FC6\u102B-\u103E\u1056-\u1059\u105E-\u1060\u1062-\u1064\u1067-\u106D\u1071-\u1074\u1082-\u108D\u108F\u109A-\u109D\u135D-\u135F\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17B4-\u17D3\u17DD\u180B-\u180D\u1885\u1886\u18A9\u1920-\u192B\u1930-\u193B\u1A17-\u1A1B\u1A55-\u1A5E\u1A60-\u1A7C\u1A7F\u1AB0-\u1ABE\u1B00-\u1B04\u1B34-\u1B44\u1B6B-\u1B73\u1B80-\u1B82\u1BA1-\u1BAD\u1BE6-\u1BF3\u1C24-\u1C37\u1CD0-\u1CD2\u1CD4-\u1CE8\u1CED\u1CF2-\u1CF4\u1CF7-\u1CF9\u1DC0-\u1DF9\u1DFB-\u1DFF\u20D0-\u20F0\u2CEF-\u2CF1\u2D7F\u2DE0-\u2DFF\u302A-\u302F\u3099\u309A\uA66F-\uA672\uA674-\uA67D\uA69E\uA69F\uA6F0\uA6F1\uA802\uA806\uA80B\uA823-\uA827\uA880\uA881\uA8B4-\uA8C5\uA8E0-\uA8F1\uA8FF\uA926-\uA92D\uA947-\uA953\uA980-\uA983\uA9B3-\uA9C0\uA9E5\uAA29-\uAA36\uAA43\uAA4C\uAA4D\uAA7B-\uAA7D\uAAB0\uAAB2-\uAAB4\uAAB7\uAAB8\uAABE\uAABF\uAAC1\uAAEB-\uAAEF\uAAF5\uAAF6\uABE3-\uABEA\uABEC\uABED\uFB1E\uFE00-\uFE0F\uFE20-\uFE2F]/g,""):e=>e;class V{constructor(e,{location:t=D.location,threshold:n=D.threshold,distance:r=D.distance,includeMatches:o=D.includeMatches,findAllMatches:i=D.findAllMatches,minMatchCharLength:a=D.minMatchCharLength,isCaseSensitive:s=D.isCaseSensitive,ignoreDiacritics:l=D.ignoreDiacritics,ignoreLocation:c=D.ignoreLocation}={}){if(this.options={location:t,threshold:n,distance:r,includeMatches:o,findAllMatches:i,minMatchCharLength:a,isCaseSensitive:s,ignoreDiacritics:l,ignoreLocation:c},e=s?e:e.toLowerCase(),e=l?R(e):e,this.pattern=e,this.chunks=[],!this.pattern.length)return;const u=(e,t)=>{this.chunks.push({pattern:e,alphabet:B(e),startIndex:t})},p=this.pattern.length;if(p>M){let e=0;const t=p%M,n=p-t;for(;e<n;)u(this.pattern.substr(e,M),e),e+=M;if(t){const e=p-M;u(this.pattern.substr(e),e)}}else u(this.pattern,0)}searchIn(e){const{isCaseSensitive:t,ignoreDiacritics:n,includeMatches:r}=this.options;if(e=t?e:e.toLowerCase(),e=n?R(e):e,this.pattern===e){let t={isMatch:!0,score:0};return r&&(t.indices=[[0,e.length-1]]),t}const{location:o,distance:i,threshold:a,findAllMatches:s,minMatchCharLength:l,ignoreLocation:c}=this.options;let u=[],p=0,h=!1;this.chunks.forEach((({pattern:t,alphabet:n,startIndex:d})=>{const{isMatch:f,score:m,indices:g}=j(e,t,n,{location:o+d,distance:i,threshold:a,findAllMatches:s,minMatchCharLength:l,includeMatches:r,ignoreLocation:c});f&&(h=!0),p+=m,f&&g&&(u=[...u,...g])}));let d={isMatch:h,score:h?p/this.chunks.length:1};return h&&r&&(d.indices=u),d}}class H{constructor(e){this.pattern=e}static isMultiMatch(e){return q(e,this.multiRegex)}static isSingleMatch(e){return q(e,this.singleRegex)}search(){}}function q(e,t){const n=e.match(t);return n?n[1]:null}class W extends H{constructor(e,{location:t=D.location,threshold:n=D.threshold,distance:r=D.distance,includeMatches:o=D.includeMatches,findAllMatches:i=D.findAllMatches,minMatchCharLength:a=D.minMatchCharLength,isCaseSensitive:s=D.isCaseSensitive,ignoreDiacritics:l=D.ignoreDiacritics,ignoreLocation:c=D.ignoreLocation}={}){super(e),this._bitapSearch=new V(e,{location:t,threshold:n,distance:r,includeMatches:o,findAllMatches:i,minMatchCharLength:a,isCaseSensitive:s,ignoreDiacritics:l,ignoreLocation:c})}static get type(){return"fuzzy"}static get multiRegex(){return/^"(.*)"$/}static get singleRegex(){return/^(.*)$/}search(e){return this._bitapSearch.searchIn(e)}}class U extends H{constructor(e){super(e)}static get type(){return"include"}static get multiRegex(){return/^'"(.*)"$/}static get singleRegex(){return/^'(.*)$/}search(e){let t,n=0;const r=[],o=this.pattern.length;for(;(t=e.indexOf(this.pattern,n))>-1;)n=t+o,r.push([t,n-1]);const i=!!r.length;return{isMatch:i,score:i?0:1,indices:r}}}const Y=[class extends H{constructor(e){super(e)}static get type(){return"exact"}static get multiRegex(){return/^="(.*)"$/}static get singleRegex(){return/^=(.*)$/}search(e){const t=e===this.pattern;return{isMatch:t,score:t?0:1,indices:[0,this.pattern.length-1]}}},U,class extends H{constructor(e){super(e)}static get type(){return"prefix-exact"}static get multiRegex(){return/^\^"(.*)"$/}static get singleRegex(){return/^\^(.*)$/}search(e){const t=e.startsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,this.pattern.length-1]}}},class extends H{constructor(e){super(e)}static get type(){return"inverse-prefix-exact"}static get multiRegex(){return/^!\^"(.*)"$/}static get singleRegex(){return/^!\^(.*)$/}search(e){const t=!e.startsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,e.length-1]}}},class extends H{constructor(e){super(e)}static get type(){return"inverse-suffix-exact"}static get multiRegex(){return/^!"(.*)"\$$/}static get singleRegex(){return/^!(.*)\$$/}search(e){const t=!e.endsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,e.length-1]}}},class extends H{constructor(e){super(e)}static get type(){return"suffix-exact"}static get multiRegex(){return/^"(.*)"\$$/}static get singleRegex(){return/^(.*)\$$/}search(e){const t=e.endsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[e.length-this.pattern.length,e.length-1]}}},class extends H{constructor(e){super(e)}static get type(){return"inverse-exact"}static get multiRegex(){return/^!"(.*)"$/}static get singleRegex(){return/^!(.*)$/}search(e){const t=-1===e.indexOf(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,e.length-1]}}},W],G=Y.length,X=/ +(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/;const K=new Set([W.type,U.type]);class z{constructor(e,{isCaseSensitive:t=D.isCaseSensitive,ignoreDiacritics:n=D.ignoreDiacritics,includeMatches:r=D.includeMatches,minMatchCharLength:o=D.minMatchCharLength,ignoreLocation:i=D.ignoreLocation,findAllMatches:a=D.findAllMatches,location:s=D.location,threshold:l=D.threshold,distance:c=D.distance}={}){this.query=null,this.options={isCaseSensitive:t,ignoreDiacritics:n,includeMatches:r,minMatchCharLength:o,findAllMatches:a,ignoreLocation:i,location:s,threshold:l,distance:c},e=t?e:e.toLowerCase(),e=n?R(e):e,this.pattern=e,this.query=function(e,t={}){return e.split("|").map((e=>{let n=e.trim().split(X).filter((e=>e&&!!e.trim())),r=[];for(let e=0,o=n.length;e<o;e+=1){const o=n[e];let i=!1,a=-1;for(;!i&&++a<G;){const e=Y[a];let n=e.isMultiMatch(o);n&&(r.push(new e(n,t)),i=!0)}if(!i)for(a=-1;++a<G;){const e=Y[a];let n=e.isSingleMatch(o);if(n){r.push(new e(n,t));break}}}return r}))}(this.pattern,this.options)}static condition(e,t){return t.useExtendedSearch}searchIn(e){const t=this.query;if(!t)return{isMatch:!1,score:1};const{includeMatches:n,isCaseSensitive:r,ignoreDiacritics:o}=this.options;e=r?e:e.toLowerCase(),e=o?R(e):e;let i=0,a=[],s=0;for(let r=0,o=t.length;r<o;r+=1){const o=t[r];a.length=0,i=0;for(let t=0,r=o.length;t<r;t+=1){const r=o[t],{isMatch:l,indices:c,score:u}=r.search(e);if(!l){s=0,i=0,a.length=0;break}if(i+=1,s+=u,n){const e=r.constructor.type;K.has(e)?a=[...a,...c]:a.push(c)}}if(i){let e={isMatch:!0,score:s/i};return n&&(e.indices=a),e}}return{isMatch:!1,score:1}}}const J=[];function Z(e,t){for(let n=0,r=J.length;n<r;n+=1){let r=J[n];if(r.condition(e,t))return new r(e,t)}return new V(e,t)}const Q="$and",ee="$or",te="$path",ne="$val",re=e=>!(!e[Q]&&!e[ee]),oe=e=>({[Q]:Object.keys(e).map((t=>({[t]:e[t]})))});function ie(e,t,{auto:n=!0}={}){const r=e=>{let o=Object.keys(e);const i=(e=>!!e[te])(e);if(!i&&o.length>1&&!re(e))return r(oe(e));if((e=>!v(e)&&w(e)&&!re(e))(e)){const r=i?e[te]:o[0],a=i?e[ne]:e[r];if(!y(a))throw new Error((e=>`Invalid value for key ${e}`)(r));const s={keyId:A(r),pattern:a};return n&&(s.searcher=Z(a,t)),s}let a={children:[],operator:o[0]};return o.forEach((t=>{const n=e[t];v(n)&&n.forEach((e=>{a.children.push(r(e))}))})),a};return re(e)||(e=oe(e)),r(e)}function ae(e,t){const n=e.matches;t.matches=[],S(n)&&n.forEach((e=>{if(!S(e.indices)||!e.indices.length)return;const{indices:n,value:r}=e;let o={indices:n,value:r};e.key&&(o.key=e.key.src),e.idx>-1&&(o.refIndex=e.idx),t.matches.push(o)}))}function se(e,t){t.score=e.score}class le{constructor(e,t={},n){this.options={...D,...t},this.options.useExtendedSearch,this._keyStore=new C(this.options.keys),this.setCollection(e,n)}setCollection(e,t){if(this._docs=e,t&&!(t instanceof T))throw new Error("Incorrect 'index' type");this._myIndex=t||L(this.options.keys,this._docs,{getFn:this.options.getFn,fieldNormWeight:this.options.fieldNormWeight})}add(e){S(e)&&(this._docs.push(e),this._myIndex.add(e))}remove(e=()=>!1){const t=[];for(let n=0,r=this._docs.length;n<r;n+=1){const o=this._docs[n];e(o,n)&&(this.removeAt(n),n-=1,r-=1,t.push(o))}return t}removeAt(e){this._docs.splice(e,1),this._myIndex.removeAt(e)}getIndex(){return this._myIndex}search(e,{limit:t=-1}={}){const{includeMatches:n,includeScore:r,shouldSort:o,sortFn:i,ignoreFieldNorm:a}=this.options;let s=y(e)?y(this._docs[0])?this._searchStringList(e):this._searchObjectList(e):this._searchLogical(e);return function(e,{ignoreFieldNorm:t=D.ignoreFieldNorm}){e.forEach((e=>{let n=1;e.matches.forEach((({key:e,norm:r,score:o})=>{const i=e?e.weight:null;n*=Math.pow(0===o&&i?Number.EPSILON:o,(i||1)*(t?1:r))})),e.score=n}))}(s,{ignoreFieldNorm:a}),o&&s.sort(i),b(t)&&t>-1&&(s=s.slice(0,t)),function(e,t,{includeMatches:n=D.includeMatches,includeScore:r=D.includeScore}={}){const o=[];return n&&o.push(ae),r&&o.push(se),e.map((e=>{const{idx:n}=e,r={item:t[n],refIndex:n};return o.length&&o.forEach((t=>{t(e,r)})),r}))}(s,this._docs,{includeMatches:n,includeScore:r})}_searchStringList(e){const t=Z(e,this.options),{records:n}=this._myIndex,r=[];return n.forEach((({v:e,i:n,n:o})=>{if(!S(e))return;const{isMatch:i,score:a,indices:s}=t.searchIn(e);i&&r.push({item:e,idx:n,matches:[{score:a,value:e,norm:o,indices:s}]})})),r}_searchLogical(e){const t=ie(e,this.options),n=(e,t,r)=>{if(!e.children){const{keyId:n,searcher:o}=e,i=this._findMatches({key:this._keyStore.get(n),value:this._myIndex.getValueForItemAtKeyId(t,n),searcher:o});return i&&i.length?[{idx:r,item:t,matches:i}]:[]}const o=[];for(let i=0,a=e.children.length;i<a;i+=1){const a=e.children[i],s=n(a,t,r);if(s.length)o.push(...s);else if(e.operator===Q)return[]}return o},r=this._myIndex.records,o={},i=[];return r.forEach((({$:e,i:r})=>{if(S(e)){let a=n(t,e,r);a.length&&(o[r]||(o[r]={idx:r,item:e,matches:[]},i.push(o[r])),a.forEach((({matches:e})=>{o[r].matches.push(...e)})))}})),i}_searchObjectList(e){const t=Z(e,this.options),{keys:n,records:r}=this._myIndex,o=[];return r.forEach((({$:e,i:r})=>{if(!S(e))return;let i=[];n.forEach(((n,r)=>{i.push(...this._findMatches({key:n,value:e[r],searcher:t}))})),i.length&&o.push({idx:r,item:e,matches:i})})),o}_findMatches({key:e,value:t,searcher:n}){if(!S(t))return[];let r=[];if(v(t))t.forEach((({v:t,i:o,n:i})=>{if(!S(t))return;const{isMatch:a,score:s,indices:l}=n.searchIn(t);a&&r.push({score:s,key:e,value:t,idx:o,norm:i,indices:l})}));else{const{v:o,n:i}=t,{isMatch:a,score:s,indices:l}=n.searchIn(o);a&&r.push({score:s,key:e,value:o,norm:i,indices:l})}return r}}function ce(e,t={}){const n="string"==typeof e?document.querySelector(e):e;if(!n)throw new Error(`Could not find container: ${e}`);const r=t.placeholderText||"Select items...",o=t.closeOnSelect??!1,i=t.enableSearch??!1,a=t.multiple??!0,s=t.searchPlaceholderText||"Search...",l=t.searchNoResultsText||"No results found",c=t.searchDebounceMs??200;let u=[...t.initialList||[]];n.innerHTML="",n.classList.add("fancy-dropdown-container"),Object.assign(n.style,{position:"relative",userSelect:"none"});const p=document.createElement("div");p.className="fancy-dropdown-trigger",Object.assign(p.style,{padding:"8px 12px",border:"1px solid var(--border-color)",backgroundColor:"var(--bg-color)",color:"var(--text-color)",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"space-between"});const h=document.createElement("span");h.className="fancy-dropdown-trigger-text",h.textContent=r;const d=document.createElement("i");d.className="fas fa-chevron-down",d.style.marginLeft="8px",p.append(h,d),n.append(p);const f=document.createElement("div");f.className="fancy-dropdown-list",Object.assign(f.style,{position:"absolute",top:"100%",left:"0",right:"0",maxHeight:"300px",display:"none",zIndex:"1050",border:"1px solid var(--border-color)",borderTop:"none",backgroundColor:"var(--bg-color-popup, var(--bg-color-secondary, var(--greyCAIbg, var(--grey30))))",color:"var(--text-color)",borderRadius:"0 0 4px 4px",boxShadow:"0 4px 8px var(--black50a)",overflowY:"auto"}),n.append(f);let m=null,g=null,v=null,y=null;i&&(g=document.createElement("div"),g.className="fancy-dropdown-search-wrapper",Object.assign(g.style,{padding:"8px",borderBottom:"1px solid var(--border-color)",position:"sticky",top:"0",backgroundColor:"inherit"}),m=document.createElement("input"),m.type="text",m.className="fancy-dropdown-search-input",m.placeholder=s,Object.assign(m.style,{width:"100%",padding:"6px 10px",border:"1px solid var(--border-color)",borderRadius:"3px",boxSizing:"border-box",backgroundColor:"var(--bg-color)",color:"var(--text-color)"}),m.addEventListener("click",(e=>e.stopPropagation())),g.append(m),f.append(g),v=document.createElement("div"),v.className="fancy-dropdown-no-results",v.textContent=l,Object.assign(v.style,{padding:"8px 12px",textAlign:"center",color:"var(--text-color-secondary, var(--grey50))",display:"none"}),f.append(v));let b=!1,x=null;const w=e=>"string"==typeof e?e:e.label,S=e=>"string"==typeof e?e:e.value;let _=(t.initialValues||[]).filter((e=>u.some((t=>S(t)===e))));const E=()=>{if(!i)return;const e={includeScore:!1,threshold:.4,isCaseSensitive:!1,findAllMatches:!0,...t.searchFuseOptions||{},keys:t.searchFuseOptions?.keys||[{name:"label",weight:.7},{name:"value",weight:.3}]},n=u.map((e=>"string"==typeof e?{value:e,label:e}:e));!t.searchFuseOptions?.keys&&u.every((e=>"string"==typeof e))&&(e.keys=["label"]),x=new le(n,e)},k=e=>{let t=!1;f.querySelectorAll(".fancy-dropdown-item").forEach((n=>{const r=n.dataset.value,o=_.includes(r),i=n.querySelector(".checkmark");o?(n.classList.add("selected"),i&&(i.style.display="inline-block")):(n.classList.remove("selected"),i&&(i.style.display="none")),void 0!==e?e.includes(r)?(n.style.display="flex",t=!0):n.style.display="none":(n.style.display="flex",t=!0)})),i&&v&&(v.style.display=void 0===e||t?"none":"block"),(()=>{if(0===_.length)h.textContent=r;else if(1===_.length){const e=_[0],t=u.find((t=>S(t)===e)),n=t?w(t):e;h.textContent=n}else h.textContent=`${_.length} items selected`})()},C=e=>{if(!i||!x)return void k();const t=e.trim();if(""===t)return void k(void 0);const n=x.search(t).map((e=>e.item.value));k(n)},P=()=>{m&&(y&&clearTimeout(y),y=window.setTimeout((()=>{m&&C(m.value)}),c))},N=()=>{b||(b=!0,f.style.display="block",d.classList.remove("fa-chevron-down"),d.classList.add("fa-chevron-up"),i&&m&&setTimeout((()=>m?.focus()),50))},A=()=>{b&&(b=!1,f.style.display="none",i&&m&&(m.value="",C("")),d.classList.remove("fa-chevron-up"),d.classList.add("fa-chevron-down"),y&&clearTimeout(y))};p.addEventListener("click",(e=>{e.stopPropagation(),b?A():N()})),document.addEventListener("click",(e=>{b&&n&&!n.contains(e.target)&&A()})),i&&m&&m.addEventListener("input",P);const O=(e,n)=>{const r=S(e),s=w(e),l=document.createElement("div");l.className="fancy-dropdown-item",l.dataset.value=r,Object.assign(l.style,{padding:"8px 12px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"space-between"}),l.addEventListener("mouseenter",(()=>{l.style.backgroundColor="var(--hover-color, var(--white20a))"})),l.addEventListener("mouseleave",(()=>{l.style.backgroundColor=""}));const c=document.createElement("span");c.textContent=s,l.append(c);const u=document.createElement("i");return u.className="checkmark fa-solid fa-check",Object.assign(u.style,{marginLeft:"8px",display:n?"inline-block":"none"}),l.append(u),l.addEventListener("click",(function(e){e.stopPropagation();const n=e.currentTarget.dataset.value,r=[..._];let s;s=a?_.includes(n)?_.filter((e=>e!==n)):[..._,n]:_.includes(n)?[]:[n];(async()=>{if(t.onBeforeSelection)try{if(!await Promise.resolve(t.onBeforeSelection(r,s)))return!1}catch(e){return console.error("onBeforeSelection callback failed:",e),!1}return!0})().then((e=>{e&&(_=s,i&&m&&""!==m.value.trim()?C(m.value):k(void 0),t.onSelectChange&&Promise.resolve(t.onSelectChange(r,_)).catch((e=>console.error("onSelectChange callback failed:",e))),o&&A())}))})),v?f.insertBefore(l,v):f.append(l),l};u.length>0&&u.forEach((e=>{const t=S(e);O(e,_.includes(t))})),E(),k();return{container:n,dropdownTrigger:p,dropdownList:f,getValues:()=>[..._],setValues:e=>{const n=[..._],r=e.filter((e=>u.some((t=>S(t)===e))));_=[...r],i&&m&&""!==m.value?(m.value="",C("")):k();JSON.stringify(n.sort())!==JSON.stringify(_.sort())&&t.onSelectChange&&Promise.resolve(t.onSelectChange(n,_)).catch((e=>console.error("onSelectChange callback failed:",e)))},getOptions:()=>u.map((e=>"string"==typeof e?{value:e,label:e}:e)),addOption:(e,n=!1)=>{const r=S(e);if(u.some((e=>S(e)===r)))return;u.push(e),O(e,n),E();let o=!1;const s=[..._];n&&!_.includes(r)?(a?_.push(r):_=[r],o=!0):n&&!a&&_.length>0&&_[0]!==r&&(_=[r],o=!0),i&&m&&""!==m.value?C(m.value):k(),o&&t.onSelectChange&&Promise.resolve(t.onSelectChange(s,_)).catch((e=>console.error("onSelectChange callback failed:",e)))},removeOption:e=>{const n=u.length;if(u=u.filter((t=>S(t)!==e)),u.length===n)return;let r=!1;const o=[..._],a=_.indexOf(e);a>-1&&(_.splice(a,1),r=!0);const s=f.querySelector(`.fancy-dropdown-item[data-value="${e}"]`);s?.remove(),E(),i&&m&&""!==m.value?C(m.value):k(),r&&t.onSelectChange&&Promise.resolve(t.onSelectChange(o,_)).catch((e=>console.error("onSelectChange callback failed:",e)))},selectAll:()=>{if(!a)return;const e=[..._],n=u.map(S);_=[...new Set([..._,...n])];const r=JSON.stringify(e.sort())!==JSON.stringify(_.sort());i&&m&&""!==m.value?C(m.value):k(),r&&t.onSelectChange&&Promise.resolve(t.onSelectChange(e,_)).catch((e=>console.error("onSelectChange callback failed:",e)))},deselectAll:()=>{const e=[..._];_.length>0&&(_=[],i&&m&&""!==m.value?C(m.value):k(),t.onSelectChange&&Promise.resolve(t.onSelectChange(e,_)).catch((e=>console.error("onSelectChange callback failed:",e))))},disable:()=>{n.style.pointerEvents="none",n.style.opacity="0.6",b&&A()},enable:()=>{n.style.pointerEvents="auto",n.style.opacity="1"},open:N,close:A,toggle:()=>b?A():N()}}le.version="7.1.0",le.createIndex=L,le.parseIndex=function(e,{getFn:t=D.getFn,fieldNormWeight:n=D.fieldNormWeight}={}){const{keys:r,records:o}=e,i=new T({getFn:t,fieldNormWeight:n});return i.setKeys(r),i.setIndexRecords(o),i},le.config=D,le.parseQuery=ie,function(...e){J.push(...e)}(z);const ue=(e=>{var t={};return d.d(t,e),t})({persona_description_positions:()=>e.persona_description_positions,renderStoryString:()=>e.renderStoryString});const pe=(e=>{var t={};return d.d(t,e),t})({baseChatReplace:()=>t.baseChatReplace,chat_metadata:()=>t.chat_metadata,depth_prompt_depth_default:()=>t.depth_prompt_depth_default,depth_prompt_role_default:()=>t.depth_prompt_role_default,extension_prompt_types:()=>t.extension_prompt_types,getMaxContextSize:()=>t.getMaxContextSize,name1:()=>t.name1,name2:()=>t.name2,parseMesExamples:()=>t.parseMesExamples,this_chid:()=>t.this_chid});const he=(e=>{var t={};return d.d(t,e),t})({createWorldInfoEntry:()=>n.createWorldInfoEntry,wi_anchor_position:()=>n.wi_anchor_position,world_info_include_names:()=>n.world_info_include_names,world_names:()=>n.world_names});const de=(e=>{var t={};return d.d(t,e),t})({formatInstructModeExamples:()=>r.formatInstructModeExamples,formatInstructModeSystemPrompt:()=>r.formatInstructModeSystemPrompt});const fe=(e=>{var t={};return d.d(t,e),t})({appendFileContent:()=>o.appendFileContent});const me=(e=>{var t={};return d.d(t,e),t})({formatWorldInfo:()=>i.formatWorldInfo,getPromptPosition:()=>i.getPromptPosition,getPromptRole:()=>i.getPromptRole,prepareOpenAIMessages:()=>i.prepareOpenAIMessages,setOpenAIMessageExamples:()=>i.setOpenAIMessageExamples,setOpenAIMessages:()=>i.setOpenAIMessages});const ge=(e=>{var t={};return d.d(t,e),t})({metadata_keys:()=>a.metadata_keys});const ve=(e=>{var t={};return d.d(t,e),t})({getGroupDepthPrompts:()=>s.getGroupDepthPrompts,selected_group:()=>s.selected_group});const ye=(e=>{var t={};return d.d(t,e),t})({getRegexedString:()=>l.getRegexedString,regex_placement:()=>l.regex_placement});(e=>{var t={};d.d(t,e)})({});(e=>{var t={};d.d(t,e)})({});async function be(e,t,{escapeHtml:n=!0}={}){await async function(e,...t){await SillyTavern.getContext().SlashCommandParser.commands[e].callback(...t)}("echo",{severity:e,escapeHtml:Boolean(n).toString()},t)}function xe(e){return(0,pe.getMaxContextSize)(e)}function we(e,t){return(0,pe.parseMesExamples)(e,t)}function Se(e,t,n){return(0,pe.baseChatReplace)(e,t,n)}function _e(e){return(0,me.getPromptRole)(e)}function Ee(e,{wiFormat:t}={}){return(0,me.formatWorldInfo)(e,{wiFormat:t})}function ke(e){return(0,me.getPromptPosition)(e)}function Ce(e,t={}){const n=SillyTavern.getContext(),r=t.readOnlyValues||[],o=document.querySelector(e);if(!o)throw new Error(`Could not find preset select: ${e}`);const i=e=>t.label?t.label(e):e,a=document.createElement("div");a.className="preset-select-container",a.style.display="flex",a.style.alignItems="center";const s=e=>r.includes(e);if(o.parentNode?.insertBefore(a,o),a.appendChild(o),t.initialList&&t.initialList.length>0){o.innerHTML="";const e=e=>"string"==typeof e?e:e.value;for(const n of t.initialList){const t=document.createElement("option"),r=e(n);t.value=r,t.textContent=i(r),s(r)&&(t.dataset.readonly="true"),o.appendChild(t)}}if(t.initialValue){const e=Array.from(o.options).find((e=>e.value===t.initialValue));e&&(o.value=e.value)}let l=o.value;if(o.addEventListener("change",(async()=>{const e=o.value;t.onSelectChange&&l!==e&&await t.onSelectChange(l,e),l=e})),t.create){const e=document.createElement("i");e.className="menu_button fa-solid fa-file-circle-plus";const r=i("");e.title=`Create a new ${r}`,e.setAttribute("data-i18n",`[title]Create a new ${r}`),e.addEventListener("click",(async()=>{t.create?.onPopupOpen&&await t.create.onPopupOpen();const e=i(""),r=await n.Popup.show.input(`Create a new ${e}`,`Please enter a name for the new ${e}:`,"");if(null===r||""===r.trim())return;let a=r.trim();if(Array.from(o.options).some((e=>e.value===a)))return void await be("warning",`A ${i(a)} with this name already exists.`);if(t.create?.onBeforeCreate){if(!await t.create.onBeforeCreate(a))return}if(t.create?.onAfterCreate){const e=await t.create.onAfterCreate(a);"string"==typeof e&&(a=e)}const s=document.createElement("option");s.value=a,s.textContent=i(a),o.appendChild(s);const c=o.value;o.value=a,t.onSelectChange&&c!==a&&await t.onSelectChange(c,a),l=a})),a.appendChild(e)}if(t.rename){const e=document.createElement("i");e.className="menu_button fa-solid fa-pencil";const r=i("");e.title=`Rename a ${r}`,e.setAttribute("data-i18n",`[title]Rename a ${r}`),e.addEventListener("click",(async()=>{if(-1===o.selectedIndex)return void await be("warning",`Please select a ${i("")} to rename.`);const e=o.options[o.selectedIndex];let r=e.value;if(s(r))return void await be("warning",`This ${i(r)} cannot be renamed as it is read-only.`);t.rename?.onPopupOpen&&await t.rename.onPopupOpen();const a=await n.Popup.show.input(`Rename ${i(r)}`,`Please enter a new name for "${r}":`,r);if(null===a||""===a.trim()||a===r)return;let c=a.trim();if(Array.from(o.options).some((t=>t.value===c&&t!==e)))await be("warning",`A ${i(c)} with this name already exists.`);else{if(t.rename?.onBeforeRename){if(!await t.rename.onBeforeRename(r,c))return}if(t.rename?.onAfterRename){const e=await t.rename.onAfterRename(r,c);"string"==typeof e&&(c=e)}e.value=c,e.textContent=i(c),r===l&&(l=c),t.onSelectChange&&o.value===c&&await t.onSelectChange(r,c)}})),a.appendChild(e)}if(t.delete){const e=document.createElement("i");e.className="menu_button fa-solid fa-trash-can";const r=i("");e.title=`Delete a ${r}`,e.setAttribute("data-i18n",`[title]Delete a ${r}`),e.addEventListener("click",(async()=>{if(-1===o.selectedIndex)return void await be("warning",`Please select a ${i("")} to delete.`);const e=o.options[o.selectedIndex],r=e.value,a=o.selectedIndex;if(s(r))return void await be("warning",`This ${i(r)} cannot be deleted as it is read-only.`);t.delete?.onPopupOpen&&await t.delete.onPopupOpen();if(!await n.Popup.show.confirm(`Delete ${i(r)}`,`Are you sure you want to delete "${r}"?`))return;if(t.delete?.onBeforeDelete){if(!await t.delete.onBeforeDelete(r))return}const c=r;let u,p=-1;o.options.length>1&&(p=a<o.options.length-1?a:a-1,u=o.options[p].value),o.removeChild(e),p>=0?(o.selectedIndex=p,l=u,t.onSelectChange&&await t.onSelectChange(c,u)):(t.onSelectChange&&await t.onSelectChange(c,void 0),l=void 0),t.delete?.onAfterDelete&&await t.delete.onAfterDelete(c)})),a.appendChild(e)}return{select:o,container:a}}async function Pe(e,{targetCharacterId:t,presetName:n,instructName:r,contextName:o,syspromptName:i,maxContext:a,includeNames:s,ignoreCharacterFields:l,ignoreAuthorNote:c,ignoreWorldInfo:u,messageIndexesBetween:p}={}){if(!["textgenerationwebui","openai"].includes(e))throw new Error("Unsupported API");const h=SillyTavern.getContext();let d=[],{description:f,personality:m,persona:g,scenario:v,mesExamples:y,system:b,jailbreak:x}=l?{description:"",personality:"",persona:"",scenario:"",mesExamples:"",system:"",jailbreak:""}:h.getCharacterCardFields({chid:t});const w="textgenerationwebui"===e?h.getPresetManager("instruct")?.getCompletionPresetByName(r):void 0,S=!!w?.enabled;let _=we(y,S);const E=function(){if("number"==typeof a)return a;if(!a)return xe();if("active"===a||!n)return xe();if("number"==typeof a)return a;let t;if("textgenerationwebui"===e){const e=h.getPresetManager("textgenerationwebui")?.getCompletionPresetByName(n);t=e?.max_length}else{const e=h.getPresetManager("openai")?.getCompletionPresetByName(n);t=e?.openai_max_context}return"number"==typeof t?t:xe()}();if(E<=0)return[];const k=h.ToolManager.isToolCallingSupported(),C=p?.start??0,P=p?.end?p.end+1:void 0;let N=-1===C&&0===P?[]:h.chat.slice(C,P).filter((e=>!e.is_system||k&&Array.isArray(e.extra?.tool_invocations)));N=await Promise.all(N.map((async(e,t)=>{let n=function(e,t,{characterOverride:n,isMarkdown:r,isPrompt:o,isEdit:i,depth:a}){return(0,ye.getRegexedString)(e,t,{characterOverride:n,isMarkdown:r,isPrompt:o,isEdit:i,depth:a})}(e.mes,e.is_user?ye.regex_placement.USER_INPUT:ye.regex_placement.AI_OUTPUT,{isPrompt:!0,depth:N.length-t-1});return n=await async function(e,t){return await(0,fe.appendFileContent)(e,t)}(e,n),e?.extra?.append_title&&e?.extra?.title&&(n=`${n}\n\n${e.extra.title}`),{...e,mes:n,index:t}})));const A=N.map((e=>he.world_info_include_names?`${e.name}: ${e.mes}`:e.mes)).reverse(),{worldInfoString:O,worldInfoBefore:D,worldInfoAfter:I,worldInfoExamples:T,worldInfoDepth:L,anBefore:F,anAfter:M}=u?{worldInfoString:"",worldInfoBefore:"",worldInfoAfter:"",worldInfoExamples:[],worldInfoDepth:[],anBefore:[],anAfter:[]}:await h.getWorldInfoPrompt(A,E,!1);for(const U of T){const Y=U.content;if(0===Y.length)continue;const G=we(Se(Y,pe.name1,pe.name2),S);U.position===he.wi_anchor_position.before?_.unshift(...G):_.push(...G)}function j(){let e=0;const t=[];for(let n=N.length-1;n>=0;n--){const r=N[n];if(r.extra?.token_count&&e+r.extra.token_count>E)break;e+=r.extra?.token_count||0,t.unshift({role:r.is_user?"user":"assistant",content:s?`${r.name}: ${r.mes}`:r.mes})}d.push(...t)}if("textgenerationwebui"===e){const X=[..._];_&&(_=function(e,t,n){return(0,de.formatInstructModeExamples)(e,t,n)}(_,pe.name1,pe.name2));const K=h.getPresetManager("sysprompt")?.getCompletionPresetByName(i);K&&(b=h.powerUserSettings.prefer_character_prompt&&b?b:Se(K.content,pe.name1,pe.name2),b=S?(R=h.substituteParams(b,pe.name1,pe.name2,K.content),$=w,(0,de.formatInstructModeSystemPrompt)(R,$)):b);const z={description:f,personality:m,persona:h.powerUserSettings.persona_description_position==ue.persona_description_positions.IN_PROMPT?g:"",scenario:v,system:b,char:pe.name2,user:pe.name1,wiBefore:D,wiAfter:I,loreBefore:D,loreAfter:I,mesExamples:_.join(""),mesExamplesRaw:X.join("")},J=h.getPresetManager("context")?.getCompletionPresetByName(o);let Z=function(e,{customStoryString:t,customInstructSettings:n}={}){return(0,ue.renderStoryString)(e,{customStoryString:t,customInstructSettings:n})}(z,{customInstructSettings:w,customStoryString:J?.story_string});d.push({role:"system",content:Z,ignoreInstruct:!0}),j()}else{let Q=(B=N,(0,me.setOpenAIMessages)(B)),ee=function(e){return(0,me.setOpenAIMessageExamples)(e)}(_);async function te(){let[e,t]=await function({name2:e,charDescription:t,charPersonality:n,Scenario:r,worldInfoBefore:o,worldInfoAfter:i,bias:a,type:s,quietPrompt:l,quietImage:c,extensionPrompts:u,cyclePrompt:p,systemPromptOverride:h,jailbreakPromptOverride:d,personaDescription:f,messages:m,messageExamples:g},v){return(0,me.prepareOpenAIMessages)({name2:e,charDescription:t,charPersonality:n,Scenario:r,worldInfoBefore:o,worldInfoAfter:i,bias:a,type:s,quietPrompt:l,quietImage:c,cyclePrompt:p,systemPromptOverride:h,jailbreakPromptOverride:d,personaDescription:f,extensionPrompts:u,messages:m,messageExamples:g},v)}({name2:pe.name2,charDescription:f,charPersonality:m,Scenario:v,worldInfoBefore:D,worldInfoAfter:I,extensionPrompts:h.extensionPrompts,bias:"",type:"normal",quietPrompt:void 0,quietImage:void 0,cyclePrompt:"",systemPromptOverride:b,jailbreakPromptOverride:x,personaDescription:g,messages:Q,messageExamples:ee},!1);d.push(...e)}if(!n)return await te(),d;const ne=h.getPresetManager("openai")?.getCompletionPresetByName(n);if(!ne)return console.warn(`Preset not found: ${n}. Using current preset.`),te(),d;let re=ne.prompt_order.find((e=>e.character_id===pe.this_chid));if(!re&&ne.prompt_order.length>0&&(re=ne.prompt_order[0]),!re)return console.warn(`No prompt order found for preset: ${n}. Using current preset.`),te(),d;const oe=v&&ne.scenario_format?h.substituteParams(ne.scenario_format):"",ie=m&&ne.personality_format?h.substituteParams(ne.personality_format):"",ae=h.substituteParams(ne.group_nudge_prompt),se=ne.impersonation_prompt?h.substituteParams(ne.impersonation_prompt):"",le=[];u&&le.push({role:"system",content:Ee(D,{wiFormat:ne.wi_format}),identifier:"worldInfoBefore"},{role:"system",content:Ee(I,{wiFormat:ne.wi_format}),identifier:"worldInfoAfter"}),l||le.push({role:"system",content:f,identifier:"charDescription"},{role:"system",content:ie,identifier:"charPersonality"},{role:"system",content:oe,identifier:"scenario"}),le.push({role:"system",content:se,identifier:"impersonate"},{role:"system",content:ae,identifier:"groupNudge"});const ce=h.extensionPrompts["1_memory"];ce&&ce.value&&le.push({role:_e(ce.role),content:ce.value,identifier:"summary",position:ke(ce.position)});const be=h.extensionPrompts["2_floating_prompt"];!c&&be&&be.value&&le.push({role:_e(be.role),content:be.value,identifier:"authorsNote",position:ke(be.position)});const Ce=h.extensionPrompts["3_vectors"];Ce&&Ce.value&&le.push({role:"system",content:Ce.value,identifier:"vectorsMemory",position:ke(Ce.position)});const Pe=h.extensionPrompts["4_vectors_data_bank"];Pe&&Pe.value&&le.push({role:_e(Pe.role),content:Pe.value,identifier:"vectorsDataBank",position:ke(Pe.position)});const Ne=h.extensionPrompts.chromadb;Ne&&Ne.value&&le.push({role:"system",content:Ne.value,identifier:"smartContext",position:ke(Ne.position)}),!l&&h.powerUserSettings.persona_description&&h.powerUserSettings.persona_description_position===ue.persona_description_positions.IN_PROMPT&&le.push({role:"system",content:h.powerUserSettings.persona_description,identifier:"personaDescription"}),re.order.forEach((e=>{if(!e.enabled)return;const t=(n=e.identifier,le.find((e=>e.identifier===n)));var n;t&&t.content?d.push({role:t.role??"system",content:h.substituteParams(t.content)}):"chatHistory"===e.identifier&&j()}))}var B,R,$;const V=["1_memory","2_floating_prompt","3_vectors","4_vectors_data_bank","chromadb","PERSONA_DESCRIPTION","QUIET_PROMPT","DEPTH_PROMPT"];for(const Ae in h.extensionPrompts)if(Object.hasOwn(h.extensionPrompts,Ae)){const Oe=h.extensionPrompts[Ae];if(V.includes(Ae))continue;if(!h.extensionPrompts[Ae].value)continue;if(![pe.extension_prompt_types.BEFORE_PROMPT,pe.extension_prompt_types.IN_PROMPT].includes(Oe.position))continue;if("function"==typeof Oe.filter&&!await Oe.filter())continue;Oe.position===pe.extension_prompt_types.BEFORE_PROMPT?d=[...d.slice(0,Oe.depth),{role:_e(Oe.role)??"system",content:Oe.value},...d.slice(Oe.depth)]:Oe.position===pe.extension_prompt_types.IN_PROMPT&&(d=[...d.slice(0,d.length-Oe.depth),{role:_e(Oe.role)??"system",content:Oe.value},...d.slice(d.length-Oe.depth)])}for(const De of L)d=[...d.slice(0,d.length-De.depth),{role:_e(De.role),content:De.entries.join("\n")},...d.slice(d.length-De.depth)];if(!l){const Ie=(H=ve.selected_group,q=Number(pe.this_chid),(0,ve.getGroupDepthPrompts)(H,q));if(ve.selected_group&&Array.isArray(Ie)&&Ie.length>0)Ie.filter((e=>e.text)).forEach(((e,t)=>{d=[...d.slice(0,d.length-e.depth),{role:e.role,content:e.text},...d.slice(d.length-e.depth)]}));else{const Te=Se(h.characters[pe.this_chid]?.data?.extensions?.depth_prompt?.prompt?.trim(),pe.name1,pe.name2)||"";if(Te){const Le=pe.depth_prompt_depth_default,Fe=h.characters[pe.this_chid]?.data?.extensions?.depth_prompt?.role??pe.depth_prompt_role_default;d=[...d.slice(0,d.length-Le),{role:_e(Fe),content:Te},...d.slice(d.length-Le)]}}}var H,q;let W=-1;if(!c){const Me={prompt:pe.chat_metadata[ge.metadata_keys.prompt],interval:pe.chat_metadata[ge.metadata_keys.interval],position:pe.chat_metadata[ge.metadata_keys.position],depth:pe.chat_metadata[ge.metadata_keys.depth],role:pe.chat_metadata[ge.metadata_keys.role]};if(Me.prompt)switch(Me.prompt=Se(Me.prompt,pe.name1,pe.name2),Me.position){case pe.extension_prompt_types.IN_PROMPT:d=[...d.slice(0,1),{role:"user",content:Me.prompt},...d.slice(1)],W=1;break;case pe.extension_prompt_types.IN_CHAT:d=[...d.slice(0,d.length-Me.depth),{role:_e(Me.role),content:Me.prompt},...d.slice(d.length-Me.depth)],W=d.length-Me.depth-1;break;case pe.extension_prompt_types.BEFORE_PROMPT:d.unshift({role:"user",content:Me.prompt}),W=0}}return W>=0&&(F.length>0&&(d=[...d.slice(0,W),{role:"system",content:F.join("\n")},...d.slice(W)],W++),M.length>0&&(d=[...d.slice(0,W+1),{role:"system",content:M.join("\n")},...d.slice(W+1)])),d}
/**!
 * Sortable 1.15.6
 * @author	RubaXa   <trash@rubaxa.org>
 * @author	owenm    <owen23355@gmail.com>
 * @license MIT
 */
function Ne(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Ae(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ne(Object(n),!0).forEach((function(t){De(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ne(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Oe(e){return Oe="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Oe(e)}function De(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Ie(){return Ie=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},Ie.apply(this,arguments)}function Te(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}function Le(e){if("undefined"!=typeof window&&window.navigator)return!!navigator.userAgent.match(e)}var Fe=Le(/(?:Trident.*rv[ :]?11\.|msie|iemobile|Windows Phone)/i),Me=Le(/Edge/i),je=Le(/firefox/i),Be=Le(/safari/i)&&!Le(/chrome/i)&&!Le(/android/i),Re=Le(/iP(ad|od|hone)/i),$e=Le(/chrome/i)&&Le(/android/i),Ve={capture:!1,passive:!1};function He(e,t,n){e.addEventListener(t,n,!Fe&&Ve)}function qe(e,t,n){e.removeEventListener(t,n,!Fe&&Ve)}function We(e,t){if(t){if(">"===t[0]&&(t=t.substring(1)),e)try{if(e.matches)return e.matches(t);if(e.msMatchesSelector)return e.msMatchesSelector(t);if(e.webkitMatchesSelector)return e.webkitMatchesSelector(t)}catch(e){return!1}return!1}}function Ue(e){return e.host&&e!==document&&e.host.nodeType?e.host:e.parentNode}function Ye(e,t,n,r){if(e){n=n||document;do{if(null!=t&&(">"===t[0]?e.parentNode===n&&We(e,t):We(e,t))||r&&e===n)return e;if(e===n)break}while(e=Ue(e))}return null}var Ge,Xe=/\s+/g;function Ke(e,t,n){if(e&&t)if(e.classList)e.classList[n?"add":"remove"](t);else{var r=(" "+e.className+" ").replace(Xe," ").replace(" "+t+" "," ");e.className=(r+(n?" "+t:"")).replace(Xe," ")}}function ze(e,t,n){var r=e&&e.style;if(r){if(void 0===n)return document.defaultView&&document.defaultView.getComputedStyle?n=document.defaultView.getComputedStyle(e,""):e.currentStyle&&(n=e.currentStyle),void 0===t?n:n[t];t in r||-1!==t.indexOf("webkit")||(t="-webkit-"+t),r[t]=n+("string"==typeof n?"":"px")}}function Je(e,t){var n="";if("string"==typeof e)n=e;else do{var r=ze(e,"transform");r&&"none"!==r&&(n=r+" "+n)}while(!t&&(e=e.parentNode));var o=window.DOMMatrix||window.WebKitCSSMatrix||window.CSSMatrix||window.MSCSSMatrix;return o&&new o(n)}function Ze(e,t,n){if(e){var r=e.getElementsByTagName(t),o=0,i=r.length;if(n)for(;o<i;o++)n(r[o],o);return r}return[]}function Qe(){var e=document.scrollingElement;return e||document.documentElement}function et(e,t,n,r,o){if(e.getBoundingClientRect||e===window){var i,a,s,l,c,u,p;if(e!==window&&e.parentNode&&e!==Qe()?(a=(i=e.getBoundingClientRect()).top,s=i.left,l=i.bottom,c=i.right,u=i.height,p=i.width):(a=0,s=0,l=window.innerHeight,c=window.innerWidth,u=window.innerHeight,p=window.innerWidth),(t||n)&&e!==window&&(o=o||e.parentNode,!Fe))do{if(o&&o.getBoundingClientRect&&("none"!==ze(o,"transform")||n&&"static"!==ze(o,"position"))){var h=o.getBoundingClientRect();a-=h.top+parseInt(ze(o,"border-top-width")),s-=h.left+parseInt(ze(o,"border-left-width")),l=a+i.height,c=s+i.width;break}}while(o=o.parentNode);if(r&&e!==window){var d=Je(o||e),f=d&&d.a,m=d&&d.d;d&&(l=(a/=m)+(u/=m),c=(s/=f)+(p/=f))}return{top:a,left:s,bottom:l,right:c,width:p,height:u}}}function tt(e,t,n){for(var r=at(e,!0),o=et(e)[t];r;){var i=et(r)[n];if(!("top"===n||"left"===n?o>=i:o<=i))return r;if(r===Qe())break;r=at(r,!1)}return!1}function nt(e,t,n,r){for(var o=0,i=0,a=e.children;i<a.length;){if("none"!==a[i].style.display&&a[i]!==hn.ghost&&(r||a[i]!==hn.dragged)&&Ye(a[i],n.draggable,e,!1)){if(o===t)return a[i];o++}i++}return null}function rt(e,t){for(var n=e.lastElementChild;n&&(n===hn.ghost||"none"===ze(n,"display")||t&&!We(n,t));)n=n.previousElementSibling;return n||null}function ot(e,t){var n=0;if(!e||!e.parentNode)return-1;for(;e=e.previousElementSibling;)"TEMPLATE"===e.nodeName.toUpperCase()||e===hn.clone||t&&!We(e,t)||n++;return n}function it(e){var t=0,n=0,r=Qe();if(e)do{var o=Je(e),i=o.a,a=o.d;t+=e.scrollLeft*i,n+=e.scrollTop*a}while(e!==r&&(e=e.parentNode));return[t,n]}function at(e,t){if(!e||!e.getBoundingClientRect)return Qe();var n=e,r=!1;do{if(n.clientWidth<n.scrollWidth||n.clientHeight<n.scrollHeight){var o=ze(n);if(n.clientWidth<n.scrollWidth&&("auto"==o.overflowX||"scroll"==o.overflowX)||n.clientHeight<n.scrollHeight&&("auto"==o.overflowY||"scroll"==o.overflowY)){if(!n.getBoundingClientRect||n===document.body)return Qe();if(r||t)return n;r=!0}}}while(n=n.parentNode);return Qe()}function st(e,t){return Math.round(e.top)===Math.round(t.top)&&Math.round(e.left)===Math.round(t.left)&&Math.round(e.height)===Math.round(t.height)&&Math.round(e.width)===Math.round(t.width)}function lt(e,t){return function(){if(!Ge){var n=arguments;1===n.length?e.call(this,n[0]):e.apply(this,n),Ge=setTimeout((function(){Ge=void 0}),t)}}}function ct(e,t,n){e.scrollLeft+=t,e.scrollTop+=n}function ut(e){var t=window.Polymer,n=window.jQuery||window.Zepto;return t&&t.dom?t.dom(e).cloneNode(!0):n?n(e).clone(!0)[0]:e.cloneNode(!0)}function pt(e,t,n){var r={};return Array.from(e.children).forEach((function(o){var i,a,s,l;if(Ye(o,t.draggable,e,!1)&&!o.animated&&o!==n){var c=et(o);r.left=Math.min(null!==(i=r.left)&&void 0!==i?i:1/0,c.left),r.top=Math.min(null!==(a=r.top)&&void 0!==a?a:1/0,c.top),r.right=Math.max(null!==(s=r.right)&&void 0!==s?s:-1/0,c.right),r.bottom=Math.max(null!==(l=r.bottom)&&void 0!==l?l:-1/0,c.bottom)}})),r.width=r.right-r.left,r.height=r.bottom-r.top,r.x=r.left,r.y=r.top,r}var ht="Sortable"+(new Date).getTime();function dt(){var e,t=[];return{captureAnimationState:function(){(t=[],this.options.animation)&&[].slice.call(this.el.children).forEach((function(e){if("none"!==ze(e,"display")&&e!==hn.ghost){t.push({target:e,rect:et(e)});var n=Ae({},t[t.length-1].rect);if(e.thisAnimationDuration){var r=Je(e,!0);r&&(n.top-=r.f,n.left-=r.e)}e.fromRect=n}}))},addAnimationState:function(e){t.push(e)},removeAnimationState:function(e){t.splice(function(e,t){for(var n in e)if(e.hasOwnProperty(n))for(var r in t)if(t.hasOwnProperty(r)&&t[r]===e[n][r])return Number(n);return-1}(t,{target:e}),1)},animateAll:function(n){var r=this;if(!this.options.animation)return clearTimeout(e),void("function"==typeof n&&n());var o=!1,i=0;t.forEach((function(e){var t=0,n=e.target,a=n.fromRect,s=et(n),l=n.prevFromRect,c=n.prevToRect,u=e.rect,p=Je(n,!0);p&&(s.top-=p.f,s.left-=p.e),n.toRect=s,n.thisAnimationDuration&&st(l,s)&&!st(a,s)&&(u.top-s.top)/(u.left-s.left)==(a.top-s.top)/(a.left-s.left)&&(t=function(e,t,n,r){return Math.sqrt(Math.pow(t.top-e.top,2)+Math.pow(t.left-e.left,2))/Math.sqrt(Math.pow(t.top-n.top,2)+Math.pow(t.left-n.left,2))*r.animation}(u,l,c,r.options)),st(s,a)||(n.prevFromRect=a,n.prevToRect=s,t||(t=r.options.animation),r.animate(n,u,s,t)),t&&(o=!0,i=Math.max(i,t),clearTimeout(n.animationResetTimer),n.animationResetTimer=setTimeout((function(){n.animationTime=0,n.prevFromRect=null,n.fromRect=null,n.prevToRect=null,n.thisAnimationDuration=null}),t),n.thisAnimationDuration=t)})),clearTimeout(e),o?e=setTimeout((function(){"function"==typeof n&&n()}),i):"function"==typeof n&&n(),t=[]},animate:function(e,t,n,r){if(r){ze(e,"transition",""),ze(e,"transform","");var o=Je(this.el),i=o&&o.a,a=o&&o.d,s=(t.left-n.left)/(i||1),l=(t.top-n.top)/(a||1);e.animatingX=!!s,e.animatingY=!!l,ze(e,"transform","translate3d("+s+"px,"+l+"px,0)"),this.forRepaintDummy=function(e){return e.offsetWidth}(e),ze(e,"transition","transform "+r+"ms"+(this.options.easing?" "+this.options.easing:"")),ze(e,"transform","translate3d(0,0,0)"),"number"==typeof e.animated&&clearTimeout(e.animated),e.animated=setTimeout((function(){ze(e,"transition",""),ze(e,"transform",""),e.animated=!1,e.animatingX=!1,e.animatingY=!1}),r)}}}}var ft=[],mt={initializeByDefault:!0},gt={mount:function(e){for(var t in mt)mt.hasOwnProperty(t)&&!(t in e)&&(e[t]=mt[t]);ft.forEach((function(t){if(t.pluginName===e.pluginName)throw"Sortable: Cannot mount plugin ".concat(e.pluginName," more than once")})),ft.push(e)},pluginEvent:function(e,t,n){var r=this;this.eventCanceled=!1,n.cancel=function(){r.eventCanceled=!0};var o=e+"Global";ft.forEach((function(r){t[r.pluginName]&&(t[r.pluginName][o]&&t[r.pluginName][o](Ae({sortable:t},n)),t.options[r.pluginName]&&t[r.pluginName][e]&&t[r.pluginName][e](Ae({sortable:t},n)))}))},initializePlugins:function(e,t,n,r){for(var o in ft.forEach((function(r){var o=r.pluginName;if(e.options[o]||r.initializeByDefault){var i=new r(e,t,e.options);i.sortable=e,i.options=e.options,e[o]=i,Ie(n,i.defaults)}})),e.options)if(e.options.hasOwnProperty(o)){var i=this.modifyOption(e,o,e.options[o]);void 0!==i&&(e.options[o]=i)}},getEventProperties:function(e,t){var n={};return ft.forEach((function(r){"function"==typeof r.eventProperties&&Ie(n,r.eventProperties.call(t[r.pluginName],e))})),n},modifyOption:function(e,t,n){var r;return ft.forEach((function(o){e[o.pluginName]&&o.optionListeners&&"function"==typeof o.optionListeners[t]&&(r=o.optionListeners[t].call(e[o.pluginName],n))})),r}};function vt(e){var t=e.sortable,n=e.rootEl,r=e.name,o=e.targetEl,i=e.cloneEl,a=e.toEl,s=e.fromEl,l=e.oldIndex,c=e.newIndex,u=e.oldDraggableIndex,p=e.newDraggableIndex,h=e.originalEvent,d=e.putSortable,f=e.extraEventProperties;if(t=t||n&&n[ht]){var m,g=t.options,v="on"+r.charAt(0).toUpperCase()+r.substr(1);!window.CustomEvent||Fe||Me?(m=document.createEvent("Event")).initEvent(r,!0,!0):m=new CustomEvent(r,{bubbles:!0,cancelable:!0}),m.to=a||n,m.from=s||n,m.item=o||n,m.clone=i,m.oldIndex=l,m.newIndex=c,m.oldDraggableIndex=u,m.newDraggableIndex=p,m.originalEvent=h,m.pullMode=d?d.lastPutMode:void 0;var y=Ae(Ae({},f),gt.getEventProperties(r,t));for(var b in y)m[b]=y[b];n&&n.dispatchEvent(m),g[v]&&g[v].call(t,m)}}var yt=["evt"],bt=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=n.evt,o=Te(n,yt);gt.pluginEvent.bind(hn)(e,t,Ae({dragEl:wt,parentEl:St,ghostEl:_t,rootEl:Et,nextEl:kt,lastDownEl:Ct,cloneEl:Pt,cloneHidden:Nt,dragStarted:Vt,putSortable:Lt,activeSortable:hn.active,originalEvent:r,oldIndex:At,oldDraggableIndex:Dt,newIndex:Ot,newDraggableIndex:It,hideGhostForTarget:ln,unhideGhostForTarget:cn,cloneNowHidden:function(){Nt=!0},cloneNowShown:function(){Nt=!1},dispatchSortableEvent:function(e){xt({sortable:t,name:e,originalEvent:r})}},o))};function xt(e){vt(Ae({putSortable:Lt,cloneEl:Pt,targetEl:wt,rootEl:Et,oldIndex:At,oldDraggableIndex:Dt,newIndex:Ot,newDraggableIndex:It},e))}var wt,St,_t,Et,kt,Ct,Pt,Nt,At,Ot,Dt,It,Tt,Lt,Ft,Mt,jt,Bt,Rt,$t,Vt,Ht,qt,Wt,Ut,Yt=!1,Gt=!1,Xt=[],Kt=!1,zt=!1,Jt=[],Zt=!1,Qt=[],en="undefined"!=typeof document,tn=Re,nn=Me||Fe?"cssFloat":"float",rn=en&&!$e&&!Re&&"draggable"in document.createElement("div"),on=function(){if(en){if(Fe)return!1;var e=document.createElement("x");return e.style.cssText="pointer-events:auto","auto"===e.style.pointerEvents}}(),an=function(e,t){var n=ze(e),r=parseInt(n.width)-parseInt(n.paddingLeft)-parseInt(n.paddingRight)-parseInt(n.borderLeftWidth)-parseInt(n.borderRightWidth),o=nt(e,0,t),i=nt(e,1,t),a=o&&ze(o),s=i&&ze(i),l=a&&parseInt(a.marginLeft)+parseInt(a.marginRight)+et(o).width,c=s&&parseInt(s.marginLeft)+parseInt(s.marginRight)+et(i).width;if("flex"===n.display)return"column"===n.flexDirection||"column-reverse"===n.flexDirection?"vertical":"horizontal";if("grid"===n.display)return n.gridTemplateColumns.split(" ").length<=1?"vertical":"horizontal";if(o&&a.float&&"none"!==a.float){var u="left"===a.float?"left":"right";return!i||"both"!==s.clear&&s.clear!==u?"horizontal":"vertical"}return o&&("block"===a.display||"flex"===a.display||"table"===a.display||"grid"===a.display||l>=r&&"none"===n[nn]||i&&"none"===n[nn]&&l+c>r)?"vertical":"horizontal"},sn=function(e){function t(e,n){return function(r,o,i,a){var s=r.options.group.name&&o.options.group.name&&r.options.group.name===o.options.group.name;if(null==e&&(n||s))return!0;if(null==e||!1===e)return!1;if(n&&"clone"===e)return e;if("function"==typeof e)return t(e(r,o,i,a),n)(r,o,i,a);var l=(n?r:o).options.group.name;return!0===e||"string"==typeof e&&e===l||e.join&&e.indexOf(l)>-1}}var n={},r=e.group;r&&"object"==Oe(r)||(r={name:r}),n.name=r.name,n.checkPull=t(r.pull,!0),n.checkPut=t(r.put),n.revertClone=r.revertClone,e.group=n},ln=function(){!on&&_t&&ze(_t,"display","none")},cn=function(){!on&&_t&&ze(_t,"display","")};en&&!$e&&document.addEventListener("click",(function(e){if(Gt)return e.preventDefault(),e.stopPropagation&&e.stopPropagation(),e.stopImmediatePropagation&&e.stopImmediatePropagation(),Gt=!1,!1}),!0);var un=function(e){if(wt){var t=function(e,t){var n;return Xt.some((function(r){var o=r[ht].options.emptyInsertThreshold;if(o&&!rt(r)){var i=et(r),a=e>=i.left-o&&e<=i.right+o,s=t>=i.top-o&&t<=i.bottom+o;return a&&s?n=r:void 0}})),n}((e=e.touches?e.touches[0]:e).clientX,e.clientY);if(t){var n={};for(var r in e)e.hasOwnProperty(r)&&(n[r]=e[r]);n.target=n.rootEl=t,n.preventDefault=void 0,n.stopPropagation=void 0,t[ht]._onDragOver(n)}}},pn=function(e){wt&&wt.parentNode[ht]._isOutsideThisEl(e.target)};function hn(e,t){if(!e||!e.nodeType||1!==e.nodeType)throw"Sortable: `el` must be an HTMLElement, not ".concat({}.toString.call(e));this.el=e,this.options=t=Ie({},t),e[ht]=this;var n={group:null,sort:!0,disabled:!1,store:null,handle:null,draggable:/^[uo]l$/i.test(e.nodeName)?">li":">*",swapThreshold:1,invertSwap:!1,invertedSwapThreshold:null,removeCloneOnHide:!0,direction:function(){return an(e,this.options)},ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",ignore:"a, img",filter:null,preventOnFilter:!0,animation:0,easing:null,setData:function(e,t){e.setData("Text",t.textContent)},dropBubble:!1,dragoverBubble:!1,dataIdAttr:"data-id",delay:0,delayOnTouchOnly:!1,touchStartThreshold:(Number.parseInt?Number:window).parseInt(window.devicePixelRatio,10)||1,forceFallback:!1,fallbackClass:"sortable-fallback",fallbackOnBody:!1,fallbackTolerance:0,fallbackOffset:{x:0,y:0},supportPointer:!1!==hn.supportPointer&&"PointerEvent"in window&&(!Be||Re),emptyInsertThreshold:5};for(var r in gt.initializePlugins(this,e,n),n)!(r in t)&&(t[r]=n[r]);for(var o in sn(t),this)"_"===o.charAt(0)&&"function"==typeof this[o]&&(this[o]=this[o].bind(this));this.nativeDraggable=!t.forceFallback&&rn,this.nativeDraggable&&(this.options.touchStartThreshold=1),t.supportPointer?He(e,"pointerdown",this._onTapStart):(He(e,"mousedown",this._onTapStart),He(e,"touchstart",this._onTapStart)),this.nativeDraggable&&(He(e,"dragover",this),He(e,"dragenter",this)),Xt.push(this.el),t.store&&t.store.get&&this.sort(t.store.get(this)||[]),Ie(this,dt())}function dn(e,t,n,r,o,i,a,s){var l,c,u=e[ht],p=u.options.onMove;return!window.CustomEvent||Fe||Me?(l=document.createEvent("Event")).initEvent("move",!0,!0):l=new CustomEvent("move",{bubbles:!0,cancelable:!0}),l.to=t,l.from=e,l.dragged=n,l.draggedRect=r,l.related=o||t,l.relatedRect=i||et(t),l.willInsertAfter=s,l.originalEvent=a,e.dispatchEvent(l),p&&(c=p.call(u,l,a)),c}function fn(e){e.draggable=!1}function mn(){Zt=!1}function gn(e){for(var t=e.tagName+e.className+e.src+e.href+e.textContent,n=t.length,r=0;n--;)r+=t.charCodeAt(n);return r.toString(36)}function vn(e){return setTimeout(e,0)}function yn(e){return clearTimeout(e)}hn.prototype={constructor:hn,_isOutsideThisEl:function(e){this.el.contains(e)||e===this.el||(Ht=null)},_getDirection:function(e,t){return"function"==typeof this.options.direction?this.options.direction.call(this,e,t,wt):this.options.direction},_onTapStart:function(e){if(e.cancelable){var t=this,n=this.el,r=this.options,o=r.preventOnFilter,i=e.type,a=e.touches&&e.touches[0]||e.pointerType&&"touch"===e.pointerType&&e,s=(a||e).target,l=e.target.shadowRoot&&(e.path&&e.path[0]||e.composedPath&&e.composedPath()[0])||s,c=r.filter;if(function(e){Qt.length=0;var t=e.getElementsByTagName("input"),n=t.length;for(;n--;){var r=t[n];r.checked&&Qt.push(r)}}(n),!wt&&!(/mousedown|pointerdown/.test(i)&&0!==e.button||r.disabled)&&!l.isContentEditable&&(this.nativeDraggable||!Be||!s||"SELECT"!==s.tagName.toUpperCase())&&!((s=Ye(s,r.draggable,n,!1))&&s.animated||Ct===s)){if(At=ot(s),Dt=ot(s,r.draggable),"function"==typeof c){if(c.call(this,e,s,this))return xt({sortable:t,rootEl:l,name:"filter",targetEl:s,toEl:n,fromEl:n}),bt("filter",t,{evt:e}),void(o&&e.preventDefault())}else if(c&&(c=c.split(",").some((function(r){if(r=Ye(l,r.trim(),n,!1))return xt({sortable:t,rootEl:r,name:"filter",targetEl:s,fromEl:n,toEl:n}),bt("filter",t,{evt:e}),!0}))))return void(o&&e.preventDefault());r.handle&&!Ye(l,r.handle,n,!1)||this._prepareDragStart(e,a,s)}}},_prepareDragStart:function(e,t,n){var r,o=this,i=o.el,a=o.options,s=i.ownerDocument;if(n&&!wt&&n.parentNode===i){var l=et(n);if(Et=i,St=(wt=n).parentNode,kt=wt.nextSibling,Ct=n,Tt=a.group,hn.dragged=wt,Ft={target:wt,clientX:(t||e).clientX,clientY:(t||e).clientY},Rt=Ft.clientX-l.left,$t=Ft.clientY-l.top,this._lastX=(t||e).clientX,this._lastY=(t||e).clientY,wt.style["will-change"]="all",r=function(){bt("delayEnded",o,{evt:e}),hn.eventCanceled?o._onDrop():(o._disableDelayedDragEvents(),!je&&o.nativeDraggable&&(wt.draggable=!0),o._triggerDragStart(e,t),xt({sortable:o,name:"choose",originalEvent:e}),Ke(wt,a.chosenClass,!0))},a.ignore.split(",").forEach((function(e){Ze(wt,e.trim(),fn)})),He(s,"dragover",un),He(s,"mousemove",un),He(s,"touchmove",un),a.supportPointer?(He(s,"pointerup",o._onDrop),!this.nativeDraggable&&He(s,"pointercancel",o._onDrop)):(He(s,"mouseup",o._onDrop),He(s,"touchend",o._onDrop),He(s,"touchcancel",o._onDrop)),je&&this.nativeDraggable&&(this.options.touchStartThreshold=4,wt.draggable=!0),bt("delayStart",this,{evt:e}),!a.delay||a.delayOnTouchOnly&&!t||this.nativeDraggable&&(Me||Fe))r();else{if(hn.eventCanceled)return void this._onDrop();a.supportPointer?(He(s,"pointerup",o._disableDelayedDrag),He(s,"pointercancel",o._disableDelayedDrag)):(He(s,"mouseup",o._disableDelayedDrag),He(s,"touchend",o._disableDelayedDrag),He(s,"touchcancel",o._disableDelayedDrag)),He(s,"mousemove",o._delayedDragTouchMoveHandler),He(s,"touchmove",o._delayedDragTouchMoveHandler),a.supportPointer&&He(s,"pointermove",o._delayedDragTouchMoveHandler),o._dragStartTimer=setTimeout(r,a.delay)}}},_delayedDragTouchMoveHandler:function(e){var t=e.touches?e.touches[0]:e;Math.max(Math.abs(t.clientX-this._lastX),Math.abs(t.clientY-this._lastY))>=Math.floor(this.options.touchStartThreshold/(this.nativeDraggable&&window.devicePixelRatio||1))&&this._disableDelayedDrag()},_disableDelayedDrag:function(){wt&&fn(wt),clearTimeout(this._dragStartTimer),this._disableDelayedDragEvents()},_disableDelayedDragEvents:function(){var e=this.el.ownerDocument;qe(e,"mouseup",this._disableDelayedDrag),qe(e,"touchend",this._disableDelayedDrag),qe(e,"touchcancel",this._disableDelayedDrag),qe(e,"pointerup",this._disableDelayedDrag),qe(e,"pointercancel",this._disableDelayedDrag),qe(e,"mousemove",this._delayedDragTouchMoveHandler),qe(e,"touchmove",this._delayedDragTouchMoveHandler),qe(e,"pointermove",this._delayedDragTouchMoveHandler)},_triggerDragStart:function(e,t){t=t||"touch"==e.pointerType&&e,!this.nativeDraggable||t?this.options.supportPointer?He(document,"pointermove",this._onTouchMove):He(document,t?"touchmove":"mousemove",this._onTouchMove):(He(wt,"dragend",this),He(Et,"dragstart",this._onDragStart));try{document.selection?vn((function(){document.selection.empty()})):window.getSelection().removeAllRanges()}catch(e){}},_dragStarted:function(e,t){if(Yt=!1,Et&&wt){bt("dragStarted",this,{evt:t}),this.nativeDraggable&&He(document,"dragover",pn);var n=this.options;!e&&Ke(wt,n.dragClass,!1),Ke(wt,n.ghostClass,!0),hn.active=this,e&&this._appendGhost(),xt({sortable:this,name:"start",originalEvent:t})}else this._nulling()},_emulateDragOver:function(){if(Mt){this._lastX=Mt.clientX,this._lastY=Mt.clientY,ln();for(var e=document.elementFromPoint(Mt.clientX,Mt.clientY),t=e;e&&e.shadowRoot&&(e=e.shadowRoot.elementFromPoint(Mt.clientX,Mt.clientY))!==t;)t=e;if(wt.parentNode[ht]._isOutsideThisEl(e),t)do{if(t[ht]){if(t[ht]._onDragOver({clientX:Mt.clientX,clientY:Mt.clientY,target:e,rootEl:t})&&!this.options.dragoverBubble)break}e=t}while(t=Ue(t));cn()}},_onTouchMove:function(e){if(Ft){var t=this.options,n=t.fallbackTolerance,r=t.fallbackOffset,o=e.touches?e.touches[0]:e,i=_t&&Je(_t,!0),a=_t&&i&&i.a,s=_t&&i&&i.d,l=tn&&Ut&&it(Ut),c=(o.clientX-Ft.clientX+r.x)/(a||1)+(l?l[0]-Jt[0]:0)/(a||1),u=(o.clientY-Ft.clientY+r.y)/(s||1)+(l?l[1]-Jt[1]:0)/(s||1);if(!hn.active&&!Yt){if(n&&Math.max(Math.abs(o.clientX-this._lastX),Math.abs(o.clientY-this._lastY))<n)return;this._onDragStart(e,!0)}if(_t){i?(i.e+=c-(jt||0),i.f+=u-(Bt||0)):i={a:1,b:0,c:0,d:1,e:c,f:u};var p="matrix(".concat(i.a,",").concat(i.b,",").concat(i.c,",").concat(i.d,",").concat(i.e,",").concat(i.f,")");ze(_t,"webkitTransform",p),ze(_t,"mozTransform",p),ze(_t,"msTransform",p),ze(_t,"transform",p),jt=c,Bt=u,Mt=o}e.cancelable&&e.preventDefault()}},_appendGhost:function(){if(!_t){var e=this.options.fallbackOnBody?document.body:Et,t=et(wt,!0,tn,!0,e),n=this.options;if(tn){for(Ut=e;"static"===ze(Ut,"position")&&"none"===ze(Ut,"transform")&&Ut!==document;)Ut=Ut.parentNode;Ut!==document.body&&Ut!==document.documentElement?(Ut===document&&(Ut=Qe()),t.top+=Ut.scrollTop,t.left+=Ut.scrollLeft):Ut=Qe(),Jt=it(Ut)}Ke(_t=wt.cloneNode(!0),n.ghostClass,!1),Ke(_t,n.fallbackClass,!0),Ke(_t,n.dragClass,!0),ze(_t,"transition",""),ze(_t,"transform",""),ze(_t,"box-sizing","border-box"),ze(_t,"margin",0),ze(_t,"top",t.top),ze(_t,"left",t.left),ze(_t,"width",t.width),ze(_t,"height",t.height),ze(_t,"opacity","0.8"),ze(_t,"position",tn?"absolute":"fixed"),ze(_t,"zIndex","100000"),ze(_t,"pointerEvents","none"),hn.ghost=_t,e.appendChild(_t),ze(_t,"transform-origin",Rt/parseInt(_t.style.width)*100+"% "+$t/parseInt(_t.style.height)*100+"%")}},_onDragStart:function(e,t){var n=this,r=e.dataTransfer,o=n.options;bt("dragStart",this,{evt:e}),hn.eventCanceled?this._onDrop():(bt("setupClone",this),hn.eventCanceled||((Pt=ut(wt)).removeAttribute("id"),Pt.draggable=!1,Pt.style["will-change"]="",this._hideClone(),Ke(Pt,this.options.chosenClass,!1),hn.clone=Pt),n.cloneId=vn((function(){bt("clone",n),hn.eventCanceled||(n.options.removeCloneOnHide||Et.insertBefore(Pt,wt),n._hideClone(),xt({sortable:n,name:"clone"}))})),!t&&Ke(wt,o.dragClass,!0),t?(Gt=!0,n._loopId=setInterval(n._emulateDragOver,50)):(qe(document,"mouseup",n._onDrop),qe(document,"touchend",n._onDrop),qe(document,"touchcancel",n._onDrop),r&&(r.effectAllowed="move",o.setData&&o.setData.call(n,r,wt)),He(document,"drop",n),ze(wt,"transform","translateZ(0)")),Yt=!0,n._dragStartId=vn(n._dragStarted.bind(n,t,e)),He(document,"selectstart",n),Vt=!0,window.getSelection().removeAllRanges(),Be&&ze(document.body,"user-select","none"))},_onDragOver:function(e){var t,n,r,o,i=this.el,a=e.target,s=this.options,l=s.group,c=hn.active,u=Tt===l,p=s.sort,h=Lt||c,d=this,f=!1;if(!Zt){if(void 0!==e.preventDefault&&e.cancelable&&e.preventDefault(),a=Ye(a,s.draggable,i,!0),A("dragOver"),hn.eventCanceled)return f;if(wt.contains(e.target)||a.animated&&a.animatingX&&a.animatingY||d._ignoreWhileAnimating===a)return D(!1);if(Gt=!1,c&&!s.disabled&&(u?p||(r=St!==Et):Lt===this||(this.lastPutMode=Tt.checkPull(this,c,wt,e))&&l.checkPut(this,c,wt,e))){if(o="vertical"===this._getDirection(e,a),t=et(wt),A("dragOverValid"),hn.eventCanceled)return f;if(r)return St=Et,O(),this._hideClone(),A("revert"),hn.eventCanceled||(kt?Et.insertBefore(wt,kt):Et.appendChild(wt)),D(!0);var m=rt(i,s.draggable);if(!m||function(e,t,n){var r=et(rt(n.el,n.options.draggable)),o=pt(n.el,n.options,_t),i=10;return t?e.clientX>o.right+i||e.clientY>r.bottom&&e.clientX>r.left:e.clientY>o.bottom+i||e.clientX>r.right&&e.clientY>r.top}(e,o,this)&&!m.animated){if(m===wt)return D(!1);if(m&&i===e.target&&(a=m),a&&(n=et(a)),!1!==dn(Et,i,wt,t,a,n,e,!!a))return O(),m&&m.nextSibling?i.insertBefore(wt,m.nextSibling):i.appendChild(wt),St=i,I(),D(!0)}else if(m&&function(e,t,n){var r=et(nt(n.el,0,n.options,!0)),o=pt(n.el,n.options,_t),i=10;return t?e.clientX<o.left-i||e.clientY<r.top&&e.clientX<r.right:e.clientY<o.top-i||e.clientY<r.bottom&&e.clientX<r.left}(e,o,this)){var g=nt(i,0,s,!0);if(g===wt)return D(!1);if(n=et(a=g),!1!==dn(Et,i,wt,t,a,n,e,!1))return O(),i.insertBefore(wt,g),St=i,I(),D(!0)}else if(a.parentNode===i){n=et(a);var v,y,b,x=wt.parentNode!==i,w=!function(e,t,n){var r=n?e.left:e.top,o=n?e.right:e.bottom,i=n?e.width:e.height,a=n?t.left:t.top,s=n?t.right:t.bottom,l=n?t.width:t.height;return r===a||o===s||r+i/2===a+l/2}(wt.animated&&wt.toRect||t,a.animated&&a.toRect||n,o),S=o?"top":"left",_=tt(a,"top","top")||tt(wt,"top","top"),E=_?_.scrollTop:void 0;if(Ht!==a&&(y=n[S],Kt=!1,zt=!w&&s.invertSwap||x),v=function(e,t,n,r,o,i,a,s){var l=r?e.clientY:e.clientX,c=r?n.height:n.width,u=r?n.top:n.left,p=r?n.bottom:n.right,h=!1;if(!a)if(s&&Wt<c*o){if(!Kt&&(1===qt?l>u+c*i/2:l<p-c*i/2)&&(Kt=!0),Kt)h=!0;else if(1===qt?l<u+Wt:l>p-Wt)return-qt}else if(l>u+c*(1-o)/2&&l<p-c*(1-o)/2)return function(e){return ot(wt)<ot(e)?1:-1}(t);if((h=h||a)&&(l<u+c*i/2||l>p-c*i/2))return l>u+c/2?1:-1;return 0}(e,a,n,o,w?1:s.swapThreshold,null==s.invertedSwapThreshold?s.swapThreshold:s.invertedSwapThreshold,zt,Ht===a),0!==v){var k=ot(wt);do{k-=v,b=St.children[k]}while(b&&("none"===ze(b,"display")||b===_t))}if(0===v||b===a)return D(!1);Ht=a,qt=v;var C=a.nextElementSibling,P=!1,N=dn(Et,i,wt,t,a,n,e,P=1===v);if(!1!==N)return 1!==N&&-1!==N||(P=1===N),Zt=!0,setTimeout(mn,30),O(),P&&!C?i.appendChild(wt):a.parentNode.insertBefore(wt,P?C:a),_&&ct(_,0,E-_.scrollTop),St=wt.parentNode,void 0===y||zt||(Wt=Math.abs(y-et(a)[S])),I(),D(!0)}if(i.contains(wt))return D(!1)}return!1}function A(s,l){bt(s,d,Ae({evt:e,isOwner:u,axis:o?"vertical":"horizontal",revert:r,dragRect:t,targetRect:n,canSort:p,fromSortable:h,target:a,completed:D,onMove:function(n,r){return dn(Et,i,wt,t,n,et(n),e,r)},changed:I},l))}function O(){A("dragOverAnimationCapture"),d.captureAnimationState(),d!==h&&h.captureAnimationState()}function D(t){return A("dragOverCompleted",{insertion:t}),t&&(u?c._hideClone():c._showClone(d),d!==h&&(Ke(wt,Lt?Lt.options.ghostClass:c.options.ghostClass,!1),Ke(wt,s.ghostClass,!0)),Lt!==d&&d!==hn.active?Lt=d:d===hn.active&&Lt&&(Lt=null),h===d&&(d._ignoreWhileAnimating=a),d.animateAll((function(){A("dragOverAnimationComplete"),d._ignoreWhileAnimating=null})),d!==h&&(h.animateAll(),h._ignoreWhileAnimating=null)),(a===wt&&!wt.animated||a===i&&!a.animated)&&(Ht=null),s.dragoverBubble||e.rootEl||a===document||(wt.parentNode[ht]._isOutsideThisEl(e.target),!t&&un(e)),!s.dragoverBubble&&e.stopPropagation&&e.stopPropagation(),f=!0}function I(){Ot=ot(wt),It=ot(wt,s.draggable),xt({sortable:d,name:"change",toEl:i,newIndex:Ot,newDraggableIndex:It,originalEvent:e})}},_ignoreWhileAnimating:null,_offMoveEvents:function(){qe(document,"mousemove",this._onTouchMove),qe(document,"touchmove",this._onTouchMove),qe(document,"pointermove",this._onTouchMove),qe(document,"dragover",un),qe(document,"mousemove",un),qe(document,"touchmove",un)},_offUpEvents:function(){var e=this.el.ownerDocument;qe(e,"mouseup",this._onDrop),qe(e,"touchend",this._onDrop),qe(e,"pointerup",this._onDrop),qe(e,"pointercancel",this._onDrop),qe(e,"touchcancel",this._onDrop),qe(document,"selectstart",this)},_onDrop:function(e){var t=this.el,n=this.options;Ot=ot(wt),It=ot(wt,n.draggable),bt("drop",this,{evt:e}),St=wt&&wt.parentNode,Ot=ot(wt),It=ot(wt,n.draggable),hn.eventCanceled||(Yt=!1,zt=!1,Kt=!1,clearInterval(this._loopId),clearTimeout(this._dragStartTimer),yn(this.cloneId),yn(this._dragStartId),this.nativeDraggable&&(qe(document,"drop",this),qe(t,"dragstart",this._onDragStart)),this._offMoveEvents(),this._offUpEvents(),Be&&ze(document.body,"user-select",""),ze(wt,"transform",""),e&&(Vt&&(e.cancelable&&e.preventDefault(),!n.dropBubble&&e.stopPropagation()),_t&&_t.parentNode&&_t.parentNode.removeChild(_t),(Et===St||Lt&&"clone"!==Lt.lastPutMode)&&Pt&&Pt.parentNode&&Pt.parentNode.removeChild(Pt),wt&&(this.nativeDraggable&&qe(wt,"dragend",this),fn(wt),wt.style["will-change"]="",Vt&&!Yt&&Ke(wt,Lt?Lt.options.ghostClass:this.options.ghostClass,!1),Ke(wt,this.options.chosenClass,!1),xt({sortable:this,name:"unchoose",toEl:St,newIndex:null,newDraggableIndex:null,originalEvent:e}),Et!==St?(Ot>=0&&(xt({rootEl:St,name:"add",toEl:St,fromEl:Et,originalEvent:e}),xt({sortable:this,name:"remove",toEl:St,originalEvent:e}),xt({rootEl:St,name:"sort",toEl:St,fromEl:Et,originalEvent:e}),xt({sortable:this,name:"sort",toEl:St,originalEvent:e})),Lt&&Lt.save()):Ot!==At&&Ot>=0&&(xt({sortable:this,name:"update",toEl:St,originalEvent:e}),xt({sortable:this,name:"sort",toEl:St,originalEvent:e})),hn.active&&(null!=Ot&&-1!==Ot||(Ot=At,It=Dt),xt({sortable:this,name:"end",toEl:St,originalEvent:e}),this.save())))),this._nulling()},_nulling:function(){bt("nulling",this),Et=wt=St=_t=kt=Pt=Ct=Nt=Ft=Mt=Vt=Ot=It=At=Dt=Ht=qt=Lt=Tt=hn.dragged=hn.ghost=hn.clone=hn.active=null,Qt.forEach((function(e){e.checked=!0})),Qt.length=jt=Bt=0},handleEvent:function(e){switch(e.type){case"drop":case"dragend":this._onDrop(e);break;case"dragenter":case"dragover":wt&&(this._onDragOver(e),function(e){e.dataTransfer&&(e.dataTransfer.dropEffect="move");e.cancelable&&e.preventDefault()}(e));break;case"selectstart":e.preventDefault()}},toArray:function(){for(var e,t=[],n=this.el.children,r=0,o=n.length,i=this.options;r<o;r++)Ye(e=n[r],i.draggable,this.el,!1)&&t.push(e.getAttribute(i.dataIdAttr)||gn(e));return t},sort:function(e,t){var n={},r=this.el;this.toArray().forEach((function(e,t){var o=r.children[t];Ye(o,this.options.draggable,r,!1)&&(n[e]=o)}),this),t&&this.captureAnimationState(),e.forEach((function(e){n[e]&&(r.removeChild(n[e]),r.appendChild(n[e]))})),t&&this.animateAll()},save:function(){var e=this.options.store;e&&e.set&&e.set(this)},closest:function(e,t){return Ye(e,t||this.options.draggable,this.el,!1)},option:function(e,t){var n=this.options;if(void 0===t)return n[e];var r=gt.modifyOption(this,e,t);n[e]=void 0!==r?r:t,"group"===e&&sn(n)},destroy:function(){bt("destroy",this);var e=this.el;e[ht]=null,qe(e,"mousedown",this._onTapStart),qe(e,"touchstart",this._onTapStart),qe(e,"pointerdown",this._onTapStart),this.nativeDraggable&&(qe(e,"dragover",this),qe(e,"dragenter",this)),Array.prototype.forEach.call(e.querySelectorAll("[draggable]"),(function(e){e.removeAttribute("draggable")})),this._onDrop(),this._disableDelayedDragEvents(),Xt.splice(Xt.indexOf(this.el),1),this.el=e=null},_hideClone:function(){if(!Nt){if(bt("hideClone",this),hn.eventCanceled)return;ze(Pt,"display","none"),this.options.removeCloneOnHide&&Pt.parentNode&&Pt.parentNode.removeChild(Pt),Nt=!0}},_showClone:function(e){if("clone"===e.lastPutMode){if(Nt){if(bt("showClone",this),hn.eventCanceled)return;wt.parentNode!=Et||this.options.group.revertClone?kt?Et.insertBefore(Pt,kt):Et.appendChild(Pt):Et.insertBefore(Pt,wt),this.options.group.revertClone&&this.animate(wt,Pt),ze(Pt,"display",""),Nt=!1}}else this._hideClone()}},en&&He(document,"touchmove",(function(e){(hn.active||Yt)&&e.cancelable&&e.preventDefault()})),hn.utils={on:He,off:qe,css:ze,find:Ze,is:function(e,t){return!!Ye(e,t,e,!1)},extend:function(e,t){if(e&&t)for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},throttle:lt,closest:Ye,toggleClass:Ke,clone:ut,index:ot,nextTick:vn,cancelNextTick:yn,detectDirection:an,getChild:nt,expando:ht},hn.get=function(e){return e[ht]},hn.mount=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];t[0].constructor===Array&&(t=t[0]),t.forEach((function(e){if(!e.prototype||!e.prototype.constructor)throw"Sortable: Mounted plugin must be a constructor function, not ".concat({}.toString.call(e));e.utils&&(hn.utils=Ae(Ae({},hn.utils),e.utils)),gt.mount(e)}))},hn.create=function(e,t){return new hn(e,t)},hn.version="1.15.6";var bn,xn,wn,Sn,_n,En,kn=[],Cn=!1;function Pn(){kn.forEach((function(e){clearInterval(e.pid)})),kn=[]}function Nn(){clearInterval(En)}var An=lt((function(e,t,n,r){if(t.scroll){var o,i=(e.touches?e.touches[0]:e).clientX,a=(e.touches?e.touches[0]:e).clientY,s=t.scrollSensitivity,l=t.scrollSpeed,c=Qe(),u=!1;xn!==n&&(xn=n,Pn(),bn=t.scroll,o=t.scrollFn,!0===bn&&(bn=at(n,!0)));var p=0,h=bn;do{var d=h,f=et(d),m=f.top,g=f.bottom,v=f.left,y=f.right,b=f.width,x=f.height,w=void 0,S=void 0,_=d.scrollWidth,E=d.scrollHeight,k=ze(d),C=d.scrollLeft,P=d.scrollTop;d===c?(w=b<_&&("auto"===k.overflowX||"scroll"===k.overflowX||"visible"===k.overflowX),S=x<E&&("auto"===k.overflowY||"scroll"===k.overflowY||"visible"===k.overflowY)):(w=b<_&&("auto"===k.overflowX||"scroll"===k.overflowX),S=x<E&&("auto"===k.overflowY||"scroll"===k.overflowY));var N=w&&(Math.abs(y-i)<=s&&C+b<_)-(Math.abs(v-i)<=s&&!!C),A=S&&(Math.abs(g-a)<=s&&P+x<E)-(Math.abs(m-a)<=s&&!!P);if(!kn[p])for(var O=0;O<=p;O++)kn[O]||(kn[O]={});kn[p].vx==N&&kn[p].vy==A&&kn[p].el===d||(kn[p].el=d,kn[p].vx=N,kn[p].vy=A,clearInterval(kn[p].pid),0==N&&0==A||(u=!0,kn[p].pid=setInterval(function(){r&&0===this.layer&&hn.active._onTouchMove(_n);var t=kn[this.layer].vy?kn[this.layer].vy*l:0,n=kn[this.layer].vx?kn[this.layer].vx*l:0;"function"==typeof o&&"continue"!==o.call(hn.dragged.parentNode[ht],n,t,e,_n,kn[this.layer].el)||ct(kn[this.layer].el,n,t)}.bind({layer:p}),24))),p++}while(t.bubbleScroll&&h!==c&&(h=at(h,!1)));Cn=u}}),30),On=function(e){var t=e.originalEvent,n=e.putSortable,r=e.dragEl,o=e.activeSortable,i=e.dispatchSortableEvent,a=e.hideGhostForTarget,s=e.unhideGhostForTarget;if(t){var l=n||o;a();var c=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:t,u=document.elementFromPoint(c.clientX,c.clientY);s(),l&&!l.el.contains(u)&&(i("spill"),this.onSpill({dragEl:r,putSortable:n}))}};function Dn(){}function In(){}Dn.prototype={startIndex:null,dragStart:function(e){var t=e.oldDraggableIndex;this.startIndex=t},onSpill:function(e){var t=e.dragEl,n=e.putSortable;this.sortable.captureAnimationState(),n&&n.captureAnimationState();var r=nt(this.sortable.el,this.startIndex,this.options);r?this.sortable.el.insertBefore(t,r):this.sortable.el.appendChild(t),this.sortable.animateAll(),n&&n.animateAll()},drop:On},Ie(Dn,{pluginName:"revertOnSpill"}),In.prototype={onSpill:function(e){var t=e.dragEl,n=e.putSortable||this.sortable;n.captureAnimationState(),t.parentNode&&t.parentNode.removeChild(t),n.animateAll()},drop:On},Ie(In,{pluginName:"removeOnSpill"});hn.mount(new function(){function e(){for(var e in this.defaults={scroll:!0,forceAutoScrollFallback:!1,scrollSensitivity:30,scrollSpeed:10,bubbleScroll:!0},this)"_"===e.charAt(0)&&"function"==typeof this[e]&&(this[e]=this[e].bind(this))}return e.prototype={dragStarted:function(e){var t=e.originalEvent;this.sortable.nativeDraggable?He(document,"dragover",this._handleAutoScroll):this.options.supportPointer?He(document,"pointermove",this._handleFallbackAutoScroll):t.touches?He(document,"touchmove",this._handleFallbackAutoScroll):He(document,"mousemove",this._handleFallbackAutoScroll)},dragOverCompleted:function(e){var t=e.originalEvent;this.options.dragOverBubble||t.rootEl||this._handleAutoScroll(t)},drop:function(){this.sortable.nativeDraggable?qe(document,"dragover",this._handleAutoScroll):(qe(document,"pointermove",this._handleFallbackAutoScroll),qe(document,"touchmove",this._handleFallbackAutoScroll),qe(document,"mousemove",this._handleFallbackAutoScroll)),Nn(),Pn(),clearTimeout(Ge),Ge=void 0},nulling:function(){_n=xn=bn=Cn=En=wn=Sn=null,kn.length=0},_handleFallbackAutoScroll:function(e){this._handleAutoScroll(e,!0)},_handleAutoScroll:function(e,t){var n=this,r=(e.touches?e.touches[0]:e).clientX,o=(e.touches?e.touches[0]:e).clientY,i=document.elementFromPoint(r,o);if(_n=e,t||this.options.forceAutoScrollFallback||Me||Fe||Be){An(e,this.options,i,t);var a=at(i,!0);!Cn||En&&r===wn&&o===Sn||(En&&Nn(),En=setInterval((function(){var i=at(document.elementFromPoint(r,o),!0);i!==a&&(a=i,Pn()),An(e,n.options,i,t)}),10),wn=r,Sn=o)}else{if(!this.options.bubbleScroll||at(i,!0)===Qe())return void Pn();An(e,this.options,at(i,!1),!1)}}},Ie(e,{pluginName:"scroll",initializeByDefault:!0})}),hn.mount(In,Dn);const Tn=hn;function Ln(e,t={}){const n="string"==typeof e?document.querySelector(e):e;if(!n)throw new Error(`Could not find container: ${e}`);const r=t.showToggleButton??!1,o=t.showDeleteButton??!1,i=t.showSelectInput??!1;let a=[...t.initialList||[]],s=null;n.innerHTML="",n.classList.add("sortable-list-container");const l=document.createElement("ul");l.className="sortable-list",Object.assign(l.style,{listStyle:"none",padding:"0",margin:"0"}),n.appendChild(l);const c=e=>l.querySelector(`li[data-id="${e}"]`),u=e=>{const n=document.createElement("li");n.className="sortable-list-item",n.dataset.id=e.id,Object.assign(n.style,{display:"flex",alignItems:"center",padding:"8px 12px",border:"1px solid var(--SmartThemeBorderColor, #ccc)",color:"var(--SmartThemeBodyColor, #333)",marginBottom:"2px"});const a=document.createElement("span");a.className="drag-handle",a.innerHTML='<i class="fas fa-bars"></i>',Object.assign(a.style,{cursor:"grab",marginRight:"10px",color:"var(--SmartThemeBodyColor, #555)",flexShrink:"0"}),n.appendChild(a);const s=document.createElement("span");s.className="item-label",s.style.flexGrow="1",s.style.marginRight="10px",s.style.overflow="hidden",s.style.textOverflow="ellipsis",s.style.whiteSpace="nowrap",t.renderLabel?t.renderLabel(s,e):s.textContent=e.label,n.appendChild(s);const l="10px",c=e.showSelect??!0,u=e.canSelect??!0;let p=null;if(i&&c)if(u){if(p=document.createElement("select"),p.className="select-input text_pole",p.style.marginRight=l,p.style.flexShrink="0",p.style.width="unset",e.selectOptions&&e.selectOptions.length>0)e.selectOptions.forEach((t=>{const n=document.createElement("option");n.value=t.value,n.textContent=t.label,t.value===e.selectValue&&(n.selected=!0),p.appendChild(n)}));else{const e=document.createElement("option");e.textContent="--",e.disabled=!0,e.selected=!0,p.appendChild(e),p.disabled=!0}p.addEventListener("change",(t=>{t.stopPropagation(),m(e.id,t)})),n.appendChild(p)}else{const e=document.createElement("span");e.style.marginRight=l,e.style.display="inline-block",e.style.flexShrink="0",n.appendChild(e)}else if(i&&!c){const e=document.createElement("span");e.style.marginRight=l,e.style.display="inline-block",e.style.flexShrink="0",n.appendChild(e)}const h=e.canToggle??!0;if(r&&h){const t=document.createElement("span");t.className="toggle-button",t.innerHTML=`<i class="fas ${e.enabled?"fa-toggle-on":"fa-toggle-off"}"></i>`,Object.assign(t.style,{cursor:"pointer",marginRight:l,fontSize:"1.2em",color:e.enabled?"var(--success-color, #4CAF50)":"var(--SmartThemeBodyColor, #555)",flexShrink:"0"}),t.addEventListener("click",(t=>{t.stopPropagation(),d(e.id)})),n.appendChild(t)}else if(r&&!h){const e=document.createElement("span");e.style.marginRight=l,e.style.display="inline-block",e.style.flexShrink="0",n.appendChild(e)}const g=e.canDelete??!0;if(o&&g){const t=document.createElement("span");t.className="delete-button",t.innerHTML='<i class="fas fa-trash-can"></i>',Object.assign(t.style,{cursor:"pointer",color:"var(--error-color, #f44336)",flexShrink:"0"}),t.addEventListener("click",(t=>{t.stopPropagation(),f(e.id)})),n.appendChild(t)}else if(o&&!g){const e=document.createElement("span");e.style.display="inline-block",e.style.flexShrink="0",n.appendChild(e)}return r&&(n.style.opacity=e.enabled?"1":"0.6"),n},p=()=>{l.innerHTML="",a.forEach((e=>{const t=u(e);l.appendChild(t)}))},h=(e,n={})=>{const o=(e=>a.find((t=>t.id===e)))(e),s=c(e);if(!o||!s)return;if("label"in n&&t.renderLabel||"selectOptions"in n||"showSelect"in n||"canSelect"in n||"canToggle"in n||"canDelete"in n){const e=u(o);s.replaceWith(e)}else{if("label"in n&&!t.renderLabel){const e=s.querySelector(".item-label");e&&(e.textContent=o.label)}if("selectValue"in n&&i){const e=s.querySelector(".select-input");e&&(e.value=o.selectValue??"")}if("enabled"in n&&r&&(o.canToggle??1)){const e=s.querySelector(".toggle-button i"),t=s.querySelector(".toggle-button");e&&(e.className="fas "+(o.enabled?"fa-toggle-on":"fa-toggle-off")),t&&(t.style.color=o.enabled?"var(--success-color, #4CAF50)":"var(--SmartThemeBodyColor, #555)")}if("enabled"in n&&r){s.style.opacity=o.enabled?"1":"0.6";const e=s.querySelector(".select-input");e&&(e.disabled=!o.enabled||!(o.canSelect??1))}}},d=async e=>{const n=a.findIndex((t=>t.id===e));if(-1===n||!(a[n].canToggle??1))return;const r=a[n],o=!r.enabled;if(t.onToggle)try{await Promise.resolve(t.onToggle(e,o))}catch(e){return void console.error("onToggle callback failed:",e)}const i={enabled:o};a[n]={...r,...i},h(e,i)},f=async e=>{const n=a.findIndex((t=>t.id===e));if(-1===n||!(a[n].canDelete??1))return;let r=!0;if(t.onDelete)try{r=await Promise.resolve(t.onDelete(e))}catch(e){console.error("onDelete callback failed:",e),r=!1}r&&(a.splice(n,1),c(e)?.remove())},m=async(e,n)=>{const r=a.findIndex((t=>t.id===e));if(-1===r||!(a[r].canSelect??1))return;const o=a[r],i=n.target,s=i.value;if(t.onSelectChange)try{await Promise.resolve(t.onSelectChange(e,s))}catch(e){return console.error("onSelectChange callback failed:",e),void(i.value=o.selectValue??"")}const l={selectValue:s};a[r]={...o,...l}},g=()=>{s&&s.destroy();const e={handle:".drag-handle",animation:150,ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",filter:".select-input, .toggle-button, .delete-button",preventOnFilter:!1,onEnd:e=>{const{oldIndex:n,newIndex:r}=e;if(void 0===n||void 0===r||n===r)return;const o=Array.from(l.children).map((e=>e.dataset.id)).filter((e=>void 0!==e));a.sort(((e,t)=>o.indexOf(e.id)-o.indexOf(t.id)));const i=a.map((e=>e.id));t.onOrderChange&&Promise.resolve(t.onOrderChange(i)).catch((e=>console.error("onOrderChange callback failed:",e)))},...t.sortableJsOptions||{}};s=Tn.create(l,e)};p(),g();const v={getList:()=>[...a],getOrder:()=>a.map((e=>e.id)),addItem:(e,t)=>{if(a.some((t=>t.id===e.id)))return void console.warn(`SortableList: Item with ID "${e.id}" already exists. Skipping add.`);const n=void 0===t||t<0||t>a.length?a.length:t;a.splice(n,0,e);const r=u(e),o=l.children[n];l.insertBefore(r,o??null)},removeItem:e=>{const t=a.findIndex((t=>t.id===e));t>-1&&(a.splice(t,1),c(e)?.remove())},updateItem:(e,t)=>{const n=a.findIndex((t=>t.id===e));if(n>-1){const r=a[n];"id"in t&&(console.warn("SortableList: Cannot change item ID via updateItem."),delete t.id),a[n]={...r,...t},h(e,t)}},setList:e=>{a=[...e],p(),g()},destroy:()=>{s&&(s.destroy(),s=null),n.innerHTML="",n.classList.remove("sortable-list-container"),a=[]},getSortableInstance:()=>s};return v}async function Fn({entry:e,selectedWorldName:t,skipSave:n=!1,skipReload:r=!1,operation:o="auto"}){const i=SillyTavern.getContext(),a=await i.loadWorldInfo(t);if(!a)throw new Error("Failed to load world info");const s=Object.values(a.entries),l=s.length>0?s[s.length-1]:void 0;let c;if("update"===o||"auto"===o){const t=Object.values(a.entries).find((t=>t.uid===e.uid));if(t)("auto"===o||"update"===o)&&(c=t);else if("update"===o)throw new Error("Entry not found for update operation")}const u=c?"update":"add";if(!c){if(p=t,h=a,c=(0,he.createWorldInfoEntry)(p,h),!c)throw new Error("Failed to create entry");if(l){const e=c.uid;Object.assign(c,l),c.uid=e}}var p,h;return c.key=e.key,c.content=e.content,c.comment=e.comment,n||await i.saveWorldInfo(t,a),r||i.reloadWorldInfoEditor(t,!0),{entry:c,operation:u}}var Mn,jn;!function(e){e[e.TEXT=1]="TEXT",e[e.CONFIRM=2]="CONFIRM",e[e.INPUT=3]="INPUT",e[e.DISPLAY=4]="DISPLAY"}(Mn||(Mn={})),function(e){e[e.AFFIRMATIVE=1]="AFFIRMATIVE",e[e.NEGATIVE=0]="NEGATIVE",e[e.CANCELLED=null]="CANCELLED"}(jn||(jn={}));const Bn=":A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",Rn=new RegExp("^"+("["+Bn+"]["+(Bn+"\\-.\\d\\u00B7\\u0300-\\u036F\\u203F-\\u2040")+"]*")+"$");function $n(e,t){const n=[];let r=t.exec(e);for(;r;){const o=[];o.startIndex=t.lastIndex-r[0].length;const i=r.length;for(let e=0;e<i;e++)o.push(r[e]);n.push(o),r=t.exec(e)}return n}const Vn=function(e){const t=Rn.exec(e);return!(null==t)};const Hn={allowBooleanAttributes:!1,unpairedTags:[]};function qn(e,t){t=Object.assign({},Hn,t);const n=[];let r=!1,o=!1;"\ufeff"===e[0]&&(e=e.substr(1));for(let i=0;i<e.length;i++)if("<"===e[i]&&"?"===e[i+1]){if(i+=2,i=Un(e,i),i.err)return i}else{if("<"!==e[i]){if(Wn(e[i]))continue;return Qn("InvalidChar","char '"+e[i]+"' is not expected.",tr(e,i))}{let a=i;if(i++,"!"===e[i]){i=Yn(e,i);continue}{let s=!1;"/"===e[i]&&(s=!0,i++);let l="";for(;i<e.length&&">"!==e[i]&&" "!==e[i]&&"\t"!==e[i]&&"\n"!==e[i]&&"\r"!==e[i];i++)l+=e[i];if(l=l.trim(),"/"===l[l.length-1]&&(l=l.substring(0,l.length-1),i--),!Vn(l)){let t;return t=0===l.trim().length?"Invalid space after '<'.":"Tag '"+l+"' is an invalid name.",Qn("InvalidTag",t,tr(e,i))}const c=Kn(e,i);if(!1===c)return Qn("InvalidAttr","Attributes for '"+l+"' have open quote.",tr(e,i));let u=c.value;if(i=c.index,"/"===u[u.length-1]){const n=i-u.length;u=u.substring(0,u.length-1);const o=Jn(u,t);if(!0!==o)return Qn(o.err.code,o.err.msg,tr(e,n+o.err.line));r=!0}else if(s){if(!c.tagClosed)return Qn("InvalidTag","Closing tag '"+l+"' doesn't have proper closing.",tr(e,i));if(u.trim().length>0)return Qn("InvalidTag","Closing tag '"+l+"' can't have attributes or invalid starting.",tr(e,a));if(0===n.length)return Qn("InvalidTag","Closing tag '"+l+"' has not been opened.",tr(e,a));{const t=n.pop();if(l!==t.tagName){let n=tr(e,t.tagStartPos);return Qn("InvalidTag","Expected closing tag '"+t.tagName+"' (opened in line "+n.line+", col "+n.col+") instead of closing tag '"+l+"'.",tr(e,a))}0==n.length&&(o=!0)}}else{const s=Jn(u,t);if(!0!==s)return Qn(s.err.code,s.err.msg,tr(e,i-u.length+s.err.line));if(!0===o)return Qn("InvalidXml","Multiple possible root nodes found.",tr(e,i));-1!==t.unpairedTags.indexOf(l)||n.push({tagName:l,tagStartPos:a}),r=!0}for(i++;i<e.length;i++)if("<"===e[i]){if("!"===e[i+1]){i++,i=Yn(e,i);continue}if("?"!==e[i+1])break;if(i=Un(e,++i),i.err)return i}else if("&"===e[i]){const t=Zn(e,i);if(-1==t)return Qn("InvalidChar","char '&' is not expected.",tr(e,i));i=t}else if(!0===o&&!Wn(e[i]))return Qn("InvalidXml","Extra text at the end",tr(e,i));"<"===e[i]&&i--}}}return r?1==n.length?Qn("InvalidTag","Unclosed tag '"+n[0].tagName+"'.",tr(e,n[0].tagStartPos)):!(n.length>0)||Qn("InvalidXml","Invalid '"+JSON.stringify(n.map((e=>e.tagName)),null,4).replace(/\r?\n/g,"")+"' found.",{line:1,col:1}):Qn("InvalidXml","Start tag expected.",1)}function Wn(e){return" "===e||"\t"===e||"\n"===e||"\r"===e}function Un(e,t){const n=t;for(;t<e.length;t++)if("?"!=e[t]&&" "!=e[t]);else{const r=e.substr(n,t-n);if(t>5&&"xml"===r)return Qn("InvalidXml","XML declaration allowed only at the start of the document.",tr(e,t));if("?"==e[t]&&">"==e[t+1]){t++;break}}return t}function Yn(e,t){if(e.length>t+5&&"-"===e[t+1]&&"-"===e[t+2]){for(t+=3;t<e.length;t++)if("-"===e[t]&&"-"===e[t+1]&&">"===e[t+2]){t+=2;break}}else if(e.length>t+8&&"D"===e[t+1]&&"O"===e[t+2]&&"C"===e[t+3]&&"T"===e[t+4]&&"Y"===e[t+5]&&"P"===e[t+6]&&"E"===e[t+7]){let n=1;for(t+=8;t<e.length;t++)if("<"===e[t])n++;else if(">"===e[t]&&(n--,0===n))break}else if(e.length>t+9&&"["===e[t+1]&&"C"===e[t+2]&&"D"===e[t+3]&&"A"===e[t+4]&&"T"===e[t+5]&&"A"===e[t+6]&&"["===e[t+7])for(t+=8;t<e.length;t++)if("]"===e[t]&&"]"===e[t+1]&&">"===e[t+2]){t+=2;break}return t}const Gn='"',Xn="'";function Kn(e,t){let n="",r="",o=!1;for(;t<e.length;t++){if(e[t]===Gn||e[t]===Xn)""===r?r=e[t]:r!==e[t]||(r="");else if(">"===e[t]&&""===r){o=!0;break}n+=e[t]}return""===r&&{value:n,index:t,tagClosed:o}}const zn=new RegExp("(\\s*)([^\\s=]+)(\\s*=)?(\\s*(['\"])(([\\s\\S])*?)\\5)?","g");function Jn(e,t){const n=$n(e,zn),r={};for(let e=0;e<n.length;e++){if(0===n[e][1].length)return Qn("InvalidAttr","Attribute '"+n[e][2]+"' has no space in starting.",nr(n[e]));if(void 0!==n[e][3]&&void 0===n[e][4])return Qn("InvalidAttr","Attribute '"+n[e][2]+"' is without value.",nr(n[e]));if(void 0===n[e][3]&&!t.allowBooleanAttributes)return Qn("InvalidAttr","boolean attribute '"+n[e][2]+"' is not allowed.",nr(n[e]));const o=n[e][2];if(!er(o))return Qn("InvalidAttr","Attribute '"+o+"' is an invalid name.",nr(n[e]));if(r.hasOwnProperty(o))return Qn("InvalidAttr","Attribute '"+o+"' is repeated.",nr(n[e]));r[o]=1}return!0}function Zn(e,t){if(";"===e[++t])return-1;if("#"===e[t])return function(e,t){let n=/\d/;for("x"===e[t]&&(t++,n=/[\da-fA-F]/);t<e.length;t++){if(";"===e[t])return t;if(!e[t].match(n))break}return-1}(e,++t);let n=0;for(;t<e.length;t++,n++)if(!(e[t].match(/\w/)&&n<20)){if(";"===e[t])break;return-1}return t}function Qn(e,t,n){return{err:{code:e,msg:t,line:n.line||n,col:n.col}}}function er(e){return Vn(e)}function tr(e,t){const n=e.substring(0,t).split(/\r?\n/);return{line:n.length,col:n[n.length-1].length+1}}function nr(e){return e.startIndex+e[1].length}const rr={preserveOrder:!1,attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,removeNSPrefix:!1,allowBooleanAttributes:!1,parseTagValue:!0,parseAttributeValue:!1,trimValues:!0,cdataPropName:!1,numberParseOptions:{hex:!0,leadingZeros:!0,eNotation:!0},tagValueProcessor:function(e,t){return t},attributeValueProcessor:function(e,t){return t},stopNodes:[],alwaysCreateTextNode:!1,isArray:()=>!1,commentPropName:!1,unpairedTags:[],processEntities:!0,htmlEntities:!1,ignoreDeclaration:!1,ignorePiTags:!1,transformTagName:!1,transformAttributeName:!1,updateTag:function(e,t,n){return e}};class or{constructor(e){this.tagname=e,this.child=[],this[":@"]={}}add(e,t){"__proto__"===e&&(e="#__proto__"),this.child.push({[e]:t})}addChild(e){"__proto__"===e.tagname&&(e.tagname="#__proto__"),e[":@"]&&Object.keys(e[":@"]).length>0?this.child.push({[e.tagname]:e.child,":@":e[":@"]}):this.child.push({[e.tagname]:e.child})}}function ir(e,t){const n={};if("O"!==e[t+3]||"C"!==e[t+4]||"T"!==e[t+5]||"Y"!==e[t+6]||"P"!==e[t+7]||"E"!==e[t+8])throw new Error("Invalid Tag instead of DOCTYPE");{t+=9;let r=1,o=!1,i=!1,a="";for(;t<e.length;t++)if("<"!==e[t]||i)if(">"===e[t]){if(i?"-"===e[t-1]&&"-"===e[t-2]&&(i=!1,r--):r--,0===r)break}else"["===e[t]?o=!0:a+=e[t];else{if(o&&lr(e,t)){let r,o;t+=7,[r,o,t]=ar(e,t+1),-1===o.indexOf("&")&&(n[hr(r)]={regx:RegExp(`&${r};`,"g"),val:o})}else if(o&&cr(e,t))t+=8;else if(o&&ur(e,t))t+=8;else if(o&&pr(e,t))t+=9;else{if(!sr)throw new Error("Invalid DOCTYPE");i=!0}r++,a=""}if(0!==r)throw new Error("Unclosed DOCTYPE")}return{entities:n,i:t}}function ar(e,t){let n="";for(;t<e.length&&"'"!==e[t]&&'"'!==e[t];t++)n+=e[t];if(n=n.trim(),-1!==n.indexOf(" "))throw new Error("External entites are not supported");const r=e[t++];let o="";for(;t<e.length&&e[t]!==r;t++)o+=e[t];return[n,o,t]}function sr(e,t){return"!"===e[t+1]&&"-"===e[t+2]&&"-"===e[t+3]}function lr(e,t){return"!"===e[t+1]&&"E"===e[t+2]&&"N"===e[t+3]&&"T"===e[t+4]&&"I"===e[t+5]&&"T"===e[t+6]&&"Y"===e[t+7]}function cr(e,t){return"!"===e[t+1]&&"E"===e[t+2]&&"L"===e[t+3]&&"E"===e[t+4]&&"M"===e[t+5]&&"E"===e[t+6]&&"N"===e[t+7]&&"T"===e[t+8]}function ur(e,t){return"!"===e[t+1]&&"A"===e[t+2]&&"T"===e[t+3]&&"T"===e[t+4]&&"L"===e[t+5]&&"I"===e[t+6]&&"S"===e[t+7]&&"T"===e[t+8]}function pr(e,t){return"!"===e[t+1]&&"N"===e[t+2]&&"O"===e[t+3]&&"T"===e[t+4]&&"A"===e[t+5]&&"T"===e[t+6]&&"I"===e[t+7]&&"O"===e[t+8]&&"N"===e[t+9]}function hr(e){if(Vn(e))return e;throw new Error(`Invalid entity name ${e}`)}const dr=/^[-+]?0x[a-fA-F0-9]+$/,fr=/^([\-\+])?(0*)([0-9]*(\.[0-9]*)?)$/,mr={hex:!0,leadingZeros:!0,decimalPoint:".",eNotation:!0};function gr(e,t={}){if(t=Object.assign({},mr,t),!e||"string"!=typeof e)return e;let n=e.trim();if(void 0!==t.skipLike&&t.skipLike.test(n))return e;if("0"===e)return 0;if(t.hex&&dr.test(n))return function(e,t){if(parseInt)return parseInt(e,t);if(Number.parseInt)return Number.parseInt(e,t);if(window&&window.parseInt)return window.parseInt(e,t);throw new Error("parseInt, Number.parseInt, window.parseInt are not supported")}(n,16);if(-1!==n.search(/[eE]/)){const r=n.match(/^([-\+])?(0*)([0-9]*(\.[0-9]*)?[eE][-\+]?[0-9]+)$/);if(r){if(t.leadingZeros)n=(r[1]||"")+r[3];else if("0"!==r[2]||"."!==r[3][0])return e;return t.eNotation?Number(n):e}return e}{const r=fr.exec(n);if(r){const o=r[1],i=r[2];let a=function(e){if(e&&-1!==e.indexOf("."))return"."===(e=e.replace(/0+$/,""))?e="0":"."===e[0]?e="0"+e:"."===e[e.length-1]&&(e=e.substr(0,e.length-1)),e;return e}(r[3]);if(!t.leadingZeros&&i.length>0&&o&&"."!==n[2])return e;if(!t.leadingZeros&&i.length>0&&!o&&"."!==n[1])return e;if(t.leadingZeros&&i===e)return 0;{const r=Number(n),s=""+r;return-1!==s.search(/[eE]/)?t.eNotation?r:e:-1!==n.indexOf(".")?"0"===s&&""===a||s===a||o&&s==="-"+a?r:e:i?a===s||o+a===s?r:e:n===s||n===o+s?r:e}}return e}}function vr(e){return"function"==typeof e?e:Array.isArray(e)?t=>{for(const n of e){if("string"==typeof n&&t===n)return!0;if(n instanceof RegExp&&n.test(t))return!0}}:()=>!1}class yr{constructor(e){this.options=e,this.currentNode=null,this.tagsNodeStack=[],this.docTypeEntities={},this.lastEntities={apos:{regex:/&(apos|#39|#x27);/g,val:"'"},gt:{regex:/&(gt|#62|#x3E);/g,val:">"},lt:{regex:/&(lt|#60|#x3C);/g,val:"<"},quot:{regex:/&(quot|#34|#x22);/g,val:'"'}},this.ampEntity={regex:/&(amp|#38|#x26);/g,val:"&"},this.htmlEntities={space:{regex:/&(nbsp|#160);/g,val:" "},cent:{regex:/&(cent|#162);/g,val:""},pound:{regex:/&(pound|#163);/g,val:""},yen:{regex:/&(yen|#165);/g,val:""},euro:{regex:/&(euro|#8364);/g,val:""},copyright:{regex:/&(copy|#169);/g,val:""},reg:{regex:/&(reg|#174);/g,val:""},inr:{regex:/&(inr|#8377);/g,val:""},num_dec:{regex:/&#([0-9]{1,7});/g,val:(e,t)=>String.fromCodePoint(Number.parseInt(t,10))},num_hex:{regex:/&#x([0-9a-fA-F]{1,6});/g,val:(e,t)=>String.fromCodePoint(Number.parseInt(t,16))}},this.addExternalEntities=br,this.parseXml=Er,this.parseTextData=xr,this.resolveNameSpace=wr,this.buildAttributesMap=_r,this.isItStopNode=Nr,this.replaceEntitiesValue=Cr,this.readStopNodeData=Dr,this.saveTextToParentTag=Pr,this.addChild=kr,this.ignoreAttributesFn=vr(this.options.ignoreAttributes)}}function br(e){const t=Object.keys(e);for(let n=0;n<t.length;n++){const r=t[n];this.lastEntities[r]={regex:new RegExp("&"+r+";","g"),val:e[r]}}}function xr(e,t,n,r,o,i,a){if(void 0!==e&&(this.options.trimValues&&!r&&(e=e.trim()),e.length>0)){a||(e=this.replaceEntitiesValue(e));const r=this.options.tagValueProcessor(t,e,n,o,i);if(null==r)return e;if(typeof r!=typeof e||r!==e)return r;if(this.options.trimValues)return Ir(e,this.options.parseTagValue,this.options.numberParseOptions);return e.trim()===e?Ir(e,this.options.parseTagValue,this.options.numberParseOptions):e}}function wr(e){if(this.options.removeNSPrefix){const t=e.split(":"),n="/"===e.charAt(0)?"/":"";if("xmlns"===t[0])return"";2===t.length&&(e=n+t[1])}return e}const Sr=new RegExp("([^\\s=]+)\\s*(=\\s*(['\"])([\\s\\S]*?)\\3)?","gm");function _r(e,t,n){if(!0!==this.options.ignoreAttributes&&"string"==typeof e){const n=$n(e,Sr),r=n.length,o={};for(let e=0;e<r;e++){const r=this.resolveNameSpace(n[e][1]);if(this.ignoreAttributesFn(r,t))continue;let i=n[e][4],a=this.options.attributeNamePrefix+r;if(r.length)if(this.options.transformAttributeName&&(a=this.options.transformAttributeName(a)),"__proto__"===a&&(a="#__proto__"),void 0!==i){this.options.trimValues&&(i=i.trim()),i=this.replaceEntitiesValue(i);const e=this.options.attributeValueProcessor(r,i,t);o[a]=null==e?i:typeof e!=typeof i||e!==i?e:Ir(i,this.options.parseAttributeValue,this.options.numberParseOptions)}else this.options.allowBooleanAttributes&&(o[a]=!0)}if(!Object.keys(o).length)return;if(this.options.attributesGroupName){const e={};return e[this.options.attributesGroupName]=o,e}return o}}const Er=function(e){e=e.replace(/\r\n?/g,"\n");const t=new or("!xml");let n=t,r="",o="";for(let i=0;i<e.length;i++){if("<"===e[i])if("/"===e[i+1]){const t=Ar(e,">",i,"Closing Tag is not closed.");let a=e.substring(i+2,t).trim();if(this.options.removeNSPrefix){const e=a.indexOf(":");-1!==e&&(a=a.substr(e+1))}this.options.transformTagName&&(a=this.options.transformTagName(a)),n&&(r=this.saveTextToParentTag(r,n,o));const s=o.substring(o.lastIndexOf(".")+1);if(a&&-1!==this.options.unpairedTags.indexOf(a))throw new Error(`Unpaired tag can not be used as closing tag: </${a}>`);let l=0;s&&-1!==this.options.unpairedTags.indexOf(s)?(l=o.lastIndexOf(".",o.lastIndexOf(".")-1),this.tagsNodeStack.pop()):l=o.lastIndexOf("."),o=o.substring(0,l),n=this.tagsNodeStack.pop(),r="",i=t}else if("?"===e[i+1]){let t=Or(e,i,!1,"?>");if(!t)throw new Error("Pi Tag is not closed.");if(r=this.saveTextToParentTag(r,n,o),this.options.ignoreDeclaration&&"?xml"===t.tagName||this.options.ignorePiTags);else{const e=new or(t.tagName);e.add(this.options.textNodeName,""),t.tagName!==t.tagExp&&t.attrExpPresent&&(e[":@"]=this.buildAttributesMap(t.tagExp,o,t.tagName)),this.addChild(n,e,o)}i=t.closeIndex+1}else if("!--"===e.substr(i+1,3)){const t=Ar(e,"--\x3e",i+4,"Comment is not closed.");if(this.options.commentPropName){const a=e.substring(i+4,t-2);r=this.saveTextToParentTag(r,n,o),n.add(this.options.commentPropName,[{[this.options.textNodeName]:a}])}i=t}else if("!D"===e.substr(i+1,2)){const t=ir(e,i);this.docTypeEntities=t.entities,i=t.i}else if("!["===e.substr(i+1,2)){const t=Ar(e,"]]>",i,"CDATA is not closed.")-2,a=e.substring(i+9,t);r=this.saveTextToParentTag(r,n,o);let s=this.parseTextData(a,n.tagname,o,!0,!1,!0,!0);null==s&&(s=""),this.options.cdataPropName?n.add(this.options.cdataPropName,[{[this.options.textNodeName]:a}]):n.add(this.options.textNodeName,s),i=t+2}else{let a=Or(e,i,this.options.removeNSPrefix),s=a.tagName;const l=a.rawTagName;let c=a.tagExp,u=a.attrExpPresent,p=a.closeIndex;this.options.transformTagName&&(s=this.options.transformTagName(s)),n&&r&&"!xml"!==n.tagname&&(r=this.saveTextToParentTag(r,n,o,!1));const h=n;if(h&&-1!==this.options.unpairedTags.indexOf(h.tagname)&&(n=this.tagsNodeStack.pop(),o=o.substring(0,o.lastIndexOf("."))),s!==t.tagname&&(o+=o?"."+s:s),this.isItStopNode(this.options.stopNodes,o,s)){let t="";if(c.length>0&&c.lastIndexOf("/")===c.length-1)"/"===s[s.length-1]?(s=s.substr(0,s.length-1),o=o.substr(0,o.length-1),c=s):c=c.substr(0,c.length-1),i=a.closeIndex;else if(-1!==this.options.unpairedTags.indexOf(s))i=a.closeIndex;else{const n=this.readStopNodeData(e,l,p+1);if(!n)throw new Error(`Unexpected end of ${l}`);i=n.i,t=n.tagContent}const r=new or(s);s!==c&&u&&(r[":@"]=this.buildAttributesMap(c,o,s)),t&&(t=this.parseTextData(t,s,o,!0,u,!0,!0)),o=o.substr(0,o.lastIndexOf(".")),r.add(this.options.textNodeName,t),this.addChild(n,r,o)}else{if(c.length>0&&c.lastIndexOf("/")===c.length-1){"/"===s[s.length-1]?(s=s.substr(0,s.length-1),o=o.substr(0,o.length-1),c=s):c=c.substr(0,c.length-1),this.options.transformTagName&&(s=this.options.transformTagName(s));const e=new or(s);s!==c&&u&&(e[":@"]=this.buildAttributesMap(c,o,s)),this.addChild(n,e,o),o=o.substr(0,o.lastIndexOf("."))}else{const e=new or(s);this.tagsNodeStack.push(n),s!==c&&u&&(e[":@"]=this.buildAttributesMap(c,o,s)),this.addChild(n,e,o),n=e}r="",i=p}}else r+=e[i]}return t.child};function kr(e,t,n){const r=this.options.updateTag(t.tagname,n,t[":@"]);!1===r||("string"==typeof r?(t.tagname=r,e.addChild(t)):e.addChild(t))}const Cr=function(e){if(this.options.processEntities){for(let t in this.docTypeEntities){const n=this.docTypeEntities[t];e=e.replace(n.regx,n.val)}for(let t in this.lastEntities){const n=this.lastEntities[t];e=e.replace(n.regex,n.val)}if(this.options.htmlEntities)for(let t in this.htmlEntities){const n=this.htmlEntities[t];e=e.replace(n.regex,n.val)}e=e.replace(this.ampEntity.regex,this.ampEntity.val)}return e};function Pr(e,t,n,r){return e&&(void 0===r&&(r=0===t.child.length),void 0!==(e=this.parseTextData(e,t.tagname,n,!1,!!t[":@"]&&0!==Object.keys(t[":@"]).length,r))&&""!==e&&t.add(this.options.textNodeName,e),e=""),e}function Nr(e,t,n){const r="*."+n;for(const n in e){const o=e[n];if(r===o||t===o)return!0}return!1}function Ar(e,t,n,r){const o=e.indexOf(t,n);if(-1===o)throw new Error(r);return o+t.length-1}function Or(e,t,n,r=">"){const o=function(e,t,n=">"){let r,o="";for(let i=t;i<e.length;i++){let t=e[i];if(r)t===r&&(r="");else if('"'===t||"'"===t)r=t;else if(t===n[0]){if(!n[1])return{data:o,index:i};if(e[i+1]===n[1])return{data:o,index:i}}else"\t"===t&&(t=" ");o+=t}}(e,t+1,r);if(!o)return;let i=o.data;const a=o.index,s=i.search(/\s/);let l=i,c=!0;-1!==s&&(l=i.substring(0,s),i=i.substring(s+1).trimStart());const u=l;if(n){const e=l.indexOf(":");-1!==e&&(l=l.substr(e+1),c=l!==o.data.substr(e+1))}return{tagName:l,tagExp:i,closeIndex:a,attrExpPresent:c,rawTagName:u}}function Dr(e,t,n){const r=n;let o=1;for(;n<e.length;n++)if("<"===e[n])if("/"===e[n+1]){const i=Ar(e,">",n,`${t} is not closed`);if(e.substring(n+2,i).trim()===t&&(o--,0===o))return{tagContent:e.substring(r,n),i};n=i}else if("?"===e[n+1]){n=Ar(e,"?>",n+1,"StopNode is not closed.")}else if("!--"===e.substr(n+1,3)){n=Ar(e,"--\x3e",n+3,"StopNode is not closed.")}else if("!["===e.substr(n+1,2)){n=Ar(e,"]]>",n,"StopNode is not closed.")-2}else{const r=Or(e,n,">");if(r){(r&&r.tagName)===t&&"/"!==r.tagExp[r.tagExp.length-1]&&o++,n=r.closeIndex}}}function Ir(e,t,n){if(t&&"string"==typeof e){const t=e.trim();return"true"===t||"false"!==t&&gr(e,n)}return void 0!==e?e:""}function Tr(e,t){return Lr(e,t)}function Lr(e,t,n){let r;const o={};for(let i=0;i<e.length;i++){const a=e[i],s=Fr(a);let l="";if(l=void 0===n?s:n+"."+s,s===t.textNodeName)void 0===r?r=a[s]:r+=""+a[s];else{if(void 0===s)continue;if(a[s]){let e=Lr(a[s],t,l);const n=jr(e,t);a[":@"]?Mr(e,a[":@"],l,t):1!==Object.keys(e).length||void 0===e[t.textNodeName]||t.alwaysCreateTextNode?0===Object.keys(e).length&&(t.alwaysCreateTextNode?e[t.textNodeName]="":e=""):e=e[t.textNodeName],void 0!==o[s]&&o.hasOwnProperty(s)?(Array.isArray(o[s])||(o[s]=[o[s]]),o[s].push(e)):t.isArray(s,l,n)?o[s]=[e]:o[s]=e}}}return"string"==typeof r?r.length>0&&(o[t.textNodeName]=r):void 0!==r&&(o[t.textNodeName]=r),o}function Fr(e){const t=Object.keys(e);for(let e=0;e<t.length;e++){const n=t[e];if(":@"!==n)return n}}function Mr(e,t,n,r){if(t){const o=Object.keys(t),i=o.length;for(let a=0;a<i;a++){const i=o[a];r.isArray(i,n+"."+i,!0,!0)?e[i]=[t[i]]:e[i]=t[i]}}}function jr(e,t){const{textNodeName:n}=t,r=Object.keys(e).length;return 0===r||!(1!==r||!e[n]&&"boolean"!=typeof e[n]&&0!==e[n])}function Br(e,t){let n="";return t.format&&t.indentBy.length>0&&(n="\n"),Rr(e,t,"",n)}function Rr(e,t,n,r){let o="",i=!1;for(let a=0;a<e.length;a++){const s=e[a],l=$r(s);if(void 0===l)continue;let c="";if(c=0===n.length?l:`${n}.${l}`,l===t.textNodeName){let e=s[l];Hr(c,t)||(e=t.tagValueProcessor(l,e),e=qr(e,t)),i&&(o+=r),o+=e,i=!1;continue}if(l===t.cdataPropName){i&&(o+=r),o+=`<![CDATA[${s[l][0][t.textNodeName]}]]>`,i=!1;continue}if(l===t.commentPropName){o+=r+`\x3c!--${s[l][0][t.textNodeName]}--\x3e`,i=!0;continue}if("?"===l[0]){const e=Vr(s[":@"],t),n="?xml"===l?"":r;let a=s[l][0][t.textNodeName];a=0!==a.length?" "+a:"",o+=n+`<${l}${a}${e}?>`,i=!0;continue}let u=r;""!==u&&(u+=t.indentBy);const p=r+`<${l}${Vr(s[":@"],t)}`,h=Rr(s[l],t,c,u);-1!==t.unpairedTags.indexOf(l)?t.suppressUnpairedNode?o+=p+">":o+=p+"/>":h&&0!==h.length||!t.suppressEmptyNode?h&&h.endsWith(">")?o+=p+`>${h}${r}</${l}>`:(o+=p+">",h&&""!==r&&(h.includes("/>")||h.includes("</"))?o+=r+t.indentBy+h+r:o+=h,o+=`</${l}>`):o+=p+"/>",i=!0}return o}function $r(e){const t=Object.keys(e);for(let n=0;n<t.length;n++){const r=t[n];if(e.hasOwnProperty(r)&&":@"!==r)return r}}function Vr(e,t){let n="";if(e&&!t.ignoreAttributes)for(let r in e){if(!e.hasOwnProperty(r))continue;let o=t.attributeValueProcessor(r,e[r]);o=qr(o,t),!0===o&&t.suppressBooleanAttributes?n+=` ${r.substr(t.attributeNamePrefix.length)}`:n+=` ${r.substr(t.attributeNamePrefix.length)}="${o}"`}return n}function Hr(e,t){let n=(e=e.substr(0,e.length-t.textNodeName.length-1)).substr(e.lastIndexOf(".")+1);for(let r in t.stopNodes)if(t.stopNodes[r]===e||t.stopNodes[r]==="*."+n)return!0;return!1}function qr(e,t){if(e&&e.length>0&&t.processEntities)for(let n=0;n<t.entities.length;n++){const r=t.entities[n];e=e.replace(r.regex,r.val)}return e}const Wr={attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,cdataPropName:!1,format:!1,indentBy:"  ",suppressEmptyNode:!1,suppressUnpairedNode:!0,suppressBooleanAttributes:!0,tagValueProcessor:function(e,t){return t},attributeValueProcessor:function(e,t){return t},preserveOrder:!1,commentPropName:!1,unpairedTags:[],entities:[{regex:new RegExp("&","g"),val:"&amp;"},{regex:new RegExp(">","g"),val:"&gt;"},{regex:new RegExp("<","g"),val:"&lt;"},{regex:new RegExp("'","g"),val:"&apos;"},{regex:new RegExp('"',"g"),val:"&quot;"}],processEntities:!0,stopNodes:[],oneListGroup:!1};function Ur(e){this.options=Object.assign({},Wr,e),!0===this.options.ignoreAttributes||this.options.attributesGroupName?this.isAttribute=function(){return!1}:(this.ignoreAttributesFn=vr(this.options.ignoreAttributes),this.attrPrefixLen=this.options.attributeNamePrefix.length,this.isAttribute=Xr),this.processTextOrObjNode=Yr,this.options.format?(this.indentate=Gr,this.tagEndChar=">\n",this.newLine="\n"):(this.indentate=function(){return""},this.tagEndChar=">",this.newLine="")}function Yr(e,t,n,r){const o=this.j2x(e,n+1,r.concat(t));return void 0!==e[this.options.textNodeName]&&1===Object.keys(e).length?this.buildTextValNode(e[this.options.textNodeName],t,o.attrStr,n):this.buildObjectNode(o.val,t,o.attrStr,n)}function Gr(e){return this.options.indentBy.repeat(e)}function Xr(e){return!(!e.startsWith(this.options.attributeNamePrefix)||e===this.options.textNodeName)&&e.substr(this.attrPrefixLen)}Ur.prototype.build=function(e){return this.options.preserveOrder?Br(e,this.options):(Array.isArray(e)&&this.options.arrayNodeName&&this.options.arrayNodeName.length>1&&(e={[this.options.arrayNodeName]:e}),this.j2x(e,0,[]).val)},Ur.prototype.j2x=function(e,t,n){let r="",o="";const i=n.join(".");for(let a in e)if(Object.prototype.hasOwnProperty.call(e,a))if(void 0===e[a])this.isAttribute(a)&&(o+="");else if(null===e[a])this.isAttribute(a)||a===this.options.cdataPropName?o+="":"?"===a[0]?o+=this.indentate(t)+"<"+a+"?"+this.tagEndChar:o+=this.indentate(t)+"<"+a+"/"+this.tagEndChar;else if(e[a]instanceof Date)o+=this.buildTextValNode(e[a],a,"",t);else if("object"!=typeof e[a]){const n=this.isAttribute(a);if(n&&!this.ignoreAttributesFn(n,i))r+=this.buildAttrPairStr(n,""+e[a]);else if(!n)if(a===this.options.textNodeName){let t=this.options.tagValueProcessor(a,""+e[a]);o+=this.replaceEntitiesValue(t)}else o+=this.buildTextValNode(e[a],a,"",t)}else if(Array.isArray(e[a])){const r=e[a].length;let i="",s="";for(let l=0;l<r;l++){const r=e[a][l];if(void 0===r);else if(null===r)"?"===a[0]?o+=this.indentate(t)+"<"+a+"?"+this.tagEndChar:o+=this.indentate(t)+"<"+a+"/"+this.tagEndChar;else if("object"==typeof r)if(this.options.oneListGroup){const e=this.j2x(r,t+1,n.concat(a));i+=e.val,this.options.attributesGroupName&&r.hasOwnProperty(this.options.attributesGroupName)&&(s+=e.attrStr)}else i+=this.processTextOrObjNode(r,a,t,n);else if(this.options.oneListGroup){let e=this.options.tagValueProcessor(a,r);e=this.replaceEntitiesValue(e),i+=e}else i+=this.buildTextValNode(r,a,"",t)}this.options.oneListGroup&&(i=this.buildObjectNode(i,a,s,t)),o+=i}else if(this.options.attributesGroupName&&a===this.options.attributesGroupName){const t=Object.keys(e[a]),n=t.length;for(let o=0;o<n;o++)r+=this.buildAttrPairStr(t[o],""+e[a][t[o]])}else o+=this.processTextOrObjNode(e[a],a,t,n);return{attrStr:r,val:o}},Ur.prototype.buildAttrPairStr=function(e,t){return t=this.options.attributeValueProcessor(e,""+t),t=this.replaceEntitiesValue(t),this.options.suppressBooleanAttributes&&"true"===t?" "+e:" "+e+'="'+t+'"'},Ur.prototype.buildObjectNode=function(e,t,n,r){if(""===e)return"?"===t[0]?this.indentate(r)+"<"+t+n+"?"+this.tagEndChar:this.indentate(r)+"<"+t+n+this.closeTag(t)+this.tagEndChar;{let o="</"+t+this.tagEndChar,i="";return"?"===t[0]&&(i="?",o=""),!n&&""!==n||-1!==e.indexOf("<")?!1!==this.options.commentPropName&&t===this.options.commentPropName&&0===i.length?this.indentate(r)+`\x3c!--${e}--\x3e`+this.newLine:this.indentate(r)+"<"+t+n+i+this.tagEndChar+e+this.indentate(r)+o:this.indentate(r)+"<"+t+n+i+">"+e+o}},Ur.prototype.closeTag=function(e){let t="";return-1!==this.options.unpairedTags.indexOf(e)?this.options.suppressUnpairedNode||(t="/"):t=this.options.suppressEmptyNode?"/":`></${e}`,t},Ur.prototype.buildTextValNode=function(e,t,n,r){if(!1!==this.options.cdataPropName&&t===this.options.cdataPropName)return this.indentate(r)+`<![CDATA[${e}]]>`+this.newLine;if(!1!==this.options.commentPropName&&t===this.options.commentPropName)return this.indentate(r)+`\x3c!--${e}--\x3e`+this.newLine;if("?"===t[0])return this.indentate(r)+"<"+t+n+"?"+this.tagEndChar;{let o=this.options.tagValueProcessor(t,e);return o=this.replaceEntitiesValue(o),""===o?this.indentate(r)+"<"+t+n+this.closeTag(t)+this.tagEndChar:this.indentate(r)+"<"+t+n+">"+o+"</"+t+this.tagEndChar}},Ur.prototype.replaceEntitiesValue=function(e){if(e&&e.length>0&&this.options.processEntities)for(let t=0;t<this.options.entities.length;t++){const n=this.options.entities[t];e=e.replace(n.regex,n.val)}return e};var Kr=new class{constructor(e){this.externalEntities={},this.options=function(e){return Object.assign({},rr,e)}(e)}parse(e,t){if("string"==typeof e);else{if(!e.toString)throw new Error("XML data is accepted in String or Bytes[] form.");e=e.toString()}if(t){!0===t&&(t={});const n=qn(e,t);if(!0!==n)throw Error(`${n.err.msg}:${n.err.line}:${n.err.col}`)}const n=new yr(this.options);n.addExternalEntities(this.externalEntities);const r=n.parseXml(e);return this.options.preserveOrder||void 0===r?r:Tr(r,this.options)}addEntity(e,t){if(-1!==t.indexOf("&"))throw new Error("Entity value can't have '&'");if(-1!==e.indexOf("&")||-1!==e.indexOf(";"))throw new Error("An entity must be set without '&' and ';'. Eg. use '#xD' for '&#xD;'");if("&"===t)throw new Error("An entity with value '&' is not permitted");this.externalEntities[e]=t}}({ignoreAttributes:!1,allowBooleanAttributes:!0});function zr(e,t){var n,r,o,i,a=e.match(/```(?:\w+\n|\n)([\s\S]*?)```/),s=a?a[1].trim():e.trim();try{switch(t){case"xml":var l=Kr.parse(s),c=null!==(n=null!==(r=null==l?void 0:l.response)&&void 0!==r?r:null==l||null===(o=l.root)||void 0===o?void 0:o.response)&&void 0!==n?n:null==l||null===(i=l.data)||void 0===i?void 0:i.response;if("string"==typeof c)return c.trim();if(c&&"string"==typeof c["#text"])return c["#text"].trim();if(l&&Object.keys(l).length>0){var u=Object.values(l)[0];if("string"==typeof u)return u.trim();if("string"==typeof(null==u?void 0:u["#text"]))return u["#text"].trim()}throw new Error("Invalid XML format: <response> tag content not found or not a string.");case"json":var p=JSON.parse(s);if(p&&"string"==typeof p.response)return p.response.trim();if(null!=p&&p.response&&Object.keys(p.response).length>0)return String(Object.values(p.response)[0]).trim();if(p&&Object.keys(p).length>0)return String(Object.values(p)[0]).trim();throw new Error('Invalid JSON format: "response" key not found or its value is not a string.');case"none":return s;default:throw new Error("Unsupported format specified: ".concat(t))}}catch(n){throw console.error("Error parsing response in format '".concat(t,"':"),n),console.error("Raw content received:",e),"xml"===t&&n.message.includes("Invalid XML")?new Error("Model response is not valid XML or does not contain the <response> tag."):"json"===t&&n instanceof SyntaxError?new Error('Model response is not valid JSON or does not follow the {"response": "..."} structure.'):new Error("Failed to parse response as ".concat(t,": ").concat(n.message))}}var Jr=d(639);function Zr(e){return Zr="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Zr(e)}function Qr(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */Qr=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,o=Object.defineProperty||function(e,t,n){e[t]=n.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",l=i.toStringTag||"@@toStringTag";function c(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,n){return e[t]=n}}function u(e,t,n,r){var i=t&&t.prototype instanceof v?t:v,a=Object.create(i.prototype),s=new O(r||[]);return o(a,"_invoke",{value:C(e,n,s)}),a}function p(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var h="suspendedStart",d="suspendedYield",f="executing",m="completed",g={};function v(){}function y(){}function b(){}var x={};c(x,a,(function(){return this}));var w=Object.getPrototypeOf,S=w&&w(w(D([])));S&&S!==n&&r.call(S,a)&&(x=S);var _=b.prototype=v.prototype=Object.create(x);function E(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function n(o,i,a,s){var l=p(e[o],e,i);if("throw"!==l.type){var c=l.arg,u=c.value;return u&&"object"==Zr(u)&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,a,s)}),(function(e){n("throw",e,a,s)})):t.resolve(u).then((function(e){c.value=e,a(c)}),(function(e){return n("throw",e,a,s)}))}s(l.arg)}var i;o(this,"_invoke",{value:function(e,r){function o(){return new t((function(t,o){n(e,r,t,o)}))}return i=i?i.then(o,o):o()}})}function C(t,n,r){var o=h;return function(i,a){if(o===f)throw Error("Generator is already running");if(o===m){if("throw"===i)throw a;return{value:e,done:!0}}for(r.method=i,r.arg=a;;){var s=r.delegate;if(s){var l=P(s,r);if(l){if(l===g)continue;return l}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===h)throw o=m,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=f;var c=p(t,n,r);if("normal"===c.type){if(o=r.done?m:d,c.arg===g)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(o=m,r.method="throw",r.arg=c.arg)}}}function P(t,n){var r=n.method,o=t.iterator[r];if(o===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,P(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),g;var i=p(o,t.iterator,n.arg);if("throw"===i.type)return n.method="throw",n.arg=i.arg,n.delegate=null,g;var a=i.arg;return a?a.done?(n[t.resultName]=a.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,g):a:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,g)}function N(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function A(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function O(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(N,this),this.reset(!0)}function D(t){if(t||""===t){var n=t[a];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,i=function n(){for(;++o<t.length;)if(r.call(t,o))return n.value=t[o],n.done=!1,n;return n.value=e,n.done=!0,n};return i.next=i}}throw new TypeError(Zr(t)+" is not iterable")}return y.prototype=b,o(_,"constructor",{value:b,configurable:!0}),o(b,"constructor",{value:y,configurable:!0}),y.displayName=c(b,l,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,b):(e.__proto__=b,c(e,l,"GeneratorFunction")),e.prototype=Object.create(_),e},t.awrap=function(e){return{__await:e}},E(k.prototype),c(k.prototype,s,(function(){return this})),t.AsyncIterator=k,t.async=function(e,n,r,o,i){void 0===i&&(i=Promise);var a=new k(u(e,n,r,o),i);return t.isGeneratorFunction(n)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},E(_),c(_,l,"Generator"),c(_,a,(function(){return this})),c(_,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=D,O.prototype={constructor:O,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(A),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function o(r,o){return s.type="throw",s.arg=t,n.next=r,o&&(n.method="next",n.arg=e),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var l=r.call(a,"catchLoc"),c=r.call(a,"finallyLoc");if(l&&c){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(l){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!c)throw Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=e,a.arg=t,i?(this.method="next",this.next=i.finallyLoc,g):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),A(n),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;A(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:D(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),g}},t}function eo(e){return function(e){if(Array.isArray(e))return oo(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||ro(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function to(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=ro(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){s=!0,i=e},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw i}}}}function no(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,i,a,s=[],l=!0,c=!1;try{if(i=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;l=!1}else for(;!(l=(r=i.call(n)).done)&&(s.push(r.value),s.length!==t);l=!0);}catch(e){c=!0,o=e}finally{try{if(!l&&null!=n.return&&(a=n.return(),Object(a)!==a))return}finally{if(c)throw o}}return s}}(e,t)||ro(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ro(e,t){if(e){if("string"==typeof e)return oo(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?oo(e,t):void 0}}function oo(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function io(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function ao(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?io(Object(n),!0).forEach((function(t){so(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):io(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function so(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=Zr(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=Zr(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==Zr(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function lo(e,t,n,r,o,i,a){try{var s=e[i](a),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}var co=SillyTavern.getContext(),uo=["name","description","personality","scenario","first_mes","mes_example"],po={name:"Name",description:"Description",personality:"Personality",scenario:"Scenario",first_mes:"First Message",mes_example:"Example Dialogue"};new g("dumb",{}).getSettings();function ho(e){return fo.apply(this,arguments)}function fo(){var e;return e=Qr().mark((function e(t){var n,r,o,i,a,s,l,c,u,p,h,d,f,m,g,v,y,b,x,w,S,_,E,k,C,P,N,A,O,D,I,T,L,F,M,j,B;return Qr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=t.profileId,l=t.userPrompt,c=t.buildPromptOptions,u=t.session,p=t.allCharacters,h=t.entriesGroupByWorldName,d=t.promptSettings,f=t.formatDescription,m=t.mainContextList,g=t.includeUserMacro,v=t.maxResponseToken,y=t.targetField,b=t.outputFormat,s){e.next=3;break}throw new Error("No connection profile selected.");case 3:if(x=null===(n=co.extensionSettings.connectionManager)||void 0===n||null===(n=n.profiles)||void 0===n?void 0:n.find((function(e){return e.id===s}))){e.next=6;break}throw new Error('Connection profile with ID "'.concat(s,'" not found.'));case 6:if(w=x.api?co.CONNECT_API_MAP[x.api].selected:void 0){e.next=9;break}throw new Error('Could not determine API for profile "'.concat(x.name,'".'));case 9:return(S={}).char=null!==(r=u.fields.name.value)&&void 0!==r?r:"{{char}}",S.user=g&&pe.name1?pe.name1:"{{user}}",S.persona="{{persona}}",S.targetField=y,S.userInstructions=Jr.compile(l.trim(),{noEscape:!0})(S),S.fieldSpecificInstructions=Jr.compile(null!==(o=null===(i=u.draftFields[y])||void 0===i?void 0:i.prompt)&&void 0!==o?o:null===(a=u.fields[y])||void 0===a?void 0:a.prompt,{noEscape:!0})(ao(ao({},S),{},{char:"mes_example"===y?"{{char}}":S.char,user:"mes_example"===y?"{{user}}":S.user})),S.activeFormatInstructions=Jr.compile(f.content,{noEscape:!0})(S),e.next=19,Pe(w,c);case 19:_=e.sent,E=[],u.selectedCharacterIndexes.forEach((function(e){var t=parseInt(e),n=p[t];n&&E.push(n)})),S.characters=E,k={},Object.entries(h).filter((function(e){var t=no(e,2),n=t[0],r=t[1];return r.length>0&&u.selectedWorldNames.includes(n)&&r.some((function(e){return!e.disable}))})).forEach((function(e){var t=no(e,2),n=t[0],r=t[1];k[n]=r.filter((function(e){return!e.disable}))})),S.lorebooks=k,C=Object.fromEntries(Object.entries(u.fields).map((function(e){var t=no(e,2),n=t[0],r=t[1];return[r.label,Jr.compile(r.value,{noEscape:!0})(ao(ao({},S),{},{char:"mes_example"===n?"{{char}}":S.char,user:"mes_example"===n?"{{user}}":S.user}))]}))),P=Object.fromEntries(Object.entries(u.draftFields||{}).map((function(e){var t=no(e,2),n=(t[0],t[1]);return[n.label,Jr.compile(n.value,{noEscape:!0})(S)]}))),N={core:C,draft:P},S.fields=N,A=[],O=to(m),e.prev=32,O.s();case 34:if((D=O.n()).done){e.next=54;break}if("chatHistory"!==(I=D.value).promptName){e.next=40;break}return T=_.map((function(e){return{role:e.role,content:e.content}})),A.push.apply(A,eo(T)),e.abrupt("continue",52);case 40:if(L=structuredClone(S),"stDescription"===I.promptName&&(L.char="{{char}}",L.user="{{user}}"),F=d[I.promptName]){e.next=45;break}return e.abrupt("continue",52);case 45:(M={role:I.role,content:Jr.compile(F.content,{noEscape:!0})(L)}).content=M.content.replaceAll("{{user}}","[[[crec_veryUniqueUserPlaceHolder]]]"),M.content=M.content.replaceAll("{{char}}","[[[crec_veryUniqueCharPlaceHolder]]]"),M.content=co.substituteParams(M.content),M.content=M.content.replaceAll("[[[crec_veryUniqueUserPlaceHolder]]]","{{user}}"),M.content=M.content.replaceAll("[[[crec_veryUniqueCharPlaceHolder]]]","{{char}}"),M.content&&A.push(M);case 52:e.next=34;break;case 54:e.next=59;break;case 56:e.prev=56,e.t0=e.catch(32),O.e(e.t0);case 59:return e.prev=59,O.f(),e.finish(59);case 62:return e.next=64,co.ConnectionManagerRequestService.sendRequest(s,A,v);case 64:return j=e.sent,B=zr(j.content,b),e.abrupt("return",B);case 67:case"end":return e.stop()}}),e,null,[[32,56,59,62]])})),fo=function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function a(e){lo(i,r,o,a,s,"next",e)}function s(e){lo(i,r,o,a,s,"throw",e)}a(void 0)}))},fo.apply(this,arguments)}var mo="{{activeFormatInstructions}}",go="=== CURRENT CHARACTER FIELD VALUES ===\n{{#if fields.core}}\n**Core Fields:**\n{{#each fields.core as |value key|}}\n- **{{key}}:** {{#if value}}{{value}}{{else}}*Not provided*{{/if}}\n{{/each}}\n{{/if}}\n\n{{#if fields.draft}}\n**Draft Fields:**\n{{#each fields.draft as |value key|}}\n- **{{key}}:** {{#if value}}{{value}}{{else}}*Not provided*{{/if}}\n{{/each}}\n{{/if}}",vo='Your task is to generate the content for the "{{targetField}}" field of a character card. Base your response on the preceding context (chat history, persona, system prompts, character/lore definitions, existing fields, etc.).\n{{#if userInstructions}}\n\nFollow these user instructions: {{userInstructions}}\n{{/if}}\n{{#if fieldSpecificInstructions}}\n\nField-specific instructions: {{fieldSpecificInstructions}}\n{{/if}}';function yo(e){return yo="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},yo(e)}function bo(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */bo=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,o=Object.defineProperty||function(e,t,n){e[t]=n.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",l=i.toStringTag||"@@toStringTag";function c(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,n){return e[t]=n}}function u(e,t,n,r){var i=t&&t.prototype instanceof v?t:v,a=Object.create(i.prototype),s=new O(r||[]);return o(a,"_invoke",{value:C(e,n,s)}),a}function p(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var h="suspendedStart",d="suspendedYield",f="executing",m="completed",g={};function v(){}function y(){}function b(){}var x={};c(x,a,(function(){return this}));var w=Object.getPrototypeOf,S=w&&w(w(D([])));S&&S!==n&&r.call(S,a)&&(x=S);var _=b.prototype=v.prototype=Object.create(x);function E(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function n(o,i,a,s){var l=p(e[o],e,i);if("throw"!==l.type){var c=l.arg,u=c.value;return u&&"object"==yo(u)&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,a,s)}),(function(e){n("throw",e,a,s)})):t.resolve(u).then((function(e){c.value=e,a(c)}),(function(e){return n("throw",e,a,s)}))}s(l.arg)}var i;o(this,"_invoke",{value:function(e,r){function o(){return new t((function(t,o){n(e,r,t,o)}))}return i=i?i.then(o,o):o()}})}function C(t,n,r){var o=h;return function(i,a){if(o===f)throw Error("Generator is already running");if(o===m){if("throw"===i)throw a;return{value:e,done:!0}}for(r.method=i,r.arg=a;;){var s=r.delegate;if(s){var l=P(s,r);if(l){if(l===g)continue;return l}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===h)throw o=m,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=f;var c=p(t,n,r);if("normal"===c.type){if(o=r.done?m:d,c.arg===g)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(o=m,r.method="throw",r.arg=c.arg)}}}function P(t,n){var r=n.method,o=t.iterator[r];if(o===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,P(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),g;var i=p(o,t.iterator,n.arg);if("throw"===i.type)return n.method="throw",n.arg=i.arg,n.delegate=null,g;var a=i.arg;return a?a.done?(n[t.resultName]=a.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,g):a:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,g)}function N(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function A(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function O(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(N,this),this.reset(!0)}function D(t){if(t||""===t){var n=t[a];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,i=function n(){for(;++o<t.length;)if(r.call(t,o))return n.value=t[o],n.done=!1,n;return n.value=e,n.done=!0,n};return i.next=i}}throw new TypeError(yo(t)+" is not iterable")}return y.prototype=b,o(_,"constructor",{value:b,configurable:!0}),o(b,"constructor",{value:y,configurable:!0}),y.displayName=c(b,l,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,b):(e.__proto__=b,c(e,l,"GeneratorFunction")),e.prototype=Object.create(_),e},t.awrap=function(e){return{__await:e}},E(k.prototype),c(k.prototype,s,(function(){return this})),t.AsyncIterator=k,t.async=function(e,n,r,o,i){void 0===i&&(i=Promise);var a=new k(u(e,n,r,o),i);return t.isGeneratorFunction(n)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},E(_),c(_,l,"Generator"),c(_,a,(function(){return this})),c(_,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=D,O.prototype={constructor:O,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(A),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function o(r,o){return s.type="throw",s.arg=t,n.next=r,o&&(n.method="next",n.arg=e),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var l=r.call(a,"catchLoc"),c=r.call(a,"finallyLoc");if(l&&c){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(l){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!c)throw Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=e,a.arg=t,i?(this.method="next",this.next=i.finallyLoc,g):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),A(n),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;A(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:D(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),g}},t}function xo(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function wo(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?xo(Object(n),!0).forEach((function(t){So(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):xo(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function So(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=yo(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=yo(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==yo(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _o(e,t,n,r,o,i,a){try{var s=e[i](a),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}var Eo="SillyTavern-Character-Creator",ko="0.1.8",Co=["stDescription","charDefinitions","lorebookDefinitions","xmlFormat","jsonFormat","noneFormat","worldInfoCharDefinition","existingFieldDefinitions","taskDescription","outputFormatInstructions","personaDescription"],Po={stDescription:'=======\n\nWhen creating a **character card** in SillyTavern, you can define a structured profile to guide the AI\'s behavior and ensure consistency in roleplay or storytelling. Below are the common fields and their purposes, based on community templates and best practices:\n\n---\n\n### **1. Name**\n**Purpose**:\nThe character\'s primary identifier. The AI uses this to reference the character in dialogue and narration.\n**Key Tips**:\n- Use a memorable name that reflects their role (e.g., "Zara the Shadowblade" implies stealth/combat).\n- Avoid overly complex or ambiguous names (e.g., "Xy\'lthraa" may confuse the AI).\n**Example**:\n`"Seraphina Vale"` (Elegant, hints at nobility) vs. `"Rusty"` (Casual, rugged).\n\n---\n\n### **2. Description**\n**Purpose**:\nA snapshot of the character\'s identity, combining **appearance**, **personality**, and **key traits** to guide the AI\'s "mental image."\n**Structure**:\n- **Appearance**: Physical traits (e.g., scars, clothing, species).\n- **Personality**: Core demeanor (e.g., stoic, playful).\n- **Mannerisms**: Unique habits (e.g., "taps fingers when lying").\n**Example**:\n> *"A hulking orc with moss-green skin and a chipped tusk, wearing a patchwork cloak. Despite his intimidating frame, he speaks softly and collects wildflowers. Secretly fears fire."*\n**Tips**:\n- Use vivid, concise language.\n- Prioritize traits critical to roleplay (e.g., "blind in one eye" affects interactions).\n\n---\n\n### **3. Personality**\n**Purpose**:\nExplicitly defines **how the character thinks/behaves**, reducing ambiguity for the AI.\n**What to Include**:\n- Core traits (e.g., "optimistic", "paranoid").\n- Motivations (e.g., "seeks revenge against the crown").\n- Flaws (e.g., "impulsive", "overly trusting").\n**Example**:\n`"Charismatic but manipulative; values loyalty only when it benefits him. Haunted by guilt over a failed rescue mission."`\n**Tips**:\n- Use bullet points or short phrases for clarity.\n- Avoid contradictions (e.g., "shy" vs. "loves public speaking").\n\n---\n\n### **4. Scenario**\n**Purpose**:\nSets the stage for the interaction, providing **contextual boundaries** for the AI.\n**What to Include**:\n- **Location**: Where the scene takes place (e.g., "a smoky tavern").\n- **Time**: Era or time-sensitive context (e.g., "during a solar eclipse").\n- **Relationship**: Predefined ties to the user (e.g., "childhood rivals reunited").\n**Example**:\n`"A cyberpunk night market in 2147. {{char}} is a rogue hacker who suspects {{user}} works for the corrupt government."`\n**Tips**:\n- Use dynamic placeholders like `{{user}}` to personalize the scenario.\n\n---\n\n### **5. First Message**\n**Purpose**:\nThe character\'s **opening line**, critical for establishing tone, voice, and narrative momentum.\n**Key Elements**:\n- **Dialogue**: Shows speech style (formal, slang-heavy).\n- **Actions**: Subtle body language (e.g., "crosses arms skeptically").\n- **Hook**: Encourages user engagement (e.g., a question or mystery).\n**Example**:\n`*{{char}} adjusts her gas mask, voice muffled.* "You\'re the third outsider this week. What makes you think you\'ll survive the Wastes?"`\n**Tips**:\n- Avoid passive openings (e.g., "Hello, how can I help you?").\n- Mirror the character\'s personality (e.g., a shy character might stammer).\n\n---\n\n### **6. Example Dialogue**\n**Purpose**:\nTeaches the AI the character\'s **speech patterns**, **formatting preferences**, and **interaction style**.\n**Structure**:\n- Use `{{char}}` and `{{user}}` placeholders.\n- Mix dialogue and actions (e.g., `*{{char}} smirks.* "You\'re bold. I like that."`).\n- Show range (e.g., anger, sarcasm, vulnerability).\n**Example**:\n```\n{{user}}: Why should I trust you?\n{{char}}: *Pulls a dagger from her boot and twirls it.* "You shouldn\'t. But I\'m your only way out of this alive."\n```\n**Tips**:\n- Include 35 varied exchanges.\n- Match the character\'s voice (e.g., a poet might use metaphors).\n\n---\n\n### **Advanced Tips**\n- **Avoid "Wall of Text"**: Use line breaks and punctuation to improve readability for the AI.\n\n---\n\n### **Example Character Card Snippet**\n```json\n{\n  "name": "Kael Stormveil",\n  "description": "A storm sorcerer with crackling electricity in his eyes. Wears a cloak woven from thunderclouds. Pragmatic to a fault, but secretly fears losing control of his powers.",\n  "personality": "Analytical, blunt, distrusts authority. Motto: \'Chaosis just order waiting to be deciphered.\'",\n  "scenario": "A floating library during a magical hurricane. {{user}} is a novice mage Kael reluctantly mentors.",\n  "first_message": "*Kael\'s hands spark as he slams a tome shut.* \'You\'ve got five minutes to explain why I shouldn\'t toss you into the storm.\'",\n  "example_dialogue": "{{user}}: Can you teach me to control the storm?\n{{char}}: *Snorts.* \'Control is an illusion. You ride the storm or drown.\'"\n}\n```\n\n=======',charDefinitions:"## Selected Characters for Context\n{{#each characters}}\n### {{this.name}}\n{{#if this.description}}\n#### Description\n{{this.description}}\n{{/if}}\n{{#if this.personality}}\n#### Personality\n{{this.personality}}\n{{/if}}\n{{#if this.scenario}}\n#### Scenario\n{{this.scenario}}\n{{/if}}\n{{#if this.first_mes}}\n#### First Message\n{{this.first_mes}}\n{{/if}}\n{{#if this.mes_example}}\n#### Example Dialogue\n{{this.mes_example}}\n{{/if}}\n\n{{/each}}",lorebookDefinitions:"## Selected Lorebooks for Context\n{{#each lorebooks}}\n### {{@key}}\n  {{#each this as |entry|}}\n#### {{#if entry.comment}}{{entry.comment}}{{else}}*No title*{{/if}}\nTriggers: {{#if entry.key}}{{join entry.key ', '}}{{else}}*No triggers*{{/if}}\nContent: {{#if entry.content}}{{entry.content}}{{else}}*No content*{{/if}}\n\n  {{/each}}\n\n\n{{/each}}",xmlFormat:"=== RESPONSE FORMAT INSTRUCTIONS ===\nYou MUST provide your response wrapped ONLY in a single <response> XML tag.\n\nWhen providing code in your response, wrap it in triple backticks:\n\nExample:\n```\n<response>Generated content for the field goes here.</response>\n```",jsonFormat:'=== RESPONSE FORMAT INSTRUCTIONS ===\nYou MUST provide your response as a JSON object with a single key "response" containing the generated content as a string.\n\nWhen providing code in your response, wrap it in triple backticks:\n\nExample:\n```\n{\n  "response": "Generated content for the field goes here."\n}\n```',noneFormat:"=== RESPONSE FORMAT INSTRUCTIONS ===\nYou MUST provide ONLY the raw text content for the field, without any formatting, XML tags, JSON structure, or explanatory text. Just the content itself.\n\nWhen providing code in your response, wrap it in triple backticks:\n\nExample:\n```\nGenerated content for the field goes here.\n```",worldInfoCharDefinition:"### {{character.name}}\n- **Description:** {{#if character.description}}{{character.description}}{{else}}*Not provided*{{/if}}\n- **Personality:** {{#if character.personality}}{{character.personality}}{{else}}*Not provided*{{/if}}\n- **Scenario:** {{#if character.scenario}}{{character.scenario}}{{else}}*Not provided*{{/if}}\n- **First Message:** {{#if character.first_mes}}{{character.first_mes}}{{else}}*Not provided*{{/if}}\n- **Example Dialogue:**\n  {{#if character.mes_example}}{{character.mes_example}}{{else}}*Not provided*{{/if}}",existingFieldDefinitions:go,taskDescription:vo,outputFormatInstructions:mo,personaDescription:"## User's Persona Description\nname: {{user}}\n{{persona}}"},No={version:ko,formatVersion:"F_1.5",profileId:"",maxContextType:"profile",maxContextValue:16384,maxResponseToken:1024,outputFormat:"xml",contextToSend:{stDescription:!0,messages:{type:"last",first:10,last:10,range:{start:0,end:10}},charCard:!0,existingFields:!0,worldInfo:!0,persona:!0},prompts:{stDescription:{content:Po.stDescription,isDefault:!0,label:"ST/Char Card Description"},charDefinitions:{content:Po.charDefinitions,isDefault:!0,label:"Character Definition Template"},lorebookDefinitions:{content:Po.lorebookDefinitions,isDefault:!0,label:"Lorebook Definition Template"},xmlFormat:{content:Po.xmlFormat,isDefault:!0,label:"XML Format Description"},jsonFormat:{content:Po.jsonFormat,isDefault:!0,label:"JSON Format Description"},noneFormat:{content:Po.noneFormat,isDefault:!0,label:"Plain Text Format Description"},worldInfoCharDefinition:{content:Po.worldInfoCharDefinition,isDefault:!0,label:"World Info Character Definition Template"},existingFieldDefinitions:{content:go,isDefault:!0,label:"Existing Fields Definition Template"},taskDescription:{content:vo,isDefault:!0,label:"Task Description Template"},outputFormatInstructions:{content:mo,isDefault:!0,label:"Output Format Instructions"},personaDescription:{content:Po.personaDescription,isDefault:!0,label:"User Persona Description Template"}},promptPreset:"default",promptPresets:{default:{content:"Generate the field content based on the chat history and existing character details. Be creative but consistent."}},mainContextTemplatePreset:"default",mainContextTemplatePresets:{default:{prompts:[{enabled:!0,promptName:"chatHistory",role:"system"},{enabled:!0,promptName:"stDescription",role:"system"},{enabled:!0,promptName:"charDefinitions",role:"system"},{enabled:!0,promptName:"lorebookDefinitions",role:"system"},{enabled:!0,promptName:"existingFieldDefinitions",role:"system"},{enabled:!0,promptName:"personaDescription",role:"system"},{enabled:!0,promptName:"outputFormatInstructions",role:"system"},{enabled:!0,promptName:"taskDescription",role:"user"}]}},showSaveAsWorldInfoEntry:{show:!1}};function Ao(e){var t=e.replace(/[^\w\s]/g,"").split(/\s+/).filter(Boolean),n=!1;return t.map((function(e,t){var r=e.replace(/^\d+/,"");if(r){var o=n?"".concat(r[0].toUpperCase()).concat(r.slice(1).toLowerCase()):r.toLowerCase();return n||(n=!0),o}return""})).join("")}var Oo=new g("charCreator",No);function Do(){var e;return e=bo().mark((function e(){return bo().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,t){Oo.initializeSettings({strategy:[{from:"*",to:"F_1.4",action:function(e){var t,n,r,o,i,a,s,l,c;return{profileId:null!==(t=null==e?void 0:e.profileId)&&void 0!==t?t:"",maxContextType:null!==(n=null==e?void 0:e.maxContextType)&&void 0!==n?n:"profile",maxContextValue:null!==(r=null==e?void 0:e.maxContextValue)&&void 0!==r?r:16384,maxResponseToken:null!==(o=null==e?void 0:e.maxResponseToken)&&void 0!==o?o:1024,outputFormat:null!==(i=null==e?void 0:e.outputFormat)&&void 0!==i?i:"xml",contextToSend:wo(wo({},null==e?void 0:e.contextToSend),{},{persona:!0}),prompts:{stDescription:{content:Po.stDescription,isDefault:!0,label:"ST/Char Card Description"},charDefinitions:{content:Po.charDefinitions,isDefault:!0,label:"Character Definition Template"},lorebookDefinitions:{content:Po.lorebookDefinitions,isDefault:!0,label:"Lorebook Definition Template"},xmlFormat:{content:Po.xmlFormat,isDefault:!0,label:"XML Format Description"},jsonFormat:{content:Po.jsonFormat,isDefault:!0,label:"JSON Format Description"},noneFormat:{content:Po.noneFormat,isDefault:!0,label:"Plain Text Format Description"},worldInfoCharDefinition:{content:Po.worldInfoCharDefinition,isDefault:!0,label:"World Info Character Definition Template"},existingFieldDefinitions:{content:go,isDefault:!0,label:"Existing Fields Definition Template"},taskDescription:{content:vo,isDefault:!0,label:"Task Description Template"},outputFormatInstructions:{content:mo,isDefault:!0,label:"Output Format Instructions"},personaDescription:{content:Po.personaDescription,isDefault:!0,label:"User Persona Description Template"}},promptPreset:null!==(a=null==e?void 0:e.default)&&void 0!==a?a:"default",promptPresets:null!==(s=null==e?void 0:e.promptPresets)&&void 0!==s?s:{default:{content:"Generate the field content based on the chat history and existing character details. Be creative but consistent."}},mainContextTemplatePreset:"default",mainContextTemplatePresets:{default:{prompts:[{enabled:!0,promptName:"chatHistory",role:"system"},{enabled:!0,promptName:"stDescription",role:"system"},{enabled:!0,promptName:"charDefinitions",role:"system"},{enabled:!0,promptName:"lorebookDefinitions",role:"system"},{enabled:!0,promptName:"existingFieldDefinitions",role:"system"},{enabled:!0,promptName:"personaDescription",role:"system"},{enabled:!0,promptName:"outputFormatInstructions",role:"system"},{enabled:!0,promptName:"taskDescription",role:"user"}]}},showSaveAsWorldInfoEntry:null!==(l=null==e?void 0:e.showSaveAsWorldInfoEntry)&&void 0!==l?l:{show:null!==(c=null==e?void 0:e.showSaveAsWorldInfoEntry.show)&&void 0!==c&&c}}}},{from:"F_1.4",to:"F_1.5",action:function(e){return wo(wo({},e),{},{prompts:wo(wo({},null==e?void 0:e.prompts),{},{personaDescription:{content:Po.personaDescription,isDefault:!0,label:"User Persona Description Template"}}),mainContextTemplatePresets:wo(wo({},null==e?void 0:e.mainContextTemplatePresets),{},{default:{prompts:[{enabled:!0,promptName:"chatHistory",role:"system"},{enabled:!0,promptName:"stDescription",role:"system"},{enabled:!0,promptName:"charDefinitions",role:"system"},{enabled:!0,promptName:"lorebookDefinitions",role:"system"},{enabled:!0,promptName:"existingFieldDefinitions",role:"system"},{enabled:!0,promptName:"personaDescription",role:"system"},{enabled:!0,promptName:"outputFormatInstructions",role:"system"},{enabled:!0,promptName:"taskDescription",role:"user"}]}})})}}]}).then((function(t){e()})).catch((function(t){console.error("[".concat(Eo,"] Error initializing settings:"),t),be("error","[".concat(Eo,"] Failed to initialize settings: ").concat(t.message)),co.Popup.show.confirm("[".concat(Eo,"] Failed to load settings. This might be due to an update. Reset settings to default?"),"Extension Error").then((function(t){t&&(Oo.resetSettings(),be("success","[".concat(Eo,"] Settings reset. Reloading may be required.")),e())}))}))})));case 1:case"end":return e.stop()}}),e)})),Do=function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function a(e){_o(i,r,o,a,s,"next",e)}function s(e){_o(i,r,o,a,s,"throw",e)}a(void 0)}))},Do.apply(this,arguments)}function Io(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=Ro(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){s=!0,i=e},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw i}}}}function To(e){return To="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},To(e)}function Lo(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Fo(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Lo(Object(n),!0).forEach((function(t){Mo(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Lo(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Mo(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=To(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=To(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==To(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function jo(e){return function(e){if(Array.isArray(e))return $o(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||Ro(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Bo(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,i,a,s=[],l=!0,c=!1;try{if(i=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;l=!1}else for(;!(l=(r=i.call(n)).done)&&(s.push(r.value),s.length!==t);l=!0);}catch(e){c=!0,o=e}finally{try{if(!l&&null!=n.return&&(a=n.return(),Object(a)!==a))return}finally{if(c)throw o}}return s}}(e,t)||Ro(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Ro(e,t){if(e){if("string"==typeof e)return $o(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?$o(e,t):void 0}}function $o(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function Vo(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */Vo=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,o=Object.defineProperty||function(e,t,n){e[t]=n.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",l=i.toStringTag||"@@toStringTag";function c(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,n){return e[t]=n}}function u(e,t,n,r){var i=t&&t.prototype instanceof v?t:v,a=Object.create(i.prototype),s=new O(r||[]);return o(a,"_invoke",{value:C(e,n,s)}),a}function p(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var h="suspendedStart",d="suspendedYield",f="executing",m="completed",g={};function v(){}function y(){}function b(){}var x={};c(x,a,(function(){return this}));var w=Object.getPrototypeOf,S=w&&w(w(D([])));S&&S!==n&&r.call(S,a)&&(x=S);var _=b.prototype=v.prototype=Object.create(x);function E(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function n(o,i,a,s){var l=p(e[o],e,i);if("throw"!==l.type){var c=l.arg,u=c.value;return u&&"object"==To(u)&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,a,s)}),(function(e){n("throw",e,a,s)})):t.resolve(u).then((function(e){c.value=e,a(c)}),(function(e){return n("throw",e,a,s)}))}s(l.arg)}var i;o(this,"_invoke",{value:function(e,r){function o(){return new t((function(t,o){n(e,r,t,o)}))}return i=i?i.then(o,o):o()}})}function C(t,n,r){var o=h;return function(i,a){if(o===f)throw Error("Generator is already running");if(o===m){if("throw"===i)throw a;return{value:e,done:!0}}for(r.method=i,r.arg=a;;){var s=r.delegate;if(s){var l=P(s,r);if(l){if(l===g)continue;return l}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===h)throw o=m,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=f;var c=p(t,n,r);if("normal"===c.type){if(o=r.done?m:d,c.arg===g)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(o=m,r.method="throw",r.arg=c.arg)}}}function P(t,n){var r=n.method,o=t.iterator[r];if(o===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,P(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),g;var i=p(o,t.iterator,n.arg);if("throw"===i.type)return n.method="throw",n.arg=i.arg,n.delegate=null,g;var a=i.arg;return a?a.done?(n[t.resultName]=a.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,g):a:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,g)}function N(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function A(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function O(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(N,this),this.reset(!0)}function D(t){if(t||""===t){var n=t[a];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,i=function n(){for(;++o<t.length;)if(r.call(t,o))return n.value=t[o],n.done=!1,n;return n.value=e,n.done=!0,n};return i.next=i}}throw new TypeError(To(t)+" is not iterable")}return y.prototype=b,o(_,"constructor",{value:b,configurable:!0}),o(b,"constructor",{value:y,configurable:!0}),y.displayName=c(b,l,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,b):(e.__proto__=b,c(e,l,"GeneratorFunction")),e.prototype=Object.create(_),e},t.awrap=function(e){return{__await:e}},E(k.prototype),c(k.prototype,s,(function(){return this})),t.AsyncIterator=k,t.async=function(e,n,r,o,i){void 0===i&&(i=Promise);var a=new k(u(e,n,r,o),i);return t.isGeneratorFunction(n)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},E(_),c(_,l,"Generator"),c(_,a,(function(){return this})),c(_,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=D,O.prototype={constructor:O,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(A),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function o(r,o){return s.type="throw",s.arg=t,n.next=r,o&&(n.method="next",n.arg=e),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var l=r.call(a,"catchLoc"),c=r.call(a,"finallyLoc");if(l&&c){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(l){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!c)throw Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=e,a.arg=t,i?(this.method="next",this.next=i.finallyLoc,g):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),A(n),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;A(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:D(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),g}},t}function Ho(e,t,n,r,o,i,a){try{var s=e[i](a),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function qo(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function a(e){Ho(i,r,o,a,s,"next",e)}function s(e){Ho(i,r,o,a,s,"throw",e)}a(void 0)}))}}function Wo(){return(Wo=qo(Vo().mark((function e(){var t,n,r,o,i,a,s,l,c,u,p,h,d,f,m,g,v,y,b;return Vo().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,co.renderExtensionTemplateAsync("third-party/".concat(Eo),"templates/settings");case 2:if(t=e.sent,$("#extensions_settings").append(t),n=document.querySelector(".charCreator_settings")){e.next=7;break}return e.abrupt("return");case 7:r=Oo.getSettings(),a=n.querySelector("#charCreator_mainContextTemplatePreset"),s=n.querySelector("#charCreator_mainContextList"),l=n.querySelector("#charCreator_restoreMainContextTemplateDefault"),Ce("#charCreator_mainContextTemplatePreset",{initialList:Object.keys(r.mainContextTemplatePresets),initialValue:r.mainContextTemplatePreset,readOnlyValues:["default"],onSelectChange:function(e,t){var n=null!=t?t:"default";p(r.mainContextTemplatePresets[n].prompts.map((function(e){var t=e.promptName;return r.prompts[e.promptName]&&(t="".concat(r.prompts[e.promptName].label," (").concat(e.promptName,")")),{enabled:e.enabled,id:e.promptName,label:t,selectOptions:[{value:"user",label:"User"},{value:"assistant",label:"Assistant"},{value:"system",label:"System"}],selectValue:e.role}}))),r.mainContextTemplatePreset=n,Oo.saveSettings()},create:{onAfterCreate:function(e){var t=r.mainContextTemplatePresets[r.mainContextTemplatePreset];t||(t=r.mainContextTemplatePresets.default),r.mainContextTemplatePresets[e]=structuredClone(t)}},rename:{onAfterRename:function(e,t){r.mainContextTemplatePresets[t]=r.mainContextTemplatePresets[e],delete r.mainContextTemplatePresets[e]}},delete:{onAfterDelete:function(e){delete r.mainContextTemplatePresets[e]}}}),c=r.mainContextTemplatePresets[r.mainContextTemplatePreset].prompts.map((function(e){var t=e.promptName;return r.prompts[e.promptName]&&(t="".concat(r.prompts[e.promptName].label," (").concat(e.promptName,")")),{enabled:e.enabled,id:e.promptName,label:t,selectOptions:[{value:"user",label:"User"},{value:"assistant",label:"Assistant"},{value:"system",label:"System"}],selectValue:e.role}})),u=Ln(s,{initialList:c,showSelectInput:!0,showToggleButton:!0,onSelectChange:function(e,t){var n=r.mainContextTemplatePresets[r.mainContextTemplatePreset].prompts.find((function(t){return t.promptName===e}));n&&(n.role=t,Oo.saveSettings())},onToggle:function(e,t){var n=r.mainContextTemplatePresets[r.mainContextTemplatePreset].prompts.find((function(t){return t.promptName===e}));n&&(n.enabled=t,Oo.saveSettings())},onOrderChange:function(e){var t=e.map((function(e){return r.mainContextTemplatePresets[r.mainContextTemplatePreset].prompts.find((function(t){return t.promptName===e}))})).filter((function(e){return void 0!==e}));r.mainContextTemplatePresets[r.mainContextTemplatePreset].prompts=t,Oo.saveSettings()}}),p=u.setList,h=u.getList,o=p,i=h,l.addEventListener("click",qo(Vo().mark((function e(){return Vo().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,co.Popup.show.confirm("Restore default","Are you sure you want to restore the default prompt?");case 2:if(e.sent){e.next=5;break}return e.abrupt("return");case 5:r.mainContextTemplatePresets.default={prompts:No.mainContextTemplatePresets.default.prompts},"default"!==a.value?(a.value="default",a.dispatchEvent(new Event("change"))):(p(r.mainContextTemplatePresets.default.prompts.map((function(e){var t=e.promptName;return r.prompts[e.promptName]&&(t="".concat(r.prompts[e.promptName].label," (").concat(e.promptName,")")),{enabled:e.enabled,id:e.promptName,label:t,selectOptions:[{value:"user",label:"User"},{value:"assistant",label:"Assistant"},{value:"system",label:"System"}],selectValue:e.role}}))),Oo.saveSettings());case 7:case"end":return e.stop()}}),e)})))),d=n.querySelector("#charCreator_systemPromptPreset"),f=n.querySelector("#charCreator_systemPromptContent"),m=n.querySelector("#charCreator_restoreSystemPromptDefault"),Ce("#charCreator_systemPromptPreset",{initialList:Object.keys(r.prompts),readOnlyValues:Co,initialValue:Co[0],label:function(e){if(""===e)return"prompt";var t=r.prompts[e];return t?"".concat(t.label," (").concat(e,")"):e},create:{onBeforeCreate:function(e){var t=Ao(e);return t?!r.prompts[t]||(be("error","Prompt name already exists: ".concat(t)),!1):(be("error","Invalid prompt name: ".concat(e)),!1)},onAfterCreate:function(e){var t=Ao(e);return r.prompts[t]={content:f.value,isDefault:!1,label:e},Object.entries(r.mainContextTemplatePresets).forEach((function(e){var n=Bo(e,2);n[0];n[1].prompts.push({enabled:!0,promptName:t,role:"user"})})),o([].concat(jo(i()),[{enabled:!0,id:t,label:"".concat(e," (").concat(t,")"),selectOptions:[{value:"user",label:"User"},{value:"assistant",label:"Assistant"},{value:"system",label:"System"}],selectValue:"user"}])),t}},rename:{onBeforeRename:function(e,t){var n=Ao(t);return n?!r.prompts[n]||(be("error","Prompt name already exists: ".concat(n)),!1):(be("error","Invalid prompt name: ".concat(t)),!1)},onAfterRename:function(e,t){var n=Ao(t);return r.prompts[n]=Fo(Fo({},r.prompts[e]),{},{label:t}),delete r.prompts[e],Object.entries(r.mainContextTemplatePresets).forEach((function(t){var r=Bo(t,2);r[0];r[1].prompts.forEach((function(t){t.promptName===e&&(t.promptName=n)}))})),o(i().map((function(r){return r.id===e?Fo(Fo({},r),{},{id:n,label:"".concat(t," (").concat(n,")")}):r}))),n}},delete:{onAfterDelete:function(e){delete r.prompts[e],Object.entries(r.mainContextTemplatePresets).forEach((function(t){var n=Bo(t,2),r=(n[0],n[1]);r.prompts=r.prompts.filter((function(t){return t.promptName!==e}))})),o(i().filter((function(t){return t.id!==e})))}},onSelectChange:function(e,t){var n,o=null!=t?t:"",i=r.prompts[o];i&&(f.value=null!==(n=i.content)&&void 0!==n?n:"",m.style.display=Co.includes(o)?"block":"none",Oo.saveSettings())}}),g=d.value,(v=r.prompts[g])&&(f.value=null!==(y=v.content)&&void 0!==y?y:"",m.style.display=Co.includes(g)?"block":"none"),f.addEventListener("change",(function(){var e=d.value,t=f.value,n=r.prompts[e];n&&(n.content=t,n.isDefault=!!Co.includes(e)&&Po[e]===t,m.style.display=Co.includes(e)?"block":"none",Oo.saveSettings())})),m.addEventListener("click",qo(Vo().mark((function e(){var t,n,o;return Vo().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=d.value,n=Po[t],!(o=r.prompts[t])){e.next=10;break}return e.next=6,co.Popup.show.confirm("Restore Default",'Are you sure you want to restore the default for "'.concat(o.label,'"?'));case 6:e.sent&&(f.value=n,f.dispatchEvent(new Event("change"))),e.next=11;break;case 10:be("warning","No prompt selected.");case 11:case"end":return e.stop()}}),e)})))),(b=n.querySelector("#charCreator_showSaveAsWorldInfo"))&&(b.checked=r.showSaveAsWorldInfoEntry.show,b.addEventListener("change",(function(){r.showSaveAsWorldInfoEntry.show=b.checked,Oo.saveSettings()}))),n.querySelector("#charCreator_resetEverything").addEventListener("click",qo(Vo().mark((function e(){return Vo().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,co.Popup.show.confirm("Reset Everything","Are you sure? This will reset all settings to default and clear your data in popup. This cannot be undone. This is a destructive action.");case 2:e.sent&&(localStorage.removeItem("charCreator"),Oo.resetSettings(),setTimeout((function(){be("success","Everything has been reset to default. Please reload the page.")}),1500));case 4:case"end":return e.stop()}}),e)}))));case 30:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Uo(){return Uo=qo(Vo().mark((function e(){var t;return Vo().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t='<div class="menu_button fa-solid fa-user-astronaut interactable charCreator-icon" title="Character Creator"></div>',$(".form_create_bottom_buttons_block").prepend(t),$("#GroupFavDelOkBack").prepend(t),$("#form_character_search_form").prepend(t),document.querySelectorAll(".charCreator-icon").forEach((function(e){e.addEventListener("click",qo(Vo().mark((function e(){var t,n,r,o,i,a,s,l,c,u,p,h,d,f,g,v,y,b,x,w,S,_,E,k,C,P,N,A,O,D,I,T,L,F,M,j,B,R,$,V,H,q,W,U,Y,G,X,K,z,J,Z,Q,ee,te,ne,re,oe,ie,ae,se,le,ue;return Vo().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return ue=function(){return ue=qo(Vo().mark((function e(t){var n,r,o,i,a,s,l,c,u,d,f,m,g,v,y,b,x,w,S,_,E,k,C,P,N,A,O,D,I;return Vo().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(u=t.targetField,d=t.button,f=t.textarea,m=t.isDraft,d.disabled=!0,g=d.innerHTML,d.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i>',e.prev=4,y=p.querySelector("#charCreator_prompt").value,h.profileId){e.next=9;break}return be("warning","Please select a connection profile."),e.abrupt("return");case 9:if(b=null===(v=R.extensionSettings.connectionManager)||void 0===v||null===(v=v.profiles)||void 0===v?void 0:v.find((function(e){return e.id===h.profileId}))){e.next=13;break}return be("warning","Connection profile not found."),e.abrupt("return");case 13:x={presetName:null==b?void 0:b.preset,contextName:null==b?void 0:b.context,instructName:null==b?void 0:b.instruct,targetCharacterId:pe.this_chid,ignoreCharacterFields:!0,ignoreWorldInfo:!0,ignoreAuthorNote:!0,maxContext:"custom"===h.maxContextType?h.maxContextValue:"profile"===h.maxContextType?"preset":"active",includeNames:!!ve.selected_group},w=h.contextToSend.messages,e.t0=w.type,e.next="none"===e.t0?18:"first"===e.t0?20:"last"===e.t0?22:"range"===e.t0?26:(e.t0,28);break;case 18:return x.messageIndexesBetween={start:-1,end:-1},e.abrupt("break",29);case 20:return x.messageIndexesBetween={start:0,end:null!==(n=w.first)&&void 0!==n?n:10},e.abrupt("break",29);case 22:return S=null!==(r=null===(o=co.chat)||void 0===o?void 0:o.length)&&void 0!==r?r:0,_=null!==(i=w.last)&&void 0!==i?i:10,x.messageIndexesBetween={end:Math.max(0,S-1),start:Math.max(0,S-_)},e.abrupt("break",29);case 26:return x.messageIndexesBetween={start:null!==(a=null===(s=w.range)||void 0===s?void 0:s.start)&&void 0!==a?a:0,end:null!==(l=null===(c=w.range)||void 0===c?void 0:c.end)&&void 0!==l?l:10},e.abrupt("break",29);case 28:return e.abrupt("break",29);case 29:void 0!==pe.this_chid||ve.selected_group||(x.messageIndexesBetween={start:-1,end:-1}),E="",e.t1=h.outputFormat,e.next="xml"===e.t1?34:"json"===e.t1?36:"none"===e.t1?38:40;break;case 34:return E=h.prompts.xmlFormat.content,e.abrupt("break",40);case 36:return E=h.prompts.jsonFormat.content,e.abrupt("break",40);case 38:return E=h.prompts.noneFormat.content,e.abrupt("break",40);case 40:return k={},e.next=43,Promise.all(he.world_names.filter((function(e){return j.selectedWorldNames.includes(e)})).map(function(){var e=qo(Vo().mark((function e(t){var n;return Vo().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,co.loadWorldInfo(t);case 2:(n=e.sent)&&(k[t]=Object.values(n.entries));case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 43:P={},N=Io(uo);try{for(N.s();!(A=N.n()).done;)O=A.value,P[O]={prompt:j.fields[O].prompt,value:j.fields[O].value,label:po[O]}}catch(e){N.e(e)}finally{N.f()}return C=Fo(Fo({},j),{},{fields:P}),D=structuredClone(h.prompts),h.contextToSend.stDescription||delete D.stDescription,h.contextToSend.charCard&&0!==j.selectedCharacterIndexes.length||delete D.charDefinitions,h.contextToSend.worldInfo&&0!==j.selectedWorldNames.length||delete D.lorebookDefinitions,h.contextToSend.existingFields||delete D.existingFieldDefinitions,h.contextToSend.persona||delete D.personaDescription,delete D.worldInfoCharDefinition,e.next=56,ho({profileId:h.profileId,userPrompt:y,buildPromptOptions:x,session:C,allCharacters:R.characters,entriesGroupByWorldName:k,promptSettings:D,formatDescription:{content:E},mainContextList:h.mainContextTemplatePresets[h.mainContextTemplatePreset].prompts.filter((function(e){return e.enabled})).map((function(e){return{promptName:e.promptName,role:e.role}})),includeUserMacro:h.contextToSend.persona,maxResponseToken:h.maxResponseToken,targetField:u,outputFormat:h.outputFormat});case 56:I=e.sent,f.value=I,f.dispatchEvent(new Event("change")),e.next=65;break;case 61:e.prev=61,e.t2=e.catch(4),console.error("Error generating field ".concat(u,":"),e.t2),be("error","Failed to generate ".concat(u,": ").concat(e.t2.message||e.t2));case 65:return e.prev=65,d.disabled=!1,d.innerHTML=g,e.finish(65);case 69:case"end":return e.stop()}}),e,null,[[4,61,65,69]])}))),ue.apply(this,arguments)},le=function(e){return ue.apply(this,arguments)},e.next=4,co.renderExtensionTemplateAsync("third-party/".concat(Eo),"templates/popup");case 4:if(u=e.sent,co.callGenericPopup(u,Mn.DISPLAY,void 0,{large:!0,wide:!0}),p=document.getElementById("charCreatorPopup")){e.next=9;break}return e.abrupt("return");case 9:h=Oo.getSettings(),co.ConnectionManagerRequestService.handleDropdown("#charCreatorPopup #charCreator_connectionProfile",h.profileId,(function(e){var t;h.profileId=null!==(t=null==e?void 0:e.id)&&void 0!==t?t:"",Oo.saveSettings()})),d=p.querySelector("#charCreator_stDescription"),f=p.querySelector("#charCreator_includePersona"),g=p.querySelector("#charCreator_includeChars"),v=p.querySelector("#charCreator_charIncludeContainer"),y=p.querySelector("#charCreator_includeWorldInfo"),b=p.querySelector("#charCreator_worldInfoIncludeContainer"),x=p.querySelector("#charCreator_includeExistingFields"),d.checked=h.contextToSend.stDescription,f.checked=h.contextToSend.persona,g.checked=h.contextToSend.charCard,x.checked=h.contextToSend.existingFields,y.checked=h.contextToSend.worldInfo,v.style.display=g.checked?"block":"none",b.style.display=y.checked?"block":"none",d.addEventListener("change",(function(){h.contextToSend.stDescription=d.checked,Oo.saveSettings()})),f.addEventListener("change",(function(){h.contextToSend.persona=f.checked,Oo.saveSettings()})),g.addEventListener("change",(function(){h.contextToSend.charCard=g.checked,v.style.display=g.checked?"block":"none",Oo.saveSettings()})),y.addEventListener("change",(function(){h.contextToSend.worldInfo=y.checked,b.style.display=y.checked?"block":"none",Oo.saveSettings()})),x.addEventListener("change",(function(){h.contextToSend.existingFields=x.checked,Oo.saveSettings()})),w=p.querySelector(".message-options"),S=p.querySelector("#charCreator_messageType"),_=p.querySelector("#charCreator_firstX"),E=p.querySelector("#charCreator_lastX"),k=p.querySelector("#charCreator_rangeX"),C=p.querySelector("#charCreator_firstXMessages"),P=p.querySelector("#charCreator_lastXMessages"),N=p.querySelector("#charCreator_rangeStart"),A=p.querySelector("#charCreator_rangeEnd"),S.value=h.contextToSend.messages.type,C.value=String(null!==(t=h.contextToSend.messages.first)&&void 0!==t?t:10),P.value=String(null!==(n=h.contextToSend.messages.last)&&void 0!==n?n:10),N.value=String(null!==(r=null===(o=h.contextToSend.messages.range)||void 0===o?void 0:o.start)&&void 0!==r?r:0),A.value=String(null!==(i=null===(a=h.contextToSend.messages.range)||void 0===a?void 0:a.end)&&void 0!==i?i:10),(O=function(e){_.style.display="first"===e?"block":"none",E.style.display="last"===e?"block":"none",k.style.display="range"===e?"block":"none"})(S.value),void 0!==pe.this_chid||ve.selected_group||(w.style.display="none"),S.addEventListener("change",(function(){var e=S.value;h.contextToSend.messages.type=e,Oo.saveSettings(),O(e)})),C.addEventListener("change",(function(){h.contextToSend.messages.first=parseInt(C.value)||10,Oo.saveSettings()})),P.addEventListener("change",(function(){h.contextToSend.messages.last=parseInt(P.value)||10,Oo.saveSettings()})),N.addEventListener("change",(function(){var e,t;h.contextToSend.messages.range={start:parseInt(N.value)||0,end:null!==(e=null===(t=h.contextToSend.messages.range)||void 0===t?void 0:t.end)&&void 0!==e?e:10},Oo.saveSettings()})),A.addEventListener("change",(function(){var e,t;h.contextToSend.messages.range={start:null!==(e=null===(t=h.contextToSend.messages.range)||void 0===t?void 0:t.start)&&void 0!==e?e:0,end:parseInt(A.value)||10},Oo.saveSettings()})),D=p.querySelector("#charCreator_maxContextType"),I=p.querySelector("#charCreator_maxTokens_container"),T=p.querySelector("#charCreator_maxTokens"),D.value=h.maxContextType,I.style.display="custom"===h.maxContextType?"block":"none",T.value=String(h.maxContextValue),D.addEventListener("change",(function(){var e=D.value;h.maxContextType=e,Oo.saveSettings(),I.style.display="custom"===e?"block":"none"})),T.addEventListener("change",(function(){h.maxContextValue=Number(T.value)||16384,Oo.saveSettings()})),(L=p.querySelector("#charCreator_maxResponseTokens")).value=String(h.maxResponseToken),L.addEventListener("change",(function(){h.maxResponseToken=Number(L.value)||1024,Oo.saveSettings()})),(F=p.querySelector("#charCreator_outputFormat")).value=h.outputFormat,F.addEventListener("change",(function(){h.outputFormat=F.value,Oo.saveSettings()})),M="charCreator",(j=JSON.parse(null!==(s=localStorage.getItem(M))&&void 0!==s?s:"{}")).selectedCharacterIndexes||(j.selectedCharacterIndexes=pe.this_chid?[pe.this_chid]:[]),j.selectedWorldNames||(j.selectedWorldNames=[]),j.fields||(j.fields={}),j.draftFields||(j.draftFields={}),uo.forEach((function(e){j.fields[e]||(j.fields[e]={value:"",prompt:"",label:""})})),B=function(){localStorage.setItem(M,JSON.stringify(j))},R=SillyTavern.getContext(),j.selectedCharacterIndexes=j.selectedCharacterIndexes.filter((function(e){return R.characters[Number(e)]})),p.querySelector("#charCreator_characterSelector")&&ce("#charCreator_characterSelector",{initialList:$=R.characters.map((function(e){return{value:R.characters.indexOf(e).toString(),label:e.name}})),initialValues:j.selectedCharacterIndexes,placeholderText:"Select characters...",enableSearch:$.length>10,onSelectChange:function(e,t){j.selectedCharacterIndexes=t,B()}}),V=p.querySelector("#charCreator_worldInfoSelector"),H=structuredClone(he.world_names);try{V&&H.length>0?ce("#charCreator_worldInfoSelector",{initialList:H,initialValues:j.selectedWorldNames,placeholderText:"Select lorebooks...",enableSearch:H.length>10,onSelectChange:function(e,t){j.selectedWorldNames=t,B()}}):V&&(V.textContent="No active lorebooks found.")}catch(e){console.error("Failed to get active world info:",e),V&&(V.textContent="Error loading lorebooks.")}q=p.querySelector("#charCreator_prompt"),Ce("#charCreatorPopup #charCreator_promptPreset",{initialValue:h.promptPreset,initialList:Object.keys(h.promptPresets),readOnlyValues:["default"],onSelectChange:function(){var e=qo(Vo().mark((function e(t,n){var r,o,i;return Vo().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=null!=n?n:"default",h.promptPreset=i,Oo.saveSettings(),q.value=null!==(r=null===(o=h.promptPresets[i])||void 0===o?void 0:o.content)&&void 0!==r?r:"";case 4:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),create:{onAfterCreate:function(e){var t,n=h.promptPresets[h.promptPreset];h.promptPresets[e]={content:null!==(t=null==n?void 0:n.content)&&void 0!==t?t:""}}},rename:{onAfterRename:function(e,t){h.promptPresets[t]=h.promptPresets[e],delete h.promptPresets[e]}},delete:{onAfterDelete:function(e){delete h.promptPresets[e]}}}),q.value=null!==(l=null===(c=h.promptPresets[h.promptPreset])||void 0===c?void 0:c.content)&&void 0!==l?l:"",q.addEventListener("change",(function(){h.promptPresets[h.promptPreset]&&(h.promptPresets[h.promptPreset].content=q.value,Oo.saveSettings())})),W={name:{label:po.name,rows:1,large:!1,promptEnabled:!1},description:{label:po.description,rows:5,large:!0,promptEnabled:!0},personality:{label:po.personality,rows:4,large:!0,promptEnabled:!0},scenario:{label:po.scenario,rows:3,large:!0,promptEnabled:!0},first_mes:{label:po.first_mes,rows:3,large:!0,promptEnabled:!0},mes_example:{label:po.mes_example,rows:6,large:!0,promptEnabled:!0}},U=p.querySelector("#charCreator_coreFieldTemplate"),Y=p.querySelector("#charCreator_draftFieldTemplate"),G=p.querySelector("#charCreator_coreFieldsContainer"),X=p.querySelector("#charCreator_draftFieldsList"),K=p.querySelectorAll(".tab-button"),z=p.querySelectorAll(".tab-content"),J=p.querySelector("#charCreator_addDraftField"),Z=p.querySelector("#charCreator_exportDraftFields"),Q=p.querySelector("#charCreator_importDraftFields"),ee={},te=function(e){K.forEach((function(t){t.classList.toggle("active",t.getAttribute("data-tab")===e)})),z.forEach((function(t){t.classList.toggle("active",t.id===e)}));var t="charCreator_draftFieldsContainer"===e;J.style.display=t?"block":"none",Z.style.display=t?"block":"none",Q.style.display=t?"block":"none"},K.forEach((function(e){e.addEventListener("click",(function(){var t=e.getAttribute("data-tab");t&&te(t)}))})),te("charCreator_coreFieldsContainer"),uo.forEach((function(e){var t,n,r,o,i,a,s=W[e],l=U.content.cloneNode(!0),c=l.querySelector("label"),u=l.querySelector(".field-value-textarea"),p=l.querySelector(".generate-field-button"),h=l.querySelector(".clear-field-button"),d=l.querySelector(".field-prompt-textarea");(u.id="charCreator_field_".concat(e),d.id="charCreator_prompt_".concat(e),c.textContent=s.label,c.htmlFor=u.id,u.rows=s.rows,u.value=null!==(t=null===(n=j.fields[e])||void 0===n?void 0:n.value)&&void 0!==t?t:"",p.dataset.field=e,p.title="Generate ".concat(s.label),d.placeholder="Enter additional prompt for ".concat(s.label.toLowerCase(),"..."),d.value=null!==(r=null===(o=j.fields[e])||void 0===o?void 0:o.prompt)&&void 0!==r?r:"",s.promptEnabled)||(null===(i=d.closest(".field-prompt-container"))||void 0===i||i.remove());s.large&&(null===(a=u.closest(".field-container"))||void 0===a||a.classList.add("large-field"));null==h||h.addEventListener("click",(function(){u.value="",u.dispatchEvent(new Event("change"))})),ee[e]={textarea:u,button:p,promptTextarea:d,clearButton:h},G.appendChild(l)})),ne=function(e,t){var n,r;if(Y&&X){var o=Y.content.cloneNode(!0),i=o.querySelector(".character-field"),a=o.querySelector("label"),s=o.querySelector(".field-value-textarea"),l=o.querySelector(".field-prompt-textarea"),c=o.querySelector(".delete-draft-field-button"),u=o.querySelector(".generate-field-button"),p=o.querySelector(".clear-field-button");i.dataset.draftFieldName=e,a.textContent=t.label,a.htmlFor="charCreator_draft_field_".concat(e),s.id="charCreator_draft_field_".concat(e),s.value=null!==(n=t.value)&&void 0!==n?n:"",l.value=null!==(r=t.prompt)&&void 0!==r?r:"",l.id="charCreator_draft_prompt_".concat(e),l.placeholder="Enter additional prompt for ".concat(t.label,"..."),c.dataset.draftFieldName=e,u.dataset.field=e,p.dataset.draftFieldName=e,s.addEventListener("change",(function(){j.draftFields[e]&&(j.draftFields[e].value=s.value,B())})),l.addEventListener("change",(function(){j.draftFields[e]&&(j.draftFields[e].prompt=l.value,B())})),p.addEventListener("click",(function(){j.draftFields[e]&&(s.value="",j.draftFields[e].value="",B())})),c.addEventListener("click",qo(Vo().mark((function n(){return Vo().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,co.Popup.show.confirm("Delete Draft Field",'Are you sure you want to delete the draft field "'.concat(t.label,'"? This cannot be undone.'));case 2:n.sent&&(delete j.draftFields[e],i.remove(),B());case 4:case"end":return n.stop()}}),n)})))),u.addEventListener("click",(function(){le({targetField:e,button:u,textarea:s,isDraft:!0})})),X.appendChild(o)}},(re=function(){X&&(X.innerHTML="",Object.entries(j.draftFields||{}).forEach((function(e){var t=Bo(e,2),n=t[0],r=t[1];ne(n,r)})))})(),null==Z||Z.addEventListener("click",(function(){var e={draftFields:j.draftFields,timestamp:(new Date).toISOString(),version:ko},t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),n=URL.createObjectURL(t),r=document.createElement("a");r.href=n,r.download="draft-fields-".concat((new Date).toISOString().slice(0,10),".json"),document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(n)})),null==Q||Q.addEventListener("click",qo(Vo().mark((function e(){var t;return Vo().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:(t=document.createElement("input")).type="file",t.accept=".json",t.addEventListener("change",qo(Vo().mark((function e(){var n,r,o,i,a;return Vo().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=null===(n=t.files)||void 0===n?void 0:n[0]){e.next=3;break}return e.abrupt("return");case 3:return e.prev=3,e.next=6,r.text();case 6:if(o=e.sent,(i=JSON.parse(o)).draftFields&&"object"===To(i.draftFields)){e.next=10;break}throw new Error("Invalid draft fields data");case 10:if(a=!0,!(Object.keys(j.draftFields).length>0)){e.next=15;break}return e.next=14,co.Popup.show.confirm("Import Draft Fields","This will replace all existing draft fields. Continue?");case 14:a=e.sent;case 15:a&&(j.draftFields=i.draftFields,B(),re(),be("success","Draft fields imported successfully")),e.next=21;break;case 18:e.prev=18,e.t0=e.catch(3),be("error","Failed to import draft fields: ".concat(e.t0.message));case 21:case"end":return e.stop()}}),e,null,[[3,18]])})))),t.click();case 5:case"end":return e.stop()}}),e)})))),J&&J.addEventListener("click",qo(Vo().mark((function e(){var t,n;return Vo().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,co.Popup.show.input("Enter Draft Field Name","");case 2:if((t=e.sent)&&t.trim()){e.next=5;break}return e.abrupt("return");case 5:if(n=Ao(t.trim())){e.next=9;break}return be("error","Invalid field name provided."),e.abrupt("return");case 9:if(!j.draftFields[n]&&!W[n]){e.next=12;break}return be("warning",'Field name "'.concat(n,'" already exists.')),e.abrupt("return");case 12:j.draftFields[n]={value:"",prompt:"",label:t},ne(n,j.draftFields[n]),B();case 15:case"end":return e.stop()}}),e)})))),p.querySelector("#charCreator_loadCharSelector")&&ce("#charCreator_loadCharSelector",{initialList:oe=R.characters.map((function(e){return{value:R.characters.indexOf(e).toString(),label:e.name}})),initialValues:[],placeholderText:"Load Character Data...",enableSearch:oe.length>10,multiple:!1,closeOnSelect:!0,onBeforeSelection:function(e,t){return qo(Vo().mark((function e(){return Vo().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==t.length){e.next=2;break}return e.abrupt("return",!1);case 2:if(0!==t[0].length){e.next=5;break}return e.abrupt("return",!1);case 5:if(uo.every((function(e){var t,n=null===(t=ee[e])||void 0===t?void 0:t.textarea;return n&&""===n.value.trim()}))){e.next=12;break}return e.next=9,co.Popup.show.confirm("Load Character Data","Are you sure you want to overwrite existing data? This cannot be undone.");case 9:if(e.sent){e.next=12;break}return e.abrupt("return",!1);case 12:return e.abrupt("return",!0);case 13:case"end":return e.stop()}}),e)})))()},onSelectChange:function(){var e=qo(Vo().mark((function e(t,n){var r,o;return Vo().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==n.length){e.next=2;break}return e.abrupt("return");case 2:if(0!==(r=n[0]).length){e.next=5;break}return e.abrupt("return");case 5:if(o=R.characters[parseInt(r)]){e.next=9;break}return be("warning","Selected character not found."),e.abrupt("return");case 9:uo.forEach((function(e){var t,n,r,i=null===(t=ee[e])||void 0===t?void 0:t.textarea,a=null===(n=ee[e])||void 0===n?void 0:n.promptTextarea;i&&(i.value=null!==(r=o[e])&&void 0!==r?r:"",i.dispatchEvent(new Event("change")));a&&""!==a.value.trim()&&(a.value="",a.dispatchEvent(new Event("change")))}));case 10:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()}),p.querySelector("#charCreator_reset").addEventListener("click",qo(Vo().mark((function e(){return Vo().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,co.Popup.show.confirm("Reset Fields","Are you sure? This will reset core fields and remove draft fields. This cannot be undone.");case 2:e.sent&&(uo.forEach((function(e){var t,n;null!==(t=ee[e])&&void 0!==t&&t.textarea&&(ee[e].textarea.value="",ee[e].textarea.dispatchEvent(new Event("change"))),null!==(n=ee[e])&&void 0!==n&&n.promptTextarea&&(ee[e].promptTextarea.value="",ee[e].promptTextarea.dispatchEvent(new Event("change")))})),j.draftFields={},B(),re());case 4:case"end":return e.stop()}}),e)})))),p.querySelector("#charCreator_saveAsNewCharacter").addEventListener("click",qo(Vo().mark((function e(){var t;return Vo().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(j.fields.name.value){e.next=3;break}return be("warning","Please enter a name for the new character."),e.abrupt("return");case 3:return e.next=5,co.Popup.show.confirm("Save as New Character","Are you sure?");case 5:if(e.sent){e.next=8;break}return e.abrupt("return");case 8:return t={name:j.fields.name.value,description:j.fields.description.value,personality:j.fields.personality.value,scenario:j.fields.scenario.value,first_mes:j.fields.first_mes.value,mes_example:j.fields.mes_example.value,data:{name:j.fields.name.value,description:j.fields.description.value,personality:j.fields.personality.value,scenario:j.fields.scenario.value,first_mes:j.fields.first_mes.value,mes_example:j.fields.mes_example.value,tags:[],avatar:"none"},avatar:"none",tags:[],spec:"chara_card_v3",spec_version:"3.0"},e.prev=9,e.next=12,m(t,!0);case 12:e.next=17;break;case 14:e.prev=14,e.t0=e.catch(9),be("error","Failed to create character: ".concat(e.t0.message));case 17:case"end":return e.stop()}}),e,null,[[9,14]])})))),ie=p.querySelector("#charCreator_saveAsWorldInfoSelector"),h.showSaveAsWorldInfoEntry.show?(ae=ce(ie,{placeholderText:"Save as World Info Entry",initialList:he.world_names,closeOnSelect:!0,multiple:!1,enableSearch:!0,onBeforeSelection:function(e,t){return qo(Vo().mark((function e(){var n,r,o,i,a;return Vo().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==t.length){e.next=2;break}return e.abrupt("return",!1);case 2:if((n={name:j.fields.name.value,description:j.fields.description.value,first_mes:j.fields.first_mes.value,scenario:j.fields.scenario.value,personality:j.fields.personality.value,mes_example:j.fields.mes_example.value,avatar:"none"}).name){e.next=7;break}return be("warning","Please enter a name for the character."),se(),e.abrupt("return",!1);case 7:r="",e.prev=8,o=Jr.compile(h.prompts.charDefinitions.content,{noEscape:!0}),r=o({character:n}),e.next=19;break;case 13:return e.prev=13,e.t0=e.catch(8),console.error("Failed to compile character definition prompt: ".concat(e.t0.message)),be("error","Failed to compile character definition prompt: ".concat(e.t0.message)),se(),e.abrupt("return",!1);case 19:return i=t[0],a={uid:-1,key:[j.fields.name.value],content:r,comment:j.fields.name.value,disable:!1},e.prev=21,e.next=24,Fn({entry:a,selectedWorldName:i,operation:"add"});case 24:be("success","Entry added"),e.next=30;break;case 27:e.prev=27,e.t1=e.catch(21),be("error","Failed to create world info entry: ".concat(e.t1.message));case 30:return se(),e.abrupt("return",!1);case 32:case"end":return e.stop()}}),e,null,[[8,13],[21,27]])})))()}}),se=ae.close):ie.style.display="none",Object.entries(ee).forEach((function(e){var t=Bo(e,2),n=t[0],r=t[1],o=r.textarea,i=r.button,a=r.promptTextarea;i&&(i.addEventListener("click",(function(){le({targetField:n,button:i,textarea:o})})),o.addEventListener("change",(function(){var e=n;j.fields[e]=Fo(Fo({},j.fields[e]),{},{value:o.value}),B()})),null==a||a.addEventListener("change",(function(){var e=n;j.fields[e]=Fo(Fo({},j.fields[e]),{},{prompt:a.value}),B()})))}));case 115:case"end":return e.stop()}}),e)}))))}));case 6:case"end":return e.stop()}}),e)}))),Uo.apply(this,arguments)}function Yo(){!function(){Wo.apply(this,arguments)}(),function(){Uo.apply(this,arguments)}()}Jr.helpers.join||Jr.registerHelper("join",(function(e,t){return Array.isArray(e)?e.join("string"==typeof t?t:", "):""})),co.ConnectionManagerRequestService?function(){return Do.apply(this,arguments)}().then((function(){Yo()})):be("error","[".concat(Eo,"] Make sure you are on staging branch and staging is updated."));