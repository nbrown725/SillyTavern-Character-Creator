import{persona_description_positions as e,renderStoryString as t}from"../../../../power-user.js";import{baseChatReplace as n,chat_metadata as r,depth_prompt_depth_default as o,depth_prompt_role_default as i,extension_prompt_types as a,getMaxContextSize as s,name1 as l,name2 as c,parseMesExamples as u,this_chid as p}from"../../../../../script.js";import{createWorldInfoEntry as d,wi_anchor_position as h,world_info_include_names as f,world_names as m}from"../../../../world-info.js";import{formatInstructModeExamples as g,formatInstructModeSystemPrompt as v}from"../../../../instruct-mode.js";import{appendFileContent as y}from"../../../../chats.js";import{formatWorldInfo as b,getPromptPosition as S,getPromptRole as x,prepareOpenAIMessages as w,setOpenAIMessageExamples as C,setOpenAIMessages as _}from"../../../../openai.js";import{metadata_keys as E}from"../../../../authors-note.js";import{getGroupDepthPrompts as k,selected_group as P}from"../../../../group-chats.js";import{getRegexedString as D,regex_placement as T}from"../../../regex/engine.js";import"../../../../utils.js";import"../../../../slash-commands/SlashCommandCommonEnumsProvider.js";import"../../../../slash-commands/SlashCommandEnumValue.js";var I={27:(e,t,n)=>{function r(e){return e&&e.__esModule?e:{default:e}}t.__esModule=!0,t.parseWithoutProcessing=c,t.parse=function(e,t){var n=c(e,t);return new i.default(t).accept(n)};var o=r(n(201)),i=r(n(915)),a=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(n(425)),s=n(849);t.parser=o.default;var l={};function c(e,t){return"Program"===e.type?e:(o.default.yy=l,l.locInfo=function(e){return new l.SourceLocation(t&&t.srcName,e)},o.default.parse(e))}s.extend(l,a)},97:(e,t,n)=>{t.__esModule=!0;var r=n(849);t.default=function(e){e.registerHelper("blockHelperMissing",function(t,n){var o=n.inverse,i=n.fn;if(!0===t)return i(this);if(!1===t||null==t)return o(this);if(r.isArray(t))return t.length>0?(n.ids&&(n.ids=[n.name]),e.helpers.each(t,n)):o(this);if(n.data&&n.ids){var a=r.createFrame(n.data);a.contextPath=r.appendContextPath(n.data.contextPath,n.name),n={data:a}}return i(t,n)})},e.exports=t.default},127:(e,t,n)=>{function r(e){return e&&e.__esModule?e:{default:e}}t.__esModule=!0,t.Compiler=l,t.precompile=function(e,t,n){if(null==e||"string"!=typeof e&&"Program"!==e.type)throw new o.default("You must pass a string or Handlebars AST to Handlebars.precompile. You passed "+e);"data"in(t=t||{})||(t.data=!0);t.compat&&(t.useDepths=!0);var r=n.parse(e,t),i=(new n.Compiler).compile(r,t);return(new n.JavaScriptCompiler).compile(i,t)},t.compile=function(e,t,n){void 0===t&&(t={});if(null==e||"string"!=typeof e&&"Program"!==e.type)throw new o.default("You must pass a string or Handlebars AST to Handlebars.compile. You passed "+e);"data"in(t=i.extend({},t))||(t.data=!0);t.compat&&(t.useDepths=!0);var r=void 0;function a(){var r=n.parse(e,t),o=(new n.Compiler).compile(r,t),i=(new n.JavaScriptCompiler).compile(o,t,void 0,!0);return n.template(i)}function s(e,t){return r||(r=a()),r.call(this,e,t)}return s._setup=function(e){return r||(r=a()),r._setup(e)},s._child=function(e,t,n,o){return r||(r=a()),r._child(e,t,n,o)},s};var o=r(n(769)),i=n(849),a=r(n(919)),s=[].slice;function l(){}function c(e,t){if(e===t)return!0;if(i.isArray(e)&&i.isArray(t)&&e.length===t.length){for(var n=0;n<e.length;n++)if(!c(e[n],t[n]))return!1;return!0}}function u(e){if(!e.path.parts){var t=e.path;e.path={type:"PathExpression",data:!1,depth:0,parts:[t.original+""],original:t.original+"",loc:t.loc}}}l.prototype={compiler:l,equals:function(e){var t=this.opcodes.length;if(e.opcodes.length!==t)return!1;for(var n=0;n<t;n++){var r=this.opcodes[n],o=e.opcodes[n];if(r.opcode!==o.opcode||!c(r.args,o.args))return!1}t=this.children.length;for(n=0;n<t;n++)if(!this.children[n].equals(e.children[n]))return!1;return!0},guid:0,compile:function(e,t){return this.sourceNode=[],this.opcodes=[],this.children=[],this.options=t,this.stringParams=t.stringParams,this.trackIds=t.trackIds,t.blockParams=t.blockParams||[],t.knownHelpers=i.extend(Object.create(null),{helperMissing:!0,blockHelperMissing:!0,each:!0,if:!0,unless:!0,with:!0,log:!0,lookup:!0},t.knownHelpers),this.accept(e)},compileProgram:function(e){var t=(new this.compiler).compile(e,this.options),n=this.guid++;return this.usePartial=this.usePartial||t.usePartial,this.children[n]=t,this.useDepths=this.useDepths||t.useDepths,n},accept:function(e){if(!this[e.type])throw new o.default("Unknown type: "+e.type,e);this.sourceNode.unshift(e);var t=this[e.type](e);return this.sourceNode.shift(),t},Program:function(e){this.options.blockParams.unshift(e.blockParams);for(var t=e.body,n=t.length,r=0;r<n;r++)this.accept(t[r]);return this.options.blockParams.shift(),this.isSimple=1===n,this.blockParams=e.blockParams?e.blockParams.length:0,this},BlockStatement:function(e){u(e);var t=e.program,n=e.inverse;t=t&&this.compileProgram(t),n=n&&this.compileProgram(n);var r=this.classifySexpr(e);"helper"===r?this.helperSexpr(e,t,n):"simple"===r?(this.simpleSexpr(e),this.opcode("pushProgram",t),this.opcode("pushProgram",n),this.opcode("emptyHash"),this.opcode("blockValue",e.path.original)):(this.ambiguousSexpr(e,t,n),this.opcode("pushProgram",t),this.opcode("pushProgram",n),this.opcode("emptyHash"),this.opcode("ambiguousBlockValue")),this.opcode("append")},DecoratorBlock:function(e){var t=e.program&&this.compileProgram(e.program),n=this.setupFullMustacheParams(e,t,void 0),r=e.path;this.useDecorators=!0,this.opcode("registerDecorator",n.length,r.original)},PartialStatement:function(e){this.usePartial=!0;var t=e.program;t&&(t=this.compileProgram(e.program));var n=e.params;if(n.length>1)throw new o.default("Unsupported number of partial arguments: "+n.length,e);n.length||(this.options.explicitPartialContext?this.opcode("pushLiteral","undefined"):n.push({type:"PathExpression",parts:[],depth:0}));var r=e.name.original,i="SubExpression"===e.name.type;i&&this.accept(e.name),this.setupFullMustacheParams(e,t,void 0,!0);var a=e.indent||"";this.options.preventIndent&&a&&(this.opcode("appendContent",a),a=""),this.opcode("invokePartial",i,r,a),this.opcode("append")},PartialBlockStatement:function(e){this.PartialStatement(e)},MustacheStatement:function(e){this.SubExpression(e),e.escaped&&!this.options.noEscape?this.opcode("appendEscaped"):this.opcode("append")},Decorator:function(e){this.DecoratorBlock(e)},ContentStatement:function(e){e.value&&this.opcode("appendContent",e.value)},CommentStatement:function(){},SubExpression:function(e){u(e);var t=this.classifySexpr(e);"simple"===t?this.simpleSexpr(e):"helper"===t?this.helperSexpr(e):this.ambiguousSexpr(e)},ambiguousSexpr:function(e,t,n){var r=e.path,o=r.parts[0],i=null!=t||null!=n;this.opcode("getContext",r.depth),this.opcode("pushProgram",t),this.opcode("pushProgram",n),r.strict=!0,this.accept(r),this.opcode("invokeAmbiguous",o,i)},simpleSexpr:function(e){var t=e.path;t.strict=!0,this.accept(t),this.opcode("resolvePossibleLambda")},helperSexpr:function(e,t,n){var r=this.setupFullMustacheParams(e,t,n),i=e.path,s=i.parts[0];if(this.options.knownHelpers[s])this.opcode("invokeKnownHelper",r.length,s);else{if(this.options.knownHelpersOnly)throw new o.default("You specified knownHelpersOnly, but used the unknown helper "+s,e);i.strict=!0,i.falsy=!0,this.accept(i),this.opcode("invokeHelper",r.length,i.original,a.default.helpers.simpleId(i))}},PathExpression:function(e){this.addDepth(e.depth),this.opcode("getContext",e.depth);var t=e.parts[0],n=a.default.helpers.scopedId(e),r=!e.depth&&!n&&this.blockParamIndex(t);r?this.opcode("lookupBlockParam",r,e.parts):t?e.data?(this.options.data=!0,this.opcode("lookupData",e.depth,e.parts,e.strict)):this.opcode("lookupOnContext",e.parts,e.falsy,e.strict,n):this.opcode("pushContext")},StringLiteral:function(e){this.opcode("pushString",e.value)},NumberLiteral:function(e){this.opcode("pushLiteral",e.value)},BooleanLiteral:function(e){this.opcode("pushLiteral",e.value)},UndefinedLiteral:function(){this.opcode("pushLiteral","undefined")},NullLiteral:function(){this.opcode("pushLiteral","null")},Hash:function(e){var t=e.pairs,n=0,r=t.length;for(this.opcode("pushHash");n<r;n++)this.pushParam(t[n].value);for(;n--;)this.opcode("assignToHash",t[n].key);this.opcode("popHash")},opcode:function(e){this.opcodes.push({opcode:e,args:s.call(arguments,1),loc:this.sourceNode[0].loc})},addDepth:function(e){e&&(this.useDepths=!0)},classifySexpr:function(e){var t=a.default.helpers.simpleId(e.path),n=t&&!!this.blockParamIndex(e.path.parts[0]),r=!n&&a.default.helpers.helperExpression(e),o=!n&&(r||t);if(o&&!r){var i=e.path.parts[0],s=this.options;s.knownHelpers[i]?r=!0:s.knownHelpersOnly&&(o=!1)}return r?"helper":o?"ambiguous":"simple"},pushParams:function(e){for(var t=0,n=e.length;t<n;t++)this.pushParam(e[t])},pushParam:function(e){var t=null!=e.value?e.value:e.original||"";if(this.stringParams)t.replace&&(t=t.replace(/^(\.?\.\/)*/g,"").replace(/\//g,".")),e.depth&&this.addDepth(e.depth),this.opcode("getContext",e.depth||0),this.opcode("pushStringParam",t,e.type),"SubExpression"===e.type&&this.accept(e);else{if(this.trackIds){var n=void 0;if(!e.parts||a.default.helpers.scopedId(e)||e.depth||(n=this.blockParamIndex(e.parts[0])),n){var r=e.parts.slice(1).join(".");this.opcode("pushId","BlockParam",n,r)}else(t=e.original||t).replace&&(t=t.replace(/^this(?:\.|$)/,"").replace(/^\.\//,"").replace(/^\.$/,"")),this.opcode("pushId",e.type,t)}this.accept(e)}},setupFullMustacheParams:function(e,t,n,r){var o=e.params;return this.pushParams(o),this.opcode("pushProgram",t),this.opcode("pushProgram",n),e.hash?this.accept(e.hash):this.opcode("emptyHash",r),o},blockParamIndex:function(e){for(var t=0,n=this.options.blockParams.length;t<n;t++){var r=this.options.blockParams[t],o=r&&i.indexOf(r,e);if(r&&o>=0)return[t,o]}}}},148:(e,t)=>{t.__esModule=!0,t.default=function(e){"object"!=typeof globalThis&&(Object.prototype.__defineGetter__("__magic__",function(){return this}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__);var t=globalThis.Handlebars;e.noConflict=function(){return globalThis.Handlebars===e&&(globalThis.Handlebars=t),e}},e.exports=t.default},201:(e,t)=>{t.__esModule=!0;var n=function(){var e={trace:function(){},yy:{},symbols_:{error:2,root:3,program:4,EOF:5,program_repetition0:6,statement:7,mustache:8,block:9,rawBlock:10,partial:11,partialBlock:12,content:13,COMMENT:14,CONTENT:15,openRawBlock:16,rawBlock_repetition0:17,END_RAW_BLOCK:18,OPEN_RAW_BLOCK:19,helperName:20,openRawBlock_repetition0:21,openRawBlock_option0:22,CLOSE_RAW_BLOCK:23,openBlock:24,block_option0:25,closeBlock:26,openInverse:27,block_option1:28,OPEN_BLOCK:29,openBlock_repetition0:30,openBlock_option0:31,openBlock_option1:32,CLOSE:33,OPEN_INVERSE:34,openInverse_repetition0:35,openInverse_option0:36,openInverse_option1:37,openInverseChain:38,OPEN_INVERSE_CHAIN:39,openInverseChain_repetition0:40,openInverseChain_option0:41,openInverseChain_option1:42,inverseAndProgram:43,INVERSE:44,inverseChain:45,inverseChain_option0:46,OPEN_ENDBLOCK:47,OPEN:48,mustache_repetition0:49,mustache_option0:50,OPEN_UNESCAPED:51,mustache_repetition1:52,mustache_option1:53,CLOSE_UNESCAPED:54,OPEN_PARTIAL:55,partialName:56,partial_repetition0:57,partial_option0:58,openPartialBlock:59,OPEN_PARTIAL_BLOCK:60,openPartialBlock_repetition0:61,openPartialBlock_option0:62,param:63,sexpr:64,OPEN_SEXPR:65,sexpr_repetition0:66,sexpr_option0:67,CLOSE_SEXPR:68,hash:69,hash_repetition_plus0:70,hashSegment:71,ID:72,EQUALS:73,blockParams:74,OPEN_BLOCK_PARAMS:75,blockParams_repetition_plus0:76,CLOSE_BLOCK_PARAMS:77,path:78,dataName:79,STRING:80,NUMBER:81,BOOLEAN:82,UNDEFINED:83,NULL:84,DATA:85,pathSegments:86,SEP:87,$accept:0,$end:1},terminals_:{2:"error",5:"EOF",14:"COMMENT",15:"CONTENT",18:"END_RAW_BLOCK",19:"OPEN_RAW_BLOCK",23:"CLOSE_RAW_BLOCK",29:"OPEN_BLOCK",33:"CLOSE",34:"OPEN_INVERSE",39:"OPEN_INVERSE_CHAIN",44:"INVERSE",47:"OPEN_ENDBLOCK",48:"OPEN",51:"OPEN_UNESCAPED",54:"CLOSE_UNESCAPED",55:"OPEN_PARTIAL",60:"OPEN_PARTIAL_BLOCK",65:"OPEN_SEXPR",68:"CLOSE_SEXPR",72:"ID",73:"EQUALS",75:"OPEN_BLOCK_PARAMS",77:"CLOSE_BLOCK_PARAMS",80:"STRING",81:"NUMBER",82:"BOOLEAN",83:"UNDEFINED",84:"NULL",85:"DATA",87:"SEP"},productions_:[0,[3,2],[4,1],[7,1],[7,1],[7,1],[7,1],[7,1],[7,1],[7,1],[13,1],[10,3],[16,5],[9,4],[9,4],[24,6],[27,6],[38,6],[43,2],[45,3],[45,1],[26,3],[8,5],[8,5],[11,5],[12,3],[59,5],[63,1],[63,1],[64,5],[69,1],[71,3],[74,3],[20,1],[20,1],[20,1],[20,1],[20,1],[20,1],[20,1],[56,1],[56,1],[79,2],[78,1],[86,3],[86,1],[6,0],[6,2],[17,0],[17,2],[21,0],[21,2],[22,0],[22,1],[25,0],[25,1],[28,0],[28,1],[30,0],[30,2],[31,0],[31,1],[32,0],[32,1],[35,0],[35,2],[36,0],[36,1],[37,0],[37,1],[40,0],[40,2],[41,0],[41,1],[42,0],[42,1],[46,0],[46,1],[49,0],[49,2],[50,0],[50,1],[52,0],[52,2],[53,0],[53,1],[57,0],[57,2],[58,0],[58,1],[61,0],[61,2],[62,0],[62,1],[66,0],[66,2],[67,0],[67,1],[70,1],[70,2],[76,1],[76,2]],performAction:function(e,t,n,r,o,i,a){var s=i.length-1;switch(o){case 1:return i[s-1];case 2:this.$=r.prepareProgram(i[s]);break;case 3:case 4:case 5:case 6:case 7:case 8:case 20:case 27:case 28:case 33:case 34:case 40:case 41:this.$=i[s];break;case 9:this.$={type:"CommentStatement",value:r.stripComment(i[s]),strip:r.stripFlags(i[s],i[s]),loc:r.locInfo(this._$)};break;case 10:this.$={type:"ContentStatement",original:i[s],value:i[s],loc:r.locInfo(this._$)};break;case 11:this.$=r.prepareRawBlock(i[s-2],i[s-1],i[s],this._$);break;case 12:this.$={path:i[s-3],params:i[s-2],hash:i[s-1]};break;case 13:this.$=r.prepareBlock(i[s-3],i[s-2],i[s-1],i[s],!1,this._$);break;case 14:this.$=r.prepareBlock(i[s-3],i[s-2],i[s-1],i[s],!0,this._$);break;case 15:this.$={open:i[s-5],path:i[s-4],params:i[s-3],hash:i[s-2],blockParams:i[s-1],strip:r.stripFlags(i[s-5],i[s])};break;case 16:case 17:this.$={path:i[s-4],params:i[s-3],hash:i[s-2],blockParams:i[s-1],strip:r.stripFlags(i[s-5],i[s])};break;case 18:this.$={strip:r.stripFlags(i[s-1],i[s-1]),program:i[s]};break;case 19:var l=r.prepareBlock(i[s-2],i[s-1],i[s],i[s],!1,this._$),c=r.prepareProgram([l],i[s-1].loc);c.chained=!0,this.$={strip:i[s-2].strip,program:c,chain:!0};break;case 21:this.$={path:i[s-1],strip:r.stripFlags(i[s-2],i[s])};break;case 22:case 23:this.$=r.prepareMustache(i[s-3],i[s-2],i[s-1],i[s-4],r.stripFlags(i[s-4],i[s]),this._$);break;case 24:this.$={type:"PartialStatement",name:i[s-3],params:i[s-2],hash:i[s-1],indent:"",strip:r.stripFlags(i[s-4],i[s]),loc:r.locInfo(this._$)};break;case 25:this.$=r.preparePartialBlock(i[s-2],i[s-1],i[s],this._$);break;case 26:this.$={path:i[s-3],params:i[s-2],hash:i[s-1],strip:r.stripFlags(i[s-4],i[s])};break;case 29:this.$={type:"SubExpression",path:i[s-3],params:i[s-2],hash:i[s-1],loc:r.locInfo(this._$)};break;case 30:this.$={type:"Hash",pairs:i[s],loc:r.locInfo(this._$)};break;case 31:this.$={type:"HashPair",key:r.id(i[s-2]),value:i[s],loc:r.locInfo(this._$)};break;case 32:this.$=r.id(i[s-1]);break;case 35:this.$={type:"StringLiteral",value:i[s],original:i[s],loc:r.locInfo(this._$)};break;case 36:this.$={type:"NumberLiteral",value:Number(i[s]),original:Number(i[s]),loc:r.locInfo(this._$)};break;case 37:this.$={type:"BooleanLiteral",value:"true"===i[s],original:"true"===i[s],loc:r.locInfo(this._$)};break;case 38:this.$={type:"UndefinedLiteral",original:void 0,value:void 0,loc:r.locInfo(this._$)};break;case 39:this.$={type:"NullLiteral",original:null,value:null,loc:r.locInfo(this._$)};break;case 42:this.$=r.preparePath(!0,i[s],this._$);break;case 43:this.$=r.preparePath(!1,i[s],this._$);break;case 44:i[s-2].push({part:r.id(i[s]),original:i[s],separator:i[s-1]}),this.$=i[s-2];break;case 45:this.$=[{part:r.id(i[s]),original:i[s]}];break;case 46:case 48:case 50:case 58:case 64:case 70:case 78:case 82:case 86:case 90:case 94:this.$=[];break;case 47:case 49:case 51:case 59:case 65:case 71:case 79:case 83:case 87:case 91:case 95:case 99:case 101:i[s-1].push(i[s]);break;case 98:case 100:this.$=[i[s]]}},table:[{3:1,4:2,5:[2,46],6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{1:[3]},{5:[1,4]},{5:[2,2],7:5,8:6,9:7,10:8,11:9,12:10,13:11,14:[1,12],15:[1,20],16:17,19:[1,23],24:15,27:16,29:[1,21],34:[1,22],39:[2,2],44:[2,2],47:[2,2],48:[1,13],51:[1,14],55:[1,18],59:19,60:[1,24]},{1:[2,1]},{5:[2,47],14:[2,47],15:[2,47],19:[2,47],29:[2,47],34:[2,47],39:[2,47],44:[2,47],47:[2,47],48:[2,47],51:[2,47],55:[2,47],60:[2,47]},{5:[2,3],14:[2,3],15:[2,3],19:[2,3],29:[2,3],34:[2,3],39:[2,3],44:[2,3],47:[2,3],48:[2,3],51:[2,3],55:[2,3],60:[2,3]},{5:[2,4],14:[2,4],15:[2,4],19:[2,4],29:[2,4],34:[2,4],39:[2,4],44:[2,4],47:[2,4],48:[2,4],51:[2,4],55:[2,4],60:[2,4]},{5:[2,5],14:[2,5],15:[2,5],19:[2,5],29:[2,5],34:[2,5],39:[2,5],44:[2,5],47:[2,5],48:[2,5],51:[2,5],55:[2,5],60:[2,5]},{5:[2,6],14:[2,6],15:[2,6],19:[2,6],29:[2,6],34:[2,6],39:[2,6],44:[2,6],47:[2,6],48:[2,6],51:[2,6],55:[2,6],60:[2,6]},{5:[2,7],14:[2,7],15:[2,7],19:[2,7],29:[2,7],34:[2,7],39:[2,7],44:[2,7],47:[2,7],48:[2,7],51:[2,7],55:[2,7],60:[2,7]},{5:[2,8],14:[2,8],15:[2,8],19:[2,8],29:[2,8],34:[2,8],39:[2,8],44:[2,8],47:[2,8],48:[2,8],51:[2,8],55:[2,8],60:[2,8]},{5:[2,9],14:[2,9],15:[2,9],19:[2,9],29:[2,9],34:[2,9],39:[2,9],44:[2,9],47:[2,9],48:[2,9],51:[2,9],55:[2,9],60:[2,9]},{20:25,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:36,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{4:37,6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],39:[2,46],44:[2,46],47:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{4:38,6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],44:[2,46],47:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{15:[2,48],17:39,18:[2,48]},{20:41,56:40,64:42,65:[1,43],72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{4:44,6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],47:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{5:[2,10],14:[2,10],15:[2,10],18:[2,10],19:[2,10],29:[2,10],34:[2,10],39:[2,10],44:[2,10],47:[2,10],48:[2,10],51:[2,10],55:[2,10],60:[2,10]},{20:45,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:46,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:47,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:41,56:48,64:42,65:[1,43],72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{33:[2,78],49:49,65:[2,78],72:[2,78],80:[2,78],81:[2,78],82:[2,78],83:[2,78],84:[2,78],85:[2,78]},{23:[2,33],33:[2,33],54:[2,33],65:[2,33],68:[2,33],72:[2,33],75:[2,33],80:[2,33],81:[2,33],82:[2,33],83:[2,33],84:[2,33],85:[2,33]},{23:[2,34],33:[2,34],54:[2,34],65:[2,34],68:[2,34],72:[2,34],75:[2,34],80:[2,34],81:[2,34],82:[2,34],83:[2,34],84:[2,34],85:[2,34]},{23:[2,35],33:[2,35],54:[2,35],65:[2,35],68:[2,35],72:[2,35],75:[2,35],80:[2,35],81:[2,35],82:[2,35],83:[2,35],84:[2,35],85:[2,35]},{23:[2,36],33:[2,36],54:[2,36],65:[2,36],68:[2,36],72:[2,36],75:[2,36],80:[2,36],81:[2,36],82:[2,36],83:[2,36],84:[2,36],85:[2,36]},{23:[2,37],33:[2,37],54:[2,37],65:[2,37],68:[2,37],72:[2,37],75:[2,37],80:[2,37],81:[2,37],82:[2,37],83:[2,37],84:[2,37],85:[2,37]},{23:[2,38],33:[2,38],54:[2,38],65:[2,38],68:[2,38],72:[2,38],75:[2,38],80:[2,38],81:[2,38],82:[2,38],83:[2,38],84:[2,38],85:[2,38]},{23:[2,39],33:[2,39],54:[2,39],65:[2,39],68:[2,39],72:[2,39],75:[2,39],80:[2,39],81:[2,39],82:[2,39],83:[2,39],84:[2,39],85:[2,39]},{23:[2,43],33:[2,43],54:[2,43],65:[2,43],68:[2,43],72:[2,43],75:[2,43],80:[2,43],81:[2,43],82:[2,43],83:[2,43],84:[2,43],85:[2,43],87:[1,50]},{72:[1,35],86:51},{23:[2,45],33:[2,45],54:[2,45],65:[2,45],68:[2,45],72:[2,45],75:[2,45],80:[2,45],81:[2,45],82:[2,45],83:[2,45],84:[2,45],85:[2,45],87:[2,45]},{52:52,54:[2,82],65:[2,82],72:[2,82],80:[2,82],81:[2,82],82:[2,82],83:[2,82],84:[2,82],85:[2,82]},{25:53,38:55,39:[1,57],43:56,44:[1,58],45:54,47:[2,54]},{28:59,43:60,44:[1,58],47:[2,56]},{13:62,15:[1,20],18:[1,61]},{33:[2,86],57:63,65:[2,86],72:[2,86],80:[2,86],81:[2,86],82:[2,86],83:[2,86],84:[2,86],85:[2,86]},{33:[2,40],65:[2,40],72:[2,40],80:[2,40],81:[2,40],82:[2,40],83:[2,40],84:[2,40],85:[2,40]},{33:[2,41],65:[2,41],72:[2,41],80:[2,41],81:[2,41],82:[2,41],83:[2,41],84:[2,41],85:[2,41]},{20:64,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{26:65,47:[1,66]},{30:67,33:[2,58],65:[2,58],72:[2,58],75:[2,58],80:[2,58],81:[2,58],82:[2,58],83:[2,58],84:[2,58],85:[2,58]},{33:[2,64],35:68,65:[2,64],72:[2,64],75:[2,64],80:[2,64],81:[2,64],82:[2,64],83:[2,64],84:[2,64],85:[2,64]},{21:69,23:[2,50],65:[2,50],72:[2,50],80:[2,50],81:[2,50],82:[2,50],83:[2,50],84:[2,50],85:[2,50]},{33:[2,90],61:70,65:[2,90],72:[2,90],80:[2,90],81:[2,90],82:[2,90],83:[2,90],84:[2,90],85:[2,90]},{20:74,33:[2,80],50:71,63:72,64:75,65:[1,43],69:73,70:76,71:77,72:[1,78],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{72:[1,79]},{23:[2,42],33:[2,42],54:[2,42],65:[2,42],68:[2,42],72:[2,42],75:[2,42],80:[2,42],81:[2,42],82:[2,42],83:[2,42],84:[2,42],85:[2,42],87:[1,50]},{20:74,53:80,54:[2,84],63:81,64:75,65:[1,43],69:82,70:76,71:77,72:[1,78],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{26:83,47:[1,66]},{47:[2,55]},{4:84,6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],39:[2,46],44:[2,46],47:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{47:[2,20]},{20:85,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{4:86,6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],47:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{26:87,47:[1,66]},{47:[2,57]},{5:[2,11],14:[2,11],15:[2,11],19:[2,11],29:[2,11],34:[2,11],39:[2,11],44:[2,11],47:[2,11],48:[2,11],51:[2,11],55:[2,11],60:[2,11]},{15:[2,49],18:[2,49]},{20:74,33:[2,88],58:88,63:89,64:75,65:[1,43],69:90,70:76,71:77,72:[1,78],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{65:[2,94],66:91,68:[2,94],72:[2,94],80:[2,94],81:[2,94],82:[2,94],83:[2,94],84:[2,94],85:[2,94]},{5:[2,25],14:[2,25],15:[2,25],19:[2,25],29:[2,25],34:[2,25],39:[2,25],44:[2,25],47:[2,25],48:[2,25],51:[2,25],55:[2,25],60:[2,25]},{20:92,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:74,31:93,33:[2,60],63:94,64:75,65:[1,43],69:95,70:76,71:77,72:[1,78],75:[2,60],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:74,33:[2,66],36:96,63:97,64:75,65:[1,43],69:98,70:76,71:77,72:[1,78],75:[2,66],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:74,22:99,23:[2,52],63:100,64:75,65:[1,43],69:101,70:76,71:77,72:[1,78],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:74,33:[2,92],62:102,63:103,64:75,65:[1,43],69:104,70:76,71:77,72:[1,78],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{33:[1,105]},{33:[2,79],65:[2,79],72:[2,79],80:[2,79],81:[2,79],82:[2,79],83:[2,79],84:[2,79],85:[2,79]},{33:[2,81]},{23:[2,27],33:[2,27],54:[2,27],65:[2,27],68:[2,27],72:[2,27],75:[2,27],80:[2,27],81:[2,27],82:[2,27],83:[2,27],84:[2,27],85:[2,27]},{23:[2,28],33:[2,28],54:[2,28],65:[2,28],68:[2,28],72:[2,28],75:[2,28],80:[2,28],81:[2,28],82:[2,28],83:[2,28],84:[2,28],85:[2,28]},{23:[2,30],33:[2,30],54:[2,30],68:[2,30],71:106,72:[1,107],75:[2,30]},{23:[2,98],33:[2,98],54:[2,98],68:[2,98],72:[2,98],75:[2,98]},{23:[2,45],33:[2,45],54:[2,45],65:[2,45],68:[2,45],72:[2,45],73:[1,108],75:[2,45],80:[2,45],81:[2,45],82:[2,45],83:[2,45],84:[2,45],85:[2,45],87:[2,45]},{23:[2,44],33:[2,44],54:[2,44],65:[2,44],68:[2,44],72:[2,44],75:[2,44],80:[2,44],81:[2,44],82:[2,44],83:[2,44],84:[2,44],85:[2,44],87:[2,44]},{54:[1,109]},{54:[2,83],65:[2,83],72:[2,83],80:[2,83],81:[2,83],82:[2,83],83:[2,83],84:[2,83],85:[2,83]},{54:[2,85]},{5:[2,13],14:[2,13],15:[2,13],19:[2,13],29:[2,13],34:[2,13],39:[2,13],44:[2,13],47:[2,13],48:[2,13],51:[2,13],55:[2,13],60:[2,13]},{38:55,39:[1,57],43:56,44:[1,58],45:111,46:110,47:[2,76]},{33:[2,70],40:112,65:[2,70],72:[2,70],75:[2,70],80:[2,70],81:[2,70],82:[2,70],83:[2,70],84:[2,70],85:[2,70]},{47:[2,18]},{5:[2,14],14:[2,14],15:[2,14],19:[2,14],29:[2,14],34:[2,14],39:[2,14],44:[2,14],47:[2,14],48:[2,14],51:[2,14],55:[2,14],60:[2,14]},{33:[1,113]},{33:[2,87],65:[2,87],72:[2,87],80:[2,87],81:[2,87],82:[2,87],83:[2,87],84:[2,87],85:[2,87]},{33:[2,89]},{20:74,63:115,64:75,65:[1,43],67:114,68:[2,96],69:116,70:76,71:77,72:[1,78],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{33:[1,117]},{32:118,33:[2,62],74:119,75:[1,120]},{33:[2,59],65:[2,59],72:[2,59],75:[2,59],80:[2,59],81:[2,59],82:[2,59],83:[2,59],84:[2,59],85:[2,59]},{33:[2,61],75:[2,61]},{33:[2,68],37:121,74:122,75:[1,120]},{33:[2,65],65:[2,65],72:[2,65],75:[2,65],80:[2,65],81:[2,65],82:[2,65],83:[2,65],84:[2,65],85:[2,65]},{33:[2,67],75:[2,67]},{23:[1,123]},{23:[2,51],65:[2,51],72:[2,51],80:[2,51],81:[2,51],82:[2,51],83:[2,51],84:[2,51],85:[2,51]},{23:[2,53]},{33:[1,124]},{33:[2,91],65:[2,91],72:[2,91],80:[2,91],81:[2,91],82:[2,91],83:[2,91],84:[2,91],85:[2,91]},{33:[2,93]},{5:[2,22],14:[2,22],15:[2,22],19:[2,22],29:[2,22],34:[2,22],39:[2,22],44:[2,22],47:[2,22],48:[2,22],51:[2,22],55:[2,22],60:[2,22]},{23:[2,99],33:[2,99],54:[2,99],68:[2,99],72:[2,99],75:[2,99]},{73:[1,108]},{20:74,63:125,64:75,65:[1,43],72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{5:[2,23],14:[2,23],15:[2,23],19:[2,23],29:[2,23],34:[2,23],39:[2,23],44:[2,23],47:[2,23],48:[2,23],51:[2,23],55:[2,23],60:[2,23]},{47:[2,19]},{47:[2,77]},{20:74,33:[2,72],41:126,63:127,64:75,65:[1,43],69:128,70:76,71:77,72:[1,78],75:[2,72],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{5:[2,24],14:[2,24],15:[2,24],19:[2,24],29:[2,24],34:[2,24],39:[2,24],44:[2,24],47:[2,24],48:[2,24],51:[2,24],55:[2,24],60:[2,24]},{68:[1,129]},{65:[2,95],68:[2,95],72:[2,95],80:[2,95],81:[2,95],82:[2,95],83:[2,95],84:[2,95],85:[2,95]},{68:[2,97]},{5:[2,21],14:[2,21],15:[2,21],19:[2,21],29:[2,21],34:[2,21],39:[2,21],44:[2,21],47:[2,21],48:[2,21],51:[2,21],55:[2,21],60:[2,21]},{33:[1,130]},{33:[2,63]},{72:[1,132],76:131},{33:[1,133]},{33:[2,69]},{15:[2,12],18:[2,12]},{14:[2,26],15:[2,26],19:[2,26],29:[2,26],34:[2,26],47:[2,26],48:[2,26],51:[2,26],55:[2,26],60:[2,26]},{23:[2,31],33:[2,31],54:[2,31],68:[2,31],72:[2,31],75:[2,31]},{33:[2,74],42:134,74:135,75:[1,120]},{33:[2,71],65:[2,71],72:[2,71],75:[2,71],80:[2,71],81:[2,71],82:[2,71],83:[2,71],84:[2,71],85:[2,71]},{33:[2,73],75:[2,73]},{23:[2,29],33:[2,29],54:[2,29],65:[2,29],68:[2,29],72:[2,29],75:[2,29],80:[2,29],81:[2,29],82:[2,29],83:[2,29],84:[2,29],85:[2,29]},{14:[2,15],15:[2,15],19:[2,15],29:[2,15],34:[2,15],39:[2,15],44:[2,15],47:[2,15],48:[2,15],51:[2,15],55:[2,15],60:[2,15]},{72:[1,137],77:[1,136]},{72:[2,100],77:[2,100]},{14:[2,16],15:[2,16],19:[2,16],29:[2,16],34:[2,16],44:[2,16],47:[2,16],48:[2,16],51:[2,16],55:[2,16],60:[2,16]},{33:[1,138]},{33:[2,75]},{33:[2,32]},{72:[2,101],77:[2,101]},{14:[2,17],15:[2,17],19:[2,17],29:[2,17],34:[2,17],39:[2,17],44:[2,17],47:[2,17],48:[2,17],51:[2,17],55:[2,17],60:[2,17]}],defaultActions:{4:[2,1],54:[2,55],56:[2,20],60:[2,57],73:[2,81],82:[2,85],86:[2,18],90:[2,89],101:[2,53],104:[2,93],110:[2,19],111:[2,77],116:[2,97],119:[2,63],122:[2,69],135:[2,75],136:[2,32]},parseError:function(e,t){throw new Error(e)},parse:function(e){var t=this,n=[0],r=[null],o=[],i=this.table,a="",s=0,l=0,c=0;this.lexer.setInput(e),this.lexer.yy=this.yy,this.yy.lexer=this.lexer,this.yy.parser=this,void 0===this.lexer.yylloc&&(this.lexer.yylloc={});var u=this.lexer.yylloc;o.push(u);var p=this.lexer.options&&this.lexer.options.ranges;function d(){var e;return"number"!=typeof(e=t.lexer.lex()||1)&&(e=t.symbols_[e]||e),e}"function"==typeof this.yy.parseError&&(this.parseError=this.yy.parseError);for(var h,f,m,g,v,y,b,S,x,w={};;){if(m=n[n.length-1],this.defaultActions[m]?g=this.defaultActions[m]:(null==h&&(h=d()),g=i[m]&&i[m][h]),void 0===g||!g.length||!g[0]){var C="";if(!c){for(y in x=[],i[m])this.terminals_[y]&&y>2&&x.push("'"+this.terminals_[y]+"'");C=this.lexer.showPosition?"Parse error on line "+(s+1)+":\n"+this.lexer.showPosition()+"\nExpecting "+x.join(", ")+", got '"+(this.terminals_[h]||h)+"'":"Parse error on line "+(s+1)+": Unexpected "+(1==h?"end of input":"'"+(this.terminals_[h]||h)+"'"),this.parseError(C,{text:this.lexer.match,token:this.terminals_[h]||h,line:this.lexer.yylineno,loc:u,expected:x})}}if(g[0]instanceof Array&&g.length>1)throw new Error("Parse Error: multiple actions possible at state: "+m+", token: "+h);switch(g[0]){case 1:n.push(h),r.push(this.lexer.yytext),o.push(this.lexer.yylloc),n.push(g[1]),h=null,f?(h=f,f=null):(l=this.lexer.yyleng,a=this.lexer.yytext,s=this.lexer.yylineno,u=this.lexer.yylloc,c>0&&c--);break;case 2:if(b=this.productions_[g[1]][1],w.$=r[r.length-b],w._$={first_line:o[o.length-(b||1)].first_line,last_line:o[o.length-1].last_line,first_column:o[o.length-(b||1)].first_column,last_column:o[o.length-1].last_column},p&&(w._$.range=[o[o.length-(b||1)].range[0],o[o.length-1].range[1]]),void 0!==(v=this.performAction.call(w,a,l,s,this.yy,g[1],r,o)))return v;b&&(n=n.slice(0,-1*b*2),r=r.slice(0,-1*b),o=o.slice(0,-1*b)),n.push(this.productions_[g[1]][0]),r.push(w.$),o.push(w._$),S=i[n[n.length-2]][n[n.length-1]],n.push(S);break;case 3:return!0}}return!0}},t=function(){var e={EOF:1,parseError:function(e,t){if(!this.yy.parser)throw new Error(e);this.yy.parser.parseError(e,t)},setInput:function(e){return this._input=e,this._more=this._less=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this.options.ranges&&(this.yylloc.range=[0,0]),this.offset=0,this},input:function(){var e=this._input[0];return this.yytext+=e,this.yyleng++,this.offset++,this.match+=e,this.matched+=e,e.match(/(?:\r\n?|\n).*/g)?(this.yylineno++,this.yylloc.last_line++):this.yylloc.last_column++,this.options.ranges&&this.yylloc.range[1]++,this._input=this._input.slice(1),e},unput:function(e){var t=e.length,n=e.split(/(?:\r\n?|\n)/g);this._input=e+this._input,this.yytext=this.yytext.substr(0,this.yytext.length-t-1),this.offset-=t;var r=this.match.split(/(?:\r\n?|\n)/g);this.match=this.match.substr(0,this.match.length-1),this.matched=this.matched.substr(0,this.matched.length-1),n.length-1&&(this.yylineno-=n.length-1);var o=this.yylloc.range;return this.yylloc={first_line:this.yylloc.first_line,last_line:this.yylineno+1,first_column:this.yylloc.first_column,last_column:n?(n.length===r.length?this.yylloc.first_column:0)+r[r.length-n.length].length-n[0].length:this.yylloc.first_column-t},this.options.ranges&&(this.yylloc.range=[o[0],o[0]+this.yyleng-t]),this},more:function(){return this._more=!0,this},less:function(e){this.unput(this.match.slice(e))},pastInput:function(){var e=this.matched.substr(0,this.matched.length-this.match.length);return(e.length>20?"...":"")+e.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var e=this.match;return e.length<20&&(e+=this._input.substr(0,20-e.length)),(e.substr(0,20)+(e.length>20?"...":"")).replace(/\n/g,"")},showPosition:function(){var e=this.pastInput(),t=new Array(e.length+1).join("-");return e+this.upcomingInput()+"\n"+t+"^"},next:function(){if(this.done)return this.EOF;var e,t,n,r,o;this._input||(this.done=!0),this._more||(this.yytext="",this.match="");for(var i=this._currentRules(),a=0;a<i.length&&(!(n=this._input.match(this.rules[i[a]]))||t&&!(n[0].length>t[0].length)||(t=n,r=a,this.options.flex));a++);return t?((o=t[0].match(/(?:\r\n?|\n).*/g))&&(this.yylineno+=o.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:o?o[o.length-1].length-o[o.length-1].match(/\r?\n?/)[0].length:this.yylloc.last_column+t[0].length},this.yytext+=t[0],this.match+=t[0],this.matches=t,this.yyleng=this.yytext.length,this.options.ranges&&(this.yylloc.range=[this.offset,this.offset+=this.yyleng]),this._more=!1,this._input=this._input.slice(t[0].length),this.matched+=t[0],e=this.performAction.call(this,this.yy,this,i[r],this.conditionStack[this.conditionStack.length-1]),this.done&&this._input&&(this.done=!1),e||void 0):""===this._input?this.EOF:this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var e=this.next();return void 0!==e?e:this.lex()},begin:function(e){this.conditionStack.push(e)},popState:function(){return this.conditionStack.pop()},_currentRules:function(){return this.conditions[this.conditionStack[this.conditionStack.length-1]].rules},topState:function(){return this.conditionStack[this.conditionStack.length-2]},pushState:function(e){this.begin(e)},options:{},performAction:function(e,t,n,r){function o(e,n){return t.yytext=t.yytext.substring(e,t.yyleng-n+e)}switch(n){case 0:if("\\\\"===t.yytext.slice(-2)?(o(0,1),this.begin("mu")):"\\"===t.yytext.slice(-1)?(o(0,1),this.begin("emu")):this.begin("mu"),t.yytext)return 15;break;case 1:case 5:return 15;case 2:return this.popState(),15;case 3:return this.begin("raw"),15;case 4:return this.popState(),"raw"===this.conditionStack[this.conditionStack.length-1]?15:(o(5,9),"END_RAW_BLOCK");case 6:case 22:return this.popState(),14;case 7:return 65;case 8:return 68;case 9:return 19;case 10:return this.popState(),this.begin("raw"),23;case 11:return 55;case 12:return 60;case 13:return 29;case 14:return 47;case 15:case 16:return this.popState(),44;case 17:return 34;case 18:return 39;case 19:return 51;case 20:case 23:return 48;case 21:this.unput(t.yytext),this.popState(),this.begin("com");break;case 24:return 73;case 25:case 26:case 41:return 72;case 27:return 87;case 28:break;case 29:return this.popState(),54;case 30:return this.popState(),33;case 31:return t.yytext=o(1,2).replace(/\\"/g,'"'),80;case 32:return t.yytext=o(1,2).replace(/\\'/g,"'"),80;case 33:return 85;case 34:case 35:return 82;case 36:return 83;case 37:return 84;case 38:return 81;case 39:return 75;case 40:return 77;case 42:return t.yytext=t.yytext.replace(/\\([\\\]])/g,"$1"),72;case 43:return"INVALID";case 44:return 5}},rules:[/^(?:[^\x00]*?(?=(\{\{)))/,/^(?:[^\x00]+)/,/^(?:[^\x00]{2,}?(?=(\{\{|\\\{\{|\\\\\{\{|$)))/,/^(?:\{\{\{\{(?=[^/]))/,/^(?:\{\{\{\{\/[^\s!"#%-,\.\/;->@\[-\^`\{-~]+(?=[=}\s\/.])\}\}\}\})/,/^(?:[^\x00]+?(?=(\{\{\{\{)))/,/^(?:[\s\S]*?--(~)?\}\})/,/^(?:\()/,/^(?:\))/,/^(?:\{\{\{\{)/,/^(?:\}\}\}\})/,/^(?:\{\{(~)?>)/,/^(?:\{\{(~)?#>)/,/^(?:\{\{(~)?#\*?)/,/^(?:\{\{(~)?\/)/,/^(?:\{\{(~)?\^\s*(~)?\}\})/,/^(?:\{\{(~)?\s*else\s*(~)?\}\})/,/^(?:\{\{(~)?\^)/,/^(?:\{\{(~)?\s*else\b)/,/^(?:\{\{(~)?\{)/,/^(?:\{\{(~)?&)/,/^(?:\{\{(~)?!--)/,/^(?:\{\{(~)?![\s\S]*?\}\})/,/^(?:\{\{(~)?\*?)/,/^(?:=)/,/^(?:\.\.)/,/^(?:\.(?=([=~}\s\/.)|])))/,/^(?:[\/.])/,/^(?:\s+)/,/^(?:\}(~)?\}\})/,/^(?:(~)?\}\})/,/^(?:"(\\["]|[^"])*")/,/^(?:'(\\[']|[^'])*')/,/^(?:@)/,/^(?:true(?=([~}\s)])))/,/^(?:false(?=([~}\s)])))/,/^(?:undefined(?=([~}\s)])))/,/^(?:null(?=([~}\s)])))/,/^(?:-?[0-9]+(?:\.[0-9]+)?(?=([~}\s)])))/,/^(?:as\s+\|)/,/^(?:\|)/,/^(?:([^\s!"#%-,\.\/;->@\[-\^`\{-~]+(?=([=~}\s\/.)|]))))/,/^(?:\[(\\\]|[^\]])*\])/,/^(?:.)/,/^(?:$)/],conditions:{mu:{rules:[7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44],inclusive:!1},emu:{rules:[2],inclusive:!1},com:{rules:[6],inclusive:!1},raw:{rules:[3,4,5],inclusive:!1},INITIAL:{rules:[0,1,44],inclusive:!0}}};return e}();function n(){this.yy={}}return e.lexer=t,n.prototype=e,e.Parser=n,new n}();t.default=n,e.exports=t.default},261:(e,t,n)=>{function r(e){return e&&e.__esModule?e:{default:e}}function o(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}t.__esModule=!0;var i=o(n(871)),a=r(n(613)),s=r(n(769)),l=o(n(849)),c=o(n(624)),u=r(n(148));function p(){var e=new i.HandlebarsEnvironment;return l.extend(e,i),e.SafeString=a.default,e.Exception=s.default,e.Utils=l,e.escapeExpression=l.escapeExpression,e.VM=c,e.template=function(t){return c.template(t,e)},e}var d=p();d.create=p,u.default(d),d.default=d,t.default=d,e.exports=t.default},277:(e,t,n)=>{function r(e){return e&&e.__esModule?e:{default:e}}t.__esModule=!0,t.registerDefaultHelpers=function(e){o.default(e),i.default(e),a.default(e),s.default(e),l.default(e),c.default(e),u.default(e)},t.moveHelperToHooks=function(e,t,n){e.helpers[t]&&(e.hooks[t]=e.helpers[t],n||delete e.helpers[t])};var o=r(n(97)),i=r(n(785)),a=r(n(353)),s=r(n(355)),l=r(n(300)),c=r(n(466)),u=r(n(908))},300:(e,t)=>{t.__esModule=!0,t.default=function(e){e.registerHelper("log",function(){for(var t=[void 0],n=arguments[arguments.length-1],r=0;r<arguments.length-1;r++)t.push(arguments[r]);var o=1;null!=n.hash.level?o=n.hash.level:n.data&&null!=n.data.level&&(o=n.data.level),t[0]=o,e.log.apply(e,t)})},e.exports=t.default},350:(e,t,n)=>{t.__esModule=!0;var r,o=n(769),i=(r=o)&&r.__esModule?r:{default:r};function a(){this.parents=[]}function s(e){this.acceptRequired(e,"path"),this.acceptArray(e.params),this.acceptKey(e,"hash")}function l(e){s.call(this,e),this.acceptKey(e,"program"),this.acceptKey(e,"inverse")}function c(e){this.acceptRequired(e,"name"),this.acceptArray(e.params),this.acceptKey(e,"hash")}a.prototype={constructor:a,mutating:!1,acceptKey:function(e,t){var n=this.accept(e[t]);if(this.mutating){if(n&&!a.prototype[n.type])throw new i.default('Unexpected node type "'+n.type+'" found when accepting '+t+" on "+e.type);e[t]=n}},acceptRequired:function(e,t){if(this.acceptKey(e,t),!e[t])throw new i.default(e.type+" requires "+t)},acceptArray:function(e){for(var t=0,n=e.length;t<n;t++)this.acceptKey(e,t),e[t]||(e.splice(t,1),t--,n--)},accept:function(e){if(e){if(!this[e.type])throw new i.default("Unknown type: "+e.type,e);this.current&&this.parents.unshift(this.current),this.current=e;var t=this[e.type](e);return this.current=this.parents.shift(),!this.mutating||t?t:!1!==t?e:void 0}},Program:function(e){this.acceptArray(e.body)},MustacheStatement:s,Decorator:s,BlockStatement:l,DecoratorBlock:l,PartialStatement:c,PartialBlockStatement:function(e){c.call(this,e),this.acceptKey(e,"program")},ContentStatement:function(){},CommentStatement:function(){},SubExpression:s,PathExpression:function(){},StringLiteral:function(){},NumberLiteral:function(){},BooleanLiteral:function(){},UndefinedLiteral:function(){},NullLiteral:function(){},Hash:function(e){this.acceptArray(e.pairs)},HashPair:function(e){this.acceptRequired(e,"value")}},t.default=a,e.exports=t.default},353:(e,t,n)=>{t.__esModule=!0;var r,o=n(769),i=(r=o)&&r.__esModule?r:{default:r};t.default=function(e){e.registerHelper("helperMissing",function(){if(1!==arguments.length)throw new i.default('Missing helper: "'+arguments[arguments.length-1].name+'"')})},e.exports=t.default},355:(e,t,n)=>{t.__esModule=!0;var r,o=n(849),i=n(769),a=(r=i)&&r.__esModule?r:{default:r};t.default=function(e){e.registerHelper("if",function(e,t){if(2!=arguments.length)throw new a.default("#if requires exactly one argument");return o.isFunction(e)&&(e=e.call(this)),!t.hash.includeZero&&!e||o.isEmpty(e)?t.inverse(this):t.fn(this)}),e.registerHelper("unless",function(t,n){if(2!=arguments.length)throw new a.default("#unless requires exactly one argument");return e.helpers.if.call(this,t,{fn:n.inverse,inverse:n.fn,hash:n.hash})})},e.exports=t.default},425:(e,t,n)=>{t.__esModule=!0,t.SourceLocation=function(e,t){this.source=e,this.start={line:t.first_line,column:t.first_column},this.end={line:t.last_line,column:t.last_column}},t.id=function(e){return/^\[.*\]$/.test(e)?e.substring(1,e.length-1):e},t.stripFlags=function(e,t){return{open:"~"===e.charAt(2),close:"~"===t.charAt(t.length-3)}},t.stripComment=function(e){return e.replace(/^\{\{~?!-?-?/,"").replace(/-?-?~?\}\}$/,"")},t.preparePath=function(e,t,n){n=this.locInfo(n);for(var r=e?"@":"",o=[],a=0,s=0,l=t.length;s<l;s++){var c=t[s].part,u=t[s].original!==c;if(r+=(t[s].separator||"")+c,u||".."!==c&&"."!==c&&"this"!==c)o.push(c);else{if(o.length>0)throw new i.default("Invalid path: "+r,{loc:n});".."===c&&a++}}return{type:"PathExpression",data:e,depth:a,parts:o,original:r,loc:n}},t.prepareMustache=function(e,t,n,r,o,i){var a=r.charAt(3)||r.charAt(2),s="{"!==a&&"&"!==a;return{type:/\*/.test(r)?"Decorator":"MustacheStatement",path:e,params:t,hash:n,escaped:s,strip:o,loc:this.locInfo(i)}},t.prepareRawBlock=function(e,t,n,r){a(e,n),r=this.locInfo(r);var o={type:"Program",body:t,strip:{},loc:r};return{type:"BlockStatement",path:e.path,params:e.params,hash:e.hash,program:o,openStrip:{},inverseStrip:{},closeStrip:{},loc:r}},t.prepareBlock=function(e,t,n,r,o,s){r&&r.path&&a(e,r);var l=/\*/.test(e.open);t.blockParams=e.blockParams;var c=void 0,u=void 0;if(n){if(l)throw new i.default("Unexpected inverse block on decorator",n);n.chain&&(n.program.body[0].closeStrip=r.strip),u=n.strip,c=n.program}o&&(o=c,c=t,t=o);return{type:l?"DecoratorBlock":"BlockStatement",path:e.path,params:e.params,hash:e.hash,program:t,inverse:c,openStrip:e.strip,inverseStrip:u,closeStrip:r&&r.strip,loc:this.locInfo(s)}},t.prepareProgram=function(e,t){if(!t&&e.length){var n=e[0].loc,r=e[e.length-1].loc;n&&r&&(t={source:n.source,start:{line:n.start.line,column:n.start.column},end:{line:r.end.line,column:r.end.column}})}return{type:"Program",body:e,strip:{},loc:t}},t.preparePartialBlock=function(e,t,n,r){return a(e,n),{type:"PartialBlockStatement",name:e.path,params:e.params,hash:e.hash,program:t,openStrip:e.strip,closeStrip:n&&n.strip,loc:this.locInfo(r)}};var r,o=n(769),i=(r=o)&&r.__esModule?r:{default:r};function a(e,t){if(t=t.path?t.path.original:t,e.path.original!==t){var n={loc:e.path.loc};throw new i.default(e.path.original+" doesn't match "+t,n)}}},430:(e,t,n)=>{t.__esModule=!0;var r=n(849);t.default=function(e){e.registerDecorator("inline",function(e,t,n,o){var i=e;return t.partials||(t.partials={},i=function(o,i){var a=n.partials;n.partials=r.extend({},a,t.partials);var s=e(o,i);return n.partials=a,s}),t.partials[o.args[0]]=o.fn,i})},e.exports=t.default},466:(e,t)=>{t.__esModule=!0,t.default=function(e){e.registerHelper("lookup",function(e,t,n){return e?n.lookupProperty(e,t):e})},e.exports=t.default},566:(e,t,n)=>{t.__esModule=!0;var r=n(849),o={methodMap:["debug","info","warn","error"],level:"info",lookupLevel:function(e){if("string"==typeof e){var t=r.indexOf(o.methodMap,e.toLowerCase());e=t>=0?t:parseInt(e,10)}return e},log:function(e){if(e=o.lookupLevel(e),"undefined"!=typeof console&&o.lookupLevel(o.level)<=e){var t=o.methodMap[e];console[t]||(t="log");for(var n=arguments.length,r=Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];console[t].apply(console,r)}}};t.default=o,e.exports=t.default},613:(e,t)=>{function n(e){this.string=e}t.__esModule=!0,n.prototype.toString=n.prototype.toHTML=function(){return""+this.string},t.default=n,e.exports=t.default},614:(e,t)=>{t.__esModule=!0,t.wrapHelper=function(e,t){if("function"!=typeof e)return e;return function(){return arguments[arguments.length-1]=t(arguments[arguments.length-1]),e.apply(this,arguments)}}},624:(e,t,n)=>{t.__esModule=!0,t.checkRevision=function(e){var t=e&&e[0]||1,n=s.COMPILER_REVISION;if(t>=s.LAST_COMPATIBLE_COMPILER_REVISION&&t<=s.COMPILER_REVISION)return;if(t<s.LAST_COMPATIBLE_COMPILER_REVISION){var r=s.REVISION_CHANGES[n],o=s.REVISION_CHANGES[t];throw new a.default("Template was precompiled with an older version of Handlebars than the current runtime. Please update your precompiler to a newer version ("+r+") or downgrade your runtime to an older version ("+o+").")}throw new a.default("Template was precompiled with a newer version of Handlebars than the current runtime. Please update your runtime to a newer version ("+e[1]+").")},t.template=function(e,t){if(!t)throw new a.default("No environment passed to template");if(!e||!e.main)throw new a.default("Unknown template object: "+typeof e);e.main.decorator=e.main_d,t.VM.checkRevision(e.compiler);var n=e.compiler&&7===e.compiler[0];var r={strict:function(e,t,n){if(!e||!(t in e))throw new a.default('"'+t+'" not defined in '+e,{loc:n});return r.lookupProperty(e,t)},lookupProperty:function(e,t){var n=e[t];return null==n||Object.prototype.hasOwnProperty.call(e,t)||u.resultIsAllowed(n,r.protoAccessControl,t)?n:void 0},lookup:function(e,t){for(var n=e.length,o=0;o<n;o++){if(null!=(e[o]&&r.lookupProperty(e[o],t)))return e[o][t]}},lambda:function(e,t){return"function"==typeof e?e.call(t):e},escapeExpression:o.escapeExpression,invokePartial:function(n,r,i){i.hash&&(r=o.extend({},r,i.hash),i.ids&&(i.ids[0]=!0)),n=t.VM.resolvePartial.call(this,n,r,i);var s=o.extend({},i,{hooks:this.hooks,protoAccessControl:this.protoAccessControl}),l=t.VM.invokePartial.call(this,n,r,s);if(null==l&&t.compile&&(i.partials[i.name]=t.compile(n,e.compilerOptions,t),l=i.partials[i.name](r,s)),null!=l){if(i.indent){for(var c=l.split("\n"),u=0,p=c.length;u<p&&(c[u]||u+1!==p);u++)c[u]=i.indent+c[u];l=c.join("\n")}return l}throw new a.default("The partial "+i.name+" could not be compiled when running in runtime-only mode")},fn:function(t){var n=e[t];return n.decorator=e[t+"_d"],n},programs:[],program:function(e,t,n,r,o){var i=this.programs[e],a=this.fn(e);return t||o||r||n?i=p(this,e,a,t,n,r,o):i||(i=this.programs[e]=p(this,e,a)),i},data:function(e,t){for(;e&&t--;)e=e._parent;return e},mergeIfNeeded:function(e,t){var n=e||t;return e&&t&&e!==t&&(n=o.extend({},t,e)),n},nullContext:Object.seal({}),noop:t.VM.noop,compilerInfo:e.compiler};function i(t){var n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],o=n.data;i._setup(n),!n.partial&&e.useData&&(o=function(e,t){t&&"root"in t||((t=t?s.createFrame(t):{}).root=e);return t}(t,o));var a=void 0,l=e.useBlockParams?[]:void 0;function c(t){return""+e.main(r,t,r.helpers,r.partials,o,l,a)}return e.useDepths&&(a=n.depths?t!=n.depths[0]?[t].concat(n.depths):n.depths:[t]),(c=h(e.main,c,r,n.depths||[],o,l))(t,n)}return i.isTop=!0,i._setup=function(i){if(i.partial)r.protoAccessControl=i.protoAccessControl,r.helpers=i.helpers,r.partials=i.partials,r.decorators=i.decorators,r.hooks=i.hooks;else{var a=o.extend({},t.helpers,i.helpers);!function(e,t){Object.keys(e).forEach(function(n){var r=e[n];e[n]=function(e,t){var n=t.lookupProperty;return c.wrapHelper(e,function(e){return o.extend({lookupProperty:n},e)})}(r,t)})}(a,r),r.helpers=a,e.usePartial&&(r.partials=r.mergeIfNeeded(i.partials,t.partials)),(e.usePartial||e.useDecorators)&&(r.decorators=o.extend({},t.decorators,i.decorators)),r.hooks={},r.protoAccessControl=u.createProtoAccessControl(i);var s=i.allowCallsToHelperMissing||n;l.moveHelperToHooks(r,"helperMissing",s),l.moveHelperToHooks(r,"blockHelperMissing",s)}},i._child=function(t,n,o,i){if(e.useBlockParams&&!o)throw new a.default("must pass block params");if(e.useDepths&&!i)throw new a.default("must pass parent depths");return p(r,t,e[t],n,0,o,i)},i},t.wrapProgram=p,t.resolvePartial=function(e,t,n){e?e.call||n.name||(n.name=e,e=n.partials[e]):e="@partial-block"===n.name?n.data["partial-block"]:n.partials[n.name];return e},t.invokePartial=function(e,t,n){var r=n.data&&n.data["partial-block"];n.partial=!0,n.ids&&(n.data.contextPath=n.ids[0]||n.data.contextPath);var i=void 0;n.fn&&n.fn!==d&&function(){n.data=s.createFrame(n.data);var e=n.fn;i=n.data["partial-block"]=function(t){var n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return n.data=s.createFrame(n.data),n.data["partial-block"]=r,e(t,n)},e.partials&&(n.partials=o.extend({},n.partials,e.partials))}();void 0===e&&i&&(e=i);if(void 0===e)throw new a.default("The partial "+n.name+" could not be found");if(e instanceof Function)return e(t,n)},t.noop=d;var r,o=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(n(849)),i=n(769),a=(r=i)&&r.__esModule?r:{default:r},s=n(871),l=n(277),c=n(614),u=n(865);function p(e,t,n,r,o,i,a){function s(t){var o=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],s=a;return!a||t==a[0]||t===e.nullContext&&null===a[0]||(s=[t].concat(a)),n(e,t,e.helpers,e.partials,o.data||r,i&&[o.blockParams].concat(i),s)}return(s=h(n,s,e,a,r,i)).program=t,s.depth=a?a.length:0,s.blockParams=o||0,s}function d(){return""}function h(e,t,n,r,i,a){if(e.decorator){var s={};t=e.decorator(t,s,n,r&&r[0],i,a,r),o.extend(t,s)}return t}},632:(e,t,n)=>{t.__esModule=!0;var r=n(849),o=void 0;try{}catch(e){}function i(e,t,n){if(r.isArray(e)){for(var o=[],i=0,a=e.length;i<a;i++)o.push(t.wrap(e[i],n));return o}return"boolean"==typeof e||"number"==typeof e?e+"":e}function a(e){this.srcFile=e,this.source=[]}o||((o=function(e,t,n,r){this.src="",r&&this.add(r)}).prototype={add:function(e){r.isArray(e)&&(e=e.join("")),this.src+=e},prepend:function(e){r.isArray(e)&&(e=e.join("")),this.src=e+this.src},toStringWithSourceMap:function(){return{code:this.toString()}},toString:function(){return this.src}}),a.prototype={isEmpty:function(){return!this.source.length},prepend:function(e,t){this.source.unshift(this.wrap(e,t))},push:function(e,t){this.source.push(this.wrap(e,t))},merge:function(){var e=this.empty();return this.each(function(t){e.add(["  ",t,"\n"])}),e},each:function(e){for(var t=0,n=this.source.length;t<n;t++)e(this.source[t])},empty:function(){var e=this.currentLocation||{start:{}};return new o(e.start.line,e.start.column,this.srcFile)},wrap:function(e){var t=arguments.length<=1||void 0===arguments[1]?this.currentLocation||{start:{}}:arguments[1];return e instanceof o?e:(e=i(e,this,t),new o(t.start.line,t.start.column,this.srcFile,e))},functionCall:function(e,t,n){return n=this.generateList(n),this.wrap([e,t?"."+t+"(":"(",n,")"])},quotedString:function(e){return'"'+(e+"").replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")+'"'},objectLiteral:function(e){var t=this,n=[];Object.keys(e).forEach(function(r){var o=i(e[r],t);"undefined"!==o&&n.push([t.quotedString(r),":",o])});var r=this.generateList(n);return r.prepend("{"),r.add("}"),r},generateList:function(e){for(var t=this.empty(),n=0,r=e.length;n<r;n++)n&&t.add(","),t.add(i(e[n],this));return t},generateArray:function(e){var t=this.generateList(e);return t.prepend("["),t.add("]"),t}},t.default=a,e.exports=t.default},639:(e,t,n)=>{function r(e){return e&&e.__esModule?e:{default:e}}t.__esModule=!0;var o=r(n(261)),i=r(n(919)),a=n(27),s=n(127),l=r(n(727)),c=r(n(350)),u=r(n(148)),p=o.default.create;function d(){var e=p();return e.compile=function(t,n){return s.compile(t,n,e)},e.precompile=function(t,n){return s.precompile(t,n,e)},e.AST=i.default,e.Compiler=s.Compiler,e.JavaScriptCompiler=l.default,e.Parser=a.parser,e.parse=a.parse,e.parseWithoutProcessing=a.parseWithoutProcessing,e}var h=d();h.create=d,u.default(h),h.Visitor=c.default,h.default=h,t.default=h,e.exports=t.default},726:(e,t,n)=>{t.__esModule=!0,t.createNewLookupObject=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return r.extend.apply(void 0,[Object.create(null)].concat(t))};var r=n(849)},727:(e,t,n)=>{function r(e){return e&&e.__esModule?e:{default:e}}t.__esModule=!0;var o=n(871),i=r(n(769)),a=n(849),s=r(n(632));function l(e){this.value=e}function c(){}c.prototype={nameLookup:function(e,t){return this.internalNameLookup(e,t)},depthedLookup:function(e){return[this.aliasable("container.lookup"),"(depths, ",JSON.stringify(e),")"]},compilerInfo:function(){var e=o.COMPILER_REVISION;return[e,o.REVISION_CHANGES[e]]},appendToBuffer:function(e,t,n){return a.isArray(e)||(e=[e]),e=this.source.wrap(e,t),this.environment.isSimple?["return ",e,";"]:n?["buffer += ",e,";"]:(e.appendToBuffer=!0,e)},initializeBuffer:function(){return this.quotedString("")},internalNameLookup:function(e,t){return this.lookupPropertyFunctionIsUsed=!0,["lookupProperty(",e,",",JSON.stringify(t),")"]},lookupPropertyFunctionIsUsed:!1,compile:function(e,t,n,r){this.environment=e,this.options=t,this.stringParams=this.options.stringParams,this.trackIds=this.options.trackIds,this.precompile=!r,this.name=this.environment.name,this.isChild=!!n,this.context=n||{decorators:[],programs:[],environments:[]},this.preamble(),this.stackSlot=0,this.stackVars=[],this.aliases={},this.registers={list:[]},this.hashes=[],this.compileStack=[],this.inlineStack=[],this.blockParams=[],this.compileChildren(e,t),this.useDepths=this.useDepths||e.useDepths||e.useDecorators||this.options.compat,this.useBlockParams=this.useBlockParams||e.useBlockParams;var o=e.opcodes,a=void 0,s=void 0,l=void 0,c=void 0;for(l=0,c=o.length;l<c;l++)a=o[l],this.source.currentLocation=a.loc,s=s||a.loc,this[a.opcode].apply(this,a.args);if(this.source.currentLocation=s,this.pushSource(""),this.stackSlot||this.inlineStack.length||this.compileStack.length)throw new i.default("Compile completed with content left on stack");this.decorators.isEmpty()?this.decorators=void 0:(this.useDecorators=!0,this.decorators.prepend(["var decorators = container.decorators, ",this.lookupPropertyFunctionVarDeclaration(),";\n"]),this.decorators.push("return fn;"),r?this.decorators=Function.apply(this,["fn","props","container","depth0","data","blockParams","depths",this.decorators.merge()]):(this.decorators.prepend("function(fn, props, container, depth0, data, blockParams, depths) {\n"),this.decorators.push("}\n"),this.decorators=this.decorators.merge()));var u=this.createFunctionContext(r);if(this.isChild)return u;var p={compiler:this.compilerInfo(),main:u};this.decorators&&(p.main_d=this.decorators,p.useDecorators=!0);var d=this.context,h=d.programs,f=d.decorators;for(l=0,c=h.length;l<c;l++)h[l]&&(p[l]=h[l],f[l]&&(p[l+"_d"]=f[l],p.useDecorators=!0));return this.environment.usePartial&&(p.usePartial=!0),this.options.data&&(p.useData=!0),this.useDepths&&(p.useDepths=!0),this.useBlockParams&&(p.useBlockParams=!0),this.options.compat&&(p.compat=!0),r?p.compilerOptions=this.options:(p.compiler=JSON.stringify(p.compiler),this.source.currentLocation={start:{line:1,column:0}},p=this.objectLiteral(p),t.srcName?(p=p.toStringWithSourceMap({file:t.destName})).map=p.map&&p.map.toString():p=p.toString()),p},preamble:function(){this.lastContext=0,this.source=new s.default(this.options.srcName),this.decorators=new s.default(this.options.srcName)},createFunctionContext:function(e){var t=this,n="",r=this.stackVars.concat(this.registers.list);r.length>0&&(n+=", "+r.join(", "));var o=0;Object.keys(this.aliases).forEach(function(e){var r=t.aliases[e];r.children&&r.referenceCount>1&&(n+=", alias"+ ++o+"="+e,r.children[0]="alias"+o)}),this.lookupPropertyFunctionIsUsed&&(n+=", "+this.lookupPropertyFunctionVarDeclaration());var i=["container","depth0","helpers","partials","data"];(this.useBlockParams||this.useDepths)&&i.push("blockParams"),this.useDepths&&i.push("depths");var a=this.mergeSource(n);return e?(i.push(a),Function.apply(this,i)):this.source.wrap(["function(",i.join(","),") {\n  ",a,"}"])},mergeSource:function(e){var t=this.environment.isSimple,n=!this.forceBuffer,r=void 0,o=void 0,i=void 0,a=void 0;return this.source.each(function(e){e.appendToBuffer?(i?e.prepend("  + "):i=e,a=e):(i&&(o?i.prepend("buffer += "):r=!0,a.add(";"),i=a=void 0),o=!0,t||(n=!1))}),n?i?(i.prepend("return "),a.add(";")):o||this.source.push('return "";'):(e+=", buffer = "+(r?"":this.initializeBuffer()),i?(i.prepend("return buffer + "),a.add(";")):this.source.push("return buffer;")),e&&this.source.prepend("var "+e.substring(2)+(r?"":";\n")),this.source.merge()},lookupPropertyFunctionVarDeclaration:function(){return"\n      lookupProperty = container.lookupProperty || function(parent, propertyName) {\n        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {\n          return parent[propertyName];\n        }\n        return undefined\n    }\n    ".trim()},blockValue:function(e){var t=this.aliasable("container.hooks.blockHelperMissing"),n=[this.contextName(0)];this.setupHelperArgs(e,0,n);var r=this.popStack();n.splice(1,0,r),this.push(this.source.functionCall(t,"call",n))},ambiguousBlockValue:function(){var e=this.aliasable("container.hooks.blockHelperMissing"),t=[this.contextName(0)];this.setupHelperArgs("",0,t,!0),this.flushInline();var n=this.topStack();t.splice(1,0,n),this.pushSource(["if (!",this.lastHelper,") { ",n," = ",this.source.functionCall(e,"call",t),"}"])},appendContent:function(e){this.pendingContent?e=this.pendingContent+e:this.pendingLocation=this.source.currentLocation,this.pendingContent=e},append:function(){if(this.isInline())this.replaceStack(function(e){return[" != null ? ",e,' : ""']}),this.pushSource(this.appendToBuffer(this.popStack()));else{var e=this.popStack();this.pushSource(["if (",e," != null) { ",this.appendToBuffer(e,void 0,!0)," }"]),this.environment.isSimple&&this.pushSource(["else { ",this.appendToBuffer("''",void 0,!0)," }"])}},appendEscaped:function(){this.pushSource(this.appendToBuffer([this.aliasable("container.escapeExpression"),"(",this.popStack(),")"]))},getContext:function(e){this.lastContext=e},pushContext:function(){this.pushStackLiteral(this.contextName(this.lastContext))},lookupOnContext:function(e,t,n,r){var o=0;r||!this.options.compat||this.lastContext?this.pushContext():this.push(this.depthedLookup(e[o++])),this.resolvePath("context",e,o,t,n)},lookupBlockParam:function(e,t){this.useBlockParams=!0,this.push(["blockParams[",e[0],"][",e[1],"]"]),this.resolvePath("context",t,1)},lookupData:function(e,t,n){e?this.pushStackLiteral("container.data(data, "+e+")"):this.pushStackLiteral("data"),this.resolvePath("data",t,0,!0,n)},resolvePath:function(e,t,n,r,o){var i=this;if(this.options.strict||this.options.assumeObjects)this.push(function(e,t,n,r,o){var i=t.popStack(),a=n.length;e&&a--;for(;r<a;r++)i=t.nameLookup(i,n[r],o);return e?[t.aliasable("container.strict"),"(",i,", ",t.quotedString(n[r]),", ",JSON.stringify(t.source.currentLocation)," )"]:i}(this.options.strict&&o,this,t,n,e));else for(var a=t.length;n<a;n++)this.replaceStack(function(o){var a=i.nameLookup(o,t[n],e);return r?[" && ",a]:[" != null ? ",a," : ",o]})},resolvePossibleLambda:function(){this.push([this.aliasable("container.lambda"),"(",this.popStack(),", ",this.contextName(0),")"])},pushStringParam:function(e,t){this.pushContext(),this.pushString(t),"SubExpression"!==t&&("string"==typeof e?this.pushString(e):this.pushStackLiteral(e))},emptyHash:function(e){this.trackIds&&this.push("{}"),this.stringParams&&(this.push("{}"),this.push("{}")),this.pushStackLiteral(e?"undefined":"{}")},pushHash:function(){this.hash&&this.hashes.push(this.hash),this.hash={values:{},types:[],contexts:[],ids:[]}},popHash:function(){var e=this.hash;this.hash=this.hashes.pop(),this.trackIds&&this.push(this.objectLiteral(e.ids)),this.stringParams&&(this.push(this.objectLiteral(e.contexts)),this.push(this.objectLiteral(e.types))),this.push(this.objectLiteral(e.values))},pushString:function(e){this.pushStackLiteral(this.quotedString(e))},pushLiteral:function(e){this.pushStackLiteral(e)},pushProgram:function(e){null!=e?this.pushStackLiteral(this.programExpression(e)):this.pushStackLiteral(null)},registerDecorator:function(e,t){var n=this.nameLookup("decorators",t,"decorator"),r=this.setupHelperArgs(t,e);this.decorators.push(["fn = ",this.decorators.functionCall(n,"",["fn","props","container",r])," || fn;"])},invokeHelper:function(e,t,n){var r=this.popStack(),o=this.setupHelper(e,t),i=[];n&&i.push(o.name),i.push(r),this.options.strict||i.push(this.aliasable("container.hooks.helperMissing"));var a=["(",this.itemsSeparatedBy(i,"||"),")"],s=this.source.functionCall(a,"call",o.callParams);this.push(s)},itemsSeparatedBy:function(e,t){var n=[];n.push(e[0]);for(var r=1;r<e.length;r++)n.push(t,e[r]);return n},invokeKnownHelper:function(e,t){var n=this.setupHelper(e,t);this.push(this.source.functionCall(n.name,"call",n.callParams))},invokeAmbiguous:function(e,t){this.useRegister("helper");var n=this.popStack();this.emptyHash();var r=this.setupHelper(0,e,t),o=["(","(helper = ",this.lastHelper=this.nameLookup("helpers",e,"helper")," || ",n,")"];this.options.strict||(o[0]="(helper = ",o.push(" != null ? helper : ",this.aliasable("container.hooks.helperMissing"))),this.push(["(",o,r.paramsInit?["),(",r.paramsInit]:[],"),","(typeof helper === ",this.aliasable('"function"')," ? ",this.source.functionCall("helper","call",r.callParams)," : helper))"])},invokePartial:function(e,t,n){var r=[],o=this.setupParams(t,1,r);e&&(t=this.popStack(),delete o.name),n&&(o.indent=JSON.stringify(n)),o.helpers="helpers",o.partials="partials",o.decorators="container.decorators",e?r.unshift(t):r.unshift(this.nameLookup("partials",t,"partial")),this.options.compat&&(o.depths="depths"),o=this.objectLiteral(o),r.push(o),this.push(this.source.functionCall("container.invokePartial","",r))},assignToHash:function(e){var t=this.popStack(),n=void 0,r=void 0,o=void 0;this.trackIds&&(o=this.popStack()),this.stringParams&&(r=this.popStack(),n=this.popStack());var i=this.hash;n&&(i.contexts[e]=n),r&&(i.types[e]=r),o&&(i.ids[e]=o),i.values[e]=t},pushId:function(e,t,n){"BlockParam"===e?this.pushStackLiteral("blockParams["+t[0]+"].path["+t[1]+"]"+(n?" + "+JSON.stringify("."+n):"")):"PathExpression"===e?this.pushString(t):"SubExpression"===e?this.pushStackLiteral("true"):this.pushStackLiteral("null")},compiler:c,compileChildren:function(e,t){for(var n=e.children,r=void 0,o=void 0,i=0,a=n.length;i<a;i++){r=n[i],o=new this.compiler;var s=this.matchExistingProgram(r);if(null==s){this.context.programs.push("");var l=this.context.programs.length;r.index=l,r.name="program"+l,this.context.programs[l]=o.compile(r,t,this.context,!this.precompile),this.context.decorators[l]=o.decorators,this.context.environments[l]=r,this.useDepths=this.useDepths||o.useDepths,this.useBlockParams=this.useBlockParams||o.useBlockParams,r.useDepths=this.useDepths,r.useBlockParams=this.useBlockParams}else r.index=s.index,r.name="program"+s.index,this.useDepths=this.useDepths||s.useDepths,this.useBlockParams=this.useBlockParams||s.useBlockParams}},matchExistingProgram:function(e){for(var t=0,n=this.context.environments.length;t<n;t++){var r=this.context.environments[t];if(r&&r.equals(e))return r}},programExpression:function(e){var t=this.environment.children[e],n=[t.index,"data",t.blockParams];return(this.useBlockParams||this.useDepths)&&n.push("blockParams"),this.useDepths&&n.push("depths"),"container.program("+n.join(", ")+")"},useRegister:function(e){this.registers[e]||(this.registers[e]=!0,this.registers.list.push(e))},push:function(e){return e instanceof l||(e=this.source.wrap(e)),this.inlineStack.push(e),e},pushStackLiteral:function(e){this.push(new l(e))},pushSource:function(e){this.pendingContent&&(this.source.push(this.appendToBuffer(this.source.quotedString(this.pendingContent),this.pendingLocation)),this.pendingContent=void 0),e&&this.source.push(e)},replaceStack:function(e){var t=["("],n=void 0,r=void 0,o=void 0;if(!this.isInline())throw new i.default("replaceStack on non-inline");var a=this.popStack(!0);if(a instanceof l)t=["(",n=[a.value]],o=!0;else{r=!0;var s=this.incrStack();t=["((",this.push(s)," = ",a,")"],n=this.topStack()}var c=e.call(this,n);o||this.popStack(),r&&this.stackSlot--,this.push(t.concat(c,")"))},incrStack:function(){return this.stackSlot++,this.stackSlot>this.stackVars.length&&this.stackVars.push("stack"+this.stackSlot),this.topStackName()},topStackName:function(){return"stack"+this.stackSlot},flushInline:function(){var e=this.inlineStack;this.inlineStack=[];for(var t=0,n=e.length;t<n;t++){var r=e[t];if(r instanceof l)this.compileStack.push(r);else{var o=this.incrStack();this.pushSource([o," = ",r,";"]),this.compileStack.push(o)}}},isInline:function(){return this.inlineStack.length},popStack:function(e){var t=this.isInline(),n=(t?this.inlineStack:this.compileStack).pop();if(!e&&n instanceof l)return n.value;if(!t){if(!this.stackSlot)throw new i.default("Invalid stack pop");this.stackSlot--}return n},topStack:function(){var e=this.isInline()?this.inlineStack:this.compileStack,t=e[e.length-1];return t instanceof l?t.value:t},contextName:function(e){return this.useDepths&&e?"depths["+e+"]":"depth"+e},quotedString:function(e){return this.source.quotedString(e)},objectLiteral:function(e){return this.source.objectLiteral(e)},aliasable:function(e){var t=this.aliases[e];return t?(t.referenceCount++,t):((t=this.aliases[e]=this.source.wrap(e)).aliasable=!0,t.referenceCount=1,t)},setupHelper:function(e,t,n){var r=[];return{params:r,paramsInit:this.setupHelperArgs(t,e,r,n),name:this.nameLookup("helpers",t,"helper"),callParams:[this.aliasable(this.contextName(0)+" != null ? "+this.contextName(0)+" : (container.nullContext || {})")].concat(r)}},setupParams:function(e,t,n){var r={},o=[],i=[],a=[],s=!n,l=void 0;s&&(n=[]),r.name=this.quotedString(e),r.hash=this.popStack(),this.trackIds&&(r.hashIds=this.popStack()),this.stringParams&&(r.hashTypes=this.popStack(),r.hashContexts=this.popStack());var c=this.popStack(),u=this.popStack();(u||c)&&(r.fn=u||"container.noop",r.inverse=c||"container.noop");for(var p=t;p--;)l=this.popStack(),n[p]=l,this.trackIds&&(a[p]=this.popStack()),this.stringParams&&(i[p]=this.popStack(),o[p]=this.popStack());return s&&(r.args=this.source.generateArray(n)),this.trackIds&&(r.ids=this.source.generateArray(a)),this.stringParams&&(r.types=this.source.generateArray(i),r.contexts=this.source.generateArray(o)),this.options.data&&(r.data="data"),this.useBlockParams&&(r.blockParams="blockParams"),r},setupHelperArgs:function(e,t,n,r){var o=this.setupParams(e,t,n);return o.loc=JSON.stringify(this.source.currentLocation),o=this.objectLiteral(o),r?(this.useRegister("options"),n.push("options"),["options=",o]):n?(n.push(o),""):o}},function(){for(var e="break else new var case finally return void catch for switch while continue function this with default if throw delete in try do instanceof typeof abstract enum int short boolean export interface static byte extends long super char final native synchronized class float package throws const goto private transient debugger implements protected volatile double import public let yield await null true false".split(" "),t=c.RESERVED_WORDS={},n=0,r=e.length;n<r;n++)t[e[n]]=!0}(),c.isValidJavaScriptVariableName=function(e){return!c.RESERVED_WORDS[e]&&/^[a-zA-Z_$][0-9a-zA-Z_$]*$/.test(e)},t.default=c,e.exports=t.default},769:(e,t)=>{t.__esModule=!0;var n=["description","fileName","lineNumber","endLineNumber","message","name","number","stack"];function r(e,t){var o=t&&t.loc,i=void 0,a=void 0,s=void 0,l=void 0;o&&(i=o.start.line,a=o.end.line,s=o.start.column,l=o.end.column,e+=" - "+i+":"+s);for(var c=Error.prototype.constructor.call(this,e),u=0;u<n.length;u++)this[n[u]]=c[n[u]];Error.captureStackTrace&&Error.captureStackTrace(this,r);try{o&&(this.lineNumber=i,this.endLineNumber=a,Object.defineProperty?(Object.defineProperty(this,"column",{value:s,enumerable:!0}),Object.defineProperty(this,"endColumn",{value:l,enumerable:!0})):(this.column=s,this.endColumn=l))}catch(e){}}r.prototype=new Error,t.default=r,e.exports=t.default},785:(e,t,n)=>{t.__esModule=!0;var r,o=n(849),i=n(769),a=(r=i)&&r.__esModule?r:{default:r};t.default=function(e){e.registerHelper("each",function(e,t){if(!t)throw new a.default("Must pass iterator to #each");var n,r=t.fn,i=t.inverse,s=0,l="",c=void 0,u=void 0;function p(t,n,i){c&&(c.key=t,c.index=n,c.first=0===n,c.last=!!i,u&&(c.contextPath=u+t)),l+=r(e[t],{data:c,blockParams:o.blockParams([e[t],t],[u+t,null])})}if(t.data&&t.ids&&(u=o.appendContextPath(t.data.contextPath,t.ids[0])+"."),o.isFunction(e)&&(e=e.call(this)),t.data&&(c=o.createFrame(t.data)),e&&"object"==typeof e)if(o.isArray(e))for(var d=e.length;s<d;s++)s in e&&p(s,s,s===e.length-1);else if("function"==typeof Symbol&&e[Symbol.iterator]){for(var h=[],f=e[Symbol.iterator](),m=f.next();!m.done;m=f.next())h.push(m.value);for(d=(e=h).length;s<d;s++)p(s,s,s===e.length-1)}else n=void 0,Object.keys(e).forEach(function(e){void 0!==n&&p(n,s-1),n=e,s++}),void 0!==n&&p(n,s-1,!0);return 0===s&&(l=i(this)),l})},e.exports=t.default},849:(e,t)=>{t.__esModule=!0,t.extend=a,t.indexOf=function(e,t){for(var n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1},t.escapeExpression=function(e){if("string"!=typeof e){if(e&&e.toHTML)return e.toHTML();if(null==e)return"";if(!e)return e+"";e=""+e}if(!o.test(e))return e;return e.replace(r,i)},t.isEmpty=function(e){return!e&&0!==e||!(!c(e)||0!==e.length)},t.createFrame=function(e){var t=a({},e);return t._parent=e,t},t.blockParams=function(e,t){return e.path=t,e},t.appendContextPath=function(e,t){return(e?e+".":"")+t};var n={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;","=":"&#x3D;"},r=/[&<>"'`=]/g,o=/[&<>"'`=]/;function i(e){return n[e]}function a(e){for(var t=1;t<arguments.length;t++)for(var n in arguments[t])Object.prototype.hasOwnProperty.call(arguments[t],n)&&(e[n]=arguments[t][n]);return e}var s=Object.prototype.toString;t.toString=s;var l=function(e){return"function"==typeof e};l(/x/)&&(t.isFunction=l=function(e){return"function"==typeof e&&"[object Function]"===s.call(e)}),t.isFunction=l;var c=Array.isArray||function(e){return!(!e||"object"!=typeof e)&&"[object Array]"===s.call(e)};t.isArray=c},865:(e,t,n)=>{t.__esModule=!0,t.createProtoAccessControl=function(e){var t=Object.create(null);t.constructor=!1,t.__defineGetter__=!1,t.__defineSetter__=!1,t.__lookupGetter__=!1;var n=Object.create(null);return n.__proto__=!1,{properties:{whitelist:o.createNewLookupObject(n,e.allowedProtoProperties),defaultValue:e.allowProtoPropertiesByDefault},methods:{whitelist:o.createNewLookupObject(t,e.allowedProtoMethods),defaultValue:e.allowProtoMethodsByDefault}}},t.resultIsAllowed=function(e,t,n){return l("function"==typeof e?t.methods:t.properties,n)},t.resetLoggedProperties=function(){Object.keys(s).forEach(function(e){delete s[e]})};var r,o=n(726),i=n(566),a=(r=i)&&r.__esModule?r:{default:r},s=Object.create(null);function l(e,t){return void 0!==e.whitelist[t]?!0===e.whitelist[t]:void 0!==e.defaultValue?e.defaultValue:(function(e){!0!==s[e]&&(s[e]=!0,a.default.log("error",'Handlebars: Access has been denied to resolve the property "'+e+'" because it is not an "own property" of its parent.\nYou can add a runtime option to disable the check or this warning:\nSee https://handlebarsjs.com/api-reference/runtime-options.html#options-to-control-prototype-access for details'))}(t),!1)}},871:(e,t,n)=>{function r(e){return e&&e.__esModule?e:{default:e}}t.__esModule=!0,t.HandlebarsEnvironment=p;var o=n(849),i=r(n(769)),a=n(277),s=n(940),l=r(n(566)),c=n(865);t.VERSION="4.7.8";t.COMPILER_REVISION=8;t.LAST_COMPATIBLE_COMPILER_REVISION=7;t.REVISION_CHANGES={1:"<= 1.0.rc.2",2:"== 1.0.0-rc.3",3:"== 1.0.0-rc.4",4:"== 1.x.x",5:"== 2.0.0-alpha.x",6:">= 2.0.0-beta.1",7:">= 4.0.0 <4.3.0",8:">= 4.3.0"};var u="[object Object]";function p(e,t,n){this.helpers=e||{},this.partials=t||{},this.decorators=n||{},a.registerDefaultHelpers(this),s.registerDefaultDecorators(this)}p.prototype={constructor:p,logger:l.default,log:l.default.log,registerHelper:function(e,t){if(o.toString.call(e)===u){if(t)throw new i.default("Arg not supported with multiple helpers");o.extend(this.helpers,e)}else this.helpers[e]=t},unregisterHelper:function(e){delete this.helpers[e]},registerPartial:function(e,t){if(o.toString.call(e)===u)o.extend(this.partials,e);else{if(void 0===t)throw new i.default('Attempting to register a partial called "'+e+'" as undefined');this.partials[e]=t}},unregisterPartial:function(e){delete this.partials[e]},registerDecorator:function(e,t){if(o.toString.call(e)===u){if(t)throw new i.default("Arg not supported with multiple decorators");o.extend(this.decorators,e)}else this.decorators[e]=t},unregisterDecorator:function(e){delete this.decorators[e]},resetLoggedPropertyAccesses:function(){c.resetLoggedProperties()}};var d=l.default.log;t.log=d,t.createFrame=o.createFrame,t.logger=l.default},908:(e,t,n)=>{t.__esModule=!0;var r,o=n(849),i=n(769),a=(r=i)&&r.__esModule?r:{default:r};t.default=function(e){e.registerHelper("with",function(e,t){if(2!=arguments.length)throw new a.default("#with requires exactly one argument");o.isFunction(e)&&(e=e.call(this));var n=t.fn;if(o.isEmpty(e))return t.inverse(this);var r=t.data;return t.data&&t.ids&&((r=o.createFrame(t.data)).contextPath=o.appendContextPath(t.data.contextPath,t.ids[0])),n(e,{data:r,blockParams:o.blockParams([e],[r&&r.contextPath])})})},e.exports=t.default},915:(e,t,n)=>{t.__esModule=!0;var r,o=n(350),i=(r=o)&&r.__esModule?r:{default:r};function a(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];this.options=e}function s(e,t,n){void 0===t&&(t=e.length);var r=e[t-1],o=e[t-2];return r?"ContentStatement"===r.type?(o||!n?/\r?\n\s*?$/:/(^|\r?\n)\s*?$/).test(r.original):void 0:n}function l(e,t,n){void 0===t&&(t=-1);var r=e[t+1],o=e[t+2];return r?"ContentStatement"===r.type?(o||!n?/^\s*?\r?\n/:/^\s*?(\r?\n|$)/).test(r.original):void 0:n}function c(e,t,n){var r=e[null==t?0:t+1];if(r&&"ContentStatement"===r.type&&(n||!r.rightStripped)){var o=r.value;r.value=r.value.replace(n?/^\s+/:/^[ \t]*\r?\n?/,""),r.rightStripped=r.value!==o}}function u(e,t,n){var r=e[null==t?e.length-1:t-1];if(r&&"ContentStatement"===r.type&&(n||!r.leftStripped)){var o=r.value;return r.value=r.value.replace(n?/\s+$/:/[ \t]+$/,""),r.leftStripped=r.value!==o,r.leftStripped}}a.prototype=new i.default,a.prototype.Program=function(e){var t=!this.options.ignoreStandalone,n=!this.isRootSeen;this.isRootSeen=!0;for(var r=e.body,o=0,i=r.length;o<i;o++){var a=r[o],p=this.accept(a);if(p){var d=s(r,o,n),h=l(r,o,n),f=p.openStandalone&&d,m=p.closeStandalone&&h,g=p.inlineStandalone&&d&&h;p.close&&c(r,o,!0),p.open&&u(r,o,!0),t&&g&&(c(r,o),u(r,o)&&"PartialStatement"===a.type&&(a.indent=/([ \t]+$)/.exec(r[o-1].original)[1])),t&&f&&(c((a.program||a.inverse).body),u(r,o)),t&&m&&(c(r,o),u((a.inverse||a.program).body))}}return e},a.prototype.BlockStatement=a.prototype.DecoratorBlock=a.prototype.PartialBlockStatement=function(e){this.accept(e.program),this.accept(e.inverse);var t=e.program||e.inverse,n=e.program&&e.inverse,r=n,o=n;if(n&&n.chained)for(r=n.body[0].program;o.chained;)o=o.body[o.body.length-1].program;var i={open:e.openStrip.open,close:e.closeStrip.close,openStandalone:l(t.body),closeStandalone:s((r||t).body)};if(e.openStrip.close&&c(t.body,null,!0),n){var a=e.inverseStrip;a.open&&u(t.body,null,!0),a.close&&c(r.body,null,!0),e.closeStrip.open&&u(o.body,null,!0),!this.options.ignoreStandalone&&s(t.body)&&l(r.body)&&(u(t.body),c(r.body))}else e.closeStrip.open&&u(t.body,null,!0);return i},a.prototype.Decorator=a.prototype.MustacheStatement=function(e){return e.strip},a.prototype.PartialStatement=a.prototype.CommentStatement=function(e){var t=e.strip||{};return{inlineStandalone:!0,open:t.open,close:t.close}},t.default=a,e.exports=t.default},919:(e,t)=>{t.__esModule=!0;var n={helpers:{helperExpression:function(e){return"SubExpression"===e.type||("MustacheStatement"===e.type||"BlockStatement"===e.type)&&!!(e.params&&e.params.length||e.hash)},scopedId:function(e){return/^\.|this\b/.test(e.original)},simpleId:function(e){return 1===e.parts.length&&!n.helpers.scopedId(e)&&!e.depth}}};t.default=n,e.exports=t.default},940:(e,t,n)=>{t.__esModule=!0,t.registerDefaultDecorators=function(e){i.default(e)};var r,o=n(430),i=(r=o)&&r.__esModule?r:{default:r}}},A={};class N extends Error{data;constructor(e,t){super(e),this.data=t}toString(){return this.message}}async function O(e,t){const n=SillyTavern.getContext(),r=new FormData;r.append("avatar",new Blob([JSON.stringify(e)],{type:"application/json"}),"character.json"),r.append("file_type","json");const o=n.getRequestHeaders();delete o["Content-Type"];const i=await fetch("/api/characters/import",{method:"POST",headers:o,body:r,cache:"no-cache"});if(!i.ok)throw new N(i.statusText,i);t&&await n.getCharacters()}async function F(e,t){const n=SillyTavern.getContext(),r=new FormData;r.append("ch_name",e.name),r.append("avatar_url",e.avatar??""),r.append("description",e.description??""),r.append("first_mes",e.first_mes??""),r.append("scenario",e.scenario??""),r.append("personality",e.personality??""),r.append("mes_example",e.mes_example??""),r.append("creatorcomment",e.creatorcomment??""),r.append("tags",(e.tags??[]).join(","));const o=n.getThumbnailUrl("avatar",e.avatar),i=await fetch(o).then(e=>e.blob()),a=new File([i],"avatar.png",{type:"image/png"});r.append("avatar",a);const s=e.data||{};r.append("creator",s.creator??""),r.append("character_version",s.character_version??""),r.append("creator_notes",s.creator_notes??""),r.append("system_prompt",s.system_prompt??""),r.append("post_history_instructions",s.post_history_instructions??"");const l=s.extensions||{};r.append("chat",e.chat??""),r.append("create_date",e.create_date??""),r.append("last_mes",e.last_mes??""),r.append("talkativeness",l.talkativeness??""),r.append("fav",String(l.fav??!1)),r.append("world",l.world??"");const c=l.depth_prompt||{};if(r.append("depth_prompt_prompt",c.prompt??""),r.append("depth_prompt_depth",String(c.depth??0)),r.append("depth_prompt_role",c.role??""),Array.isArray(s.alternate_greetings))for(const e of s.alternate_greetings)r.append("alternate_greetings",e);r.append("json_data",JSON.stringify(e));const u=n.getRequestHeaders();delete u["Content-Type"];const p=await fetch("/api/characters/edit",{method:"POST",headers:u,body:r,cache:"no-cache"});if(!p.ok)throw new N(p.statusText,p);t&&await n.getCharacters()}class L{settingsKey;defaultSettings;constructor(e,t){this.settingsKey=e,this.defaultSettings=t}async initializeSettings(e={}){const{strategy:t="recursive"}=e,n=this.defaultSettings.version,r=this.defaultSettings.formatVersion,o=SillyTavern.getContext().extensionSettings[this.settingsKey],i={version:{changed:!1,new:n??""},formatVersion:{changed:!1,new:r??""},oldSettings:null,newSettings:this.defaultSettings};if(!o)return SillyTavern.getContext().extensionSettings[this.settingsKey]=this.defaultSettings,this.saveSettings(),i;const a={...i,oldSettings:structuredClone(o),version:{changed:!1,old:o.version,new:o.version},formatVersion:{changed:!1,old:o.formatVersion,new:o.formatVersion}};if("recursive"===t){function s(e,t){let n=!1;for(const r of Object.keys(t))void 0===e[r]?(e[r]=t[r],n=!0):"object"==typeof t[r]&&null!==t[r]&&(e[r]=e[r]||{},s(e[r],t[r])&&(n=!0));return n}n&&o.version!==n&&(a.version.changed=!0,a.version.new=n,o.version=n),r&&"*"!==r&&o.formatVersion!==r&&(a.formatVersion.changed=!0,a.formatVersion.new=r,o.formatVersion=r),(s(o,this.defaultSettings)||a.version.changed||a.formatVersion.changed)&&this.saveSettings()}else if(Array.isArray(t)){n&&!o.version&&(o.version=n,a.version.changed=!0,a.version.new=n),r&&!o.formatVersion&&(o.formatVersion=r,a.formatVersion.changed=!0,a.formatVersion.new=r);let l=structuredClone(o),c=o.formatVersion;try{let u;do{u=!1;let p=t.find(e=>e.from===c);if(p&&p.to>c)l=await p.action(l),c=p.to,l.formatVersion=p.to,u=!0;else for(const d of t)if("*"===d.from&&d.to>c&&c!==d.to){l=await d.action(l),c=d.to,l.formatVersion=d.to,u=!0;break}}while(u);if(c!==o.formatVersion){a.formatVersion.changed=!0,a.formatVersion.new=c;const h=this.defaultSettings.version;h&&(l.version=h)}if(a.formatVersion.changed){for(const f of Object.keys(o))delete o[f];Object.assign(o,l),this.saveSettings()}}catch(m){throw console.error("Failed to apply version changes:",m),new Error(`Version migration failed: ${m instanceof Error?m.message:m}`,{cause:m})}}return a.newSettings=o,a}getSettings(){return SillyTavern.getContext().extensionSettings[this.settingsKey]}updateSetting(e,t){SillyTavern.getContext().extensionSettings[this.settingsKey][e]=t,this.saveSettings()}saveSettings(){SillyTavern.getContext().saveSettingsDebounced()}resetSettings(){SillyTavern.getContext().extensionSettings[this.settingsKey]=this.defaultSettings,this.saveSettings()}}function M(e){return Array.isArray?Array.isArray(e):"[object Array]"===U(e)}function B(e){return"string"==typeof e}function j(e){return"number"==typeof e}function R(e){return!0===e||!1===e||function(e){return H(e)&&null!==e}(e)&&"[object Boolean]"==U(e)}function H(e){return"object"==typeof e}function q(e){return null!=e}function V(e){return!e.trim().length}function U(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":Object.prototype.toString.call(e)}const W=Object.prototype.hasOwnProperty;class G{constructor(e){this._keys=[],this._keyMap={};let t=0;e.forEach(e=>{let n=Y(e);this._keys.push(n),this._keyMap[n.id]=n,t+=n.weight}),this._keys.forEach(e=>{e.weight/=t})}get(e){return this._keyMap[e]}keys(){return this._keys}toJSON(){return JSON.stringify(this._keys)}}function Y(e){let t=null,n=null,r=null,o=1,i=null;if(B(e)||M(e))r=e,t=X(e),n=z(e);else{if(!W.call(e,"name"))throw new Error((e=>`Missing ${e} property in key`)("name"));const a=e.name;if(r=a,W.call(e,"weight")&&(o=e.weight,o<=0))throw new Error((e=>`Property 'weight' in key '${e}' must be a positive integer`)(a));t=X(a),n=z(a),i=e.getFn}return{path:t,id:n,weight:o,src:r,getFn:i}}function X(e){return M(e)?e:e.split(".")}function z(e){return M(e)?e.join("."):e}const J={useExtendedSearch:!1,getFn:function(e,t){let n=[],r=!1;const o=(e,t,i)=>{if(q(e))if(t[i]){const a=e[t[i]];if(!q(a))return;if(i===t.length-1&&(B(a)||j(a)||R(a)))n.push(function(e){return null==e?"":function(e){if("string"==typeof e)return e;let t=e+"";return"0"==t&&1/e==-1/0?"-0":t}(e)}(a));else if(M(a)){r=!0;for(let e=0,n=a.length;e<n;e+=1)o(a[e],t,i+1)}else t.length&&o(a,t,i+1)}else n.push(e)};return o(e,B(t)?t.split("."):t,0),r?n:n[0]},ignoreLocation:!1,ignoreFieldNorm:!1,fieldNormWeight:1};var K={isCaseSensitive:!1,ignoreDiacritics:!1,includeScore:!1,keys:[],shouldSort:!0,sortFn:(e,t)=>e.score===t.score?e.idx<t.idx?-1:1:e.score<t.score?-1:1,includeMatches:!1,findAllMatches:!1,minMatchCharLength:1,location:0,threshold:.6,distance:100,...J};const Z=/[^ ]+/g;class Q{constructor({getFn:e=K.getFn,fieldNormWeight:t=K.fieldNormWeight}={}){this.norm=function(e=1,t=3){const n=new Map,r=Math.pow(10,t);return{get(t){const o=t.match(Z).length;if(n.has(o))return n.get(o);const i=1/Math.pow(o,.5*e),a=parseFloat(Math.round(i*r)/r);return n.set(o,a),a},clear(){n.clear()}}}(t,3),this.getFn=e,this.isCreated=!1,this.setIndexRecords()}setSources(e=[]){this.docs=e}setIndexRecords(e=[]){this.records=e}setKeys(e=[]){this.keys=e,this._keysMap={},e.forEach((e,t)=>{this._keysMap[e.id]=t})}create(){!this.isCreated&&this.docs.length&&(this.isCreated=!0,B(this.docs[0])?this.docs.forEach((e,t)=>{this._addString(e,t)}):this.docs.forEach((e,t)=>{this._addObject(e,t)}),this.norm.clear())}add(e){const t=this.size();B(e)?this._addString(e,t):this._addObject(e,t)}removeAt(e){this.records.splice(e,1);for(let t=e,n=this.size();t<n;t+=1)this.records[t].i-=1}getValueForItemAtKeyId(e,t){return e[this._keysMap[t]]}size(){return this.records.length}_addString(e,t){if(!q(e)||V(e))return;let n={v:e,i:t,n:this.norm.get(e)};this.records.push(n)}_addObject(e,t){let n={i:t,$:{}};this.keys.forEach((t,r)=>{let o=t.getFn?t.getFn(e):this.getFn(e,t.path);if(q(o))if(M(o)){let e=[];const t=[{nestedArrIndex:-1,value:o}];for(;t.length;){const{nestedArrIndex:n,value:r}=t.pop();if(q(r))if(B(r)&&!V(r)){let t={v:r,i:n,n:this.norm.get(r)};e.push(t)}else M(r)&&r.forEach((e,n)=>{t.push({nestedArrIndex:n,value:e})})}n.$[r]=e}else if(B(o)&&!V(o)){let e={v:o,n:this.norm.get(o)};n.$[r]=e}}),this.records.push(n)}toJSON(){return{keys:this.keys,records:this.records}}}function ee(e,t,{getFn:n=K.getFn,fieldNormWeight:r=K.fieldNormWeight}={}){const o=new Q({getFn:n,fieldNormWeight:r});return o.setKeys(e.map(Y)),o.setSources(t),o.create(),o}function te(e,{errors:t=0,currentLocation:n=0,expectedLocation:r=0,distance:o=K.distance,ignoreLocation:i=K.ignoreLocation}={}){const a=t/e.length;if(i)return a;const s=Math.abs(r-n);return o?a+s/o:s?1:a}const ne=32;function re(e,t,n,{location:r=K.location,distance:o=K.distance,threshold:i=K.threshold,findAllMatches:a=K.findAllMatches,minMatchCharLength:s=K.minMatchCharLength,includeMatches:l=K.includeMatches,ignoreLocation:c=K.ignoreLocation}={}){if(t.length>ne)throw new Error(`Pattern length exceeds max of ${ne}.`);const u=t.length,p=e.length,d=Math.max(0,Math.min(r,p));let h=i,f=d;const m=s>1||l,g=m?Array(p):[];let v;for(;(v=e.indexOf(t,f))>-1;){let e=te(t,{currentLocation:v,expectedLocation:d,distance:o,ignoreLocation:c});if(h=Math.min(e,h),f=v+u,m){let e=0;for(;e<u;)g[v+e]=1,e+=1}}f=-1;let y=[],b=1,S=u+p;const x=1<<u-1;for(let r=0;r<u;r+=1){let i=0,s=S;for(;i<s;){te(t,{errors:r,currentLocation:d+s,expectedLocation:d,distance:o,ignoreLocation:c})<=h?i=s:S=s,s=Math.floor((S-i)/2+i)}S=s;let l=Math.max(1,d-s+1),v=a?p:Math.min(d+s,p)+u,w=Array(v+2);w[v+1]=(1<<r)-1;for(let i=v;i>=l;i-=1){let a=i-1,s=n[e.charAt(a)];if(m&&(g[a]=+!!s),w[i]=(w[i+1]<<1|1)&s,r&&(w[i]|=(y[i+1]|y[i])<<1|1|y[i+1]),w[i]&x&&(b=te(t,{errors:r,currentLocation:a,expectedLocation:d,distance:o,ignoreLocation:c}),b<=h)){if(h=b,f=a,f<=d)break;l=Math.max(1,2*d-f)}}if(te(t,{errors:r+1,currentLocation:d,expectedLocation:d,distance:o,ignoreLocation:c})>h)break;y=w}const w={isMatch:f>=0,score:Math.max(.001,b)};if(m){const e=function(e=[],t=K.minMatchCharLength){let n=[],r=-1,o=-1,i=0;for(let a=e.length;i<a;i+=1){let a=e[i];a&&-1===r?r=i:a||-1===r||(o=i-1,o-r+1>=t&&n.push([r,o]),r=-1)}return e[i-1]&&i-r>=t&&n.push([r,i-1]),n}(g,s);e.length?l&&(w.indices=e):w.isMatch=!1}return w}function oe(e){let t={};for(let n=0,r=e.length;n<r;n+=1){const o=e.charAt(n);t[o]=(t[o]||0)|1<<r-n-1}return t}const ie=String.prototype.normalize?e=>e.normalize("NFD").replace(/[\u0300-\u036F\u0483-\u0489\u0591-\u05BD\u05BF\u05C1\u05C2\u05C4\u05C5\u05C7\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06DC\u06DF-\u06E4\u06E7\u06E8\u06EA-\u06ED\u0711\u0730-\u074A\u07A6-\u07B0\u07EB-\u07F3\u07FD\u0816-\u0819\u081B-\u0823\u0825-\u0827\u0829-\u082D\u0859-\u085B\u08D3-\u08E1\u08E3-\u0903\u093A-\u093C\u093E-\u094F\u0951-\u0957\u0962\u0963\u0981-\u0983\u09BC\u09BE-\u09C4\u09C7\u09C8\u09CB-\u09CD\u09D7\u09E2\u09E3\u09FE\u0A01-\u0A03\u0A3C\u0A3E-\u0A42\u0A47\u0A48\u0A4B-\u0A4D\u0A51\u0A70\u0A71\u0A75\u0A81-\u0A83\u0ABC\u0ABE-\u0AC5\u0AC7-\u0AC9\u0ACB-\u0ACD\u0AE2\u0AE3\u0AFA-\u0AFF\u0B01-\u0B03\u0B3C\u0B3E-\u0B44\u0B47\u0B48\u0B4B-\u0B4D\u0B56\u0B57\u0B62\u0B63\u0B82\u0BBE-\u0BC2\u0BC6-\u0BC8\u0BCA-\u0BCD\u0BD7\u0C00-\u0C04\u0C3E-\u0C44\u0C46-\u0C48\u0C4A-\u0C4D\u0C55\u0C56\u0C62\u0C63\u0C81-\u0C83\u0CBC\u0CBE-\u0CC4\u0CC6-\u0CC8\u0CCA-\u0CCD\u0CD5\u0CD6\u0CE2\u0CE3\u0D00-\u0D03\u0D3B\u0D3C\u0D3E-\u0D44\u0D46-\u0D48\u0D4A-\u0D4D\u0D57\u0D62\u0D63\u0D82\u0D83\u0DCA\u0DCF-\u0DD4\u0DD6\u0DD8-\u0DDF\u0DF2\u0DF3\u0E31\u0E34-\u0E3A\u0E47-\u0E4E\u0EB1\u0EB4-\u0EB9\u0EBB\u0EBC\u0EC8-\u0ECD\u0F18\u0F19\u0F35\u0F37\u0F39\u0F3E\u0F3F\u0F71-\u0F84\u0F86\u0F87\u0F8D-\u0F97\u0F99-\u0FBC\u0FC6\u102B-\u103E\u1056-\u1059\u105E-\u1060\u1062-\u1064\u1067-\u106D\u1071-\u1074\u1082-\u108D\u108F\u109A-\u109D\u135D-\u135F\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17B4-\u17D3\u17DD\u180B-\u180D\u1885\u1886\u18A9\u1920-\u192B\u1930-\u193B\u1A17-\u1A1B\u1A55-\u1A5E\u1A60-\u1A7C\u1A7F\u1AB0-\u1ABE\u1B00-\u1B04\u1B34-\u1B44\u1B6B-\u1B73\u1B80-\u1B82\u1BA1-\u1BAD\u1BE6-\u1BF3\u1C24-\u1C37\u1CD0-\u1CD2\u1CD4-\u1CE8\u1CED\u1CF2-\u1CF4\u1CF7-\u1CF9\u1DC0-\u1DF9\u1DFB-\u1DFF\u20D0-\u20F0\u2CEF-\u2CF1\u2D7F\u2DE0-\u2DFF\u302A-\u302F\u3099\u309A\uA66F-\uA672\uA674-\uA67D\uA69E\uA69F\uA6F0\uA6F1\uA802\uA806\uA80B\uA823-\uA827\uA880\uA881\uA8B4-\uA8C5\uA8E0-\uA8F1\uA8FF\uA926-\uA92D\uA947-\uA953\uA980-\uA983\uA9B3-\uA9C0\uA9E5\uAA29-\uAA36\uAA43\uAA4C\uAA4D\uAA7B-\uAA7D\uAAB0\uAAB2-\uAAB4\uAAB7\uAAB8\uAABE\uAABF\uAAC1\uAAEB-\uAAEF\uAAF5\uAAF6\uABE3-\uABEA\uABEC\uABED\uFB1E\uFE00-\uFE0F\uFE20-\uFE2F]/g,""):e=>e;class ae{constructor(e,{location:t=K.location,threshold:n=K.threshold,distance:r=K.distance,includeMatches:o=K.includeMatches,findAllMatches:i=K.findAllMatches,minMatchCharLength:a=K.minMatchCharLength,isCaseSensitive:s=K.isCaseSensitive,ignoreDiacritics:l=K.ignoreDiacritics,ignoreLocation:c=K.ignoreLocation}={}){if(this.options={location:t,threshold:n,distance:r,includeMatches:o,findAllMatches:i,minMatchCharLength:a,isCaseSensitive:s,ignoreDiacritics:l,ignoreLocation:c},e=s?e:e.toLowerCase(),e=l?ie(e):e,this.pattern=e,this.chunks=[],!this.pattern.length)return;const u=(e,t)=>{this.chunks.push({pattern:e,alphabet:oe(e),startIndex:t})},p=this.pattern.length;if(p>ne){let e=0;const t=p%ne,n=p-t;for(;e<n;)u(this.pattern.substr(e,ne),e),e+=ne;if(t){const e=p-ne;u(this.pattern.substr(e),e)}}else u(this.pattern,0)}searchIn(e){const{isCaseSensitive:t,ignoreDiacritics:n,includeMatches:r}=this.options;if(e=t?e:e.toLowerCase(),e=n?ie(e):e,this.pattern===e){let t={isMatch:!0,score:0};return r&&(t.indices=[[0,e.length-1]]),t}const{location:o,distance:i,threshold:a,findAllMatches:s,minMatchCharLength:l,ignoreLocation:c}=this.options;let u=[],p=0,d=!1;this.chunks.forEach(({pattern:t,alphabet:n,startIndex:h})=>{const{isMatch:f,score:m,indices:g}=re(e,t,n,{location:o+h,distance:i,threshold:a,findAllMatches:s,minMatchCharLength:l,includeMatches:r,ignoreLocation:c});f&&(d=!0),p+=m,f&&g&&(u=[...u,...g])});let h={isMatch:d,score:d?p/this.chunks.length:1};return d&&r&&(h.indices=u),h}}class se{constructor(e){this.pattern=e}static isMultiMatch(e){return le(e,this.multiRegex)}static isSingleMatch(e){return le(e,this.singleRegex)}search(){}}function le(e,t){const n=e.match(t);return n?n[1]:null}class ce extends se{constructor(e,{location:t=K.location,threshold:n=K.threshold,distance:r=K.distance,includeMatches:o=K.includeMatches,findAllMatches:i=K.findAllMatches,minMatchCharLength:a=K.minMatchCharLength,isCaseSensitive:s=K.isCaseSensitive,ignoreDiacritics:l=K.ignoreDiacritics,ignoreLocation:c=K.ignoreLocation}={}){super(e),this._bitapSearch=new ae(e,{location:t,threshold:n,distance:r,includeMatches:o,findAllMatches:i,minMatchCharLength:a,isCaseSensitive:s,ignoreDiacritics:l,ignoreLocation:c})}static get type(){return"fuzzy"}static get multiRegex(){return/^"(.*)"$/}static get singleRegex(){return/^(.*)$/}search(e){return this._bitapSearch.searchIn(e)}}class ue extends se{constructor(e){super(e)}static get type(){return"include"}static get multiRegex(){return/^'"(.*)"$/}static get singleRegex(){return/^'(.*)$/}search(e){let t,n=0;const r=[],o=this.pattern.length;for(;(t=e.indexOf(this.pattern,n))>-1;)n=t+o,r.push([t,n-1]);const i=!!r.length;return{isMatch:i,score:i?0:1,indices:r}}}const pe=[class extends se{constructor(e){super(e)}static get type(){return"exact"}static get multiRegex(){return/^="(.*)"$/}static get singleRegex(){return/^=(.*)$/}search(e){const t=e===this.pattern;return{isMatch:t,score:t?0:1,indices:[0,this.pattern.length-1]}}},ue,class extends se{constructor(e){super(e)}static get type(){return"prefix-exact"}static get multiRegex(){return/^\^"(.*)"$/}static get singleRegex(){return/^\^(.*)$/}search(e){const t=e.startsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,this.pattern.length-1]}}},class extends se{constructor(e){super(e)}static get type(){return"inverse-prefix-exact"}static get multiRegex(){return/^!\^"(.*)"$/}static get singleRegex(){return/^!\^(.*)$/}search(e){const t=!e.startsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,e.length-1]}}},class extends se{constructor(e){super(e)}static get type(){return"inverse-suffix-exact"}static get multiRegex(){return/^!"(.*)"\$$/}static get singleRegex(){return/^!(.*)\$$/}search(e){const t=!e.endsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,e.length-1]}}},class extends se{constructor(e){super(e)}static get type(){return"suffix-exact"}static get multiRegex(){return/^"(.*)"\$$/}static get singleRegex(){return/^(.*)\$$/}search(e){const t=e.endsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[e.length-this.pattern.length,e.length-1]}}},class extends se{constructor(e){super(e)}static get type(){return"inverse-exact"}static get multiRegex(){return/^!"(.*)"$/}static get singleRegex(){return/^!(.*)$/}search(e){const t=-1===e.indexOf(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,e.length-1]}}},ce],de=pe.length,he=/ +(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/;const fe=new Set([ce.type,ue.type]);class me{constructor(e,{isCaseSensitive:t=K.isCaseSensitive,ignoreDiacritics:n=K.ignoreDiacritics,includeMatches:r=K.includeMatches,minMatchCharLength:o=K.minMatchCharLength,ignoreLocation:i=K.ignoreLocation,findAllMatches:a=K.findAllMatches,location:s=K.location,threshold:l=K.threshold,distance:c=K.distance}={}){this.query=null,this.options={isCaseSensitive:t,ignoreDiacritics:n,includeMatches:r,minMatchCharLength:o,findAllMatches:a,ignoreLocation:i,location:s,threshold:l,distance:c},e=t?e:e.toLowerCase(),e=n?ie(e):e,this.pattern=e,this.query=function(e,t={}){return e.split("|").map(e=>{let n=e.trim().split(he).filter(e=>e&&!!e.trim()),r=[];for(let e=0,o=n.length;e<o;e+=1){const o=n[e];let i=!1,a=-1;for(;!i&&++a<de;){const e=pe[a];let n=e.isMultiMatch(o);n&&(r.push(new e(n,t)),i=!0)}if(!i)for(a=-1;++a<de;){const e=pe[a];let n=e.isSingleMatch(o);if(n){r.push(new e(n,t));break}}}return r})}(this.pattern,this.options)}static condition(e,t){return t.useExtendedSearch}searchIn(e){const t=this.query;if(!t)return{isMatch:!1,score:1};const{includeMatches:n,isCaseSensitive:r,ignoreDiacritics:o}=this.options;e=r?e:e.toLowerCase(),e=o?ie(e):e;let i=0,a=[],s=0;for(let r=0,o=t.length;r<o;r+=1){const o=t[r];a.length=0,i=0;for(let t=0,r=o.length;t<r;t+=1){const r=o[t],{isMatch:l,indices:c,score:u}=r.search(e);if(!l){s=0,i=0,a.length=0;break}if(i+=1,s+=u,n){const e=r.constructor.type;fe.has(e)?a=[...a,...c]:a.push(c)}}if(i){let e={isMatch:!0,score:s/i};return n&&(e.indices=a),e}}return{isMatch:!1,score:1}}}const ge=[];function ve(e,t){for(let n=0,r=ge.length;n<r;n+=1){let r=ge[n];if(r.condition(e,t))return new r(e,t)}return new ae(e,t)}const ye="$and",be="$or",Se="$path",xe="$val",we=e=>!(!e[ye]&&!e[be]),Ce=e=>({[ye]:Object.keys(e).map(t=>({[t]:e[t]}))});function _e(e,t,{auto:n=!0}={}){const r=e=>{let o=Object.keys(e);const i=(e=>!!e[Se])(e);if(!i&&o.length>1&&!we(e))return r(Ce(e));if((e=>!M(e)&&H(e)&&!we(e))(e)){const r=i?e[Se]:o[0],a=i?e[xe]:e[r];if(!B(a))throw new Error((e=>`Invalid value for key ${e}`)(r));const s={keyId:z(r),pattern:a};return n&&(s.searcher=ve(a,t)),s}let a={children:[],operator:o[0]};return o.forEach(t=>{const n=e[t];M(n)&&n.forEach(e=>{a.children.push(r(e))})}),a};return we(e)||(e=Ce(e)),r(e)}function Ee(e,t){const n=e.matches;t.matches=[],q(n)&&n.forEach(e=>{if(!q(e.indices)||!e.indices.length)return;const{indices:n,value:r}=e;let o={indices:n,value:r};e.key&&(o.key=e.key.src),e.idx>-1&&(o.refIndex=e.idx),t.matches.push(o)})}function ke(e,t){t.score=e.score}class Pe{constructor(e,t={},n){this.options={...K,...t},this.options.useExtendedSearch,this._keyStore=new G(this.options.keys),this.setCollection(e,n)}setCollection(e,t){if(this._docs=e,t&&!(t instanceof Q))throw new Error("Incorrect 'index' type");this._myIndex=t||ee(this.options.keys,this._docs,{getFn:this.options.getFn,fieldNormWeight:this.options.fieldNormWeight})}add(e){q(e)&&(this._docs.push(e),this._myIndex.add(e))}remove(e=()=>!1){const t=[];for(let n=0,r=this._docs.length;n<r;n+=1){const o=this._docs[n];e(o,n)&&(this.removeAt(n),n-=1,r-=1,t.push(o))}return t}removeAt(e){this._docs.splice(e,1),this._myIndex.removeAt(e)}getIndex(){return this._myIndex}search(e,{limit:t=-1}={}){const{includeMatches:n,includeScore:r,shouldSort:o,sortFn:i,ignoreFieldNorm:a}=this.options;let s=B(e)?B(this._docs[0])?this._searchStringList(e):this._searchObjectList(e):this._searchLogical(e);return function(e,{ignoreFieldNorm:t=K.ignoreFieldNorm}){e.forEach(e=>{let n=1;e.matches.forEach(({key:e,norm:r,score:o})=>{const i=e?e.weight:null;n*=Math.pow(0===o&&i?Number.EPSILON:o,(i||1)*(t?1:r))}),e.score=n})}(s,{ignoreFieldNorm:a}),o&&s.sort(i),j(t)&&t>-1&&(s=s.slice(0,t)),function(e,t,{includeMatches:n=K.includeMatches,includeScore:r=K.includeScore}={}){const o=[];return n&&o.push(Ee),r&&o.push(ke),e.map(e=>{const{idx:n}=e,r={item:t[n],refIndex:n};return o.length&&o.forEach(t=>{t(e,r)}),r})}(s,this._docs,{includeMatches:n,includeScore:r})}_searchStringList(e){const t=ve(e,this.options),{records:n}=this._myIndex,r=[];return n.forEach(({v:e,i:n,n:o})=>{if(!q(e))return;const{isMatch:i,score:a,indices:s}=t.searchIn(e);i&&r.push({item:e,idx:n,matches:[{score:a,value:e,norm:o,indices:s}]})}),r}_searchLogical(e){const t=_e(e,this.options),n=(e,t,r)=>{if(!e.children){const{keyId:n,searcher:o}=e,i=this._findMatches({key:this._keyStore.get(n),value:this._myIndex.getValueForItemAtKeyId(t,n),searcher:o});return i&&i.length?[{idx:r,item:t,matches:i}]:[]}const o=[];for(let i=0,a=e.children.length;i<a;i+=1){const a=e.children[i],s=n(a,t,r);if(s.length)o.push(...s);else if(e.operator===ye)return[]}return o},r=this._myIndex.records,o={},i=[];return r.forEach(({$:e,i:r})=>{if(q(e)){let a=n(t,e,r);a.length&&(o[r]||(o[r]={idx:r,item:e,matches:[]},i.push(o[r])),a.forEach(({matches:e})=>{o[r].matches.push(...e)}))}}),i}_searchObjectList(e){const t=ve(e,this.options),{keys:n,records:r}=this._myIndex,o=[];return r.forEach(({$:e,i:r})=>{if(!q(e))return;let i=[];n.forEach((n,r)=>{i.push(...this._findMatches({key:n,value:e[r],searcher:t}))}),i.length&&o.push({idx:r,item:e,matches:i})}),o}_findMatches({key:e,value:t,searcher:n}){if(!q(t))return[];let r=[];if(M(t))t.forEach(({v:t,i:o,n:i})=>{if(!q(t))return;const{isMatch:a,score:s,indices:l}=n.searchIn(t);a&&r.push({score:s,key:e,value:t,idx:o,norm:i,indices:l})});else{const{v:o,n:i}=t,{isMatch:a,score:s,indices:l}=n.searchIn(o);a&&r.push({score:s,key:e,value:o,norm:i,indices:l})}return r}}function De(e,t={}){const n="string"==typeof e?document.querySelector(e):e;if(!n)throw new Error(`Could not find container: ${e}`);const r=t.placeholderText||"Select items...",o=t.closeOnSelect??!1,i=t.enableSearch??!1,a=t.multiple??!0,s=t.searchPlaceholderText||"Search...",l=t.searchNoResultsText||"No results found",c=t.searchDebounceMs??200;let u=[...t.initialList||[]];n.innerHTML="",n.classList.add("fancy-dropdown-container"),Object.assign(n.style,{position:"relative",userSelect:"none"});const p=document.createElement("div");p.className="fancy-dropdown-trigger",Object.assign(p.style,{padding:"8px 12px",border:"1px solid var(--border-color)",backgroundColor:"var(--bg-color)",color:"var(--text-color)",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"space-between"});const d=document.createElement("span");d.className="fancy-dropdown-trigger-text",d.textContent=r;const h=document.createElement("i");h.className="fas fa-chevron-down",h.style.marginLeft="8px",p.append(d,h),n.append(p);const f=document.createElement("div");f.className="fancy-dropdown-list",Object.assign(f.style,{position:"absolute",top:"100%",left:"0",right:"0",maxHeight:"300px",display:"none",zIndex:"1050",border:"1px solid var(--border-color)",borderTop:"none",backgroundColor:"var(--bg-color-popup, var(--bg-color-secondary, var(--greyCAIbg, var(--grey30))))",color:"var(--text-color)",borderRadius:"0 0 4px 4px",boxShadow:"0 4px 8px var(--black50a)",overflowY:"auto"}),n.append(f);let m=null,g=null,v=null,y=null;i&&(g=document.createElement("div"),g.className="fancy-dropdown-search-wrapper",Object.assign(g.style,{padding:"8px",borderBottom:"1px solid var(--border-color)",position:"sticky",top:"0",backgroundColor:"inherit"}),m=document.createElement("input"),m.type="text",m.className="fancy-dropdown-search-input",m.placeholder=s,Object.assign(m.style,{width:"100%",padding:"6px 10px",border:"1px solid var(--border-color)",borderRadius:"3px",boxSizing:"border-box",backgroundColor:"var(--bg-color)",color:"var(--text-color)"}),m.addEventListener("click",e=>e.stopPropagation()),g.append(m),f.append(g),v=document.createElement("div"),v.className="fancy-dropdown-no-results",v.textContent=l,Object.assign(v.style,{padding:"8px 12px",textAlign:"center",color:"var(--text-color-secondary, var(--grey50))",display:"none"}),f.append(v));let b=!1,S=null;const x=e=>"string"==typeof e?e:e.label,w=e=>"string"==typeof e?e:e.value;let C=(t.initialValues||[]).filter(e=>u.some(t=>w(t)===e));const _=()=>{if(!i)return;const e={includeScore:!1,threshold:.4,isCaseSensitive:!1,findAllMatches:!0,...t.searchFuseOptions||{},keys:t.searchFuseOptions?.keys||[{name:"label",weight:.7},{name:"value",weight:.3}]},n=u.map(e=>"string"==typeof e?{value:e,label:e}:e);!t.searchFuseOptions?.keys&&u.every(e=>"string"==typeof e)&&(e.keys=["label"]),S=new Pe(n,e)},E=e=>{let t=!1;f.querySelectorAll(".fancy-dropdown-item").forEach(n=>{const r=n.dataset.value,o=C.includes(r),i=n.querySelector(".checkmark");o?(n.classList.add("selected"),i&&(i.style.display="inline-block")):(n.classList.remove("selected"),i&&(i.style.display="none")),void 0!==e?e.includes(r)?(n.style.display="flex",t=!0):n.style.display="none":(n.style.display="flex",t=!0)}),i&&v&&(v.style.display=void 0===e||t?"none":"block"),(()=>{if(0===C.length)d.textContent=r;else if(1===C.length){const e=C[0],t=u.find(t=>w(t)===e),n=t?x(t):e;d.textContent=n}else d.textContent=`${C.length} items selected`})()},k=e=>{if(!i||!S)return void E();const t=e.trim();if(""===t)return void E(void 0);const n=S.search(t).map(e=>e.item.value);E(n)},P=()=>{m&&(y&&clearTimeout(y),y=window.setTimeout(()=>{m&&k(m.value)},c))},D=()=>{b||(b=!0,f.style.display="block",h.classList.remove("fa-chevron-down"),h.classList.add("fa-chevron-up"),i&&m&&setTimeout(()=>m?.focus(),50))},T=()=>{b&&(b=!1,f.style.display="none",i&&m&&(m.value="",k("")),h.classList.remove("fa-chevron-up"),h.classList.add("fa-chevron-down"),y&&clearTimeout(y))};p.addEventListener("click",e=>{e.stopPropagation(),b?T():D()}),document.addEventListener("click",e=>{b&&n&&!n.contains(e.target)&&T()}),i&&m&&m.addEventListener("input",P);const I=(e,n)=>{const r=w(e),s=x(e),l=document.createElement("div");l.className="fancy-dropdown-item",l.dataset.value=r,Object.assign(l.style,{padding:"8px 12px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"space-between"}),l.addEventListener("mouseenter",()=>{l.style.backgroundColor="var(--hover-color, var(--white20a))"}),l.addEventListener("mouseleave",()=>{l.style.backgroundColor=""});const c=document.createElement("span");c.textContent=s,l.append(c);const u=document.createElement("i");return u.className="checkmark fa-solid fa-check",Object.assign(u.style,{marginLeft:"8px",display:n?"inline-block":"none"}),l.append(u),l.addEventListener("click",function(e){e.stopPropagation();const n=e.currentTarget.dataset.value,r=[...C];let s;s=a?C.includes(n)?C.filter(e=>e!==n):[...C,n]:C.includes(n)?[]:[n];(async()=>{if(t.onBeforeSelection)try{if(!await Promise.resolve(t.onBeforeSelection(r,s)))return!1}catch(e){return console.error("onBeforeSelection callback failed:",e),!1}return!0})().then(e=>{e&&(C=s,i&&m&&""!==m.value.trim()?k(m.value):E(void 0),t.onSelectChange&&Promise.resolve(t.onSelectChange(r,C)).catch(e=>console.error("onSelectChange callback failed:",e)),o&&T())})}),v?f.insertBefore(l,v):f.append(l),l};u.length>0&&u.forEach(e=>{const t=w(e);I(e,C.includes(t))}),_(),E();return{container:n,dropdownTrigger:p,dropdownList:f,getValues:()=>[...C],setValues:e=>{const n=[...C],r=e.filter(e=>u.some(t=>w(t)===e));C=[...r],i&&m&&""!==m.value?(m.value="",k("")):E();JSON.stringify(n.sort())!==JSON.stringify(C.sort())&&t.onSelectChange&&Promise.resolve(t.onSelectChange(n,C)).catch(e=>console.error("onSelectChange callback failed:",e))},getOptions:()=>u.map(e=>"string"==typeof e?{value:e,label:e}:e),addOption:(e,n=!1)=>{const r=w(e);if(u.some(e=>w(e)===r))return;u.push(e),I(e,n),_();let o=!1;const s=[...C];n&&!C.includes(r)?(a?C.push(r):C=[r],o=!0):n&&!a&&C.length>0&&C[0]!==r&&(C=[r],o=!0),i&&m&&""!==m.value?k(m.value):E(),o&&t.onSelectChange&&Promise.resolve(t.onSelectChange(s,C)).catch(e=>console.error("onSelectChange callback failed:",e))},removeOption:e=>{const n=u.length;if(u=u.filter(t=>w(t)!==e),u.length===n)return;let r=!1;const o=[...C],a=C.indexOf(e);a>-1&&(C.splice(a,1),r=!0);const s=f.querySelector(`.fancy-dropdown-item[data-value="${e}"]`);s?.remove(),_(),i&&m&&""!==m.value?k(m.value):E(),r&&t.onSelectChange&&Promise.resolve(t.onSelectChange(o,C)).catch(e=>console.error("onSelectChange callback failed:",e))},selectAll:()=>{if(!a)return;const e=[...C],n=u.map(w);C=[...new Set([...C,...n])];const r=JSON.stringify(e.sort())!==JSON.stringify(C.sort());i&&m&&""!==m.value?k(m.value):E(),r&&t.onSelectChange&&Promise.resolve(t.onSelectChange(e,C)).catch(e=>console.error("onSelectChange callback failed:",e))},deselectAll:()=>{const e=[...C];C.length>0&&(C=[],i&&m&&""!==m.value?k(m.value):E(),t.onSelectChange&&Promise.resolve(t.onSelectChange(e,C)).catch(e=>console.error("onSelectChange callback failed:",e)))},disable:()=>{n.style.pointerEvents="none",n.style.opacity="0.6",b&&T()},enable:()=>{n.style.pointerEvents="auto",n.style.opacity="1"},open:D,close:T,toggle:()=>b?T():D()}}async function Te(e,t,{escapeHtml:n=!0}={}){await async function(e,...t){await SillyTavern.getContext().SlashCommandParser.commands[e].callback(...t)}("echo",{severity:e,escapeHtml:Boolean(n).toString()},t)}function Ie(e){return s(e)}function Ae(e,t){return u(e,t)}function Ne(e,t,r){return n(e,t,r)}function Oe(e){return x(e)}function Fe(e,{wiFormat:t}={}){return b(e,{wiFormat:t})}function Le(e){return S(e)}function Me(e,t={}){const n=SillyTavern.getContext(),r=t.readOnlyValues||[],o=document.querySelector(e);if(!o)throw new Error(`Could not find preset select: ${e}`);const i=e=>t.label?t.label(e):e,a=document.createElement("div");a.className="preset-select-container",a.style.display="flex",a.style.alignItems="center";const s=e=>r.includes(e);if(o.parentNode?.insertBefore(a,o),a.appendChild(o),t.initialList&&t.initialList.length>0){o.innerHTML="";const e=e=>"string"==typeof e?e:e.value;for(const n of t.initialList){const t=document.createElement("option"),r=e(n);t.value=r,t.textContent=i(r),s(r)&&(t.dataset.readonly="true"),o.appendChild(t)}}if(t.initialValue){const e=Array.from(o.options).find(e=>e.value===t.initialValue);e&&(o.value=e.value)}let l=o.value;if(o.addEventListener("change",async()=>{const e=o.value;t.onSelectChange&&l!==e&&await t.onSelectChange(l,e),l=e}),t.create){const e=document.createElement("i");e.className="menu_button fa-solid fa-file-circle-plus";const r=i("");e.title=`Create a new ${r}`,e.setAttribute("data-i18n",`[title]Create a new ${r}`),e.addEventListener("click",async()=>{t.create?.onPopupOpen&&await t.create.onPopupOpen();const e=i(""),r=await n.Popup.show.input(`Create a new ${e}`,`Please enter a name for the new ${e}:`,"");if(null===r||""===r.trim())return;let a=r.trim();if(Array.from(o.options).some(e=>e.value===a))return void await Te("warning",`A ${i(a)} with this name already exists.`);if(t.create?.onBeforeCreate){if(!await t.create.onBeforeCreate(a))return}if(t.create?.onAfterCreate){const e=await t.create.onAfterCreate(a);"string"==typeof e&&(a=e)}const s=document.createElement("option");s.value=a,s.textContent=i(a),o.appendChild(s);const c=o.value;o.value=a,t.onSelectChange&&c!==a&&await t.onSelectChange(c,a),l=a}),a.appendChild(e)}if(t.rename){const e=document.createElement("i");e.className="menu_button fa-solid fa-pencil";const r=i("");e.title=`Rename a ${r}`,e.setAttribute("data-i18n",`[title]Rename a ${r}`),e.addEventListener("click",async()=>{if(-1===o.selectedIndex)return void await Te("warning",`Please select a ${i("")} to rename.`);const e=o.options[o.selectedIndex];let r=e.value;if(s(r))return void await Te("warning",`This ${i(r)} cannot be renamed as it is read-only.`);t.rename?.onPopupOpen&&await t.rename.onPopupOpen();const a=await n.Popup.show.input(`Rename ${i(r)}`,`Please enter a new name for "${r}":`,r);if(null===a||""===a.trim()||a===r)return;let c=a.trim();if(Array.from(o.options).some(t=>t.value===c&&t!==e))await Te("warning",`A ${i(c)} with this name already exists.`);else{if(t.rename?.onBeforeRename){if(!await t.rename.onBeforeRename(r,c))return}if(t.rename?.onAfterRename){const e=await t.rename.onAfterRename(r,c);"string"==typeof e&&(c=e)}e.value=c,e.textContent=i(c),r===l&&(l=c),t.onSelectChange&&o.value===c&&await t.onSelectChange(r,c)}}),a.appendChild(e)}if(t.delete){const e=document.createElement("i");e.className="menu_button fa-solid fa-trash-can";const r=i("");e.title=`Delete a ${r}`,e.setAttribute("data-i18n",`[title]Delete a ${r}`),e.addEventListener("click",async()=>{if(-1===o.selectedIndex)return void await Te("warning",`Please select a ${i("")} to delete.`);const e=o.options[o.selectedIndex],r=e.value,a=o.selectedIndex;if(s(r))return void await Te("warning",`This ${i(r)} cannot be deleted as it is read-only.`);t.delete?.onPopupOpen&&await t.delete.onPopupOpen();if(!await n.Popup.show.confirm(`Delete ${i(r)}`,`Are you sure you want to delete "${r}"?`))return;if(t.delete?.onBeforeDelete){if(!await t.delete.onBeforeDelete(r))return}const c=r;let u,p=-1;o.options.length>1&&(p=a<o.options.length-1?a:a-1,u=o.options[p].value),o.removeChild(e),p>=0?(o.selectedIndex=p,l=u,t.onSelectChange&&await t.onSelectChange(c,u)):(t.onSelectChange&&await t.onSelectChange(c,void 0),l=void 0),t.delete?.onAfterDelete&&await t.delete.onAfterDelete(c)}),a.appendChild(e)}return{select:o,container:a}}Pe.version="7.1.0",Pe.createIndex=ee,Pe.parseIndex=function(e,{getFn:t=K.getFn,fieldNormWeight:n=K.fieldNormWeight}={}){const{keys:r,records:o}=e,i=new Q({getFn:t,fieldNormWeight:n});return i.setKeys(r),i.setIndexRecords(o),i},Pe.config=K,Pe.parseQuery=_e,function(...e){ge.push(...e)}(me);class Be{encode(e){const t=Math.ceil(e.length/4);return new Array(t).fill(" ")}decode(e){return e.join("")}}class je{messages=[];tokenizer;maxContext;currentTokenCount=0;constructor(e){this.tokenizer=new Be,this.maxContext=e}getTokenCount(e){return e.content?e.source?.extra?.token_count??this.tokenizer.encode(e.content).length:0}canFit(e){return this.currentTokenCount+this.getTokenCount(e)<=this.maxContext}add(e){if(!e.content)return!0;const t=this.getTokenCount(e);return!(this.currentTokenCount+t>this.maxContext)&&(this.messages.push(e),this.currentTokenCount+=t,!0)}addFront(e){if(!e.content)return!0;const t=this.getTokenCount(e);return!(this.currentTokenCount+t>this.maxContext)&&(this.messages.unshift(e),this.currentTokenCount+=t,!0)}addMany(e){let t=0;const n=e.filter(e=>{if(!e.content)return!0;const n=this.getTokenCount(e);return!(this.currentTokenCount+t+n>this.maxContext)&&(t+=n,!0)});return n.length>0&&(this.messages.push(...n),this.currentTokenCount+=t),n.length===e.length}insert(e,t){if(!t.content)return!0;const n=this.getTokenCount(t);return!(this.currentTokenCount+n>this.maxContext)&&(this.messages.splice(e,0,t),this.currentTokenCount+=n,!0)}getMessages(){return this.messages}}async function Re(n,{targetCharacterId:s,presetName:u,instructName:d,contextName:m,syspromptName:b,maxContext:S,includeNames:x,ignoreCharacterFields:I,ignoreAuthorNote:A,ignoreWorldInfo:N,messageIndexesBetween:O}={}){if(!["textgenerationwebui","openai"].includes(n))throw new Error("Unsupported API");const F=SillyTavern.getContext();let{description:L,personality:M,persona:B,scenario:j,mesExamples:R,system:$,jailbreak:H}=I?{description:"",personality:"",persona:"",scenario:"",mesExamples:"",system:"",jailbreak:""}:F.getCharacterCardFields({chid:s});const q="textgenerationwebui"===n?F.getPresetManager("instruct")?.getCompletionPresetByName(d):void 0,V=!!q?.enabled;let U=Ae(R,V);let W=[];const G=function(){if("number"==typeof S)return S;if(!S)return Ie();if("active"===S||!u)return Ie();if("number"==typeof S)return S;let e;if("textgenerationwebui"===n){const t=F.getPresetManager("textgenerationwebui")?.getCompletionPresetByName(u);e=t?.max_length}else{const t=F.getPresetManager("openai")?.getCompletionPresetByName(u);e=t?.openai_max_context}return"number"==typeof e?e:Ie()}();if(G<=0)return{result:[],warnings:W};const Y=new je(G),X=F.ToolManager.isToolCallingSupported(),z=O?.start??0,J=O?.end?O.end+1:void 0;let K=-1===z&&0===J?[]:F.chat.slice(z,J).filter(e=>!e.is_system||X&&Array.isArray(e.extra?.tool_invocations));K=await Promise.all(K.map(async(e,t)=>{let n=function(e,t,{characterOverride:n,isMarkdown:r,isPrompt:o,isEdit:i,depth:a}){return D(e,t,{characterOverride:n,isMarkdown:r,isPrompt:o,isEdit:i,depth:a})}(e.mes,e.is_user?T.USER_INPUT:T.AI_OUTPUT,{isPrompt:!0,depth:K.length-t-1});return n=await async function(e,t){return await y(e,t)}(e,n),e?.extra?.append_title&&e?.extra?.title&&(n=`${n}\n\n${e.extra.title}`),{...e,mes:n,index:t}}));const Z=K.map(e=>f?`${e.name}: ${e.mes}`:e.mes).reverse(),{worldInfoString:Q,worldInfoBefore:ee,worldInfoAfter:te,worldInfoExamples:ne,worldInfoDepth:re,anBefore:oe,anAfter:ie}=N?{worldInfoString:"",worldInfoBefore:"",worldInfoAfter:"",worldInfoExamples:[],worldInfoDepth:[],anBefore:[],anAfter:[]}:await F.getWorldInfoPrompt(Z,G,!1);for(const de of ne){const he=de.content;if(0===he.length)continue;const fe=Ae(Ne(he,l,c),V);de.position===h.before?U.unshift(...fe):U.push(...fe)}function ae(){const e=[];for(let t=K.length-1;t>=0;t--){const n=K[t];e.unshift({role:n.is_user?"user":"assistant",content:x?`${n.name}: ${n.mes}`:n.mes,source:n})}Y.addMany(e)}if("textgenerationwebui"===n){const me=[...U];U&&(U=function(e,t,n){return g(e,t,n)}(U,l,c));const ge=F.getPresetManager("sysprompt")?.getCompletionPresetByName(b);ge&&($=F.powerUserSettings.prefer_character_prompt&&$?$:Ne(ge.content,l,c),$=V?(se=F.substituteParams($,l,c,ge.content),v(se,q)):$);const ve={description:L,personality:M,persona:F.powerUserSettings.persona_description_position==e.IN_PROMPT?B:"",scenario:j,system:$,char:c,user:l,wiBefore:ee,wiAfter:te,loreBefore:ee,loreAfter:te,mesExamples:U.join(""),mesExamplesRaw:me.join("")},ye=F.getPresetManager("context")?.getCompletionPresetByName(m);let be=function(e,{customStoryString:n,customInstructSettings:r}={}){return t(e,{customStoryString:n,customInstructSettings:r})}(ve,{customInstructSettings:q,customStoryString:ye?.story_string});Y.add({role:"system",content:be,ignoreInstruct:!0}),ae()}else{let Se=_(K),xe=function(e){return C(e)}(U);async function we(){let[e,t]=await function({name2:e,charDescription:t,charPersonality:n,Scenario:r,worldInfoBefore:o,worldInfoAfter:i,bias:a,type:s,quietPrompt:l,quietImage:c,extensionPrompts:u,cyclePrompt:p,systemPromptOverride:d,jailbreakPromptOverride:h,personaDescription:f,messages:m,messageExamples:g},v){return w({name2:e,charDescription:t,charPersonality:n,Scenario:r,worldInfoBefore:o,worldInfoAfter:i,bias:a,type:s,quietPrompt:l,quietImage:c,cyclePrompt:p,systemPromptOverride:d,jailbreakPromptOverride:h,personaDescription:f,extensionPrompts:u,messages:m,messageExamples:g},v)}({name2:c,charDescription:L,charPersonality:M,Scenario:j,worldInfoBefore:ee,worldInfoAfter:te,extensionPrompts:F.extensionPrompts,bias:"",type:"normal",quietPrompt:void 0,quietImage:void 0,cyclePrompt:"",systemPromptOverride:$,jailbreakPromptOverride:H,personaDescription:B,messages:Se,messageExamples:xe},!1);Y.addMany(e)}if(!u)return W.push("No preset name provided. Using default preset."),await we(),{result:Y.getMessages(),warnings:W};const Ce=F.getPresetManager("openai")?.getCompletionPresetByName(u);if(!Ce)return console.warn(`Preset not found: ${u}. Using current preset.`),W.push(`Preset not found: ${u}. Using current preset.`),we(),{result:Y.getMessages(),warnings:W};let _e=Ce.prompt_order?.find(e=>e.character_id===p);if(!_e&&Ce.prompt_order&&Ce.prompt_order.length>0&&(_e=Ce.prompt_order[0]),!_e)return console.warn(`No prompt order found for preset: ${u}. Using current preset.`),W.push(`No prompt order found for preset: ${u}. Using current preset.`),we(),{result:Y.getMessages(),warnings:W};const Ee=j&&Ce.scenario_format?F.substituteParams(Ce.scenario_format):"",ke=M&&Ce.personality_format?F.substituteParams(Ce.personality_format):"",Pe=F.substituteParams(Ce.group_nudge_prompt),De=Ce.impersonation_prompt?F.substituteParams(Ce.impersonation_prompt):"",Te=[];N||Te.push({role:"system",content:Fe(ee,{wiFormat:Ce.wi_format}),identifier:"worldInfoBefore"},{role:"system",content:Fe(te,{wiFormat:Ce.wi_format}),identifier:"worldInfoAfter"}),I||Te.push({role:"system",content:L,identifier:"charDescription"},{role:"system",content:ke,identifier:"charPersonality"},{role:"system",content:Ee,identifier:"scenario"}),Te.push({role:"system",content:De,identifier:"impersonate"},{role:"system",content:Pe,identifier:"groupNudge"});const Me=F.extensionPrompts["1_memory"];Me&&Me.value&&Te.push({role:Oe(Me.role),content:Me.value,identifier:"summary",position:Le(Me.position)});const Be=F.extensionPrompts["2_floating_prompt"];!A&&Be&&Be.value&&Te.push({role:Oe(Be.role),content:Be.value,identifier:"authorsNote",position:Le(Be.position)});const Re=F.extensionPrompts["3_vectors"];Re&&Re.value&&Te.push({role:"system",content:Re.value,identifier:"vectorsMemory",position:Le(Re.position)});const $e=F.extensionPrompts["4_vectors_data_bank"];$e&&$e.value&&Te.push({role:Oe($e.role),content:$e.value,identifier:"vectorsDataBank",position:Le($e.position)});const He=F.extensionPrompts.chromadb;function qe(e){const t=Te.find(t=>t.identifier===e);if(t)return t;const n=Ce.prompts.find(t=>t.identifier===e);return n||void 0}He&&He.value&&Te.push({role:"system",content:He.value,identifier:"smartContext",position:Le(He.position)}),!I&&F.powerUserSettings.persona_description&&F.powerUserSettings.persona_description_position===e.IN_PROMPT&&Te.push({role:"system",content:F.powerUserSettings.persona_description,identifier:"personaDescription"}),_e.order.forEach(e=>{if(!e.enabled)return;const t=qe(e.identifier);t&&t.content?Y.add({role:t.role??"system",content:F.substituteParams(t.content)}):"chatHistory"===e.identifier&&ae()})}var se;const le=["1_memory","2_floating_prompt","3_vectors","4_vectors_data_bank","chromadb","PERSONA_DESCRIPTION","QUIET_PROMPT","DEPTH_PROMPT"];for(const Ve in F.extensionPrompts)if(Object.hasOwn(F.extensionPrompts,Ve)){const Ue=F.extensionPrompts[Ve];if(le.includes(Ve))continue;if(!F.extensionPrompts[Ve].value)continue;if(![a.BEFORE_PROMPT,a.IN_PROMPT].includes(Ue.position))continue;if("function"==typeof Ue.filter&&!await Ue.filter())continue;const We={role:Oe(Ue.role)??"system",content:Ue.value};if(Ue.position===a.BEFORE_PROMPT)Y.insert(Ue.depth,We);else if(Ue.position===a.IN_PROMPT){const Ge=Y.getMessages();Y.insert(Ge.length-Ue.depth,We)}}for(const Ye of re){const Xe=Y.getMessages();Y.insert(Xe.length-Ye.depth,{role:Oe(Ye.role),content:Ye.entries.join("\n")})}if(!I){const ze=(ce=P,ue=Number(p),k(ce,ue));if(P&&Array.isArray(ze)&&ze.length>0)ze.filter(e=>e.text).forEach((e,t)=>{const n=Y.getMessages();Y.insert(n.length-e.depth,{role:e.role,content:e.text})});else{const Je=Ne(F.characters[p]?.data?.extensions?.depth_prompt?.prompt?.trim(),l,c)||"";if(Je){const Ke=o,Ze=F.characters[p]?.data?.extensions?.depth_prompt?.role??i,Qe=Y.getMessages();Y.insert(Qe.length-Ke,{role:Oe(Ze),content:Je})}}}var ce,ue;let pe=-1;if(!A){const et={prompt:r[E.prompt],interval:r[E.interval],position:r[E.position],depth:r[E.depth],role:r[E.role]};if(et.prompt){et.prompt=Ne(et.prompt,l,c);const tt={role:Oe(et.role),content:et.prompt};switch(et.position){case a.IN_PROMPT:Y.insert(1,tt),pe=1;break;case a.IN_CHAT:pe=Y.getMessages().length-et.depth,Y.insert(pe,tt);break;case a.BEFORE_PROMPT:Y.addFront(tt),pe=0}}}return pe>=0&&(oe.length>0&&(Y.insert(pe,{role:"system",content:oe.join("\n")}),pe++),ie.length>0&&Y.insert(pe+1,{role:"system",content:ie.join("\n")})),{result:Y.getMessages(),warnings:W}}
/**!
 * Sortable 1.15.6
 * @author	RubaXa   <trash@rubaxa.org>
 * @author	owenm    <owen23355@gmail.com>
 * @license MIT
 */
function $e(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function He(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?$e(Object(n),!0).forEach(function(t){Ve(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):$e(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function qe(e){return qe="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},qe(e)}function Ve(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Ue(){return Ue=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},Ue.apply(this,arguments)}function We(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}function Ge(e){if("undefined"!=typeof window&&window.navigator)return!!navigator.userAgent.match(e)}var Ye=Ge(/(?:Trident.*rv[ :]?11\.|msie|iemobile|Windows Phone)/i),Xe=Ge(/Edge/i),ze=Ge(/firefox/i),Je=Ge(/safari/i)&&!Ge(/chrome/i)&&!Ge(/android/i),Ke=Ge(/iP(ad|od|hone)/i),Ze=Ge(/chrome/i)&&Ge(/android/i),Qe={capture:!1,passive:!1};function et(e,t,n){e.addEventListener(t,n,!Ye&&Qe)}function tt(e,t,n){e.removeEventListener(t,n,!Ye&&Qe)}function nt(e,t){if(t){if(">"===t[0]&&(t=t.substring(1)),e)try{if(e.matches)return e.matches(t);if(e.msMatchesSelector)return e.msMatchesSelector(t);if(e.webkitMatchesSelector)return e.webkitMatchesSelector(t)}catch(e){return!1}return!1}}function rt(e){return e.host&&e!==document&&e.host.nodeType?e.host:e.parentNode}function ot(e,t,n,r){if(e){n=n||document;do{if(null!=t&&(">"===t[0]?e.parentNode===n&&nt(e,t):nt(e,t))||r&&e===n)return e;if(e===n)break}while(e=rt(e))}return null}var it,at=/\s+/g;function st(e,t,n){if(e&&t)if(e.classList)e.classList[n?"add":"remove"](t);else{var r=(" "+e.className+" ").replace(at," ").replace(" "+t+" "," ");e.className=(r+(n?" "+t:"")).replace(at," ")}}function lt(e,t,n){var r=e&&e.style;if(r){if(void 0===n)return document.defaultView&&document.defaultView.getComputedStyle?n=document.defaultView.getComputedStyle(e,""):e.currentStyle&&(n=e.currentStyle),void 0===t?n:n[t];t in r||-1!==t.indexOf("webkit")||(t="-webkit-"+t),r[t]=n+("string"==typeof n?"":"px")}}function ct(e,t){var n="";if("string"==typeof e)n=e;else do{var r=lt(e,"transform");r&&"none"!==r&&(n=r+" "+n)}while(!t&&(e=e.parentNode));var o=window.DOMMatrix||window.WebKitCSSMatrix||window.CSSMatrix||window.MSCSSMatrix;return o&&new o(n)}function ut(e,t,n){if(e){var r=e.getElementsByTagName(t),o=0,i=r.length;if(n)for(;o<i;o++)n(r[o],o);return r}return[]}function pt(){var e=document.scrollingElement;return e||document.documentElement}function dt(e,t,n,r,o){if(e.getBoundingClientRect||e===window){var i,a,s,l,c,u,p;if(e!==window&&e.parentNode&&e!==pt()?(a=(i=e.getBoundingClientRect()).top,s=i.left,l=i.bottom,c=i.right,u=i.height,p=i.width):(a=0,s=0,l=window.innerHeight,c=window.innerWidth,u=window.innerHeight,p=window.innerWidth),(t||n)&&e!==window&&(o=o||e.parentNode,!Ye))do{if(o&&o.getBoundingClientRect&&("none"!==lt(o,"transform")||n&&"static"!==lt(o,"position"))){var d=o.getBoundingClientRect();a-=d.top+parseInt(lt(o,"border-top-width")),s-=d.left+parseInt(lt(o,"border-left-width")),l=a+i.height,c=s+i.width;break}}while(o=o.parentNode);if(r&&e!==window){var h=ct(o||e),f=h&&h.a,m=h&&h.d;h&&(l=(a/=m)+(u/=m),c=(s/=f)+(p/=f))}return{top:a,left:s,bottom:l,right:c,width:p,height:u}}}function ht(e,t,n){for(var r=yt(e,!0),o=dt(e)[t];r;){var i=dt(r)[n];if(!("top"===n||"left"===n?o>=i:o<=i))return r;if(r===pt())break;r=yt(r,!1)}return!1}function ft(e,t,n,r){for(var o=0,i=0,a=e.children;i<a.length;){if("none"!==a[i].style.display&&a[i]!==_n.ghost&&(r||a[i]!==_n.dragged)&&ot(a[i],n.draggable,e,!1)){if(o===t)return a[i];o++}i++}return null}function mt(e,t){for(var n=e.lastElementChild;n&&(n===_n.ghost||"none"===lt(n,"display")||t&&!nt(n,t));)n=n.previousElementSibling;return n||null}function gt(e,t){var n=0;if(!e||!e.parentNode)return-1;for(;e=e.previousElementSibling;)"TEMPLATE"===e.nodeName.toUpperCase()||e===_n.clone||t&&!nt(e,t)||n++;return n}function vt(e){var t=0,n=0,r=pt();if(e)do{var o=ct(e),i=o.a,a=o.d;t+=e.scrollLeft*i,n+=e.scrollTop*a}while(e!==r&&(e=e.parentNode));return[t,n]}function yt(e,t){if(!e||!e.getBoundingClientRect)return pt();var n=e,r=!1;do{if(n.clientWidth<n.scrollWidth||n.clientHeight<n.scrollHeight){var o=lt(n);if(n.clientWidth<n.scrollWidth&&("auto"==o.overflowX||"scroll"==o.overflowX)||n.clientHeight<n.scrollHeight&&("auto"==o.overflowY||"scroll"==o.overflowY)){if(!n.getBoundingClientRect||n===document.body)return pt();if(r||t)return n;r=!0}}}while(n=n.parentNode);return pt()}function bt(e,t){return Math.round(e.top)===Math.round(t.top)&&Math.round(e.left)===Math.round(t.left)&&Math.round(e.height)===Math.round(t.height)&&Math.round(e.width)===Math.round(t.width)}function St(e,t){return function(){if(!it){var n=arguments;1===n.length?e.call(this,n[0]):e.apply(this,n),it=setTimeout(function(){it=void 0},t)}}}function xt(e,t,n){e.scrollLeft+=t,e.scrollTop+=n}function wt(e){var t=window.Polymer,n=window.jQuery||window.Zepto;return t&&t.dom?t.dom(e).cloneNode(!0):n?n(e).clone(!0)[0]:e.cloneNode(!0)}function Ct(e,t,n){var r={};return Array.from(e.children).forEach(function(o){var i,a,s,l;if(ot(o,t.draggable,e,!1)&&!o.animated&&o!==n){var c=dt(o);r.left=Math.min(null!==(i=r.left)&&void 0!==i?i:1/0,c.left),r.top=Math.min(null!==(a=r.top)&&void 0!==a?a:1/0,c.top),r.right=Math.max(null!==(s=r.right)&&void 0!==s?s:-1/0,c.right),r.bottom=Math.max(null!==(l=r.bottom)&&void 0!==l?l:-1/0,c.bottom)}}),r.width=r.right-r.left,r.height=r.bottom-r.top,r.x=r.left,r.y=r.top,r}var _t="Sortable"+(new Date).getTime();function Et(){var e,t=[];return{captureAnimationState:function(){(t=[],this.options.animation)&&[].slice.call(this.el.children).forEach(function(e){if("none"!==lt(e,"display")&&e!==_n.ghost){t.push({target:e,rect:dt(e)});var n=He({},t[t.length-1].rect);if(e.thisAnimationDuration){var r=ct(e,!0);r&&(n.top-=r.f,n.left-=r.e)}e.fromRect=n}})},addAnimationState:function(e){t.push(e)},removeAnimationState:function(e){t.splice(function(e,t){for(var n in e)if(e.hasOwnProperty(n))for(var r in t)if(t.hasOwnProperty(r)&&t[r]===e[n][r])return Number(n);return-1}(t,{target:e}),1)},animateAll:function(n){var r=this;if(!this.options.animation)return clearTimeout(e),void("function"==typeof n&&n());var o=!1,i=0;t.forEach(function(e){var t=0,n=e.target,a=n.fromRect,s=dt(n),l=n.prevFromRect,c=n.prevToRect,u=e.rect,p=ct(n,!0);p&&(s.top-=p.f,s.left-=p.e),n.toRect=s,n.thisAnimationDuration&&bt(l,s)&&!bt(a,s)&&(u.top-s.top)/(u.left-s.left)===(a.top-s.top)/(a.left-s.left)&&(t=function(e,t,n,r){return Math.sqrt(Math.pow(t.top-e.top,2)+Math.pow(t.left-e.left,2))/Math.sqrt(Math.pow(t.top-n.top,2)+Math.pow(t.left-n.left,2))*r.animation}(u,l,c,r.options)),bt(s,a)||(n.prevFromRect=a,n.prevToRect=s,t||(t=r.options.animation),r.animate(n,u,s,t)),t&&(o=!0,i=Math.max(i,t),clearTimeout(n.animationResetTimer),n.animationResetTimer=setTimeout(function(){n.animationTime=0,n.prevFromRect=null,n.fromRect=null,n.prevToRect=null,n.thisAnimationDuration=null},t),n.thisAnimationDuration=t)}),clearTimeout(e),o?e=setTimeout(function(){"function"==typeof n&&n()},i):"function"==typeof n&&n(),t=[]},animate:function(e,t,n,r){if(r){lt(e,"transition",""),lt(e,"transform","");var o=ct(this.el),i=o&&o.a,a=o&&o.d,s=(t.left-n.left)/(i||1),l=(t.top-n.top)/(a||1);e.animatingX=!!s,e.animatingY=!!l,lt(e,"transform","translate3d("+s+"px,"+l+"px,0)"),this.forRepaintDummy=function(e){return e.offsetWidth}(e),lt(e,"transition","transform "+r+"ms"+(this.options.easing?" "+this.options.easing:"")),lt(e,"transform","translate3d(0,0,0)"),"number"==typeof e.animated&&clearTimeout(e.animated),e.animated=setTimeout(function(){lt(e,"transition",""),lt(e,"transform",""),e.animated=!1,e.animatingX=!1,e.animatingY=!1},r)}}}}var kt=[],Pt={initializeByDefault:!0},Dt={mount:function(e){for(var t in Pt)Pt.hasOwnProperty(t)&&!(t in e)&&(e[t]=Pt[t]);kt.forEach(function(t){if(t.pluginName===e.pluginName)throw"Sortable: Cannot mount plugin ".concat(e.pluginName," more than once")}),kt.push(e)},pluginEvent:function(e,t,n){var r=this;this.eventCanceled=!1,n.cancel=function(){r.eventCanceled=!0};var o=e+"Global";kt.forEach(function(r){t[r.pluginName]&&(t[r.pluginName][o]&&t[r.pluginName][o](He({sortable:t},n)),t.options[r.pluginName]&&t[r.pluginName][e]&&t[r.pluginName][e](He({sortable:t},n)))})},initializePlugins:function(e,t,n,r){for(var o in kt.forEach(function(r){var o=r.pluginName;if(e.options[o]||r.initializeByDefault){var i=new r(e,t,e.options);i.sortable=e,i.options=e.options,e[o]=i,Ue(n,i.defaults)}}),e.options)if(e.options.hasOwnProperty(o)){var i=this.modifyOption(e,o,e.options[o]);void 0!==i&&(e.options[o]=i)}},getEventProperties:function(e,t){var n={};return kt.forEach(function(r){"function"==typeof r.eventProperties&&Ue(n,r.eventProperties.call(t[r.pluginName],e))}),n},modifyOption:function(e,t,n){var r;return kt.forEach(function(o){e[o.pluginName]&&o.optionListeners&&"function"==typeof o.optionListeners[t]&&(r=o.optionListeners[t].call(e[o.pluginName],n))}),r}};function Tt(e){var t=e.sortable,n=e.rootEl,r=e.name,o=e.targetEl,i=e.cloneEl,a=e.toEl,s=e.fromEl,l=e.oldIndex,c=e.newIndex,u=e.oldDraggableIndex,p=e.newDraggableIndex,d=e.originalEvent,h=e.putSortable,f=e.extraEventProperties;if(t=t||n&&n[_t]){var m,g=t.options,v="on"+r.charAt(0).toUpperCase()+r.substr(1);!window.CustomEvent||Ye||Xe?(m=document.createEvent("Event")).initEvent(r,!0,!0):m=new CustomEvent(r,{bubbles:!0,cancelable:!0}),m.to=a||n,m.from=s||n,m.item=o||n,m.clone=i,m.oldIndex=l,m.newIndex=c,m.oldDraggableIndex=u,m.newDraggableIndex=p,m.originalEvent=d,m.pullMode=h?h.lastPutMode:void 0;var y=He(He({},f),Dt.getEventProperties(r,t));for(var b in y)m[b]=y[b];n&&n.dispatchEvent(m),g[v]&&g[v].call(t,m)}}var It=["evt"],At=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=n.evt,o=We(n,It);Dt.pluginEvent.bind(_n)(e,t,He({dragEl:Ot,parentEl:Ft,ghostEl:Lt,rootEl:Mt,nextEl:Bt,lastDownEl:jt,cloneEl:Rt,cloneHidden:$t,dragStarted:Qt,putSortable:Gt,activeSortable:_n.active,originalEvent:r,oldIndex:Ht,oldDraggableIndex:Vt,newIndex:qt,newDraggableIndex:Ut,hideGhostForTarget:Sn,unhideGhostForTarget:xn,cloneNowHidden:function(){$t=!0},cloneNowShown:function(){$t=!1},dispatchSortableEvent:function(e){Nt({sortable:t,name:e,originalEvent:r})}},o))};function Nt(e){Tt(He({putSortable:Gt,cloneEl:Rt,targetEl:Ot,rootEl:Mt,oldIndex:Ht,oldDraggableIndex:Vt,newIndex:qt,newDraggableIndex:Ut},e))}var Ot,Ft,Lt,Mt,Bt,jt,Rt,$t,Ht,qt,Vt,Ut,Wt,Gt,Yt,Xt,zt,Jt,Kt,Zt,Qt,en,tn,nn,rn,on=!1,an=!1,sn=[],ln=!1,cn=!1,un=[],pn=!1,dn=[],hn="undefined"!=typeof document,fn=Ke,mn=Xe||Ye?"cssFloat":"float",gn=hn&&!Ze&&!Ke&&"draggable"in document.createElement("div"),vn=function(){if(hn){if(Ye)return!1;var e=document.createElement("x");return e.style.cssText="pointer-events:auto","auto"===e.style.pointerEvents}}(),yn=function(e,t){var n=lt(e),r=parseInt(n.width)-parseInt(n.paddingLeft)-parseInt(n.paddingRight)-parseInt(n.borderLeftWidth)-parseInt(n.borderRightWidth),o=ft(e,0,t),i=ft(e,1,t),a=o&&lt(o),s=i&&lt(i),l=a&&parseInt(a.marginLeft)+parseInt(a.marginRight)+dt(o).width,c=s&&parseInt(s.marginLeft)+parseInt(s.marginRight)+dt(i).width;if("flex"===n.display)return"column"===n.flexDirection||"column-reverse"===n.flexDirection?"vertical":"horizontal";if("grid"===n.display)return n.gridTemplateColumns.split(" ").length<=1?"vertical":"horizontal";if(o&&a.float&&"none"!==a.float){var u="left"===a.float?"left":"right";return!i||"both"!==s.clear&&s.clear!==u?"horizontal":"vertical"}return o&&("block"===a.display||"flex"===a.display||"table"===a.display||"grid"===a.display||l>=r&&"none"===n[mn]||i&&"none"===n[mn]&&l+c>r)?"vertical":"horizontal"},bn=function(e){function t(e,n){return function(r,o,i,a){var s=r.options.group.name&&o.options.group.name&&r.options.group.name===o.options.group.name;if(null==e&&(n||s))return!0;if(null==e||!1===e)return!1;if(n&&"clone"===e)return e;if("function"==typeof e)return t(e(r,o,i,a),n)(r,o,i,a);var l=(n?r:o).options.group.name;return!0===e||"string"==typeof e&&e===l||e.join&&e.indexOf(l)>-1}}var n={},r=e.group;r&&"object"==qe(r)||(r={name:r}),n.name=r.name,n.checkPull=t(r.pull,!0),n.checkPut=t(r.put),n.revertClone=r.revertClone,e.group=n},Sn=function(){!vn&&Lt&&lt(Lt,"display","none")},xn=function(){!vn&&Lt&&lt(Lt,"display","")};hn&&!Ze&&document.addEventListener("click",function(e){if(an)return e.preventDefault(),e.stopPropagation&&e.stopPropagation(),e.stopImmediatePropagation&&e.stopImmediatePropagation(),an=!1,!1},!0);var wn=function(e){if(Ot){e=e.touches?e.touches[0]:e;var t=(o=e.clientX,i=e.clientY,sn.some(function(e){var t=e[_t].options.emptyInsertThreshold;if(t&&!mt(e)){var n=dt(e),r=o>=n.left-t&&o<=n.right+t,s=i>=n.top-t&&i<=n.bottom+t;return r&&s?a=e:void 0}}),a);if(t){var n={};for(var r in e)e.hasOwnProperty(r)&&(n[r]=e[r]);n.target=n.rootEl=t,n.preventDefault=void 0,n.stopPropagation=void 0,t[_t]._onDragOver(n)}}var o,i,a},Cn=function(e){Ot&&Ot.parentNode[_t]._isOutsideThisEl(e.target)};function _n(e,t){if(!e||!e.nodeType||1!==e.nodeType)throw"Sortable: `el` must be an HTMLElement, not ".concat({}.toString.call(e));this.el=e,this.options=t=Ue({},t),e[_t]=this;var n={group:null,sort:!0,disabled:!1,store:null,handle:null,draggable:/^[uo]l$/i.test(e.nodeName)?">li":">*",swapThreshold:1,invertSwap:!1,invertedSwapThreshold:null,removeCloneOnHide:!0,direction:function(){return yn(e,this.options)},ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",ignore:"a, img",filter:null,preventOnFilter:!0,animation:0,easing:null,setData:function(e,t){e.setData("Text",t.textContent)},dropBubble:!1,dragoverBubble:!1,dataIdAttr:"data-id",delay:0,delayOnTouchOnly:!1,touchStartThreshold:(Number.parseInt?Number:window).parseInt(window.devicePixelRatio,10)||1,forceFallback:!1,fallbackClass:"sortable-fallback",fallbackOnBody:!1,fallbackTolerance:0,fallbackOffset:{x:0,y:0},supportPointer:!1!==_n.supportPointer&&"PointerEvent"in window&&(!Je||Ke),emptyInsertThreshold:5};for(var r in Dt.initializePlugins(this,e,n),n)!(r in t)&&(t[r]=n[r]);for(var o in bn(t),this)"_"===o.charAt(0)&&"function"==typeof this[o]&&(this[o]=this[o].bind(this));this.nativeDraggable=!t.forceFallback&&gn,this.nativeDraggable&&(this.options.touchStartThreshold=1),t.supportPointer?et(e,"pointerdown",this._onTapStart):(et(e,"mousedown",this._onTapStart),et(e,"touchstart",this._onTapStart)),this.nativeDraggable&&(et(e,"dragover",this),et(e,"dragenter",this)),sn.push(this.el),t.store&&t.store.get&&this.sort(t.store.get(this)||[]),Ue(this,Et())}function En(e,t,n,r,o,i,a,s){var l,c,u=e[_t],p=u.options.onMove;return!window.CustomEvent||Ye||Xe?(l=document.createEvent("Event")).initEvent("move",!0,!0):l=new CustomEvent("move",{bubbles:!0,cancelable:!0}),l.to=t,l.from=e,l.dragged=n,l.draggedRect=r,l.related=o||t,l.relatedRect=i||dt(t),l.willInsertAfter=s,l.originalEvent=a,e.dispatchEvent(l),p&&(c=p.call(u,l,a)),c}function kn(e){e.draggable=!1}function Pn(){pn=!1}function Dn(e){for(var t=e.tagName+e.className+e.src+e.href+e.textContent,n=t.length,r=0;n--;)r+=t.charCodeAt(n);return r.toString(36)}function Tn(e){return setTimeout(e,0)}function In(e){return clearTimeout(e)}_n.prototype={constructor:_n,_isOutsideThisEl:function(e){this.el.contains(e)||e===this.el||(en=null)},_getDirection:function(e,t){return"function"==typeof this.options.direction?this.options.direction.call(this,e,t,Ot):this.options.direction},_onTapStart:function(e){if(e.cancelable){var t=this,n=this.el,r=this.options,o=r.preventOnFilter,i=e.type,a=e.touches&&e.touches[0]||e.pointerType&&"touch"===e.pointerType&&e,s=(a||e).target,l=e.target.shadowRoot&&(e.path&&e.path[0]||e.composedPath&&e.composedPath()[0])||s,c=r.filter;if(function(e){dn.length=0;var t=e.getElementsByTagName("input"),n=t.length;for(;n--;){var r=t[n];r.checked&&dn.push(r)}}(n),!Ot&&!(/mousedown|pointerdown/.test(i)&&0!==e.button||r.disabled)&&!l.isContentEditable&&(this.nativeDraggable||!Je||!s||"SELECT"!==s.tagName.toUpperCase())&&!((s=ot(s,r.draggable,n,!1))&&s.animated||jt===s)){if(Ht=gt(s),Vt=gt(s,r.draggable),"function"==typeof c){if(c.call(this,e,s,this))return Nt({sortable:t,rootEl:l,name:"filter",targetEl:s,toEl:n,fromEl:n}),At("filter",t,{evt:e}),void(o&&e.preventDefault())}else if(c&&(c=c.split(",").some(function(r){if(r=ot(l,r.trim(),n,!1))return Nt({sortable:t,rootEl:r,name:"filter",targetEl:s,fromEl:n,toEl:n}),At("filter",t,{evt:e}),!0})))return void(o&&e.preventDefault());r.handle&&!ot(l,r.handle,n,!1)||this._prepareDragStart(e,a,s)}}},_prepareDragStart:function(e,t,n){var r,o=this,i=o.el,a=o.options,s=i.ownerDocument;if(n&&!Ot&&n.parentNode===i){var l=dt(n);if(Mt=i,Ft=(Ot=n).parentNode,Bt=Ot.nextSibling,jt=n,Wt=a.group,_n.dragged=Ot,Yt={target:Ot,clientX:(t||e).clientX,clientY:(t||e).clientY},Kt=Yt.clientX-l.left,Zt=Yt.clientY-l.top,this._lastX=(t||e).clientX,this._lastY=(t||e).clientY,Ot.style["will-change"]="all",r=function(){At("delayEnded",o,{evt:e}),_n.eventCanceled?o._onDrop():(o._disableDelayedDragEvents(),!ze&&o.nativeDraggable&&(Ot.draggable=!0),o._triggerDragStart(e,t),Nt({sortable:o,name:"choose",originalEvent:e}),st(Ot,a.chosenClass,!0))},a.ignore.split(",").forEach(function(e){ut(Ot,e.trim(),kn)}),et(s,"dragover",wn),et(s,"mousemove",wn),et(s,"touchmove",wn),a.supportPointer?(et(s,"pointerup",o._onDrop),!this.nativeDraggable&&et(s,"pointercancel",o._onDrop)):(et(s,"mouseup",o._onDrop),et(s,"touchend",o._onDrop),et(s,"touchcancel",o._onDrop)),ze&&this.nativeDraggable&&(this.options.touchStartThreshold=4,Ot.draggable=!0),At("delayStart",this,{evt:e}),!a.delay||a.delayOnTouchOnly&&!t||this.nativeDraggable&&(Xe||Ye))r();else{if(_n.eventCanceled)return void this._onDrop();a.supportPointer?(et(s,"pointerup",o._disableDelayedDrag),et(s,"pointercancel",o._disableDelayedDrag)):(et(s,"mouseup",o._disableDelayedDrag),et(s,"touchend",o._disableDelayedDrag),et(s,"touchcancel",o._disableDelayedDrag)),et(s,"mousemove",o._delayedDragTouchMoveHandler),et(s,"touchmove",o._delayedDragTouchMoveHandler),a.supportPointer&&et(s,"pointermove",o._delayedDragTouchMoveHandler),o._dragStartTimer=setTimeout(r,a.delay)}}},_delayedDragTouchMoveHandler:function(e){var t=e.touches?e.touches[0]:e;Math.max(Math.abs(t.clientX-this._lastX),Math.abs(t.clientY-this._lastY))>=Math.floor(this.options.touchStartThreshold/(this.nativeDraggable&&window.devicePixelRatio||1))&&this._disableDelayedDrag()},_disableDelayedDrag:function(){Ot&&kn(Ot),clearTimeout(this._dragStartTimer),this._disableDelayedDragEvents()},_disableDelayedDragEvents:function(){var e=this.el.ownerDocument;tt(e,"mouseup",this._disableDelayedDrag),tt(e,"touchend",this._disableDelayedDrag),tt(e,"touchcancel",this._disableDelayedDrag),tt(e,"pointerup",this._disableDelayedDrag),tt(e,"pointercancel",this._disableDelayedDrag),tt(e,"mousemove",this._delayedDragTouchMoveHandler),tt(e,"touchmove",this._delayedDragTouchMoveHandler),tt(e,"pointermove",this._delayedDragTouchMoveHandler)},_triggerDragStart:function(e,t){t=t||"touch"==e.pointerType&&e,!this.nativeDraggable||t?this.options.supportPointer?et(document,"pointermove",this._onTouchMove):et(document,t?"touchmove":"mousemove",this._onTouchMove):(et(Ot,"dragend",this),et(Mt,"dragstart",this._onDragStart));try{document.selection?Tn(function(){document.selection.empty()}):window.getSelection().removeAllRanges()}catch(e){}},_dragStarted:function(e,t){if(on=!1,Mt&&Ot){At("dragStarted",this,{evt:t}),this.nativeDraggable&&et(document,"dragover",Cn);var n=this.options;!e&&st(Ot,n.dragClass,!1),st(Ot,n.ghostClass,!0),_n.active=this,e&&this._appendGhost(),Nt({sortable:this,name:"start",originalEvent:t})}else this._nulling()},_emulateDragOver:function(){if(Xt){this._lastX=Xt.clientX,this._lastY=Xt.clientY,Sn();for(var e=document.elementFromPoint(Xt.clientX,Xt.clientY),t=e;e&&e.shadowRoot&&(e=e.shadowRoot.elementFromPoint(Xt.clientX,Xt.clientY))!==t;)t=e;if(Ot.parentNode[_t]._isOutsideThisEl(e),t)do{if(t[_t]){if(t[_t]._onDragOver({clientX:Xt.clientX,clientY:Xt.clientY,target:e,rootEl:t})&&!this.options.dragoverBubble)break}e=t}while(t=rt(t));xn()}},_onTouchMove:function(e){if(Yt){var t=this.options,n=t.fallbackTolerance,r=t.fallbackOffset,o=e.touches?e.touches[0]:e,i=Lt&&ct(Lt,!0),a=Lt&&i&&i.a,s=Lt&&i&&i.d,l=fn&&rn&&vt(rn),c=(o.clientX-Yt.clientX+r.x)/(a||1)+(l?l[0]-un[0]:0)/(a||1),u=(o.clientY-Yt.clientY+r.y)/(s||1)+(l?l[1]-un[1]:0)/(s||1);if(!_n.active&&!on){if(n&&Math.max(Math.abs(o.clientX-this._lastX),Math.abs(o.clientY-this._lastY))<n)return;this._onDragStart(e,!0)}if(Lt){i?(i.e+=c-(zt||0),i.f+=u-(Jt||0)):i={a:1,b:0,c:0,d:1,e:c,f:u};var p="matrix(".concat(i.a,",").concat(i.b,",").concat(i.c,",").concat(i.d,",").concat(i.e,",").concat(i.f,")");lt(Lt,"webkitTransform",p),lt(Lt,"mozTransform",p),lt(Lt,"msTransform",p),lt(Lt,"transform",p),zt=c,Jt=u,Xt=o}e.cancelable&&e.preventDefault()}},_appendGhost:function(){if(!Lt){var e=this.options.fallbackOnBody?document.body:Mt,t=dt(Ot,!0,fn,!0,e),n=this.options;if(fn){for(rn=e;"static"===lt(rn,"position")&&"none"===lt(rn,"transform")&&rn!==document;)rn=rn.parentNode;rn!==document.body&&rn!==document.documentElement?(rn===document&&(rn=pt()),t.top+=rn.scrollTop,t.left+=rn.scrollLeft):rn=pt(),un=vt(rn)}st(Lt=Ot.cloneNode(!0),n.ghostClass,!1),st(Lt,n.fallbackClass,!0),st(Lt,n.dragClass,!0),lt(Lt,"transition",""),lt(Lt,"transform",""),lt(Lt,"box-sizing","border-box"),lt(Lt,"margin",0),lt(Lt,"top",t.top),lt(Lt,"left",t.left),lt(Lt,"width",t.width),lt(Lt,"height",t.height),lt(Lt,"opacity","0.8"),lt(Lt,"position",fn?"absolute":"fixed"),lt(Lt,"zIndex","100000"),lt(Lt,"pointerEvents","none"),_n.ghost=Lt,e.appendChild(Lt),lt(Lt,"transform-origin",Kt/parseInt(Lt.style.width)*100+"% "+Zt/parseInt(Lt.style.height)*100+"%")}},_onDragStart:function(e,t){var n=this,r=e.dataTransfer,o=n.options;At("dragStart",this,{evt:e}),_n.eventCanceled?this._onDrop():(At("setupClone",this),_n.eventCanceled||((Rt=wt(Ot)).removeAttribute("id"),Rt.draggable=!1,Rt.style["will-change"]="",this._hideClone(),st(Rt,this.options.chosenClass,!1),_n.clone=Rt),n.cloneId=Tn(function(){At("clone",n),_n.eventCanceled||(n.options.removeCloneOnHide||Mt.insertBefore(Rt,Ot),n._hideClone(),Nt({sortable:n,name:"clone"}))}),!t&&st(Ot,o.dragClass,!0),t?(an=!0,n._loopId=setInterval(n._emulateDragOver,50)):(tt(document,"mouseup",n._onDrop),tt(document,"touchend",n._onDrop),tt(document,"touchcancel",n._onDrop),r&&(r.effectAllowed="move",o.setData&&o.setData.call(n,r,Ot)),et(document,"drop",n),lt(Ot,"transform","translateZ(0)")),on=!0,n._dragStartId=Tn(n._dragStarted.bind(n,t,e)),et(document,"selectstart",n),Qt=!0,window.getSelection().removeAllRanges(),Je&&lt(document.body,"user-select","none"))},_onDragOver:function(e){var t,n,r,o,i=this.el,a=e.target,s=this.options,l=s.group,c=_n.active,u=Wt===l,p=s.sort,d=Gt||c,h=this,f=!1;if(!pn){if(void 0!==e.preventDefault&&e.cancelable&&e.preventDefault(),a=ot(a,s.draggable,i,!0),T("dragOver"),_n.eventCanceled)return f;if(Ot.contains(e.target)||a.animated&&a.animatingX&&a.animatingY||h._ignoreWhileAnimating===a)return A(!1);if(an=!1,c&&!s.disabled&&(u?p||(r=Ft!==Mt):Gt===this||(this.lastPutMode=Wt.checkPull(this,c,Ot,e))&&l.checkPut(this,c,Ot,e))){if(o="vertical"===this._getDirection(e,a),t=dt(Ot),T("dragOverValid"),_n.eventCanceled)return f;if(r)return Ft=Mt,I(),this._hideClone(),T("revert"),_n.eventCanceled||(Bt?Mt.insertBefore(Ot,Bt):Mt.appendChild(Ot)),A(!0);var m=mt(i,s.draggable);if(!m||function(e,t,n){var r=dt(mt(n.el,n.options.draggable)),o=Ct(n.el,n.options,Lt),i=10;return t?e.clientX>o.right+i||e.clientY>r.bottom&&e.clientX>r.left:e.clientY>o.bottom+i||e.clientX>r.right&&e.clientY>r.top}(e,o,this)&&!m.animated){if(m===Ot)return A(!1);if(m&&i===e.target&&(a=m),a&&(n=dt(a)),!1!==En(Mt,i,Ot,t,a,n,e,!!a))return I(),m&&m.nextSibling?i.insertBefore(Ot,m.nextSibling):i.appendChild(Ot),Ft=i,N(),A(!0)}else if(m&&function(e,t,n){var r=dt(ft(n.el,0,n.options,!0)),o=Ct(n.el,n.options,Lt),i=10;return t?e.clientX<o.left-i||e.clientY<r.top&&e.clientX<r.right:e.clientY<o.top-i||e.clientY<r.bottom&&e.clientX<r.left}(e,o,this)){var g=ft(i,0,s,!0);if(g===Ot)return A(!1);if(n=dt(a=g),!1!==En(Mt,i,Ot,t,a,n,e,!1))return I(),i.insertBefore(Ot,g),Ft=i,N(),A(!0)}else if(a.parentNode===i){n=dt(a);var v,y,b,S=Ot.parentNode!==i,x=!function(e,t,n){var r=n?e.left:e.top,o=n?e.right:e.bottom,i=n?e.width:e.height,a=n?t.left:t.top,s=n?t.right:t.bottom,l=n?t.width:t.height;return r===a||o===s||r+i/2===a+l/2}(Ot.animated&&Ot.toRect||t,a.animated&&a.toRect||n,o),w=o?"top":"left",C=ht(a,"top","top")||ht(Ot,"top","top"),_=C?C.scrollTop:void 0;if(en!==a&&(y=n[w],ln=!1,cn=!x&&s.invertSwap||S),v=function(e,t,n,r,o,i,a,s){var l=r?e.clientY:e.clientX,c=r?n.height:n.width,u=r?n.top:n.left,p=r?n.bottom:n.right,d=!1;if(!a)if(s&&nn<c*o){if(!ln&&(1===tn?l>u+c*i/2:l<p-c*i/2)&&(ln=!0),ln)d=!0;else if(1===tn?l<u+nn:l>p-nn)return-tn}else if(l>u+c*(1-o)/2&&l<p-c*(1-o)/2)return function(e){return gt(Ot)<gt(e)?1:-1}(t);if((d=d||a)&&(l<u+c*i/2||l>p-c*i/2))return l>u+c/2?1:-1;return 0}(e,a,n,o,x?1:s.swapThreshold,null==s.invertedSwapThreshold?s.swapThreshold:s.invertedSwapThreshold,cn,en===a),0!==v){var E=gt(Ot);do{E-=v,b=Ft.children[E]}while(b&&("none"===lt(b,"display")||b===Lt))}if(0===v||b===a)return A(!1);en=a,tn=v;var k=a.nextElementSibling,P=!1,D=En(Mt,i,Ot,t,a,n,e,P=1===v);if(!1!==D)return 1!==D&&-1!==D||(P=1===D),pn=!0,setTimeout(Pn,30),I(),P&&!k?i.appendChild(Ot):a.parentNode.insertBefore(Ot,P?k:a),C&&xt(C,0,_-C.scrollTop),Ft=Ot.parentNode,void 0===y||cn||(nn=Math.abs(y-dt(a)[w])),N(),A(!0)}if(i.contains(Ot))return A(!1)}return!1}function T(s,l){At(s,h,He({evt:e,isOwner:u,axis:o?"vertical":"horizontal",revert:r,dragRect:t,targetRect:n,canSort:p,fromSortable:d,target:a,completed:A,onMove:function(n,r){return En(Mt,i,Ot,t,n,dt(n),e,r)},changed:N},l))}function I(){T("dragOverAnimationCapture"),h.captureAnimationState(),h!==d&&d.captureAnimationState()}function A(t){return T("dragOverCompleted",{insertion:t}),t&&(u?c._hideClone():c._showClone(h),h!==d&&(st(Ot,Gt?Gt.options.ghostClass:c.options.ghostClass,!1),st(Ot,s.ghostClass,!0)),Gt!==h&&h!==_n.active?Gt=h:h===_n.active&&Gt&&(Gt=null),d===h&&(h._ignoreWhileAnimating=a),h.animateAll(function(){T("dragOverAnimationComplete"),h._ignoreWhileAnimating=null}),h!==d&&(d.animateAll(),d._ignoreWhileAnimating=null)),(a===Ot&&!Ot.animated||a===i&&!a.animated)&&(en=null),s.dragoverBubble||e.rootEl||a===document||(Ot.parentNode[_t]._isOutsideThisEl(e.target),!t&&wn(e)),!s.dragoverBubble&&e.stopPropagation&&e.stopPropagation(),f=!0}function N(){qt=gt(Ot),Ut=gt(Ot,s.draggable),Nt({sortable:h,name:"change",toEl:i,newIndex:qt,newDraggableIndex:Ut,originalEvent:e})}},_ignoreWhileAnimating:null,_offMoveEvents:function(){tt(document,"mousemove",this._onTouchMove),tt(document,"touchmove",this._onTouchMove),tt(document,"pointermove",this._onTouchMove),tt(document,"dragover",wn),tt(document,"mousemove",wn),tt(document,"touchmove",wn)},_offUpEvents:function(){var e=this.el.ownerDocument;tt(e,"mouseup",this._onDrop),tt(e,"touchend",this._onDrop),tt(e,"pointerup",this._onDrop),tt(e,"pointercancel",this._onDrop),tt(e,"touchcancel",this._onDrop),tt(document,"selectstart",this)},_onDrop:function(e){var t=this.el,n=this.options;qt=gt(Ot),Ut=gt(Ot,n.draggable),At("drop",this,{evt:e}),Ft=Ot&&Ot.parentNode,qt=gt(Ot),Ut=gt(Ot,n.draggable),_n.eventCanceled||(on=!1,cn=!1,ln=!1,clearInterval(this._loopId),clearTimeout(this._dragStartTimer),In(this.cloneId),In(this._dragStartId),this.nativeDraggable&&(tt(document,"drop",this),tt(t,"dragstart",this._onDragStart)),this._offMoveEvents(),this._offUpEvents(),Je&&lt(document.body,"user-select",""),lt(Ot,"transform",""),e&&(Qt&&(e.cancelable&&e.preventDefault(),!n.dropBubble&&e.stopPropagation()),Lt&&Lt.parentNode&&Lt.parentNode.removeChild(Lt),(Mt===Ft||Gt&&"clone"!==Gt.lastPutMode)&&Rt&&Rt.parentNode&&Rt.parentNode.removeChild(Rt),Ot&&(this.nativeDraggable&&tt(Ot,"dragend",this),kn(Ot),Ot.style["will-change"]="",Qt&&!on&&st(Ot,Gt?Gt.options.ghostClass:this.options.ghostClass,!1),st(Ot,this.options.chosenClass,!1),Nt({sortable:this,name:"unchoose",toEl:Ft,newIndex:null,newDraggableIndex:null,originalEvent:e}),Mt!==Ft?(qt>=0&&(Nt({rootEl:Ft,name:"add",toEl:Ft,fromEl:Mt,originalEvent:e}),Nt({sortable:this,name:"remove",toEl:Ft,originalEvent:e}),Nt({rootEl:Ft,name:"sort",toEl:Ft,fromEl:Mt,originalEvent:e}),Nt({sortable:this,name:"sort",toEl:Ft,originalEvent:e})),Gt&&Gt.save()):qt!==Ht&&qt>=0&&(Nt({sortable:this,name:"update",toEl:Ft,originalEvent:e}),Nt({sortable:this,name:"sort",toEl:Ft,originalEvent:e})),_n.active&&(null!=qt&&-1!==qt||(qt=Ht,Ut=Vt),Nt({sortable:this,name:"end",toEl:Ft,originalEvent:e}),this.save())))),this._nulling()},_nulling:function(){At("nulling",this),Mt=Ot=Ft=Lt=Bt=Rt=jt=$t=Yt=Xt=Qt=qt=Ut=Ht=Vt=en=tn=Gt=Wt=_n.dragged=_n.ghost=_n.clone=_n.active=null,dn.forEach(function(e){e.checked=!0}),dn.length=zt=Jt=0},handleEvent:function(e){switch(e.type){case"drop":case"dragend":this._onDrop(e);break;case"dragenter":case"dragover":Ot&&(this._onDragOver(e),function(e){e.dataTransfer&&(e.dataTransfer.dropEffect="move");e.cancelable&&e.preventDefault()}(e));break;case"selectstart":e.preventDefault()}},toArray:function(){for(var e,t=[],n=this.el.children,r=0,o=n.length,i=this.options;r<o;r++)ot(e=n[r],i.draggable,this.el,!1)&&t.push(e.getAttribute(i.dataIdAttr)||Dn(e));return t},sort:function(e,t){var n={},r=this.el;this.toArray().forEach(function(e,t){var o=r.children[t];ot(o,this.options.draggable,r,!1)&&(n[e]=o)},this),t&&this.captureAnimationState(),e.forEach(function(e){n[e]&&(r.removeChild(n[e]),r.appendChild(n[e]))}),t&&this.animateAll()},save:function(){var e=this.options.store;e&&e.set&&e.set(this)},closest:function(e,t){return ot(e,t||this.options.draggable,this.el,!1)},option:function(e,t){var n=this.options;if(void 0===t)return n[e];var r=Dt.modifyOption(this,e,t);n[e]=void 0!==r?r:t,"group"===e&&bn(n)},destroy:function(){At("destroy",this);var e=this.el;e[_t]=null,tt(e,"mousedown",this._onTapStart),tt(e,"touchstart",this._onTapStart),tt(e,"pointerdown",this._onTapStart),this.nativeDraggable&&(tt(e,"dragover",this),tt(e,"dragenter",this)),Array.prototype.forEach.call(e.querySelectorAll("[draggable]"),function(e){e.removeAttribute("draggable")}),this._onDrop(),this._disableDelayedDragEvents(),sn.splice(sn.indexOf(this.el),1),this.el=e=null},_hideClone:function(){if(!$t){if(At("hideClone",this),_n.eventCanceled)return;lt(Rt,"display","none"),this.options.removeCloneOnHide&&Rt.parentNode&&Rt.parentNode.removeChild(Rt),$t=!0}},_showClone:function(e){if("clone"===e.lastPutMode){if($t){if(At("showClone",this),_n.eventCanceled)return;Ot.parentNode!=Mt||this.options.group.revertClone?Bt?Mt.insertBefore(Rt,Bt):Mt.appendChild(Rt):Mt.insertBefore(Rt,Ot),this.options.group.revertClone&&this.animate(Ot,Rt),lt(Rt,"display",""),$t=!1}}else this._hideClone()}},hn&&et(document,"touchmove",function(e){(_n.active||on)&&e.cancelable&&e.preventDefault()}),_n.utils={on:et,off:tt,css:lt,find:ut,is:function(e,t){return!!ot(e,t,e,!1)},extend:function(e,t){if(e&&t)for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},throttle:St,closest:ot,toggleClass:st,clone:wt,index:gt,nextTick:Tn,cancelNextTick:In,detectDirection:yn,getChild:ft,expando:_t},_n.get=function(e){return e[_t]},_n.mount=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];t[0].constructor===Array&&(t=t[0]),t.forEach(function(e){if(!e.prototype||!e.prototype.constructor)throw"Sortable: Mounted plugin must be a constructor function, not ".concat({}.toString.call(e));e.utils&&(_n.utils=He(He({},_n.utils),e.utils)),Dt.mount(e)})},_n.create=function(e,t){return new _n(e,t)},_n.version="1.15.6";var An,Nn,On,Fn,Ln,Mn,Bn=[],jn=!1;function Rn(){Bn.forEach(function(e){clearInterval(e.pid)}),Bn=[]}function $n(){clearInterval(Mn)}var Hn=St(function(e,t,n,r){if(t.scroll){var o,i=(e.touches?e.touches[0]:e).clientX,a=(e.touches?e.touches[0]:e).clientY,s=t.scrollSensitivity,l=t.scrollSpeed,c=pt(),u=!1;Nn!==n&&(Nn=n,Rn(),An=t.scroll,o=t.scrollFn,!0===An&&(An=yt(n,!0)));var p=0,d=An;do{var h=d,f=dt(h),m=f.top,g=f.bottom,v=f.left,y=f.right,b=f.width,S=f.height,x=void 0,w=void 0,C=h.scrollWidth,_=h.scrollHeight,E=lt(h),k=h.scrollLeft,P=h.scrollTop;h===c?(x=b<C&&("auto"===E.overflowX||"scroll"===E.overflowX||"visible"===E.overflowX),w=S<_&&("auto"===E.overflowY||"scroll"===E.overflowY||"visible"===E.overflowY)):(x=b<C&&("auto"===E.overflowX||"scroll"===E.overflowX),w=S<_&&("auto"===E.overflowY||"scroll"===E.overflowY));var D=x&&(Math.abs(y-i)<=s&&k+b<C)-(Math.abs(v-i)<=s&&!!k),T=w&&(Math.abs(g-a)<=s&&P+S<_)-(Math.abs(m-a)<=s&&!!P);if(!Bn[p])for(var I=0;I<=p;I++)Bn[I]||(Bn[I]={});Bn[p].vx==D&&Bn[p].vy==T&&Bn[p].el===h||(Bn[p].el=h,Bn[p].vx=D,Bn[p].vy=T,clearInterval(Bn[p].pid),0==D&&0==T||(u=!0,Bn[p].pid=setInterval(function(){r&&0===this.layer&&_n.active._onTouchMove(Ln);var t=Bn[this.layer].vy?Bn[this.layer].vy*l:0,n=Bn[this.layer].vx?Bn[this.layer].vx*l:0;"function"==typeof o&&"continue"!==o.call(_n.dragged.parentNode[_t],n,t,e,Ln,Bn[this.layer].el)||xt(Bn[this.layer].el,n,t)}.bind({layer:p}),24))),p++}while(t.bubbleScroll&&d!==c&&(d=yt(d,!1)));jn=u}},30),qn=function(e){var t=e.originalEvent,n=e.putSortable,r=e.dragEl,o=e.activeSortable,i=e.dispatchSortableEvent,a=e.hideGhostForTarget,s=e.unhideGhostForTarget;if(t){var l=n||o;a();var c=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:t,u=document.elementFromPoint(c.clientX,c.clientY);s(),l&&!l.el.contains(u)&&(i("spill"),this.onSpill({dragEl:r,putSortable:n}))}};function Vn(){}function Un(){}Vn.prototype={startIndex:null,dragStart:function(e){var t=e.oldDraggableIndex;this.startIndex=t},onSpill:function(e){var t=e.dragEl,n=e.putSortable;this.sortable.captureAnimationState(),n&&n.captureAnimationState();var r=ft(this.sortable.el,this.startIndex,this.options);r?this.sortable.el.insertBefore(t,r):this.sortable.el.appendChild(t),this.sortable.animateAll(),n&&n.animateAll()},drop:qn},Ue(Vn,{pluginName:"revertOnSpill"}),Un.prototype={onSpill:function(e){var t=e.dragEl,n=e.putSortable||this.sortable;n.captureAnimationState(),t.parentNode&&t.parentNode.removeChild(t),n.animateAll()},drop:qn},Ue(Un,{pluginName:"removeOnSpill"});_n.mount(new function(){function e(){for(var e in this.defaults={scroll:!0,forceAutoScrollFallback:!1,scrollSensitivity:30,scrollSpeed:10,bubbleScroll:!0},this)"_"===e.charAt(0)&&"function"==typeof this[e]&&(this[e]=this[e].bind(this))}return e.prototype={dragStarted:function(e){var t=e.originalEvent;this.sortable.nativeDraggable?et(document,"dragover",this._handleAutoScroll):this.options.supportPointer?et(document,"pointermove",this._handleFallbackAutoScroll):t.touches?et(document,"touchmove",this._handleFallbackAutoScroll):et(document,"mousemove",this._handleFallbackAutoScroll)},dragOverCompleted:function(e){var t=e.originalEvent;this.options.dragOverBubble||t.rootEl||this._handleAutoScroll(t)},drop:function(){this.sortable.nativeDraggable?tt(document,"dragover",this._handleAutoScroll):(tt(document,"pointermove",this._handleFallbackAutoScroll),tt(document,"touchmove",this._handleFallbackAutoScroll),tt(document,"mousemove",this._handleFallbackAutoScroll)),$n(),Rn(),clearTimeout(it),it=void 0},nulling:function(){Ln=Nn=An=jn=Mn=On=Fn=null,Bn.length=0},_handleFallbackAutoScroll:function(e){this._handleAutoScroll(e,!0)},_handleAutoScroll:function(e,t){var n=this,r=(e.touches?e.touches[0]:e).clientX,o=(e.touches?e.touches[0]:e).clientY,i=document.elementFromPoint(r,o);if(Ln=e,t||this.options.forceAutoScrollFallback||Xe||Ye||Je){Hn(e,this.options,i,t);var a=yt(i,!0);!jn||Mn&&r===On&&o===Fn||(Mn&&$n(),Mn=setInterval(function(){var i=yt(document.elementFromPoint(r,o),!0);i!==a&&(a=i,Rn()),Hn(e,n.options,i,t)},10),On=r,Fn=o)}else{if(!this.options.bubbleScroll||yt(i,!0)===pt())return void Rn();Hn(e,this.options,yt(i,!1),!1)}}},Ue(e,{pluginName:"scroll",initializeByDefault:!0})}),_n.mount(Un,Vn);const Wn=_n;function Gn(e,t={}){const n="string"==typeof e?document.querySelector(e):e;if(!n)throw new Error(`Could not find container: ${e}`);const r=t.showToggleButton??!1,o=t.showDeleteButton??!1,i=t.showSelectInput??!1;let a=[...t.initialList||[]],s=null;n.innerHTML="",n.classList.add("sortable-list-container");const l=document.createElement("ul");l.className="sortable-list",Object.assign(l.style,{listStyle:"none",padding:"0",margin:"0"}),n.appendChild(l);const c=e=>l.querySelector(`li[data-id="${e}"]`),u=e=>{const n=document.createElement("li");n.className="sortable-list-item",n.dataset.id=e.id,Object.assign(n.style,{display:"flex",alignItems:"center",padding:"8px 12px",border:"1px solid var(--SmartThemeBorderColor, #ccc)",color:"var(--SmartThemeBodyColor, #333)",marginBottom:"2px"});const a=document.createElement("span");a.className="drag-handle",a.innerHTML='<i class="fas fa-bars"></i>',Object.assign(a.style,{cursor:"grab",marginRight:"10px",color:"var(--SmartThemeBodyColor, #555)",flexShrink:"0"}),n.appendChild(a);const s=document.createElement("span");s.className="item-label",s.style.flexGrow="1",s.style.marginRight="10px",s.style.overflow="hidden",s.style.textOverflow="ellipsis",s.style.whiteSpace="nowrap",t.renderLabel?t.renderLabel(s,e):s.textContent=e.label,n.appendChild(s);const l="10px",c=e.showSelect??!0,u=e.canSelect??!0;let p=null;if(i&&c)if(u){if(p=document.createElement("select"),p.className="select-input text_pole",p.style.marginRight=l,p.style.flexShrink="0",p.style.width="unset",e.selectOptions&&e.selectOptions.length>0)e.selectOptions.forEach(t=>{const n=document.createElement("option");n.value=t.value,n.textContent=t.label,t.value===e.selectValue&&(n.selected=!0),p.appendChild(n)});else{const e=document.createElement("option");e.textContent="--",e.disabled=!0,e.selected=!0,p.appendChild(e),p.disabled=!0}p.addEventListener("change",t=>{t.stopPropagation(),m(e.id,t)}),n.appendChild(p)}else{const e=document.createElement("span");e.style.marginRight=l,e.style.display="inline-block",e.style.flexShrink="0",n.appendChild(e)}else if(i&&!c){const e=document.createElement("span");e.style.marginRight=l,e.style.display="inline-block",e.style.flexShrink="0",n.appendChild(e)}const d=e.canToggle??!0;if(r&&d){const t=document.createElement("span");t.className="toggle-button",t.innerHTML=`<i class="fas ${e.enabled?"fa-toggle-on":"fa-toggle-off"}"></i>`,Object.assign(t.style,{cursor:"pointer",marginRight:l,fontSize:"1.2em",color:e.enabled?"var(--success-color, #4CAF50)":"var(--SmartThemeBodyColor, #555)",flexShrink:"0"}),t.addEventListener("click",t=>{t.stopPropagation(),h(e.id)}),n.appendChild(t)}else if(r&&!d){const e=document.createElement("span");e.style.marginRight=l,e.style.display="inline-block",e.style.flexShrink="0",n.appendChild(e)}const g=e.canDelete??!0;if(o&&g){const t=document.createElement("span");t.className="delete-button",t.innerHTML='<i class="fas fa-trash-can"></i>',Object.assign(t.style,{cursor:"pointer",color:"var(--error-color, #f44336)",flexShrink:"0"}),t.addEventListener("click",t=>{t.stopPropagation(),f(e.id)}),n.appendChild(t)}else if(o&&!g){const e=document.createElement("span");e.style.display="inline-block",e.style.flexShrink="0",n.appendChild(e)}return r&&(n.style.opacity=e.enabled?"1":"0.6"),n},p=()=>{l.innerHTML="",a.forEach(e=>{const t=u(e);l.appendChild(t)})},d=(e,n={})=>{const o=(e=>a.find(t=>t.id===e))(e),s=c(e);if(!o||!s)return;if("label"in n&&t.renderLabel||"selectOptions"in n||"showSelect"in n||"canSelect"in n||"canToggle"in n||"canDelete"in n){const e=u(o);return void s.replaceWith(e)}if("label"in n&&!t.renderLabel){const e=s.querySelector(".item-label");e&&(e.textContent=o.label)}if("selectValue"in n&&i){const e=s.querySelector(".select-input");e&&(e.value=o.selectValue??"")}if("enabled"in n&&r&&(o.canToggle??1)){const e=s.querySelector(".toggle-button i"),t=s.querySelector(".toggle-button");e&&(e.className="fas "+(o.enabled?"fa-toggle-on":"fa-toggle-off")),t&&(t.style.color=o.enabled?"var(--success-color, #4CAF50)":"var(--SmartThemeBodyColor, #555)")}if("enabled"in n&&r){s.style.opacity=o.enabled?"1":"0.6";const e=s.querySelector(".select-input");e&&(e.disabled=!o.enabled||!(o.canSelect??1))}},h=async e=>{const n=a.findIndex(t=>t.id===e);if(-1===n||!(a[n].canToggle??1))return;const r=a[n],o=!r.enabled;if(t.onToggle)try{await Promise.resolve(t.onToggle(e,o))}catch(e){return void console.error("onToggle callback failed:",e)}const i={enabled:o};a[n]={...r,...i},d(e,i)},f=async e=>{const n=a.findIndex(t=>t.id===e);if(-1===n||!(a[n].canDelete??1))return;let r=!0;if(t.onDelete)try{r=await Promise.resolve(t.onDelete(e))}catch(e){console.error("onDelete callback failed:",e),r=!1}r&&(a.splice(n,1),c(e)?.remove())},m=async(e,n)=>{const r=a.findIndex(t=>t.id===e);if(-1===r||!(a[r].canSelect??1))return;const o=a[r],i=n.target,s=i.value;if(t.onSelectChange)try{await Promise.resolve(t.onSelectChange(e,s))}catch(e){return console.error("onSelectChange callback failed:",e),void(i.value=o.selectValue??"")}const l={selectValue:s};a[r]={...o,...l}},g=()=>{s&&s.destroy();const e={handle:".drag-handle",animation:150,ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",filter:".select-input, .toggle-button, .delete-button",preventOnFilter:!1,onEnd:e=>{const{oldIndex:n,newIndex:r}=e;if(void 0===n||void 0===r||n===r)return;const o=Array.from(l.children).map(e=>e.dataset.id).filter(e=>void 0!==e);a.sort((e,t)=>o.indexOf(e.id)-o.indexOf(t.id));const i=a.map(e=>e.id);t.onOrderChange&&Promise.resolve(t.onOrderChange(i)).catch(e=>console.error("onOrderChange callback failed:",e))},...t.sortableJsOptions||{}};s=Wn.create(l,e)};p(),g();const v={getList:()=>[...a],getOrder:()=>a.map(e=>e.id),addItem:(e,t)=>{if(a.some(t=>t.id===e.id))return void console.warn(`SortableList: Item with ID "${e.id}" already exists. Skipping add.`);const n=void 0===t||t<0||t>a.length?a.length:t;a.splice(n,0,e);const r=u(e),o=l.children[n];l.insertBefore(r,o??null)},removeItem:e=>{const t=a.findIndex(t=>t.id===e);t>-1&&(a.splice(t,1),c(e)?.remove())},updateItem:(e,t)=>{const n=a.findIndex(t=>t.id===e);if(n>-1){const r=a[n];"id"in t&&(console.warn("SortableList: Cannot change item ID via updateItem."),delete t.id),a[n]={...r,...t},d(e,t)}},setList:e=>{a=[...e],p(),g()},destroy:()=>{s&&(s.destroy(),s=null),n.innerHTML="",n.classList.remove("sortable-list-container"),a=[]},getSortableInstance:()=>s};return v}async function Yn({entry:e,selectedWorldName:t,skipSave:n=!1,skipReload:r=!1,operation:o="auto"}){const i=SillyTavern.getContext(),a=await i.loadWorldInfo(t);if(!a)throw new Error("Failed to load world info");const s=Object.values(a.entries),l=s.length>0?s[s.length-1]:void 0;let c;if("update"===o||"auto"===o){const t=Object.values(a.entries).find(t=>t.uid===e.uid);if(t)("auto"===o||"update"===o)&&(c=t);else if("update"===o)throw new Error("Entry not found for update operation")}const u=c?"update":"add";if(!c){if(c=d(t,a),!c)throw new Error("Failed to create entry");if(l){const e=c.uid;Object.assign(c,l),c.uid=e}}return c.key=e.key,c.content=e.content,c.comment=e.comment,n||await i.saveWorldInfo(t,a),r||i.reloadWorldInfoEditor(t,!0),{entry:c,operation:u}}class Xn{diff(e,t,n={}){let r;"function"==typeof n?(r=n,n={}):"callback"in n&&(r=n.callback);const o=this.castInput(e,n),i=this.castInput(t,n),a=this.removeEmpty(this.tokenize(o,n)),s=this.removeEmpty(this.tokenize(i,n));return this.diffWithOptionsObj(a,s,n,r)}diffWithOptionsObj(e,t,n,r){var o;const i=e=>(e=this.postProcess(e,n),r?void setTimeout(function(){r(e)},0):e),a=t.length,s=e.length;let l=1,c=a+s;null!=n.maxEditLength&&(c=Math.min(c,n.maxEditLength));const u=null!==(o=n.timeout)&&void 0!==o?o:1/0,p=Date.now()+u,d=[{oldPos:-1,lastComponent:void 0}];let h=this.extractCommon(d[0],t,e,0,n);if(d[0].oldPos+1>=s&&h+1>=a)return i(this.buildValues(d[0].lastComponent,t,e));let f=-1/0,m=1/0;const g=()=>{for(let r=Math.max(f,-l);r<=Math.min(m,l);r+=2){let o;const l=d[r-1],c=d[r+1];l&&(d[r-1]=void 0);let u=!1;if(c){const e=c.oldPos-r;u=c&&0<=e&&e<a}const p=l&&l.oldPos+1<s;if(u||p){if(o=!p||u&&l.oldPos<c.oldPos?this.addToPath(c,!0,!1,0,n):this.addToPath(l,!1,!0,1,n),h=this.extractCommon(o,t,e,r,n),o.oldPos+1>=s&&h+1>=a)return i(this.buildValues(o.lastComponent,t,e))||!0;d[r]=o,o.oldPos+1>=s&&(m=Math.min(m,r-1)),h+1>=a&&(f=Math.max(f,r+1))}else d[r]=void 0}l++};if(r)!function e(){setTimeout(function(){if(l>c||Date.now()>p)return r(void 0);g()||e()},0)}();else for(;l<=c&&Date.now()<=p;){const e=g();if(e)return e}}addToPath(e,t,n,r,o){const i=e.lastComponent;return i&&!o.oneChangePerToken&&i.added===t&&i.removed===n?{oldPos:e.oldPos+r,lastComponent:{count:i.count+1,added:t,removed:n,previousComponent:i.previousComponent}}:{oldPos:e.oldPos+r,lastComponent:{count:1,added:t,removed:n,previousComponent:i}}}extractCommon(e,t,n,r,o){const i=t.length,a=n.length;let s=e.oldPos,l=s-r,c=0;for(;l+1<i&&s+1<a&&this.equals(n[s+1],t[l+1],o);)l++,s++,c++,o.oneChangePerToken&&(e.lastComponent={count:1,previousComponent:e.lastComponent,added:!1,removed:!1});return c&&!o.oneChangePerToken&&(e.lastComponent={count:c,previousComponent:e.lastComponent,added:!1,removed:!1}),e.oldPos=s,l}equals(e,t,n){return n.comparator?n.comparator(e,t):e===t||!!n.ignoreCase&&e.toLowerCase()===t.toLowerCase()}removeEmpty(e){const t=[];for(let n=0;n<e.length;n++)e[n]&&t.push(e[n]);return t}castInput(e,t){return e}tokenize(e,t){return Array.from(e)}join(e){return e.join("")}postProcess(e,t){return e}get useLongestToken(){return!1}buildValues(e,t,n){const r=[];let o;for(;e;)r.push(e),o=e.previousComponent,delete e.previousComponent,e=o;r.reverse();const i=r.length;let a=0,s=0,l=0;for(;a<i;a++){const e=r[a];if(e.removed)e.value=this.join(n.slice(l,l+e.count)),l+=e.count;else{if(!e.added&&this.useLongestToken){let r=t.slice(s,s+e.count);r=r.map(function(e,t){const r=n[l+t];return r.length>e.length?r:e}),e.value=this.join(r)}else e.value=this.join(t.slice(s,s+e.count));s+=e.count,e.added||(l+=e.count)}}return r}}function zn(e,t){let n;for(n=0;n<e.length&&n<t.length;n++)if(e[n]!=t[n])return e.slice(0,n);return e.slice(0,n)}function Jn(e,t){let n;if(!e||!t||e[e.length-1]!=t[t.length-1])return"";for(n=0;n<e.length&&n<t.length;n++)if(e[e.length-(n+1)]!=t[t.length-(n+1)])return e.slice(-n);return e.slice(-n)}function Kn(e,t,n){if(e.slice(0,t.length)!=t)throw Error(`string ${JSON.stringify(e)} doesn't start with prefix ${JSON.stringify(t)}; this is a bug`);return n+e.slice(t.length)}function Zn(e,t,n){if(!t)return e+n;if(e.slice(-t.length)!=t)throw Error(`string ${JSON.stringify(e)} doesn't end with suffix ${JSON.stringify(t)}; this is a bug`);return e.slice(0,-t.length)+n}function Qn(e,t){return Kn(e,t,"")}function er(e,t){return Zn(e,t,"")}function tr(e,t){return t.slice(0,function(e,t){let n=0;e.length>t.length&&(n=e.length-t.length);let r=t.length;e.length<t.length&&(r=e.length);const o=Array(r);let i=0;o[0]=0;for(let e=1;e<r;e++){for(t[e]==t[i]?o[e]=o[i]:o[e]=i;i>0&&t[e]!=t[i];)i=o[i];t[e]==t[i]&&i++}i=0;for(let r=n;r<e.length;r++){for(;i>0&&e[r]!=t[i];)i=o[i];e[r]==t[i]&&i++}return i}(e,t))}function nr(e){let t;for(t=e.length-1;t>=0&&e[t].match(/\s/);t--);return e.substring(t+1)}function rr(e){const t=e.match(/^\s*/);return t?t[0]:""}const or="a-zA-Z0-9_\\u{C0}-\\u{FF}\\u{D8}-\\u{F6}\\u{F8}-\\u{2C6}\\u{2C8}-\\u{2D7}\\u{2DE}-\\u{2FF}\\u{1E00}-\\u{1EFF}",ir=new RegExp(`[${or}]+|\\s+|[^${or}]`,"ug");const ar=new class extends Xn{equals(e,t,n){return n.ignoreCase&&(e=e.toLowerCase(),t=t.toLowerCase()),e.trim()===t.trim()}tokenize(e,t={}){let n;if(t.intlSegmenter){const r=t.intlSegmenter;if("word"!=r.resolvedOptions().granularity)throw new Error('The segmenter passed must have a granularity of "word"');n=Array.from(r.segment(e),e=>e.segment)}else n=e.match(ir)||[];const r=[];let o=null;return n.forEach(e=>{/\s/.test(e)?null==o?r.push(e):r.push(r.pop()+e):null!=o&&/\s/.test(o)?r[r.length-1]==o?r.push(r.pop()+e):r.push(o+e):r.push(e),o=e}),r}join(e){return e.map((e,t)=>0==t?e:e.replace(/^\s+/,"")).join("")}postProcess(e,t){if(!e||t.oneChangePerToken)return e;let n=null,r=null,o=null;return e.forEach(e=>{e.added?r=e:e.removed?o=e:((r||o)&&lr(n,o,r,e),n=e,r=null,o=null)}),(r||o)&&lr(n,o,r,null),e}};function sr(e,t,n){return null==(null==n?void 0:n.ignoreWhitespace)||n.ignoreWhitespace?ar.diff(e,t,n):function(e,t,n){return cr.diff(e,t,n)}(e,t,n)}function lr(e,t,n,r){if(t&&n){const o=rr(t.value),i=nr(t.value),a=rr(n.value),s=nr(n.value);if(e){const r=zn(o,a);e.value=Zn(e.value,a,r),t.value=Qn(t.value,r),n.value=Qn(n.value,r)}if(r){const e=Jn(i,s);r.value=Kn(r.value,s,e),t.value=er(t.value,e),n.value=er(n.value,e)}}else if(n){if(e){const e=rr(n.value);n.value=n.value.substring(e.length)}if(r){const e=rr(r.value);r.value=r.value.substring(e.length)}}else if(e&&r){const n=rr(r.value),o=rr(t.value),i=nr(t.value),a=zn(n,o);t.value=Qn(t.value,a);const s=Jn(Qn(n,a),i);t.value=er(t.value,s),r.value=Kn(r.value,n,s),e.value=Zn(e.value,n,n.slice(0,n.length-s.length))}else if(r){const e=rr(r.value),n=tr(nr(t.value),e);t.value=er(t.value,n)}else if(e){const n=tr(nr(e.value),rr(t.value));t.value=Qn(t.value,n)}}const cr=new class extends Xn{tokenize(e){const t=new RegExp(`(\\r?\\n)|[${or}]+|[^\\S\\n\\r]+|[^${or}]`,"ug");return e.match(t)||[]}};var ur,pr;!function(e){e[e.TEXT=1]="TEXT",e[e.CONFIRM=2]="CONFIRM",e[e.INPUT=3]="INPUT",e[e.DISPLAY=4]="DISPLAY"}(ur||(ur={})),function(e){e[e.AFFIRMATIVE=1]="AFFIRMATIVE",e[e.NEGATIVE=0]="NEGATIVE",e[e.CANCELLED=null]="CANCELLED"}(pr||(pr={}));const dr={preserveOrder:!1,attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,removeNSPrefix:!1,allowBooleanAttributes:!1,parseTagValue:!0,parseAttributeValue:!1,trimValues:!0,cdataPropName:!1,numberParseOptions:{hex:!0,leadingZeros:!0,eNotation:!0},tagValueProcessor:function(e,t){return t},attributeValueProcessor:function(e,t){return t},stopNodes:[],alwaysCreateTextNode:!1,isArray:()=>!1,commentPropName:!1,unpairedTags:[],processEntities:!0,htmlEntities:!1,ignoreDeclaration:!1,ignorePiTags:!1,transformTagName:!1,transformAttributeName:!1,updateTag:function(e,t,n){return e},captureMetaData:!1},hr=":A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",fr=new RegExp("^"+("["+hr+"]["+(hr+"\\-.\\d\\u00B7\\u0300-\\u036F\\u203F-\\u2040")+"]*")+"$");function mr(e,t){const n=[];let r=t.exec(e);for(;r;){const o=[];o.startIndex=t.lastIndex-r[0].length;const i=r.length;for(let e=0;e<i;e++)o.push(r[e]);n.push(o),r=t.exec(e)}return n}const gr=function(e){const t=fr.exec(e);return!(null==t)};let vr;vr="function"!=typeof Symbol?"@@xmlMetadata":Symbol("XML Node Metadata");class yr{constructor(e){this.tagname=e,this.child=[],this[":@"]={}}add(e,t){"__proto__"===e&&(e="#__proto__"),this.child.push({[e]:t})}addChild(e,t){"__proto__"===e.tagname&&(e.tagname="#__proto__"),e[":@"]&&Object.keys(e[":@"]).length>0?this.child.push({[e.tagname]:e.child,":@":e[":@"]}):this.child.push({[e.tagname]:e.child}),void 0!==t&&(this.child[this.child.length-1][vr]={startIndex:t})}static getMetaDataSymbol(){return vr}}function br(e,t){const n={};if("O"!==e[t+3]||"C"!==e[t+4]||"T"!==e[t+5]||"Y"!==e[t+6]||"P"!==e[t+7]||"E"!==e[t+8])throw new Error("Invalid Tag instead of DOCTYPE");{t+=9;let r=1,o=!1,i=!1,a="";for(;t<e.length;t++)if("<"!==e[t]||i)if(">"===e[t]){if(i?"-"===e[t-1]&&"-"===e[t-2]&&(i=!1,r--):r--,0===r)break}else"["===e[t]?o=!0:a+=e[t];else{if(o&&Er(e,"!ENTITY",t)){let r,o;t+=7,[r,o,t]=xr(e,t+1),-1===o.indexOf("&")&&(n[r]={regx:RegExp(`&${r};`,"g"),val:o})}else if(o&&Er(e,"!ELEMENT",t)){t+=8;const{index:n}=_r(e,t+1);t=n}else if(o&&Er(e,"!ATTLIST",t))t+=8;else if(o&&Er(e,"!NOTATION",t)){t+=9;const{index:n}=wr(e,t+1);t=n}else{if(!Er(e,"!--",t))throw new Error("Invalid DOCTYPE");i=!0}r++,a=""}if(0!==r)throw new Error("Unclosed DOCTYPE")}return{entities:n,i:t}}const Sr=(e,t)=>{for(;t<e.length&&/\s/.test(e[t]);)t++;return t};function xr(e,t){t=Sr(e,t);let n="";for(;t<e.length&&!/\s/.test(e[t])&&'"'!==e[t]&&"'"!==e[t];)n+=e[t],t++;if(kr(n),t=Sr(e,t),"SYSTEM"===e.substring(t,t+6).toUpperCase())throw new Error("External entities are not supported");if("%"===e[t])throw new Error("Parameter entities are not supported");let r="";return[t,r]=Cr(e,t,"entity"),[n,r,--t]}function wr(e,t){t=Sr(e,t);let n="";for(;t<e.length&&!/\s/.test(e[t]);)n+=e[t],t++;kr(n),t=Sr(e,t);const r=e.substring(t,t+6).toUpperCase();if("SYSTEM"!==r&&"PUBLIC"!==r)throw new Error(`Expected SYSTEM or PUBLIC, found "${r}"`);t+=r.length,t=Sr(e,t);let o=null,i=null;if("PUBLIC"===r)[t,o]=Cr(e,t,"publicIdentifier"),'"'!==e[t=Sr(e,t)]&&"'"!==e[t]||([t,i]=Cr(e,t,"systemIdentifier"));else if("SYSTEM"===r&&([t,i]=Cr(e,t,"systemIdentifier"),!i))throw new Error("Missing mandatory system identifier for SYSTEM notation");return{notationName:n,publicIdentifier:o,systemIdentifier:i,index:--t}}function Cr(e,t,n){let r="";const o=e[t];if('"'!==o&&"'"!==o)throw new Error(`Expected quoted string, found "${o}"`);for(t++;t<e.length&&e[t]!==o;)r+=e[t],t++;if(e[t]!==o)throw new Error(`Unterminated ${n} value`);return[++t,r]}function _r(e,t){t=Sr(e,t);let n="";for(;t<e.length&&!/\s/.test(e[t]);)n+=e[t],t++;if(!kr(n))throw new Error(`Invalid element name: "${n}"`);let r="";if("E"===e[t=Sr(e,t)]&&Er(e,"MPTY",t))t+=4;else if("A"===e[t]&&Er(e,"NY",t))t+=2;else{if("("!==e[t])throw new Error(`Invalid Element Expression, found "${e[t]}"`);for(t++;t<e.length&&")"!==e[t];)r+=e[t],t++;if(")"!==e[t])throw new Error("Unterminated content model")}return{elementName:n,contentModel:r.trim(),index:t}}function Er(e,t,n){for(let r=0;r<t.length;r++)if(t[r]!==e[n+r+1])return!1;return!0}function kr(e){if(gr(e))return e;throw new Error(`Invalid entity name ${e}`)}const Pr=/^[-+]?0x[a-fA-F0-9]+$/,Dr=/^([\-\+])?(0*)([0-9]*(\.[0-9]*)?)$/,Tr={hex:!0,leadingZeros:!0,decimalPoint:".",eNotation:!0};function Ir(e,t={}){if(t=Object.assign({},Tr,t),!e||"string"!=typeof e)return e;let n=e.trim();if(void 0!==t.skipLike&&t.skipLike.test(n))return e;if("0"===e)return 0;if(t.hex&&Pr.test(n))return function(e,t){if(parseInt)return parseInt(e,t);if(Number.parseInt)return Number.parseInt(e,t);if(window&&window.parseInt)return window.parseInt(e,t);throw new Error("parseInt, Number.parseInt, window.parseInt are not supported")}(n,16);if(-1!==n.search(/.+[eE].+/))return function(e,t,n){if(!n.eNotation)return e;const r=t.match(Ar);if(r){let o=r[1]||"";const i=-1===r[3].indexOf("e")?"E":"e",a=r[2],s=o?e[a.length+1]===i:e[a.length]===i;return a.length>1&&s?e:1!==a.length||!r[3].startsWith(`.${i}`)&&r[3][0]!==i?n.leadingZeros&&!s?(t=(r[1]||"")+r[3],Number(t)):e:Number(t)}return e}(e,n,t);{const r=Dr.exec(n);if(r){const o=r[1]||"",i=r[2];let a=function(e){if(e&&-1!==e.indexOf("."))return"."===(e=e.replace(/0+$/,""))?e="0":"."===e[0]?e="0"+e:"."===e[e.length-1]&&(e=e.substring(0,e.length-1)),e;return e}(r[3]);const s=o?"."===e[i.length+1]:"."===e[i.length];if(!t.leadingZeros&&(i.length>1||1===i.length&&!s))return e;{const r=Number(n),s=String(r);if(0===r)return r;if(-1!==s.search(/[eE]/))return t.eNotation?r:e;if(-1!==n.indexOf("."))return"0"===s||s===a||s===`${o}${a}`?r:e;let l=i?a:n;return i?l===s||o+l===s?r:e:l===s||l===o+s?r:e}}return e}}const Ar=/^([-+])?(0*)(\d*(\.\d*)?[eE][-\+]?\d+)$/;class Nr{constructor(e){var t;this.options=e,this.currentNode=null,this.tagsNodeStack=[],this.docTypeEntities={},this.lastEntities={apos:{regex:/&(apos|#39|#x27);/g,val:"'"},gt:{regex:/&(gt|#62|#x3E);/g,val:">"},lt:{regex:/&(lt|#60|#x3C);/g,val:"<"},quot:{regex:/&(quot|#34|#x22);/g,val:'"'}},this.ampEntity={regex:/&(amp|#38|#x26);/g,val:"&"},this.htmlEntities={space:{regex:/&(nbsp|#160);/g,val:" "},cent:{regex:/&(cent|#162);/g,val:"¢"},pound:{regex:/&(pound|#163);/g,val:"£"},yen:{regex:/&(yen|#165);/g,val:"¥"},euro:{regex:/&(euro|#8364);/g,val:"€"},copyright:{regex:/&(copy|#169);/g,val:"©"},reg:{regex:/&(reg|#174);/g,val:"®"},inr:{regex:/&(inr|#8377);/g,val:"₹"},num_dec:{regex:/&#([0-9]{1,7});/g,val:(e,t)=>String.fromCodePoint(Number.parseInt(t,10))},num_hex:{regex:/&#x([0-9a-fA-F]{1,6});/g,val:(e,t)=>String.fromCodePoint(Number.parseInt(t,16))}},this.addExternalEntities=Or,this.parseXml=jr,this.parseTextData=Fr,this.resolveNameSpace=Lr,this.buildAttributesMap=Br,this.isItStopNode=qr,this.replaceEntitiesValue=$r,this.readStopNodeData=Wr,this.saveTextToParentTag=Hr,this.addChild=Rr,this.ignoreAttributesFn="function"==typeof(t=this.options.ignoreAttributes)?t:Array.isArray(t)?e=>{for(const n of t){if("string"==typeof n&&e===n)return!0;if(n instanceof RegExp&&n.test(e))return!0}}:()=>!1}}function Or(e){const t=Object.keys(e);for(let n=0;n<t.length;n++){const r=t[n];this.lastEntities[r]={regex:new RegExp("&"+r+";","g"),val:e[r]}}}function Fr(e,t,n,r,o,i,a){if(void 0!==e&&(this.options.trimValues&&!r&&(e=e.trim()),e.length>0)){a||(e=this.replaceEntitiesValue(e));const r=this.options.tagValueProcessor(t,e,n,o,i);if(null==r)return e;if(typeof r!=typeof e||r!==e)return r;if(this.options.trimValues)return Gr(e,this.options.parseTagValue,this.options.numberParseOptions);return e.trim()===e?Gr(e,this.options.parseTagValue,this.options.numberParseOptions):e}}function Lr(e){if(this.options.removeNSPrefix){const t=e.split(":"),n="/"===e.charAt(0)?"/":"";if("xmlns"===t[0])return"";2===t.length&&(e=n+t[1])}return e}const Mr=new RegExp("([^\\s=]+)\\s*(=\\s*(['\"])([\\s\\S]*?)\\3)?","gm");function Br(e,t,n){if(!0!==this.options.ignoreAttributes&&"string"==typeof e){const n=mr(e,Mr),r=n.length,o={};for(let e=0;e<r;e++){const r=this.resolveNameSpace(n[e][1]);if(this.ignoreAttributesFn(r,t))continue;let i=n[e][4],a=this.options.attributeNamePrefix+r;if(r.length)if(this.options.transformAttributeName&&(a=this.options.transformAttributeName(a)),"__proto__"===a&&(a="#__proto__"),void 0!==i){this.options.trimValues&&(i=i.trim()),i=this.replaceEntitiesValue(i);const e=this.options.attributeValueProcessor(r,i,t);o[a]=null==e?i:typeof e!=typeof i||e!==i?e:Gr(i,this.options.parseAttributeValue,this.options.numberParseOptions)}else this.options.allowBooleanAttributes&&(o[a]=!0)}if(!Object.keys(o).length)return;if(this.options.attributesGroupName){const e={};return e[this.options.attributesGroupName]=o,e}return o}}const jr=function(e){e=e.replace(/\r\n?/g,"\n");const t=new yr("!xml");let n=t,r="",o="";for(let i=0;i<e.length;i++){if("<"===e[i])if("/"===e[i+1]){const t=Vr(e,">",i,"Closing Tag is not closed.");let a=e.substring(i+2,t).trim();if(this.options.removeNSPrefix){const e=a.indexOf(":");-1!==e&&(a=a.substr(e+1))}this.options.transformTagName&&(a=this.options.transformTagName(a)),n&&(r=this.saveTextToParentTag(r,n,o));const s=o.substring(o.lastIndexOf(".")+1);if(a&&-1!==this.options.unpairedTags.indexOf(a))throw new Error(`Unpaired tag can not be used as closing tag: </${a}>`);let l=0;s&&-1!==this.options.unpairedTags.indexOf(s)?(l=o.lastIndexOf(".",o.lastIndexOf(".")-1),this.tagsNodeStack.pop()):l=o.lastIndexOf("."),o=o.substring(0,l),n=this.tagsNodeStack.pop(),r="",i=t}else if("?"===e[i+1]){let t=Ur(e,i,!1,"?>");if(!t)throw new Error("Pi Tag is not closed.");if(r=this.saveTextToParentTag(r,n,o),this.options.ignoreDeclaration&&"?xml"===t.tagName||this.options.ignorePiTags);else{const e=new yr(t.tagName);e.add(this.options.textNodeName,""),t.tagName!==t.tagExp&&t.attrExpPresent&&(e[":@"]=this.buildAttributesMap(t.tagExp,o,t.tagName)),this.addChild(n,e,o,i)}i=t.closeIndex+1}else if("!--"===e.substr(i+1,3)){const t=Vr(e,"--\x3e",i+4,"Comment is not closed.");if(this.options.commentPropName){const a=e.substring(i+4,t-2);r=this.saveTextToParentTag(r,n,o),n.add(this.options.commentPropName,[{[this.options.textNodeName]:a}])}i=t}else if("!D"===e.substr(i+1,2)){const t=br(e,i);this.docTypeEntities=t.entities,i=t.i}else if("!["===e.substr(i+1,2)){const t=Vr(e,"]]>",i,"CDATA is not closed.")-2,a=e.substring(i+9,t);r=this.saveTextToParentTag(r,n,o);let s=this.parseTextData(a,n.tagname,o,!0,!1,!0,!0);null==s&&(s=""),this.options.cdataPropName?n.add(this.options.cdataPropName,[{[this.options.textNodeName]:a}]):n.add(this.options.textNodeName,s),i=t+2}else{let a=Ur(e,i,this.options.removeNSPrefix),s=a.tagName;const l=a.rawTagName;let c=a.tagExp,u=a.attrExpPresent,p=a.closeIndex;this.options.transformTagName&&(s=this.options.transformTagName(s)),n&&r&&"!xml"!==n.tagname&&(r=this.saveTextToParentTag(r,n,o,!1));const d=n;d&&-1!==this.options.unpairedTags.indexOf(d.tagname)&&(n=this.tagsNodeStack.pop(),o=o.substring(0,o.lastIndexOf("."))),s!==t.tagname&&(o+=o?"."+s:s);const h=i;if(this.isItStopNode(this.options.stopNodes,o,s)){let t="";if(c.length>0&&c.lastIndexOf("/")===c.length-1)"/"===s[s.length-1]?(s=s.substr(0,s.length-1),o=o.substr(0,o.length-1),c=s):c=c.substr(0,c.length-1),i=a.closeIndex;else if(-1!==this.options.unpairedTags.indexOf(s))i=a.closeIndex;else{const n=this.readStopNodeData(e,l,p+1);if(!n)throw new Error(`Unexpected end of ${l}`);i=n.i,t=n.tagContent}const r=new yr(s);s!==c&&u&&(r[":@"]=this.buildAttributesMap(c,o,s)),t&&(t=this.parseTextData(t,s,o,!0,u,!0,!0)),o=o.substr(0,o.lastIndexOf(".")),r.add(this.options.textNodeName,t),this.addChild(n,r,o,h)}else{if(c.length>0&&c.lastIndexOf("/")===c.length-1){"/"===s[s.length-1]?(s=s.substr(0,s.length-1),o=o.substr(0,o.length-1),c=s):c=c.substr(0,c.length-1),this.options.transformTagName&&(s=this.options.transformTagName(s));const e=new yr(s);s!==c&&u&&(e[":@"]=this.buildAttributesMap(c,o,s)),this.addChild(n,e,o,h),o=o.substr(0,o.lastIndexOf("."))}else{const e=new yr(s);this.tagsNodeStack.push(n),s!==c&&u&&(e[":@"]=this.buildAttributesMap(c,o,s)),this.addChild(n,e,o,h),n=e}r="",i=p}}else r+=e[i]}return t.child};function Rr(e,t,n,r){this.options.captureMetaData||(r=void 0);const o=this.options.updateTag(t.tagname,n,t[":@"]);!1===o||("string"==typeof o?(t.tagname=o,e.addChild(t,r)):e.addChild(t,r))}const $r=function(e){if(this.options.processEntities){for(let t in this.docTypeEntities){const n=this.docTypeEntities[t];e=e.replace(n.regx,n.val)}for(let t in this.lastEntities){const n=this.lastEntities[t];e=e.replace(n.regex,n.val)}if(this.options.htmlEntities)for(let t in this.htmlEntities){const n=this.htmlEntities[t];e=e.replace(n.regex,n.val)}e=e.replace(this.ampEntity.regex,this.ampEntity.val)}return e};function Hr(e,t,n,r){return e&&(void 0===r&&(r=0===t.child.length),void 0!==(e=this.parseTextData(e,t.tagname,n,!1,!!t[":@"]&&0!==Object.keys(t[":@"]).length,r))&&""!==e&&t.add(this.options.textNodeName,e),e=""),e}function qr(e,t,n){const r="*."+n;for(const n in e){const o=e[n];if(r===o||t===o)return!0}return!1}function Vr(e,t,n,r){const o=e.indexOf(t,n);if(-1===o)throw new Error(r);return o+t.length-1}function Ur(e,t,n,r=">"){const o=function(e,t,n=">"){let r,o="";for(let i=t;i<e.length;i++){let t=e[i];if(r)t===r&&(r="");else if('"'===t||"'"===t)r=t;else if(t===n[0]){if(!n[1])return{data:o,index:i};if(e[i+1]===n[1])return{data:o,index:i}}else"\t"===t&&(t=" ");o+=t}}(e,t+1,r);if(!o)return;let i=o.data;const a=o.index,s=i.search(/\s/);let l=i,c=!0;-1!==s&&(l=i.substring(0,s),i=i.substring(s+1).trimStart());const u=l;if(n){const e=l.indexOf(":");-1!==e&&(l=l.substr(e+1),c=l!==o.data.substr(e+1))}return{tagName:l,tagExp:i,closeIndex:a,attrExpPresent:c,rawTagName:u}}function Wr(e,t,n){const r=n;let o=1;for(;n<e.length;n++)if("<"===e[n])if("/"===e[n+1]){const i=Vr(e,">",n,`${t} is not closed`);if(e.substring(n+2,i).trim()===t&&(o--,0===o))return{tagContent:e.substring(r,n),i};n=i}else if("?"===e[n+1]){n=Vr(e,"?>",n+1,"StopNode is not closed.")}else if("!--"===e.substr(n+1,3)){n=Vr(e,"--\x3e",n+3,"StopNode is not closed.")}else if("!["===e.substr(n+1,2)){n=Vr(e,"]]>",n,"StopNode is not closed.")-2}else{const r=Ur(e,n,">");if(r){(r&&r.tagName)===t&&"/"!==r.tagExp[r.tagExp.length-1]&&o++,n=r.closeIndex}}}function Gr(e,t,n){if(t&&"string"==typeof e){const t=e.trim();return"true"===t||"false"!==t&&Ir(e,n)}return void 0!==e?e:""}const Yr=yr.getMetaDataSymbol();function Xr(e,t){return zr(e,t)}function zr(e,t,n){let r;const o={};for(let i=0;i<e.length;i++){const a=e[i],s=Jr(a);let l="";if(l=void 0===n?s:n+"."+s,s===t.textNodeName)void 0===r?r=a[s]:r+=""+a[s];else{if(void 0===s)continue;if(a[s]){let e=zr(a[s],t,l);const n=Zr(e,t);void 0!==a[Yr]&&(e[Yr]=a[Yr]),a[":@"]?Kr(e,a[":@"],l,t):1!==Object.keys(e).length||void 0===e[t.textNodeName]||t.alwaysCreateTextNode?0===Object.keys(e).length&&(t.alwaysCreateTextNode?e[t.textNodeName]="":e=""):e=e[t.textNodeName],void 0!==o[s]&&o.hasOwnProperty(s)?(Array.isArray(o[s])||(o[s]=[o[s]]),o[s].push(e)):t.isArray(s,l,n)?o[s]=[e]:o[s]=e}}}return"string"==typeof r?r.length>0&&(o[t.textNodeName]=r):void 0!==r&&(o[t.textNodeName]=r),o}function Jr(e){const t=Object.keys(e);for(let e=0;e<t.length;e++){const n=t[e];if(":@"!==n)return n}}function Kr(e,t,n,r){if(t){const o=Object.keys(t),i=o.length;for(let a=0;a<i;a++){const i=o[a];r.isArray(i,n+"."+i,!0,!0)?e[i]=[t[i]]:e[i]=t[i]}}}function Zr(e,t){const{textNodeName:n}=t,r=Object.keys(e).length;return 0===r||!(1!==r||!e[n]&&"boolean"!=typeof e[n]&&0!==e[n])}const Qr={allowBooleanAttributes:!1,unpairedTags:[]};function eo(e){return" "===e||"\t"===e||"\n"===e||"\r"===e}function to(e,t){const n=t;for(;t<e.length;t++)if("?"==e[t]||" "==e[t]){const r=e.substr(n,t-n);if(t>5&&"xml"===r)return co("InvalidXml","XML declaration allowed only at the start of the document.",ho(e,t));if("?"==e[t]&&">"==e[t+1]){t++;break}continue}return t}function no(e,t){if(e.length>t+5&&"-"===e[t+1]&&"-"===e[t+2]){for(t+=3;t<e.length;t++)if("-"===e[t]&&"-"===e[t+1]&&">"===e[t+2]){t+=2;break}}else if(e.length>t+8&&"D"===e[t+1]&&"O"===e[t+2]&&"C"===e[t+3]&&"T"===e[t+4]&&"Y"===e[t+5]&&"P"===e[t+6]&&"E"===e[t+7]){let n=1;for(t+=8;t<e.length;t++)if("<"===e[t])n++;else if(">"===e[t]&&(n--,0===n))break}else if(e.length>t+9&&"["===e[t+1]&&"C"===e[t+2]&&"D"===e[t+3]&&"A"===e[t+4]&&"T"===e[t+5]&&"A"===e[t+6]&&"["===e[t+7])for(t+=8;t<e.length;t++)if("]"===e[t]&&"]"===e[t+1]&&">"===e[t+2]){t+=2;break}return t}const ro='"',oo="'";function io(e,t){let n="",r="",o=!1;for(;t<e.length;t++){if(e[t]===ro||e[t]===oo)""===r?r=e[t]:r!==e[t]||(r="");else if(">"===e[t]&&""===r){o=!0;break}n+=e[t]}return""===r&&{value:n,index:t,tagClosed:o}}const ao=new RegExp("(\\s*)([^\\s=]+)(\\s*=)?(\\s*(['\"])(([\\s\\S])*?)\\5)?","g");function so(e,t){const n=mr(e,ao),r={};for(let e=0;e<n.length;e++){if(0===n[e][1].length)return co("InvalidAttr","Attribute '"+n[e][2]+"' has no space in starting.",fo(n[e]));if(void 0!==n[e][3]&&void 0===n[e][4])return co("InvalidAttr","Attribute '"+n[e][2]+"' is without value.",fo(n[e]));if(void 0===n[e][3]&&!t.allowBooleanAttributes)return co("InvalidAttr","boolean attribute '"+n[e][2]+"' is not allowed.",fo(n[e]));const o=n[e][2];if(!uo(o))return co("InvalidAttr","Attribute '"+o+"' is an invalid name.",fo(n[e]));if(r.hasOwnProperty(o))return co("InvalidAttr","Attribute '"+o+"' is repeated.",fo(n[e]));r[o]=1}return!0}function lo(e,t){if(";"===e[++t])return-1;if("#"===e[t])return function(e,t){let n=/\d/;for("x"===e[t]&&(t++,n=/[\da-fA-F]/);t<e.length;t++){if(";"===e[t])return t;if(!e[t].match(n))break}return-1}(e,++t);let n=0;for(;t<e.length;t++,n++)if(!(e[t].match(/\w/)&&n<20)){if(";"===e[t])break;return-1}return t}function co(e,t,n){return{err:{code:e,msg:t,line:n.line||n,col:n.col}}}function uo(e){return gr(e)}function po(e){return gr(e)}function ho(e,t){const n=e.substring(0,t).split(/\r?\n/);return{line:n.length,col:n[n.length-1].length+1}}function fo(e){return e.startIndex+e[1].length}var mo=new class{constructor(e){this.externalEntities={},this.options=function(e){return Object.assign({},dr,e)}(e)}parse(e,t){if("string"==typeof e);else{if(!e.toString)throw new Error("XML data is accepted in String or Bytes[] form.");e=e.toString()}if(t){!0===t&&(t={});const n=function(e,t){t=Object.assign({},Qr,t);const n=[];let r=!1,o=!1;"\ufeff"===e[0]&&(e=e.substr(1));for(let i=0;i<e.length;i++)if("<"===e[i]&&"?"===e[i+1]){if(i+=2,i=to(e,i),i.err)return i}else{if("<"!==e[i]){if(eo(e[i]))continue;return co("InvalidChar","char '"+e[i]+"' is not expected.",ho(e,i))}{let a=i;if(i++,"!"===e[i]){i=no(e,i);continue}{let s=!1;"/"===e[i]&&(s=!0,i++);let l="";for(;i<e.length&&">"!==e[i]&&" "!==e[i]&&"\t"!==e[i]&&"\n"!==e[i]&&"\r"!==e[i];i++)l+=e[i];if(l=l.trim(),"/"===l[l.length-1]&&(l=l.substring(0,l.length-1),i--),!po(l)){let t;return t=0===l.trim().length?"Invalid space after '<'.":"Tag '"+l+"' is an invalid name.",co("InvalidTag",t,ho(e,i))}const c=io(e,i);if(!1===c)return co("InvalidAttr","Attributes for '"+l+"' have open quote.",ho(e,i));let u=c.value;if(i=c.index,"/"===u[u.length-1]){const n=i-u.length;u=u.substring(0,u.length-1);const o=so(u,t);if(!0!==o)return co(o.err.code,o.err.msg,ho(e,n+o.err.line));r=!0}else if(s){if(!c.tagClosed)return co("InvalidTag","Closing tag '"+l+"' doesn't have proper closing.",ho(e,i));if(u.trim().length>0)return co("InvalidTag","Closing tag '"+l+"' can't have attributes or invalid starting.",ho(e,a));if(0===n.length)return co("InvalidTag","Closing tag '"+l+"' has not been opened.",ho(e,a));{const t=n.pop();if(l!==t.tagName){let n=ho(e,t.tagStartPos);return co("InvalidTag","Expected closing tag '"+t.tagName+"' (opened in line "+n.line+", col "+n.col+") instead of closing tag '"+l+"'.",ho(e,a))}0==n.length&&(o=!0)}}else{const s=so(u,t);if(!0!==s)return co(s.err.code,s.err.msg,ho(e,i-u.length+s.err.line));if(!0===o)return co("InvalidXml","Multiple possible root nodes found.",ho(e,i));-1!==t.unpairedTags.indexOf(l)||n.push({tagName:l,tagStartPos:a}),r=!0}for(i++;i<e.length;i++)if("<"===e[i]){if("!"===e[i+1]){i++,i=no(e,i);continue}if("?"!==e[i+1])break;if(i=to(e,++i),i.err)return i}else if("&"===e[i]){const t=lo(e,i);if(-1==t)return co("InvalidChar","char '&' is not expected.",ho(e,i));i=t}else if(!0===o&&!eo(e[i]))return co("InvalidXml","Extra text at the end",ho(e,i));"<"===e[i]&&i--}}}return r?1==n.length?co("InvalidTag","Unclosed tag '"+n[0].tagName+"'.",ho(e,n[0].tagStartPos)):!(n.length>0)||co("InvalidXml","Invalid '"+JSON.stringify(n.map(e=>e.tagName),null,4).replace(/\r?\n/g,"")+"' found.",{line:1,col:1}):co("InvalidXml","Start tag expected.",1)}(e,t);if(!0!==n)throw Error(`${n.err.msg}:${n.err.line}:${n.err.col}`)}const n=new Nr(this.options);n.addExternalEntities(this.externalEntities);const r=n.parseXml(e);return this.options.preserveOrder||void 0===r?r:Xr(r,this.options)}addEntity(e,t){if(-1!==t.indexOf("&"))throw new Error("Entity value can't have '&'");if(-1!==e.indexOf("&")||-1!==e.indexOf(";"))throw new Error("An entity must be set without '&' and ';'. Eg. use '#xD' for '&#xD;'");if("&"===t)throw new Error("An entity with value '&' is not permitted");this.externalEntities[e]=t}static getMetaDataSymbol(){return yr.getMetaDataSymbol()}}({ignoreAttributes:!1,allowBooleanAttributes:!0});function go(e,t){var n,r,o,i,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=e.match(/```(?:\w+\n|\n)([\s\S]*?)```/),l=s?s[1].trim():e.trim();a.previousContent&&(l=a.previousContent+l.trimEnd());try{switch(t){case"xml":var c=mo.parse(l),u=null!==(n=null!==(r=null==c?void 0:c.response)&&void 0!==r?r:null==c||null===(o=c.root)||void 0===o?void 0:o.response)&&void 0!==n?n:null==c||null===(i=c.data)||void 0===i?void 0:i.response;if("string"==typeof u)return u.trim();if(u&&"string"==typeof u["#text"])return u["#text"].trim();if(c&&Object.keys(c).length>0){var p=Object.values(c)[0];if("string"==typeof p)return p.trim();if("string"==typeof(null==p?void 0:p["#text"]))return p["#text"].trim()}throw new Error("Invalid XML format: <response> tag content not found or not a string.");case"json":var d=JSON.parse(l);if(d&&"string"==typeof d.response)return d.response.trim();if(null!=d&&d.response&&Object.keys(d.response).length>0)return String(Object.values(d.response)[0]).trim();if(d&&Object.keys(d).length>0)return String(Object.values(d)[0]).trim();throw new Error('Invalid JSON format: "response" key not found or its value is not a string.');case"none":return l;default:throw new Error("Unsupported format specified: ".concat(t))}}catch(n){throw console.error("Error parsing response in format '".concat(t,"':"),n),console.error("Raw content received:",e),"xml"===t&&n.message.includes("Invalid XML")?new Error("Model response is not valid XML or does not contain the <response> tag."):"json"===t&&n instanceof SyntaxError?new Error('Model response is not valid JSON or does not follow the {"response": "..."} structure.'):new Error("Failed to parse response as ".concat(t,": ").concat(n.message))}}function vo(e,t){var n=e.trim();switch(t){case"xml":return"<response>\n  ".concat(n);case"json":return'{\n  "response": "'.concat(n);case"none":return n;default:throw new Error("Unsupported format specified: ".concat(t))}}var yo='=======\n\nWhen creating a **character card** in SillyTavern, you can define a structured profile to guide the AI\'s behavior and ensure consistency in roleplay or storytelling. Below are the common fields and their purposes, based on community templates and best practices:\n\n---\n\n### **1. Name**\n**Purpose**:\nThe character\'s primary identifier. The AI uses this to reference the character in dialogue and narration.\n**Key Tips**:\n- Use a memorable name that reflects their role (e.g., "Zara the Shadowblade" implies stealth/combat).\n- Avoid overly complex or ambiguous names (e.g., "Xy\'lthraa" may confuse the AI).\n**Example**:\n`"Seraphina Vale"` (Elegant, hints at nobility) vs. `"Rusty"` (Casual, rugged).\n\n---\n\n### **2. Description**\n**Purpose**:\nA snapshot of the character\'s identity, combining **appearance**, **personality**, and **key traits** to guide the AI\'s "mental image."\n**Structure**:\n- **Appearance**: Physical traits (e.g., scars, clothing, species).\n- **Personality**: Core demeanor (e.g., stoic, playful).\n- **Mannerisms**: Unique habits (e.g., "taps fingers when lying").\n**Example**:\n> *"A hulking orc with moss-green skin and a chipped tusk, wearing a patchwork cloak. Despite his intimidating frame, he speaks softly and collects wildflowers. Secretly fears fire."*\n**Tips**:\n- Use vivid, concise language.\n- Prioritize traits critical to roleplay (e.g., "blind in one eye" affects interactions).\n\n---\n\n### **3. Personality**\n**Purpose**:\nExplicitly defines **how the character thinks/behaves**, reducing ambiguity for the AI.\n**What to Include**:\n- Core traits (e.g., "optimistic", "paranoid").\n- Motivations (e.g., "seeks revenge against the crown").\n- Flaws (e.g., "impulsive", "overly trusting").\n**Example**:\n`"Charismatic but manipulative; values loyalty only when it benefits him. Haunted by guilt over a failed rescue mission."`\n**Tips**:\n- Use bullet points or short phrases for clarity.\n- Avoid contradictions (e.g., "shy" vs. "loves public speaking").\n\n---\n\n### **4. Scenario**\n**Purpose**:\nSets the stage for the interaction, providing **contextual boundaries** for the AI.\n**What to Include**:\n- **Location**: Where the scene takes place (e.g., "a smoky tavern").\n- **Time**: Era or time-sensitive context (e.g., "during a solar eclipse").\n- **Relationship**: Predefined ties to the user (e.g., "childhood rivals reunited").\n**Example**:\n`"A cyberpunk night market in 2147. {{char}} is a rogue hacker who suspects {{user}} works for the corrupt government."`\n**Tips**:\n- Use dynamic placeholders like `{{user}}` to personalize the scenario.\n\n---\n\n### **5. First Message - Alternate Greetings**\n**Purpose**:\nThe character\'s **opening line**, critical for establishing tone, voice, and narrative momentum.\n**Key Elements**:\n- **Dialogue**: Shows speech style (formal, slang-heavy).\n- **Actions**: Subtle body language (e.g., "crosses arms skeptically").\n- **Hook**: Encourages user engagement (e.g., a question or mystery).\n**Example**:\n`*{{char}} adjusts her gas mask, voice muffled.* "You\'re the third outsider this week. What makes you think you\'ll survive the Wastes?"`\n**Tips**:\n- Avoid passive openings (e.g., "Hello, how can I help you?").\n- Mirror the character\'s personality (e.g., a shy character might stammer).\n\n---\n\n### **6. Example Dialogue**\n**Purpose**:\nTeaches the AI the character\'s **speech patterns**, **formatting preferences**, and **interaction style**.\n**Structure**:\n- Use `{{char}}` and `{{user}}` placeholders.\n- Mix dialogue and actions (e.g., `*{{char}} smirks.* "You\'re bold. I like that."`).\n- Show range (e.g., anger, sarcasm, vulnerability).\n**Example**:\n```\n{{user}}: Why should I trust you?\n{{char}}: *Pulls a dagger from her boot and twirls it.* "You shouldn\'t. But I\'m your only way out of this alive."\n```\n**Tips**:\n- Include 3–5 varied exchanges.\n- Match the character\'s voice (e.g., a poet might use metaphors).\n\n---\n\n### **7. Advanced Tips**\n- **Avoid "Wall of Text"**: Use line breaks and punctuation to improve readability for the AI.\n\n=======',bo="{{activeFormatInstructions}}",So="=== CURRENT CHARACTER FIELD VALUES ===\n{{#if fields.core}}\n**Core Fields:**\n{{#each fields.core as |value key|}}\n- **{{key}}:** {{#if value}}{{value}}{{else}}*Not provided*{{/if}}\n{{/each}}\n{{/if}}\n\n{{#if fields.alternate_greetings}}\n**Alternate Greetings:**\n{{#each fields.alternate_greetings as |value key|}}\n- **{{key}}:** {{#if value}}{{value}}{{else}}*Not provided*{{/if}}\n{{/each}}\n{{/if}}\n\n{{#if fields.draft}}\n**Draft Fields:**\n{{#each fields.draft as |value key|}}\n- **{{key}}:** {{#if value}}{{value}}{{else}}*Not provided*{{/if}}\n{{/each}}\n{{/if}}",xo='Your task is to generate the content for the "{{targetField}}" field of a character card. Base your response on the preceding context (chat history, persona, system prompts, character/lore definitions, existing fields, etc.).\n{{#if userInstructions}}\n\nFollow these user instructions: {{userInstructions}}\n{{/if}}\n{{#if fieldSpecificInstructions}}\n\nField-specific instructions: {{fieldSpecificInstructions}}\n{{/if}}';function wo(e){return wo="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},wo(e)}function Co(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function i(n,r,o,i){var l=r&&r.prototype instanceof s?r:s,c=Object.create(l.prototype);return _o(c,"_invoke",function(n,r,o){var i,s,l,c=0,u=o||[],p=!1,d={p:0,n:0,v:e,a:h,f:h.bind(e,4),d:function(t,n){return i=t,s=0,l=e,d.n=n,a}};function h(n,r){for(s=n,l=r,t=0;!p&&c&&!o&&t<u.length;t++){var o,i=u[t],h=d.p,f=i[2];n>3?(o=f===r)&&(l=i[(s=i[4])?5:(s=3,3)],i[4]=i[5]=e):i[0]<=h&&((o=n<2&&h<i[1])?(s=0,d.v=r,d.n=i[1]):h<f&&(o=n<3||i[0]>r||r>f)&&(i[4]=n,i[5]=r,d.n=f,s=0))}if(o||n>1)return a;throw p=!0,r}return function(o,u,f){if(c>1)throw TypeError("Generator is already running");for(p&&1===u&&h(u,f),s=u,l=f;(t=s<2?e:l)||!p;){i||(s?s<3?(s>1&&(d.n=-1),h(s,l)):d.n=l:d.v=l);try{if(c=2,i){if(s||(o="next"),t=i[o]){if(!(t=t.call(i,l)))throw TypeError("iterator result is not an object");if(!t.done)return t;l=t.value,s<2&&(s=0)}else 1===s&&(t=i.return)&&t.call(i),s<2&&(l=TypeError("The iterator does not provide a '"+o+"' method"),s=1);i=e}else if((t=(p=d.n<0)?l:n.call(r,d))!==a)break}catch(t){i=e,s=1,l=t}finally{c=1}}return{value:t,done:p}}}(n,o,i),!0),c}var a={};function s(){}function l(){}function c(){}t=Object.getPrototypeOf;var u=[][r]?t(t([][r]())):(_o(t={},r,function(){return this}),t),p=c.prototype=s.prototype=Object.create(u);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,_o(e,o,"GeneratorFunction")),e.prototype=Object.create(p),e}return l.prototype=c,_o(p,"constructor",c),_o(c,"constructor",l),l.displayName="GeneratorFunction",_o(c,o,"GeneratorFunction"),_o(p),_o(p,o,"Generator"),_o(p,r,function(){return this}),_o(p,"toString",function(){return"[object Generator]"}),(Co=function(){return{w:i,m:d}})()}function _o(e,t,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}_o=function(e,t,n,r){function i(t,n){_o(e,t,function(e){return this._invoke(t,n,e)})}t?o?o(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(i("next",0),i("throw",1),i("return",2))},_o(e,t,n,r)}function Eo(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function ko(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Eo(Object(n),!0).forEach(function(t){Po(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Eo(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function Po(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=wo(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=wo(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==wo(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Do(e,t,n,r,o,i,a){try{var s=e[i](a),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function To(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var i=e.apply(t,n);function a(e){Do(i,r,o,a,s,"next",e)}function s(e){Do(i,r,o,a,s,"throw",e)}a(void 0)})}}var Io="SillyTavern-Character-Creator-Chat",Ao="0.2.2",No=["stDescription","charDefinitions","lorebookDefinitions","xmlFormat","jsonFormat","noneFormat","worldInfoCharDefinition","existingFieldDefinitions","taskDescription","outputFormatInstructions","personaDescription"],Oo={stDescription:yo,charDefinitions:"## Selected Characters for Context\n{{#each characters}}\n### {{this.name}}\n{{#if this.description}}\n#### Description\n{{this.description}}\n{{/if}}\n{{#if this.personality}}\n#### Personality\n{{this.personality}}\n{{/if}}\n{{#if this.scenario}}\n#### Scenario\n{{this.scenario}}\n{{/if}}\n{{#if this.first_mes}}\n#### First Message\n{{this.first_mes}}\n{{/if}}\n{{#if this.mes_example}}\n#### Example Dialogue\n{{this.mes_example}}\n{{/if}}\n{{#if this.alternate_greetings}}\n#### Alternate Greetings\n{{#each this.alternate_greetings}}\n### {{add @index 1}}\n{{this}}\n{{/each}}\n{{/if}}\n\n{{/each}}",lorebookDefinitions:"## Selected Lorebooks for Context\n{{#each lorebooks}}\n### {{@key}}\n  {{#each this as |entry|}}\n#### {{#if entry.comment}}{{entry.comment}}{{else}}*No title*{{/if}}\nTriggers: {{#if entry.key}}{{join entry.key ', '}}{{else}}*No triggers*{{/if}}\nContent: {{#if entry.content}}{{entry.content}}{{else}}*No content*{{/if}}\n\n  {{/each}}\n\n\n{{/each}}",xmlFormat:"=== RESPONSE FORMAT INSTRUCTIONS ===\nYou MUST provide your response wrapped ONLY in a single <response> XML tag.\n\nWhen providing code in your response, wrap it in triple backticks:\n\nExample:\n```\n<response>Generated content for the field goes here.</response>\n```",jsonFormat:'=== RESPONSE FORMAT INSTRUCTIONS ===\nYou MUST provide your response as a JSON object with a single key "response" containing the generated content as a string.\n\nWhen providing code in your response, wrap it in triple backticks:\n\nExample:\n```\n{\n  "response": "Generated content for the field goes here."\n}\n```',noneFormat:"=== RESPONSE FORMAT INSTRUCTIONS ===\nYou MUST provide ONLY the raw text content for the field, without any formatting, XML tags, JSON structure, or explanatory text. Just the content itself.\n\nWhen providing code in your response, wrap it in triple backticks:\n\nExample:\n```\nGenerated content for the field goes here.\n```",worldInfoCharDefinition:"### {{character.name}}\n- **Description:** {{#if character.description}}{{character.description}}{{else}}*Not provided*{{/if}}\n- **Personality:** {{#if character.personality}}{{character.personality}}{{else}}*Not provided*{{/if}}\n- **Scenario:** {{#if character.scenario}}{{character.scenario}}{{else}}*Not provided*{{/if}}\n- **First Message:** {{#if character.first_mes}}{{character.first_mes}}{{else}}*Not provided*{{/if}}\n- **Example Dialogue:**\n  {{#if character.mes_example}}{{character.mes_example}}{{else}}*Not provided*{{/if}}\n- **Alternate Greetings:**\n  {{#if character.alternate_greetings}}\n  {{#each character.alternate_greetings}}\n  **{{add @index 1}}:** {{this}}\n  {{/each}}\n  {{else}}*Not provided*{{/if}}",existingFieldDefinitions:So,taskDescription:xo,outputFormatInstructions:bo,personaDescription:"## User's Persona Description\nname: {{user}}\n{{persona}}"},Fo={version:Ao,formatVersion:"F_1.7",profileId:"",maxContextType:"profile",maxContextValue:16384,maxResponseToken:1024,outputFormat:"xml",contextToSend:{stDescription:!0,messages:{type:"last",first:10,last:10,range:{start:0,end:10}},charCard:!0,existingFields:!0,worldInfo:!0,persona:!0,dontSendOtherGreetings:!1},prompts:{stDescription:{content:Oo.stDescription,isDefault:!0,label:"ST/Char Card Description"},charDefinitions:{content:Oo.charDefinitions,isDefault:!0,label:"Character Definition Template"},lorebookDefinitions:{content:Oo.lorebookDefinitions,isDefault:!0,label:"Lorebook Definition Template"},xmlFormat:{content:Oo.xmlFormat,isDefault:!0,label:"XML Format Description"},jsonFormat:{content:Oo.jsonFormat,isDefault:!0,label:"JSON Format Description"},noneFormat:{content:Oo.noneFormat,isDefault:!0,label:"Plain Text Format Description"},worldInfoCharDefinition:{content:Oo.worldInfoCharDefinition,isDefault:!0,label:"World Info Character Definition Template"},existingFieldDefinitions:{content:So,isDefault:!0,label:"Existing Fields Definition Template"},taskDescription:{content:xo,isDefault:!0,label:"Task Description Template"},outputFormatInstructions:{content:bo,isDefault:!0,label:"Output Format Instructions"},personaDescription:{content:Oo.personaDescription,isDefault:!0,label:"User Persona Description Template"}},promptPreset:"default",promptPresets:{default:{content:"Generate the field content based on the chat history and existing character details. Be creative but consistent."}},mainContextTemplatePreset:"default",mainContextTemplatePresets:{default:{prompts:[{enabled:!0,promptName:"chatHistory",role:"system"},{enabled:!0,promptName:"creatorChatHistory",role:"system"},{enabled:!0,promptName:"stDescription",role:"system"},{enabled:!0,promptName:"charDefinitions",role:"system"},{enabled:!0,promptName:"lorebookDefinitions",role:"system"},{enabled:!0,promptName:"existingFieldDefinitions",role:"system"},{enabled:!0,promptName:"personaDescription",role:"system"},{enabled:!0,promptName:"outputFormatInstructions",role:"system"},{enabled:!0,promptName:"taskDescription",role:"user"}]}},showSaveAsWorldInfoEntry:{show:!1}};function Lo(e){var t=e.replace(/[^\w\s]/g,"").split(/\s+/).filter(Boolean),n=!1;return t.map(function(e,t){var r=e.replace(/^\d+/,"");if(r){var o=n?"".concat(r[0].toUpperCase()).concat(r.slice(1).toLowerCase()):r.toLowerCase();return n||(n=!0),o}return""}).join("")}var Mo=new L("charCreatorChat",Fo);function Bo(){return(Bo=To(Co().m(function e(){return Co().w(function(e){for(;;)if(0===e.n)return e.a(2,new Promise(function(e,t){Mo.initializeSettings({strategy:[{from:"*",to:"F_1.4",action:function(e){var t,n,r,o,i,a,s,l,c;return{profileId:null!==(t=null==e?void 0:e.profileId)&&void 0!==t?t:"",maxContextType:null!==(n=null==e?void 0:e.maxContextType)&&void 0!==n?n:"profile",maxContextValue:null!==(r=null==e?void 0:e.maxContextValue)&&void 0!==r?r:16384,maxResponseToken:null!==(o=null==e?void 0:e.maxResponseToken)&&void 0!==o?o:1024,outputFormat:null!==(i=null==e?void 0:e.outputFormat)&&void 0!==i?i:"xml",contextToSend:ko(ko({},null==e?void 0:e.contextToSend),{},{persona:!0}),prompts:{stDescription:{content:Oo.stDescription,isDefault:!0,label:"ST/Char Card Description"},charDefinitions:{content:Oo.charDefinitions,isDefault:!0,label:"Character Definition Template"},lorebookDefinitions:{content:Oo.lorebookDefinitions,isDefault:!0,label:"Lorebook Definition Template"},xmlFormat:{content:Oo.xmlFormat,isDefault:!0,label:"XML Format Description"},jsonFormat:{content:Oo.jsonFormat,isDefault:!0,label:"JSON Format Description"},noneFormat:{content:Oo.noneFormat,isDefault:!0,label:"Plain Text Format Description"},worldInfoCharDefinition:{content:Oo.worldInfoCharDefinition,isDefault:!0,label:"World Info Character Definition Template"},existingFieldDefinitions:{content:So,isDefault:!0,label:"Existing Fields Definition Template"},taskDescription:{content:xo,isDefault:!0,label:"Task Description Template"},outputFormatInstructions:{content:bo,isDefault:!0,label:"Output Format Instructions"},personaDescription:{content:Oo.personaDescription,isDefault:!0,label:"User Persona Description Template"}},promptPreset:null!==(a=null==e?void 0:e.default)&&void 0!==a?a:"default",promptPresets:null!==(s=null==e?void 0:e.promptPresets)&&void 0!==s?s:{default:{content:"Generate the field content based on the chat history and existing character details. Be creative but consistent."}},mainContextTemplatePreset:"default",mainContextTemplatePresets:{default:{prompts:[{enabled:!0,promptName:"chatHistory",role:"system"},{enabled:!0,promptName:"creatorChatHistory",role:"system"},{enabled:!0,promptName:"stDescription",role:"system"},{enabled:!0,promptName:"charDefinitions",role:"system"},{enabled:!0,promptName:"lorebookDefinitions",role:"system"},{enabled:!0,promptName:"existingFieldDefinitions",role:"system"},{enabled:!0,promptName:"personaDescription",role:"system"},{enabled:!0,promptName:"outputFormatInstructions",role:"system"},{enabled:!0,promptName:"taskDescription",role:"user"}]}},showSaveAsWorldInfoEntry:null!==(l=null==e?void 0:e.showSaveAsWorldInfoEntry)&&void 0!==l?l:{show:null!==(c=null==e?void 0:e.showSaveAsWorldInfoEntry.show)&&void 0!==c&&c}}}},{from:"F_1.4",to:"F_1.5",action:function(e){return ko(ko({},e),{},{prompts:ko(ko({},null==e?void 0:e.prompts),{},{personaDescription:{content:Oo.personaDescription,isDefault:!0,label:"User Persona Description Template"}}),mainContextTemplatePresets:ko(ko({},null==e?void 0:e.mainContextTemplatePresets),{},{default:{prompts:[{enabled:!0,promptName:"chatHistory",role:"system"},{enabled:!0,promptName:"creatorChatHistory",role:"system"},{enabled:!0,promptName:"stDescription",role:"system"},{enabled:!0,promptName:"charDefinitions",role:"system"},{enabled:!0,promptName:"lorebookDefinitions",role:"system"},{enabled:!0,promptName:"existingFieldDefinitions",role:"system"},{enabled:!0,promptName:"personaDescription",role:"system"},{enabled:!0,promptName:"outputFormatInstructions",role:"system"},{enabled:!0,promptName:"taskDescription",role:"user"}]}})})}},{from:"F_1.5",to:"F_1.6",action:function(e){return To(Co().m(function t(){return Co().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,Te("info","[".concat(Io,"] Added Alternate Greetings."));case 1:return t.a(2,ko(ko({},e),{},{prompts:ko(ko({},null==e?void 0:e.prompts),{},{stDescription:{content:Oo.stDescription,isDefault:!0,label:"ST/Char Card Description"},charDefinitions:{content:Oo.charDefinitions,isDefault:!0,label:"Character Definition Template"},worldInfoCharDefinition:{content:Oo.worldInfoCharDefinition,isDefault:!0,label:"World Info Character Definition Template"},existingFieldDefinitions:{content:So,isDefault:!0,label:"Existing Fields Definition Template"}})}))}},t)}))()}},{from:"F_1.6",to:"F_1.7",action:function(e){return To(Co().m(function t(){var n;return Co().w(function(t){for(;;)if(0===t.n)return n=ko({},e),e.prompts.stDescription.isDefault&&(n.prompts.stDescription.content=yo),t.a(2,n)},t)}))()}}]}).then(function(t){e()}).catch(function(t){console.error("[".concat(Io,"] Error initializing settings:"),t),Te("error","[".concat(Io,"] Failed to initialize settings: ").concat(t.message)),Ko.Popup.show.confirm("[".concat(Io,"] Failed to load settings. This might be due to an update. Reset settings to default?"),"Extension Error").then(function(t){t&&(Mo.resetSettings(),Te("success","[".concat(Io,"] Settings reset. Reloading may be required.")),e())})})}))},e)}))).apply(this,arguments)}var jo=function e(t){var n=A[t];if(void 0!==n)return n.exports;var r=A[t]={exports:{}};return I[t](r,r.exports,e),r.exports}(639);function Ro(e){return Ro="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Ro(e)}function $o(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function i(n,r,o,i){var l=r&&r.prototype instanceof s?r:s,c=Object.create(l.prototype);return Ho(c,"_invoke",function(n,r,o){var i,s,l,c=0,u=o||[],p=!1,d={p:0,n:0,v:e,a:h,f:h.bind(e,4),d:function(t,n){return i=t,s=0,l=e,d.n=n,a}};function h(n,r){for(s=n,l=r,t=0;!p&&c&&!o&&t<u.length;t++){var o,i=u[t],h=d.p,f=i[2];n>3?(o=f===r)&&(l=i[(s=i[4])?5:(s=3,3)],i[4]=i[5]=e):i[0]<=h&&((o=n<2&&h<i[1])?(s=0,d.v=r,d.n=i[1]):h<f&&(o=n<3||i[0]>r||r>f)&&(i[4]=n,i[5]=r,d.n=f,s=0))}if(o||n>1)return a;throw p=!0,r}return function(o,u,f){if(c>1)throw TypeError("Generator is already running");for(p&&1===u&&h(u,f),s=u,l=f;(t=s<2?e:l)||!p;){i||(s?s<3?(s>1&&(d.n=-1),h(s,l)):d.n=l:d.v=l);try{if(c=2,i){if(s||(o="next"),t=i[o]){if(!(t=t.call(i,l)))throw TypeError("iterator result is not an object");if(!t.done)return t;l=t.value,s<2&&(s=0)}else 1===s&&(t=i.return)&&t.call(i),s<2&&(l=TypeError("The iterator does not provide a '"+o+"' method"),s=1);i=e}else if((t=(p=d.n<0)?l:n.call(r,d))!==a)break}catch(t){i=e,s=1,l=t}finally{c=1}}return{value:t,done:p}}}(n,o,i),!0),c}var a={};function s(){}function l(){}function c(){}t=Object.getPrototypeOf;var u=[][r]?t(t([][r]())):(Ho(t={},r,function(){return this}),t),p=c.prototype=s.prototype=Object.create(u);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,Ho(e,o,"GeneratorFunction")),e.prototype=Object.create(p),e}return l.prototype=c,Ho(p,"constructor",c),Ho(c,"constructor",l),l.displayName="GeneratorFunction",Ho(c,o,"GeneratorFunction"),Ho(p),Ho(p,o,"Generator"),Ho(p,r,function(){return this}),Ho(p,"toString",function(){return"[object Generator]"}),($o=function(){return{w:i,m:d}})()}function Ho(e,t,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}Ho=function(e,t,n,r){function i(t,n){Ho(e,t,function(e){return this._invoke(t,n,e)})}t?o?o(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(i("next",0),i("throw",1),i("return",2))},Ho(e,t,n,r)}function qo(e){return function(e){if(Array.isArray(e))return Go(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||Wo(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Vo(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=Wo(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){s=!0,i=e},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw i}}}}function Uo(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,i,a,s=[],l=!0,c=!1;try{if(i=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;l=!1}else for(;!(l=(r=i.call(n)).done)&&(s.push(r.value),s.length!==t);l=!0);}catch(e){c=!0,o=e}finally{try{if(!l&&null!=n.return&&(a=n.return(),Object(a)!==a))return}finally{if(c)throw o}}return s}}(e,t)||Wo(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Wo(e,t){if(e){if("string"==typeof e)return Go(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Go(e,t):void 0}}function Go(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function Yo(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function Xo(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Yo(Object(n),!0).forEach(function(t){zo(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Yo(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function zo(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=Ro(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=Ro(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==Ro(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Jo(e,t,n,r,o,i,a){try{var s=e[i](a),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}var Ko=SillyTavern.getContext(),Zo=["name","description","personality","scenario","first_mes","mes_example"],Qo={name:"Name",description:"Description",personality:"Personality",scenario:"Scenario",first_mes:"First Message",mes_example:"Example Dialogue"};new L("dumb",{}).getSettings();function ei(e){return ti.apply(this,arguments)}function ti(){var e;return e=$o().m(function e(t){var n,r,o,i,a,s,c,u,p,d,h,f,m,g,v,y,b,S,x,w,C,_,E,k,P,D,T,I,A,N,O,F,L,M,B,j,R,$,H,q,V,U,W,G,Y,X,z,J,K;return $o().w(function(e){for(;;)switch(e.p=e.n){case 0:if(c=t.profileId,u=t.userPrompt,p=t.buildPromptOptions,d=t.continueFrom,h=t.session,f=t.allCharacters,m=t.entriesGroupByWorldName,g=t.promptSettings,v=t.formatDescription,y=t.mainContextList,b=t.includeUserMacro,S=t.maxResponseToken,x=t.targetField,w=t.outputFormat,C=t.additionalContentPartsForCurrentUserMessage,c){e.n=1;break}throw new Error("No connection profile selected.");case 1:if(_=null===(n=Ko.extensionSettings.connectionManager)||void 0===n||null===(n=n.profiles)||void 0===n?void 0:n.find(function(e){return e.id===c})){e.n=2;break}throw new Error('Connection profile with ID "'.concat(c,'" not found.'));case 2:if(E=_.api?Ko.CONNECT_API_MAP[_.api].selected:void 0){e.n=3;break}throw new Error('Could not determine API for profile "'.concat(_.name,'".'));case 3:(k={}).char=null!==(r=h.fields.name.value)&&void 0!==r?r:"{{char}}",k.user=b&&l?l:"{{user}}",k.persona="{{persona}}",k.targetField=x,k.userInstructions=jo.compile(u.trim(),{noEscape:!0})(k),P=null!==(o=null!==(i=null===(a=h.draftFields[x])||void 0===a?void 0:a.prompt)&&void 0!==i?i:null===(s=h.fields[x])||void 0===s?void 0:s.prompt)&&void 0!==o?o:"",k.fieldSpecificInstructions=jo.compile(P,{noEscape:!0})(Xo(Xo({},k),{},{char:"mes_example"===x?"{{char}}":k.char,user:"mes_example"===x?"{{user}}":k.user})),k.activeFormatInstructions=jo.compile(v.content||"",{noEscape:!0})(k),D=[],h.selectedCharacterIndexes.forEach(function(e){var t=parseInt(e),n=f[t];n&&D.push(n)}),k.characters=D,h.creatorChatHistory||(h.creatorChatHistory={messages:[]}),Array.isArray(h.creatorChatHistory.messages)||(h.creatorChatHistory.messages=[]),k.creatorChatHistory=h.creatorChatHistory.messages,T={},Object.entries(m).filter(function(e){var t=Uo(e,2),n=t[0],r=t[1];return r.length>0&&h.selectedWorldNames.includes(n)&&r.some(function(e){return!e.disable})}).forEach(function(e){var t=Uo(e,2),n=t[0],r=t[1];T[n]=r.filter(function(e){return!e.disable})}),k.lorebooks=T,I={},A={},N={},O=x.startsWith("alternate_greetings_"),F=Mo.getSettings().contextToSend.dontSendOtherGreetings,Object.entries(h.fields).forEach(function(e){var t=Uo(e,2),n=t[0],r=t[1],o=!1;if(F){var i=n.startsWith("alternate_greetings_");o=O?i&&n!==x||"first_mes"===n:i}if(!o){var a=jo.compile(r.value||"",{noEscape:!0})(Xo(Xo({},k),{},{char:"mes_example"===n?"{{char}}":k.char,user:"mes_example"===n?"{{user}}":k.user}));if(Zo.includes(n)){var s=r.label||Qo[n]||n;I[s]=a}else n.startsWith("alternate_greetings_")&&(parseInt(n.split("_")[2]),A[n]=a)}}),Object.entries(h.draftFields||{}).forEach(function(e){var t=Uo(e,2),n=(t[0],t[1]);N[n.label]=jo.compile(n.value||"",{noEscape:!0})(k)}),L={core:I,alternate_greetings:A,draft:N},k.fields=L,M=[],B=Vo(y),e.p=4,B.s();case 5:if((j=B.n()).done){e.n=11;break}if("chatHistory"!==(R=j.value).promptName){e.n=7;break}return e.n=6,Re(E,p);case 6:if(($=e.v).warnings&&$.warnings.length>0){H=Vo($.warnings);try{for(H.s();!(q=H.n()).done;)Te("warning",q.value)}catch(e){H.e(e)}finally{H.f()}}return M.push.apply(M,qo($.result)),e.a(3,10);case 7:if("creatorChatHistory"!==R.promptName){e.n=8;break}return W=null!==(V=null===(U=h.creatorChatHistory)||void 0===U?void 0:U.messages)&&void 0!==V?V:[],M.push.apply(M,qo(W)),e.a(3,10);case 8:if(G=structuredClone(k),"stDescription"===R.promptName&&(G.char="{{char}}",G.user="{{user}}"),Y=g[R.promptName]){e.n=9;break}return e.a(3,10);case 9:(X={role:R.role,content:jo.compile(Y.content||"",{noEscape:!0})(G)}).content=X.content.replaceAll("{{user}}","[[[crec_veryUniqueUserPlaceHolder]]]"),X.content=X.content.replaceAll("{{char}}","[[[crec_veryUniqueCharPlaceHolder]]]"),X.content=Ko.substituteParams(X.content),X.content=X.content.replaceAll("[[[crec_veryUniqueUserPlaceHolder]]]","{{user}}"),X.content=X.content.replaceAll("[[[crec_veryUniqueCharPlaceHolder]]]","{{char}}"),X.content&&M.push(X);case 10:e.n=5;break;case 11:e.n=13;break;case 12:e.p=12,K=e.v,B.e(K);case 13:return e.p=13,B.f(),e.f(13);case 14:return C&&C.length>0&&M.push({role:"user",content:C}),d&&M.push({role:"assistant",content:vo(d,w)}),e.n=15,Ko.ConnectionManagerRequestService.sendRequest(c,M,S);case 15:return z=e.v,J=go(z.content,w,{previousContent:d}),e.a(2,J)}},e,null,[[4,12,13,14]])}),ti=function(){var t=this,n=arguments;return new Promise(function(r,o){var i=e.apply(t,n);function a(e){Jo(i,r,o,a,s,"next",e)}function s(e){Jo(i,r,o,a,s,"throw",e)}a(void 0)})},ti.apply(this,arguments)}function ni(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function i(n,r,o,i){var l=r&&r.prototype instanceof s?r:s,c=Object.create(l.prototype);return ri(c,"_invoke",function(n,r,o){var i,s,l,c=0,u=o||[],p=!1,d={p:0,n:0,v:e,a:h,f:h.bind(e,4),d:function(t,n){return i=t,s=0,l=e,d.n=n,a}};function h(n,r){for(s=n,l=r,t=0;!p&&c&&!o&&t<u.length;t++){var o,i=u[t],h=d.p,f=i[2];n>3?(o=f===r)&&(l=i[(s=i[4])?5:(s=3,3)],i[4]=i[5]=e):i[0]<=h&&((o=n<2&&h<i[1])?(s=0,d.v=r,d.n=i[1]):h<f&&(o=n<3||i[0]>r||r>f)&&(i[4]=n,i[5]=r,d.n=f,s=0))}if(o||n>1)return a;throw p=!0,r}return function(o,u,f){if(c>1)throw TypeError("Generator is already running");for(p&&1===u&&h(u,f),s=u,l=f;(t=s<2?e:l)||!p;){i||(s?s<3?(s>1&&(d.n=-1),h(s,l)):d.n=l:d.v=l);try{if(c=2,i){if(s||(o="next"),t=i[o]){if(!(t=t.call(i,l)))throw TypeError("iterator result is not an object");if(!t.done)return t;l=t.value,s<2&&(s=0)}else 1===s&&(t=i.return)&&t.call(i),s<2&&(l=TypeError("The iterator does not provide a '"+o+"' method"),s=1);i=e}else if((t=(p=d.n<0)?l:n.call(r,d))!==a)break}catch(t){i=e,s=1,l=t}finally{c=1}}return{value:t,done:p}}}(n,o,i),!0),c}var a={};function s(){}function l(){}function c(){}t=Object.getPrototypeOf;var u=[][r]?t(t([][r]())):(ri(t={},r,function(){return this}),t),p=c.prototype=s.prototype=Object.create(u);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,ri(e,o,"GeneratorFunction")),e.prototype=Object.create(p),e}return l.prototype=c,ri(p,"constructor",c),ri(c,"constructor",l),l.displayName="GeneratorFunction",ri(c,o,"GeneratorFunction"),ri(p),ri(p,o,"Generator"),ri(p,r,function(){return this}),ri(p,"toString",function(){return"[object Generator]"}),(ni=function(){return{w:i,m:d}})()}function ri(e,t,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}ri=function(e,t,n,r){function i(t,n){ri(e,t,function(e){return this._invoke(t,n,e)})}t?o?o(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(i("next",0),i("throw",1),i("return",2))},ri(e,t,n,r)}function oi(e,t,n,r,o,i,a){try{var s=e[i](a),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function ii(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var i=e.apply(t,n);function a(e){oi(i,r,o,a,s,"next",e)}function s(e){oi(i,r,o,a,s,"throw",e)}a(void 0)})}}var ai="character_creator_chat_session",si=null,li=null,ci=null;function ui(){!function(){var e=localStorage.getItem(ai);if(e)try{si=JSON.parse(e)}catch(e){console.error("Failed to parse chat session:",e),hi()}else hi()}(),$(document).on("click",'.tab-button[data-tab="charCreator_chatContainer"]',function(){li||pi()})}function pi(){return di.apply(this,arguments)}function di(){return(di=ii(ni().m(function e(){var t,n,r;return ni().w(function(e){for(;;)switch(e.p=e.n){case 0:return t=$("#charCreator_chatContainer"),e.p=1,e.n=2,Ko.renderExtensionTemplateAsync("third-party/SillyTavern-Character-Creator-Chat","templates/chat");case 2:n=e.v,t.html(n),(li=$("#chat_container")).show(),mi(),wi(),e.n=4;break;case 3:e.p=3,r=e.v,console.error("Failed to load chat template:",r),t.html('<div class="error">Failed to load chat interface</div>');case 4:return e.a(2)}},e,null,[[1,3]])}))).apply(this,arguments)}function hi(){si={id:ki(),messages:[],createdAt:Date.now(),lastModified:Date.now()},fi()}function fi(){si&&(si.lastModified=Date.now(),localStorage.setItem(ai,JSON.stringify(si)))}function mi(){$("#send_message").on("click",gi),$("#chat_input").on("keydown",function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),gi())}),$("#clear_chat").on("click",_i),$("#export_chat").on("click",Ei),$("#chat_messages").on("click",".edit-message-btn",function(){var e=$(this).closest(".chat-message").attr("data-message-id");e&&function(e){if(!si)return;var t=si.messages.find(function(t){return t.id===e});if(!t)return;var n=$('.chat-message[data-message-id="'.concat(e,'"]')),r=n.find(".message-content"),o=n.find(".message-edit-container"),i=o.find(".message-edit-textarea");r.hide(),o.show(),i.val(t.content).focus(),i.css("height","auto"),i.css("height",i[0].scrollHeight+"px")}(e)}),$("#chat_messages").on("click",".delete-message-btn",function(){var e=$(this).closest(".chat-message").attr("data-message-id");e&&function(e){if(!si)return;if(!confirm("Are you sure you want to delete this message?"))return;var t=si.messages.findIndex(function(t){return t.id===e});if(-1!==t){si.messages.splice(t,1),fi(),$('.chat-message[data-message-id="'.concat(e,'"]')).fadeOut(200,function(){$(this).remove()}),Di()}}(e)}),$("#chat_messages").on("click",".save-edit-btn",function(){var e=$(this).closest(".chat-message").attr("data-message-id");e&&function(e){var t;if(!si)return;var n=$('.chat-message[data-message-id="'.concat(e,'"]')),r=n.find(".message-edit-container"),o=r.find(".message-edit-textarea"),i=null===(t=o.val())||void 0===t?void 0:t.toString().trim();if(!i)return void alert("Message cannot be empty");var a=si.messages.findIndex(function(t){return t.id===e});if(-1!==a){si.messages[a].content=i,fi();var s=n.find(".message-content");s.html(Pi(i)),s.show(),r.hide(),Di()}}(e)}),$("#chat_messages").on("click",".cancel-edit-btn",function(){var e=$(this).closest(".chat-message").attr("data-message-id");e&&function(e){var t=$('.chat-message[data-message-id="'.concat(e,'"]')),n=t.find(".message-content"),r=t.find(".message-edit-container");n.show(),r.hide()}(e)}),$("#attach_image").on("click",function(){var e=document.getElementById("chat_image_input");null==e||e.click()}),$("#chat_image_input").on("change",function(e){var t,n=e.target,r=null===(t=n.files)||void 0===t?void 0:t[0];if(r){if(!r.type.startsWith("image/"))return alert("Please select an image file."),void(n.value="");var o=new FileReader;o.onload=function(){ci=o.result;var e=$("#chat_image_preview");e.attr("src",ci||""),e.closest(".chat-image-preview-container").show()},o.readAsDataURL(r)}}),$("#clear_image").on("click",function(){ci=null;var e=document.getElementById("chat_image_input");e&&(e.value="");var t=$("#chat_image_preview");t.attr("src",""),t.closest(".chat-image-preview-container").hide()})}function gi(){return vi.apply(this,arguments)}function vi(){return(vi=ii(ni().m(function e(){var t,n,r,o,i,a,s,l;return ni().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=$("#chat_input"),r=null===(t=n.val())||void 0===t?void 0:t.toString().trim()){e.n=1;break}return e.a(2);case 1:return(o=$("#send_message")).prop("disabled",!0),n.prop("disabled",!0),Si({id:ki(),role:"user",content:r,inlineImageUrl:null!=ci?ci:void 0,timestamp:Date.now()}),n.val(""),e.p=2,e.n=3,yi(r,null!=ci?ci:void 0);case 3:i=e.v,Si({id:ki(),role:"assistant",content:i,timestamp:Date.now()}),e.n=5;break;case 4:e.p=4,l=e.v,console.error("Failed to generate response:",l),alert("Failed to generate response. Please check your connection settings.");case 5:return e.p=5,o.prop("disabled",!1),n.prop("disabled",!1),n.focus(),ci=null,(a=document.getElementById("chat_image_input"))&&(a.value=""),(s=$("#chat_image_preview")).attr("src",""),s.closest(".chat-image-preview-container").hide(),e.f(5);case 6:return e.a(2)}},e,null,[[2,4,5,6]])}))).apply(this,arguments)}function yi(e,t){return bi.apply(this,arguments)}function bi(){return bi=ii(ni().m(function e(t,n){var r,o,i,a,s,l,c,u,d,h,f,g,v,y,b,S;return ni().w(function(e){for(;;)switch(e.p=e.n){case 0:if((r=Mo.getSettings()).profileId){e.n=1;break}throw new Error("No connection profile selected");case 1:return e.p=1,a="charCreator",(s=JSON.parse(null!==(o=localStorage.getItem(a))&&void 0!==o?o:"{}")).selectedCharacterIndexes||(s.selectedCharacterIndexes=p?[p]:[]),s.selectedWorldNames||(s.selectedWorldNames=[]),s.fields||(s.fields={}),s.draftFields||(s.draftFields={}),s.lastLoadedCharacterId||(s.lastLoadedCharacterId=""),Zo.forEach(function(e){s.fields[e]||(s.fields[e]={value:"",prompt:"",label:Qo[e]})}),s.creatorChatHistory||(s.creatorChatHistory={messages:[]}),Array.isArray(s.creatorChatHistory.messages)||(s.creatorChatHistory.messages=[]),l=SillyTavern.getContext(),c={},e.n=2,Promise.all(m.filter(function(e){return s.selectedWorldNames.includes(e)}).map(function(){var e=ii(ni().m(function e(t){var n;return ni().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,Ko.loadWorldInfo(t);case 1:(n=e.v)&&(c[t]=Object.values(n.entries));case 2:return e.a(2)}},e)}));return function(t){return e.apply(this,arguments)}}()));case 2:u=null===(i=l.extensionSettings.connectionManager)||void 0===i||null===(i=i.profiles)||void 0===i?void 0:i.find(function(e){return e.id===r.profileId}),d={presetName:null==u?void 0:u.preset,contextName:null==u?void 0:u.context,instructName:null==u?void 0:u.instruct,targetCharacterId:p,ignoreCharacterFields:!0,ignoreWorldInfo:!0,ignoreAuthorNote:!0,maxContext:"custom"===r.maxContextType?r.maxContextValue:"profile"===r.maxContextType?"preset":"active",includeNames:!!P,messageIndexesBetween:{start:-1,end:-1}},h="",b=r.outputFormat,e.n="xml"===b?3:"json"===b?4:"none"===b?5:6;break;case 3:return h=r.prompts.xmlFormat.content,e.a(3,6);case 4:return h=r.prompts.jsonFormat.content,e.a(3,6);case 5:return h=r.prompts.noneFormat.content,e.a(3,6);case 6:return f=structuredClone(r.prompts),r.contextToSend.stDescription||delete f.stDescription,r.contextToSend.charCard&&0!==s.selectedCharacterIndexes.length||delete f.charDefinitions,r.contextToSend.worldInfo&&0!==s.selectedWorldNames.length||delete f.lorebookDefinitions,r.contextToSend.existingFields||delete f.existingFieldDefinitions,r.contextToSend.persona||delete f.personaDescription,delete f.worldInfoCharDefinition,g='This is a chat request. The user just said: "'.concat(t,'". Please respond naturally as an AI assistant helping with character creation to continue the conversation.'),e.n=7,ei({profileId:r.profileId,userPrompt:g,buildPromptOptions:d,session:s,allCharacters:l.characters,entriesGroupByWorldName:c,promptSettings:f,formatDescription:{content:h},mainContextList:r.mainContextTemplatePresets[r.mainContextTemplatePreset].prompts.filter(function(e){return e.enabled}).map(function(e){return{promptName:e.promptName,role:e.role}}),includeUserMacro:r.contextToSend.persona,maxResponseToken:r.maxResponseToken,targetField:"chat_response",outputFormat:r.outputFormat,additionalContentPartsForCurrentUserMessage:n?[{type:"image_url",image_url:{url:n,detail:"auto"}}]:void 0});case 7:return v=e.v,n?(y=[],t&&t.length>0&&y.push({type:"text",text:t}),y.push({type:"image_url",image_url:{url:n,detail:"auto"}}),s.creatorChatHistory.messages.push({role:"user",content:y})):s.creatorChatHistory.messages.push({role:"user",content:t}),s.creatorChatHistory.messages.push({role:"assistant",content:v}),localStorage.setItem(a,JSON.stringify(s)),e.a(2,v||"");case 8:throw e.p=8,S=e.v,console.error("Chat API error:",S),S;case 9:return e.a(2)}},e,null,[[1,8]])})),bi.apply(this,arguments)}function Si(e){si&&(si.messages.push(e),fi(),xi(e),Ci())}function xi(e){var t,n=$("#chat_message_template")[0].content.cloneNode(!0),r=$(n.querySelector(".chat-message"));r.attr("data-message-id",e.id),r.addClass("message-".concat(e.role)),r.find(".message-role").text("user"===e.role?"You":"AI"),r.find(".message-timestamp").text((t=e.timestamp,new Date(t).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})));var o=r.find(".message-content");if(o.html(Pi(e.content)),e.inlineImageUrl){var i=$('<div class="inline-image" style="margin-top:6px;"><img src="'.concat(e.inlineImageUrl,'" alt="inline image" style="max-width: 200px; max-height: 200px; border:1px solid var(--SmartThemeBorderColor); border-radius:4px;"/></div>'));o.append(i)}$("#chat_messages").append(r)}function wi(){si&&($("#chat_messages").empty(),si.messages.forEach(function(e){return xi(e)}),Ci())}function Ci(){var e=$("#chat_messages")[0];e&&(e.scrollTop=e.scrollHeight)}function _i(){confirm("Are you sure you want to clear the chat history?")&&(hi(),$("#chat_messages").empty(),Di())}function Ei(){if(si&&0!==si.messages.length){var e={session:si,exportedAt:(new Date).toISOString()},t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),n=URL.createObjectURL(t),r=document.createElement("a");r.href=n,r.download="character-chat-".concat((new Date).toISOString().split("T")[0],".json"),document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(n)}else alert("No chat history to export")}function ki(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}function Pi(e){var t=e;return t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=$("<div>").text(t).html()).replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>")).replace(/__(.+?)__/g,"<strong>$1</strong>")).replace(/\*(.+?)\*/g,"<em>$1</em>")).replace(/_(.+?)_/g,"<em>$1</em>")).replace(/```([^]+?)```/g,"<pre><code>$1</code></pre>")).replace(/`(.+?)`/g,"<code>$1</code>")).replace(/\n/g,"<br>")).replace(/^- (.+)$/gm,"• $1")).replace(/^\* (.+)$/gm,"• $1")).replace(/^\d+\. (.+)$/gm,"$&")}function Di(){var e;if(si){var t="charCreator",n=JSON.parse(null!==(e=localStorage.getItem(t))&&void 0!==e?e:"{}");n.creatorChatHistory&&(n.creatorChatHistory.messages=si.messages.map(function(e){if(e.inlineImageUrl){var t=[];return e.content&&e.content.length>0&&t.push({type:"text",text:e.content}),t.push({type:"image_url",image_url:{url:e.inlineImageUrl,detail:"auto"}}),{role:e.role,content:t}}return{role:e.role,content:e.content}}),localStorage.setItem(t,JSON.stringify(n)))}}function Ti(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=Mi(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){s=!0,i=e},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw i}}}}function Ii(e){return Ii="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Ii(e)}function Ai(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function Ni(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ai(Object(n),!0).forEach(function(t){Oi(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ai(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function Oi(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=Ii(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=Ii(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==Ii(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Fi(e){return function(e){if(Array.isArray(e))return Bi(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||Mi(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Li(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,i,a,s=[],l=!0,c=!1;try{if(i=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;l=!1}else for(;!(l=(r=i.call(n)).done)&&(s.push(r.value),s.length!==t);l=!0);}catch(e){c=!0,o=e}finally{try{if(!l&&null!=n.return&&(a=n.return(),Object(a)!==a))return}finally{if(c)throw o}}return s}}(e,t)||Mi(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Mi(e,t){if(e){if("string"==typeof e)return Bi(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Bi(e,t):void 0}}function Bi(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function ji(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function i(n,r,o,i){var l=r&&r.prototype instanceof s?r:s,c=Object.create(l.prototype);return Ri(c,"_invoke",function(n,r,o){var i,s,l,c=0,u=o||[],p=!1,d={p:0,n:0,v:e,a:h,f:h.bind(e,4),d:function(t,n){return i=t,s=0,l=e,d.n=n,a}};function h(n,r){for(s=n,l=r,t=0;!p&&c&&!o&&t<u.length;t++){var o,i=u[t],h=d.p,f=i[2];n>3?(o=f===r)&&(l=i[(s=i[4])?5:(s=3,3)],i[4]=i[5]=e):i[0]<=h&&((o=n<2&&h<i[1])?(s=0,d.v=r,d.n=i[1]):h<f&&(o=n<3||i[0]>r||r>f)&&(i[4]=n,i[5]=r,d.n=f,s=0))}if(o||n>1)return a;throw p=!0,r}return function(o,u,f){if(c>1)throw TypeError("Generator is already running");for(p&&1===u&&h(u,f),s=u,l=f;(t=s<2?e:l)||!p;){i||(s?s<3?(s>1&&(d.n=-1),h(s,l)):d.n=l:d.v=l);try{if(c=2,i){if(s||(o="next"),t=i[o]){if(!(t=t.call(i,l)))throw TypeError("iterator result is not an object");if(!t.done)return t;l=t.value,s<2&&(s=0)}else 1===s&&(t=i.return)&&t.call(i),s<2&&(l=TypeError("The iterator does not provide a '"+o+"' method"),s=1);i=e}else if((t=(p=d.n<0)?l:n.call(r,d))!==a)break}catch(t){i=e,s=1,l=t}finally{c=1}}return{value:t,done:p}}}(n,o,i),!0),c}var a={};function s(){}function l(){}function c(){}t=Object.getPrototypeOf;var u=[][r]?t(t([][r]())):(Ri(t={},r,function(){return this}),t),p=c.prototype=s.prototype=Object.create(u);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,Ri(e,o,"GeneratorFunction")),e.prototype=Object.create(p),e}return l.prototype=c,Ri(p,"constructor",c),Ri(c,"constructor",l),l.displayName="GeneratorFunction",Ri(c,o,"GeneratorFunction"),Ri(p),Ri(p,o,"Generator"),Ri(p,r,function(){return this}),Ri(p,"toString",function(){return"[object Generator]"}),(ji=function(){return{w:i,m:d}})()}function Ri(e,t,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}Ri=function(e,t,n,r){function i(t,n){Ri(e,t,function(e){return this._invoke(t,n,e)})}t?o?o(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(i("next",0),i("throw",1),i("return",2))},Ri(e,t,n,r)}function $i(e,t,n,r,o,i,a){try{var s=e[i](a),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function Hi(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var i=e.apply(t,n);function a(e){$i(i,r,o,a,s,"next",e)}function s(e){$i(i,r,o,a,s,"throw",e)}a(void 0)})}}function qi(){return(qi=Hi(ji().m(function e(){var t,n,r,o,i,a,s,l,c,u,p,d,h,f,m,g,v,y,b;return ji().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,Ko.renderExtensionTemplateAsync("third-party/".concat(Io),"templates/settings");case 1:if(t=e.v,$("#extensions_settings").append(t),n=document.querySelector(".charCreator_settings")){e.n=2;break}return e.a(2);case 2:r=Mo.getSettings(),a=n.querySelector("#charCreator_mainContextTemplatePreset"),s=n.querySelector("#charCreator_mainContextList"),l=n.querySelector("#charCreator_restoreMainContextTemplateDefault"),Me("#charCreator_mainContextTemplatePreset",{initialList:Object.keys(r.mainContextTemplatePresets),initialValue:r.mainContextTemplatePreset,readOnlyValues:["default"],onSelectChange:function(e,t){var n=null!=t?t:"default";p(r.mainContextTemplatePresets[n].prompts.map(function(e){var t=e.promptName;return r.prompts[e.promptName]&&(t="".concat(r.prompts[e.promptName].label," (").concat(e.promptName,")")),{enabled:e.enabled,id:e.promptName,label:t,selectOptions:[{value:"user",label:"User"},{value:"assistant",label:"Assistant"},{value:"system",label:"System"}],selectValue:e.role}})),r.mainContextTemplatePreset=n,Mo.saveSettings()},create:{onAfterCreate:function(e){var t=r.mainContextTemplatePresets[r.mainContextTemplatePreset];t||(t=r.mainContextTemplatePresets.default),r.mainContextTemplatePresets[e]=structuredClone(t)}},rename:{onAfterRename:function(e,t){r.mainContextTemplatePresets[t]=r.mainContextTemplatePresets[e],delete r.mainContextTemplatePresets[e]}},delete:{onAfterDelete:function(e){delete r.mainContextTemplatePresets[e]}}}),c=r.mainContextTemplatePresets[r.mainContextTemplatePreset].prompts.map(function(e){var t=e.promptName;return r.prompts[e.promptName]&&(t="".concat(r.prompts[e.promptName].label," (").concat(e.promptName,")")),{enabled:e.enabled,id:e.promptName,label:t,selectOptions:[{value:"user",label:"User"},{value:"assistant",label:"Assistant"},{value:"system",label:"System"}],selectValue:e.role}}),u=Gn(s,{initialList:c,showSelectInput:!0,showToggleButton:!0,onSelectChange:function(e,t){var n=r.mainContextTemplatePresets[r.mainContextTemplatePreset].prompts.find(function(t){return t.promptName===e});n&&(n.role=t,Mo.saveSettings())},onToggle:function(e,t){var n=r.mainContextTemplatePresets[r.mainContextTemplatePreset].prompts.find(function(t){return t.promptName===e});n&&(n.enabled=t,Mo.saveSettings())},onOrderChange:function(e){var t=e.map(function(e){return r.mainContextTemplatePresets[r.mainContextTemplatePreset].prompts.find(function(t){return t.promptName===e})}).filter(function(e){return void 0!==e});r.mainContextTemplatePresets[r.mainContextTemplatePreset].prompts=t,Mo.saveSettings()}}),p=u.setList,d=u.getList,o=p,i=d,l.addEventListener("click",Hi(ji().m(function e(){return ji().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,Ko.Popup.show.confirm("Restore default","Are you sure you want to restore the default prompt?");case 1:if(e.v){e.n=2;break}return e.a(2);case 2:r.mainContextTemplatePresets.default={prompts:Fo.mainContextTemplatePresets.default.prompts},"default"!==a.value?(a.value="default",a.dispatchEvent(new Event("change"))):(p(r.mainContextTemplatePresets.default.prompts.map(function(e){var t=e.promptName;return r.prompts[e.promptName]&&(t="".concat(r.prompts[e.promptName].label," (").concat(e.promptName,")")),{enabled:e.enabled,id:e.promptName,label:t,selectOptions:[{value:"user",label:"User"},{value:"assistant",label:"Assistant"},{value:"system",label:"System"}],selectValue:e.role}})),Mo.saveSettings());case 3:return e.a(2)}},e)}))),h=n.querySelector("#charCreator_systemPromptPreset"),f=n.querySelector("#charCreator_systemPromptContent"),m=n.querySelector("#charCreator_restoreSystemPromptDefault"),Me("#charCreator_systemPromptPreset",{initialList:Object.keys(r.prompts),readOnlyValues:No,initialValue:No[0],label:function(e){if(""===e)return"prompt";var t=r.prompts[e];return t?"".concat(t.label," (").concat(e,")"):e},create:{onBeforeCreate:function(e){var t=Lo(e);return t?!r.prompts[t]||(Te("error","Prompt name already exists: ".concat(t)),!1):(Te("error","Invalid prompt name: ".concat(e)),!1)},onAfterCreate:function(e){var t=Lo(e);return r.prompts[t]={content:f.value,isDefault:!1,label:e},Object.entries(r.mainContextTemplatePresets).forEach(function(e){var n=Li(e,2);n[0];n[1].prompts.push({enabled:!0,promptName:t,role:"user"})}),o([].concat(Fi(i()),[{enabled:!0,id:t,label:"".concat(e," (").concat(t,")"),selectOptions:[{value:"user",label:"User"},{value:"assistant",label:"Assistant"},{value:"system",label:"System"}],selectValue:"user"}])),t}},rename:{onBeforeRename:function(e,t){var n=Lo(t);return n?!r.prompts[n]||(Te("error","Prompt name already exists: ".concat(n)),!1):(Te("error","Invalid prompt name: ".concat(t)),!1)},onAfterRename:function(e,t){var n=Lo(t);return r.prompts[n]=Ni(Ni({},r.prompts[e]),{},{label:t}),delete r.prompts[e],Object.entries(r.mainContextTemplatePresets).forEach(function(t){var r=Li(t,2);r[0];r[1].prompts.forEach(function(t){t.promptName===e&&(t.promptName=n)})}),o(i().map(function(r){return r.id===e?Ni(Ni({},r),{},{id:n,label:"".concat(t," (").concat(n,")")}):r})),n}},delete:{onAfterDelete:function(e){delete r.prompts[e],Object.entries(r.mainContextTemplatePresets).forEach(function(t){var n=Li(t,2),r=(n[0],n[1]);r.prompts=r.prompts.filter(function(t){return t.promptName!==e})}),o(i().filter(function(t){return t.id!==e}))}},onSelectChange:function(e,t){var n,o=null!=t?t:"",i=r.prompts[o];i&&(f.value=null!==(n=i.content)&&void 0!==n?n:"",m.style.display=No.includes(o)?"block":"none",Mo.saveSettings())}}),g=h.value,(v=r.prompts[g])&&(f.value=null!==(y=v.content)&&void 0!==y?y:"",m.style.display=No.includes(g)?"block":"none"),f.addEventListener("change",function(){var e=h.value,t=f.value,n=r.prompts[e];n&&(n.content=t,n.isDefault=!!No.includes(e)&&Oo[e]===t,m.style.display=No.includes(e)?"block":"none",Mo.saveSettings())}),m.addEventListener("click",Hi(ji().m(function e(){var t,n,o;return ji().w(function(e){for(;;)switch(e.n){case 0:if(t=h.value,n=Oo[t],!(o=r.prompts[t])){e.n=2;break}return e.n=1,Ko.Popup.show.confirm("Restore Default",'Are you sure you want to restore the default for "'.concat(o.label,'"?'));case 1:e.v&&(f.value=n,f.dispatchEvent(new Event("change"))),e.n=3;break;case 2:Te("warning","No prompt selected.");case 3:return e.a(2)}},e)}))),(b=n.querySelector("#charCreator_showSaveAsWorldInfo"))&&(b.checked=r.showSaveAsWorldInfoEntry.show,b.addEventListener("change",function(){r.showSaveAsWorldInfoEntry.show=b.checked,Mo.saveSettings()})),n.querySelector("#charCreator_resetEverything").addEventListener("click",Hi(ji().m(function e(){return ji().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,Ko.Popup.show.confirm("Reset Everything","Are you sure? This will reset all settings to default and clear your data in popup. This cannot be undone. This is a destructive action.");case 1:e.v&&(localStorage.removeItem("charCreator"),Mo.resetSettings(),setTimeout(function(){Te("success","Everything has been reset to default. Please reload the page.")},1500));case 2:return e.a(2)}},e)})));case 3:return e.a(2)}},e)}))).apply(this,arguments)}function Vi(){return Vi=Hi(ji().m(function e(){var t,n,r;return ji().w(function(e){for(;;)switch(e.n){case 0:n='<div class="menu_button fa-solid fa-user-astronaut interactable charCreator-icon" title="Character Creator"></div>',(r=null!==(t=document.getElementById("rm_buttons_container"))&&void 0!==t?t:document.getElementById("form_character_search_form"))&&$(r).prepend(n),$(".form_create_bottom_buttons_block").prepend(n),$("#GroupFavDelOkBack").prepend(n),document.querySelectorAll(".charCreator-icon").forEach(function(e){e.addEventListener("click",Hi(ji().m(function e(){var t,n,r,o,i,a,s,l,c,u,d,h,f,g,v,y,b,S,x,w,C,_,E,k,D,T,I,A,N,L,M,B,j,R,$,H,q,V,U,W,G,Y,X,z,J,K,Z,Q,ee,te,ne,re,oe,ie,ae,se,le,ce,ue,pe,de,he,fe,me,ge,ve,ye,be,Se,xe,we,Ce,_e,Ee;return ji().w(function(e){for(;;)switch(e.n){case 0:return _e=function(){return _e=Hi(ji().m(function e(t){var n,r,o,i,a,s,l,c,u,f,g,v,y,b,S,x,w,C,_,E,k,D,T,I,A,N,O,F,L,M,B,j,R;return ji().w(function(e){for(;;)switch(e.p=e.n){case 0:if(u=t.targetField,f=t.button,g=t.textarea,v=t.isDraft,y=t.continueFrom,f.disabled=!0,b=f.innerHTML,f.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i>',e.p=1,x=d.querySelector("#charCreator_prompt").value,h.profileId){e.n=2;break}return Te("warning","Please select a connection profile."),e.a(2);case 2:if(w=null===(S=U.extensionSettings.connectionManager)||void 0===S||null===(S=S.profiles)||void 0===S?void 0:S.find(function(e){return e.id===h.profileId})){e.n=3;break}return Te("warning","Connection profile not found."),e.a(2);case 3:C={presetName:null==w?void 0:w.preset,contextName:null==w?void 0:w.context,instructName:null==w?void 0:w.instruct,targetCharacterId:p,ignoreCharacterFields:!0,ignoreWorldInfo:!0,ignoreAuthorNote:!0,maxContext:"custom"===h.maxContextType?h.maxContextValue:"profile"===h.maxContextType?"preset":"active",includeNames:!!P},_=h.contextToSend.messages,B=_.type,e.n="none"===B?4:"first"===B?5:"last"===B?6:"range"===B?7:8;break;case 4:return C.messageIndexesBetween={start:-1,end:-1},e.a(3,9);case 5:return C.messageIndexesBetween={start:0,end:null!==(n=_.first)&&void 0!==n?n:10},e.a(3,9);case 6:return E=null!==(r=null===(o=Ko.chat)||void 0===o?void 0:o.length)&&void 0!==r?r:0,k=null!==(i=_.last)&&void 0!==i?i:10,C.messageIndexesBetween={end:Math.max(0,E-1),start:Math.max(0,E-k)},e.a(3,9);case 7:return C.messageIndexesBetween={start:null!==(a=null===(s=_.range)||void 0===s?void 0:s.start)&&void 0!==a?a:0,end:null!==(l=null===(c=_.range)||void 0===c?void 0:c.end)&&void 0!==l?l:10},e.a(3,9);case 8:return e.a(3,9);case 9:void 0!==p||P||(C.messageIndexesBetween={start:-1,end:-1}),D="",j=h.outputFormat,e.n="xml"===j?10:"json"===j?11:"none"===j?12:13;break;case 10:return D=h.prompts.xmlFormat.content,e.a(3,13);case 11:return D=h.prompts.jsonFormat.content,e.a(3,13);case 12:return D=h.prompts.noneFormat.content,e.a(3,13);case 13:return T={},e.n=14,Promise.all(m.filter(function(e){return q.selectedWorldNames.includes(e)}).map(function(){var e=Hi(ji().m(function e(t){var n;return ji().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,Ko.loadWorldInfo(t);case 1:(n=e.v)&&(T[t]=Object.values(n.entries));case 2:return e.a(2)}},e)}));return function(t){return e.apply(this,arguments)}}()));case 14:A={},N=Ti(Zo);try{for(N.s();!(O=N.n()).done;)F=O.value,A[F]={prompt:q.fields[F].prompt,value:q.fields[F].value,label:Qo[F]}}catch(e){N.e(e)}finally{N.f()}return le().forEach(function(e){A[e]={prompt:q.fields[e].prompt,value:q.fields[e].value,label:e}}),I=Ni(Ni({},q),{},{fields:A}),L=structuredClone(h.prompts),h.contextToSend.stDescription||delete L.stDescription,h.contextToSend.charCard&&0!==q.selectedCharacterIndexes.length||delete L.charDefinitions,h.contextToSend.worldInfo&&0!==q.selectedWorldNames.length||delete L.lorebookDefinitions,h.contextToSend.existingFields||delete L.existingFieldDefinitions,h.contextToSend.persona||delete L.personaDescription,delete L.worldInfoCharDefinition,e.n=15,ei({profileId:h.profileId,userPrompt:x,buildPromptOptions:C,continueFrom:y,session:I,allCharacters:U.characters,entriesGroupByWorldName:T,promptSettings:L,formatDescription:{content:D},mainContextList:h.mainContextTemplatePresets[h.mainContextTemplatePreset].prompts.filter(function(e){return e.enabled}).map(function(e){return{promptName:e.promptName,role:e.role}}),includeUserMacro:h.contextToSend.persona,maxResponseToken:h.maxResponseToken,targetField:u,outputFormat:h.outputFormat});case 15:M=e.v,g.value=M,g.dispatchEvent(new Event("change")),e.n=17;break;case 16:e.p=16,R=e.v,console.error("Error generating field ".concat(u,":"),R),Te("error","Failed to generate ".concat(u,": ").concat(R.message||R));case 17:return e.p=17,f.disabled=!1,f.innerHTML=b,e.f(17);case 18:return e.a(2)}},e,null,[[1,16,17,18]])})),_e.apply(this,arguments)},Ce=function(e){return _e.apply(this,arguments)},e.n=1,Ko.renderExtensionTemplateAsync("third-party/".concat(Io),"templates/popup");case 1:if(u=e.v,Ko.callGenericPopup(u,ur.DISPLAY,void 0,{large:!0,wide:!0}),d=document.getElementById("charCreatorPopup")){e.n=2;break}return e.a(2);case 2:h=Mo.getSettings(),Ko.ConnectionManagerRequestService.handleDropdown("#charCreatorPopup #charCreator_connectionProfile",h.profileId,function(e){var t;h.profileId=null!==(t=null==e?void 0:e.id)&&void 0!==t?t:"",Mo.saveSettings()}),f=d.querySelector("#charCreator_stDescription"),g=d.querySelector("#charCreator_includePersona"),v=d.querySelector("#charCreator_includeChars"),y=d.querySelector("#charCreator_charIncludeContainer"),b=d.querySelector("#charCreator_includeWorldInfo"),S=d.querySelector("#charCreator_worldInfoIncludeContainer"),x=d.querySelector("#charCreator_includeExistingFields"),f.checked=h.contextToSend.stDescription,g.checked=h.contextToSend.persona,v.checked=h.contextToSend.charCard,x.checked=h.contextToSend.existingFields,b.checked=h.contextToSend.worldInfo,(w=d.querySelector("#charCreator_dontSendOtherGreetings")).checked=h.contextToSend.dontSendOtherGreetings,y.style.display=v.checked?"block":"none",S.style.display=b.checked?"block":"none",f.addEventListener("change",function(){h.contextToSend.stDescription=f.checked,Mo.saveSettings()}),g.addEventListener("change",function(){h.contextToSend.persona=g.checked,Mo.saveSettings()}),v.addEventListener("change",function(){h.contextToSend.charCard=v.checked,y.style.display=v.checked?"block":"none",Mo.saveSettings()}),b.addEventListener("change",function(){h.contextToSend.worldInfo=b.checked,S.style.display=b.checked?"block":"none",Mo.saveSettings()}),x.addEventListener("change",function(){h.contextToSend.existingFields=x.checked,Mo.saveSettings()}),w.addEventListener("change",function(){h.contextToSend.dontSendOtherGreetings=w.checked,Mo.saveSettings()}),C=d.querySelector(".message-options"),_=d.querySelector("#charCreator_messageType"),E=d.querySelector("#charCreator_firstX"),k=d.querySelector("#charCreator_lastX"),D=d.querySelector("#charCreator_rangeX"),T=d.querySelector("#charCreator_firstXMessages"),I=d.querySelector("#charCreator_lastXMessages"),A=d.querySelector("#charCreator_rangeStart"),N=d.querySelector("#charCreator_rangeEnd"),_.value=h.contextToSend.messages.type,T.value=String(null!==(t=h.contextToSend.messages.first)&&void 0!==t?t:10),I.value=String(null!==(n=h.contextToSend.messages.last)&&void 0!==n?n:10),A.value=String(null!==(r=null===(o=h.contextToSend.messages.range)||void 0===o?void 0:o.start)&&void 0!==r?r:0),N.value=String(null!==(i=null===(a=h.contextToSend.messages.range)||void 0===a?void 0:a.end)&&void 0!==i?i:10),(L=function(e){E.style.display="first"===e?"block":"none",k.style.display="last"===e?"block":"none",D.style.display="range"===e?"block":"none"})(_.value),void 0!==p||P||(C.style.display="none"),_.addEventListener("change",function(){var e=_.value;h.contextToSend.messages.type=e,Mo.saveSettings(),L(e)}),T.addEventListener("change",function(){h.contextToSend.messages.first=parseInt(T.value)||10,Mo.saveSettings()}),I.addEventListener("change",function(){h.contextToSend.messages.last=parseInt(I.value)||10,Mo.saveSettings()}),A.addEventListener("change",function(){var e,t;h.contextToSend.messages.range={start:parseInt(A.value)||0,end:null!==(e=null===(t=h.contextToSend.messages.range)||void 0===t?void 0:t.end)&&void 0!==e?e:10},Mo.saveSettings()}),N.addEventListener("change",function(){var e,t;h.contextToSend.messages.range={start:null!==(e=null===(t=h.contextToSend.messages.range)||void 0===t?void 0:t.start)&&void 0!==e?e:0,end:parseInt(N.value)||10},Mo.saveSettings()}),M=d.querySelector("#charCreator_maxContextType"),B=d.querySelector("#charCreator_maxTokens_container"),j=d.querySelector("#charCreator_maxTokens"),M.value=h.maxContextType,B.style.display="custom"===h.maxContextType?"block":"none",j.value=String(h.maxContextValue),M.addEventListener("change",function(){var e=M.value;h.maxContextType=e,Mo.saveSettings(),B.style.display="custom"===e?"block":"none"}),j.addEventListener("change",function(){h.maxContextValue=Number(j.value)||16384,Mo.saveSettings()}),(R=d.querySelector("#charCreator_maxResponseTokens")).value=String(h.maxResponseToken),R.addEventListener("change",function(){h.maxResponseToken=Number(R.value)||1024,Mo.saveSettings()}),($=d.querySelector("#charCreator_outputFormat")).value=h.outputFormat,$.addEventListener("change",function(){h.outputFormat=$.value,Mo.saveSettings()}),H="charCreator",(q=JSON.parse(null!==(s=localStorage.getItem(H))&&void 0!==s?s:"{}")).selectedCharacterIndexes||(q.selectedCharacterIndexes=p?[p]:[]),q.selectedWorldNames||(q.selectedWorldNames=[]),q.fields||(q.fields={}),q.draftFields||(q.draftFields={}),q.lastLoadedCharacterId||(q.lastLoadedCharacterId=""),q.creatorChatHistory||(q.creatorChatHistory={messages:[]}),Zo.forEach(function(e){q.fields[e]||(q.fields[e]={value:"",prompt:"",label:""})}),V=function(){localStorage.setItem(H,JSON.stringify(q))},U=SillyTavern.getContext(),q.selectedCharacterIndexes=q.selectedCharacterIndexes.filter(function(e){return U.characters[Number(e)]}),d.querySelector("#charCreator_characterSelector")&&(W=U.characters.map(function(e){return{value:U.characters.indexOf(e).toString(),label:e.name}}),G=De("#charCreator_characterSelector",{initialList:W,initialValues:q.selectedCharacterIndexes,placeholderText:"Select characters...",enableSearch:W.length>10,onSelectChange:function(e,t){q.selectedCharacterIndexes=t,V()}}),d.querySelector("#charCreator_clear-includeChars-button").addEventListener("click",function(){G.deselectAll()})),Y=d.querySelector("#charCreator_worldInfoSelector"),X=structuredClone(m);try{Y&&X.length>0?De("#charCreator_worldInfoSelector",{initialList:X,initialValues:q.selectedWorldNames,placeholderText:"Select lorebooks...",enableSearch:X.length>10,onSelectChange:function(e,t){q.selectedWorldNames=t,V()}}):Y&&(Y.textContent="No active lorebooks found.")}catch(e){console.error("Failed to get active world info:",e),Y&&(Y.textContent="Error loading lorebooks.")}z=d.querySelector("#charCreator_prompt"),Me("#charCreatorPopup #charCreator_promptPreset",{initialValue:h.promptPreset,initialList:Object.keys(h.promptPresets),readOnlyValues:["default"],onSelectChange:function(){var e=Hi(ji().m(function e(t,n){var r,o,i;return ji().w(function(e){for(;;)switch(e.n){case 0:i=null!=n?n:"default",h.promptPreset=i,Mo.saveSettings(),z.value=null!==(r=null===(o=h.promptPresets[i])||void 0===o?void 0:o.content)&&void 0!==r?r:"";case 1:return e.a(2)}},e)}));return function(t,n){return e.apply(this,arguments)}}(),create:{onAfterCreate:function(e){var t,n=h.promptPresets[h.promptPreset];h.promptPresets[e]={content:null!==(t=null==n?void 0:n.content)&&void 0!==t?t:""}}},rename:{onAfterRename:function(e,t){h.promptPresets[t]=h.promptPresets[e],delete h.promptPresets[e]}},delete:{onAfterDelete:function(e){delete h.promptPresets[e]}}}),z.value=null!==(l=null===(c=h.promptPresets[h.promptPreset])||void 0===c?void 0:c.content)&&void 0!==l?l:"",z.addEventListener("change",function(){h.promptPresets[h.promptPreset]&&(h.promptPresets[h.promptPreset].content=z.value,Mo.saveSettings())}),J={name:{label:Qo.name,rows:1,large:!1,promptEnabled:!1},description:{label:Qo.description,rows:5,large:!0,promptEnabled:!0},personality:{label:Qo.personality,rows:4,large:!0,promptEnabled:!0},scenario:{label:Qo.scenario,rows:3,large:!0,promptEnabled:!0},first_mes:{label:Qo.first_mes,rows:3,large:!0,promptEnabled:!0},mes_example:{label:Qo.mes_example,rows:6,large:!0,promptEnabled:!0}},K=d.querySelector("#charCreator_coreFieldTemplate"),Z=d.querySelector("#charCreator_draftFieldTemplate"),Q=d.querySelector("#charCreator_coreFieldsContainer"),ee=d.querySelector("#charCreator_draftFieldsList"),te=d.querySelectorAll(".tab-button"),ne=d.querySelectorAll(".tab-content"),re=d.querySelector("#charCreator_addDraftField"),oe=d.querySelector("#charCreator_exportDraftFields"),ie=d.querySelector("#charCreator_importDraftFields"),ae={},se=function(e){te.forEach(function(t){t.classList.toggle("active",t.getAttribute("data-tab")===e)}),ne.forEach(function(t){t.classList.toggle("active",t.id===e)});var t="charCreator_draftFieldsContainer"===e;if(re.style.display=t?"block":"none",oe.style.display=t?"block":"none",ie.style.display=t?"block":"none","charCreator_chatContainer"===e){var n=document.querySelector("#charCreator_chatContainer");n&&!n.querySelector("#chat_container")&&pi()}},te.forEach(function(e){e.addEventListener("click",function(){var t=e.getAttribute("data-tab");t&&se(t)})}),se("charCreator_coreFieldsContainer"),le=function(){return Object.keys(q.fields).filter(function(e){return e.startsWith("alternate_greetings_")}).sort(function(e,t){return parseInt(e.split("_")[2]||"1")-parseInt(t.split("_")[2]||"1")})},ce=0,ue=function(e){var t,n,r,o,i,a,s=d.querySelector("#charCreator_alternateGreetingTabContentTemplate"),l=e.querySelector(".alternate-greetings-tabs"),c=e.querySelector(".alternate-greetings-content-area"),u=e.querySelector(".no-greetings-placeholder"),p=e.querySelector(".add-alternate-greeting-button"),h=e.querySelector(".delete-alternate-greeting-button"),f=e.querySelector(".field-container > div:last-child"),m=null==f?void 0:f.querySelector(".generate-alternate-greeting-button"),g=null==f?void 0:f.querySelector(".continue-alternate-greeting-button"),v=null==f?void 0:f.querySelector(".compare-alternate-greeting-button"),y=null==f?void 0:f.querySelector(".clear-alternate-greeting-button");l.innerHTML="",c.innerHTML="";var b=le(),S=function(e){ce=e,l.querySelectorAll(".alternate-greeting-tab-button").forEach(function(t,n){t.classList.toggle("active",n===e)}),c.querySelectorAll(".alternate-greeting-tab-content").forEach(function(t,n){t.style.display=n===e?"block":"none"});var t=b.length>0;m.disabled=!t,g.disabled=!t,v.disabled=!t,y.disabled=!t,h.disabled=!t};0===b.length?(u.style.display="block",c.style.display="none",m.disabled=!0,y.disabled=!0,h.disabled=!0):(u.style.display="none",c.style.display="block",b.forEach(function(e,t){var n,r,o=q.fields[e];if(o){var i=document.createElement("button");i.className="menu_button alternate-greeting-tab-button";var a=parseInt(e.split("_")[2])||1;i.textContent="Greeting ".concat(a),i.dataset.index=t.toString(),i.addEventListener("click",function(){return S(t)}),l.appendChild(i);var u=s.content.cloneNode(!0),p=u.querySelector(".alternate-greeting-textarea"),d=u.querySelector(".alternate-greeting-prompt-textarea");p.value=null!==(n=o.value)&&void 0!==n?n:"",d.value=null!==(r=o.prompt)&&void 0!==r?r:"",p.rows=8,p.addEventListener("change",function(){q.fields[e]&&(q.fields[e].value=p.value,V())}),d.addEventListener("change",function(){q.fields[e]&&(q.fields[e].prompt=d.value,V())}),c.appendChild(u)}}),S(0));var x=p.cloneNode(!0);null===(t=p.parentNode)||void 0===t||t.replaceChild(x,p);var w=h.cloneNode(!0);null===(n=h.parentNode)||void 0===n||n.replaceChild(w,h);var C=m.cloneNode(!0);null===(r=m.parentNode)||void 0===r||r.replaceChild(C,m);var _=g.cloneNode(!0);null===(o=g.parentNode)||void 0===o||o.replaceChild(_,g);var E=v.cloneNode(!0);null===(i=v.parentNode)||void 0===i||i.replaceChild(E,v);var k=y.cloneNode(!0);null===(a=y.parentNode)||void 0===a||a.replaceChild(k,y),x.addEventListener("click",function(){var t=b.length+1,n="alternate_greetings_".concat(t);q.fields[n]={prompt:"",value:"",label:"Alternate Greeting ".concat(t)},V(),ue(e),S(b.length)}),w.addEventListener("click",Hi(ji().m(function t(){var n,r;return ji().w(function(t){for(;;)switch(t.n){case 0:if(!(ce<0||ce>=b.length)){t.n=1;break}return t.a(2);case 1:return n=b[ce],t.n=2,Ko.Popup.show.confirm("Delete Greeting","Are you sure you want to delete Greeting ".concat(ce+1,"? This cannot be undone."));case 2:t.v&&(delete q.fields[n],b.slice(ce+1).forEach(function(e,t){var n=ce+t+1,r="alternate_greetings_".concat(n);e!==r&&(q.fields[r]=q.fields[e],q.fields[r].label="Alternate Greeting ".concat(n),delete q.fields[e])}),V(),ue(e),(r=le()).length>0&&S(Math.min(ce,r.length-1)));case 3:return t.a(2)}},t)}))),C.addEventListener("click",function(){if(!(ce<0||ce>=b.length)){var e=b[ce],t=c.querySelectorAll(".alternate-greeting-tab-content")[ce],n=null==t?void 0:t.querySelector(".alternate-greeting-textarea");Ce({targetField:e,button:C,textarea:n,isDraft:!1})}}),_.addEventListener("click",function(){if(!(ce<0||ce>=b.length)){var e=b[ce],t=c.querySelectorAll(".alternate-greeting-tab-content")[ce],n=null==t?void 0:t.querySelector(".alternate-greeting-textarea");null!=n&&n.value.trim()?Ce({targetField:e,button:_,textarea:n,isDraft:!1,continueFrom:n.value}):Te("warning","No content to continue from")}}),E.addEventListener("click",function(){var e,t,n,r;if(!(ce<0||ce>=b.length)){var o=b[ce],i=c.querySelectorAll(".alternate-greeting-tab-content")[ce],a=null==i?void 0:i.querySelector(".alternate-greeting-textarea");if(null!=a&&a.value.trim()){var s=null===(e=ge)||void 0===e||null===(e=e.getValues())||void 0===e?void 0:e[0];if(s){var l=U.characters[parseInt(s)];if(l){var u=null!==(r=(null!==(t=null===(n=l.data)||void 0===n?void 0:n.alternate_greetings)&&void 0!==t?t:[])[ce])&&void 0!==r?r:"";Ee(o,a.value,u)}else Te("warning","Selected character not found.")}else Te("warning","Please select a character first to compare against.")}else Te("warning","No content to compare")}}),k.addEventListener("click",function(){if(!(ce<0||ce>=b.length)){var e=b[ce],t=c.querySelectorAll(".alternate-greeting-tab-content")[ce],n=null==t?void 0:t.querySelector(".alternate-greeting-textarea");null==t||t.querySelector(".alternate-greeting-prompt-textarea");q.fields[e]&&(n.value="",q.fields[e].value="",V())}})},Zo.forEach(function(e){var t,n;if(e in J){var r=J[e],o=K.content.cloneNode(!0),i=o.querySelector("label"),a=o.querySelector(".field-value-textarea"),s=o.querySelector(".generate-field-button"),l=o.querySelector(".continue-field-button"),c=o.querySelector(".clear-field-button"),u=o.querySelector(".field-prompt-textarea");a.id="charCreator_field_".concat(e),u.id="charCreator_prompt_".concat(e),i.textContent=r.label,i.htmlFor=a.id,a.rows=r.rows;var p,d,h=q.fields[e];if(a.value=null!==(t=null==h?void 0:h.value)&&void 0!==t?t:"",s.dataset.field=e,s.title="Generate ".concat(r.label),u.placeholder="Enter additional prompt for ".concat(r.label.toLowerCase(),"..."),u.value=null!==(n=null==h?void 0:h.prompt)&&void 0!==n?n:"",!r.promptEnabled)null===(p=u.closest(".field-prompt-container"))||void 0===p||p.remove();if(r.large)null===(d=a.closest(".field-container"))||void 0===d||d.classList.add("large-field");null==c||c.addEventListener("click",function(){a.value="",a.dispatchEvent(new Event("change"))}),ae[e]={textarea:a,button:s,continueButton:l,promptTextarea:u,clearButton:c},Q.appendChild(o)}else console.warn("Skipping unknown core field: ".concat(e))}),pe=d.querySelector("#charCreator_alternateGreetingsTemplate"),de=pe.content.cloneNode(!0),he=de.querySelector(".alternate-greetings-field"),Q.appendChild(de),ue(he),fe=function(e,t){var n,r;if(Z&&ee){var o=Z.content.cloneNode(!0),i=o.querySelector(".character-field"),a=o.querySelector("label"),s=o.querySelector(".field-value-textarea"),l=o.querySelector(".field-prompt-textarea"),c=o.querySelector(".delete-draft-field-button"),u=o.querySelector(".generate-field-button"),p=o.querySelector(".continue-field-button"),d=o.querySelector(".clear-field-button");i.dataset.draftFieldName=e,a.textContent=t.label,a.htmlFor="charCreator_draft_field_".concat(e),s.id="charCreator_draft_field_".concat(e),s.value=null!==(n=t.value)&&void 0!==n?n:"",l.value=null!==(r=t.prompt)&&void 0!==r?r:"",l.id="charCreator_draft_prompt_".concat(e),l.placeholder="Enter additional prompt for ".concat(t.label,"..."),c.dataset.draftFieldName=e,u.dataset.field=e,d.dataset.draftFieldName=e,s.addEventListener("change",function(){q.draftFields[e]&&(q.draftFields[e].value=s.value,V())}),l.addEventListener("change",function(){q.draftFields[e]&&(q.draftFields[e].prompt=l.value,V())}),d.addEventListener("click",function(){q.draftFields[e]&&(s.value="",q.draftFields[e].value="",V())}),c.addEventListener("click",Hi(ji().m(function n(){return ji().w(function(n){for(;;)switch(n.n){case 0:return n.n=1,Ko.Popup.show.confirm("Delete Draft Field",'Are you sure you want to delete the draft field "'.concat(t.label,'"? This cannot be undone.'));case 1:n.v&&(delete q.draftFields[e],i.remove(),V());case 2:return n.a(2)}},n)}))),u.addEventListener("click",function(){Ce({targetField:e,button:u,textarea:s,isDraft:!0})}),p.addEventListener("click",function(){s.value.trim()?Ce({targetField:e,button:p,textarea:s,isDraft:!0,continueFrom:s.value}):Te("warning","No content to continue from")}),ee.appendChild(o)}},(me=function(){ee&&(ee.innerHTML="",Object.entries(q.draftFields||{}).forEach(function(e){var t=Li(e,2),n=t[0],r=t[1];fe(n,r)}))})(),null==oe||oe.addEventListener("click",function(){var e={draftFields:q.draftFields,timestamp:(new Date).toISOString(),version:Ao},t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),n=URL.createObjectURL(t),r=document.createElement("a");r.href=n,r.download="draft-fields-".concat((new Date).toISOString().slice(0,10),".json"),document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(n)}),null==ie||ie.addEventListener("click",Hi(ji().m(function e(){var t;return ji().w(function(e){for(;;)switch(e.n){case 0:(t=document.createElement("input")).type="file",t.accept=".json",t.addEventListener("change",Hi(ji().m(function e(){var n,r,o,i,a,s;return ji().w(function(e){for(;;)switch(e.p=e.n){case 0:if(r=null===(n=t.files)||void 0===n?void 0:n[0]){e.n=1;break}return e.a(2);case 1:return e.p=1,e.n=2,r.text();case 2:if(o=e.v,(i=JSON.parse(o)).draftFields&&"object"===Ii(i.draftFields)){e.n=3;break}throw new Error("Invalid draft fields data");case 3:if(a=!0,!(Object.keys(q.draftFields).length>0)){e.n=5;break}return e.n=4,Ko.Popup.show.confirm("Import Draft Fields","This will replace all existing draft fields. Continue?");case 4:a=e.v;case 5:a&&(q.draftFields=i.draftFields,V(),me(),Te("success","Draft fields imported successfully")),e.n=7;break;case 6:e.p=6,s=e.v,Te("error","Failed to import draft fields: ".concat(s.message));case 7:return e.a(2)}},e,null,[[1,6]])}))),t.click();case 1:return e.a(2)}},e)}))),re&&re.addEventListener("click",Hi(ji().m(function e(){var t,n;return ji().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,Ko.Popup.show.input("Enter Draft Field Name","");case 1:if((t=e.v)&&t.trim()){e.n=2;break}return e.a(2);case 2:if(n=Lo(t.trim())){e.n=3;break}return Te("error","Invalid field name provided."),e.a(2);case 3:if(!q.draftFields[n]&&!Qo[n]){e.n=4;break}return Te("warning",'Field name "'.concat(n,'" already exists.')),e.a(2);case 4:q.draftFields[n]={value:"",prompt:"",label:t},fe(n,q.draftFields[n]),V();case 5:return e.a(2)}},e)}))),ge=null,d.querySelector("#charCreator_loadCharSelector")&&(ve=U.characters.map(function(e){return{value:U.characters.indexOf(e).toString(),label:e.name}}),ye=q.lastLoadedCharacterId?U.characters.findIndex(function(e){return e.avatar===q.lastLoadedCharacterId}):-1,be=ye>=0?[ye.toString()]:[],ge=De("#charCreator_loadCharSelector",{initialList:ve,initialValues:be,placeholderText:"Load Character Data...",enableSearch:ve.length>10,multiple:!1,closeOnSelect:!0,onBeforeSelection:function(e,t){return Hi(ji().m(function e(){return ji().w(function(e){for(;;)switch(e.n){case 0:if(0!==t.length){e.n=1;break}return e.a(2,!1);case 1:if(0!==t[0].length){e.n=2;break}return e.a(2,!1);case 2:if(Zo.every(function(e){var t,n=null===(t=ae[e])||void 0===t?void 0:t.textarea;return n&&""===n.value.trim()})){e.n=4;break}return e.n=3,Ko.Popup.show.confirm("Load Character Data","Are you sure you want to overwrite existing data? This cannot be undone.");case 3:if(e.v){e.n=4;break}return e.a(2,!1);case 4:return e.a(2,!0)}},e)}))()},onSelectChange:function(){var e=Hi(ji().m(function e(t,n){var r,o,i,a,s,l;return ji().w(function(e){for(;;)switch(e.n){case 0:if(0!==n.length){e.n=1;break}return e.a(2);case 1:if(0!==(i=n[0]).length){e.n=2;break}return e.a(2);case 2:if(a=U.characters[parseInt(i)]){e.n=3;break}return Te("warning","Selected character not found."),e.a(2);case 3:Zo.forEach(function(e){var t=ae[e];if(t){var n,r,o,i=t.textarea,s=t.promptTextarea,l=q.fields[e],c=null!==(n=null!==(r=a[e])&&void 0!==r?r:null===(o=a.data)||void 0===o?void 0:o[e])&&void 0!==n?n:"";i.value!==c&&(i.value=c,l&&(l.value=c)),s&&null!=l&&l.prompt&&(s.value="",l.prompt="")}}),le().forEach(function(e){delete q.fields[e]}),s=null!==(r=null===(o=a.data)||void 0===o?void 0:o.alternate_greetings)&&void 0!==r?r:[],Array.isArray(s)&&s.forEach(function(e,t){var n=t+1,r="alternate_greetings_".concat(n);q.fields[r]={value:e,prompt:"",label:"Alternate Greeting ".concat(n)}}),(l=null==Q?void 0:Q.querySelector(".alternate-greetings-field"))&&ue(l),q.lastLoadedCharacterId=a.avatar,V();case 4:return e.a(2)}},e)}));return function(t,n){return e.apply(this,arguments)}}()})),d.querySelector("#charCreator_reset").addEventListener("click",Hi(ji().m(function e(){var t;return ji().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,Ko.Popup.show.confirm("Reset Fields","Are you sure? This will reset core fields and remove draft fields. This cannot be undone.");case 1:e.v&&(Zo.forEach(function(e){var t=ae[e];if(t){var n=q.fields[e];t.textarea&&(t.textarea.value="",n&&(n.value="")),t.promptTextarea&&(t.promptTextarea.value="",n&&(n.prompt=""))}}),le().forEach(function(e){delete q.fields[e]}),(t=null==Q?void 0:Q.querySelector(".alternate-greetings-field"))&&ue(t),ge.deselectAll(),q.draftFields={},q.creatorChatHistory={messages:[]},V(),me());case 2:return e.a(2)}},e)}))),d.querySelector("#charCreator_saveAsNewCharacter").addEventListener("click",Hi(ji().m(function e(){var t,n,r;return ji().w(function(e){for(;;)switch(e.p=e.n){case 0:if(q.fields.name.value){e.n=1;break}return Te("warning","Please enter a name for the new character."),e.a(2);case 1:return e.n=2,Ko.Popup.show.confirm("Save as New Character","Are you sure?");case 2:if(e.v){e.n=3;break}return e.a(2);case 3:return t=le().map(function(e){var t,n;return null!==(t=null===(n=q.fields[e])||void 0===n?void 0:n.value)&&void 0!==t?t:""}).filter(function(e){return""!==e.trim()}),n={name:q.fields.name.value,description:q.fields.description.value,personality:q.fields.personality.value,scenario:q.fields.scenario.value,first_mes:q.fields.first_mes.value,mes_example:q.fields.mes_example.value,data:{name:q.fields.name.value,description:q.fields.description.value,personality:q.fields.personality.value,scenario:q.fields.scenario.value,first_mes:q.fields.first_mes.value,mes_example:q.fields.mes_example.value,tags:[],avatar:"none",alternate_greetings:t},avatar:"none",tags:[],spec:"chara_card_v3",spec_version:"3.0"},e.p=4,e.n=5,O(n,!0);case 5:e.n=7;break;case 6:e.p=6,r=e.v,Te("error","Failed to create character: ".concat(r.message));case 7:return e.a(2)}},e,null,[[4,6]])}))),d.querySelector("#charCreator_overrideCharacter").addEventListener("click",Hi(ji().m(function e(){var t,n,r,o,i,a;return ji().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=null===(t=ge)||void 0===t||null===(t=t.getValues())||void 0===t?void 0:t[0]){e.n=1;break}return Te("warning","Please load a character first to override."),e.a(2);case 1:if(r=U.characters[parseInt(n)]){e.n=2;break}return Te("warning","Selected character not found for override."),e.a(2);case 2:if(q.fields.name.value){e.n=3;break}return Te("warning","Please enter a name for the character."),e.a(2);case 3:return e.n=4,Ko.Popup.show.confirm("Override Character",'Are you sure you want to override "'.concat(r.name,'"? This cannot be undone.'));case 4:if(e.v){e.n=5;break}return e.a(2);case 5:return o=le().map(function(e){var t,n;return null!==(t=null===(n=q.fields[e])||void 0===n?void 0:n.value)&&void 0!==t?t:""}).filter(function(e){return""!==e.trim()}),i=Ni(Ni({},r),{},{name:q.fields.name.value,description:q.fields.description.value,personality:q.fields.personality.value,scenario:q.fields.scenario.value,first_mes:q.fields.first_mes.value,mes_example:q.fields.mes_example.value,data:Ni(Ni({},r.data),{},{name:q.fields.name.value,description:q.fields.description.value,personality:q.fields.personality.value,scenario:q.fields.scenario.value,first_mes:q.fields.first_mes.value,mes_example:q.fields.mes_example.value,alternate_greetings:o})}),e.p=6,e.n=7,F(i,!0);case 7:Te("success",'Character "'.concat(i.name,'" overridden successfully!')),e.n=9;break;case 8:e.p=8,a=e.v,Te("error","Failed to override character: ".concat(a.message));case 9:return e.a(2)}},e,null,[[6,8]])}))),Se=d.querySelector("#charCreator_saveAsWorldInfoSelector"),h.showSaveAsWorldInfoEntry.show?(xe=De(Se,{placeholderText:"Save as World Info Entry",initialList:m,closeOnSelect:!0,multiple:!1,enableSearch:!0,onBeforeSelection:function(e,t){return Hi(ji().m(function e(){var n,r,o,i,a,s,l,c;return ji().w(function(e){for(;;)switch(e.p=e.n){case 0:if(0!==t.length){e.n=1;break}return e.a(2,!1);case 1:if(n=le().map(function(e){var t,n;return null!==(t=null===(n=q.fields[e])||void 0===n?void 0:n.value)&&void 0!==t?t:""}).filter(function(e){return""!==e.trim()}),(r={name:q.fields.name.value,description:q.fields.description.value,first_mes:q.fields.first_mes.value,scenario:q.fields.scenario.value,personality:q.fields.personality.value,mes_example:q.fields.mes_example.value,alternate_greetings:n}).name){e.n=2;break}return Te("warning","Please enter a name for the character."),we(),e.a(2,!1);case 2:o="",e.p=3,i=jo.compile(h.prompts.charDefinitions.content,{noEscape:!0}),o=i({character:r}),e.n=5;break;case 4:return e.p=4,l=e.v,console.error("Failed to compile character definition prompt: ".concat(l.message)),Te("error","Failed to compile character definition prompt: ".concat(l.message)),we(),e.a(2,!1);case 5:return a=t[0],s={uid:-1,key:[q.fields.name.value],content:o,comment:q.fields.name.value,disable:!1,keysecondary:[]},e.p=6,e.n=7,Yn({entry:s,selectedWorldName:a,operation:"add"});case 7:Te("success","Entry added"),e.n=9;break;case 8:e.p=8,c=e.v,Te("error","Failed to create world info entry: ".concat(c.message));case 9:return we(),e.a(2,!1)}},e,null,[[6,8],[3,4]])}))()}}),we=xe.close):Se.style.display="none",Ee=function(){var e=Hi(ji().m(function e(t,n,r){var o,i,a,s,l,c,u,p,d,h,f,m;return ji().w(function(e){for(;;)switch(e.n){case 0:return(o=document.createElement("div")).classList.add("compare-popup"),(i=document.createElement("h3")).textContent="Compare ".concat(Qo[t]||t),o.appendChild(i),(a=document.createElement("div")).style.display="flex",a.style.gap="1rem",a.style.marginTop="1rem",(s=document.createElement("div")).style.flex="1",(l=document.createElement("div")).style.flex="1",(c=document.createElement("h4")).textContent="Character Content",(u=document.createElement("h4")).textContent="Current Content",s.appendChild(c),l.appendChild(u),p=sr(r,n),d="",h="",p.forEach(function(e){var t=e.added?"green":e.removed?"red":"grey",n="color: ".concat(t,"; ").concat(e.added||e.removed?"background-color: rgba(0,0,0,0.1);":"");e.added||(d+='<span style="'.concat(n,'">').concat(e.value,"</span>")),e.removed||(h+='<span style="'.concat(n,'">').concat(e.value,"</span>"))}),(f=document.createElement("div")).classList.add("content"),f.innerHTML=d,f.style.whiteSpace="pre-wrap",f.style.fontFamily="monospace",f.style.padding="1rem",f.style.border="1px solid #ccc",(m=document.createElement("div")).classList.add("content"),m.innerHTML=h,m.style.whiteSpace="pre-wrap",m.style.fontFamily="monospace",m.style.padding="1rem",m.style.border="1px solid #ccc",s.appendChild(f),l.appendChild(m),a.appendChild(s),a.appendChild(l),o.appendChild(a),e.n=1,Ko.callGenericPopup(o,ur.DISPLAY,void 0,{wide:!0});case 1:return e.a(2)}},e)}));return function(t,n,r){return e.apply(this,arguments)}}(),Object.entries(ae).forEach(function(e){var t,n=Li(e,2),r=n[0],o=n[1],i=o.textarea,a=o.button,s=o.continueButton,l=o.promptTextarea,c=null===(t=i.closest(".field-container"))||void 0===t?void 0:t.querySelector(".compare-field-button");c&&c.addEventListener("click",function(){var e,t,n,o,a,s;Ee(r,i.value,null!==(e=null!==(t=null===(n=U.characters[parseInt(null===(o=ge)||void 0===o||null===(o=o.getValues())||void 0===o?void 0:o[0])])||void 0===n?void 0:n[r])&&void 0!==t?t:null===(a=U.characters[parseInt(null===(s=ge)||void 0===s||null===(s=s.getValues())||void 0===s?void 0:s[0])])||void 0===a||null===(a=a.data)||void 0===a?void 0:a[r])&&void 0!==e?e:"")}),s&&s.addEventListener("click",function(){i.value.trim()?Ce({targetField:r,button:s,textarea:i,continueFrom:i.value}):Te("warning","No content to continue from")}),a&&(a.addEventListener("click",function(){Ce({targetField:r,button:a,textarea:i})}),i.addEventListener("change",function(){var e=r;q.fields[e]=Ni(Ni({},q.fields[e]),{},{value:i.value}),V()}),null==l||l.addEventListener("change",function(){var e=r;q.fields[e]=Ni(Ni({},q.fields[e]),{},{prompt:l.value}),V()}))});case 3:return e.a(2)}},e)})))});case 1:return e.a(2)}},e)})),Vi.apply(this,arguments)}function Ui(){!function(){qi.apply(this,arguments)}(),function(){Vi.apply(this,arguments)}(),ui()}jo.helpers.join||jo.registerHelper("join",function(e,t){return Array.isArray(e)?e.join("string"==typeof t?t:", "):""}),Ko.ConnectionManagerRequestService?function(){return Bo.apply(this,arguments)}().then(function(){Ui()}):Te("error","[".concat(Io,"] Make sure ST is updated."));
//# sourceMappingURL=index.js.map