import*as e from"../../../../power-user.js";import*as t from"../../../../../script.js";import*as n from"../../../../world-info.js";import*as r from"../../../../instruct-mode.js";import*as o from"../../../../chats.js";import*as i from"../../../../openai.js";import*as a from"../../../../authors-note.js";import*as s from"../../../../group-chats.js";import*as c from"../../../regex/engine.js";import*as l from"../../../../utils.js";import*as u from"../../../../slash-commands/SlashCommandCommonEnumsProvider.js";import*as d from"../../../../../lib.js";var h={d:(e,t)=>{for(var n in t)h.o(t,n)&&!h.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};class p extends Error{data;constructor(e,t){super(e),this.data=t}toString(){return this.message}}async function f(e,t){const n=SillyTavern.getContext(),r=new FormData;r.append("avatar",new Blob([JSON.stringify(e)],{type:"application/json"}),"character.json"),r.append("file_type","json");const o=n.getRequestHeaders();delete o["Content-Type"];const i=await fetch("/api/characters/import",{method:"POST",headers:o,body:r,cache:"no-cache"});if(!i.ok)throw new p(i.statusText,i);(t??1)&&await n.getCharacters()}function m(e){return Array.isArray?Array.isArray(e):"[object Array]"===E(e)}function g(e){return"string"==typeof e}function v(e){return"number"==typeof e}function y(e){return!0===e||!1===e||function(e){return x(e)&&null!==e}(e)&&"[object Boolean]"==E(e)}function x(e){return"object"==typeof e}function b(e){return null!=e}function w(e){return!e.trim().length}function E(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":Object.prototype.toString.call(e)}const S=Object.prototype.hasOwnProperty;class C{constructor(e){this._keys=[],this._keyMap={};let t=0;e.forEach((e=>{let n=A(e);this._keys.push(n),this._keyMap[n.id]=n,t+=n.weight})),this._keys.forEach((e=>{e.weight/=t}))}get(e){return this._keyMap[e]}keys(){return this._keys}toJSON(){return JSON.stringify(this._keys)}}function A(e){let t=null,n=null,r=null,o=1,i=null;if(g(e)||m(e))r=e,t=_(e),n=P(e);else{if(!S.call(e,"name"))throw new Error((e=>`Missing ${e} property in key`)("name"));const a=e.name;if(r=a,S.call(e,"weight")&&(o=e.weight,o<=0))throw new Error((e=>`Property 'weight' in key '${e}' must be a positive integer`)(a));t=_(a),n=P(a),i=e.getFn}return{path:t,id:n,weight:o,src:r,getFn:i}}function _(e){return m(e)?e:e.split(".")}function P(e){return m(e)?e.join("."):e}var k={isCaseSensitive:!1,ignoreDiacritics:!1,includeScore:!1,keys:[],shouldSort:!0,sortFn:(e,t)=>e.score===t.score?e.idx<t.idx?-1:1:e.score<t.score?-1:1,includeMatches:!1,findAllMatches:!1,minMatchCharLength:1,location:0,threshold:.6,distance:100,...{useExtendedSearch:!1,getFn:function(e,t){let n=[],r=!1;const o=(e,t,i)=>{if(b(e))if(t[i]){const a=e[t[i]];if(!b(a))return;if(i===t.length-1&&(g(a)||v(a)||y(a)))n.push(function(e){return null==e?"":function(e){if("string"==typeof e)return e;let t=e+"";return"0"==t&&1/e==-1/0?"-0":t}(e)}(a));else if(m(a)){r=!0;for(let e=0,n=a.length;e<n;e+=1)o(a[e],t,i+1)}else t.length&&o(a,t,i+1)}else n.push(e)};return o(e,g(t)?t.split("."):t,0),r?n:n[0]},ignoreLocation:!1,ignoreFieldNorm:!1,fieldNormWeight:1}};const N=/[^ ]+/g;class I{constructor({getFn:e=k.getFn,fieldNormWeight:t=k.fieldNormWeight}={}){this.norm=function(e=1,t=3){const n=new Map,r=Math.pow(10,t);return{get(t){const o=t.match(N).length;if(n.has(o))return n.get(o);const i=1/Math.pow(o,.5*e),a=parseFloat(Math.round(i*r)/r);return n.set(o,a),a},clear(){n.clear()}}}(t,3),this.getFn=e,this.isCreated=!1,this.setIndexRecords()}setSources(e=[]){this.docs=e}setIndexRecords(e=[]){this.records=e}setKeys(e=[]){this.keys=e,this._keysMap={},e.forEach(((e,t)=>{this._keysMap[e.id]=t}))}create(){!this.isCreated&&this.docs.length&&(this.isCreated=!0,g(this.docs[0])?this.docs.forEach(((e,t)=>{this._addString(e,t)})):this.docs.forEach(((e,t)=>{this._addObject(e,t)})),this.norm.clear())}add(e){const t=this.size();g(e)?this._addString(e,t):this._addObject(e,t)}removeAt(e){this.records.splice(e,1);for(let t=e,n=this.size();t<n;t+=1)this.records[t].i-=1}getValueForItemAtKeyId(e,t){return e[this._keysMap[t]]}size(){return this.records.length}_addString(e,t){if(!b(e)||w(e))return;let n={v:e,i:t,n:this.norm.get(e)};this.records.push(n)}_addObject(e,t){let n={i:t,$:{}};this.keys.forEach(((t,r)=>{let o=t.getFn?t.getFn(e):this.getFn(e,t.path);if(b(o))if(m(o)){let e=[];const t=[{nestedArrIndex:-1,value:o}];for(;t.length;){const{nestedArrIndex:n,value:r}=t.pop();if(b(r))if(g(r)&&!w(r)){let t={v:r,i:n,n:this.norm.get(r)};e.push(t)}else m(r)&&r.forEach(((e,n)=>{t.push({nestedArrIndex:n,value:e})}))}n.$[r]=e}else if(g(o)&&!w(o)){let e={v:o,n:this.norm.get(o)};n.$[r]=e}})),this.records.push(n)}toJSON(){return{keys:this.keys,records:this.records}}}function T(e,t,{getFn:n=k.getFn,fieldNormWeight:r=k.fieldNormWeight}={}){const o=new I({getFn:n,fieldNormWeight:r});return o.setKeys(e.map(A)),o.setSources(t),o.create(),o}function O(e,{errors:t=0,currentLocation:n=0,expectedLocation:r=0,distance:o=k.distance,ignoreLocation:i=k.ignoreLocation}={}){const a=t/e.length;if(i)return a;const s=Math.abs(r-n);return o?a+s/o:s?1:a}const D=32;function F(e,t,n,{location:r=k.location,distance:o=k.distance,threshold:i=k.threshold,findAllMatches:a=k.findAllMatches,minMatchCharLength:s=k.minMatchCharLength,includeMatches:c=k.includeMatches,ignoreLocation:l=k.ignoreLocation}={}){if(t.length>D)throw new Error(`Pattern length exceeds max of ${D}.`);const u=t.length,d=e.length,h=Math.max(0,Math.min(r,d));let p=i,f=h;const m=s>1||c,g=m?Array(d):[];let v;for(;(v=e.indexOf(t,f))>-1;){let e=O(t,{currentLocation:v,expectedLocation:h,distance:o,ignoreLocation:l});if(p=Math.min(e,p),f=v+u,m){let e=0;for(;e<u;)g[v+e]=1,e+=1}}f=-1;let y=[],x=1,b=u+d;const w=1<<u-1;for(let r=0;r<u;r+=1){let i=0,s=b;for(;i<s;){O(t,{errors:r,currentLocation:h+s,expectedLocation:h,distance:o,ignoreLocation:l})<=p?i=s:b=s,s=Math.floor((b-i)/2+i)}b=s;let c=Math.max(1,h-s+1),v=a?d:Math.min(h+s,d)+u,E=Array(v+2);E[v+1]=(1<<r)-1;for(let i=v;i>=c;i-=1){let a=i-1,s=n[e.charAt(a)];if(m&&(g[a]=+!!s),E[i]=(E[i+1]<<1|1)&s,r&&(E[i]|=(y[i+1]|y[i])<<1|1|y[i+1]),E[i]&w&&(x=O(t,{errors:r,currentLocation:a,expectedLocation:h,distance:o,ignoreLocation:l}),x<=p)){if(p=x,f=a,f<=h)break;c=Math.max(1,2*h-f)}}if(O(t,{errors:r+1,currentLocation:h,expectedLocation:h,distance:o,ignoreLocation:l})>p)break;y=E}const E={isMatch:f>=0,score:Math.max(.001,x)};if(m){const e=function(e=[],t=k.minMatchCharLength){let n=[],r=-1,o=-1,i=0;for(let a=e.length;i<a;i+=1){let a=e[i];a&&-1===r?r=i:a||-1===r||(o=i-1,o-r+1>=t&&n.push([r,o]),r=-1)}return e[i-1]&&i-r>=t&&n.push([r,i-1]),n}(g,s);e.length?c&&(E.indices=e):E.isMatch=!1}return E}function L(e){let t={};for(let n=0,r=e.length;n<r;n+=1){const o=e.charAt(n);t[o]=(t[o]||0)|1<<r-n-1}return t}const M=String.prototype.normalize?e=>e.normalize("NFD").replace(/[\u0300-\u036F\u0483-\u0489\u0591-\u05BD\u05BF\u05C1\u05C2\u05C4\u05C5\u05C7\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06DC\u06DF-\u06E4\u06E7\u06E8\u06EA-\u06ED\u0711\u0730-\u074A\u07A6-\u07B0\u07EB-\u07F3\u07FD\u0816-\u0819\u081B-\u0823\u0825-\u0827\u0829-\u082D\u0859-\u085B\u08D3-\u08E1\u08E3-\u0903\u093A-\u093C\u093E-\u094F\u0951-\u0957\u0962\u0963\u0981-\u0983\u09BC\u09BE-\u09C4\u09C7\u09C8\u09CB-\u09CD\u09D7\u09E2\u09E3\u09FE\u0A01-\u0A03\u0A3C\u0A3E-\u0A42\u0A47\u0A48\u0A4B-\u0A4D\u0A51\u0A70\u0A71\u0A75\u0A81-\u0A83\u0ABC\u0ABE-\u0AC5\u0AC7-\u0AC9\u0ACB-\u0ACD\u0AE2\u0AE3\u0AFA-\u0AFF\u0B01-\u0B03\u0B3C\u0B3E-\u0B44\u0B47\u0B48\u0B4B-\u0B4D\u0B56\u0B57\u0B62\u0B63\u0B82\u0BBE-\u0BC2\u0BC6-\u0BC8\u0BCA-\u0BCD\u0BD7\u0C00-\u0C04\u0C3E-\u0C44\u0C46-\u0C48\u0C4A-\u0C4D\u0C55\u0C56\u0C62\u0C63\u0C81-\u0C83\u0CBC\u0CBE-\u0CC4\u0CC6-\u0CC8\u0CCA-\u0CCD\u0CD5\u0CD6\u0CE2\u0CE3\u0D00-\u0D03\u0D3B\u0D3C\u0D3E-\u0D44\u0D46-\u0D48\u0D4A-\u0D4D\u0D57\u0D62\u0D63\u0D82\u0D83\u0DCA\u0DCF-\u0DD4\u0DD6\u0DD8-\u0DDF\u0DF2\u0DF3\u0E31\u0E34-\u0E3A\u0E47-\u0E4E\u0EB1\u0EB4-\u0EB9\u0EBB\u0EBC\u0EC8-\u0ECD\u0F18\u0F19\u0F35\u0F37\u0F39\u0F3E\u0F3F\u0F71-\u0F84\u0F86\u0F87\u0F8D-\u0F97\u0F99-\u0FBC\u0FC6\u102B-\u103E\u1056-\u1059\u105E-\u1060\u1062-\u1064\u1067-\u106D\u1071-\u1074\u1082-\u108D\u108F\u109A-\u109D\u135D-\u135F\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17B4-\u17D3\u17DD\u180B-\u180D\u1885\u1886\u18A9\u1920-\u192B\u1930-\u193B\u1A17-\u1A1B\u1A55-\u1A5E\u1A60-\u1A7C\u1A7F\u1AB0-\u1ABE\u1B00-\u1B04\u1B34-\u1B44\u1B6B-\u1B73\u1B80-\u1B82\u1BA1-\u1BAD\u1BE6-\u1BF3\u1C24-\u1C37\u1CD0-\u1CD2\u1CD4-\u1CE8\u1CED\u1CF2-\u1CF4\u1CF7-\u1CF9\u1DC0-\u1DF9\u1DFB-\u1DFF\u20D0-\u20F0\u2CEF-\u2CF1\u2D7F\u2DE0-\u2DFF\u302A-\u302F\u3099\u309A\uA66F-\uA672\uA674-\uA67D\uA69E\uA69F\uA6F0\uA6F1\uA802\uA806\uA80B\uA823-\uA827\uA880\uA881\uA8B4-\uA8C5\uA8E0-\uA8F1\uA8FF\uA926-\uA92D\uA947-\uA953\uA980-\uA983\uA9B3-\uA9C0\uA9E5\uAA29-\uAA36\uAA43\uAA4C\uAA4D\uAA7B-\uAA7D\uAAB0\uAAB2-\uAAB4\uAAB7\uAAB8\uAABE\uAABF\uAAC1\uAAEB-\uAAEF\uAAF5\uAAF6\uABE3-\uABEA\uABEC\uABED\uFB1E\uFE00-\uFE0F\uFE20-\uFE2F]/g,""):e=>e;class j{constructor(e,{location:t=k.location,threshold:n=k.threshold,distance:r=k.distance,includeMatches:o=k.includeMatches,findAllMatches:i=k.findAllMatches,minMatchCharLength:a=k.minMatchCharLength,isCaseSensitive:s=k.isCaseSensitive,ignoreDiacritics:c=k.ignoreDiacritics,ignoreLocation:l=k.ignoreLocation}={}){if(this.options={location:t,threshold:n,distance:r,includeMatches:o,findAllMatches:i,minMatchCharLength:a,isCaseSensitive:s,ignoreDiacritics:c,ignoreLocation:l},e=s?e:e.toLowerCase(),e=c?M(e):e,this.pattern=e,this.chunks=[],!this.pattern.length)return;const u=(e,t)=>{this.chunks.push({pattern:e,alphabet:L(e),startIndex:t})},d=this.pattern.length;if(d>D){let e=0;const t=d%D,n=d-t;for(;e<n;)u(this.pattern.substr(e,D),e),e+=D;if(t){const e=d-D;u(this.pattern.substr(e),e)}}else u(this.pattern,0)}searchIn(e){const{isCaseSensitive:t,ignoreDiacritics:n,includeMatches:r}=this.options;if(e=t?e:e.toLowerCase(),e=n?M(e):e,this.pattern===e){let t={isMatch:!0,score:0};return r&&(t.indices=[[0,e.length-1]]),t}const{location:o,distance:i,threshold:a,findAllMatches:s,minMatchCharLength:c,ignoreLocation:l}=this.options;let u=[],d=0,h=!1;this.chunks.forEach((({pattern:t,alphabet:n,startIndex:p})=>{const{isMatch:f,score:m,indices:g}=F(e,t,n,{location:o+p,distance:i,threshold:a,findAllMatches:s,minMatchCharLength:c,includeMatches:r,ignoreLocation:l});f&&(h=!0),d+=m,f&&g&&(u=[...u,...g])}));let p={isMatch:h,score:h?d/this.chunks.length:1};return h&&r&&(p.indices=u),p}}class B{constructor(e){this.pattern=e}static isMultiMatch(e){return R(e,this.multiRegex)}static isSingleMatch(e){return R(e,this.singleRegex)}search(){}}function R(e,t){const n=e.match(t);return n?n[1]:null}class V extends B{constructor(e,{location:t=k.location,threshold:n=k.threshold,distance:r=k.distance,includeMatches:o=k.includeMatches,findAllMatches:i=k.findAllMatches,minMatchCharLength:a=k.minMatchCharLength,isCaseSensitive:s=k.isCaseSensitive,ignoreDiacritics:c=k.ignoreDiacritics,ignoreLocation:l=k.ignoreLocation}={}){super(e),this._bitapSearch=new j(e,{location:t,threshold:n,distance:r,includeMatches:o,findAllMatches:i,minMatchCharLength:a,isCaseSensitive:s,ignoreDiacritics:c,ignoreLocation:l})}static get type(){return"fuzzy"}static get multiRegex(){return/^"(.*)"$/}static get singleRegex(){return/^(.*)$/}search(e){return this._bitapSearch.searchIn(e)}}class q extends B{constructor(e){super(e)}static get type(){return"include"}static get multiRegex(){return/^'"(.*)"$/}static get singleRegex(){return/^'(.*)$/}search(e){let t,n=0;const r=[],o=this.pattern.length;for(;(t=e.indexOf(this.pattern,n))>-1;)n=t+o,r.push([t,n-1]);const i=!!r.length;return{isMatch:i,score:i?0:1,indices:r}}}const W=[class extends B{constructor(e){super(e)}static get type(){return"exact"}static get multiRegex(){return/^="(.*)"$/}static get singleRegex(){return/^=(.*)$/}search(e){const t=e===this.pattern;return{isMatch:t,score:t?0:1,indices:[0,this.pattern.length-1]}}},q,class extends B{constructor(e){super(e)}static get type(){return"prefix-exact"}static get multiRegex(){return/^\^"(.*)"$/}static get singleRegex(){return/^\^(.*)$/}search(e){const t=e.startsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,this.pattern.length-1]}}},class extends B{constructor(e){super(e)}static get type(){return"inverse-prefix-exact"}static get multiRegex(){return/^!\^"(.*)"$/}static get singleRegex(){return/^!\^(.*)$/}search(e){const t=!e.startsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,e.length-1]}}},class extends B{constructor(e){super(e)}static get type(){return"inverse-suffix-exact"}static get multiRegex(){return/^!"(.*)"\$$/}static get singleRegex(){return/^!(.*)\$$/}search(e){const t=!e.endsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,e.length-1]}}},class extends B{constructor(e){super(e)}static get type(){return"suffix-exact"}static get multiRegex(){return/^"(.*)"\$$/}static get singleRegex(){return/^(.*)\$$/}search(e){const t=e.endsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[e.length-this.pattern.length,e.length-1]}}},class extends B{constructor(e){super(e)}static get type(){return"inverse-exact"}static get multiRegex(){return/^!"(.*)"$/}static get singleRegex(){return/^!(.*)$/}search(e){const t=-1===e.indexOf(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,e.length-1]}}},V],G=W.length,U=/ +(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/;const H=new Set([V.type,q.type]);class X{constructor(e,{isCaseSensitive:t=k.isCaseSensitive,ignoreDiacritics:n=k.ignoreDiacritics,includeMatches:r=k.includeMatches,minMatchCharLength:o=k.minMatchCharLength,ignoreLocation:i=k.ignoreLocation,findAllMatches:a=k.findAllMatches,location:s=k.location,threshold:c=k.threshold,distance:l=k.distance}={}){this.query=null,this.options={isCaseSensitive:t,ignoreDiacritics:n,includeMatches:r,minMatchCharLength:o,findAllMatches:a,ignoreLocation:i,location:s,threshold:c,distance:l},e=t?e:e.toLowerCase(),e=n?M(e):e,this.pattern=e,this.query=function(e,t={}){return e.split("|").map((e=>{let n=e.trim().split(U).filter((e=>e&&!!e.trim())),r=[];for(let e=0,o=n.length;e<o;e+=1){const o=n[e];let i=!1,a=-1;for(;!i&&++a<G;){const e=W[a];let n=e.isMultiMatch(o);n&&(r.push(new e(n,t)),i=!0)}if(!i)for(a=-1;++a<G;){const e=W[a];let n=e.isSingleMatch(o);if(n){r.push(new e(n,t));break}}}return r}))}(this.pattern,this.options)}static condition(e,t){return t.useExtendedSearch}searchIn(e){const t=this.query;if(!t)return{isMatch:!1,score:1};const{includeMatches:n,isCaseSensitive:r,ignoreDiacritics:o}=this.options;e=r?e:e.toLowerCase(),e=o?M(e):e;let i=0,a=[],s=0;for(let r=0,o=t.length;r<o;r+=1){const o=t[r];a.length=0,i=0;for(let t=0,r=o.length;t<r;t+=1){const r=o[t],{isMatch:c,indices:l,score:u}=r.search(e);if(!c){s=0,i=0,a.length=0;break}if(i+=1,s+=u,n){const e=r.constructor.type;H.has(e)?a=[...a,...l]:a.push(l)}}if(i){let e={isMatch:!0,score:s/i};return n&&(e.indices=a),e}}return{isMatch:!1,score:1}}}const Y=[];function J(e,t){for(let n=0,r=Y.length;n<r;n+=1){let r=Y[n];if(r.condition(e,t))return new r(e,t)}return new j(e,t)}const z="$and",K="$or",Z="$path",Q="$val",ee=e=>!(!e[z]&&!e[K]),te=e=>({[z]:Object.keys(e).map((t=>({[t]:e[t]})))});function ne(e,t,{auto:n=!0}={}){const r=e=>{let o=Object.keys(e);const i=(e=>!!e[Z])(e);if(!i&&o.length>1&&!ee(e))return r(te(e));if((e=>!m(e)&&x(e)&&!ee(e))(e)){const r=i?e[Z]:o[0],a=i?e[Q]:e[r];if(!g(a))throw new Error((e=>`Invalid value for key ${e}`)(r));const s={keyId:P(r),pattern:a};return n&&(s.searcher=J(a,t)),s}let a={children:[],operator:o[0]};return o.forEach((t=>{const n=e[t];m(n)&&n.forEach((e=>{a.children.push(r(e))}))})),a};return ee(e)||(e=te(e)),r(e)}function re(e,t){const n=e.matches;t.matches=[],b(n)&&n.forEach((e=>{if(!b(e.indices)||!e.indices.length)return;const{indices:n,value:r}=e;let o={indices:n,value:r};e.key&&(o.key=e.key.src),e.idx>-1&&(o.refIndex=e.idx),t.matches.push(o)}))}function oe(e,t){t.score=e.score}class ie{constructor(e,t={},n){this.options={...k,...t},this.options.useExtendedSearch,this._keyStore=new C(this.options.keys),this.setCollection(e,n)}setCollection(e,t){if(this._docs=e,t&&!(t instanceof I))throw new Error("Incorrect 'index' type");this._myIndex=t||T(this.options.keys,this._docs,{getFn:this.options.getFn,fieldNormWeight:this.options.fieldNormWeight})}add(e){b(e)&&(this._docs.push(e),this._myIndex.add(e))}remove(e=()=>!1){const t=[];for(let n=0,r=this._docs.length;n<r;n+=1){const o=this._docs[n];e(o,n)&&(this.removeAt(n),n-=1,r-=1,t.push(o))}return t}removeAt(e){this._docs.splice(e,1),this._myIndex.removeAt(e)}getIndex(){return this._myIndex}search(e,{limit:t=-1}={}){const{includeMatches:n,includeScore:r,shouldSort:o,sortFn:i,ignoreFieldNorm:a}=this.options;let s=g(e)?g(this._docs[0])?this._searchStringList(e):this._searchObjectList(e):this._searchLogical(e);return function(e,{ignoreFieldNorm:t=k.ignoreFieldNorm}){e.forEach((e=>{let n=1;e.matches.forEach((({key:e,norm:r,score:o})=>{const i=e?e.weight:null;n*=Math.pow(0===o&&i?Number.EPSILON:o,(i||1)*(t?1:r))})),e.score=n}))}(s,{ignoreFieldNorm:a}),o&&s.sort(i),v(t)&&t>-1&&(s=s.slice(0,t)),function(e,t,{includeMatches:n=k.includeMatches,includeScore:r=k.includeScore}={}){const o=[];return n&&o.push(re),r&&o.push(oe),e.map((e=>{const{idx:n}=e,r={item:t[n],refIndex:n};return o.length&&o.forEach((t=>{t(e,r)})),r}))}(s,this._docs,{includeMatches:n,includeScore:r})}_searchStringList(e){const t=J(e,this.options),{records:n}=this._myIndex,r=[];return n.forEach((({v:e,i:n,n:o})=>{if(!b(e))return;const{isMatch:i,score:a,indices:s}=t.searchIn(e);i&&r.push({item:e,idx:n,matches:[{score:a,value:e,norm:o,indices:s}]})})),r}_searchLogical(e){const t=ne(e,this.options),n=(e,t,r)=>{if(!e.children){const{keyId:n,searcher:o}=e,i=this._findMatches({key:this._keyStore.get(n),value:this._myIndex.getValueForItemAtKeyId(t,n),searcher:o});return i&&i.length?[{idx:r,item:t,matches:i}]:[]}const o=[];for(let i=0,a=e.children.length;i<a;i+=1){const a=e.children[i],s=n(a,t,r);if(s.length)o.push(...s);else if(e.operator===z)return[]}return o},r=this._myIndex.records,o={},i=[];return r.forEach((({$:e,i:r})=>{if(b(e)){let a=n(t,e,r);a.length&&(o[r]||(o[r]={idx:r,item:e,matches:[]},i.push(o[r])),a.forEach((({matches:e})=>{o[r].matches.push(...e)})))}})),i}_searchObjectList(e){const t=J(e,this.options),{keys:n,records:r}=this._myIndex,o=[];return r.forEach((({$:e,i:r})=>{if(!b(e))return;let i=[];n.forEach(((n,r)=>{i.push(...this._findMatches({key:n,value:e[r],searcher:t}))})),i.length&&o.push({idx:r,item:e,matches:i})})),o}_findMatches({key:e,value:t,searcher:n}){if(!b(t))return[];let r=[];if(m(t))t.forEach((({v:t,i:o,n:i})=>{if(!b(t))return;const{isMatch:a,score:s,indices:c}=n.searchIn(t);a&&r.push({score:s,key:e,value:t,idx:o,norm:i,indices:c})}));else{const{v:o,n:i}=t,{isMatch:a,score:s,indices:c}=n.searchIn(o);a&&r.push({score:s,key:e,value:o,norm:i,indices:c})}return r}}function ae(e,t={}){const n="string"==typeof e?document.querySelector(e):e;if(!n)throw new Error(`Could not find container: ${e}`);const r=t.placeholderText||"Select items...",o=t.closeOnSelect??!1,i=t.enableSearch??!1,a=t.multiple??!0,s=t.searchPlaceholderText||"Search...",c=t.searchNoResultsText||"No results found",l=t.searchDebounceMs??200;let u=[...t.initialList||[]];n.innerHTML="",n.classList.add("fancy-dropdown-container"),Object.assign(n.style,{position:"relative",userSelect:"none"});const d=document.createElement("div");d.className="fancy-dropdown-trigger",Object.assign(d.style,{padding:"8px 12px",border:"1px solid var(--border-color)",backgroundColor:"var(--bg-color)",color:"var(--text-color)",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"space-between"});const h=document.createElement("span");h.className="fancy-dropdown-trigger-text",h.textContent=r;const p=document.createElement("i");p.className="fas fa-chevron-down",p.style.marginLeft="8px",d.append(h,p),n.append(d);const f=document.createElement("div");f.className="fancy-dropdown-list",Object.assign(f.style,{position:"absolute",top:"100%",left:"0",right:"0",maxHeight:"300px",display:"none",zIndex:"1050",border:"1px solid var(--border-color)",borderTop:"none",backgroundColor:"var(--bg-color-popup, var(--bg-color-secondary, var(--greyCAIbg, var(--grey30))))",color:"var(--text-color)",borderRadius:"0 0 4px 4px",boxShadow:"0 4px 8px var(--black50a)",overflowY:"auto"}),n.append(f);let m=null,g=null,v=null,y=null;i&&(g=document.createElement("div"),g.className="fancy-dropdown-search-wrapper",Object.assign(g.style,{padding:"8px",borderBottom:"1px solid var(--border-color)",position:"sticky",top:"0",backgroundColor:"inherit"}),m=document.createElement("input"),m.type="text",m.className="fancy-dropdown-search-input",m.placeholder=s,Object.assign(m.style,{width:"100%",padding:"6px 10px",border:"1px solid var(--border-color)",borderRadius:"3px",boxSizing:"border-box",backgroundColor:"var(--bg-color)",color:"var(--text-color)"}),m.addEventListener("click",(e=>e.stopPropagation())),g.append(m),f.append(g),v=document.createElement("div"),v.className="fancy-dropdown-no-results",v.textContent=c,Object.assign(v.style,{padding:"8px 12px",textAlign:"center",color:"var(--text-color-secondary, var(--grey50))",display:"none"}),f.append(v));let x=!1,b=null;const w=e=>"string"==typeof e?e:e.label,E=e=>"string"==typeof e?e:e.value;let S=(t.initialValues||[]).filter((e=>u.some((t=>E(t)===e))));const C=()=>{if(!i)return;const e={includeScore:!1,threshold:.4,isCaseSensitive:!1,findAllMatches:!0,...t.searchFuseOptions||{},keys:t.searchFuseOptions?.keys||[{name:"label",weight:.7},{name:"value",weight:.3}]},n=u.map((e=>"string"==typeof e?{value:e,label:e}:e));!t.searchFuseOptions?.keys&&u.every((e=>"string"==typeof e))&&(e.keys=["label"]),b=new ie(n,e)},A=e=>{let t=!1;f.querySelectorAll(".fancy-dropdown-item").forEach((n=>{const r=n.dataset.value,o=S.includes(r),i=n.querySelector(".checkmark");o?(n.classList.add("selected"),i&&(i.style.display="inline-block")):(n.classList.remove("selected"),i&&(i.style.display="none")),void 0!==e?e.includes(r)?(n.style.display="flex",t=!0):n.style.display="none":(n.style.display="flex",t=!0)})),i&&v&&(v.style.display=void 0===e||t?"none":"block"),(()=>{if(0===S.length)h.textContent=r;else if(1===S.length){const e=S[0],t=u.find((t=>E(t)===e)),n=t?w(t):e;h.textContent=n}else h.textContent=`${S.length} items selected`})()},_=e=>{if(!i||!b)return void A();const t=e.trim();if(""===t)return void A(void 0);const n=b.search(t).map((e=>e.item.value));A(n)},P=()=>{m&&(y&&clearTimeout(y),y=window.setTimeout((()=>{m&&_(m.value)}),l))},k=()=>{x||(x=!0,f.style.display="block",p.classList.remove("fa-chevron-down"),p.classList.add("fa-chevron-up"),i&&m&&setTimeout((()=>m?.focus()),50))},N=()=>{x&&(x=!1,f.style.display="none",i&&m&&(m.value="",_("")),p.classList.remove("fa-chevron-up"),p.classList.add("fa-chevron-down"),y&&clearTimeout(y))};d.addEventListener("click",(e=>{e.stopPropagation(),x?N():k()})),document.addEventListener("click",(e=>{x&&n&&!n.contains(e.target)&&N()})),i&&m&&m.addEventListener("input",P);const I=(e,n)=>{const r=E(e),s=w(e),c=document.createElement("div");c.className="fancy-dropdown-item",c.dataset.value=r,Object.assign(c.style,{padding:"8px 12px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"space-between"}),c.addEventListener("mouseenter",(()=>{c.style.backgroundColor="var(--hover-color, var(--white20a))"})),c.addEventListener("mouseleave",(()=>{c.style.backgroundColor=""}));const l=document.createElement("span");l.textContent=s,c.append(l);const u=document.createElement("i");return u.className="checkmark fa-solid fa-check",Object.assign(u.style,{marginLeft:"8px",display:n?"inline-block":"none"}),c.append(u),c.addEventListener("click",(function(e){e.stopPropagation();const n=e.currentTarget.dataset.value,r=[...S];let s;s=a?S.includes(n)?S.filter((e=>e!==n)):[...S,n]:S.includes(n)?[]:[n];(async()=>{if(t.onBeforeSelection)try{if(!await Promise.resolve(t.onBeforeSelection(r,s)))return!1}catch(e){return console.error("onBeforeSelection callback failed:",e),!1}return!0})().then((e=>{e&&(S=s,i&&m&&""!==m.value.trim()?_(m.value):A(void 0),t.onSelectChange&&Promise.resolve(t.onSelectChange(r,S)).catch((e=>console.error("onSelectChange callback failed:",e))),o&&N())}))})),v?f.insertBefore(c,v):f.append(c),c};u.length>0&&u.forEach((e=>{const t=E(e);I(e,S.includes(t))})),C(),A();return{container:n,dropdownTrigger:d,dropdownList:f,getValues:()=>[...S],setValues:e=>{const n=[...S],r=e.filter((e=>u.some((t=>E(t)===e))));S=[...r],i&&m&&""!==m.value?(m.value="",_("")):A();JSON.stringify(n.sort())!==JSON.stringify(S.sort())&&t.onSelectChange&&Promise.resolve(t.onSelectChange(n,S)).catch((e=>console.error("onSelectChange callback failed:",e)))},getOptions:()=>u.map((e=>"string"==typeof e?{value:e,label:e}:e)),addOption:(e,n=!1)=>{const r=E(e);if(u.some((e=>E(e)===r)))return;u.push(e),I(e,n),C();let o=!1;const s=[...S];n&&!S.includes(r)?(a?S.push(r):S=[r],o=!0):n&&!a&&S.length>0&&S[0]!==r&&(S=[r],o=!0),i&&m&&""!==m.value?_(m.value):A(),o&&t.onSelectChange&&Promise.resolve(t.onSelectChange(s,S)).catch((e=>console.error("onSelectChange callback failed:",e)))},removeOption:e=>{const n=u.length;if(u=u.filter((t=>E(t)!==e)),u.length===n)return;let r=!1;const o=[...S],a=S.indexOf(e);a>-1&&(S.splice(a,1),r=!0);const s=f.querySelector(`.fancy-dropdown-item[data-value="${e}"]`);s?.remove(),C(),i&&m&&""!==m.value?_(m.value):A(),r&&t.onSelectChange&&Promise.resolve(t.onSelectChange(o,S)).catch((e=>console.error("onSelectChange callback failed:",e)))},selectAll:()=>{if(!a)return;const e=[...S],n=u.map(E);S=[...new Set([...S,...n])];const r=JSON.stringify(e.sort())!==JSON.stringify(S.sort());i&&m&&""!==m.value?_(m.value):A(),r&&t.onSelectChange&&Promise.resolve(t.onSelectChange(e,S)).catch((e=>console.error("onSelectChange callback failed:",e)))},deselectAll:()=>{const e=[...S];S.length>0&&(S=[],i&&m&&""!==m.value?_(m.value):A(),t.onSelectChange&&Promise.resolve(t.onSelectChange(e,S)).catch((e=>console.error("onSelectChange callback failed:",e))))},disable:()=>{n.style.pointerEvents="none",n.style.opacity="0.6",x&&N()},enable:()=>{n.style.pointerEvents="auto",n.style.opacity="1"},open:k,close:N,toggle:()=>x?N():k()}}ie.version="7.1.0",ie.createIndex=T,ie.parseIndex=function(e,{getFn:t=k.getFn,fieldNormWeight:n=k.fieldNormWeight}={}){const{keys:r,records:o}=e,i=new I({getFn:t,fieldNormWeight:n});return i.setKeys(r),i.setIndexRecords(o),i},ie.config=k,ie.parseQuery=ne,function(...e){Y.push(...e)}(X);const se=(e=>{var t={};return h.d(t,e),t})({persona_description_positions:()=>e.persona_description_positions,renderStoryString:()=>e.renderStoryString});const ce=(e=>{var t={};return h.d(t,e),t})({baseChatReplace:()=>t.baseChatReplace,chat_metadata:()=>t.chat_metadata,depth_prompt_depth_default:()=>t.depth_prompt_depth_default,depth_prompt_role_default:()=>t.depth_prompt_role_default,extension_prompt_types:()=>t.extension_prompt_types,getMaxContextSize:()=>t.getMaxContextSize,name1:()=>t.name1,name2:()=>t.name2,parseMesExamples:()=>t.parseMesExamples,this_chid:()=>t.this_chid});const le=(e=>{var t={};return h.d(t,e),t})({createWorldInfoEntry:()=>n.createWorldInfoEntry,wi_anchor_position:()=>n.wi_anchor_position,world_info_include_names:()=>n.world_info_include_names,world_names:()=>n.world_names});const ue=(e=>{var t={};return h.d(t,e),t})({formatInstructModeExamples:()=>r.formatInstructModeExamples,formatInstructModeSystemPrompt:()=>r.formatInstructModeSystemPrompt});const de=(e=>{var t={};return h.d(t,e),t})({appendFileContent:()=>o.appendFileContent});const he=(e=>{var t={};return h.d(t,e),t})({formatWorldInfo:()=>i.formatWorldInfo,getPromptPosition:()=>i.getPromptPosition,getPromptRole:()=>i.getPromptRole,prepareOpenAIMessages:()=>i.prepareOpenAIMessages,setOpenAIMessageExamples:()=>i.setOpenAIMessageExamples,setOpenAIMessages:()=>i.setOpenAIMessages});const pe=(e=>{var t={};return h.d(t,e),t})({metadata_keys:()=>a.metadata_keys});const fe=(e=>{var t={};return h.d(t,e),t})({getGroupDepthPrompts:()=>s.getGroupDepthPrompts,selected_group:()=>s.selected_group});const me=(e=>{var t={};return h.d(t,e),t})({getRegexedString:()=>c.getRegexedString,regex_placement:()=>c.regex_placement});(e=>{var t={};h.d(t,e)})({});(e=>{var t={};h.d(t,e)})({});async function ge(e,t,{escapeHtml:n=!0}={}){await async function(e,...t){await SillyTavern.getContext().SlashCommandParser.commands[e].callback(...t)}("echo",{severity:e,escapeHtml:Boolean(n).toString()},t)}function ve(e){return(0,ce.getMaxContextSize)(e)}function ye(e,t){return(0,ce.parseMesExamples)(e,t)}function xe(e,t,n){return(0,ce.baseChatReplace)(e,t,n)}function be(e){return(0,he.getPromptRole)(e)}function we(e,{wiFormat:t}={}){return(0,he.formatWorldInfo)(e,{wiFormat:t})}function Ee(e){return(0,he.getPromptPosition)(e)}function Se(e,t={}){const n=SillyTavern.getContext(),r=t.readOnlyValues||[],o=document.querySelector(e);if(!o)throw new Error(`Could not find preset select: ${e}`);const i=t.label||"preset",a=document.createElement("div");a.className="preset-select-container",a.style.display="flex",a.style.alignItems="center";const s=e=>r.includes(e);if(o.parentNode?.insertBefore(a,o),a.appendChild(o),t.initialList&&t.initialList.length>0){o.innerHTML="";for(const e of t.initialList){const t=document.createElement("option");t.value=e,t.textContent=e,s(e)&&(t.dataset.readonly="true"),o.appendChild(t)}}if(t.initialValue){const e=Array.from(o.options).find((e=>e.value===t.initialValue||e.textContent===t.initialValue));e&&(o.value=e.value)}let c=o.value;if(o.addEventListener("change",(async()=>{const e=o.value;t.onSelectChange&&c!==e&&await t.onSelectChange(c,e),c=e})),t.create){const e=document.createElement("i");e.className="menu_button fa-solid fa-file-circle-plus",e.title=`Create a new ${i}`,e.setAttribute("data-i18n",`[title]Create a new ${i}`),e.addEventListener("click",(async()=>{t.create?.onPopupOpen&&await t.create.onPopupOpen();const e=await n.Popup.show.input(`Create a new ${i}`,`Please enter a name for the new ${i}:`,"");if(null===e||""===e.trim())return;const r=e.trim();if(Array.from(o.options).some((e=>e.textContent===r)))return void await ge("warning",`A ${i} with this name already exists.`);if(t.create?.onBeforeCreate){if(!await t.create.onBeforeCreate(r))return}const a=document.createElement("option");a.value=r,a.textContent=r,o.appendChild(a);const s=o.value;o.value=r,t.create?.onAfterCreate&&await t.create.onAfterCreate(r),t.onSelectChange&&s!==r&&await t.onSelectChange(s,r),c=r})),a.appendChild(e)}if(t.rename){const e=document.createElement("i");e.className="menu_button fa-solid fa-pencil",e.title=`Rename a ${i}`,e.setAttribute("data-i18n",`[title]Rename a ${i}`),e.addEventListener("click",(async()=>{if(-1===o.selectedIndex)return void await ge("warning",`Please select a ${i} to rename.`);const e=o.options[o.selectedIndex];let r=e.value;if(s(r))return void await ge("warning",`This ${i} cannot be renamed as it is read-only.`);t.rename?.onPopupOpen&&await t.rename.onPopupOpen();const a=await n.Popup.show.input(`Rename ${i}`,`Please enter a new name for "${r}":`,r);if(null===a||""===a.trim()||a===r)return;const l=a.trim();if(Array.from(o.options).some((t=>t.textContent===l&&t!==e)))await ge("warning",`A ${i} with this name already exists.`);else{if(t.rename?.onBeforeRename){if(!await t.rename.onBeforeRename(r,l))return}e.value=l,e.textContent=l,r===c&&(c=l),t.rename?.onAfterRename&&await t.rename.onAfterRename(r,l),t.onSelectChange&&o.value===l&&await t.onSelectChange(r,l)}})),a.appendChild(e)}if(t.delete){const e=document.createElement("i");e.className="menu_button fa-solid fa-trash-can",e.title=`Delete a ${i}`,e.setAttribute("data-i18n",`[title]Delete a ${i}`),e.addEventListener("click",(async()=>{if(-1===o.selectedIndex)return void await ge("warning",`Please select a ${i} to delete.`);const e=o.options[o.selectedIndex],r=e.value,a=o.selectedIndex;if(s(r))return void await ge("warning",`This ${i} cannot be deleted as it is read-only.`);t.delete?.onPopupOpen&&await t.delete.onPopupOpen();if(!await n.Popup.show.confirm(`Are you sure you want to delete "${r}"?`,`Delete ${i}`))return;if(t.delete?.onBeforeDelete){if(!await t.delete.onBeforeDelete(r))return}const l=r;let u,d=-1;o.options.length>1&&(d=a<o.options.length-1?a:a-1,u=o.options[d].value),o.removeChild(e),d>=0?(o.selectedIndex=d,c=u,t.onSelectChange&&await t.onSelectChange(l,u)):(t.onSelectChange&&await t.onSelectChange(l,void 0),c=void 0),t.delete?.onAfterDelete&&await t.delete.onAfterDelete(l)})),a.appendChild(e)}return{select:o,container:a}}async function Ce(e,{targetCharacterId:t,presetName:n,instructName:r,contextName:o,syspromptName:i,maxContext:a,includeNames:s,ignoreCharacterFields:c,ignoreAuthorNote:l,ignoreWorldInfo:u,messageIndexesBetween:d}={}){if(!["textgenerationwebui","openai"].includes(e))throw new Error("Unsupported API");const h=SillyTavern.getContext();let p=[],{description:f,personality:m,persona:g,scenario:v,mesExamples:y,system:x,jailbreak:b}=c?{description:"",personality:"",persona:"",scenario:"",mesExamples:"",system:"",jailbreak:""}:h.getCharacterCardFields({chid:t});const w="textgenerationwebui"===e?h.getPresetManager("instruct")?.getCompletionPresetByName(r):void 0,E=!!w?.enabled;let S=ye(y,E);const C=function(){if("number"==typeof a)return a;if(!a)return ve();if("active"===a||!n)return ve();if("number"==typeof a)return a;let t;if("textgenerationwebui"===e){const e=h.getPresetManager("textgenerationwebui")?.getCompletionPresetByName(n);t=e?.max_length}else{const e=h.getPresetManager("openai")?.getCompletionPresetByName(n);t=e?.openai_max_context}return"number"==typeof t?t:ve()}();if(C<=0)return[];const A=h.ToolManager.isToolCallingSupported(),_=d?.start??0,P=d?.end?d.end+1:void 0;let k=-1===_&&0===P?[]:h.chat.slice(_,P).filter((e=>!e.is_system||A&&Array.isArray(e.extra?.tool_invocations)));k=await Promise.all(k.map((async(e,t)=>{let n=function(e,t,{characterOverride:n,isMarkdown:r,isPrompt:o,isEdit:i,depth:a}){return(0,me.getRegexedString)(e,t,{characterOverride:n,isMarkdown:r,isPrompt:o,isEdit:i,depth:a})}(e.mes,e.is_user?me.regex_placement.USER_INPUT:me.regex_placement.AI_OUTPUT,{isPrompt:!0,depth:k.length-t-1});return n=await async function(e,t){return await(0,de.appendFileContent)(e,t)}(e,n),e?.extra?.append_title&&e?.extra?.title&&(n=`${n}\n\n${e.extra.title}`),{...e,mes:n,index:t}})));const N=k.map((e=>le.world_info_include_names?`${e.name}: ${e.mes}`:e.mes)).reverse(),{worldInfoString:I,worldInfoBefore:T,worldInfoAfter:O,worldInfoExamples:D,worldInfoDepth:F,anBefore:L,anAfter:M}=u?{worldInfoString:"",worldInfoBefore:"",worldInfoAfter:"",worldInfoExamples:[],worldInfoDepth:[],anBefore:[],anAfter:[]}:await h.getWorldInfoPrompt(N,C,!1);for(const U of D){const H=U.content;if(0===H.length)continue;const X=ye(xe(H,ce.name1,ce.name2),E);U.position===le.wi_anchor_position.before?S.unshift(...X):S.push(...X)}function j(){let e=0;const t=[];for(let n=k.length-1;n>=0;n--){const r=k[n];if(r.extra?.token_count&&e+r.extra.token_count>C)break;e+=r.extra?.token_count||0,t.unshift({role:r.is_user?"user":"assistant",content:s?`${r.name}: ${r.mes}`:r.mes})}p.push(...t)}if("textgenerationwebui"===e){const Y=[...S];S&&(S=function(e,t,n){return(0,ue.formatInstructModeExamples)(e,t,n)}(S,ce.name1,ce.name2));const J=h.getPresetManager("sysprompt")?.getCompletionPresetByName(i);J&&(x=h.powerUserSettings.prefer_character_prompt&&x?x:xe(J.content,ce.name1,ce.name2),x=E?($=h.substituteParams(x,ce.name1,ce.name2,J.content),R=w,(0,ue.formatInstructModeSystemPrompt)($,R)):x);const z={description:f,personality:m,persona:h.powerUserSettings.persona_description_position==se.persona_description_positions.IN_PROMPT?g:"",scenario:v,system:x,char:ce.name2,user:ce.name1,wiBefore:T,wiAfter:O,loreBefore:T,loreAfter:O,mesExamples:S.join(""),mesExamplesRaw:Y.join("")},K=h.getPresetManager("context")?.getCompletionPresetByName(o);let Z=function(e,{customStoryString:t,customInstructSettings:n}={}){return(0,se.renderStoryString)(e,{customStoryString:t,customInstructSettings:n})}(z,{customInstructSettings:w,customStoryString:K?.story_string});p.push({role:"system",content:Z,ignoreInstruct:!0}),j()}else{let Q=(B=k,(0,he.setOpenAIMessages)(B)),ee=function(e){return(0,he.setOpenAIMessageExamples)(e)}(S);async function te(){let[e,t]=await function({name2:e,charDescription:t,charPersonality:n,Scenario:r,worldInfoBefore:o,worldInfoAfter:i,bias:a,type:s,quietPrompt:c,quietImage:l,extensionPrompts:u,cyclePrompt:d,systemPromptOverride:h,jailbreakPromptOverride:p,personaDescription:f,messages:m,messageExamples:g},v){return(0,he.prepareOpenAIMessages)({name2:e,charDescription:t,charPersonality:n,Scenario:r,worldInfoBefore:o,worldInfoAfter:i,bias:a,type:s,quietPrompt:c,quietImage:l,cyclePrompt:d,systemPromptOverride:h,jailbreakPromptOverride:p,personaDescription:f,extensionPrompts:u,messages:m,messageExamples:g},v)}({name2:ce.name2,charDescription:f,charPersonality:m,Scenario:v,worldInfoBefore:T,worldInfoAfter:O,extensionPrompts:h.extensionPrompts,bias:"",type:"normal",quietPrompt:void 0,quietImage:void 0,cyclePrompt:"",systemPromptOverride:x,jailbreakPromptOverride:b,personaDescription:g,messages:Q,messageExamples:ee},!1);p.push(...e)}if(!n)return await te(),p;const ne=h.getPresetManager("openai")?.getCompletionPresetByName(n);if(!ne)return console.warn(`Preset not found: ${n}. Using current preset.`),te(),p;let re=ne.prompt_order.find((e=>e.character_id===ce.this_chid));if(!re&&ne.prompt_order.length>0&&(re=ne.prompt_order[0]),!re)return console.warn(`No prompt order found for preset: ${n}. Using current preset.`),te(),p;const oe=v&&ne.scenario_format?h.substituteParams(ne.scenario_format):"",ie=m&&ne.personality_format?h.substituteParams(ne.personality_format):"",ae=h.substituteParams(ne.group_nudge_prompt),ge=ne.impersonation_prompt?h.substituteParams(ne.impersonation_prompt):"",Se=[];u&&Se.push({role:"system",content:we(T,{wiFormat:ne.wi_format}),identifier:"worldInfoBefore"},{role:"system",content:we(O,{wiFormat:ne.wi_format}),identifier:"worldInfoAfter"}),c||Se.push({role:"system",content:f,identifier:"charDescription"},{role:"system",content:ie,identifier:"charPersonality"},{role:"system",content:oe,identifier:"scenario"}),Se.push({role:"system",content:ge,identifier:"impersonate"},{role:"system",content:ae,identifier:"groupNudge"});const Ce=h.extensionPrompts["1_memory"];Ce&&Ce.value&&Se.push({role:be(Ce.role),content:Ce.value,identifier:"summary",position:Ee(Ce.position)});const Ae=h.extensionPrompts["2_floating_prompt"];!l&&Ae&&Ae.value&&Se.push({role:be(Ae.role),content:Ae.value,identifier:"authorsNote",position:Ee(Ae.position)});const _e=h.extensionPrompts["3_vectors"];_e&&_e.value&&Se.push({role:"system",content:_e.value,identifier:"vectorsMemory",position:Ee(_e.position)});const Pe=h.extensionPrompts["4_vectors_data_bank"];Pe&&Pe.value&&Se.push({role:be(Pe.role),content:Pe.value,identifier:"vectorsDataBank",position:Ee(Pe.position)});const ke=h.extensionPrompts.chromadb;ke&&ke.value&&Se.push({role:"system",content:ke.value,identifier:"smartContext",position:Ee(ke.position)}),!c&&h.powerUserSettings.persona_description&&h.powerUserSettings.persona_description_position===se.persona_description_positions.IN_PROMPT&&Se.push({role:"system",content:h.powerUserSettings.persona_description,identifier:"personaDescription"}),re.order.forEach((e=>{if(!e.enabled)return;const t=(n=e.identifier,Se.find((e=>e.identifier===n)));var n;t&&t.content?p.push({role:t.role??"system",content:h.substituteParams(t.content)}):"chatHistory"===e.identifier&&j()}))}var B,$,R;const V=["1_memory","2_floating_prompt","3_vectors","4_vectors_data_bank","chromadb","PERSONA_DESCRIPTION","QUIET_PROMPT","DEPTH_PROMPT"];for(const Ne in h.extensionPrompts)if(Object.hasOwn(h.extensionPrompts,Ne)){const Ie=h.extensionPrompts[Ne];if(V.includes(Ne))continue;if(!h.extensionPrompts[Ne].value)continue;if(![ce.extension_prompt_types.BEFORE_PROMPT,ce.extension_prompt_types.IN_PROMPT].includes(Ie.position))continue;if("function"==typeof Ie.filter&&!await Ie.filter())continue;Ie.position===ce.extension_prompt_types.BEFORE_PROMPT?p=[...p.slice(0,Ie.depth),{role:be(Ie.role)??"system",content:Ie.value},...p.slice(Ie.depth)]:Ie.position===ce.extension_prompt_types.IN_PROMPT&&(p=[...p.slice(0,p.length-Ie.depth),{role:be(Ie.role)??"system",content:Ie.value},...p.slice(p.length-Ie.depth)])}for(const Te of F)p=[...p.slice(0,p.length-Te.depth),{role:be(Te.role),content:Te.entries.join("\n")},...p.slice(p.length-Te.depth)];if(!c){const Oe=(q=fe.selected_group,W=Number(ce.this_chid),(0,fe.getGroupDepthPrompts)(q,W));if(fe.selected_group&&Array.isArray(Oe)&&Oe.length>0)Oe.filter((e=>e.text)).forEach(((e,t)=>{p=[...p.slice(0,p.length-e.depth),{role:e.role,content:e.text},...p.slice(p.length-e.depth)]}));else{const De=xe(h.characters[ce.this_chid]?.data?.extensions?.depth_prompt?.prompt?.trim(),ce.name1,ce.name2)||"";if(De){const Fe=ce.depth_prompt_depth_default,Le=h.characters[ce.this_chid]?.data?.extensions?.depth_prompt?.role??ce.depth_prompt_role_default;p=[...p.slice(0,p.length-Fe),{role:be(Le),content:De},...p.slice(p.length-Fe)]}}}var q,W;let G=-1;if(!l){const Me={prompt:ce.chat_metadata[pe.metadata_keys.prompt],interval:ce.chat_metadata[pe.metadata_keys.interval],position:ce.chat_metadata[pe.metadata_keys.position],depth:ce.chat_metadata[pe.metadata_keys.depth],role:ce.chat_metadata[pe.metadata_keys.role]};if(Me.prompt)switch(Me.prompt=xe(Me.prompt,ce.name1,ce.name2),Me.position){case ce.extension_prompt_types.IN_PROMPT:p=[...p.slice(0,1),{role:"user",content:Me.prompt},...p.slice(1)],G=1;break;case ce.extension_prompt_types.IN_CHAT:p=[...p.slice(0,p.length-Me.depth),{role:be(Me.role),content:Me.prompt},...p.slice(p.length-Me.depth)],G=p.length-Me.depth-1;break;case ce.extension_prompt_types.BEFORE_PROMPT:p.unshift({role:"user",content:Me.prompt}),G=0}}return G>=0&&(L.length>0&&(p=[...p.slice(0,G),{role:"system",content:L.join("\n")},...p.slice(G)],G++),M.length>0&&(p=[...p.slice(0,G+1),{role:"system",content:M.join("\n")},...p.slice(G+1)])),p}async function Ae({entry:e,selectedWorldName:t,skipSave:n=!1,skipReload:r=!1,operation:o="auto"}){const i=SillyTavern.getContext(),a=await i.loadWorldInfo(t);if(!a)throw new Error("Failed to load world info");const s=Object.values(a.entries),c=s.length>0?s[s.length-1]:void 0;let l;if("update"===o||"auto"===o){const t=Object.values(a.entries).find((t=>t.uid===e.uid));if(t)("auto"===o||"update"===o)&&(l=t);else if("update"===o)throw new Error("Entry not found for update operation")}const u=l?"update":"add";if(!l){if(d=t,h=a,l=(0,le.createWorldInfoEntry)(d,h),!l)throw new Error("Failed to create entry");if(c){const e=l.uid;Object.assign(l,c),l.uid=e}}var d,h;return l.key=e.key,l.content=e.content,l.comment=e.comment,n||await i.saveWorldInfo(t,a),r||i.reloadWorldInfoEditor(t,!0),{entry:l,operation:u}}var _e,Pe;!function(e){e[e.TEXT=1]="TEXT",e[e.CONFIRM=2]="CONFIRM",e[e.INPUT=3]="INPUT",e[e.DISPLAY=4]="DISPLAY"}(_e||(_e={})),function(e){e[e.AFFIRMATIVE=1]="AFFIRMATIVE",e[e.NEGATIVE=0]="NEGATIVE",e[e.CANCELLED=null]="CANCELLED"}(Pe||(Pe={}));const ke=":A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",Ne=new RegExp("^"+("["+ke+"]["+(ke+"\\-.\\d\\u00B7\\u0300-\\u036F\\u203F-\\u2040")+"]*")+"$");function Ie(e,t){const n=[];let r=t.exec(e);for(;r;){const o=[];o.startIndex=t.lastIndex-r[0].length;const i=r.length;for(let e=0;e<i;e++)o.push(r[e]);n.push(o),r=t.exec(e)}return n}const Te=function(e){const t=Ne.exec(e);return!(null==t)};const Oe={allowBooleanAttributes:!1,unpairedTags:[]};function De(e,t){t=Object.assign({},Oe,t);const n=[];let r=!1,o=!1;"\ufeff"===e[0]&&(e=e.substr(1));for(let i=0;i<e.length;i++)if("<"===e[i]&&"?"===e[i+1]){if(i+=2,i=Le(e,i),i.err)return i}else{if("<"!==e[i]){if(Fe(e[i]))continue;return We("InvalidChar","char '"+e[i]+"' is not expected.",Ue(e,i))}{let a=i;if(i++,"!"===e[i]){i=Me(e,i);continue}{let s=!1;"/"===e[i]&&(s=!0,i++);let c="";for(;i<e.length&&">"!==e[i]&&" "!==e[i]&&"\t"!==e[i]&&"\n"!==e[i]&&"\r"!==e[i];i++)c+=e[i];if(c=c.trim(),"/"===c[c.length-1]&&(c=c.substring(0,c.length-1),i--),!Te(c)){let t;return t=0===c.trim().length?"Invalid space after '<'.":"Tag '"+c+"' is an invalid name.",We("InvalidTag",t,Ue(e,i))}const l=$e(e,i);if(!1===l)return We("InvalidAttr","Attributes for '"+c+"' have open quote.",Ue(e,i));let u=l.value;if(i=l.index,"/"===u[u.length-1]){const n=i-u.length;u=u.substring(0,u.length-1);const o=Ve(u,t);if(!0!==o)return We(o.err.code,o.err.msg,Ue(e,n+o.err.line));r=!0}else if(s){if(!l.tagClosed)return We("InvalidTag","Closing tag '"+c+"' doesn't have proper closing.",Ue(e,i));if(u.trim().length>0)return We("InvalidTag","Closing tag '"+c+"' can't have attributes or invalid starting.",Ue(e,a));if(0===n.length)return We("InvalidTag","Closing tag '"+c+"' has not been opened.",Ue(e,a));{const t=n.pop();if(c!==t.tagName){let n=Ue(e,t.tagStartPos);return We("InvalidTag","Expected closing tag '"+t.tagName+"' (opened in line "+n.line+", col "+n.col+") instead of closing tag '"+c+"'.",Ue(e,a))}0==n.length&&(o=!0)}}else{const s=Ve(u,t);if(!0!==s)return We(s.err.code,s.err.msg,Ue(e,i-u.length+s.err.line));if(!0===o)return We("InvalidXml","Multiple possible root nodes found.",Ue(e,i));-1!==t.unpairedTags.indexOf(c)||n.push({tagName:c,tagStartPos:a}),r=!0}for(i++;i<e.length;i++)if("<"===e[i]){if("!"===e[i+1]){i++,i=Me(e,i);continue}if("?"!==e[i+1])break;if(i=Le(e,++i),i.err)return i}else if("&"===e[i]){const t=qe(e,i);if(-1==t)return We("InvalidChar","char '&' is not expected.",Ue(e,i));i=t}else if(!0===o&&!Fe(e[i]))return We("InvalidXml","Extra text at the end",Ue(e,i));"<"===e[i]&&i--}}}return r?1==n.length?We("InvalidTag","Unclosed tag '"+n[0].tagName+"'.",Ue(e,n[0].tagStartPos)):!(n.length>0)||We("InvalidXml","Invalid '"+JSON.stringify(n.map((e=>e.tagName)),null,4).replace(/\r?\n/g,"")+"' found.",{line:1,col:1}):We("InvalidXml","Start tag expected.",1)}function Fe(e){return" "===e||"\t"===e||"\n"===e||"\r"===e}function Le(e,t){const n=t;for(;t<e.length;t++)if("?"!=e[t]&&" "!=e[t]);else{const r=e.substr(n,t-n);if(t>5&&"xml"===r)return We("InvalidXml","XML declaration allowed only at the start of the document.",Ue(e,t));if("?"==e[t]&&">"==e[t+1]){t++;break}}return t}function Me(e,t){if(e.length>t+5&&"-"===e[t+1]&&"-"===e[t+2]){for(t+=3;t<e.length;t++)if("-"===e[t]&&"-"===e[t+1]&&">"===e[t+2]){t+=2;break}}else if(e.length>t+8&&"D"===e[t+1]&&"O"===e[t+2]&&"C"===e[t+3]&&"T"===e[t+4]&&"Y"===e[t+5]&&"P"===e[t+6]&&"E"===e[t+7]){let n=1;for(t+=8;t<e.length;t++)if("<"===e[t])n++;else if(">"===e[t]&&(n--,0===n))break}else if(e.length>t+9&&"["===e[t+1]&&"C"===e[t+2]&&"D"===e[t+3]&&"A"===e[t+4]&&"T"===e[t+5]&&"A"===e[t+6]&&"["===e[t+7])for(t+=8;t<e.length;t++)if("]"===e[t]&&"]"===e[t+1]&&">"===e[t+2]){t+=2;break}return t}const je='"',Be="'";function $e(e,t){let n="",r="",o=!1;for(;t<e.length;t++){if(e[t]===je||e[t]===Be)""===r?r=e[t]:r!==e[t]||(r="");else if(">"===e[t]&&""===r){o=!0;break}n+=e[t]}return""===r&&{value:n,index:t,tagClosed:o}}const Re=new RegExp("(\\s*)([^\\s=]+)(\\s*=)?(\\s*(['\"])(([\\s\\S])*?)\\5)?","g");function Ve(e,t){const n=Ie(e,Re),r={};for(let e=0;e<n.length;e++){if(0===n[e][1].length)return We("InvalidAttr","Attribute '"+n[e][2]+"' has no space in starting.",He(n[e]));if(void 0!==n[e][3]&&void 0===n[e][4])return We("InvalidAttr","Attribute '"+n[e][2]+"' is without value.",He(n[e]));if(void 0===n[e][3]&&!t.allowBooleanAttributes)return We("InvalidAttr","boolean attribute '"+n[e][2]+"' is not allowed.",He(n[e]));const o=n[e][2];if(!Ge(o))return We("InvalidAttr","Attribute '"+o+"' is an invalid name.",He(n[e]));if(r.hasOwnProperty(o))return We("InvalidAttr","Attribute '"+o+"' is repeated.",He(n[e]));r[o]=1}return!0}function qe(e,t){if(";"===e[++t])return-1;if("#"===e[t])return function(e,t){let n=/\d/;for("x"===e[t]&&(t++,n=/[\da-fA-F]/);t<e.length;t++){if(";"===e[t])return t;if(!e[t].match(n))break}return-1}(e,++t);let n=0;for(;t<e.length;t++,n++)if(!(e[t].match(/\w/)&&n<20)){if(";"===e[t])break;return-1}return t}function We(e,t,n){return{err:{code:e,msg:t,line:n.line||n,col:n.col}}}function Ge(e){return Te(e)}function Ue(e,t){const n=e.substring(0,t).split(/\r?\n/);return{line:n.length,col:n[n.length-1].length+1}}function He(e){return e.startIndex+e[1].length}const Xe={preserveOrder:!1,attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,removeNSPrefix:!1,allowBooleanAttributes:!1,parseTagValue:!0,parseAttributeValue:!1,trimValues:!0,cdataPropName:!1,numberParseOptions:{hex:!0,leadingZeros:!0,eNotation:!0},tagValueProcessor:function(e,t){return t},attributeValueProcessor:function(e,t){return t},stopNodes:[],alwaysCreateTextNode:!1,isArray:()=>!1,commentPropName:!1,unpairedTags:[],processEntities:!0,htmlEntities:!1,ignoreDeclaration:!1,ignorePiTags:!1,transformTagName:!1,transformAttributeName:!1,updateTag:function(e,t,n){return e}};class Ye{constructor(e){this.tagname=e,this.child=[],this[":@"]={}}add(e,t){"__proto__"===e&&(e="#__proto__"),this.child.push({[e]:t})}addChild(e){"__proto__"===e.tagname&&(e.tagname="#__proto__"),e[":@"]&&Object.keys(e[":@"]).length>0?this.child.push({[e.tagname]:e.child,":@":e[":@"]}):this.child.push({[e.tagname]:e.child})}}function Je(e,t){const n={};if("O"!==e[t+3]||"C"!==e[t+4]||"T"!==e[t+5]||"Y"!==e[t+6]||"P"!==e[t+7]||"E"!==e[t+8])throw new Error("Invalid Tag instead of DOCTYPE");{t+=9;let r=1,o=!1,i=!1,a="";for(;t<e.length;t++)if("<"!==e[t]||i)if(">"===e[t]){if(i?"-"===e[t-1]&&"-"===e[t-2]&&(i=!1,r--):r--,0===r)break}else"["===e[t]?o=!0:a+=e[t];else{if(o&&Ze(e,t)){let r,o;t+=7,[r,o,t]=ze(e,t+1),-1===o.indexOf("&")&&(n[nt(r)]={regx:RegExp(`&${r};`,"g"),val:o})}else if(o&&Qe(e,t))t+=8;else if(o&&et(e,t))t+=8;else if(o&&tt(e,t))t+=9;else{if(!Ke)throw new Error("Invalid DOCTYPE");i=!0}r++,a=""}if(0!==r)throw new Error("Unclosed DOCTYPE")}return{entities:n,i:t}}function ze(e,t){let n="";for(;t<e.length&&"'"!==e[t]&&'"'!==e[t];t++)n+=e[t];if(n=n.trim(),-1!==n.indexOf(" "))throw new Error("External entites are not supported");const r=e[t++];let o="";for(;t<e.length&&e[t]!==r;t++)o+=e[t];return[n,o,t]}function Ke(e,t){return"!"===e[t+1]&&"-"===e[t+2]&&"-"===e[t+3]}function Ze(e,t){return"!"===e[t+1]&&"E"===e[t+2]&&"N"===e[t+3]&&"T"===e[t+4]&&"I"===e[t+5]&&"T"===e[t+6]&&"Y"===e[t+7]}function Qe(e,t){return"!"===e[t+1]&&"E"===e[t+2]&&"L"===e[t+3]&&"E"===e[t+4]&&"M"===e[t+5]&&"E"===e[t+6]&&"N"===e[t+7]&&"T"===e[t+8]}function et(e,t){return"!"===e[t+1]&&"A"===e[t+2]&&"T"===e[t+3]&&"T"===e[t+4]&&"L"===e[t+5]&&"I"===e[t+6]&&"S"===e[t+7]&&"T"===e[t+8]}function tt(e,t){return"!"===e[t+1]&&"N"===e[t+2]&&"O"===e[t+3]&&"T"===e[t+4]&&"A"===e[t+5]&&"T"===e[t+6]&&"I"===e[t+7]&&"O"===e[t+8]&&"N"===e[t+9]}function nt(e){if(Te(e))return e;throw new Error(`Invalid entity name ${e}`)}const rt=/^[-+]?0x[a-fA-F0-9]+$/,ot=/^([\-\+])?(0*)([0-9]*(\.[0-9]*)?)$/,it={hex:!0,leadingZeros:!0,decimalPoint:".",eNotation:!0};function at(e,t={}){if(t=Object.assign({},it,t),!e||"string"!=typeof e)return e;let n=e.trim();if(void 0!==t.skipLike&&t.skipLike.test(n))return e;if("0"===e)return 0;if(t.hex&&rt.test(n))return function(e,t){if(parseInt)return parseInt(e,t);if(Number.parseInt)return Number.parseInt(e,t);if(window&&window.parseInt)return window.parseInt(e,t);throw new Error("parseInt, Number.parseInt, window.parseInt are not supported")}(n,16);if(-1!==n.search(/[eE]/)){const r=n.match(/^([-\+])?(0*)([0-9]*(\.[0-9]*)?[eE][-\+]?[0-9]+)$/);if(r){if(t.leadingZeros)n=(r[1]||"")+r[3];else if("0"!==r[2]||"."!==r[3][0])return e;return t.eNotation?Number(n):e}return e}{const r=ot.exec(n);if(r){const o=r[1],i=r[2];let a=function(e){if(e&&-1!==e.indexOf("."))return"."===(e=e.replace(/0+$/,""))?e="0":"."===e[0]?e="0"+e:"."===e[e.length-1]&&(e=e.substr(0,e.length-1)),e;return e}(r[3]);if(!t.leadingZeros&&i.length>0&&o&&"."!==n[2])return e;if(!t.leadingZeros&&i.length>0&&!o&&"."!==n[1])return e;if(t.leadingZeros&&i===e)return 0;{const r=Number(n),s=""+r;return-1!==s.search(/[eE]/)?t.eNotation?r:e:-1!==n.indexOf(".")?"0"===s&&""===a||s===a||o&&s==="-"+a?r:e:i?a===s||o+a===s?r:e:n===s||n===o+s?r:e}}return e}}function st(e){return"function"==typeof e?e:Array.isArray(e)?t=>{for(const n of e){if("string"==typeof n&&t===n)return!0;if(n instanceof RegExp&&n.test(t))return!0}}:()=>!1}class ct{constructor(e){this.options=e,this.currentNode=null,this.tagsNodeStack=[],this.docTypeEntities={},this.lastEntities={apos:{regex:/&(apos|#39|#x27);/g,val:"'"},gt:{regex:/&(gt|#62|#x3E);/g,val:">"},lt:{regex:/&(lt|#60|#x3C);/g,val:"<"},quot:{regex:/&(quot|#34|#x22);/g,val:'"'}},this.ampEntity={regex:/&(amp|#38|#x26);/g,val:"&"},this.htmlEntities={space:{regex:/&(nbsp|#160);/g,val:" "},cent:{regex:/&(cent|#162);/g,val:""},pound:{regex:/&(pound|#163);/g,val:""},yen:{regex:/&(yen|#165);/g,val:""},euro:{regex:/&(euro|#8364);/g,val:""},copyright:{regex:/&(copy|#169);/g,val:""},reg:{regex:/&(reg|#174);/g,val:""},inr:{regex:/&(inr|#8377);/g,val:""},num_dec:{regex:/&#([0-9]{1,7});/g,val:(e,t)=>String.fromCodePoint(Number.parseInt(t,10))},num_hex:{regex:/&#x([0-9a-fA-F]{1,6});/g,val:(e,t)=>String.fromCodePoint(Number.parseInt(t,16))}},this.addExternalEntities=lt,this.parseXml=ft,this.parseTextData=ut,this.resolveNameSpace=dt,this.buildAttributesMap=pt,this.isItStopNode=yt,this.replaceEntitiesValue=gt,this.readStopNodeData=wt,this.saveTextToParentTag=vt,this.addChild=mt,this.ignoreAttributesFn=st(this.options.ignoreAttributes)}}function lt(e){const t=Object.keys(e);for(let n=0;n<t.length;n++){const r=t[n];this.lastEntities[r]={regex:new RegExp("&"+r+";","g"),val:e[r]}}}function ut(e,t,n,r,o,i,a){if(void 0!==e&&(this.options.trimValues&&!r&&(e=e.trim()),e.length>0)){a||(e=this.replaceEntitiesValue(e));const r=this.options.tagValueProcessor(t,e,n,o,i);if(null==r)return e;if(typeof r!=typeof e||r!==e)return r;if(this.options.trimValues)return Et(e,this.options.parseTagValue,this.options.numberParseOptions);return e.trim()===e?Et(e,this.options.parseTagValue,this.options.numberParseOptions):e}}function dt(e){if(this.options.removeNSPrefix){const t=e.split(":"),n="/"===e.charAt(0)?"/":"";if("xmlns"===t[0])return"";2===t.length&&(e=n+t[1])}return e}const ht=new RegExp("([^\\s=]+)\\s*(=\\s*(['\"])([\\s\\S]*?)\\3)?","gm");function pt(e,t,n){if(!0!==this.options.ignoreAttributes&&"string"==typeof e){const n=Ie(e,ht),r=n.length,o={};for(let e=0;e<r;e++){const r=this.resolveNameSpace(n[e][1]);if(this.ignoreAttributesFn(r,t))continue;let i=n[e][4],a=this.options.attributeNamePrefix+r;if(r.length)if(this.options.transformAttributeName&&(a=this.options.transformAttributeName(a)),"__proto__"===a&&(a="#__proto__"),void 0!==i){this.options.trimValues&&(i=i.trim()),i=this.replaceEntitiesValue(i);const e=this.options.attributeValueProcessor(r,i,t);o[a]=null==e?i:typeof e!=typeof i||e!==i?e:Et(i,this.options.parseAttributeValue,this.options.numberParseOptions)}else this.options.allowBooleanAttributes&&(o[a]=!0)}if(!Object.keys(o).length)return;if(this.options.attributesGroupName){const e={};return e[this.options.attributesGroupName]=o,e}return o}}const ft=function(e){e=e.replace(/\r\n?/g,"\n");const t=new Ye("!xml");let n=t,r="",o="";for(let i=0;i<e.length;i++){if("<"===e[i])if("/"===e[i+1]){const t=xt(e,">",i,"Closing Tag is not closed.");let a=e.substring(i+2,t).trim();if(this.options.removeNSPrefix){const e=a.indexOf(":");-1!==e&&(a=a.substr(e+1))}this.options.transformTagName&&(a=this.options.transformTagName(a)),n&&(r=this.saveTextToParentTag(r,n,o));const s=o.substring(o.lastIndexOf(".")+1);if(a&&-1!==this.options.unpairedTags.indexOf(a))throw new Error(`Unpaired tag can not be used as closing tag: </${a}>`);let c=0;s&&-1!==this.options.unpairedTags.indexOf(s)?(c=o.lastIndexOf(".",o.lastIndexOf(".")-1),this.tagsNodeStack.pop()):c=o.lastIndexOf("."),o=o.substring(0,c),n=this.tagsNodeStack.pop(),r="",i=t}else if("?"===e[i+1]){let t=bt(e,i,!1,"?>");if(!t)throw new Error("Pi Tag is not closed.");if(r=this.saveTextToParentTag(r,n,o),this.options.ignoreDeclaration&&"?xml"===t.tagName||this.options.ignorePiTags);else{const e=new Ye(t.tagName);e.add(this.options.textNodeName,""),t.tagName!==t.tagExp&&t.attrExpPresent&&(e[":@"]=this.buildAttributesMap(t.tagExp,o,t.tagName)),this.addChild(n,e,o)}i=t.closeIndex+1}else if("!--"===e.substr(i+1,3)){const t=xt(e,"--\x3e",i+4,"Comment is not closed.");if(this.options.commentPropName){const a=e.substring(i+4,t-2);r=this.saveTextToParentTag(r,n,o),n.add(this.options.commentPropName,[{[this.options.textNodeName]:a}])}i=t}else if("!D"===e.substr(i+1,2)){const t=Je(e,i);this.docTypeEntities=t.entities,i=t.i}else if("!["===e.substr(i+1,2)){const t=xt(e,"]]>",i,"CDATA is not closed.")-2,a=e.substring(i+9,t);r=this.saveTextToParentTag(r,n,o);let s=this.parseTextData(a,n.tagname,o,!0,!1,!0,!0);null==s&&(s=""),this.options.cdataPropName?n.add(this.options.cdataPropName,[{[this.options.textNodeName]:a}]):n.add(this.options.textNodeName,s),i=t+2}else{let a=bt(e,i,this.options.removeNSPrefix),s=a.tagName;const c=a.rawTagName;let l=a.tagExp,u=a.attrExpPresent,d=a.closeIndex;this.options.transformTagName&&(s=this.options.transformTagName(s)),n&&r&&"!xml"!==n.tagname&&(r=this.saveTextToParentTag(r,n,o,!1));const h=n;if(h&&-1!==this.options.unpairedTags.indexOf(h.tagname)&&(n=this.tagsNodeStack.pop(),o=o.substring(0,o.lastIndexOf("."))),s!==t.tagname&&(o+=o?"."+s:s),this.isItStopNode(this.options.stopNodes,o,s)){let t="";if(l.length>0&&l.lastIndexOf("/")===l.length-1)"/"===s[s.length-1]?(s=s.substr(0,s.length-1),o=o.substr(0,o.length-1),l=s):l=l.substr(0,l.length-1),i=a.closeIndex;else if(-1!==this.options.unpairedTags.indexOf(s))i=a.closeIndex;else{const n=this.readStopNodeData(e,c,d+1);if(!n)throw new Error(`Unexpected end of ${c}`);i=n.i,t=n.tagContent}const r=new Ye(s);s!==l&&u&&(r[":@"]=this.buildAttributesMap(l,o,s)),t&&(t=this.parseTextData(t,s,o,!0,u,!0,!0)),o=o.substr(0,o.lastIndexOf(".")),r.add(this.options.textNodeName,t),this.addChild(n,r,o)}else{if(l.length>0&&l.lastIndexOf("/")===l.length-1){"/"===s[s.length-1]?(s=s.substr(0,s.length-1),o=o.substr(0,o.length-1),l=s):l=l.substr(0,l.length-1),this.options.transformTagName&&(s=this.options.transformTagName(s));const e=new Ye(s);s!==l&&u&&(e[":@"]=this.buildAttributesMap(l,o,s)),this.addChild(n,e,o),o=o.substr(0,o.lastIndexOf("."))}else{const e=new Ye(s);this.tagsNodeStack.push(n),s!==l&&u&&(e[":@"]=this.buildAttributesMap(l,o,s)),this.addChild(n,e,o),n=e}r="",i=d}}else r+=e[i]}return t.child};function mt(e,t,n){const r=this.options.updateTag(t.tagname,n,t[":@"]);!1===r||("string"==typeof r?(t.tagname=r,e.addChild(t)):e.addChild(t))}const gt=function(e){if(this.options.processEntities){for(let t in this.docTypeEntities){const n=this.docTypeEntities[t];e=e.replace(n.regx,n.val)}for(let t in this.lastEntities){const n=this.lastEntities[t];e=e.replace(n.regex,n.val)}if(this.options.htmlEntities)for(let t in this.htmlEntities){const n=this.htmlEntities[t];e=e.replace(n.regex,n.val)}e=e.replace(this.ampEntity.regex,this.ampEntity.val)}return e};function vt(e,t,n,r){return e&&(void 0===r&&(r=0===t.child.length),void 0!==(e=this.parseTextData(e,t.tagname,n,!1,!!t[":@"]&&0!==Object.keys(t[":@"]).length,r))&&""!==e&&t.add(this.options.textNodeName,e),e=""),e}function yt(e,t,n){const r="*."+n;for(const n in e){const o=e[n];if(r===o||t===o)return!0}return!1}function xt(e,t,n,r){const o=e.indexOf(t,n);if(-1===o)throw new Error(r);return o+t.length-1}function bt(e,t,n,r=">"){const o=function(e,t,n=">"){let r,o="";for(let i=t;i<e.length;i++){let t=e[i];if(r)t===r&&(r="");else if('"'===t||"'"===t)r=t;else if(t===n[0]){if(!n[1])return{data:o,index:i};if(e[i+1]===n[1])return{data:o,index:i}}else"\t"===t&&(t=" ");o+=t}}(e,t+1,r);if(!o)return;let i=o.data;const a=o.index,s=i.search(/\s/);let c=i,l=!0;-1!==s&&(c=i.substring(0,s),i=i.substring(s+1).trimStart());const u=c;if(n){const e=c.indexOf(":");-1!==e&&(c=c.substr(e+1),l=c!==o.data.substr(e+1))}return{tagName:c,tagExp:i,closeIndex:a,attrExpPresent:l,rawTagName:u}}function wt(e,t,n){const r=n;let o=1;for(;n<e.length;n++)if("<"===e[n])if("/"===e[n+1]){const i=xt(e,">",n,`${t} is not closed`);if(e.substring(n+2,i).trim()===t&&(o--,0===o))return{tagContent:e.substring(r,n),i};n=i}else if("?"===e[n+1]){n=xt(e,"?>",n+1,"StopNode is not closed.")}else if("!--"===e.substr(n+1,3)){n=xt(e,"--\x3e",n+3,"StopNode is not closed.")}else if("!["===e.substr(n+1,2)){n=xt(e,"]]>",n,"StopNode is not closed.")-2}else{const r=bt(e,n,">");if(r){(r&&r.tagName)===t&&"/"!==r.tagExp[r.tagExp.length-1]&&o++,n=r.closeIndex}}}function Et(e,t,n){if(t&&"string"==typeof e){const t=e.trim();return"true"===t||"false"!==t&&at(e,n)}return void 0!==e?e:""}function St(e,t){return Ct(e,t)}function Ct(e,t,n){let r;const o={};for(let i=0;i<e.length;i++){const a=e[i],s=At(a);let c="";if(c=void 0===n?s:n+"."+s,s===t.textNodeName)void 0===r?r=a[s]:r+=""+a[s];else{if(void 0===s)continue;if(a[s]){let e=Ct(a[s],t,c);const n=Pt(e,t);a[":@"]?_t(e,a[":@"],c,t):1!==Object.keys(e).length||void 0===e[t.textNodeName]||t.alwaysCreateTextNode?0===Object.keys(e).length&&(t.alwaysCreateTextNode?e[t.textNodeName]="":e=""):e=e[t.textNodeName],void 0!==o[s]&&o.hasOwnProperty(s)?(Array.isArray(o[s])||(o[s]=[o[s]]),o[s].push(e)):t.isArray(s,c,n)?o[s]=[e]:o[s]=e}}}return"string"==typeof r?r.length>0&&(o[t.textNodeName]=r):void 0!==r&&(o[t.textNodeName]=r),o}function At(e){const t=Object.keys(e);for(let e=0;e<t.length;e++){const n=t[e];if(":@"!==n)return n}}function _t(e,t,n,r){if(t){const o=Object.keys(t),i=o.length;for(let a=0;a<i;a++){const i=o[a];r.isArray(i,n+"."+i,!0,!0)?e[i]=[t[i]]:e[i]=t[i]}}}function Pt(e,t){const{textNodeName:n}=t,r=Object.keys(e).length;return 0===r||!(1!==r||!e[n]&&"boolean"!=typeof e[n]&&0!==e[n])}function kt(e,t){let n="";return t.format&&t.indentBy.length>0&&(n="\n"),Nt(e,t,"",n)}function Nt(e,t,n,r){let o="",i=!1;for(let a=0;a<e.length;a++){const s=e[a],c=It(s);if(void 0===c)continue;let l="";if(l=0===n.length?c:`${n}.${c}`,c===t.textNodeName){let e=s[c];Ot(l,t)||(e=t.tagValueProcessor(c,e),e=Dt(e,t)),i&&(o+=r),o+=e,i=!1;continue}if(c===t.cdataPropName){i&&(o+=r),o+=`<![CDATA[${s[c][0][t.textNodeName]}]]>`,i=!1;continue}if(c===t.commentPropName){o+=r+`\x3c!--${s[c][0][t.textNodeName]}--\x3e`,i=!0;continue}if("?"===c[0]){const e=Tt(s[":@"],t),n="?xml"===c?"":r;let a=s[c][0][t.textNodeName];a=0!==a.length?" "+a:"",o+=n+`<${c}${a}${e}?>`,i=!0;continue}let u=r;""!==u&&(u+=t.indentBy);const d=r+`<${c}${Tt(s[":@"],t)}`,h=Nt(s[c],t,l,u);-1!==t.unpairedTags.indexOf(c)?t.suppressUnpairedNode?o+=d+">":o+=d+"/>":h&&0!==h.length||!t.suppressEmptyNode?h&&h.endsWith(">")?o+=d+`>${h}${r}</${c}>`:(o+=d+">",h&&""!==r&&(h.includes("/>")||h.includes("</"))?o+=r+t.indentBy+h+r:o+=h,o+=`</${c}>`):o+=d+"/>",i=!0}return o}function It(e){const t=Object.keys(e);for(let n=0;n<t.length;n++){const r=t[n];if(e.hasOwnProperty(r)&&":@"!==r)return r}}function Tt(e,t){let n="";if(e&&!t.ignoreAttributes)for(let r in e){if(!e.hasOwnProperty(r))continue;let o=t.attributeValueProcessor(r,e[r]);o=Dt(o,t),!0===o&&t.suppressBooleanAttributes?n+=` ${r.substr(t.attributeNamePrefix.length)}`:n+=` ${r.substr(t.attributeNamePrefix.length)}="${o}"`}return n}function Ot(e,t){let n=(e=e.substr(0,e.length-t.textNodeName.length-1)).substr(e.lastIndexOf(".")+1);for(let r in t.stopNodes)if(t.stopNodes[r]===e||t.stopNodes[r]==="*."+n)return!0;return!1}function Dt(e,t){if(e&&e.length>0&&t.processEntities)for(let n=0;n<t.entities.length;n++){const r=t.entities[n];e=e.replace(r.regex,r.val)}return e}const Ft={attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,cdataPropName:!1,format:!1,indentBy:"  ",suppressEmptyNode:!1,suppressUnpairedNode:!0,suppressBooleanAttributes:!0,tagValueProcessor:function(e,t){return t},attributeValueProcessor:function(e,t){return t},preserveOrder:!1,commentPropName:!1,unpairedTags:[],entities:[{regex:new RegExp("&","g"),val:"&amp;"},{regex:new RegExp(">","g"),val:"&gt;"},{regex:new RegExp("<","g"),val:"&lt;"},{regex:new RegExp("'","g"),val:"&apos;"},{regex:new RegExp('"',"g"),val:"&quot;"}],processEntities:!0,stopNodes:[],oneListGroup:!1};function Lt(e){this.options=Object.assign({},Ft,e),!0===this.options.ignoreAttributes||this.options.attributesGroupName?this.isAttribute=function(){return!1}:(this.ignoreAttributesFn=st(this.options.ignoreAttributes),this.attrPrefixLen=this.options.attributeNamePrefix.length,this.isAttribute=Bt),this.processTextOrObjNode=Mt,this.options.format?(this.indentate=jt,this.tagEndChar=">\n",this.newLine="\n"):(this.indentate=function(){return""},this.tagEndChar=">",this.newLine="")}function Mt(e,t,n,r){const o=this.j2x(e,n+1,r.concat(t));return void 0!==e[this.options.textNodeName]&&1===Object.keys(e).length?this.buildTextValNode(e[this.options.textNodeName],t,o.attrStr,n):this.buildObjectNode(o.val,t,o.attrStr,n)}function jt(e){return this.options.indentBy.repeat(e)}function Bt(e){return!(!e.startsWith(this.options.attributeNamePrefix)||e===this.options.textNodeName)&&e.substr(this.attrPrefixLen)}Lt.prototype.build=function(e){return this.options.preserveOrder?kt(e,this.options):(Array.isArray(e)&&this.options.arrayNodeName&&this.options.arrayNodeName.length>1&&(e={[this.options.arrayNodeName]:e}),this.j2x(e,0,[]).val)},Lt.prototype.j2x=function(e,t,n){let r="",o="";const i=n.join(".");for(let a in e)if(Object.prototype.hasOwnProperty.call(e,a))if(void 0===e[a])this.isAttribute(a)&&(o+="");else if(null===e[a])this.isAttribute(a)||a===this.options.cdataPropName?o+="":"?"===a[0]?o+=this.indentate(t)+"<"+a+"?"+this.tagEndChar:o+=this.indentate(t)+"<"+a+"/"+this.tagEndChar;else if(e[a]instanceof Date)o+=this.buildTextValNode(e[a],a,"",t);else if("object"!=typeof e[a]){const n=this.isAttribute(a);if(n&&!this.ignoreAttributesFn(n,i))r+=this.buildAttrPairStr(n,""+e[a]);else if(!n)if(a===this.options.textNodeName){let t=this.options.tagValueProcessor(a,""+e[a]);o+=this.replaceEntitiesValue(t)}else o+=this.buildTextValNode(e[a],a,"",t)}else if(Array.isArray(e[a])){const r=e[a].length;let i="",s="";for(let c=0;c<r;c++){const r=e[a][c];if(void 0===r);else if(null===r)"?"===a[0]?o+=this.indentate(t)+"<"+a+"?"+this.tagEndChar:o+=this.indentate(t)+"<"+a+"/"+this.tagEndChar;else if("object"==typeof r)if(this.options.oneListGroup){const e=this.j2x(r,t+1,n.concat(a));i+=e.val,this.options.attributesGroupName&&r.hasOwnProperty(this.options.attributesGroupName)&&(s+=e.attrStr)}else i+=this.processTextOrObjNode(r,a,t,n);else if(this.options.oneListGroup){let e=this.options.tagValueProcessor(a,r);e=this.replaceEntitiesValue(e),i+=e}else i+=this.buildTextValNode(r,a,"",t)}this.options.oneListGroup&&(i=this.buildObjectNode(i,a,s,t)),o+=i}else if(this.options.attributesGroupName&&a===this.options.attributesGroupName){const t=Object.keys(e[a]),n=t.length;for(let o=0;o<n;o++)r+=this.buildAttrPairStr(t[o],""+e[a][t[o]])}else o+=this.processTextOrObjNode(e[a],a,t,n);return{attrStr:r,val:o}},Lt.prototype.buildAttrPairStr=function(e,t){return t=this.options.attributeValueProcessor(e,""+t),t=this.replaceEntitiesValue(t),this.options.suppressBooleanAttributes&&"true"===t?" "+e:" "+e+'="'+t+'"'},Lt.prototype.buildObjectNode=function(e,t,n,r){if(""===e)return"?"===t[0]?this.indentate(r)+"<"+t+n+"?"+this.tagEndChar:this.indentate(r)+"<"+t+n+this.closeTag(t)+this.tagEndChar;{let o="</"+t+this.tagEndChar,i="";return"?"===t[0]&&(i="?",o=""),!n&&""!==n||-1!==e.indexOf("<")?!1!==this.options.commentPropName&&t===this.options.commentPropName&&0===i.length?this.indentate(r)+`\x3c!--${e}--\x3e`+this.newLine:this.indentate(r)+"<"+t+n+i+this.tagEndChar+e+this.indentate(r)+o:this.indentate(r)+"<"+t+n+i+">"+e+o}},Lt.prototype.closeTag=function(e){let t="";return-1!==this.options.unpairedTags.indexOf(e)?this.options.suppressUnpairedNode||(t="/"):t=this.options.suppressEmptyNode?"/":`></${e}`,t},Lt.prototype.buildTextValNode=function(e,t,n,r){if(!1!==this.options.cdataPropName&&t===this.options.cdataPropName)return this.indentate(r)+`<![CDATA[${e}]]>`+this.newLine;if(!1!==this.options.commentPropName&&t===this.options.commentPropName)return this.indentate(r)+`\x3c!--${e}--\x3e`+this.newLine;if("?"===t[0])return this.indentate(r)+"<"+t+n+"?"+this.tagEndChar;{let o=this.options.tagValueProcessor(t,e);return o=this.replaceEntitiesValue(o),""===o?this.indentate(r)+"<"+t+n+this.closeTag(t)+this.tagEndChar:this.indentate(r)+"<"+t+n+">"+o+"</"+t+this.tagEndChar}},Lt.prototype.replaceEntitiesValue=function(e){if(e&&e.length>0&&this.options.processEntities)for(let t=0;t<this.options.entities.length;t++){const n=this.options.entities[t];e=e.replace(n.regex,n.val)}return e};var $t=new class{constructor(e){this.externalEntities={},this.options=function(e){return Object.assign({},Xe,e)}(e)}parse(e,t){if("string"==typeof e);else{if(!e.toString)throw new Error("XML data is accepted in String or Bytes[] form.");e=e.toString()}if(t){!0===t&&(t={});const n=De(e,t);if(!0!==n)throw Error(`${n.err.msg}:${n.err.line}:${n.err.col}`)}const n=new ct(this.options);n.addExternalEntities(this.externalEntities);const r=n.parseXml(e);return this.options.preserveOrder||void 0===r?r:St(r,this.options)}addEntity(e,t){if(-1!==t.indexOf("&"))throw new Error("Entity value can't have '&'");if(-1!==e.indexOf("&")||-1!==e.indexOf(";"))throw new Error("An entity must be set without '&' and ';'. Eg. use '#xD' for '&#xD;'");if("&"===t)throw new Error("An entity with value '&' is not permitted");this.externalEntities[e]=t}}({ignoreAttributes:!1,allowBooleanAttributes:!0});function Rt(e,t){var n,r,o,i,a=e.match(/```(?:\w+\n|\n)([\s\S]*?)```/),s=a?a[1].trim():e.trim();try{switch(t){case"xml":var c=$t.parse(s),l=null!==(n=null!==(r=null==c?void 0:c.response)&&void 0!==r?r:null==c||null===(o=c.root)||void 0===o?void 0:o.response)&&void 0!==n?n:null==c||null===(i=c.data)||void 0===i?void 0:i.response;if("string"==typeof l)return l.trim();if(l&&"string"==typeof l["#text"])return l["#text"].trim();if(c&&Object.keys(c).length>0){var u=Object.values(c)[0];if("string"==typeof u)return u.trim();if("string"==typeof(null==u?void 0:u["#text"]))return u["#text"].trim()}throw new Error("Invalid XML format: <response> tag content not found or not a string.");case"json":var d=JSON.parse(s);if(d&&"string"==typeof d.response)return d.response.trim();if(null!=d&&d.response&&Object.keys(d.response).length>0)return String(Object.values(d.response)[0]).trim();if(d&&Object.keys(d).length>0)return String(Object.values(d)[0]).trim();throw new Error('Invalid JSON format: "response" key not found or its value is not a string.');case"none":return s;default:throw new Error("Unsupported format specified: ".concat(t))}}catch(n){throw console.error("Error parsing response in format '".concat(t,"':"),n),console.error("Raw content received:",e),"xml"===t&&n.message.includes("Invalid XML")?new Error("Model response is not valid XML or does not contain the <response> tag."):"json"===t&&n instanceof SyntaxError?new Error('Model response is not valid JSON or does not follow the {"response": "..."} structure.'):new Error("Failed to parse response as ".concat(t,": ").concat(n.message))}}const Vt=(e=>{var t={};return h.d(t,e),t})({Handlebars:()=>d.Handlebars});function qt(e){return qt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},qt(e)}function Wt(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */Wt=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,o=Object.defineProperty||function(e,t,n){e[t]=n.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function l(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,n){return e[t]=n}}function u(e,t,n,r){var i=t&&t.prototype instanceof v?t:v,a=Object.create(i.prototype),s=new I(r||[]);return o(a,"_invoke",{value:_(e,n,s)}),a}function d(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var h="suspendedStart",p="suspendedYield",f="executing",m="completed",g={};function v(){}function y(){}function x(){}var b={};l(b,a,(function(){return this}));var w=Object.getPrototypeOf,E=w&&w(w(T([])));E&&E!==n&&r.call(E,a)&&(b=E);var S=x.prototype=v.prototype=Object.create(b);function C(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function A(e,t){function n(o,i,a,s){var c=d(e[o],e,i);if("throw"!==c.type){var l=c.arg,u=l.value;return u&&"object"==qt(u)&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,a,s)}),(function(e){n("throw",e,a,s)})):t.resolve(u).then((function(e){l.value=e,a(l)}),(function(e){return n("throw",e,a,s)}))}s(c.arg)}var i;o(this,"_invoke",{value:function(e,r){function o(){return new t((function(t,o){n(e,r,t,o)}))}return i=i?i.then(o,o):o()}})}function _(t,n,r){var o=h;return function(i,a){if(o===f)throw Error("Generator is already running");if(o===m){if("throw"===i)throw a;return{value:e,done:!0}}for(r.method=i,r.arg=a;;){var s=r.delegate;if(s){var c=P(s,r);if(c){if(c===g)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===h)throw o=m,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=f;var l=d(t,n,r);if("normal"===l.type){if(o=r.done?m:p,l.arg===g)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(o=m,r.method="throw",r.arg=l.arg)}}}function P(t,n){var r=n.method,o=t.iterator[r];if(o===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,P(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),g;var i=d(o,t.iterator,n.arg);if("throw"===i.type)return n.method="throw",n.arg=i.arg,n.delegate=null,g;var a=i.arg;return a?a.done?(n[t.resultName]=a.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,g):a:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,g)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function N(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function I(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function T(t){if(t||""===t){var n=t[a];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,i=function n(){for(;++o<t.length;)if(r.call(t,o))return n.value=t[o],n.done=!1,n;return n.value=e,n.done=!0,n};return i.next=i}}throw new TypeError(qt(t)+" is not iterable")}return y.prototype=x,o(S,"constructor",{value:x,configurable:!0}),o(x,"constructor",{value:y,configurable:!0}),y.displayName=l(x,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,x):(e.__proto__=x,l(e,c,"GeneratorFunction")),e.prototype=Object.create(S),e},t.awrap=function(e){return{__await:e}},C(A.prototype),l(A.prototype,s,(function(){return this})),t.AsyncIterator=A,t.async=function(e,n,r,o,i){void 0===i&&(i=Promise);var a=new A(u(e,n,r,o),i);return t.isGeneratorFunction(n)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},C(S),l(S,c,"Generator"),l(S,a,(function(){return this})),l(S,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=T,I.prototype={constructor:I,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(N),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function o(r,o){return s.type="throw",s.arg=t,n.next=r,o&&(n.method="next",n.arg=e),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var c=r.call(a,"catchLoc"),l=r.call(a,"finallyLoc");if(c&&l){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=e,a.arg=t,i?(this.method="next",this.next=i.finallyLoc,g):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),N(n),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;N(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:T(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),g}},t}function Gt(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=Xt(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){s=!0,i=e},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw i}}}}function Ut(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,i,a,s=[],c=!0,l=!1;try{if(i=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;c=!1}else for(;!(c=(r=i.call(n)).done)&&(s.push(r.value),s.length!==t);c=!0);}catch(e){l=!0,o=e}finally{try{if(!c&&null!=n.return&&(a=n.return(),Object(a)!==a))return}finally{if(l)throw o}}return s}}(e,t)||Xt(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Ht(e){return function(e){if(Array.isArray(e))return Yt(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||Xt(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Xt(e,t){if(e){if("string"==typeof e)return Yt(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Yt(e,t):void 0}}function Yt(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function Jt(e,t,n,r,o,i,a){try{var s=e[i](a),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,o)}var zt=SillyTavern.getContext(),Kt=["name","description","personality","scenario","first_mes","mes_example"];function Zt(e){return Qt.apply(this,arguments)}function Qt(){var e;return e=Wt().mark((function e(t){var n,r,o,i,a,s,c,l,u,d,h,p,f,m,g,v,y,x,b,w,E,S,C,A,_,P,k,N,I,T,O;return Wt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.profileId,o=t.userPrompt,i=t.buildPromptOptions,a=t.contextToSend,s=t.session,c=t.allCharacters,l=t.entriesGroupByWorldName,u=t.promptSettings,d=t.maxResponseToken,h=t.targetField,p=t.outputFormat,r){e.next=3;break}throw new Error("No connection profile selected.");case 3:if(f=null===(n=zt.extensionSettings.connectionManager)||void 0===n||null===(n=n.profiles)||void 0===n?void 0:n.find((function(e){return e.id===r}))){e.next=6;break}throw new Error('Connection profile with ID "'.concat(r,'" not found.'));case 6:if(m=zt.substituteParams(o.trim()),g=[],v=f.api?zt.CONNECT_API_MAP[f.api].selected:void 0){e.next=11;break}throw new Error('Could not determine API for profile "'.concat(f.name,'".'));case 11:return e.t0=g.push,e.t1=g,e.t2=Ht,e.next=16,Ce(v,i);case 16:if(e.t3=e.sent,e.t4=(0,e.t2)(e.t3),e.t0.apply.call(e.t0,e.t1,e.t4),a.stDescription&&g.push({role:"system",content:u.stCharCardPrompt}),!(a.charCard&&s.selectedCharacterIndexes.length>0)){e.next=32;break}e.prev=21,y=Vt.Handlebars.compile(u.charCardDefinitionPrompt,{noEscape:!0}),x=[],s.selectedCharacterIndexes.forEach((function(e){var t=parseInt(e),n=c[t];n&&x.push(n)})),x.length>0&&(b=y({characters:x}))&&g.push({role:"system",content:b}),e.next=32;break;case 28:throw e.prev=28,e.t5=e.catch(21),console.error("Error compiling or executing Handlebars template for character definitions:",e.t5),new Error("Error compiling or executing Handlebars template for character definitions: ".concat(e.t5.message));case 32:if(!(a.worldInfo&&s.selectedWorldNames.length>0)){e.next=44;break}e.prev=33,w=Vt.Handlebars.compile(u.lorebookDefinitionPrompt,{noEscape:!0}),E={},Object.entries(l).filter((function(e){var t=Ut(e,2),n=t[0],r=t[1];return r.length>0&&s.selectedWorldNames.includes(n)&&r.some((function(e){return!e.disable}))})).forEach((function(e){var t=Ut(e,2),n=t[0],r=t[1];E[n]=r.filter((function(e){return!e.disable}))})),Object.keys(E).length>0&&(S=w({lorebooks:E}))&&g.push({role:"system",content:S}),e.next=44;break;case 40:throw e.prev=40,e.t6=e.catch(33),console.error("Error compiling or executing Handlebars template for lorebook definitions:",e.t6),new Error("Error compiling or executing Handlebars template for lorebook definitions: ".concat(e.t6.message));case 44:if(a.existingFields&&s.fields&&Object.keys(s.fields).length>0){C="=== CURRENT CHARACTER FIELD VALUES ===\n",A=Gt(Kt);try{for(A.s();!(_=A.n()).done;)P=_.value,k=s.fields[P],(P!==h||null!=k&&k.value&&""!==k.value.trim())&&(C+="- ".concat(P,": ").concat((null==k?void 0:k.value)||"*Not filled*","\n"))}catch(e){A.e(e)}finally{A.f()}g.push({role:"system",content:C})}return g.push({role:"system",content:"=== RESPONSE FORMAT INSTRUCTIONS ===\n".concat(u.formatDescription)}),N='Your task is to generate the content for the "'.concat(h,'" field of a character card.'),N+=" Base your response on the chat history, persona (if provided), existing field values (if provided), context from other characters (if provided), and context from relevant lorebooks (if provided).",null!=(I=s.fields[h])&&I.prompt&&(N+="\n\nField-specific instructions: ".concat(I.prompt)),m&&(N+="\n\nFollow these specific instructions: ".concat(m)),g.push({role:"user",content:N}),e.next=54,zt.ConnectionManagerRequestService.sendRequest(r,g,d);case 54:return T=e.sent,O=Rt(T.content,p),e.abrupt("return",O);case 57:case"end":return e.stop()}}),e,null,[[21,28],[33,40]])})),Qt=function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function a(e){Jt(i,r,o,a,s,"next",e)}function s(e){Jt(i,r,o,a,s,"throw",e)}a(void 0)}))},Qt.apply(this,arguments)}var en='=======\n\nWhen creating a **character card** in SillyTavern, you can define a structured profile to guide the AI\'s behavior and ensure consistency in roleplay or storytelling. Below are the common fields and their purposes, based on community templates and best practices:\n\n---\n\n### **1. Name**\n**Purpose**:\nThe characters primary identifier. The AI uses this to reference the character in dialogue and narration.\n**Key Tips**:\n- Use a memorable name that reflects their role (e.g., "Zara the Shadowblade" implies stealth/combat).\n- Avoid overly complex or ambiguous names (e.g., "Xylthraa" may confuse the AI).\n**Example**:\n`"Seraphina Vale"` (Elegant, hints at nobility) vs. `"Rusty"` (Casual, rugged).\n\n---\n\n### **2. Description**\n**Purpose**:\nA snapshot of the characters identity, combining **appearance**, **personality**, and **key traits** to guide the AIs "mental image."\n**Structure**:\n- **Appearance**: Physical traits (e.g., scars, clothing, species).\n- **Personality**: Core demeanor (e.g., stoic, playful).\n- **Mannerisms**: Unique habits (e.g., "taps fingers when lying").\n**Example**:\n> *"A hulking orc with moss-green skin and a chipped tusk, wearing a patchwork cloak. Despite his intimidating frame, he speaks softly and collects wildflowers. Secretly fears fire."*\n**Tips**:\n- Use vivid, concise language.\n- Prioritize traits critical to roleplay (e.g., "blind in one eye" affects interactions).\n\n---\n\n### **3. Personality**\n**Purpose**:\nExplicitly defines **how the character thinks/behaves**, reducing ambiguity for the AI.\n**What to Include**:\n- Core traits (e.g., "optimistic", "paranoid").\n- Motivations (e.g., "seeks revenge against the crown").\n- Flaws (e.g., "impulsive", "overly trusting").\n**Example**:\n`"Charismatic but manipulative; values loyalty only when it benefits him. Haunted by guilt over a failed rescue mission."`\n**Tips**:\n- Use bullet points or short phrases for clarity.\n- Avoid contradictions (e.g., "shy" vs. "loves public speaking").\n\n---\n\n### **4. Scenario**\n**Purpose**:\nSets the stage for the interaction, providing **contextual boundaries** for the AI.\n**What to Include**:\n- **Location**: Where the scene takes place (e.g., "a smoky tavern").\n- **Time**: Era or time-sensitive context (e.g., "during a solar eclipse").\n- **Relationship**: Predefined ties to the user (e.g., "childhood rivals reunited").\n**Example**:\n`"A cyberpunk night market in 2147. {{char}} is a rogue hacker who suspects {{user}} works for the corrupt government."`\n**Tips**:\n- Use dynamic placeholders like `{{user}}` to personalize the scenario.\n\n---\n\n### **5. First Message**\n**Purpose**:\nThe characters **opening line**, critical for establishing tone, voice, and narrative momentum.\n**Key Elements**:\n- **Dialogue**: Shows speech style (formal, slang-heavy).\n- **Actions**: Subtle body language (e.g., "crosses arms skeptically").\n- **Hook**: Encourages user engagement (e.g., a question or mystery).\n**Example**:\n`*{{char}} adjusts her gas mask, voice muffled.* "Youre the third outsider this week. What makes you think youll survive the Wastes?"`\n**Tips**:\n- Avoid passive openings (e.g., "Hello, how can I help you?").\n- Mirror the characters personality (e.g., a shy character might stammer).\n\n---\n\n### **6. Example Dialogue**\n**Purpose**:\nTeaches the AI the characters **speech patterns**, **formatting preferences**, and **interaction style**.\n**Structure**:\n- Use `{{char}}` and `{{user}}` placeholders.\n- Mix dialogue and actions (e.g., `*{{char}} smirks.* "Youre bold. I like that."`).\n- Show range (e.g., anger, sarcasm, vulnerability).\n**Example**:\n```\n{{user}}: Why should I trust you?\n{{char}}: *Pulls a dagger from her boot and twirls it.* "You shouldnt. But Im your only way out of this alive."\n```\n**Tips**:\n- Include 35 varied exchanges.\n- Match the characters voice (e.g., a poet might use metaphors).\n\n---\n\n### **Advanced Tips**\n- **Avoid "Wall of Text"**: Use line breaks and punctuation to improve readability for the AI.\n\n---\n\n### **Example Character Card Snippet**\n```json\n{\n  "name": "Kael Stormveil",\n  "description": "A storm sorcerer with crackling electricity in his eyes. Wears a cloak woven from thunderclouds. Pragmatic to a fault, but secretly fears losing control of his powers.",\n  "personality": "Analytical, blunt, distrusts authority. Motto: \'Chaosis just order waiting to be deciphered.\'",\n  "scenario": "A floating library during a magical hurricane. {{user}} is a novice mage Kael reluctantly mentors.",\n  "first_message": "*Kaels hands spark as he slams a tome shut.* Youve got five minutes to explain why I shouldnt toss you into the storm.",\n  "example_dialogue": "{{user}}: Can you teach me to control the storm?\n{{char}}: *Snorts.* Control is an illusion. You ride the storm or drown."\n}\n```\n\n=======',tn="## Selected Characters for Context\n{{#each characters}}\n### {{this.name}}\n{{#if this.description}}\n#### Description\n{{this.description}}\n{{/if}}\n{{#if this.personality}}\n#### Personality\n{{this.personality}}\n{{/if}}\n{{#if this.scenario}}\n#### Scenario\n{{this.scenario}}\n{{/if}}\n{{#if this.first_mes}}\n#### First Message\n{{this.first_mes}}\n{{/if}}\n{{#if this.mes_example}}\n#### Example Dialogue\n{{this.mes_example}}\n{{/if}}\n\n{{/each}}",nn="You MUST provide your response wrapped ONLY in a single <response> XML tag.\n\nWhen providing code in your response, wrap it in triple backticks:\n\nExample:\n```\n<response>Generated content for the field goes here.</response>\n```",rn='You MUST provide your response as a JSON object with a single key "response" containing the generated content as a string.\n\nWhen providing code in your response, wrap it in triple backticks:\n\nExample:\n```\n{\n  "response": "Generated content for the field goes here."\n}\n```',on="You MUST provide ONLY the raw text content for the field, without any formatting, XML tags, JSON structure, or explanatory text. Just the content itself.\n\nWhen providing code in your response, wrap it in triple backticks:\n\nExample:\n```\nGenerated content for the field goes here.\n```",an="## Selected Lorebooks for Context\n{{#each lorebooks}}\n### {{@key}}\n  {{#each this as |entry|}}\n#### {{#if entry.comment}}{{entry.comment}}{{else}}*No title*{{/if}}\nTriggers: {{#if entry.key}}{{join entry.key ', '}}{{else}}*No triggers*{{/if}}\nContent: {{#if entry.content}}{{entry.content}}{{else}}*No content*{{/if}}\n\n  {{/each}}\n\n\n{{/each}}",sn="### {{character.name}}\n- **Description:** {{#if character.description}}{{character.description}}{{else}}*Not provided*{{/if}}\n- **Personality:** {{#if character.personality}}{{character.personality}}{{else}}*Not provided*{{/if}}\n- **Scenario:** {{#if character.scenario}}{{character.scenario}}{{else}}*Not provided*{{/if}}\n- **First Message:** {{#if character.first_mes}}{{character.first_mes}}{{else}}*Not provided*{{/if}}\n- **Example Dialogue:**\n  {{#if character.mes_example}}{{character.mes_example}}{{else}}*Not provided*{{/if}}",cn="SillyTavern-Character-Creator",ln={version:"0.1.2",formatVersion:"F_1.0",profileId:"",maxContextType:"profile",maxContextValue:16384,maxResponseToken:1024,outputFormat:"xml",contextToSend:{stDescription:!0,messages:{type:"last",first:10,last:10,range:{start:0,end:10}},charCard:!0,existingFields:!0,worldInfo:!0},stCharCardPrompt:en,usingDefaultStCharCardPrompt:!0,charCardDefinitionPrompt:tn,usingDefaultCharCardDefinitionPrompt:!0,lorebookDefinitionPrompt:an,usingDefaultLorebookDefinitionPrompt:!0,xmlFormatDesc:nn,usingDefaultXmlFormatDesc:!0,jsonFormatDesc:rn,usingDefaultJsonFormatDesc:!0,noneFormatDesc:on,usingDefaultNoneFormatDesc:!0,promptPreset:"default",promptPresets:{default:{content:"Generate the field content based on the chat history and existing character details. Be creative but consistent."}},showSaveAsWorldInfoEntry:{show:!1,characterDefinitionPrompt:sn,usingDefaultCharacterDefinitionPrompt:!0}},un=new class{settingsKey;defaultSettings;constructor(e,t){this.settingsKey=e,this.defaultSettings=t}async initializeSettings(e={}){const{strategy:t="recursive"}=e,n=this.defaultSettings.version,r=this.defaultSettings.formatVersion,o=SillyTavern.getContext().extensionSettings[this.settingsKey],i={version:{changed:!1,new:n??""},formatVersion:{changed:!1,new:r??""},oldSettings:null,newSettings:this.defaultSettings};if(!o)return SillyTavern.getContext().extensionSettings[this.settingsKey]=this.defaultSettings,this.saveSettings(),i;const a={...i,oldSettings:structuredClone(o),version:{changed:!1,old:o.version,new:o.version},formatVersion:{changed:!1,old:o.formatVersion,new:o.formatVersion}};if("recursive"===t){function s(e,t){let n=!1;for(const r of Object.keys(t))void 0===e[r]?(e[r]=t[r],n=!0):"object"==typeof t[r]&&null!==t[r]&&(e[r]=e[r]||{},s(e[r],t[r])&&(n=!0));return n}n&&o.version!==n&&(a.version.changed=!0,a.version.new=n,o.version=n),r&&o.formatVersion!==r&&(a.formatVersion.changed=!0,a.formatVersion.new=r,o.formatVersion=r),(s(o,this.defaultSettings)||a.version.changed||a.formatVersion.changed)&&this.saveSettings()}else if(Array.isArray(t)){n&&!o.version&&(o.version=n,a.version.changed=!0,a.version.new=n),r&&!o.formatVersion&&(o.formatVersion=r,a.formatVersion.changed=!0,a.formatVersion.new=r);let c=structuredClone(o),l=o.formatVersion;try{for(const u of t)if(l===u.from){c=await u.action(c),l=u.to,c.formatVersion=u.to;const d=this.defaultSettings.version;d&&(c.version=d),a.formatVersion.changed=!0,a.formatVersion.new=u.to}if(a.formatVersion.changed){Object.assign(o,c);for(const h of Object.keys(o))Object.keys(c).includes(h)||delete o[h];this.saveSettings()}}catch(p){throw console.error("Failed to apply version changes:",p),new Error(`Version migration failed: ${p instanceof Error?p.message:p}`,{cause:p})}}return a.newSettings=o,a}getSettings(){return SillyTavern.getContext().extensionSettings[this.settingsKey]}updateSetting(e,t){SillyTavern.getContext().extensionSettings[this.settingsKey][e]=t,this.saveSettings()}saveSettings(){SillyTavern.getContext().saveSettingsDebounced()}resetSettings(){SillyTavern.getContext().extensionSettings[this.settingsKey]=this.defaultSettings,this.saveSettings()}}("charCreator",ln);function dn(e){return dn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},dn(e)}function hn(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function pn(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?hn(Object(n),!0).forEach((function(t){fn(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):hn(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function fn(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=dn(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=dn(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==dn(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function mn(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,i,a,s=[],c=!0,l=!1;try{if(i=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;c=!1}else for(;!(c=(r=i.call(n)).done)&&(s.push(r.value),s.length!==t);c=!0);}catch(e){l=!0,o=e}finally{try{if(!c&&null!=n.return&&(a=n.return(),Object(a)!==a))return}finally{if(l)throw o}}return s}}(e,t)||function(e,t){if(e){if("string"==typeof e)return gn(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?gn(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function gn(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function vn(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */vn=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,o=Object.defineProperty||function(e,t,n){e[t]=n.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function l(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,n){return e[t]=n}}function u(e,t,n,r){var i=t&&t.prototype instanceof v?t:v,a=Object.create(i.prototype),s=new I(r||[]);return o(a,"_invoke",{value:_(e,n,s)}),a}function d(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var h="suspendedStart",p="suspendedYield",f="executing",m="completed",g={};function v(){}function y(){}function x(){}var b={};l(b,a,(function(){return this}));var w=Object.getPrototypeOf,E=w&&w(w(T([])));E&&E!==n&&r.call(E,a)&&(b=E);var S=x.prototype=v.prototype=Object.create(b);function C(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function A(e,t){function n(o,i,a,s){var c=d(e[o],e,i);if("throw"!==c.type){var l=c.arg,u=l.value;return u&&"object"==dn(u)&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,a,s)}),(function(e){n("throw",e,a,s)})):t.resolve(u).then((function(e){l.value=e,a(l)}),(function(e){return n("throw",e,a,s)}))}s(c.arg)}var i;o(this,"_invoke",{value:function(e,r){function o(){return new t((function(t,o){n(e,r,t,o)}))}return i=i?i.then(o,o):o()}})}function _(t,n,r){var o=h;return function(i,a){if(o===f)throw Error("Generator is already running");if(o===m){if("throw"===i)throw a;return{value:e,done:!0}}for(r.method=i,r.arg=a;;){var s=r.delegate;if(s){var c=P(s,r);if(c){if(c===g)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===h)throw o=m,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=f;var l=d(t,n,r);if("normal"===l.type){if(o=r.done?m:p,l.arg===g)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(o=m,r.method="throw",r.arg=l.arg)}}}function P(t,n){var r=n.method,o=t.iterator[r];if(o===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,P(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),g;var i=d(o,t.iterator,n.arg);if("throw"===i.type)return n.method="throw",n.arg=i.arg,n.delegate=null,g;var a=i.arg;return a?a.done?(n[t.resultName]=a.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,g):a:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,g)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function N(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function I(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function T(t){if(t||""===t){var n=t[a];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,i=function n(){for(;++o<t.length;)if(r.call(t,o))return n.value=t[o],n.done=!1,n;return n.value=e,n.done=!0,n};return i.next=i}}throw new TypeError(dn(t)+" is not iterable")}return y.prototype=x,o(S,"constructor",{value:x,configurable:!0}),o(x,"constructor",{value:y,configurable:!0}),y.displayName=l(x,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,x):(e.__proto__=x,l(e,c,"GeneratorFunction")),e.prototype=Object.create(S),e},t.awrap=function(e){return{__await:e}},C(A.prototype),l(A.prototype,s,(function(){return this})),t.AsyncIterator=A,t.async=function(e,n,r,o,i){void 0===i&&(i=Promise);var a=new A(u(e,n,r,o),i);return t.isGeneratorFunction(n)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},C(S),l(S,c,"Generator"),l(S,a,(function(){return this})),l(S,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=T,I.prototype={constructor:I,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(N),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function o(r,o){return s.type="throw",s.arg=t,n.next=r,o&&(n.method="next",n.arg=e),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var c=r.call(a,"catchLoc"),l=r.call(a,"finallyLoc");if(c&&l){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=e,a.arg=t,i?(this.method="next",this.next=i.finallyLoc,g):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),N(n),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;N(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:T(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),g}},t}function yn(e,t,n,r,o,i,a){try{var s=e[i](a),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,o)}function xn(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function a(e){yn(i,r,o,a,s,"next",e)}function s(e){yn(i,r,o,a,s,"throw",e)}a(void 0)}))}}function bn(){return(bn=xn(vn().mark((function e(){var t,n,r,o,i,a,s,c;return vn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,zt.renderExtensionTemplateAsync("third-party/".concat(cn),"templates/settings");case 2:if(t=e.sent,$("#extensions_settings").append(t),n=document.querySelector(".charCreator_settings")){e.next=7;break}return e.abrupt("return");case 7:r=un.getSettings(),o=function(e,t,o,i){var a=n.querySelector(".".concat(e));if(a){var s=a.querySelector("textarea"),c=a.querySelector(".restore_default");s.value=String(r[t]),c.addEventListener("click",xn(vn().mark((function e(){var t;return vn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,zt.Popup.show.confirm("Character Creator",'Are you sure you want to restore the default for "'.concat(null===(t=a.querySelector("span"))||void 0===t?void 0:t.textContent,'"?'));case 2:e.sent&&(s.value=o,s.dispatchEvent(new Event("change")));case 4:case"end":return e.stop()}}),e)})))),s.addEventListener("change",(function(){r[t]=s.value,r[i]=s.value===o,un.saveSettings()}))}},o("stCharCardPrompt","stCharCardPrompt",en,"usingDefaultStCharCardPrompt"),o("charCardDefinitionPrompt","charCardDefinitionPrompt",tn,"usingDefaultCharCardDefinitionPrompt"),o("lorebookDefinitionPrompt","lorebookDefinitionPrompt",an,"usingDefaultLorebookDefinitionPrompt"),o("xmlFormatDesc","xmlFormatDesc",nn,"usingDefaultXmlFormatDesc"),o("jsonFormatDesc","jsonFormatDesc",rn,"usingDefaultJsonFormatDesc"),o("noneFormatDesc","noneFormatDesc",on,"usingDefaultNoneFormatDesc"),(i=n.querySelector("#charCreator_showSaveAsWorldInfo"))&&(i.checked=r.showSaveAsWorldInfoEntry.show,i.addEventListener("change",(function(){r.showSaveAsWorldInfoEntry.show=i.checked,un.saveSettings()}))),(a=n.querySelector(".worldInfoCharacterDefinition"))&&(s=a.querySelector("textarea"),c=a.querySelector(".restore_default"),s.value=r.showSaveAsWorldInfoEntry.characterDefinitionPrompt,c.addEventListener("click",xn(vn().mark((function e(){return vn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,zt.Popup.show.confirm("Character Creator","Are you sure you want to restore the default World Info Character Definition template?");case 2:e.sent&&(s.value=sn,s.dispatchEvent(new Event("change")));case 4:case"end":return e.stop()}}),e)})))),s.addEventListener("change",(function(){r.showSaveAsWorldInfoEntry.characterDefinitionPrompt=s.value,r.showSaveAsWorldInfoEntry.usingDefaultCharacterDefinitionPrompt=s.value===sn,un.saveSettings()})));case 19:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function wn(){return wn=xn(vn().mark((function e(){var t;return vn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t='<div class="menu_button fa-solid fa-user-astronaut interactable charCreator-icon" title="Character Creator"></div>',$(".form_create_bottom_buttons_block").prepend(t),$("#GroupFavDelOkBack").prepend(t),$("#form_character_search_form").prepend(t),document.querySelectorAll(".charCreator-icon").forEach((function(e){e.addEventListener("click",xn(vn().mark((function e(){var t,n,r,o,i,a,s,c,l,u,d,h,p,m,g,v,y,x,b,w,E,S,C,A,_,P,k,N,I,T,O,D,F,L,M,j,B,$,R,V,q,W,G,U,H,X,Y,J,z;return vn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,zt.renderExtensionTemplateAsync("third-party/".concat(cn),"templates/popup");case 2:if(u=e.sent,zt.callGenericPopup(u,_e.DISPLAY,void 0,{large:!0,wide:!0}),d=document.getElementById("charCreatorPopup")){e.next=7;break}return e.abrupt("return");case 7:h=un.getSettings(),zt.ConnectionManagerRequestService.handleDropdown("#charCreatorPopup #charCreator_connectionProfile",h.profileId,(function(e){var t;h.profileId=null!==(t=null==e?void 0:e.id)&&void 0!==t?t:"",un.saveSettings()})),p=d.querySelector("#charCreator_stDescription"),m=d.querySelector("#charCreator_includeChars"),g=d.querySelector("#charCreator_charIncludeContainer"),v=d.querySelector("#charCreator_includeWorldInfo"),y=d.querySelector("#charCreator_worldInfoIncludeContainer"),x=d.querySelector("#charCreator_includeExistingFields"),p.checked=h.contextToSend.stDescription,m.checked=h.contextToSend.charCard,x.checked=h.contextToSend.existingFields,v.checked=h.contextToSend.worldInfo,g.style.display=m.checked?"block":"none",y.style.display=v.checked?"block":"none",p.addEventListener("change",(function(){h.contextToSend.stDescription=p.checked,un.saveSettings()})),m.addEventListener("change",(function(){h.contextToSend.charCard=m.checked,g.style.display=m.checked?"block":"none",un.saveSettings()})),v.addEventListener("change",(function(){h.contextToSend.worldInfo=v.checked,y.style.display=v.checked?"block":"none",un.saveSettings()})),x.addEventListener("change",(function(){h.contextToSend.existingFields=x.checked,un.saveSettings()})),b=d.querySelector(".message-options"),w=d.querySelector("#charCreator_messageType"),E=d.querySelector("#charCreator_firstX"),S=d.querySelector("#charCreator_lastX"),C=d.querySelector("#charCreator_rangeX"),A=d.querySelector("#charCreator_firstXMessages"),_=d.querySelector("#charCreator_lastXMessages"),P=d.querySelector("#charCreator_rangeStart"),k=d.querySelector("#charCreator_rangeEnd"),w.value=h.contextToSend.messages.type,A.value=String(null!==(t=h.contextToSend.messages.first)&&void 0!==t?t:10),_.value=String(null!==(n=h.contextToSend.messages.last)&&void 0!==n?n:10),P.value=String(null!==(r=null===(o=h.contextToSend.messages.range)||void 0===o?void 0:o.start)&&void 0!==r?r:0),k.value=String(null!==(i=null===(a=h.contextToSend.messages.range)||void 0===a?void 0:a.end)&&void 0!==i?i:10),(N=function(e){E.style.display="first"===e?"block":"none",S.style.display="last"===e?"block":"none",C.style.display="range"===e?"block":"none"})(w.value),"none"!==h.contextToSend.messages.type||void 0!==ce.this_chid||fe.selected_group||(b.style.display="none"),w.addEventListener("change",(function(){var e=w.value;h.contextToSend.messages.type=e,un.saveSettings(),N(e)})),A.addEventListener("change",(function(){h.contextToSend.messages.first=parseInt(A.value)||10,un.saveSettings()})),_.addEventListener("change",(function(){h.contextToSend.messages.last=parseInt(_.value)||10,un.saveSettings()})),P.addEventListener("change",(function(){var e,t;h.contextToSend.messages.range={start:parseInt(P.value)||0,end:null!==(e=null===(t=h.contextToSend.messages.range)||void 0===t?void 0:t.end)&&void 0!==e?e:10},un.saveSettings()})),k.addEventListener("change",(function(){var e,t;h.contextToSend.messages.range={start:null!==(e=null===(t=h.contextToSend.messages.range)||void 0===t?void 0:t.start)&&void 0!==e?e:0,end:parseInt(k.value)||10},un.saveSettings()})),I=d.querySelector("#charCreator_maxContextType"),T=d.querySelector("#charCreator_maxTokens_container"),O=d.querySelector("#charCreator_maxTokens"),I.value=h.maxContextType,T.style.display="custom"===h.maxContextType?"block":"none",O.value=String(h.maxContextValue),I.addEventListener("change",(function(){var e=I.value;h.maxContextType=e,un.saveSettings(),T.style.display="custom"===e?"block":"none"})),O.addEventListener("change",(function(){h.maxContextValue=Number(O.value)||16384,un.saveSettings()})),(D=d.querySelector("#charCreator_maxResponseTokens")).value=String(h.maxResponseToken),D.addEventListener("change",(function(){h.maxResponseToken=Number(D.value)||1024,un.saveSettings()})),(F=d.querySelector("#charCreator_outputFormat")).value=h.outputFormat,F.addEventListener("change",(function(){h.outputFormat=F.value,un.saveSettings()})),L="charCreator",(M=JSON.parse(null!==(s=localStorage.getItem(L))&&void 0!==s?s:"{}")).selectedCharacterIndexes||(M.selectedCharacterIndexes=ce.this_chid?[ce.this_chid]:[]),M.selectedWorldNames||(M.selectedWorldNames=[]),M.fields||(M.fields={}),Kt.forEach((function(e){M.fields[e]||(M.fields[e]={value:"",prompt:""})})),j=function(){localStorage.setItem(L,JSON.stringify(M))},B=SillyTavern.getContext(),M.selectedCharacterIndexes=M.selectedCharacterIndexes.filter((function(e){return B.characters[Number(e)]})),d.querySelector("#charCreator_characterSelector")&&ae("#charCreator_characterSelector",{initialList:$=B.characters.map((function(e){return{value:B.characters.indexOf(e).toString(),label:e.name}})),initialValues:M.selectedCharacterIndexes,placeholderText:"Select characters...",enableSearch:$.length>10,onSelectChange:function(e,t){M.selectedCharacterIndexes=t,j()}}),R=d.querySelector("#charCreator_worldInfoSelector"),V=structuredClone(le.world_names);try{R&&V.length>0?ae("#charCreator_worldInfoSelector",{initialList:V,initialValues:M.selectedWorldNames,placeholderText:"Select lorebooks...",enableSearch:V.length>10,onSelectChange:function(e,t){M.selectedWorldNames=t,j()}}):R&&(R.textContent="No active lorebooks found.")}catch(e){console.error("Failed to get active world info:",e),R&&(R.textContent="Error loading lorebooks.")}q=d.querySelector("#charCreator_prompt"),Se("#charCreatorPopup #charCreator_promptPreset",{label:"instructionPreset",initialValue:h.promptPreset,initialList:Object.keys(h.promptPresets),readOnlyValues:["default"],onSelectChange:function(){var e=xn(vn().mark((function e(t,n){var r,o,i;return vn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=null!=n?n:"default",h.promptPreset=i,un.saveSettings(),q.value=null!==(r=null===(o=h.promptPresets[i])||void 0===o?void 0:o.content)&&void 0!==r?r:"";case 4:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),create:{onAfterCreate:function(e){var t,n=h.promptPresets[h.promptPreset];h.promptPresets[e]={content:null!==(t=null==n?void 0:n.content)&&void 0!==t?t:""}}},rename:{onAfterRename:function(e,t){h.promptPresets[t]=h.promptPresets[e],delete h.promptPresets[e]}},delete:{onAfterDelete:function(e){delete h.promptPresets[e]}}}),q.value=null!==(c=null===(l=h.promptPresets[h.promptPreset])||void 0===l?void 0:l.content)&&void 0!==c?c:"",q.addEventListener("change",(function(){h.promptPresets[h.promptPreset]&&(h.promptPresets[h.promptPreset].content=q.value,un.saveSettings())})),W={name:{label:"Name",rows:1,large:!1,promptEnabled:!1},description:{label:"Description",rows:5,large:!0,promptEnabled:!0},personality:{label:"Personality",rows:4,large:!0,promptEnabled:!0},scenario:{label:"Scenario",rows:3,large:!0,promptEnabled:!0},first_mes:{label:"First Message",rows:3,large:!0,promptEnabled:!0},mes_example:{label:"Example Dialogue",rows:6,large:!0,promptEnabled:!0}},G=d.querySelector("#charCreator_fieldTemplate"),U=d.querySelector("#charCreator_fieldsContainer"),H={},G&&U&&Kt.forEach((function(e){var t=W[e],n=G.content.cloneNode(!0),r=n.querySelector(".character-field"),o=n.querySelector("label"),i=n.querySelector(".field-container textarea"),a=n.querySelector(".generate-field-button"),s=n.querySelector(".field-prompt-container textarea");if(r&&o&&i&&a&&s){var c,l,u,d,h,p;if(i.id="charCreator_field_".concat(e),s.id="charCreator_prompt_".concat(e),o.dataset.for=i.id,o.textContent=t.label,i.rows=t.rows,i.value=null!==(c=null===(l=M.fields[e])||void 0===l?void 0:l.value)&&void 0!==c?c:"",a.dataset.field=e,a.title="Generate ".concat(t.label),s.placeholder="Enter addiitonal prompt for ".concat(t.label.toLowerCase(),"..."),s.value=null!==(u=null===(d=M.fields[e])||void 0===d?void 0:d.prompt)&&void 0!==u?u:"",!t.promptEnabled)null===(h=s.closest(".field-prompt-container"))||void 0===h||h.remove();if(t.large)null===(p=i.closest(".field-container"))||void 0===p||p.classList.add("large-field");H[e]={textarea:i,button:a,promptTextarea:s}}U.appendChild(n)})),d.querySelector("#charCreator_loadCharSelector")&&ae("#charCreator_loadCharSelector",{initialList:X=B.characters.map((function(e){return{value:B.characters.indexOf(e).toString(),label:e.name}})),initialValues:[],placeholderText:"Load Character Data...",enableSearch:X.length>10,multiple:!1,closeOnSelect:!0,onBeforeSelection:function(e,t){return xn(vn().mark((function e(){return vn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==t.length){e.next=2;break}return e.abrupt("return",!1);case 2:if(0!==t[0].length){e.next=5;break}return e.abrupt("return",!1);case 5:if(Kt.every((function(e){var t,n=null===(t=H[e])||void 0===t?void 0:t.textarea;return n&&""===n.value.trim()}))){e.next=12;break}return e.next=9,zt.Popup.show.confirm("Load Character Data","Are you sure you want to overwrite existing data? This cannot be undone.");case 9:if(e.sent){e.next=12;break}return e.abrupt("return",!1);case 12:return e.abrupt("return",!0);case 13:case"end":return e.stop()}}),e)})))()},onSelectChange:function(){var e=xn(vn().mark((function e(t,n){var r,o;return vn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==n.length){e.next=2;break}return e.abrupt("return");case 2:if(0!==(r=n[0]).length){e.next=5;break}return e.abrupt("return");case 5:if(o=B.characters[parseInt(r)]){e.next=9;break}return ge("warning","Selected character not found."),e.abrupt("return");case 9:Kt.forEach((function(e){var t,n,r,i=null===(t=H[e])||void 0===t?void 0:t.textarea,a=null===(n=H[e])||void 0===n?void 0:n.promptTextarea;i&&(i.value=null!==(r=o[e])&&void 0!==r?r:"",i.dispatchEvent(new Event("change")));a&&""!==a.value.trim()&&(a.value="",a.dispatchEvent(new Event("change")))}));case 10:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()}),d.querySelector("#charCreator_reset").addEventListener("click",xn(vn().mark((function e(){return vn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,zt.Popup.show.confirm("Reset Fields","Are you sure you want to reset all fields? This cannot be undone.");case 2:e.sent&&Kt.forEach((function(e){var t,n;null!==(t=H[e])&&void 0!==t&&t.textarea&&(H[e].textarea.value="",H[e].textarea.dispatchEvent(new Event("change"))),null!==(n=H[e])&&void 0!==n&&n.promptTextarea&&(H[e].promptTextarea.value="",H[e].promptTextarea.dispatchEvent(new Event("change")))}));case 4:case"end":return e.stop()}}),e)})))),d.querySelector("#charCreator_saveAsNewCharacter").addEventListener("click",xn(vn().mark((function e(){var t;return vn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(M.fields.name.value){e.next=3;break}return ge("warning","Please enter a name for the new character."),e.abrupt("return");case 3:return e.next=5,zt.Popup.show.confirm("Save as New Character","Are you sure?");case 5:if(e.sent){e.next=8;break}return e.abrupt("return");case 8:return t={name:M.fields.name.value,description:M.fields.description.value,personality:M.fields.personality.value,scenario:M.fields.scenario.value,first_mes:M.fields.first_mes.value,mes_example:M.fields.mes_example.value,data:{name:M.fields.name.value,description:M.fields.description.value,personality:M.fields.personality.value,scenario:M.fields.scenario.value,first_mes:M.fields.first_mes.value,mes_example:M.fields.mes_example.value,tags:[],avatar:"none"},avatar:"none",tags:[],spec:"chara_card_v3",spec_version:"3.0"},e.prev=9,e.next=12,f(t,!0);case 12:e.next=17;break;case 14:e.prev=14,e.t0=e.catch(9),ge("error","Failed to create character: ".concat(e.t0.message));case 17:case"end":return e.stop()}}),e,null,[[9,14]])})))),Y=d.querySelector("#charCreator_saveAsWorldInfoSelector"),h.showSaveAsWorldInfoEntry.show?(J=ae(Y,{placeholderText:"Save as World Info Entry",initialList:le.world_names,closeOnSelect:!0,multiple:!1,enableSearch:!0,onBeforeSelection:function(e,t){return xn(vn().mark((function e(){var n,r,o,i,a;return vn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==t.length){e.next=2;break}return e.abrupt("return",!1);case 2:if((n={name:M.fields.name.value,description:M.fields.description.value,first_mes:M.fields.first_mes.value,scenario:M.fields.scenario.value,personality:M.fields.personality.value,mes_example:M.fields.mes_example.value,avatar:"none"}).name){e.next=7;break}return ge("warning","Please enter a name for the character."),z(),e.abrupt("return",!1);case 7:r="",e.prev=8,o=Vt.Handlebars.compile(h.showSaveAsWorldInfoEntry.characterDefinitionPrompt,{noEscape:!0}),r=o({character:n}),e.next=19;break;case 13:return e.prev=13,e.t0=e.catch(8),console.error("Failed to compile character definition prompt: ".concat(e.t0.message)),ge("error","Failed to compile character definition prompt: ".concat(e.t0.message)),z(),e.abrupt("return",!1);case 19:return i=t[0],a={uid:-1,key:[M.fields.name.value],content:r,comment:M.fields.name.value,disable:!1},e.prev=21,e.next=24,Ae({entry:a,selectedWorldName:i,operation:"add"});case 24:ge("success","Entry added"),e.next=30;break;case 27:e.prev=27,e.t1=e.catch(21),ge("error","Failed to create world info entry: ".concat(e.t1.message));case 30:return z(),e.abrupt("return",!1);case 32:case"end":return e.stop()}}),e,null,[[8,13],[21,27]])})))()}}),z=J.close):Y.style.display="none",Object.entries(H).forEach((function(e){var t=mn(e,2),n=t[0],r=t[1],o=r.textarea,i=r.button,a=r.promptTextarea;i&&(i.addEventListener("click",xn(vn().mark((function e(){var t,r,a,s,c,l,u,p,f,m,g,v,y,x,b,w,E,S,C,A;return vn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(f=n,i.disabled=!0,m=i.innerHTML,i.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i>',e.prev=4,v=d.querySelector("#charCreator_prompt").value,h.profileId){e.next=9;break}return ge("warning","Please select a connection profile."),e.abrupt("return");case 9:if(y=null===(g=B.extensionSettings.connectionManager)||void 0===g||null===(g=g.profiles)||void 0===g?void 0:g.find((function(e){return e.id===h.profileId}))){e.next=13;break}return ge("warning","Connection profile not found."),e.abrupt("return");case 13:x={presetName:null==y?void 0:y.preset,contextName:null==y?void 0:y.context,instructName:null==y?void 0:y.instruct,targetCharacterId:ce.this_chid,ignoreCharacterFields:!0,ignoreWorldInfo:!0,ignoreAuthorNote:!0,maxContext:"custom"===h.maxContextType?h.maxContextValue:"profile"===h.maxContextType?"preset":"active",includeNames:!!fe.selected_group},b=h.contextToSend.messages,e.t0=b.type,e.next="none"===e.t0?18:"first"===e.t0?20:"last"===e.t0?22:"range"===e.t0?26:(e.t0,28);break;case 18:return x.messageIndexesBetween={start:-1,end:-1},e.abrupt("break",29);case 20:return x.messageIndexesBetween={start:0,end:null!==(t=b.first)&&void 0!==t?t:10},e.abrupt("break",29);case 22:return w=null!==(r=null===(a=zt.chat)||void 0===a?void 0:a.length)&&void 0!==r?r:0,E=null!==(s=b.last)&&void 0!==s?s:10,x.messageIndexesBetween={end:Math.max(0,w-1),start:Math.max(0,w-E)},e.abrupt("break",29);case 26:return x.messageIndexesBetween={start:null!==(c=null===(l=b.range)||void 0===l?void 0:l.start)&&void 0!==c?c:0,end:null!==(u=null===(p=b.range)||void 0===p?void 0:p.end)&&void 0!==u?u:10},e.abrupt("break",29);case 28:return e.abrupt("break",29);case 29:void 0!==ce.this_chid||fe.selected_group||(x.messageIndexesBetween={start:-1,end:-1}),S="",e.t1=h.outputFormat,e.next="xml"===e.t1?34:"json"===e.t1?36:"none"===e.t1?38:40;break;case 34:return S=h.xmlFormatDesc,e.abrupt("break",40);case 36:return S=h.jsonFormatDesc,e.abrupt("break",40);case 38:return S=h.noneFormatDesc,e.abrupt("break",40);case 40:return C={},le.world_names.filter((function(e){return M.selectedWorldNames.includes(e)})).forEach(function(){var e=xn(vn().mark((function e(t){var n;return vn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,zt.loadWorldInfo(t);case 2:(n=e.sent)&&(C[t]=Object.values(n.entries));case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.next=44,Zt({profileId:h.profileId,userPrompt:v,buildPromptOptions:x,contextToSend:h.contextToSend,session:M,allCharacters:B.characters,entriesGroupByWorldName:C,promptSettings:{stCharCardPrompt:h.stCharCardPrompt,charCardDefinitionPrompt:h.charCardDefinitionPrompt,lorebookDefinitionPrompt:h.lorebookDefinitionPrompt,formatDescription:S},maxResponseToken:h.maxResponseToken,targetField:f,outputFormat:h.outputFormat});case 44:A=e.sent,o.value=A,o.dispatchEvent(new Event("change")),e.next=53;break;case 49:e.prev=49,e.t2=e.catch(4),console.error("Error generating field ".concat(f,":"),e.t2),ge("error","Failed to generate ".concat(f,": ").concat(e.t2.message||e.t2));case 53:return e.prev=53,i.disabled=!1,i.innerHTML=m,e.finish(53);case 57:case"end":return e.stop()}}),e,null,[[4,49,53,57]])})))),o.addEventListener("change",(function(){var e=n;M.fields[e]=pn(pn({},M.fields[e]),{},{value:o.value}),j()})),null==a||a.addEventListener("change",(function(){var e=n;M.fields[e]=pn(pn({},M.fields[e]),{},{prompt:a.value}),j()})))}));case 93:case"end":return e.stop()}}),e)}))))}));case 6:case"end":return e.stop()}}),e)}))),wn.apply(this,arguments)}function En(){!function(){bn.apply(this,arguments)}(),function(){wn.apply(this,arguments)}()}Vt.Handlebars.helpers.join||Vt.Handlebars.registerHelper("join",(function(e,t){return Array.isArray(e)?e.join("string"==typeof t?t:", "):""})),Vt.Handlebars.registerHelper("ifValue",(function(e,t){return e&&String(e).trim().length>0?t.fn(this):t.inverse(this)})),zt.ConnectionManagerRequestService?un.initializeSettings().then((function(e){if(e.version.changed){var t=un.getSettings(),n=!1,r=function(e,r,o){t[o]&&t[e]!==r&&(console.log("[".concat(cn,"] Updating default for ").concat(e)),t[e]=r,n=!0)};r("stCharCardPrompt",en,"usingDefaultStCharCardPrompt"),r("charCardDefinitionPrompt",tn,"usingDefaultCharCardDefinitionPrompt"),r("lorebookDefinitionPrompt",an,"usingDefaultLorebookDefinitionPrompt"),r("xmlFormatDesc",nn,"usingDefaultXmlFormatDesc"),r("jsonFormatDesc",rn,"usingDefaultJsonFormatDesc"),r("noneFormatDesc",on,"usingDefaultNoneFormatDesc"),t.showSaveAsWorldInfoEntry.usingDefaultCharacterDefinitionPrompt&&t.showSaveAsWorldInfoEntry.characterDefinitionPrompt!==sn&&(console.log("[".concat(cn,"] Updating default for World Info character definition template")),t.showSaveAsWorldInfoEntry.characterDefinitionPrompt=sn,n=!0),n&&(console.log("[".concat(cn,"] Saving updated default settings.")),un.saveSettings())}En()})).catch((function(e){console.error("[".concat(cn,"] Error initializing settings:"),e),ge("error","[".concat(cn,"] Failed to initialize settings: ").concat(e.message)),zt.Popup.show.confirm("[".concat(cn,"] Failed to load settings. This might be due to an update. Reset settings to default?"),"Extension Error").then((function(e){e&&(un.resetSettings(),ge("success","[".concat(cn,"] Settings reset. Reloading may be required.")),En())}))})):ge("error","[".concat(cn,"] Make sure you are on staging branch and staging is updated."));