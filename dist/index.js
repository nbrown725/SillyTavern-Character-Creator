import{persona_description_positions as e,renderStoryString as t}from"../../../../power-user.js";import{baseChatReplace as n,chat_metadata as r,depth_prompt_depth_default as o,depth_prompt_role_default as i,extension_prompt_types as a,getMaxContextSize as s,name1 as l,name2 as c,parseMesExamples as u,this_chid as p}from"../../../../../script.js";import{createWorldInfoEntry as d,wi_anchor_position as h,world_info_include_names as f,world_names as m}from"../../../../world-info.js";import{formatInstructModeExamples as g,formatInstructModeSystemPrompt as v}from"../../../../instruct-mode.js";import{appendFileContent as y}from"../../../../chats.js";import{formatWorldInfo as b,getPromptPosition as S,getPromptRole as w,prepareOpenAIMessages as x,setOpenAIMessageExamples as C,setOpenAIMessages as _}from"../../../../openai.js";import{metadata_keys as k}from"../../../../authors-note.js";import{getGroupDepthPrompts as E,selected_group as P}from"../../../../group-chats.js";import{getRegexedString as O,regex_placement as I}from"../../../regex/engine.js";import"../../../../utils.js";import"../../../../slash-commands/SlashCommandCommonEnumsProvider.js";import"../../../../slash-commands/SlashCommandEnumValue.js";var T,A,D={27:(e,t,n)=>{function r(e){return e&&e.__esModule?e:{default:e}}t.__esModule=!0,t.parseWithoutProcessing=c,t.parse=function(e,t){var n=c(e,t);return new i.default(t).accept(n)};var o=r(n(201)),i=r(n(915)),a=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(n(425)),s=n(849);t.parser=o.default;var l={};function c(e,t){return"Program"===e.type?e:(o.default.yy=l,l.locInfo=function(e){return new l.SourceLocation(t&&t.srcName,e)},o.default.parse(e))}s.extend(l,a)},97:(e,t,n)=>{t.__esModule=!0;var r=n(849);t.default=function(e){e.registerHelper("blockHelperMissing",function(t,n){var o=n.inverse,i=n.fn;if(!0===t)return i(this);if(!1===t||null==t)return o(this);if(r.isArray(t))return t.length>0?(n.ids&&(n.ids=[n.name]),e.helpers.each(t,n)):o(this);if(n.data&&n.ids){var a=r.createFrame(n.data);a.contextPath=r.appendContextPath(n.data.contextPath,n.name),n={data:a}}return i(t,n)})},e.exports=t.default},127:(e,t,n)=>{function r(e){return e&&e.__esModule?e:{default:e}}t.__esModule=!0,t.Compiler=l,t.precompile=function(e,t,n){if(null==e||"string"!=typeof e&&"Program"!==e.type)throw new o.default("You must pass a string or Handlebars AST to Handlebars.precompile. You passed "+e);"data"in(t=t||{})||(t.data=!0);t.compat&&(t.useDepths=!0);var r=n.parse(e,t),i=(new n.Compiler).compile(r,t);return(new n.JavaScriptCompiler).compile(i,t)},t.compile=function(e,t,n){void 0===t&&(t={});if(null==e||"string"!=typeof e&&"Program"!==e.type)throw new o.default("You must pass a string or Handlebars AST to Handlebars.compile. You passed "+e);"data"in(t=i.extend({},t))||(t.data=!0);t.compat&&(t.useDepths=!0);var r=void 0;function a(){var r=n.parse(e,t),o=(new n.Compiler).compile(r,t),i=(new n.JavaScriptCompiler).compile(o,t,void 0,!0);return n.template(i)}function s(e,t){return r||(r=a()),r.call(this,e,t)}return s._setup=function(e){return r||(r=a()),r._setup(e)},s._child=function(e,t,n,o){return r||(r=a()),r._child(e,t,n,o)},s};var o=r(n(769)),i=n(849),a=r(n(919)),s=[].slice;function l(){}function c(e,t){if(e===t)return!0;if(i.isArray(e)&&i.isArray(t)&&e.length===t.length){for(var n=0;n<e.length;n++)if(!c(e[n],t[n]))return!1;return!0}}function u(e){if(!e.path.parts){var t=e.path;e.path={type:"PathExpression",data:!1,depth:0,parts:[t.original+""],original:t.original+"",loc:t.loc}}}l.prototype={compiler:l,equals:function(e){var t=this.opcodes.length;if(e.opcodes.length!==t)return!1;for(var n=0;n<t;n++){var r=this.opcodes[n],o=e.opcodes[n];if(r.opcode!==o.opcode||!c(r.args,o.args))return!1}t=this.children.length;for(n=0;n<t;n++)if(!this.children[n].equals(e.children[n]))return!1;return!0},guid:0,compile:function(e,t){return this.sourceNode=[],this.opcodes=[],this.children=[],this.options=t,this.stringParams=t.stringParams,this.trackIds=t.trackIds,t.blockParams=t.blockParams||[],t.knownHelpers=i.extend(Object.create(null),{helperMissing:!0,blockHelperMissing:!0,each:!0,if:!0,unless:!0,with:!0,log:!0,lookup:!0},t.knownHelpers),this.accept(e)},compileProgram:function(e){var t=(new this.compiler).compile(e,this.options),n=this.guid++;return this.usePartial=this.usePartial||t.usePartial,this.children[n]=t,this.useDepths=this.useDepths||t.useDepths,n},accept:function(e){if(!this[e.type])throw new o.default("Unknown type: "+e.type,e);this.sourceNode.unshift(e);var t=this[e.type](e);return this.sourceNode.shift(),t},Program:function(e){this.options.blockParams.unshift(e.blockParams);for(var t=e.body,n=t.length,r=0;r<n;r++)this.accept(t[r]);return this.options.blockParams.shift(),this.isSimple=1===n,this.blockParams=e.blockParams?e.blockParams.length:0,this},BlockStatement:function(e){u(e);var t=e.program,n=e.inverse;t=t&&this.compileProgram(t),n=n&&this.compileProgram(n);var r=this.classifySexpr(e);"helper"===r?this.helperSexpr(e,t,n):"simple"===r?(this.simpleSexpr(e),this.opcode("pushProgram",t),this.opcode("pushProgram",n),this.opcode("emptyHash"),this.opcode("blockValue",e.path.original)):(this.ambiguousSexpr(e,t,n),this.opcode("pushProgram",t),this.opcode("pushProgram",n),this.opcode("emptyHash"),this.opcode("ambiguousBlockValue")),this.opcode("append")},DecoratorBlock:function(e){var t=e.program&&this.compileProgram(e.program),n=this.setupFullMustacheParams(e,t,void 0),r=e.path;this.useDecorators=!0,this.opcode("registerDecorator",n.length,r.original)},PartialStatement:function(e){this.usePartial=!0;var t=e.program;t&&(t=this.compileProgram(e.program));var n=e.params;if(n.length>1)throw new o.default("Unsupported number of partial arguments: "+n.length,e);n.length||(this.options.explicitPartialContext?this.opcode("pushLiteral","undefined"):n.push({type:"PathExpression",parts:[],depth:0}));var r=e.name.original,i="SubExpression"===e.name.type;i&&this.accept(e.name),this.setupFullMustacheParams(e,t,void 0,!0);var a=e.indent||"";this.options.preventIndent&&a&&(this.opcode("appendContent",a),a=""),this.opcode("invokePartial",i,r,a),this.opcode("append")},PartialBlockStatement:function(e){this.PartialStatement(e)},MustacheStatement:function(e){this.SubExpression(e),e.escaped&&!this.options.noEscape?this.opcode("appendEscaped"):this.opcode("append")},Decorator:function(e){this.DecoratorBlock(e)},ContentStatement:function(e){e.value&&this.opcode("appendContent",e.value)},CommentStatement:function(){},SubExpression:function(e){u(e);var t=this.classifySexpr(e);"simple"===t?this.simpleSexpr(e):"helper"===t?this.helperSexpr(e):this.ambiguousSexpr(e)},ambiguousSexpr:function(e,t,n){var r=e.path,o=r.parts[0],i=null!=t||null!=n;this.opcode("getContext",r.depth),this.opcode("pushProgram",t),this.opcode("pushProgram",n),r.strict=!0,this.accept(r),this.opcode("invokeAmbiguous",o,i)},simpleSexpr:function(e){var t=e.path;t.strict=!0,this.accept(t),this.opcode("resolvePossibleLambda")},helperSexpr:function(e,t,n){var r=this.setupFullMustacheParams(e,t,n),i=e.path,s=i.parts[0];if(this.options.knownHelpers[s])this.opcode("invokeKnownHelper",r.length,s);else{if(this.options.knownHelpersOnly)throw new o.default("You specified knownHelpersOnly, but used the unknown helper "+s,e);i.strict=!0,i.falsy=!0,this.accept(i),this.opcode("invokeHelper",r.length,i.original,a.default.helpers.simpleId(i))}},PathExpression:function(e){this.addDepth(e.depth),this.opcode("getContext",e.depth);var t=e.parts[0],n=a.default.helpers.scopedId(e),r=!e.depth&&!n&&this.blockParamIndex(t);r?this.opcode("lookupBlockParam",r,e.parts):t?e.data?(this.options.data=!0,this.opcode("lookupData",e.depth,e.parts,e.strict)):this.opcode("lookupOnContext",e.parts,e.falsy,e.strict,n):this.opcode("pushContext")},StringLiteral:function(e){this.opcode("pushString",e.value)},NumberLiteral:function(e){this.opcode("pushLiteral",e.value)},BooleanLiteral:function(e){this.opcode("pushLiteral",e.value)},UndefinedLiteral:function(){this.opcode("pushLiteral","undefined")},NullLiteral:function(){this.opcode("pushLiteral","null")},Hash:function(e){var t=e.pairs,n=0,r=t.length;for(this.opcode("pushHash");n<r;n++)this.pushParam(t[n].value);for(;n--;)this.opcode("assignToHash",t[n].key);this.opcode("popHash")},opcode:function(e){this.opcodes.push({opcode:e,args:s.call(arguments,1),loc:this.sourceNode[0].loc})},addDepth:function(e){e&&(this.useDepths=!0)},classifySexpr:function(e){var t=a.default.helpers.simpleId(e.path),n=t&&!!this.blockParamIndex(e.path.parts[0]),r=!n&&a.default.helpers.helperExpression(e),o=!n&&(r||t);if(o&&!r){var i=e.path.parts[0],s=this.options;s.knownHelpers[i]?r=!0:s.knownHelpersOnly&&(o=!1)}return r?"helper":o?"ambiguous":"simple"},pushParams:function(e){for(var t=0,n=e.length;t<n;t++)this.pushParam(e[t])},pushParam:function(e){var t=null!=e.value?e.value:e.original||"";if(this.stringParams)t.replace&&(t=t.replace(/^(\.?\.\/)*/g,"").replace(/\//g,".")),e.depth&&this.addDepth(e.depth),this.opcode("getContext",e.depth||0),this.opcode("pushStringParam",t,e.type),"SubExpression"===e.type&&this.accept(e);else{if(this.trackIds){var n=void 0;if(!e.parts||a.default.helpers.scopedId(e)||e.depth||(n=this.blockParamIndex(e.parts[0])),n){var r=e.parts.slice(1).join(".");this.opcode("pushId","BlockParam",n,r)}else(t=e.original||t).replace&&(t=t.replace(/^this(?:\.|$)/,"").replace(/^\.\//,"").replace(/^\.$/,"")),this.opcode("pushId",e.type,t)}this.accept(e)}},setupFullMustacheParams:function(e,t,n,r){var o=e.params;return this.pushParams(o),this.opcode("pushProgram",t),this.opcode("pushProgram",n),e.hash?this.accept(e.hash):this.opcode("emptyHash",r),o},blockParamIndex:function(e){for(var t=0,n=this.options.blockParams.length;t<n;t++){var r=this.options.blockParams[t],o=r&&i.indexOf(r,e);if(r&&o>=0)return[t,o]}}}},148:(e,t)=>{t.__esModule=!0,t.default=function(e){"object"!=typeof globalThis&&(Object.prototype.__defineGetter__("__magic__",function(){return this}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__);var t=globalThis.Handlebars;e.noConflict=function(){return globalThis.Handlebars===e&&(globalThis.Handlebars=t),e}},e.exports=t.default},149:(T,A,D)=>{async function N(e,t,{escapeHtml:n=!0}={}){await async function(e,...t){await SillyTavern.getContext().SlashCommandParser.commands[e].callback(...t)}("echo",{severity:e,escapeHtml:Boolean(n).toString()},t)}function F(e){return s(e)}function M(e,t){return u(e,t)}function L(e,t,r){return n(e,t,r)}function j(e,t,n){return g(e,t,n)}function B(e,t){return v(e,t)}function R(e,{customStoryString:n,customInstructSettings:r}={}){return t(e,{customStoryString:n,customInstructSettings:r})}function $(e){return w(e)}function H(){return{prompt:r[k.prompt],interval:r[k.interval],position:r[k.position],depth:r[k.depth],role:r[k.role]}}function q(e,t){return E(e,t)}function U({name2:e,charDescription:t,charPersonality:n,Scenario:r,worldInfoBefore:o,worldInfoAfter:i,bias:a,type:s,quietPrompt:l,quietImage:c,extensionPrompts:u,cyclePrompt:p,systemPromptOverride:d,jailbreakPromptOverride:h,personaDescription:f,messages:m,messageExamples:g},v){return x({name2:e,charDescription:t,charPersonality:n,Scenario:r,worldInfoBefore:o,worldInfoAfter:i,bias:a,type:s,quietPrompt:l,quietImage:c,cyclePrompt:p,systemPromptOverride:d,jailbreakPromptOverride:h,personaDescription:f,extensionPrompts:u,messages:m,messageExamples:g},v)}function Y(e){return _(e)}function V(e){return C(e)}function W(e,t,{characterOverride:n,isMarkdown:r,isPrompt:o,isEdit:i,depth:a}){return O(e,t,{characterOverride:n,isMarkdown:r,isPrompt:o,isEdit:i,depth:a})}async function G(e,t){return await y(e,t)}function X(e,{wiFormat:t}={}){return b(e,{wiFormat:t})}function K(e){return S(e)}function z(e,t){return d(e,t)}D.d(A,{p:()=>o,wL:()=>i,$O:()=>a,py:()=>l,iQ:()=>c,Dv:()=>e,gp:()=>I,Yb:()=>P,ku:()=>G,wn:()=>L,FB:()=>z,YC:()=>N,IW:()=>j,UO:()=>B,aC:()=>X,mz:()=>H,O0:()=>q,Rg:()=>F,w1:()=>K,Rb:()=>$,Up:()=>W,up:()=>M,kt:()=>U,x_:()=>R,bz:()=>V,DA:()=>Y,oP:()=>p,H:()=>h,sr:()=>f,c3:()=>m})},201:(e,t)=>{t.__esModule=!0;var n=function(){var e={trace:function(){},yy:{},symbols_:{error:2,root:3,program:4,EOF:5,program_repetition0:6,statement:7,mustache:8,block:9,rawBlock:10,partial:11,partialBlock:12,content:13,COMMENT:14,CONTENT:15,openRawBlock:16,rawBlock_repetition0:17,END_RAW_BLOCK:18,OPEN_RAW_BLOCK:19,helperName:20,openRawBlock_repetition0:21,openRawBlock_option0:22,CLOSE_RAW_BLOCK:23,openBlock:24,block_option0:25,closeBlock:26,openInverse:27,block_option1:28,OPEN_BLOCK:29,openBlock_repetition0:30,openBlock_option0:31,openBlock_option1:32,CLOSE:33,OPEN_INVERSE:34,openInverse_repetition0:35,openInverse_option0:36,openInverse_option1:37,openInverseChain:38,OPEN_INVERSE_CHAIN:39,openInverseChain_repetition0:40,openInverseChain_option0:41,openInverseChain_option1:42,inverseAndProgram:43,INVERSE:44,inverseChain:45,inverseChain_option0:46,OPEN_ENDBLOCK:47,OPEN:48,mustache_repetition0:49,mustache_option0:50,OPEN_UNESCAPED:51,mustache_repetition1:52,mustache_option1:53,CLOSE_UNESCAPED:54,OPEN_PARTIAL:55,partialName:56,partial_repetition0:57,partial_option0:58,openPartialBlock:59,OPEN_PARTIAL_BLOCK:60,openPartialBlock_repetition0:61,openPartialBlock_option0:62,param:63,sexpr:64,OPEN_SEXPR:65,sexpr_repetition0:66,sexpr_option0:67,CLOSE_SEXPR:68,hash:69,hash_repetition_plus0:70,hashSegment:71,ID:72,EQUALS:73,blockParams:74,OPEN_BLOCK_PARAMS:75,blockParams_repetition_plus0:76,CLOSE_BLOCK_PARAMS:77,path:78,dataName:79,STRING:80,NUMBER:81,BOOLEAN:82,UNDEFINED:83,NULL:84,DATA:85,pathSegments:86,SEP:87,$accept:0,$end:1},terminals_:{2:"error",5:"EOF",14:"COMMENT",15:"CONTENT",18:"END_RAW_BLOCK",19:"OPEN_RAW_BLOCK",23:"CLOSE_RAW_BLOCK",29:"OPEN_BLOCK",33:"CLOSE",34:"OPEN_INVERSE",39:"OPEN_INVERSE_CHAIN",44:"INVERSE",47:"OPEN_ENDBLOCK",48:"OPEN",51:"OPEN_UNESCAPED",54:"CLOSE_UNESCAPED",55:"OPEN_PARTIAL",60:"OPEN_PARTIAL_BLOCK",65:"OPEN_SEXPR",68:"CLOSE_SEXPR",72:"ID",73:"EQUALS",75:"OPEN_BLOCK_PARAMS",77:"CLOSE_BLOCK_PARAMS",80:"STRING",81:"NUMBER",82:"BOOLEAN",83:"UNDEFINED",84:"NULL",85:"DATA",87:"SEP"},productions_:[0,[3,2],[4,1],[7,1],[7,1],[7,1],[7,1],[7,1],[7,1],[7,1],[13,1],[10,3],[16,5],[9,4],[9,4],[24,6],[27,6],[38,6],[43,2],[45,3],[45,1],[26,3],[8,5],[8,5],[11,5],[12,3],[59,5],[63,1],[63,1],[64,5],[69,1],[71,3],[74,3],[20,1],[20,1],[20,1],[20,1],[20,1],[20,1],[20,1],[56,1],[56,1],[79,2],[78,1],[86,3],[86,1],[6,0],[6,2],[17,0],[17,2],[21,0],[21,2],[22,0],[22,1],[25,0],[25,1],[28,0],[28,1],[30,0],[30,2],[31,0],[31,1],[32,0],[32,1],[35,0],[35,2],[36,0],[36,1],[37,0],[37,1],[40,0],[40,2],[41,0],[41,1],[42,0],[42,1],[46,0],[46,1],[49,0],[49,2],[50,0],[50,1],[52,0],[52,2],[53,0],[53,1],[57,0],[57,2],[58,0],[58,1],[61,0],[61,2],[62,0],[62,1],[66,0],[66,2],[67,0],[67,1],[70,1],[70,2],[76,1],[76,2]],performAction:function(e,t,n,r,o,i,a){var s=i.length-1;switch(o){case 1:return i[s-1];case 2:this.$=r.prepareProgram(i[s]);break;case 3:case 4:case 5:case 6:case 7:case 8:case 20:case 27:case 28:case 33:case 34:case 40:case 41:this.$=i[s];break;case 9:this.$={type:"CommentStatement",value:r.stripComment(i[s]),strip:r.stripFlags(i[s],i[s]),loc:r.locInfo(this._$)};break;case 10:this.$={type:"ContentStatement",original:i[s],value:i[s],loc:r.locInfo(this._$)};break;case 11:this.$=r.prepareRawBlock(i[s-2],i[s-1],i[s],this._$);break;case 12:this.$={path:i[s-3],params:i[s-2],hash:i[s-1]};break;case 13:this.$=r.prepareBlock(i[s-3],i[s-2],i[s-1],i[s],!1,this._$);break;case 14:this.$=r.prepareBlock(i[s-3],i[s-2],i[s-1],i[s],!0,this._$);break;case 15:this.$={open:i[s-5],path:i[s-4],params:i[s-3],hash:i[s-2],blockParams:i[s-1],strip:r.stripFlags(i[s-5],i[s])};break;case 16:case 17:this.$={path:i[s-4],params:i[s-3],hash:i[s-2],blockParams:i[s-1],strip:r.stripFlags(i[s-5],i[s])};break;case 18:this.$={strip:r.stripFlags(i[s-1],i[s-1]),program:i[s]};break;case 19:var l=r.prepareBlock(i[s-2],i[s-1],i[s],i[s],!1,this._$),c=r.prepareProgram([l],i[s-1].loc);c.chained=!0,this.$={strip:i[s-2].strip,program:c,chain:!0};break;case 21:this.$={path:i[s-1],strip:r.stripFlags(i[s-2],i[s])};break;case 22:case 23:this.$=r.prepareMustache(i[s-3],i[s-2],i[s-1],i[s-4],r.stripFlags(i[s-4],i[s]),this._$);break;case 24:this.$={type:"PartialStatement",name:i[s-3],params:i[s-2],hash:i[s-1],indent:"",strip:r.stripFlags(i[s-4],i[s]),loc:r.locInfo(this._$)};break;case 25:this.$=r.preparePartialBlock(i[s-2],i[s-1],i[s],this._$);break;case 26:this.$={path:i[s-3],params:i[s-2],hash:i[s-1],strip:r.stripFlags(i[s-4],i[s])};break;case 29:this.$={type:"SubExpression",path:i[s-3],params:i[s-2],hash:i[s-1],loc:r.locInfo(this._$)};break;case 30:this.$={type:"Hash",pairs:i[s],loc:r.locInfo(this._$)};break;case 31:this.$={type:"HashPair",key:r.id(i[s-2]),value:i[s],loc:r.locInfo(this._$)};break;case 32:this.$=r.id(i[s-1]);break;case 35:this.$={type:"StringLiteral",value:i[s],original:i[s],loc:r.locInfo(this._$)};break;case 36:this.$={type:"NumberLiteral",value:Number(i[s]),original:Number(i[s]),loc:r.locInfo(this._$)};break;case 37:this.$={type:"BooleanLiteral",value:"true"===i[s],original:"true"===i[s],loc:r.locInfo(this._$)};break;case 38:this.$={type:"UndefinedLiteral",original:void 0,value:void 0,loc:r.locInfo(this._$)};break;case 39:this.$={type:"NullLiteral",original:null,value:null,loc:r.locInfo(this._$)};break;case 42:this.$=r.preparePath(!0,i[s],this._$);break;case 43:this.$=r.preparePath(!1,i[s],this._$);break;case 44:i[s-2].push({part:r.id(i[s]),original:i[s],separator:i[s-1]}),this.$=i[s-2];break;case 45:this.$=[{part:r.id(i[s]),original:i[s]}];break;case 46:case 48:case 50:case 58:case 64:case 70:case 78:case 82:case 86:case 90:case 94:this.$=[];break;case 47:case 49:case 51:case 59:case 65:case 71:case 79:case 83:case 87:case 91:case 95:case 99:case 101:i[s-1].push(i[s]);break;case 98:case 100:this.$=[i[s]]}},table:[{3:1,4:2,5:[2,46],6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{1:[3]},{5:[1,4]},{5:[2,2],7:5,8:6,9:7,10:8,11:9,12:10,13:11,14:[1,12],15:[1,20],16:17,19:[1,23],24:15,27:16,29:[1,21],34:[1,22],39:[2,2],44:[2,2],47:[2,2],48:[1,13],51:[1,14],55:[1,18],59:19,60:[1,24]},{1:[2,1]},{5:[2,47],14:[2,47],15:[2,47],19:[2,47],29:[2,47],34:[2,47],39:[2,47],44:[2,47],47:[2,47],48:[2,47],51:[2,47],55:[2,47],60:[2,47]},{5:[2,3],14:[2,3],15:[2,3],19:[2,3],29:[2,3],34:[2,3],39:[2,3],44:[2,3],47:[2,3],48:[2,3],51:[2,3],55:[2,3],60:[2,3]},{5:[2,4],14:[2,4],15:[2,4],19:[2,4],29:[2,4],34:[2,4],39:[2,4],44:[2,4],47:[2,4],48:[2,4],51:[2,4],55:[2,4],60:[2,4]},{5:[2,5],14:[2,5],15:[2,5],19:[2,5],29:[2,5],34:[2,5],39:[2,5],44:[2,5],47:[2,5],48:[2,5],51:[2,5],55:[2,5],60:[2,5]},{5:[2,6],14:[2,6],15:[2,6],19:[2,6],29:[2,6],34:[2,6],39:[2,6],44:[2,6],47:[2,6],48:[2,6],51:[2,6],55:[2,6],60:[2,6]},{5:[2,7],14:[2,7],15:[2,7],19:[2,7],29:[2,7],34:[2,7],39:[2,7],44:[2,7],47:[2,7],48:[2,7],51:[2,7],55:[2,7],60:[2,7]},{5:[2,8],14:[2,8],15:[2,8],19:[2,8],29:[2,8],34:[2,8],39:[2,8],44:[2,8],47:[2,8],48:[2,8],51:[2,8],55:[2,8],60:[2,8]},{5:[2,9],14:[2,9],15:[2,9],19:[2,9],29:[2,9],34:[2,9],39:[2,9],44:[2,9],47:[2,9],48:[2,9],51:[2,9],55:[2,9],60:[2,9]},{20:25,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:36,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{4:37,6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],39:[2,46],44:[2,46],47:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{4:38,6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],44:[2,46],47:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{15:[2,48],17:39,18:[2,48]},{20:41,56:40,64:42,65:[1,43],72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{4:44,6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],47:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{5:[2,10],14:[2,10],15:[2,10],18:[2,10],19:[2,10],29:[2,10],34:[2,10],39:[2,10],44:[2,10],47:[2,10],48:[2,10],51:[2,10],55:[2,10],60:[2,10]},{20:45,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:46,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:47,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:41,56:48,64:42,65:[1,43],72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{33:[2,78],49:49,65:[2,78],72:[2,78],80:[2,78],81:[2,78],82:[2,78],83:[2,78],84:[2,78],85:[2,78]},{23:[2,33],33:[2,33],54:[2,33],65:[2,33],68:[2,33],72:[2,33],75:[2,33],80:[2,33],81:[2,33],82:[2,33],83:[2,33],84:[2,33],85:[2,33]},{23:[2,34],33:[2,34],54:[2,34],65:[2,34],68:[2,34],72:[2,34],75:[2,34],80:[2,34],81:[2,34],82:[2,34],83:[2,34],84:[2,34],85:[2,34]},{23:[2,35],33:[2,35],54:[2,35],65:[2,35],68:[2,35],72:[2,35],75:[2,35],80:[2,35],81:[2,35],82:[2,35],83:[2,35],84:[2,35],85:[2,35]},{23:[2,36],33:[2,36],54:[2,36],65:[2,36],68:[2,36],72:[2,36],75:[2,36],80:[2,36],81:[2,36],82:[2,36],83:[2,36],84:[2,36],85:[2,36]},{23:[2,37],33:[2,37],54:[2,37],65:[2,37],68:[2,37],72:[2,37],75:[2,37],80:[2,37],81:[2,37],82:[2,37],83:[2,37],84:[2,37],85:[2,37]},{23:[2,38],33:[2,38],54:[2,38],65:[2,38],68:[2,38],72:[2,38],75:[2,38],80:[2,38],81:[2,38],82:[2,38],83:[2,38],84:[2,38],85:[2,38]},{23:[2,39],33:[2,39],54:[2,39],65:[2,39],68:[2,39],72:[2,39],75:[2,39],80:[2,39],81:[2,39],82:[2,39],83:[2,39],84:[2,39],85:[2,39]},{23:[2,43],33:[2,43],54:[2,43],65:[2,43],68:[2,43],72:[2,43],75:[2,43],80:[2,43],81:[2,43],82:[2,43],83:[2,43],84:[2,43],85:[2,43],87:[1,50]},{72:[1,35],86:51},{23:[2,45],33:[2,45],54:[2,45],65:[2,45],68:[2,45],72:[2,45],75:[2,45],80:[2,45],81:[2,45],82:[2,45],83:[2,45],84:[2,45],85:[2,45],87:[2,45]},{52:52,54:[2,82],65:[2,82],72:[2,82],80:[2,82],81:[2,82],82:[2,82],83:[2,82],84:[2,82],85:[2,82]},{25:53,38:55,39:[1,57],43:56,44:[1,58],45:54,47:[2,54]},{28:59,43:60,44:[1,58],47:[2,56]},{13:62,15:[1,20],18:[1,61]},{33:[2,86],57:63,65:[2,86],72:[2,86],80:[2,86],81:[2,86],82:[2,86],83:[2,86],84:[2,86],85:[2,86]},{33:[2,40],65:[2,40],72:[2,40],80:[2,40],81:[2,40],82:[2,40],83:[2,40],84:[2,40],85:[2,40]},{33:[2,41],65:[2,41],72:[2,41],80:[2,41],81:[2,41],82:[2,41],83:[2,41],84:[2,41],85:[2,41]},{20:64,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{26:65,47:[1,66]},{30:67,33:[2,58],65:[2,58],72:[2,58],75:[2,58],80:[2,58],81:[2,58],82:[2,58],83:[2,58],84:[2,58],85:[2,58]},{33:[2,64],35:68,65:[2,64],72:[2,64],75:[2,64],80:[2,64],81:[2,64],82:[2,64],83:[2,64],84:[2,64],85:[2,64]},{21:69,23:[2,50],65:[2,50],72:[2,50],80:[2,50],81:[2,50],82:[2,50],83:[2,50],84:[2,50],85:[2,50]},{33:[2,90],61:70,65:[2,90],72:[2,90],80:[2,90],81:[2,90],82:[2,90],83:[2,90],84:[2,90],85:[2,90]},{20:74,33:[2,80],50:71,63:72,64:75,65:[1,43],69:73,70:76,71:77,72:[1,78],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{72:[1,79]},{23:[2,42],33:[2,42],54:[2,42],65:[2,42],68:[2,42],72:[2,42],75:[2,42],80:[2,42],81:[2,42],82:[2,42],83:[2,42],84:[2,42],85:[2,42],87:[1,50]},{20:74,53:80,54:[2,84],63:81,64:75,65:[1,43],69:82,70:76,71:77,72:[1,78],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{26:83,47:[1,66]},{47:[2,55]},{4:84,6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],39:[2,46],44:[2,46],47:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{47:[2,20]},{20:85,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{4:86,6:3,14:[2,46],15:[2,46],19:[2,46],29:[2,46],34:[2,46],47:[2,46],48:[2,46],51:[2,46],55:[2,46],60:[2,46]},{26:87,47:[1,66]},{47:[2,57]},{5:[2,11],14:[2,11],15:[2,11],19:[2,11],29:[2,11],34:[2,11],39:[2,11],44:[2,11],47:[2,11],48:[2,11],51:[2,11],55:[2,11],60:[2,11]},{15:[2,49],18:[2,49]},{20:74,33:[2,88],58:88,63:89,64:75,65:[1,43],69:90,70:76,71:77,72:[1,78],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{65:[2,94],66:91,68:[2,94],72:[2,94],80:[2,94],81:[2,94],82:[2,94],83:[2,94],84:[2,94],85:[2,94]},{5:[2,25],14:[2,25],15:[2,25],19:[2,25],29:[2,25],34:[2,25],39:[2,25],44:[2,25],47:[2,25],48:[2,25],51:[2,25],55:[2,25],60:[2,25]},{20:92,72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:74,31:93,33:[2,60],63:94,64:75,65:[1,43],69:95,70:76,71:77,72:[1,78],75:[2,60],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:74,33:[2,66],36:96,63:97,64:75,65:[1,43],69:98,70:76,71:77,72:[1,78],75:[2,66],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:74,22:99,23:[2,52],63:100,64:75,65:[1,43],69:101,70:76,71:77,72:[1,78],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{20:74,33:[2,92],62:102,63:103,64:75,65:[1,43],69:104,70:76,71:77,72:[1,78],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{33:[1,105]},{33:[2,79],65:[2,79],72:[2,79],80:[2,79],81:[2,79],82:[2,79],83:[2,79],84:[2,79],85:[2,79]},{33:[2,81]},{23:[2,27],33:[2,27],54:[2,27],65:[2,27],68:[2,27],72:[2,27],75:[2,27],80:[2,27],81:[2,27],82:[2,27],83:[2,27],84:[2,27],85:[2,27]},{23:[2,28],33:[2,28],54:[2,28],65:[2,28],68:[2,28],72:[2,28],75:[2,28],80:[2,28],81:[2,28],82:[2,28],83:[2,28],84:[2,28],85:[2,28]},{23:[2,30],33:[2,30],54:[2,30],68:[2,30],71:106,72:[1,107],75:[2,30]},{23:[2,98],33:[2,98],54:[2,98],68:[2,98],72:[2,98],75:[2,98]},{23:[2,45],33:[2,45],54:[2,45],65:[2,45],68:[2,45],72:[2,45],73:[1,108],75:[2,45],80:[2,45],81:[2,45],82:[2,45],83:[2,45],84:[2,45],85:[2,45],87:[2,45]},{23:[2,44],33:[2,44],54:[2,44],65:[2,44],68:[2,44],72:[2,44],75:[2,44],80:[2,44],81:[2,44],82:[2,44],83:[2,44],84:[2,44],85:[2,44],87:[2,44]},{54:[1,109]},{54:[2,83],65:[2,83],72:[2,83],80:[2,83],81:[2,83],82:[2,83],83:[2,83],84:[2,83],85:[2,83]},{54:[2,85]},{5:[2,13],14:[2,13],15:[2,13],19:[2,13],29:[2,13],34:[2,13],39:[2,13],44:[2,13],47:[2,13],48:[2,13],51:[2,13],55:[2,13],60:[2,13]},{38:55,39:[1,57],43:56,44:[1,58],45:111,46:110,47:[2,76]},{33:[2,70],40:112,65:[2,70],72:[2,70],75:[2,70],80:[2,70],81:[2,70],82:[2,70],83:[2,70],84:[2,70],85:[2,70]},{47:[2,18]},{5:[2,14],14:[2,14],15:[2,14],19:[2,14],29:[2,14],34:[2,14],39:[2,14],44:[2,14],47:[2,14],48:[2,14],51:[2,14],55:[2,14],60:[2,14]},{33:[1,113]},{33:[2,87],65:[2,87],72:[2,87],80:[2,87],81:[2,87],82:[2,87],83:[2,87],84:[2,87],85:[2,87]},{33:[2,89]},{20:74,63:115,64:75,65:[1,43],67:114,68:[2,96],69:116,70:76,71:77,72:[1,78],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{33:[1,117]},{32:118,33:[2,62],74:119,75:[1,120]},{33:[2,59],65:[2,59],72:[2,59],75:[2,59],80:[2,59],81:[2,59],82:[2,59],83:[2,59],84:[2,59],85:[2,59]},{33:[2,61],75:[2,61]},{33:[2,68],37:121,74:122,75:[1,120]},{33:[2,65],65:[2,65],72:[2,65],75:[2,65],80:[2,65],81:[2,65],82:[2,65],83:[2,65],84:[2,65],85:[2,65]},{33:[2,67],75:[2,67]},{23:[1,123]},{23:[2,51],65:[2,51],72:[2,51],80:[2,51],81:[2,51],82:[2,51],83:[2,51],84:[2,51],85:[2,51]},{23:[2,53]},{33:[1,124]},{33:[2,91],65:[2,91],72:[2,91],80:[2,91],81:[2,91],82:[2,91],83:[2,91],84:[2,91],85:[2,91]},{33:[2,93]},{5:[2,22],14:[2,22],15:[2,22],19:[2,22],29:[2,22],34:[2,22],39:[2,22],44:[2,22],47:[2,22],48:[2,22],51:[2,22],55:[2,22],60:[2,22]},{23:[2,99],33:[2,99],54:[2,99],68:[2,99],72:[2,99],75:[2,99]},{73:[1,108]},{20:74,63:125,64:75,65:[1,43],72:[1,35],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{5:[2,23],14:[2,23],15:[2,23],19:[2,23],29:[2,23],34:[2,23],39:[2,23],44:[2,23],47:[2,23],48:[2,23],51:[2,23],55:[2,23],60:[2,23]},{47:[2,19]},{47:[2,77]},{20:74,33:[2,72],41:126,63:127,64:75,65:[1,43],69:128,70:76,71:77,72:[1,78],75:[2,72],78:26,79:27,80:[1,28],81:[1,29],82:[1,30],83:[1,31],84:[1,32],85:[1,34],86:33},{5:[2,24],14:[2,24],15:[2,24],19:[2,24],29:[2,24],34:[2,24],39:[2,24],44:[2,24],47:[2,24],48:[2,24],51:[2,24],55:[2,24],60:[2,24]},{68:[1,129]},{65:[2,95],68:[2,95],72:[2,95],80:[2,95],81:[2,95],82:[2,95],83:[2,95],84:[2,95],85:[2,95]},{68:[2,97]},{5:[2,21],14:[2,21],15:[2,21],19:[2,21],29:[2,21],34:[2,21],39:[2,21],44:[2,21],47:[2,21],48:[2,21],51:[2,21],55:[2,21],60:[2,21]},{33:[1,130]},{33:[2,63]},{72:[1,132],76:131},{33:[1,133]},{33:[2,69]},{15:[2,12],18:[2,12]},{14:[2,26],15:[2,26],19:[2,26],29:[2,26],34:[2,26],47:[2,26],48:[2,26],51:[2,26],55:[2,26],60:[2,26]},{23:[2,31],33:[2,31],54:[2,31],68:[2,31],72:[2,31],75:[2,31]},{33:[2,74],42:134,74:135,75:[1,120]},{33:[2,71],65:[2,71],72:[2,71],75:[2,71],80:[2,71],81:[2,71],82:[2,71],83:[2,71],84:[2,71],85:[2,71]},{33:[2,73],75:[2,73]},{23:[2,29],33:[2,29],54:[2,29],65:[2,29],68:[2,29],72:[2,29],75:[2,29],80:[2,29],81:[2,29],82:[2,29],83:[2,29],84:[2,29],85:[2,29]},{14:[2,15],15:[2,15],19:[2,15],29:[2,15],34:[2,15],39:[2,15],44:[2,15],47:[2,15],48:[2,15],51:[2,15],55:[2,15],60:[2,15]},{72:[1,137],77:[1,136]},{72:[2,100],77:[2,100]},{14:[2,16],15:[2,16],19:[2,16],29:[2,16],34:[2,16],44:[2,16],47:[2,16],48:[2,16],51:[2,16],55:[2,16],60:[2,16]},{33:[1,138]},{33:[2,75]},{33:[2,32]},{72:[2,101],77:[2,101]},{14:[2,17],15:[2,17],19:[2,17],29:[2,17],34:[2,17],39:[2,17],44:[2,17],47:[2,17],48:[2,17],51:[2,17],55:[2,17],60:[2,17]}],defaultActions:{4:[2,1],54:[2,55],56:[2,20],60:[2,57],73:[2,81],82:[2,85],86:[2,18],90:[2,89],101:[2,53],104:[2,93],110:[2,19],111:[2,77],116:[2,97],119:[2,63],122:[2,69],135:[2,75],136:[2,32]},parseError:function(e,t){throw new Error(e)},parse:function(e){var t=this,n=[0],r=[null],o=[],i=this.table,a="",s=0,l=0,c=0;this.lexer.setInput(e),this.lexer.yy=this.yy,this.yy.lexer=this.lexer,this.yy.parser=this,void 0===this.lexer.yylloc&&(this.lexer.yylloc={});var u=this.lexer.yylloc;o.push(u);var p=this.lexer.options&&this.lexer.options.ranges;function d(){var e;return"number"!=typeof(e=t.lexer.lex()||1)&&(e=t.symbols_[e]||e),e}"function"==typeof this.yy.parseError&&(this.parseError=this.yy.parseError);for(var h,f,m,g,v,y,b,S,w,x={};;){if(m=n[n.length-1],this.defaultActions[m]?g=this.defaultActions[m]:(null==h&&(h=d()),g=i[m]&&i[m][h]),void 0===g||!g.length||!g[0]){var C="";if(!c){for(y in w=[],i[m])this.terminals_[y]&&y>2&&w.push("'"+this.terminals_[y]+"'");C=this.lexer.showPosition?"Parse error on line "+(s+1)+":\n"+this.lexer.showPosition()+"\nExpecting "+w.join(", ")+", got '"+(this.terminals_[h]||h)+"'":"Parse error on line "+(s+1)+": Unexpected "+(1==h?"end of input":"'"+(this.terminals_[h]||h)+"'"),this.parseError(C,{text:this.lexer.match,token:this.terminals_[h]||h,line:this.lexer.yylineno,loc:u,expected:w})}}if(g[0]instanceof Array&&g.length>1)throw new Error("Parse Error: multiple actions possible at state: "+m+", token: "+h);switch(g[0]){case 1:n.push(h),r.push(this.lexer.yytext),o.push(this.lexer.yylloc),n.push(g[1]),h=null,f?(h=f,f=null):(l=this.lexer.yyleng,a=this.lexer.yytext,s=this.lexer.yylineno,u=this.lexer.yylloc,c>0&&c--);break;case 2:if(b=this.productions_[g[1]][1],x.$=r[r.length-b],x._$={first_line:o[o.length-(b||1)].first_line,last_line:o[o.length-1].last_line,first_column:o[o.length-(b||1)].first_column,last_column:o[o.length-1].last_column},p&&(x._$.range=[o[o.length-(b||1)].range[0],o[o.length-1].range[1]]),void 0!==(v=this.performAction.call(x,a,l,s,this.yy,g[1],r,o)))return v;b&&(n=n.slice(0,-1*b*2),r=r.slice(0,-1*b),o=o.slice(0,-1*b)),n.push(this.productions_[g[1]][0]),r.push(x.$),o.push(x._$),S=i[n[n.length-2]][n[n.length-1]],n.push(S);break;case 3:return!0}}return!0}},t=function(){var e={EOF:1,parseError:function(e,t){if(!this.yy.parser)throw new Error(e);this.yy.parser.parseError(e,t)},setInput:function(e){return this._input=e,this._more=this._less=this.done=!1,this.yylineno=this.yyleng=0,this.yytext=this.matched=this.match="",this.conditionStack=["INITIAL"],this.yylloc={first_line:1,first_column:0,last_line:1,last_column:0},this.options.ranges&&(this.yylloc.range=[0,0]),this.offset=0,this},input:function(){var e=this._input[0];return this.yytext+=e,this.yyleng++,this.offset++,this.match+=e,this.matched+=e,e.match(/(?:\r\n?|\n).*/g)?(this.yylineno++,this.yylloc.last_line++):this.yylloc.last_column++,this.options.ranges&&this.yylloc.range[1]++,this._input=this._input.slice(1),e},unput:function(e){var t=e.length,n=e.split(/(?:\r\n?|\n)/g);this._input=e+this._input,this.yytext=this.yytext.substr(0,this.yytext.length-t-1),this.offset-=t;var r=this.match.split(/(?:\r\n?|\n)/g);this.match=this.match.substr(0,this.match.length-1),this.matched=this.matched.substr(0,this.matched.length-1),n.length-1&&(this.yylineno-=n.length-1);var o=this.yylloc.range;return this.yylloc={first_line:this.yylloc.first_line,last_line:this.yylineno+1,first_column:this.yylloc.first_column,last_column:n?(n.length===r.length?this.yylloc.first_column:0)+r[r.length-n.length].length-n[0].length:this.yylloc.first_column-t},this.options.ranges&&(this.yylloc.range=[o[0],o[0]+this.yyleng-t]),this},more:function(){return this._more=!0,this},less:function(e){this.unput(this.match.slice(e))},pastInput:function(){var e=this.matched.substr(0,this.matched.length-this.match.length);return(e.length>20?"...":"")+e.substr(-20).replace(/\n/g,"")},upcomingInput:function(){var e=this.match;return e.length<20&&(e+=this._input.substr(0,20-e.length)),(e.substr(0,20)+(e.length>20?"...":"")).replace(/\n/g,"")},showPosition:function(){var e=this.pastInput(),t=new Array(e.length+1).join("-");return e+this.upcomingInput()+"\n"+t+"^"},next:function(){if(this.done)return this.EOF;var e,t,n,r,o;this._input||(this.done=!0),this._more||(this.yytext="",this.match="");for(var i=this._currentRules(),a=0;a<i.length&&(!(n=this._input.match(this.rules[i[a]]))||t&&!(n[0].length>t[0].length)||(t=n,r=a,this.options.flex));a++);return t?((o=t[0].match(/(?:\r\n?|\n).*/g))&&(this.yylineno+=o.length),this.yylloc={first_line:this.yylloc.last_line,last_line:this.yylineno+1,first_column:this.yylloc.last_column,last_column:o?o[o.length-1].length-o[o.length-1].match(/\r?\n?/)[0].length:this.yylloc.last_column+t[0].length},this.yytext+=t[0],this.match+=t[0],this.matches=t,this.yyleng=this.yytext.length,this.options.ranges&&(this.yylloc.range=[this.offset,this.offset+=this.yyleng]),this._more=!1,this._input=this._input.slice(t[0].length),this.matched+=t[0],e=this.performAction.call(this,this.yy,this,i[r],this.conditionStack[this.conditionStack.length-1]),this.done&&this._input&&(this.done=!1),e||void 0):""===this._input?this.EOF:this.parseError("Lexical error on line "+(this.yylineno+1)+". Unrecognized text.\n"+this.showPosition(),{text:"",token:null,line:this.yylineno})},lex:function(){var e=this.next();return void 0!==e?e:this.lex()},begin:function(e){this.conditionStack.push(e)},popState:function(){return this.conditionStack.pop()},_currentRules:function(){return this.conditions[this.conditionStack[this.conditionStack.length-1]].rules},topState:function(){return this.conditionStack[this.conditionStack.length-2]},pushState:function(e){this.begin(e)},options:{},performAction:function(e,t,n,r){function o(e,n){return t.yytext=t.yytext.substring(e,t.yyleng-n+e)}switch(n){case 0:if("\\\\"===t.yytext.slice(-2)?(o(0,1),this.begin("mu")):"\\"===t.yytext.slice(-1)?(o(0,1),this.begin("emu")):this.begin("mu"),t.yytext)return 15;break;case 1:case 5:return 15;case 2:return this.popState(),15;case 3:return this.begin("raw"),15;case 4:return this.popState(),"raw"===this.conditionStack[this.conditionStack.length-1]?15:(o(5,9),"END_RAW_BLOCK");case 6:case 22:return this.popState(),14;case 7:return 65;case 8:return 68;case 9:return 19;case 10:return this.popState(),this.begin("raw"),23;case 11:return 55;case 12:return 60;case 13:return 29;case 14:return 47;case 15:case 16:return this.popState(),44;case 17:return 34;case 18:return 39;case 19:return 51;case 20:case 23:return 48;case 21:this.unput(t.yytext),this.popState(),this.begin("com");break;case 24:return 73;case 25:case 26:case 41:return 72;case 27:return 87;case 28:break;case 29:return this.popState(),54;case 30:return this.popState(),33;case 31:return t.yytext=o(1,2).replace(/\\"/g,'"'),80;case 32:return t.yytext=o(1,2).replace(/\\'/g,"'"),80;case 33:return 85;case 34:case 35:return 82;case 36:return 83;case 37:return 84;case 38:return 81;case 39:return 75;case 40:return 77;case 42:return t.yytext=t.yytext.replace(/\\([\\\]])/g,"$1"),72;case 43:return"INVALID";case 44:return 5}},rules:[/^(?:[^\x00]*?(?=(\{\{)))/,/^(?:[^\x00]+)/,/^(?:[^\x00]{2,}?(?=(\{\{|\\\{\{|\\\\\{\{|$)))/,/^(?:\{\{\{\{(?=[^/]))/,/^(?:\{\{\{\{\/[^\s!"#%-,\.\/;->@\[-\^`\{-~]+(?=[=}\s\/.])\}\}\}\})/,/^(?:[^\x00]+?(?=(\{\{\{\{)))/,/^(?:[\s\S]*?--(~)?\}\})/,/^(?:\()/,/^(?:\))/,/^(?:\{\{\{\{)/,/^(?:\}\}\}\})/,/^(?:\{\{(~)?>)/,/^(?:\{\{(~)?#>)/,/^(?:\{\{(~)?#\*?)/,/^(?:\{\{(~)?\/)/,/^(?:\{\{(~)?\^\s*(~)?\}\})/,/^(?:\{\{(~)?\s*else\s*(~)?\}\})/,/^(?:\{\{(~)?\^)/,/^(?:\{\{(~)?\s*else\b)/,/^(?:\{\{(~)?\{)/,/^(?:\{\{(~)?&)/,/^(?:\{\{(~)?!--)/,/^(?:\{\{(~)?![\s\S]*?\}\})/,/^(?:\{\{(~)?\*?)/,/^(?:=)/,/^(?:\.\.)/,/^(?:\.(?=([=~}\s\/.)|])))/,/^(?:[\/.])/,/^(?:\s+)/,/^(?:\}(~)?\}\})/,/^(?:(~)?\}\})/,/^(?:"(\\["]|[^"])*")/,/^(?:'(\\[']|[^'])*')/,/^(?:@)/,/^(?:true(?=([~}\s)])))/,/^(?:false(?=([~}\s)])))/,/^(?:undefined(?=([~}\s)])))/,/^(?:null(?=([~}\s)])))/,/^(?:-?[0-9]+(?:\.[0-9]+)?(?=([~}\s)])))/,/^(?:as\s+\|)/,/^(?:\|)/,/^(?:([^\s!"#%-,\.\/;->@\[-\^`\{-~]+(?=([=~}\s\/.)|]))))/,/^(?:\[(\\\]|[^\]])*\])/,/^(?:.)/,/^(?:$)/],conditions:{mu:{rules:[7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44],inclusive:!1},emu:{rules:[2],inclusive:!1},com:{rules:[6],inclusive:!1},raw:{rules:[3,4,5],inclusive:!1},INITIAL:{rules:[0,1,44],inclusive:!0}}};return e}();function n(){this.yy={}}return e.lexer=t,n.prototype=e,e.Parser=n,new n}();t.default=n,e.exports=t.default},261:(e,t,n)=>{function r(e){return e&&e.__esModule?e:{default:e}}function o(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}t.__esModule=!0;var i=o(n(871)),a=r(n(613)),s=r(n(769)),l=o(n(849)),c=o(n(624)),u=r(n(148));function p(){var e=new i.HandlebarsEnvironment;return l.extend(e,i),e.SafeString=a.default,e.Exception=s.default,e.Utils=l,e.escapeExpression=l.escapeExpression,e.VM=c,e.template=function(t){return c.template(t,e)},e}var d=p();d.create=p,u.default(d),d.default=d,t.default=d,e.exports=t.default},262:(e,t,n)=>{n.r(t),n.d(t,{CHARACTER_FIELDS:()=>De,CHARACTER_LABELS:()=>Ne,globalContext:()=>Ae,runCharacterFieldGeneration:()=>Fe});var r=n(971);const o={preserveOrder:!1,attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,removeNSPrefix:!1,allowBooleanAttributes:!1,parseTagValue:!0,parseAttributeValue:!1,trimValues:!0,cdataPropName:!1,numberParseOptions:{hex:!0,leadingZeros:!0,eNotation:!0},tagValueProcessor:function(e,t){return t},attributeValueProcessor:function(e,t){return t},stopNodes:[],alwaysCreateTextNode:!1,isArray:()=>!1,commentPropName:!1,unpairedTags:[],processEntities:!0,htmlEntities:!1,ignoreDeclaration:!1,ignorePiTags:!1,transformTagName:!1,transformAttributeName:!1,updateTag:function(e,t,n){return e},captureMetaData:!1},i=":A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",a=new RegExp("^"+("["+i+"]["+(i+"\\-.\\d\\u00B7\\u0300-\\u036F\\u203F-\\u2040")+"]*")+"$");function s(e,t){const n=[];let r=t.exec(e);for(;r;){const o=[];o.startIndex=t.lastIndex-r[0].length;const i=r.length;for(let e=0;e<i;e++)o.push(r[e]);n.push(o),r=t.exec(e)}return n}const l=function(e){const t=a.exec(e);return!(null==t)};let c;c="function"!=typeof Symbol?"@@xmlMetadata":Symbol("XML Node Metadata");class u{constructor(e){this.tagname=e,this.child=[],this[":@"]={}}add(e,t){"__proto__"===e&&(e="#__proto__"),this.child.push({[e]:t})}addChild(e,t){"__proto__"===e.tagname&&(e.tagname="#__proto__"),e[":@"]&&Object.keys(e[":@"]).length>0?this.child.push({[e.tagname]:e.child,":@":e[":@"]}):this.child.push({[e.tagname]:e.child}),void 0!==t&&(this.child[this.child.length-1][c]={startIndex:t})}static getMetaDataSymbol(){return c}}function p(e,t){const n={};if("O"!==e[t+3]||"C"!==e[t+4]||"T"!==e[t+5]||"Y"!==e[t+6]||"P"!==e[t+7]||"E"!==e[t+8])throw new Error("Invalid Tag instead of DOCTYPE");{t+=9;let r=1,o=!1,i=!1,a="";for(;t<e.length;t++)if("<"!==e[t]||i)if(">"===e[t]){if(i?"-"===e[t-1]&&"-"===e[t-2]&&(i=!1,r--):r--,0===r)break}else"["===e[t]?o=!0:a+=e[t];else{if(o&&v(e,"!ENTITY",t)){let r,o;t+=7,[r,o,t]=h(e,t+1),-1===o.indexOf("&")&&(n[r]={regx:RegExp(`&${r};`,"g"),val:o})}else if(o&&v(e,"!ELEMENT",t)){t+=8;const{index:n}=g(e,t+1);t=n}else if(o&&v(e,"!ATTLIST",t))t+=8;else if(o&&v(e,"!NOTATION",t)){t+=9;const{index:n}=f(e,t+1);t=n}else{if(!v(e,"!--",t))throw new Error("Invalid DOCTYPE");i=!0}r++,a=""}if(0!==r)throw new Error("Unclosed DOCTYPE")}return{entities:n,i:t}}const d=(e,t)=>{for(;t<e.length&&/\s/.test(e[t]);)t++;return t};function h(e,t){t=d(e,t);let n="";for(;t<e.length&&!/\s/.test(e[t])&&'"'!==e[t]&&"'"!==e[t];)n+=e[t],t++;if(y(n),t=d(e,t),"SYSTEM"===e.substring(t,t+6).toUpperCase())throw new Error("External entities are not supported");if("%"===e[t])throw new Error("Parameter entities are not supported");let r="";return[t,r]=m(e,t,"entity"),[n,r,--t]}function f(e,t){t=d(e,t);let n="";for(;t<e.length&&!/\s/.test(e[t]);)n+=e[t],t++;y(n),t=d(e,t);const r=e.substring(t,t+6).toUpperCase();if("SYSTEM"!==r&&"PUBLIC"!==r)throw new Error(`Expected SYSTEM or PUBLIC, found "${r}"`);t+=r.length,t=d(e,t);let o=null,i=null;if("PUBLIC"===r)[t,o]=m(e,t,"publicIdentifier"),'"'!==e[t=d(e,t)]&&"'"!==e[t]||([t,i]=m(e,t,"systemIdentifier"));else if("SYSTEM"===r&&([t,i]=m(e,t,"systemIdentifier"),!i))throw new Error("Missing mandatory system identifier for SYSTEM notation");return{notationName:n,publicIdentifier:o,systemIdentifier:i,index:--t}}function m(e,t,n){let r="";const o=e[t];if('"'!==o&&"'"!==o)throw new Error(`Expected quoted string, found "${o}"`);for(t++;t<e.length&&e[t]!==o;)r+=e[t],t++;if(e[t]!==o)throw new Error(`Unterminated ${n} value`);return[++t,r]}function g(e,t){t=d(e,t);let n="";for(;t<e.length&&!/\s/.test(e[t]);)n+=e[t],t++;if(!y(n))throw new Error(`Invalid element name: "${n}"`);let r="";if("E"===e[t=d(e,t)]&&v(e,"MPTY",t))t+=4;else if("A"===e[t]&&v(e,"NY",t))t+=2;else{if("("!==e[t])throw new Error(`Invalid Element Expression, found "${e[t]}"`);for(t++;t<e.length&&")"!==e[t];)r+=e[t],t++;if(")"!==e[t])throw new Error("Unterminated content model")}return{elementName:n,contentModel:r.trim(),index:t}}function v(e,t,n){for(let r=0;r<t.length;r++)if(t[r]!==e[n+r+1])return!1;return!0}function y(e){if(l(e))return e;throw new Error(`Invalid entity name ${e}`)}const b=/^[-+]?0x[a-fA-F0-9]+$/,S=/^([\-\+])?(0*)([0-9]*(\.[0-9]*)?)$/,w={hex:!0,leadingZeros:!0,decimalPoint:".",eNotation:!0};function x(e,t={}){if(t=Object.assign({},w,t),!e||"string"!=typeof e)return e;let n=e.trim();if(void 0!==t.skipLike&&t.skipLike.test(n))return e;if("0"===e)return 0;if(t.hex&&b.test(n))return function(e,t){if(parseInt)return parseInt(e,t);if(Number.parseInt)return Number.parseInt(e,t);if(window&&window.parseInt)return window.parseInt(e,t);throw new Error("parseInt, Number.parseInt, window.parseInt are not supported")}(n,16);if(-1!==n.search(/.+[eE].+/))return function(e,t,n){if(!n.eNotation)return e;const r=t.match(C);if(r){let o=r[1]||"";const i=-1===r[3].indexOf("e")?"E":"e",a=r[2],s=o?e[a.length+1]===i:e[a.length]===i;return a.length>1&&s?e:1!==a.length||!r[3].startsWith(`.${i}`)&&r[3][0]!==i?n.leadingZeros&&!s?(t=(r[1]||"")+r[3],Number(t)):e:Number(t)}return e}(e,n,t);{const r=S.exec(n);if(r){const o=r[1]||"",i=r[2];let a=function(e){if(e&&-1!==e.indexOf("."))return"."===(e=e.replace(/0+$/,""))?e="0":"."===e[0]?e="0"+e:"."===e[e.length-1]&&(e=e.substring(0,e.length-1)),e;return e}(r[3]);const s=o?"."===e[i.length+1]:"."===e[i.length];if(!t.leadingZeros&&(i.length>1||1===i.length&&!s))return e;{const r=Number(n),s=String(r);if(0===r)return r;if(-1!==s.search(/[eE]/))return t.eNotation?r:e;if(-1!==n.indexOf("."))return"0"===s||s===a||s===`${o}${a}`?r:e;let l=i?a:n;return i?l===s||o+l===s?r:e:l===s||l===o+s?r:e}}return e}}const C=/^([-+])?(0*)(\d*(\.\d*)?[eE][-\+]?\d+)$/;class _{constructor(e){var t;this.options=e,this.currentNode=null,this.tagsNodeStack=[],this.docTypeEntities={},this.lastEntities={apos:{regex:/&(apos|#39|#x27);/g,val:"'"},gt:{regex:/&(gt|#62|#x3E);/g,val:">"},lt:{regex:/&(lt|#60|#x3C);/g,val:"<"},quot:{regex:/&(quot|#34|#x22);/g,val:'"'}},this.ampEntity={regex:/&(amp|#38|#x26);/g,val:"&"},this.htmlEntities={space:{regex:/&(nbsp|#160);/g,val:" "},cent:{regex:/&(cent|#162);/g,val:"¢"},pound:{regex:/&(pound|#163);/g,val:"£"},yen:{regex:/&(yen|#165);/g,val:"¥"},euro:{regex:/&(euro|#8364);/g,val:"€"},copyright:{regex:/&(copy|#169);/g,val:"©"},reg:{regex:/&(reg|#174);/g,val:"®"},inr:{regex:/&(inr|#8377);/g,val:"₹"},num_dec:{regex:/&#([0-9]{1,7});/g,val:(e,t)=>String.fromCodePoint(Number.parseInt(t,10))},num_hex:{regex:/&#x([0-9a-fA-F]{1,6});/g,val:(e,t)=>String.fromCodePoint(Number.parseInt(t,16))}},this.addExternalEntities=k,this.parseXml=T,this.parseTextData=E,this.resolveNameSpace=P,this.buildAttributesMap=I,this.isItStopNode=F,this.replaceEntitiesValue=D,this.readStopNodeData=j,this.saveTextToParentTag=N,this.addChild=A,this.ignoreAttributesFn="function"==typeof(t=this.options.ignoreAttributes)?t:Array.isArray(t)?e=>{for(const n of t){if("string"==typeof n&&e===n)return!0;if(n instanceof RegExp&&n.test(e))return!0}}:()=>!1}}function k(e){const t=Object.keys(e);for(let n=0;n<t.length;n++){const r=t[n];this.lastEntities[r]={regex:new RegExp("&"+r+";","g"),val:e[r]}}}function E(e,t,n,r,o,i,a){if(void 0!==e&&(this.options.trimValues&&!r&&(e=e.trim()),e.length>0)){a||(e=this.replaceEntitiesValue(e));const r=this.options.tagValueProcessor(t,e,n,o,i);if(null==r)return e;if(typeof r!=typeof e||r!==e)return r;if(this.options.trimValues)return B(e,this.options.parseTagValue,this.options.numberParseOptions);return e.trim()===e?B(e,this.options.parseTagValue,this.options.numberParseOptions):e}}function P(e){if(this.options.removeNSPrefix){const t=e.split(":"),n="/"===e.charAt(0)?"/":"";if("xmlns"===t[0])return"";2===t.length&&(e=n+t[1])}return e}const O=new RegExp("([^\\s=]+)\\s*(=\\s*(['\"])([\\s\\S]*?)\\3)?","gm");function I(e,t,n){if(!0!==this.options.ignoreAttributes&&"string"==typeof e){const n=s(e,O),r=n.length,o={};for(let e=0;e<r;e++){const r=this.resolveNameSpace(n[e][1]);if(this.ignoreAttributesFn(r,t))continue;let i=n[e][4],a=this.options.attributeNamePrefix+r;if(r.length)if(this.options.transformAttributeName&&(a=this.options.transformAttributeName(a)),"__proto__"===a&&(a="#__proto__"),void 0!==i){this.options.trimValues&&(i=i.trim()),i=this.replaceEntitiesValue(i);const e=this.options.attributeValueProcessor(r,i,t);o[a]=null==e?i:typeof e!=typeof i||e!==i?e:B(i,this.options.parseAttributeValue,this.options.numberParseOptions)}else this.options.allowBooleanAttributes&&(o[a]=!0)}if(!Object.keys(o).length)return;if(this.options.attributesGroupName){const e={};return e[this.options.attributesGroupName]=o,e}return o}}const T=function(e){e=e.replace(/\r\n?/g,"\n");const t=new u("!xml");let n=t,r="",o="";for(let i=0;i<e.length;i++){if("<"===e[i])if("/"===e[i+1]){const t=M(e,">",i,"Closing Tag is not closed.");let a=e.substring(i+2,t).trim();if(this.options.removeNSPrefix){const e=a.indexOf(":");-1!==e&&(a=a.substr(e+1))}this.options.transformTagName&&(a=this.options.transformTagName(a)),n&&(r=this.saveTextToParentTag(r,n,o));const s=o.substring(o.lastIndexOf(".")+1);if(a&&-1!==this.options.unpairedTags.indexOf(a))throw new Error(`Unpaired tag can not be used as closing tag: </${a}>`);let l=0;s&&-1!==this.options.unpairedTags.indexOf(s)?(l=o.lastIndexOf(".",o.lastIndexOf(".")-1),this.tagsNodeStack.pop()):l=o.lastIndexOf("."),o=o.substring(0,l),n=this.tagsNodeStack.pop(),r="",i=t}else if("?"===e[i+1]){let t=L(e,i,!1,"?>");if(!t)throw new Error("Pi Tag is not closed.");if(r=this.saveTextToParentTag(r,n,o),this.options.ignoreDeclaration&&"?xml"===t.tagName||this.options.ignorePiTags);else{const e=new u(t.tagName);e.add(this.options.textNodeName,""),t.tagName!==t.tagExp&&t.attrExpPresent&&(e[":@"]=this.buildAttributesMap(t.tagExp,o,t.tagName)),this.addChild(n,e,o,i)}i=t.closeIndex+1}else if("!--"===e.substr(i+1,3)){const t=M(e,"--\x3e",i+4,"Comment is not closed.");if(this.options.commentPropName){const a=e.substring(i+4,t-2);r=this.saveTextToParentTag(r,n,o),n.add(this.options.commentPropName,[{[this.options.textNodeName]:a}])}i=t}else if("!D"===e.substr(i+1,2)){const t=p(e,i);this.docTypeEntities=t.entities,i=t.i}else if("!["===e.substr(i+1,2)){const t=M(e,"]]>",i,"CDATA is not closed.")-2,a=e.substring(i+9,t);r=this.saveTextToParentTag(r,n,o);let s=this.parseTextData(a,n.tagname,o,!0,!1,!0,!0);null==s&&(s=""),this.options.cdataPropName?n.add(this.options.cdataPropName,[{[this.options.textNodeName]:a}]):n.add(this.options.textNodeName,s),i=t+2}else{let a=L(e,i,this.options.removeNSPrefix),s=a.tagName;const l=a.rawTagName;let c=a.tagExp,p=a.attrExpPresent,d=a.closeIndex;this.options.transformTagName&&(s=this.options.transformTagName(s)),n&&r&&"!xml"!==n.tagname&&(r=this.saveTextToParentTag(r,n,o,!1));const h=n;h&&-1!==this.options.unpairedTags.indexOf(h.tagname)&&(n=this.tagsNodeStack.pop(),o=o.substring(0,o.lastIndexOf("."))),s!==t.tagname&&(o+=o?"."+s:s);const f=i;if(this.isItStopNode(this.options.stopNodes,o,s)){let t="";if(c.length>0&&c.lastIndexOf("/")===c.length-1)"/"===s[s.length-1]?(s=s.substr(0,s.length-1),o=o.substr(0,o.length-1),c=s):c=c.substr(0,c.length-1),i=a.closeIndex;else if(-1!==this.options.unpairedTags.indexOf(s))i=a.closeIndex;else{const n=this.readStopNodeData(e,l,d+1);if(!n)throw new Error(`Unexpected end of ${l}`);i=n.i,t=n.tagContent}const r=new u(s);s!==c&&p&&(r[":@"]=this.buildAttributesMap(c,o,s)),t&&(t=this.parseTextData(t,s,o,!0,p,!0,!0)),o=o.substr(0,o.lastIndexOf(".")),r.add(this.options.textNodeName,t),this.addChild(n,r,o,f)}else{if(c.length>0&&c.lastIndexOf("/")===c.length-1){"/"===s[s.length-1]?(s=s.substr(0,s.length-1),o=o.substr(0,o.length-1),c=s):c=c.substr(0,c.length-1),this.options.transformTagName&&(s=this.options.transformTagName(s));const e=new u(s);s!==c&&p&&(e[":@"]=this.buildAttributesMap(c,o,s)),this.addChild(n,e,o,f),o=o.substr(0,o.lastIndexOf("."))}else{const e=new u(s);this.tagsNodeStack.push(n),s!==c&&p&&(e[":@"]=this.buildAttributesMap(c,o,s)),this.addChild(n,e,o,f),n=e}r="",i=d}}else r+=e[i]}return t.child};function A(e,t,n,r){this.options.captureMetaData||(r=void 0);const o=this.options.updateTag(t.tagname,n,t[":@"]);!1===o||("string"==typeof o?(t.tagname=o,e.addChild(t,r)):e.addChild(t,r))}const D=function(e){if(this.options.processEntities){for(let t in this.docTypeEntities){const n=this.docTypeEntities[t];e=e.replace(n.regx,n.val)}for(let t in this.lastEntities){const n=this.lastEntities[t];e=e.replace(n.regex,n.val)}if(this.options.htmlEntities)for(let t in this.htmlEntities){const n=this.htmlEntities[t];e=e.replace(n.regex,n.val)}e=e.replace(this.ampEntity.regex,this.ampEntity.val)}return e};function N(e,t,n,r){return e&&(void 0===r&&(r=0===t.child.length),void 0!==(e=this.parseTextData(e,t.tagname,n,!1,!!t[":@"]&&0!==Object.keys(t[":@"]).length,r))&&""!==e&&t.add(this.options.textNodeName,e),e=""),e}function F(e,t,n){const r="*."+n;for(const n in e){const o=e[n];if(r===o||t===o)return!0}return!1}function M(e,t,n,r){const o=e.indexOf(t,n);if(-1===o)throw new Error(r);return o+t.length-1}function L(e,t,n,r=">"){const o=function(e,t,n=">"){let r,o="";for(let i=t;i<e.length;i++){let t=e[i];if(r)t===r&&(r="");else if('"'===t||"'"===t)r=t;else if(t===n[0]){if(!n[1])return{data:o,index:i};if(e[i+1]===n[1])return{data:o,index:i}}else"\t"===t&&(t=" ");o+=t}}(e,t+1,r);if(!o)return;let i=o.data;const a=o.index,s=i.search(/\s/);let l=i,c=!0;-1!==s&&(l=i.substring(0,s),i=i.substring(s+1).trimStart());const u=l;if(n){const e=l.indexOf(":");-1!==e&&(l=l.substr(e+1),c=l!==o.data.substr(e+1))}return{tagName:l,tagExp:i,closeIndex:a,attrExpPresent:c,rawTagName:u}}function j(e,t,n){const r=n;let o=1;for(;n<e.length;n++)if("<"===e[n])if("/"===e[n+1]){const i=M(e,">",n,`${t} is not closed`);if(e.substring(n+2,i).trim()===t&&(o--,0===o))return{tagContent:e.substring(r,n),i};n=i}else if("?"===e[n+1]){n=M(e,"?>",n+1,"StopNode is not closed.")}else if("!--"===e.substr(n+1,3)){n=M(e,"--\x3e",n+3,"StopNode is not closed.")}else if("!["===e.substr(n+1,2)){n=M(e,"]]>",n,"StopNode is not closed.")-2}else{const r=L(e,n,">");if(r){(r&&r.tagName)===t&&"/"!==r.tagExp[r.tagExp.length-1]&&o++,n=r.closeIndex}}}function B(e,t,n){if(t&&"string"==typeof e){const t=e.trim();return"true"===t||"false"!==t&&x(e,n)}return void 0!==e?e:""}const R=u.getMetaDataSymbol();function $(e,t){return H(e,t)}function H(e,t,n){let r;const o={};for(let i=0;i<e.length;i++){const a=e[i],s=q(a);let l="";if(l=void 0===n?s:n+"."+s,s===t.textNodeName)void 0===r?r=a[s]:r+=""+a[s];else{if(void 0===s)continue;if(a[s]){let e=H(a[s],t,l);const n=Y(e,t);void 0!==a[R]&&(e[R]=a[R]),a[":@"]?U(e,a[":@"],l,t):1!==Object.keys(e).length||void 0===e[t.textNodeName]||t.alwaysCreateTextNode?0===Object.keys(e).length&&(t.alwaysCreateTextNode?e[t.textNodeName]="":e=""):e=e[t.textNodeName],void 0!==o[s]&&o.hasOwnProperty(s)?(Array.isArray(o[s])||(o[s]=[o[s]]),o[s].push(e)):t.isArray(s,l,n)?o[s]=[e]:o[s]=e}}}return"string"==typeof r?r.length>0&&(o[t.textNodeName]=r):void 0!==r&&(o[t.textNodeName]=r),o}function q(e){const t=Object.keys(e);for(let e=0;e<t.length;e++){const n=t[e];if(":@"!==n)return n}}function U(e,t,n,r){if(t){const o=Object.keys(t),i=o.length;for(let a=0;a<i;a++){const i=o[a];r.isArray(i,n+"."+i,!0,!0)?e[i]=[t[i]]:e[i]=t[i]}}}function Y(e,t){const{textNodeName:n}=t,r=Object.keys(e).length;return 0===r||!(1!==r||!e[n]&&"boolean"!=typeof e[n]&&0!==e[n])}const V={allowBooleanAttributes:!1,unpairedTags:[]};function W(e){return" "===e||"\t"===e||"\n"===e||"\r"===e}function G(e,t){const n=t;for(;t<e.length;t++)if("?"==e[t]||" "==e[t]){const r=e.substr(n,t-n);if(t>5&&"xml"===r)return te("InvalidXml","XML declaration allowed only at the start of the document.",oe(e,t));if("?"==e[t]&&">"==e[t+1]){t++;break}continue}return t}function X(e,t){if(e.length>t+5&&"-"===e[t+1]&&"-"===e[t+2]){for(t+=3;t<e.length;t++)if("-"===e[t]&&"-"===e[t+1]&&">"===e[t+2]){t+=2;break}}else if(e.length>t+8&&"D"===e[t+1]&&"O"===e[t+2]&&"C"===e[t+3]&&"T"===e[t+4]&&"Y"===e[t+5]&&"P"===e[t+6]&&"E"===e[t+7]){let n=1;for(t+=8;t<e.length;t++)if("<"===e[t])n++;else if(">"===e[t]&&(n--,0===n))break}else if(e.length>t+9&&"["===e[t+1]&&"C"===e[t+2]&&"D"===e[t+3]&&"A"===e[t+4]&&"T"===e[t+5]&&"A"===e[t+6]&&"["===e[t+7])for(t+=8;t<e.length;t++)if("]"===e[t]&&"]"===e[t+1]&&">"===e[t+2]){t+=2;break}return t}const K='"',z="'";function J(e,t){let n="",r="",o=!1;for(;t<e.length;t++){if(e[t]===K||e[t]===z)""===r?r=e[t]:r!==e[t]||(r="");else if(">"===e[t]&&""===r){o=!0;break}n+=e[t]}return""===r&&{value:n,index:t,tagClosed:o}}const Z=new RegExp("(\\s*)([^\\s=]+)(\\s*=)?(\\s*(['\"])(([\\s\\S])*?)\\5)?","g");function Q(e,t){const n=s(e,Z),r={};for(let e=0;e<n.length;e++){if(0===n[e][1].length)return te("InvalidAttr","Attribute '"+n[e][2]+"' has no space in starting.",ie(n[e]));if(void 0!==n[e][3]&&void 0===n[e][4])return te("InvalidAttr","Attribute '"+n[e][2]+"' is without value.",ie(n[e]));if(void 0===n[e][3]&&!t.allowBooleanAttributes)return te("InvalidAttr","boolean attribute '"+n[e][2]+"' is not allowed.",ie(n[e]));const o=n[e][2];if(!ne(o))return te("InvalidAttr","Attribute '"+o+"' is an invalid name.",ie(n[e]));if(r.hasOwnProperty(o))return te("InvalidAttr","Attribute '"+o+"' is repeated.",ie(n[e]));r[o]=1}return!0}function ee(e,t){if(";"===e[++t])return-1;if("#"===e[t])return function(e,t){let n=/\d/;for("x"===e[t]&&(t++,n=/[\da-fA-F]/);t<e.length;t++){if(";"===e[t])return t;if(!e[t].match(n))break}return-1}(e,++t);let n=0;for(;t<e.length;t++,n++)if(!(e[t].match(/\w/)&&n<20)){if(";"===e[t])break;return-1}return t}function te(e,t,n){return{err:{code:e,msg:t,line:n.line||n,col:n.col}}}function ne(e){return l(e)}function re(e){return l(e)}function oe(e,t){const n=e.substring(0,t).split(/\r?\n/);return{line:n.length,col:n[n.length-1].length+1}}function ie(e){return e.startIndex+e[1].length}var ae=new class{constructor(e){this.externalEntities={},this.options=function(e){return Object.assign({},o,e)}(e)}parse(e,t){if("string"==typeof e);else{if(!e.toString)throw new Error("XML data is accepted in String or Bytes[] form.");e=e.toString()}if(t){!0===t&&(t={});const n=function(e,t){t=Object.assign({},V,t);const n=[];let r=!1,o=!1;"\ufeff"===e[0]&&(e=e.substr(1));for(let i=0;i<e.length;i++)if("<"===e[i]&&"?"===e[i+1]){if(i+=2,i=G(e,i),i.err)return i}else{if("<"!==e[i]){if(W(e[i]))continue;return te("InvalidChar","char '"+e[i]+"' is not expected.",oe(e,i))}{let a=i;if(i++,"!"===e[i]){i=X(e,i);continue}{let s=!1;"/"===e[i]&&(s=!0,i++);let l="";for(;i<e.length&&">"!==e[i]&&" "!==e[i]&&"\t"!==e[i]&&"\n"!==e[i]&&"\r"!==e[i];i++)l+=e[i];if(l=l.trim(),"/"===l[l.length-1]&&(l=l.substring(0,l.length-1),i--),!re(l)){let t;return t=0===l.trim().length?"Invalid space after '<'.":"Tag '"+l+"' is an invalid name.",te("InvalidTag",t,oe(e,i))}const c=J(e,i);if(!1===c)return te("InvalidAttr","Attributes for '"+l+"' have open quote.",oe(e,i));let u=c.value;if(i=c.index,"/"===u[u.length-1]){const n=i-u.length;u=u.substring(0,u.length-1);const o=Q(u,t);if(!0!==o)return te(o.err.code,o.err.msg,oe(e,n+o.err.line));r=!0}else if(s){if(!c.tagClosed)return te("InvalidTag","Closing tag '"+l+"' doesn't have proper closing.",oe(e,i));if(u.trim().length>0)return te("InvalidTag","Closing tag '"+l+"' can't have attributes or invalid starting.",oe(e,a));if(0===n.length)return te("InvalidTag","Closing tag '"+l+"' has not been opened.",oe(e,a));{const t=n.pop();if(l!==t.tagName){let n=oe(e,t.tagStartPos);return te("InvalidTag","Expected closing tag '"+t.tagName+"' (opened in line "+n.line+", col "+n.col+") instead of closing tag '"+l+"'.",oe(e,a))}0==n.length&&(o=!0)}}else{const s=Q(u,t);if(!0!==s)return te(s.err.code,s.err.msg,oe(e,i-u.length+s.err.line));if(!0===o)return te("InvalidXml","Multiple possible root nodes found.",oe(e,i));-1!==t.unpairedTags.indexOf(l)||n.push({tagName:l,tagStartPos:a}),r=!0}for(i++;i<e.length;i++)if("<"===e[i]){if("!"===e[i+1]){i++,i=X(e,i);continue}if("?"!==e[i+1])break;if(i=G(e,++i),i.err)return i}else if("&"===e[i]){const t=ee(e,i);if(-1==t)return te("InvalidChar","char '&' is not expected.",oe(e,i));i=t}else if(!0===o&&!W(e[i]))return te("InvalidXml","Extra text at the end",oe(e,i));"<"===e[i]&&i--}}}return r?1==n.length?te("InvalidTag","Unclosed tag '"+n[0].tagName+"'.",oe(e,n[0].tagStartPos)):!(n.length>0)||te("InvalidXml","Invalid '"+JSON.stringify(n.map(e=>e.tagName),null,4).replace(/\r?\n/g,"")+"' found.",{line:1,col:1}):te("InvalidXml","Start tag expected.",1)}(e,t);if(!0!==n)throw Error(`${n.err.msg}:${n.err.line}:${n.err.col}`)}const n=new _(this.options);n.addExternalEntities(this.externalEntities);const r=n.parseXml(e);return this.options.preserveOrder||void 0===r?r:$(r,this.options)}addEntity(e,t){if(-1!==t.indexOf("&"))throw new Error("Entity value can't have '&'");if(-1!==e.indexOf("&")||-1!==e.indexOf(";"))throw new Error("An entity must be set without '&' and ';'. Eg. use '#xD' for '&#xD;'");if("&"===t)throw new Error("An entity with value '&' is not permitted");this.externalEntities[e]=t}static getMetaDataSymbol(){return u.getMetaDataSymbol()}}({ignoreAttributes:!1,allowBooleanAttributes:!0});function se(e,t){var n,r,o,i,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if("none"===t){var s=e.trim();return a.previousContent&&(s=a.previousContent+s.trimEnd()),s}var l=e.match(/```(?:\w+\n|\n)([\s\S]*?)```/),c=l?l[1].trim():e.trim();if("xml"===t){var u=c.match(/<response[\s\S]*?<\/response>/i);u&&(c=u[0].trim())}a.previousContent&&(c=a.previousContent+c.trimEnd());try{switch(t){case"xml":var p=ae.parse(c),d=null!==(n=null!==(r=null==p?void 0:p.response)&&void 0!==r?r:null==p||null===(o=p.root)||void 0===o?void 0:o.response)&&void 0!==n?n:null==p||null===(i=p.data)||void 0===i?void 0:i.response;if("string"==typeof d)return d.trim();if(d&&"string"==typeof d["#text"])return d["#text"].trim();if(p&&Object.keys(p).length>0){var h=Object.values(p)[0];if("string"==typeof h)return h.trim();if("string"==typeof(null==h?void 0:h["#text"]))return h["#text"].trim()}throw new Error("Invalid XML format: <response> tag content not found or not a string.");case"json":var f=JSON.parse(c);if(f&&"string"==typeof f.response)return f.response.trim();if(null!=f&&f.response&&Object.keys(f.response).length>0)return String(Object.values(f.response)[0]).trim();if(f&&Object.keys(f).length>0)return String(Object.values(f)[0]).trim();throw new Error('Invalid JSON format: "response" key not found or its value is not a string.');default:throw new Error("Unsupported format specified: ".concat(t))}}catch(n){throw console.error("Error parsing response in format '".concat(t,"':"),n),console.error("Raw content received:",e),"xml"===t&&n.message.includes("Invalid XML")?new Error("Model response is not valid XML or does not contain the <response> tag."):"json"===t&&n instanceof SyntaxError?new Error('Model response is not valid JSON or does not follow the {"response": "..."} structure.'):new Error("Failed to parse response as ".concat(t,": ").concat(n.message))}}function le(e,t){var n=e.trim();switch(t){case"xml":return"<response>\n  ".concat(n);case"json":return'{\n  "response": "'.concat(n);case"none":return n;default:throw new Error("Unsupported format specified: ".concat(t))}}var ce=n(149),ue=n(742),pe=n(639);function de(e){return de="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},de(e)}function he(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,i,a,s=[],l=!0,c=!1;try{if(i=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;l=!1}else for(;!(l=(r=i.call(n)).done)&&(s.push(r.value),s.length!==t);l=!0);}catch(e){c=!0,o=e}finally{try{if(!l&&null!=n.return&&(a=n.return(),Object(a)!==a))return}finally{if(c)throw o}}return s}}(e,t)||xe(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function fe(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function me(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?fe(Object(n),!0).forEach(function(t){ge(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):fe(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function ge(e,t,n){return(t=Ee(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function ve(e){if(null!=e){var t=e["function"==typeof Symbol&&Symbol.iterator||"@@iterator"],n=0;if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length))return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}}}throw new TypeError(de(e)+" is not iterable")}function ye(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function i(n,r,o,i){var l=r&&r.prototype instanceof s?r:s,c=Object.create(l.prototype);return be(c,"_invoke",function(n,r,o){var i,s,l,c=0,u=o||[],p=!1,d={p:0,n:0,v:e,a:h,f:h.bind(e,4),d:function(t,n){return i=t,s=0,l=e,d.n=n,a}};function h(n,r){for(s=n,l=r,t=0;!p&&c&&!o&&t<u.length;t++){var o,i=u[t],h=d.p,f=i[2];n>3?(o=f===r)&&(l=i[(s=i[4])?5:(s=3,3)],i[4]=i[5]=e):i[0]<=h&&((o=n<2&&h<i[1])?(s=0,d.v=r,d.n=i[1]):h<f&&(o=n<3||i[0]>r||r>f)&&(i[4]=n,i[5]=r,d.n=f,s=0))}if(o||n>1)return a;throw p=!0,r}return function(o,u,f){if(c>1)throw TypeError("Generator is already running");for(p&&1===u&&h(u,f),s=u,l=f;(t=s<2?e:l)||!p;){i||(s?s<3?(s>1&&(d.n=-1),h(s,l)):d.n=l:d.v=l);try{if(c=2,i){if(s||(o="next"),t=i[o]){if(!(t=t.call(i,l)))throw TypeError("iterator result is not an object");if(!t.done)return t;l=t.value,s<2&&(s=0)}else 1===s&&(t=i.return)&&t.call(i),s<2&&(l=TypeError("The iterator does not provide a '"+o+"' method"),s=1);i=e}else if((t=(p=d.n<0)?l:n.call(r,d))!==a)break}catch(t){i=e,s=1,l=t}finally{c=1}}return{value:t,done:p}}}(n,o,i),!0),c}var a={};function s(){}function l(){}function c(){}t=Object.getPrototypeOf;var u=[][r]?t(t([][r]())):(be(t={},r,function(){return this}),t),p=c.prototype=s.prototype=Object.create(u);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,be(e,o,"GeneratorFunction")),e.prototype=Object.create(p),e}return l.prototype=c,be(p,"constructor",c),be(c,"constructor",l),l.displayName="GeneratorFunction",be(c,o,"GeneratorFunction"),be(p),be(p,o,"Generator"),be(p,r,function(){return this}),be(p,"toString",function(){return"[object Generator]"}),(ye=function(){return{w:i,m:d}})()}function be(e,t,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}be=function(e,t,n,r){function i(t,n){be(e,t,function(e){return this._invoke(t,n,e)})}t?o?o(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(i("next",0),i("throw",1),i("return",2))},be(e,t,n,r)}function Se(e){return function(e){if(Array.isArray(e))return Ce(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||xe(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function we(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=xe(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){s=!0,i=e},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw i}}}}function xe(e,t){if(e){if("string"==typeof e)return Ce(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Ce(e,t):void 0}}function Ce(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function _e(e,t,n,r,o,i,a){try{var s=e[i](a),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function ke(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,Ee(r.key),r)}}function Ee(e){var t=function(e,t){if("object"!=de(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=de(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==de(t)?t:t+""}var Pe=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return t=e,o=[{key:"buildMessages",value:(a=ye().m(function e(t){var o,i,a,s,l,c,u,p,d,h,f,m,g,v,y,b,S,w,x,C,_,k,E,P,O,I=this;return ye().w(function(e){for(;;)switch(e.p=e.n){case 0:o=t.targetField,i=t.userPrompt,a=t.session,s=t.allCharacters,l=t.entriesGroupByWorldName,c=t.buildPromptOptions,u=t.formatDescription,p=t.includeUserMacro,d=t.continueFrom,h=t.additionalContentPartsForCurrentUserMessage,f=ue.fq.getSettings(),m=this.buildTemplateData({targetField:o,userPrompt:i,session:a,allCharacters:s,entriesGroupByWorldName:l,formatDescription:u,includeUserMacro:p}),g=f.mainContextTemplatePresets[f.mainContextTemplatePreset].prompts.filter(function(e){return e.enabled}).map(function(e){return{promptName:e.promptName,role:e.role}}),v=[],y=we(g),e.p=1,S=ye().m(function e(){var t,o,i,s,l,u,p,d,g,y,S,w,x,C,_,k,E,P;return ye().w(function(e){for(;;)switch(e.n){case 0:if("chatHistory"!==(t=b.value).promptName){e.n=2;break}return o=I.getSelectedApi(c),e.n=1,(0,r.fn)(o,c);case 1:if((i=e.v).warnings&&i.warnings.length>0){s=we(i.warnings);try{for(s.s();!(l=s.n()).done;)u=l.value,(0,ce.YC)("warning",u)}catch(e){s.e(e)}finally{s.f()}}return p=(i.result||[]).filter(function(e){return"user"===e.role||"assistant"===e.role}),v.push.apply(v,Se(p)),e.a(2,0);case 2:if("creatorChatHistory"!==t.promptName){e.n=4;break}return y=null!==(d=null===(g=a.creatorChatHistory)||void 0===g?void 0:g.messages)&&void 0!==d?d:[],e.n=3,Promise.resolve().then(n.bind(n,882));case 3:return S=e.v,w=S.SessionService,x=w.getInstance(),C=y.map(function(e,t){var n=x.getMessageForAIContext(e);if(h&&Array.isArray(n.content)&&"user"===n.role&&t===y.length-1){var r=n.content.filter(function(e){return"text"===(null==e?void 0:e.type)});return{role:n.role,content:r.length>0?r:""}}return{role:n.role,content:n.content}}),v.push.apply(v,Se(C)),e.a(2,0);case 4:if(_=I.getFilteredPromptSettings(f,a),k=_[t.promptName]){e.n=5;break}return e.a(2,0);case 5:E=structuredClone(m),"stDescription"===t.promptName&&(E.char="{{char}}",E.user="{{user}}"),(P={role:t.role,content:pe.compile(k.content||"",{noEscape:!0})(E)}).content=P.content.replaceAll("{{user}}","[[[crec_veryUniqueUserPlaceHolder]]]"),P.content=P.content.replaceAll("{{char}}","[[[crec_veryUniqueCharPlaceHolder]]]"),P.content=Ae.substituteParams(P.content),P.content=P.content.replaceAll("[[[crec_veryUniqueUserPlaceHolder]]]","{{user}}"),P.content=P.content.replaceAll("[[[crec_veryUniqueCharPlaceHolder]]]","{{char}}"),P.content&&v.push(P);case 6:return e.a(2)}},e)}),y.s();case 2:if((b=y.n()).done){e.n=5;break}return e.d(ve(S()),3);case 3:if(0!==e.v){e.n=4;break}return e.a(3,4);case 4:e.n=2;break;case 5:e.n=7;break;case 6:e.p=6,O=e.v,y.e(O);case 7:return e.p=7,y.f(),e.f(7);case 8:if(v.length>0){w=[],x=[],C=we(v);try{for(C.s();!(_=C.n()).done;)"system"===(k=_.value).role?w.push(k):x.push(k)}catch(e){C.e(e)}finally{C.f()}w.length>1?(E=w.map(function(e){return"string"==typeof e.content?e.content:""}).filter(Boolean).join("\n\n"),v.length=0,v.push.apply(v,[{role:"system",content:E}].concat(x))):1===w.length&&(v.length=0,v.push.apply(v,[w[0]].concat(x)))}return h&&h.length>0&&v.push({role:"user",content:h}),d&&(P=f.outputFormat,v.push({role:"assistant",content:le(d,P)})),e.a(2,v)}},e,this,[[1,6,7,8]])}),s=function(){var e=this,t=arguments;return new Promise(function(n,r){var o=a.apply(e,t);function i(e){_e(o,n,r,i,s,"next",e)}function s(e){_e(o,n,r,i,s,"throw",e)}i(void 0)})},function(e){return s.apply(this,arguments)})},{key:"buildTemplateData",value:function(e){var t,n,r,o,i,a,s=e.targetField,l=e.userPrompt,c=e.session,u=e.allCharacters,p=e.entriesGroupByWorldName,d=e.formatDescription,h=e.includeUserMacro,f={};f.char=null!==(t=null===(n=c.fields.name)||void 0===n?void 0:n.value)&&void 0!==t?t:"{{char}}",f.user=h&&ce.py?ce.py:"{{user}}",f.persona="{{persona}}",f.targetField=s,f.userInstructions=pe.compile(l.trim(),{noEscape:!0})(f);var m=null!==(r=null!==(o=null===(i=c.draftFields[s])||void 0===i?void 0:i.prompt)&&void 0!==o?o:null===(a=c.fields[s])||void 0===a?void 0:a.prompt)&&void 0!==r?r:"";f.fieldSpecificInstructions=pe.compile(m,{noEscape:!0})(me(me({},f),{},{char:"mes_example"===s?"{{char}}":f.char,user:"mes_example"===s?"{{user}}":f.user})),f.activeFormatInstructions=pe.compile(d.content||"",{noEscape:!0})(f);var g=[];c.selectedCharacterIndexes.forEach(function(e){var t=parseInt(e),n=u[t];n&&g.push(n)}),f.characters=g,c.creatorChatHistory||(c.creatorChatHistory={messages:[]}),Array.isArray(c.creatorChatHistory.messages)||(c.creatorChatHistory.messages=[]),f.creatorChatHistory=c.creatorChatHistory.messages;var v={};return Object.entries(p).filter(function(e){var t=he(e,2),n=t[0],r=t[1];return r.length>0&&c.selectedWorldNames.includes(n)&&r.some(function(e){return!e.disable})}).forEach(function(e){var t=he(e,2),n=t[0],r=t[1];v[n]=r.filter(function(e){return!e.disable})}),f.lorebooks=v,f.fields=this.buildFieldsContext(c,s),f}},{key:"buildFieldsContext",value:function(e,t){var n=ue.fq.getSettings(),r={},o={},i={},a=t.startsWith("alternate_greetings_"),s=n.contextToSend.dontSendOtherGreetings;return Object.entries(e.fields).forEach(function(n){var i=he(n,2),l=i[0],c=i[1],u=!1;if(s){var p=l.startsWith("alternate_greetings_");u=a?p&&l!==t||"first_mes"===l:p}if(!u){var d,h,f=pe.compile(c.value||"",{noEscape:!0})({char:"mes_example"===l?"{{char}}":null!==(d=null===(h=e.fields.name)||void 0===h?void 0:h.value)&&void 0!==d?d:"{{char}}",user:"{{user}}",persona:"{{persona}}",targetField:t});if(De.includes(l)){var m=c.label||Ne[l]||l;r[m]=f}else l.startsWith("alternate_greetings_")&&(o[l]=f)}}),Object.entries(e.draftFields||{}).forEach(function(n){var r,o,a=he(n,2),s=(a[0],a[1]);i[s.label]=pe.compile(s.value||"",{noEscape:!0})({char:null!==(r=null===(o=e.fields.name)||void 0===o?void 0:o.value)&&void 0!==r?r:"{{char}}",user:"{{user}}",persona:"{{persona}}",targetField:t})}),{core:r,alternate_greetings:o,draft:i}}},{key:"getFilteredPromptSettings",value:function(e,t){var n=structuredClone(e.prompts);return e.contextToSend.stDescription||delete n.stDescription,e.contextToSend.charCard&&0!==t.selectedCharacterIndexes.length||delete n.charDefinitions,e.contextToSend.worldInfo&&0!==t.selectedWorldNames.length||delete n.lorebookDefinitions,e.contextToSend.existingFields||delete n.existingFieldDefinitions,e.contextToSend.persona||delete n.personaDescription,delete n.worldInfoCharDefinition,n}},{key:"getSelectedApi",value:function(e){var t,n=null===(t=Ae.extensionSettings.connectionManager)||void 0===t||null===(t=t.profiles)||void 0===t?void 0:t.find(function(t){return t.preset===e.presetName});if(!n)throw new Error("Connection profile not found for preset: "+e.presetName);var r=n.api?Ae.CONNECT_API_MAP[n.api].selected:void 0;if(!r)throw new Error('Could not determine API for profile "'.concat(n.name,'".'));return r}}],i=[{key:"getInstance",value:function(){return e.instance||(e.instance=new e),e.instance}}],o&&ke(t.prototype,o),i&&ke(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,o,i,a,s}();function Oe(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function i(n,r,o,i){var l=r&&r.prototype instanceof s?r:s,c=Object.create(l.prototype);return Ie(c,"_invoke",function(n,r,o){var i,s,l,c=0,u=o||[],p=!1,d={p:0,n:0,v:e,a:h,f:h.bind(e,4),d:function(t,n){return i=t,s=0,l=e,d.n=n,a}};function h(n,r){for(s=n,l=r,t=0;!p&&c&&!o&&t<u.length;t++){var o,i=u[t],h=d.p,f=i[2];n>3?(o=f===r)&&(l=i[(s=i[4])?5:(s=3,3)],i[4]=i[5]=e):i[0]<=h&&((o=n<2&&h<i[1])?(s=0,d.v=r,d.n=i[1]):h<f&&(o=n<3||i[0]>r||r>f)&&(i[4]=n,i[5]=r,d.n=f,s=0))}if(o||n>1)return a;throw p=!0,r}return function(o,u,f){if(c>1)throw TypeError("Generator is already running");for(p&&1===u&&h(u,f),s=u,l=f;(t=s<2?e:l)||!p;){i||(s?s<3?(s>1&&(d.n=-1),h(s,l)):d.n=l:d.v=l);try{if(c=2,i){if(s||(o="next"),t=i[o]){if(!(t=t.call(i,l)))throw TypeError("iterator result is not an object");if(!t.done)return t;l=t.value,s<2&&(s=0)}else 1===s&&(t=i.return)&&t.call(i),s<2&&(l=TypeError("The iterator does not provide a '"+o+"' method"),s=1);i=e}else if((t=(p=d.n<0)?l:n.call(r,d))!==a)break}catch(t){i=e,s=1,l=t}finally{c=1}}return{value:t,done:p}}}(n,o,i),!0),c}var a={};function s(){}function l(){}function c(){}t=Object.getPrototypeOf;var u=[][r]?t(t([][r]())):(Ie(t={},r,function(){return this}),t),p=c.prototype=s.prototype=Object.create(u);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,Ie(e,o,"GeneratorFunction")),e.prototype=Object.create(p),e}return l.prototype=c,Ie(p,"constructor",c),Ie(c,"constructor",l),l.displayName="GeneratorFunction",Ie(c,o,"GeneratorFunction"),Ie(p),Ie(p,o,"Generator"),Ie(p,r,function(){return this}),Ie(p,"toString",function(){return"[object Generator]"}),(Oe=function(){return{w:i,m:d}})()}function Ie(e,t,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}Ie=function(e,t,n,r){function i(t,n){Ie(e,t,function(e){return this._invoke(t,n,e)})}t?o?o(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(i("next",0),i("throw",1),i("return",2))},Ie(e,t,n,r)}function Te(e,t,n,r,o,i,a){try{var s=e[i](a),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}var Ae=SillyTavern.getContext(),De=["name","description","personality","scenario","first_mes","mes_example"],Ne={name:"Name",description:"Description",personality:"Personality",scenario:"Scenario",first_mes:"First Message",mes_example:"Example Dialogue"};new r.gc("dumb",{}).getSettings();function Fe(e){return Me.apply(this,arguments)}function Me(){var e;return e=Oe().m(function e(t){var n,r,o,i,a,s,l,c,u,p,d,h,f,m,g,v,y,b,S;return Oe().w(function(e){for(;;)switch(e.n){case 0:if(r=t.profileId,o=t.userPrompt,i=t.buildPromptOptions,a=t.continueFrom,s=t.session,l=t.allCharacters,c=t.entriesGroupByWorldName,u=t.formatDescription,p=t.includeUserMacro,d=t.maxResponseToken,h=t.targetField,f=t.outputFormat,m=t.additionalContentPartsForCurrentUserMessage,r){e.n=1;break}throw new Error("No connection profile selected.");case 1:if(g=null===(n=Ae.extensionSettings.connectionManager)||void 0===n||null===(n=n.profiles)||void 0===n?void 0:n.find(function(e){return e.id===r})){e.n=2;break}throw new Error('Connection profile with ID "'.concat(r,'" not found.'));case 2:if(g.api?Ae.CONNECT_API_MAP[g.api].selected:void 0){e.n=3;break}throw new Error('Could not determine API for profile "'.concat(g.name,'".'));case 3:return v=Pe.getInstance(),e.n=4,v.buildMessages({targetField:h,userPrompt:o,session:s,allCharacters:l,entriesGroupByWorldName:c,buildPromptOptions:i,formatDescription:u,includeUserMacro:p,continueFrom:a,additionalContentPartsForCurrentUserMessage:m});case 4:return y=e.v,e.n=5,Ae.ConnectionManagerRequestService.sendRequest(r,y,d,{includePreset:!1});case 5:return b=e.v,S=se(b.content,f,{previousContent:a}),e.a(2,S)}},e)}),Me=function(){var t=this,n=arguments;return new Promise(function(r,o){var i=e.apply(t,n);function a(e){Te(i,r,o,a,s,"next",e)}function s(e){Te(i,r,o,a,s,"throw",e)}a(void 0)})},Me.apply(this,arguments)}},277:(e,t,n)=>{function r(e){return e&&e.__esModule?e:{default:e}}t.__esModule=!0,t.registerDefaultHelpers=function(e){o.default(e),i.default(e),a.default(e),s.default(e),l.default(e),c.default(e),u.default(e)},t.moveHelperToHooks=function(e,t,n){e.helpers[t]&&(e.hooks[t]=e.helpers[t],n||delete e.helpers[t])};var o=r(n(97)),i=r(n(785)),a=r(n(353)),s=r(n(355)),l=r(n(300)),c=r(n(466)),u=r(n(908))},300:(e,t)=>{t.__esModule=!0,t.default=function(e){e.registerHelper("log",function(){for(var t=[void 0],n=arguments[arguments.length-1],r=0;r<arguments.length-1;r++)t.push(arguments[r]);var o=1;null!=n.hash.level?o=n.hash.level:n.data&&null!=n.data.level&&(o=n.data.level),t[0]=o,e.log.apply(e,t)})},e.exports=t.default},350:(e,t,n)=>{t.__esModule=!0;var r,o=n(769),i=(r=o)&&r.__esModule?r:{default:r};function a(){this.parents=[]}function s(e){this.acceptRequired(e,"path"),this.acceptArray(e.params),this.acceptKey(e,"hash")}function l(e){s.call(this,e),this.acceptKey(e,"program"),this.acceptKey(e,"inverse")}function c(e){this.acceptRequired(e,"name"),this.acceptArray(e.params),this.acceptKey(e,"hash")}a.prototype={constructor:a,mutating:!1,acceptKey:function(e,t){var n=this.accept(e[t]);if(this.mutating){if(n&&!a.prototype[n.type])throw new i.default('Unexpected node type "'+n.type+'" found when accepting '+t+" on "+e.type);e[t]=n}},acceptRequired:function(e,t){if(this.acceptKey(e,t),!e[t])throw new i.default(e.type+" requires "+t)},acceptArray:function(e){for(var t=0,n=e.length;t<n;t++)this.acceptKey(e,t),e[t]||(e.splice(t,1),t--,n--)},accept:function(e){if(e){if(!this[e.type])throw new i.default("Unknown type: "+e.type,e);this.current&&this.parents.unshift(this.current),this.current=e;var t=this[e.type](e);return this.current=this.parents.shift(),!this.mutating||t?t:!1!==t?e:void 0}},Program:function(e){this.acceptArray(e.body)},MustacheStatement:s,Decorator:s,BlockStatement:l,DecoratorBlock:l,PartialStatement:c,PartialBlockStatement:function(e){c.call(this,e),this.acceptKey(e,"program")},ContentStatement:function(){},CommentStatement:function(){},SubExpression:s,PathExpression:function(){},StringLiteral:function(){},NumberLiteral:function(){},BooleanLiteral:function(){},UndefinedLiteral:function(){},NullLiteral:function(){},Hash:function(e){this.acceptArray(e.pairs)},HashPair:function(e){this.acceptRequired(e,"value")}},t.default=a,e.exports=t.default},353:(e,t,n)=>{t.__esModule=!0;var r,o=n(769),i=(r=o)&&r.__esModule?r:{default:r};t.default=function(e){e.registerHelper("helperMissing",function(){if(1!==arguments.length)throw new i.default('Missing helper: "'+arguments[arguments.length-1].name+'"')})},e.exports=t.default},355:(e,t,n)=>{t.__esModule=!0;var r,o=n(849),i=n(769),a=(r=i)&&r.__esModule?r:{default:r};t.default=function(e){e.registerHelper("if",function(e,t){if(2!=arguments.length)throw new a.default("#if requires exactly one argument");return o.isFunction(e)&&(e=e.call(this)),!t.hash.includeZero&&!e||o.isEmpty(e)?t.inverse(this):t.fn(this)}),e.registerHelper("unless",function(t,n){if(2!=arguments.length)throw new a.default("#unless requires exactly one argument");return e.helpers.if.call(this,t,{fn:n.inverse,inverse:n.fn,hash:n.hash})})},e.exports=t.default},425:(e,t,n)=>{t.__esModule=!0,t.SourceLocation=function(e,t){this.source=e,this.start={line:t.first_line,column:t.first_column},this.end={line:t.last_line,column:t.last_column}},t.id=function(e){return/^\[.*\]$/.test(e)?e.substring(1,e.length-1):e},t.stripFlags=function(e,t){return{open:"~"===e.charAt(2),close:"~"===t.charAt(t.length-3)}},t.stripComment=function(e){return e.replace(/^\{\{~?!-?-?/,"").replace(/-?-?~?\}\}$/,"")},t.preparePath=function(e,t,n){n=this.locInfo(n);for(var r=e?"@":"",o=[],a=0,s=0,l=t.length;s<l;s++){var c=t[s].part,u=t[s].original!==c;if(r+=(t[s].separator||"")+c,u||".."!==c&&"."!==c&&"this"!==c)o.push(c);else{if(o.length>0)throw new i.default("Invalid path: "+r,{loc:n});".."===c&&a++}}return{type:"PathExpression",data:e,depth:a,parts:o,original:r,loc:n}},t.prepareMustache=function(e,t,n,r,o,i){var a=r.charAt(3)||r.charAt(2),s="{"!==a&&"&"!==a;return{type:/\*/.test(r)?"Decorator":"MustacheStatement",path:e,params:t,hash:n,escaped:s,strip:o,loc:this.locInfo(i)}},t.prepareRawBlock=function(e,t,n,r){a(e,n),r=this.locInfo(r);var o={type:"Program",body:t,strip:{},loc:r};return{type:"BlockStatement",path:e.path,params:e.params,hash:e.hash,program:o,openStrip:{},inverseStrip:{},closeStrip:{},loc:r}},t.prepareBlock=function(e,t,n,r,o,s){r&&r.path&&a(e,r);var l=/\*/.test(e.open);t.blockParams=e.blockParams;var c=void 0,u=void 0;if(n){if(l)throw new i.default("Unexpected inverse block on decorator",n);n.chain&&(n.program.body[0].closeStrip=r.strip),u=n.strip,c=n.program}o&&(o=c,c=t,t=o);return{type:l?"DecoratorBlock":"BlockStatement",path:e.path,params:e.params,hash:e.hash,program:t,inverse:c,openStrip:e.strip,inverseStrip:u,closeStrip:r&&r.strip,loc:this.locInfo(s)}},t.prepareProgram=function(e,t){if(!t&&e.length){var n=e[0].loc,r=e[e.length-1].loc;n&&r&&(t={source:n.source,start:{line:n.start.line,column:n.start.column},end:{line:r.end.line,column:r.end.column}})}return{type:"Program",body:e,strip:{},loc:t}},t.preparePartialBlock=function(e,t,n,r){return a(e,n),{type:"PartialBlockStatement",name:e.path,params:e.params,hash:e.hash,program:t,openStrip:e.strip,closeStrip:n&&n.strip,loc:this.locInfo(r)}};var r,o=n(769),i=(r=o)&&r.__esModule?r:{default:r};function a(e,t){if(t=t.path?t.path.original:t,e.path.original!==t){var n={loc:e.path.loc};throw new i.default(e.path.original+" doesn't match "+t,n)}}},430:(e,t,n)=>{t.__esModule=!0;var r=n(849);t.default=function(e){e.registerDecorator("inline",function(e,t,n,o){var i=e;return t.partials||(t.partials={},i=function(o,i){var a=n.partials;n.partials=r.extend({},a,t.partials);var s=e(o,i);return n.partials=a,s}),t.partials[o.args[0]]=o.fn,i})},e.exports=t.default},452:(e,t,n)=>{var r,o;n.r(t),n.d(t,{POPUP_RESULT:()=>o,POPUP_TYPE:()=>r}),function(e){e[e.TEXT=1]="TEXT",e[e.CONFIRM=2]="CONFIRM",e[e.INPUT=3]="INPUT",e[e.DISPLAY=4]="DISPLAY"}(r||(r={})),function(e){e[e.AFFIRMATIVE=1]="AFFIRMATIVE",e[e.NEGATIVE=0]="NEGATIVE",e[e.CANCELLED=null]="CANCELLED"}(o||(o={}))},466:(e,t)=>{t.__esModule=!0,t.default=function(e){e.registerHelper("lookup",function(e,t,n){return e?n.lookupProperty(e,t):e})},e.exports=t.default},566:(e,t,n)=>{t.__esModule=!0;var r=n(849),o={methodMap:["debug","info","warn","error"],level:"info",lookupLevel:function(e){if("string"==typeof e){var t=r.indexOf(o.methodMap,e.toLowerCase());e=t>=0?t:parseInt(e,10)}return e},log:function(e){if(e=o.lookupLevel(e),"undefined"!=typeof console&&o.lookupLevel(o.level)<=e){var t=o.methodMap[e];console[t]||(t="log");for(var n=arguments.length,r=Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];console[t].apply(console,r)}}};t.default=o,e.exports=t.default},613:(e,t)=>{function n(e){this.string=e}t.__esModule=!0,n.prototype.toString=n.prototype.toHTML=function(){return""+this.string},t.default=n,e.exports=t.default},614:(e,t)=>{t.__esModule=!0,t.wrapHelper=function(e,t){if("function"!=typeof e)return e;return function(){return arguments[arguments.length-1]=t(arguments[arguments.length-1]),e.apply(this,arguments)}}},624:(e,t,n)=>{t.__esModule=!0,t.checkRevision=function(e){var t=e&&e[0]||1,n=s.COMPILER_REVISION;if(t>=s.LAST_COMPATIBLE_COMPILER_REVISION&&t<=s.COMPILER_REVISION)return;if(t<s.LAST_COMPATIBLE_COMPILER_REVISION){var r=s.REVISION_CHANGES[n],o=s.REVISION_CHANGES[t];throw new a.default("Template was precompiled with an older version of Handlebars than the current runtime. Please update your precompiler to a newer version ("+r+") or downgrade your runtime to an older version ("+o+").")}throw new a.default("Template was precompiled with a newer version of Handlebars than the current runtime. Please update your runtime to a newer version ("+e[1]+").")},t.template=function(e,t){if(!t)throw new a.default("No environment passed to template");if(!e||!e.main)throw new a.default("Unknown template object: "+typeof e);e.main.decorator=e.main_d,t.VM.checkRevision(e.compiler);var n=e.compiler&&7===e.compiler[0];var r={strict:function(e,t,n){if(!e||!(t in e))throw new a.default('"'+t+'" not defined in '+e,{loc:n});return r.lookupProperty(e,t)},lookupProperty:function(e,t){var n=e[t];return null==n||Object.prototype.hasOwnProperty.call(e,t)||u.resultIsAllowed(n,r.protoAccessControl,t)?n:void 0},lookup:function(e,t){for(var n=e.length,o=0;o<n;o++){if(null!=(e[o]&&r.lookupProperty(e[o],t)))return e[o][t]}},lambda:function(e,t){return"function"==typeof e?e.call(t):e},escapeExpression:o.escapeExpression,invokePartial:function(n,r,i){i.hash&&(r=o.extend({},r,i.hash),i.ids&&(i.ids[0]=!0)),n=t.VM.resolvePartial.call(this,n,r,i);var s=o.extend({},i,{hooks:this.hooks,protoAccessControl:this.protoAccessControl}),l=t.VM.invokePartial.call(this,n,r,s);if(null==l&&t.compile&&(i.partials[i.name]=t.compile(n,e.compilerOptions,t),l=i.partials[i.name](r,s)),null!=l){if(i.indent){for(var c=l.split("\n"),u=0,p=c.length;u<p&&(c[u]||u+1!==p);u++)c[u]=i.indent+c[u];l=c.join("\n")}return l}throw new a.default("The partial "+i.name+" could not be compiled when running in runtime-only mode")},fn:function(t){var n=e[t];return n.decorator=e[t+"_d"],n},programs:[],program:function(e,t,n,r,o){var i=this.programs[e],a=this.fn(e);return t||o||r||n?i=p(this,e,a,t,n,r,o):i||(i=this.programs[e]=p(this,e,a)),i},data:function(e,t){for(;e&&t--;)e=e._parent;return e},mergeIfNeeded:function(e,t){var n=e||t;return e&&t&&e!==t&&(n=o.extend({},t,e)),n},nullContext:Object.seal({}),noop:t.VM.noop,compilerInfo:e.compiler};function i(t){var n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],o=n.data;i._setup(n),!n.partial&&e.useData&&(o=function(e,t){t&&"root"in t||((t=t?s.createFrame(t):{}).root=e);return t}(t,o));var a=void 0,l=e.useBlockParams?[]:void 0;function c(t){return""+e.main(r,t,r.helpers,r.partials,o,l,a)}return e.useDepths&&(a=n.depths?t!=n.depths[0]?[t].concat(n.depths):n.depths:[t]),(c=h(e.main,c,r,n.depths||[],o,l))(t,n)}return i.isTop=!0,i._setup=function(i){if(i.partial)r.protoAccessControl=i.protoAccessControl,r.helpers=i.helpers,r.partials=i.partials,r.decorators=i.decorators,r.hooks=i.hooks;else{var a=o.extend({},t.helpers,i.helpers);!function(e,t){Object.keys(e).forEach(function(n){var r=e[n];e[n]=function(e,t){var n=t.lookupProperty;return c.wrapHelper(e,function(e){return o.extend({lookupProperty:n},e)})}(r,t)})}(a,r),r.helpers=a,e.usePartial&&(r.partials=r.mergeIfNeeded(i.partials,t.partials)),(e.usePartial||e.useDecorators)&&(r.decorators=o.extend({},t.decorators,i.decorators)),r.hooks={},r.protoAccessControl=u.createProtoAccessControl(i);var s=i.allowCallsToHelperMissing||n;l.moveHelperToHooks(r,"helperMissing",s),l.moveHelperToHooks(r,"blockHelperMissing",s)}},i._child=function(t,n,o,i){if(e.useBlockParams&&!o)throw new a.default("must pass block params");if(e.useDepths&&!i)throw new a.default("must pass parent depths");return p(r,t,e[t],n,0,o,i)},i},t.wrapProgram=p,t.resolvePartial=function(e,t,n){e?e.call||n.name||(n.name=e,e=n.partials[e]):e="@partial-block"===n.name?n.data["partial-block"]:n.partials[n.name];return e},t.invokePartial=function(e,t,n){var r=n.data&&n.data["partial-block"];n.partial=!0,n.ids&&(n.data.contextPath=n.ids[0]||n.data.contextPath);var i=void 0;n.fn&&n.fn!==d&&function(){n.data=s.createFrame(n.data);var e=n.fn;i=n.data["partial-block"]=function(t){var n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return n.data=s.createFrame(n.data),n.data["partial-block"]=r,e(t,n)},e.partials&&(n.partials=o.extend({},n.partials,e.partials))}();void 0===e&&i&&(e=i);if(void 0===e)throw new a.default("The partial "+n.name+" could not be found");if(e instanceof Function)return e(t,n)},t.noop=d;var r,o=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(n(849)),i=n(769),a=(r=i)&&r.__esModule?r:{default:r},s=n(871),l=n(277),c=n(614),u=n(865);function p(e,t,n,r,o,i,a){function s(t){var o=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],s=a;return!a||t==a[0]||t===e.nullContext&&null===a[0]||(s=[t].concat(a)),n(e,t,e.helpers,e.partials,o.data||r,i&&[o.blockParams].concat(i),s)}return(s=h(n,s,e,a,r,i)).program=t,s.depth=a?a.length:0,s.blockParams=o||0,s}function d(){return""}function h(e,t,n,r,i,a){if(e.decorator){var s={};t=e.decorator(t,s,n,r&&r[0],i,a,r),o.extend(t,s)}return t}},632:(e,t,n)=>{t.__esModule=!0;var r=n(849),o=void 0;try{}catch(e){}function i(e,t,n){if(r.isArray(e)){for(var o=[],i=0,a=e.length;i<a;i++)o.push(t.wrap(e[i],n));return o}return"boolean"==typeof e||"number"==typeof e?e+"":e}function a(e){this.srcFile=e,this.source=[]}o||((o=function(e,t,n,r){this.src="",r&&this.add(r)}).prototype={add:function(e){r.isArray(e)&&(e=e.join("")),this.src+=e},prepend:function(e){r.isArray(e)&&(e=e.join("")),this.src=e+this.src},toStringWithSourceMap:function(){return{code:this.toString()}},toString:function(){return this.src}}),a.prototype={isEmpty:function(){return!this.source.length},prepend:function(e,t){this.source.unshift(this.wrap(e,t))},push:function(e,t){this.source.push(this.wrap(e,t))},merge:function(){var e=this.empty();return this.each(function(t){e.add(["  ",t,"\n"])}),e},each:function(e){for(var t=0,n=this.source.length;t<n;t++)e(this.source[t])},empty:function(){var e=this.currentLocation||{start:{}};return new o(e.start.line,e.start.column,this.srcFile)},wrap:function(e){var t=arguments.length<=1||void 0===arguments[1]?this.currentLocation||{start:{}}:arguments[1];return e instanceof o?e:(e=i(e,this,t),new o(t.start.line,t.start.column,this.srcFile,e))},functionCall:function(e,t,n){return n=this.generateList(n),this.wrap([e,t?"."+t+"(":"(",n,")"])},quotedString:function(e){return'"'+(e+"").replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")+'"'},objectLiteral:function(e){var t=this,n=[];Object.keys(e).forEach(function(r){var o=i(e[r],t);"undefined"!==o&&n.push([t.quotedString(r),":",o])});var r=this.generateList(n);return r.prepend("{"),r.add("}"),r},generateList:function(e){for(var t=this.empty(),n=0,r=e.length;n<r;n++)n&&t.add(","),t.add(i(e[n],this));return t},generateArray:function(e){var t=this.generateList(e);return t.prepend("["),t.add("]"),t}},t.default=a,e.exports=t.default},639:(e,t,n)=>{function r(e){return e&&e.__esModule?e:{default:e}}t.__esModule=!0;var o=r(n(261)),i=r(n(919)),a=n(27),s=n(127),l=r(n(727)),c=r(n(350)),u=r(n(148)),p=o.default.create;function d(){var e=p();return e.compile=function(t,n){return s.compile(t,n,e)},e.precompile=function(t,n){return s.precompile(t,n,e)},e.AST=i.default,e.Compiler=s.Compiler,e.JavaScriptCompiler=l.default,e.Parser=a.parser,e.parse=a.parse,e.parseWithoutProcessing=a.parseWithoutProcessing,e}var h=d();h.create=d,u.default(h),h.Visitor=c.default,h.default=h,t.default=h,e.exports=t.default},726:(e,t,n)=>{t.__esModule=!0,t.createNewLookupObject=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return r.extend.apply(void 0,[Object.create(null)].concat(t))};var r=n(849)},727:(e,t,n)=>{function r(e){return e&&e.__esModule?e:{default:e}}t.__esModule=!0;var o=n(871),i=r(n(769)),a=n(849),s=r(n(632));function l(e){this.value=e}function c(){}c.prototype={nameLookup:function(e,t){return this.internalNameLookup(e,t)},depthedLookup:function(e){return[this.aliasable("container.lookup"),"(depths, ",JSON.stringify(e),")"]},compilerInfo:function(){var e=o.COMPILER_REVISION;return[e,o.REVISION_CHANGES[e]]},appendToBuffer:function(e,t,n){return a.isArray(e)||(e=[e]),e=this.source.wrap(e,t),this.environment.isSimple?["return ",e,";"]:n?["buffer += ",e,";"]:(e.appendToBuffer=!0,e)},initializeBuffer:function(){return this.quotedString("")},internalNameLookup:function(e,t){return this.lookupPropertyFunctionIsUsed=!0,["lookupProperty(",e,",",JSON.stringify(t),")"]},lookupPropertyFunctionIsUsed:!1,compile:function(e,t,n,r){this.environment=e,this.options=t,this.stringParams=this.options.stringParams,this.trackIds=this.options.trackIds,this.precompile=!r,this.name=this.environment.name,this.isChild=!!n,this.context=n||{decorators:[],programs:[],environments:[]},this.preamble(),this.stackSlot=0,this.stackVars=[],this.aliases={},this.registers={list:[]},this.hashes=[],this.compileStack=[],this.inlineStack=[],this.blockParams=[],this.compileChildren(e,t),this.useDepths=this.useDepths||e.useDepths||e.useDecorators||this.options.compat,this.useBlockParams=this.useBlockParams||e.useBlockParams;var o=e.opcodes,a=void 0,s=void 0,l=void 0,c=void 0;for(l=0,c=o.length;l<c;l++)a=o[l],this.source.currentLocation=a.loc,s=s||a.loc,this[a.opcode].apply(this,a.args);if(this.source.currentLocation=s,this.pushSource(""),this.stackSlot||this.inlineStack.length||this.compileStack.length)throw new i.default("Compile completed with content left on stack");this.decorators.isEmpty()?this.decorators=void 0:(this.useDecorators=!0,this.decorators.prepend(["var decorators = container.decorators, ",this.lookupPropertyFunctionVarDeclaration(),";\n"]),this.decorators.push("return fn;"),r?this.decorators=Function.apply(this,["fn","props","container","depth0","data","blockParams","depths",this.decorators.merge()]):(this.decorators.prepend("function(fn, props, container, depth0, data, blockParams, depths) {\n"),this.decorators.push("}\n"),this.decorators=this.decorators.merge()));var u=this.createFunctionContext(r);if(this.isChild)return u;var p={compiler:this.compilerInfo(),main:u};this.decorators&&(p.main_d=this.decorators,p.useDecorators=!0);var d=this.context,h=d.programs,f=d.decorators;for(l=0,c=h.length;l<c;l++)h[l]&&(p[l]=h[l],f[l]&&(p[l+"_d"]=f[l],p.useDecorators=!0));return this.environment.usePartial&&(p.usePartial=!0),this.options.data&&(p.useData=!0),this.useDepths&&(p.useDepths=!0),this.useBlockParams&&(p.useBlockParams=!0),this.options.compat&&(p.compat=!0),r?p.compilerOptions=this.options:(p.compiler=JSON.stringify(p.compiler),this.source.currentLocation={start:{line:1,column:0}},p=this.objectLiteral(p),t.srcName?(p=p.toStringWithSourceMap({file:t.destName})).map=p.map&&p.map.toString():p=p.toString()),p},preamble:function(){this.lastContext=0,this.source=new s.default(this.options.srcName),this.decorators=new s.default(this.options.srcName)},createFunctionContext:function(e){var t=this,n="",r=this.stackVars.concat(this.registers.list);r.length>0&&(n+=", "+r.join(", "));var o=0;Object.keys(this.aliases).forEach(function(e){var r=t.aliases[e];r.children&&r.referenceCount>1&&(n+=", alias"+ ++o+"="+e,r.children[0]="alias"+o)}),this.lookupPropertyFunctionIsUsed&&(n+=", "+this.lookupPropertyFunctionVarDeclaration());var i=["container","depth0","helpers","partials","data"];(this.useBlockParams||this.useDepths)&&i.push("blockParams"),this.useDepths&&i.push("depths");var a=this.mergeSource(n);return e?(i.push(a),Function.apply(this,i)):this.source.wrap(["function(",i.join(","),") {\n  ",a,"}"])},mergeSource:function(e){var t=this.environment.isSimple,n=!this.forceBuffer,r=void 0,o=void 0,i=void 0,a=void 0;return this.source.each(function(e){e.appendToBuffer?(i?e.prepend("  + "):i=e,a=e):(i&&(o?i.prepend("buffer += "):r=!0,a.add(";"),i=a=void 0),o=!0,t||(n=!1))}),n?i?(i.prepend("return "),a.add(";")):o||this.source.push('return "";'):(e+=", buffer = "+(r?"":this.initializeBuffer()),i?(i.prepend("return buffer + "),a.add(";")):this.source.push("return buffer;")),e&&this.source.prepend("var "+e.substring(2)+(r?"":";\n")),this.source.merge()},lookupPropertyFunctionVarDeclaration:function(){return"\n      lookupProperty = container.lookupProperty || function(parent, propertyName) {\n        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {\n          return parent[propertyName];\n        }\n        return undefined\n    }\n    ".trim()},blockValue:function(e){var t=this.aliasable("container.hooks.blockHelperMissing"),n=[this.contextName(0)];this.setupHelperArgs(e,0,n);var r=this.popStack();n.splice(1,0,r),this.push(this.source.functionCall(t,"call",n))},ambiguousBlockValue:function(){var e=this.aliasable("container.hooks.blockHelperMissing"),t=[this.contextName(0)];this.setupHelperArgs("",0,t,!0),this.flushInline();var n=this.topStack();t.splice(1,0,n),this.pushSource(["if (!",this.lastHelper,") { ",n," = ",this.source.functionCall(e,"call",t),"}"])},appendContent:function(e){this.pendingContent?e=this.pendingContent+e:this.pendingLocation=this.source.currentLocation,this.pendingContent=e},append:function(){if(this.isInline())this.replaceStack(function(e){return[" != null ? ",e,' : ""']}),this.pushSource(this.appendToBuffer(this.popStack()));else{var e=this.popStack();this.pushSource(["if (",e," != null) { ",this.appendToBuffer(e,void 0,!0)," }"]),this.environment.isSimple&&this.pushSource(["else { ",this.appendToBuffer("''",void 0,!0)," }"])}},appendEscaped:function(){this.pushSource(this.appendToBuffer([this.aliasable("container.escapeExpression"),"(",this.popStack(),")"]))},getContext:function(e){this.lastContext=e},pushContext:function(){this.pushStackLiteral(this.contextName(this.lastContext))},lookupOnContext:function(e,t,n,r){var o=0;r||!this.options.compat||this.lastContext?this.pushContext():this.push(this.depthedLookup(e[o++])),this.resolvePath("context",e,o,t,n)},lookupBlockParam:function(e,t){this.useBlockParams=!0,this.push(["blockParams[",e[0],"][",e[1],"]"]),this.resolvePath("context",t,1)},lookupData:function(e,t,n){e?this.pushStackLiteral("container.data(data, "+e+")"):this.pushStackLiteral("data"),this.resolvePath("data",t,0,!0,n)},resolvePath:function(e,t,n,r,o){var i=this;if(this.options.strict||this.options.assumeObjects)this.push(function(e,t,n,r,o){var i=t.popStack(),a=n.length;e&&a--;for(;r<a;r++)i=t.nameLookup(i,n[r],o);return e?[t.aliasable("container.strict"),"(",i,", ",t.quotedString(n[r]),", ",JSON.stringify(t.source.currentLocation)," )"]:i}(this.options.strict&&o,this,t,n,e));else for(var a=t.length;n<a;n++)this.replaceStack(function(o){var a=i.nameLookup(o,t[n],e);return r?[" && ",a]:[" != null ? ",a," : ",o]})},resolvePossibleLambda:function(){this.push([this.aliasable("container.lambda"),"(",this.popStack(),", ",this.contextName(0),")"])},pushStringParam:function(e,t){this.pushContext(),this.pushString(t),"SubExpression"!==t&&("string"==typeof e?this.pushString(e):this.pushStackLiteral(e))},emptyHash:function(e){this.trackIds&&this.push("{}"),this.stringParams&&(this.push("{}"),this.push("{}")),this.pushStackLiteral(e?"undefined":"{}")},pushHash:function(){this.hash&&this.hashes.push(this.hash),this.hash={values:{},types:[],contexts:[],ids:[]}},popHash:function(){var e=this.hash;this.hash=this.hashes.pop(),this.trackIds&&this.push(this.objectLiteral(e.ids)),this.stringParams&&(this.push(this.objectLiteral(e.contexts)),this.push(this.objectLiteral(e.types))),this.push(this.objectLiteral(e.values))},pushString:function(e){this.pushStackLiteral(this.quotedString(e))},pushLiteral:function(e){this.pushStackLiteral(e)},pushProgram:function(e){null!=e?this.pushStackLiteral(this.programExpression(e)):this.pushStackLiteral(null)},registerDecorator:function(e,t){var n=this.nameLookup("decorators",t,"decorator"),r=this.setupHelperArgs(t,e);this.decorators.push(["fn = ",this.decorators.functionCall(n,"",["fn","props","container",r])," || fn;"])},invokeHelper:function(e,t,n){var r=this.popStack(),o=this.setupHelper(e,t),i=[];n&&i.push(o.name),i.push(r),this.options.strict||i.push(this.aliasable("container.hooks.helperMissing"));var a=["(",this.itemsSeparatedBy(i,"||"),")"],s=this.source.functionCall(a,"call",o.callParams);this.push(s)},itemsSeparatedBy:function(e,t){var n=[];n.push(e[0]);for(var r=1;r<e.length;r++)n.push(t,e[r]);return n},invokeKnownHelper:function(e,t){var n=this.setupHelper(e,t);this.push(this.source.functionCall(n.name,"call",n.callParams))},invokeAmbiguous:function(e,t){this.useRegister("helper");var n=this.popStack();this.emptyHash();var r=this.setupHelper(0,e,t),o=["(","(helper = ",this.lastHelper=this.nameLookup("helpers",e,"helper")," || ",n,")"];this.options.strict||(o[0]="(helper = ",o.push(" != null ? helper : ",this.aliasable("container.hooks.helperMissing"))),this.push(["(",o,r.paramsInit?["),(",r.paramsInit]:[],"),","(typeof helper === ",this.aliasable('"function"')," ? ",this.source.functionCall("helper","call",r.callParams)," : helper))"])},invokePartial:function(e,t,n){var r=[],o=this.setupParams(t,1,r);e&&(t=this.popStack(),delete o.name),n&&(o.indent=JSON.stringify(n)),o.helpers="helpers",o.partials="partials",o.decorators="container.decorators",e?r.unshift(t):r.unshift(this.nameLookup("partials",t,"partial")),this.options.compat&&(o.depths="depths"),o=this.objectLiteral(o),r.push(o),this.push(this.source.functionCall("container.invokePartial","",r))},assignToHash:function(e){var t=this.popStack(),n=void 0,r=void 0,o=void 0;this.trackIds&&(o=this.popStack()),this.stringParams&&(r=this.popStack(),n=this.popStack());var i=this.hash;n&&(i.contexts[e]=n),r&&(i.types[e]=r),o&&(i.ids[e]=o),i.values[e]=t},pushId:function(e,t,n){"BlockParam"===e?this.pushStackLiteral("blockParams["+t[0]+"].path["+t[1]+"]"+(n?" + "+JSON.stringify("."+n):"")):"PathExpression"===e?this.pushString(t):"SubExpression"===e?this.pushStackLiteral("true"):this.pushStackLiteral("null")},compiler:c,compileChildren:function(e,t){for(var n=e.children,r=void 0,o=void 0,i=0,a=n.length;i<a;i++){r=n[i],o=new this.compiler;var s=this.matchExistingProgram(r);if(null==s){this.context.programs.push("");var l=this.context.programs.length;r.index=l,r.name="program"+l,this.context.programs[l]=o.compile(r,t,this.context,!this.precompile),this.context.decorators[l]=o.decorators,this.context.environments[l]=r,this.useDepths=this.useDepths||o.useDepths,this.useBlockParams=this.useBlockParams||o.useBlockParams,r.useDepths=this.useDepths,r.useBlockParams=this.useBlockParams}else r.index=s.index,r.name="program"+s.index,this.useDepths=this.useDepths||s.useDepths,this.useBlockParams=this.useBlockParams||s.useBlockParams}},matchExistingProgram:function(e){for(var t=0,n=this.context.environments.length;t<n;t++){var r=this.context.environments[t];if(r&&r.equals(e))return r}},programExpression:function(e){var t=this.environment.children[e],n=[t.index,"data",t.blockParams];return(this.useBlockParams||this.useDepths)&&n.push("blockParams"),this.useDepths&&n.push("depths"),"container.program("+n.join(", ")+")"},useRegister:function(e){this.registers[e]||(this.registers[e]=!0,this.registers.list.push(e))},push:function(e){return e instanceof l||(e=this.source.wrap(e)),this.inlineStack.push(e),e},pushStackLiteral:function(e){this.push(new l(e))},pushSource:function(e){this.pendingContent&&(this.source.push(this.appendToBuffer(this.source.quotedString(this.pendingContent),this.pendingLocation)),this.pendingContent=void 0),e&&this.source.push(e)},replaceStack:function(e){var t=["("],n=void 0,r=void 0,o=void 0;if(!this.isInline())throw new i.default("replaceStack on non-inline");var a=this.popStack(!0);if(a instanceof l)t=["(",n=[a.value]],o=!0;else{r=!0;var s=this.incrStack();t=["((",this.push(s)," = ",a,")"],n=this.topStack()}var c=e.call(this,n);o||this.popStack(),r&&this.stackSlot--,this.push(t.concat(c,")"))},incrStack:function(){return this.stackSlot++,this.stackSlot>this.stackVars.length&&this.stackVars.push("stack"+this.stackSlot),this.topStackName()},topStackName:function(){return"stack"+this.stackSlot},flushInline:function(){var e=this.inlineStack;this.inlineStack=[];for(var t=0,n=e.length;t<n;t++){var r=e[t];if(r instanceof l)this.compileStack.push(r);else{var o=this.incrStack();this.pushSource([o," = ",r,";"]),this.compileStack.push(o)}}},isInline:function(){return this.inlineStack.length},popStack:function(e){var t=this.isInline(),n=(t?this.inlineStack:this.compileStack).pop();if(!e&&n instanceof l)return n.value;if(!t){if(!this.stackSlot)throw new i.default("Invalid stack pop");this.stackSlot--}return n},topStack:function(){var e=this.isInline()?this.inlineStack:this.compileStack,t=e[e.length-1];return t instanceof l?t.value:t},contextName:function(e){return this.useDepths&&e?"depths["+e+"]":"depth"+e},quotedString:function(e){return this.source.quotedString(e)},objectLiteral:function(e){return this.source.objectLiteral(e)},aliasable:function(e){var t=this.aliases[e];return t?(t.referenceCount++,t):((t=this.aliases[e]=this.source.wrap(e)).aliasable=!0,t.referenceCount=1,t)},setupHelper:function(e,t,n){var r=[];return{params:r,paramsInit:this.setupHelperArgs(t,e,r,n),name:this.nameLookup("helpers",t,"helper"),callParams:[this.aliasable(this.contextName(0)+" != null ? "+this.contextName(0)+" : (container.nullContext || {})")].concat(r)}},setupParams:function(e,t,n){var r={},o=[],i=[],a=[],s=!n,l=void 0;s&&(n=[]),r.name=this.quotedString(e),r.hash=this.popStack(),this.trackIds&&(r.hashIds=this.popStack()),this.stringParams&&(r.hashTypes=this.popStack(),r.hashContexts=this.popStack());var c=this.popStack(),u=this.popStack();(u||c)&&(r.fn=u||"container.noop",r.inverse=c||"container.noop");for(var p=t;p--;)l=this.popStack(),n[p]=l,this.trackIds&&(a[p]=this.popStack()),this.stringParams&&(i[p]=this.popStack(),o[p]=this.popStack());return s&&(r.args=this.source.generateArray(n)),this.trackIds&&(r.ids=this.source.generateArray(a)),this.stringParams&&(r.types=this.source.generateArray(i),r.contexts=this.source.generateArray(o)),this.options.data&&(r.data="data"),this.useBlockParams&&(r.blockParams="blockParams"),r},setupHelperArgs:function(e,t,n,r){var o=this.setupParams(e,t,n);return o.loc=JSON.stringify(this.source.currentLocation),o=this.objectLiteral(o),r?(this.useRegister("options"),n.push("options"),["options=",o]):n?(n.push(o),""):o}},function(){for(var e="break else new var case finally return void catch for switch while continue function this with default if throw delete in try do instanceof typeof abstract enum int short boolean export interface static byte extends long super char final native synchronized class float package throws const goto private transient debugger implements protected volatile double import public let yield await null true false".split(" "),t=c.RESERVED_WORDS={},n=0,r=e.length;n<r;n++)t[e[n]]=!0}(),c.isValidJavaScriptVariableName=function(e){return!c.RESERVED_WORDS[e]&&/^[a-zA-Z_$][0-9a-zA-Z_$]*$/.test(e)},t.default=c,e.exports=t.default},742:(e,t,n)=>{n.d(t,{c9:()=>S,a$:()=>w,Yd:()=>b,C$:()=>x,Zi:()=>y,Yq:()=>_,fq:()=>C});var r=n(971),o=n(149),i='=======\n\nWhen creating a **character card** in SillyTavern, you can define a structured profile to guide the AI\'s behavior and ensure consistency in roleplay or storytelling. Below are the common fields and their purposes, based on community templates and best practices:\n\n---\n\n### **1. Name**\n**Purpose**:\nThe character\'s primary identifier. The AI uses this to reference the character in dialogue and narration.\n**Key Tips**:\n- Use a memorable name that reflects their role (e.g., "Zara the Shadowblade" implies stealth/combat).\n- Avoid overly complex or ambiguous names (e.g., "Xy\'lthraa" may confuse the AI).\n**Example**:\n`"Seraphina Vale"` (Elegant, hints at nobility) vs. `"Rusty"` (Casual, rugged).\n\n---\n\n### **2. Description**\n**Purpose**:\nA snapshot of the character\'s identity, combining **appearance**, **personality**, and **key traits** to guide the AI\'s "mental image."\n**Structure**:\n- **Appearance**: Physical traits (e.g., scars, clothing, species).\n- **Personality**: Core demeanor (e.g., stoic, playful).\n- **Mannerisms**: Unique habits (e.g., "taps fingers when lying").\n**Example**:\n> *"A hulking orc with moss-green skin and a chipped tusk, wearing a patchwork cloak. Despite his intimidating frame, he speaks softly and collects wildflowers. Secretly fears fire."*\n**Tips**:\n- Use vivid, concise language.\n- Prioritize traits critical to roleplay (e.g., "blind in one eye" affects interactions).\n\n---\n\n### **3. Personality**\n**Purpose**:\nExplicitly defines **how the character thinks/behaves**, reducing ambiguity for the AI.\n**What to Include**:\n- Core traits (e.g., "optimistic", "paranoid").\n- Motivations (e.g., "seeks revenge against the crown").\n- Flaws (e.g., "impulsive", "overly trusting").\n**Example**:\n`"Charismatic but manipulative; values loyalty only when it benefits him. Haunted by guilt over a failed rescue mission."`\n**Tips**:\n- Use bullet points or short phrases for clarity.\n- Avoid contradictions (e.g., "shy" vs. "loves public speaking").\n\n---\n\n### **4. Scenario**\n**Purpose**:\nSets the stage for the interaction, providing **contextual boundaries** for the AI.\n**What to Include**:\n- **Location**: Where the scene takes place (e.g., "a smoky tavern").\n- **Time**: Era or time-sensitive context (e.g., "during a solar eclipse").\n- **Relationship**: Predefined ties to the user (e.g., "childhood rivals reunited").\n**Example**:\n`"A cyberpunk night market in 2147. {{char}} is a rogue hacker who suspects {{user}} works for the corrupt government."`\n**Tips**:\n- Use dynamic placeholders like `{{user}}` to personalize the scenario.\n\n---\n\n### **5. First Message - Alternate Greetings**\n**Purpose**:\nThe character\'s **opening line**, critical for establishing tone, voice, and narrative momentum.\n**Key Elements**:\n- **Dialogue**: Shows speech style (formal, slang-heavy).\n- **Actions**: Subtle body language (e.g., "crosses arms skeptically").\n- **Hook**: Encourages user engagement (e.g., a question or mystery).\n**Example**:\n`*{{char}} adjusts her gas mask, voice muffled.* "You\'re the third outsider this week. What makes you think you\'ll survive the Wastes?"`\n**Tips**:\n- Avoid passive openings (e.g., "Hello, how can I help you?").\n- Mirror the character\'s personality (e.g., a shy character might stammer).\n\n---\n\n### **6. Example Dialogue**\n**Purpose**:\nTeaches the AI the character\'s **speech patterns**, **formatting preferences**, and **interaction style**.\n**Structure**:\n- Use `{{char}}` and `{{user}}` placeholders.\n- Mix dialogue and actions (e.g., `*{{char}} smirks.* "You\'re bold. I like that."`).\n- Show range (e.g., anger, sarcasm, vulnerability).\n**Example**:\n```\n{{user}}: Why should I trust you?\n{{char}}: *Pulls a dagger from her boot and twirls it.* "You shouldn\'t. But I\'m your only way out of this alive."\n```\n**Tips**:\n- Include 3–5 varied exchanges.\n- Match the character\'s voice (e.g., a poet might use metaphors).\n\n---\n\n### **7. Advanced Tips**\n- **Avoid "Wall of Text"**: Use line breaks and punctuation to improve readability for the AI.\n\n=======',a="{{activeFormatInstructions}}",s="=== CURRENT CHARACTER FIELD VALUES ===\n{{#if fields.core}}\n**Core Fields:**\n{{#each fields.core as |value key|}}\n- **{{key}}:** {{#if value}}{{value}}{{else}}*Not provided*{{/if}}\n{{/each}}\n{{/if}}\n\n{{#if fields.alternate_greetings}}\n**Alternate Greetings:**\n{{#each fields.alternate_greetings as |value key|}}\n- **{{key}}:** {{#if value}}{{value}}{{else}}*Not provided*{{/if}}\n{{/each}}\n{{/if}}\n\n{{#if fields.draft}}\n**Draft Fields:**\n{{#each fields.draft as |value key|}}\n- **{{key}}:** {{#if value}}{{value}}{{else}}*Not provided*{{/if}}\n{{/each}}\n{{/if}}",l='Your task is to generate the content for the "{{targetField}}" field of a character card. Base your response on the preceding context (chat history, persona, system prompts, character/lore definitions, existing fields, etc.).\n{{#if userInstructions}}\n\nFollow these user instructions: {{userInstructions}}\n{{/if}}\n{{#if fieldSpecificInstructions}}\n\nField-specific instructions: {{fieldSpecificInstructions}}\n{{/if}}',c=n(262);function u(e){return u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},u(e)}function p(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function i(n,r,o,i){var l=r&&r.prototype instanceof s?r:s,c=Object.create(l.prototype);return d(c,"_invoke",function(n,r,o){var i,s,l,c=0,u=o||[],p=!1,d={p:0,n:0,v:e,a:h,f:h.bind(e,4),d:function(t,n){return i=t,s=0,l=e,d.n=n,a}};function h(n,r){for(s=n,l=r,t=0;!p&&c&&!o&&t<u.length;t++){var o,i=u[t],h=d.p,f=i[2];n>3?(o=f===r)&&(l=i[(s=i[4])?5:(s=3,3)],i[4]=i[5]=e):i[0]<=h&&((o=n<2&&h<i[1])?(s=0,d.v=r,d.n=i[1]):h<f&&(o=n<3||i[0]>r||r>f)&&(i[4]=n,i[5]=r,d.n=f,s=0))}if(o||n>1)return a;throw p=!0,r}return function(o,u,f){if(c>1)throw TypeError("Generator is already running");for(p&&1===u&&h(u,f),s=u,l=f;(t=s<2?e:l)||!p;){i||(s?s<3?(s>1&&(d.n=-1),h(s,l)):d.n=l:d.v=l);try{if(c=2,i){if(s||(o="next"),t=i[o]){if(!(t=t.call(i,l)))throw TypeError("iterator result is not an object");if(!t.done)return t;l=t.value,s<2&&(s=0)}else 1===s&&(t=i.return)&&t.call(i),s<2&&(l=TypeError("The iterator does not provide a '"+o+"' method"),s=1);i=e}else if((t=(p=d.n<0)?l:n.call(r,d))!==a)break}catch(t){i=e,s=1,l=t}finally{c=1}}return{value:t,done:p}}}(n,o,i),!0),c}var a={};function s(){}function l(){}function c(){}t=Object.getPrototypeOf;var u=[][r]?t(t([][r]())):(d(t={},r,function(){return this}),t),h=c.prototype=s.prototype=Object.create(u);function f(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,d(e,o,"GeneratorFunction")),e.prototype=Object.create(h),e}return l.prototype=c,d(h,"constructor",c),d(c,"constructor",l),l.displayName="GeneratorFunction",d(c,o,"GeneratorFunction"),d(h),d(h,o,"Generator"),d(h,r,function(){return this}),d(h,"toString",function(){return"[object Generator]"}),(p=function(){return{w:i,m:f}})()}function d(e,t,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}d=function(e,t,n,r){function i(t,n){d(e,t,function(e){return this._invoke(t,n,e)})}t?o?o(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(i("next",0),i("throw",1),i("return",2))},d(e,t,n,r)}function h(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function f(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?h(Object(n),!0).forEach(function(t){m(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):h(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function m(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=u(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=u(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==u(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function g(e,t,n,r,o,i,a){try{var s=e[i](a),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function v(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var i=e.apply(t,n);function a(e){g(i,r,o,a,s,"next",e)}function s(e){g(i,r,o,a,s,"throw",e)}a(void 0)})}}var y="SillyTavern-Character-Creator-Chat",b=["stDescription","charDefinitions","lorebookDefinitions","xmlFormat","jsonFormat","noneFormat","worldInfoCharDefinition","existingFieldDefinitions","taskDescription","outputFormatInstructions","personaDescription"],S={stDescription:i,charDefinitions:"## Selected Characters for Context\n{{#each characters}}\n### {{this.name}}\n{{#if this.description}}\n#### Description\n{{this.description}}\n{{/if}}\n{{#if this.personality}}\n#### Personality\n{{this.personality}}\n{{/if}}\n{{#if this.scenario}}\n#### Scenario\n{{this.scenario}}\n{{/if}}\n{{#if this.first_mes}}\n#### First Message\n{{this.first_mes}}\n{{/if}}\n{{#if this.mes_example}}\n#### Example Dialogue\n{{this.mes_example}}\n{{/if}}\n{{#if this.alternate_greetings}}\n#### Alternate Greetings\n{{#each this.alternate_greetings}}\n### {{add @index 1}}\n{{this}}\n{{/each}}\n{{/if}}\n\n{{/each}}",lorebookDefinitions:"## Selected Lorebooks for Context\n{{#each lorebooks}}\n### {{@key}}\n  {{#each this as |entry|}}\n#### {{#if entry.comment}}{{entry.comment}}{{else}}*No title*{{/if}}\nTriggers: {{#if entry.key}}{{join entry.key ', '}}{{else}}*No triggers*{{/if}}\nContent: {{#if entry.content}}{{entry.content}}{{else}}*No content*{{/if}}\n\n  {{/each}}\n\n\n{{/each}}",xmlFormat:"=== RESPONSE FORMAT INSTRUCTIONS ===\nYou MUST provide your response wrapped ONLY in a single <response> XML tag.\n\nWhen providing code in your response, wrap it in triple backticks:\n\nExample:\n```\n<response>Generated content for the field goes here.</response>\n```",jsonFormat:'=== RESPONSE FORMAT INSTRUCTIONS ===\nYou MUST provide your response as a JSON object with a single key "response" containing the generated content as a string.\n\nWhen providing code in your response, wrap it in triple backticks:\n\nExample:\n```\n{\n  "response": "Generated content for the field goes here."\n}\n```',noneFormat:"=== RESPONSE FORMAT INSTRUCTIONS ===\nYou MUST provide ONLY the raw text content for the field, without any formatting, XML tags, JSON structure, or explanatory text. Just the content itself.\n\nWhen providing code in your response, wrap it in triple backticks:\n\nExample:\n```\nGenerated content for the field goes here.\n```",worldInfoCharDefinition:"### {{character.name}}\n- **Description:** {{#if character.description}}{{character.description}}{{else}}*Not provided*{{/if}}\n- **Personality:** {{#if character.personality}}{{character.personality}}{{else}}*Not provided*{{/if}}\n- **Scenario:** {{#if character.scenario}}{{character.scenario}}{{else}}*Not provided*{{/if}}\n- **First Message:** {{#if character.first_mes}}{{character.first_mes}}{{else}}*Not provided*{{/if}}\n- **Example Dialogue:**\n  {{#if character.mes_example}}{{character.mes_example}}{{else}}*Not provided*{{/if}}\n- **Alternate Greetings:**\n  {{#if character.alternate_greetings}}\n  {{#each character.alternate_greetings}}\n  **{{add @index 1}}:** {{this}}\n  {{/each}}\n  {{else}}*Not provided*{{/if}}",existingFieldDefinitions:s,taskDescription:l,outputFormatInstructions:a,personaDescription:"## User's Persona Description\nname: {{user}}\n{{persona}}"},w={version:"0.2.2",formatVersion:"F_1.7",profileId:"",maxContextType:"profile",maxContextValue:16384,maxResponseToken:1024,outputFormat:"xml",contextToSend:{stDescription:!0,messages:{type:"last",first:10,last:10,range:{start:0,end:10}},charCard:!0,existingFields:!0,worldInfo:!0,persona:!0,dontSendOtherGreetings:!1},prompts:{stDescription:{content:S.stDescription,isDefault:!0,label:"ST/Char Card Description"},charDefinitions:{content:S.charDefinitions,isDefault:!0,label:"Character Definition Template"},lorebookDefinitions:{content:S.lorebookDefinitions,isDefault:!0,label:"Lorebook Definition Template"},xmlFormat:{content:S.xmlFormat,isDefault:!0,label:"XML Format Description"},jsonFormat:{content:S.jsonFormat,isDefault:!0,label:"JSON Format Description"},noneFormat:{content:S.noneFormat,isDefault:!0,label:"Plain Text Format Description"},worldInfoCharDefinition:{content:S.worldInfoCharDefinition,isDefault:!0,label:"World Info Character Definition Template"},existingFieldDefinitions:{content:s,isDefault:!0,label:"Existing Fields Definition Template"},taskDescription:{content:l,isDefault:!0,label:"Task Description Template"},outputFormatInstructions:{content:a,isDefault:!0,label:"Output Format Instructions"},personaDescription:{content:S.personaDescription,isDefault:!0,label:"User Persona Description Template"}},promptPreset:"default",promptPresets:{default:{content:"Generate the field content based on the chat history and existing character details. Be creative but consistent."}},mainContextTemplatePreset:"default",mainContextTemplatePresets:{default:{prompts:[{enabled:!0,promptName:"chatHistory",role:"system"},{enabled:!0,promptName:"creatorChatHistory",role:"system"},{enabled:!0,promptName:"stDescription",role:"system"},{enabled:!0,promptName:"charDefinitions",role:"system"},{enabled:!0,promptName:"lorebookDefinitions",role:"system"},{enabled:!0,promptName:"existingFieldDefinitions",role:"system"},{enabled:!0,promptName:"personaDescription",role:"system"},{enabled:!0,promptName:"outputFormatInstructions",role:"system"},{enabled:!0,promptName:"taskDescription",role:"user"}]}},showSaveAsWorldInfoEntry:{show:!1}};function x(e){var t=e.replace(/[^\w\s]/g,"").split(/\s+/).filter(Boolean),n=!1;return t.map(function(e,t){var r=e.replace(/^\d+/,"");if(r){var o=n?"".concat(r[0].toUpperCase()).concat(r.slice(1).toLowerCase()):r.toLowerCase();return n||(n=!0),o}return""}).join("")}var C=new r.gc("charCreatorChat",w);function _(){return k.apply(this,arguments)}function k(){return(k=v(p().m(function e(){return p().w(function(e){for(;;)if(0===e.n)return e.a(2,new Promise(function(e,t){C.initializeSettings({strategy:[{from:"*",to:"F_1.4",action:function(e){var t,n,r,o,i,c,u,p,d;return{profileId:null!==(t=null==e?void 0:e.profileId)&&void 0!==t?t:"",maxContextType:null!==(n=null==e?void 0:e.maxContextType)&&void 0!==n?n:"profile",maxContextValue:null!==(r=null==e?void 0:e.maxContextValue)&&void 0!==r?r:16384,maxResponseToken:null!==(o=null==e?void 0:e.maxResponseToken)&&void 0!==o?o:1024,outputFormat:null!==(i=null==e?void 0:e.outputFormat)&&void 0!==i?i:"xml",contextToSend:f(f({},null==e?void 0:e.contextToSend),{},{persona:!0}),prompts:{stDescription:{content:S.stDescription,isDefault:!0,label:"ST/Char Card Description"},charDefinitions:{content:S.charDefinitions,isDefault:!0,label:"Character Definition Template"},lorebookDefinitions:{content:S.lorebookDefinitions,isDefault:!0,label:"Lorebook Definition Template"},xmlFormat:{content:S.xmlFormat,isDefault:!0,label:"XML Format Description"},jsonFormat:{content:S.jsonFormat,isDefault:!0,label:"JSON Format Description"},noneFormat:{content:S.noneFormat,isDefault:!0,label:"Plain Text Format Description"},worldInfoCharDefinition:{content:S.worldInfoCharDefinition,isDefault:!0,label:"World Info Character Definition Template"},existingFieldDefinitions:{content:s,isDefault:!0,label:"Existing Fields Definition Template"},taskDescription:{content:l,isDefault:!0,label:"Task Description Template"},outputFormatInstructions:{content:a,isDefault:!0,label:"Output Format Instructions"},personaDescription:{content:S.personaDescription,isDefault:!0,label:"User Persona Description Template"}},promptPreset:null!==(c=null==e?void 0:e.default)&&void 0!==c?c:"default",promptPresets:null!==(u=null==e?void 0:e.promptPresets)&&void 0!==u?u:{default:{content:"Generate the field content based on the chat history and existing character details. Be creative but consistent."}},mainContextTemplatePreset:"default",mainContextTemplatePresets:{default:{prompts:[{enabled:!0,promptName:"chatHistory",role:"system"},{enabled:!0,promptName:"creatorChatHistory",role:"system"},{enabled:!0,promptName:"stDescription",role:"system"},{enabled:!0,promptName:"charDefinitions",role:"system"},{enabled:!0,promptName:"lorebookDefinitions",role:"system"},{enabled:!0,promptName:"existingFieldDefinitions",role:"system"},{enabled:!0,promptName:"personaDescription",role:"system"},{enabled:!0,promptName:"outputFormatInstructions",role:"system"},{enabled:!0,promptName:"taskDescription",role:"user"}]}},showSaveAsWorldInfoEntry:null!==(p=null==e?void 0:e.showSaveAsWorldInfoEntry)&&void 0!==p?p:{show:null!==(d=null==e?void 0:e.showSaveAsWorldInfoEntry.show)&&void 0!==d&&d}}}},{from:"F_1.4",to:"F_1.5",action:function(e){return f(f({},e),{},{prompts:f(f({},null==e?void 0:e.prompts),{},{personaDescription:{content:S.personaDescription,isDefault:!0,label:"User Persona Description Template"}}),mainContextTemplatePresets:f(f({},null==e?void 0:e.mainContextTemplatePresets),{},{default:{prompts:[{enabled:!0,promptName:"chatHistory",role:"system"},{enabled:!0,promptName:"creatorChatHistory",role:"system"},{enabled:!0,promptName:"stDescription",role:"system"},{enabled:!0,promptName:"charDefinitions",role:"system"},{enabled:!0,promptName:"lorebookDefinitions",role:"system"},{enabled:!0,promptName:"existingFieldDefinitions",role:"system"},{enabled:!0,promptName:"personaDescription",role:"system"},{enabled:!0,promptName:"outputFormatInstructions",role:"system"},{enabled:!0,promptName:"taskDescription",role:"user"}]}})})}},{from:"F_1.5",to:"F_1.6",action:function(e){return v(p().m(function t(){return p().w(function(t){for(;;)switch(t.n){case 0:return t.n=1,(0,o.YC)("info","[".concat(y,"] Added Alternate Greetings."));case 1:return t.a(2,f(f({},e),{},{prompts:f(f({},null==e?void 0:e.prompts),{},{stDescription:{content:S.stDescription,isDefault:!0,label:"ST/Char Card Description"},charDefinitions:{content:S.charDefinitions,isDefault:!0,label:"Character Definition Template"},worldInfoCharDefinition:{content:S.worldInfoCharDefinition,isDefault:!0,label:"World Info Character Definition Template"},existingFieldDefinitions:{content:s,isDefault:!0,label:"Existing Fields Definition Template"}})}))}},t)}))()}},{from:"F_1.6",to:"F_1.7",action:function(e){return v(p().m(function t(){var n;return p().w(function(t){for(;;)if(0===t.n)return n=f({},e),e.prompts.stDescription.isDefault&&(n.prompts.stDescription.content=i),t.a(2,n)},t)}))()}}]}).then(function(t){e()}).catch(function(t){console.error("[".concat(y,"] Error initializing settings:"),t),(0,o.YC)("error","[".concat(y,"] Failed to initialize settings: ").concat(t.message)),c.globalContext.Popup.show.confirm("[".concat(y,"] Failed to load settings. This might be due to an update. Reset settings to default?"),"Extension Error").then(function(t){t&&(C.resetSettings(),(0,o.YC)("success","[".concat(y,"] Settings reset. Reloading may be required.")),e())})})}))},e)}))).apply(this,arguments)}},769:(e,t)=>{t.__esModule=!0;var n=["description","fileName","lineNumber","endLineNumber","message","name","number","stack"];function r(e,t){var o=t&&t.loc,i=void 0,a=void 0,s=void 0,l=void 0;o&&(i=o.start.line,a=o.end.line,s=o.start.column,l=o.end.column,e+=" - "+i+":"+s);for(var c=Error.prototype.constructor.call(this,e),u=0;u<n.length;u++)this[n[u]]=c[n[u]];Error.captureStackTrace&&Error.captureStackTrace(this,r);try{o&&(this.lineNumber=i,this.endLineNumber=a,Object.defineProperty?(Object.defineProperty(this,"column",{value:s,enumerable:!0}),Object.defineProperty(this,"endColumn",{value:l,enumerable:!0})):(this.column=s,this.endColumn=l))}catch(e){}}r.prototype=new Error,t.default=r,e.exports=t.default},785:(e,t,n)=>{t.__esModule=!0;var r,o=n(849),i=n(769),a=(r=i)&&r.__esModule?r:{default:r};t.default=function(e){e.registerHelper("each",function(e,t){if(!t)throw new a.default("Must pass iterator to #each");var n,r=t.fn,i=t.inverse,s=0,l="",c=void 0,u=void 0;function p(t,n,i){c&&(c.key=t,c.index=n,c.first=0===n,c.last=!!i,u&&(c.contextPath=u+t)),l+=r(e[t],{data:c,blockParams:o.blockParams([e[t],t],[u+t,null])})}if(t.data&&t.ids&&(u=o.appendContextPath(t.data.contextPath,t.ids[0])+"."),o.isFunction(e)&&(e=e.call(this)),t.data&&(c=o.createFrame(t.data)),e&&"object"==typeof e)if(o.isArray(e))for(var d=e.length;s<d;s++)s in e&&p(s,s,s===e.length-1);else if("function"==typeof Symbol&&e[Symbol.iterator]){for(var h=[],f=e[Symbol.iterator](),m=f.next();!m.done;m=f.next())h.push(m.value);for(d=(e=h).length;s<d;s++)p(s,s,s===e.length-1)}else n=void 0,Object.keys(e).forEach(function(e){void 0!==n&&p(n,s-1),n=e,s++}),void 0!==n&&p(n,s-1,!0);return 0===s&&(l=i(this)),l})},e.exports=t.default},849:(e,t)=>{t.__esModule=!0,t.extend=a,t.indexOf=function(e,t){for(var n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1},t.escapeExpression=function(e){if("string"!=typeof e){if(e&&e.toHTML)return e.toHTML();if(null==e)return"";if(!e)return e+"";e=""+e}if(!o.test(e))return e;return e.replace(r,i)},t.isEmpty=function(e){return!e&&0!==e||!(!c(e)||0!==e.length)},t.createFrame=function(e){var t=a({},e);return t._parent=e,t},t.blockParams=function(e,t){return e.path=t,e},t.appendContextPath=function(e,t){return(e?e+".":"")+t};var n={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;","=":"&#x3D;"},r=/[&<>"'`=]/g,o=/[&<>"'`=]/;function i(e){return n[e]}function a(e){for(var t=1;t<arguments.length;t++)for(var n in arguments[t])Object.prototype.hasOwnProperty.call(arguments[t],n)&&(e[n]=arguments[t][n]);return e}var s=Object.prototype.toString;t.toString=s;var l=function(e){return"function"==typeof e};l(/x/)&&(t.isFunction=l=function(e){return"function"==typeof e&&"[object Function]"===s.call(e)}),t.isFunction=l;var c=Array.isArray||function(e){return!(!e||"object"!=typeof e)&&"[object Array]"===s.call(e)};t.isArray=c},865:(e,t,n)=>{t.__esModule=!0,t.createProtoAccessControl=function(e){var t=Object.create(null);t.constructor=!1,t.__defineGetter__=!1,t.__defineSetter__=!1,t.__lookupGetter__=!1;var n=Object.create(null);return n.__proto__=!1,{properties:{whitelist:o.createNewLookupObject(n,e.allowedProtoProperties),defaultValue:e.allowProtoPropertiesByDefault},methods:{whitelist:o.createNewLookupObject(t,e.allowedProtoMethods),defaultValue:e.allowProtoMethodsByDefault}}},t.resultIsAllowed=function(e,t,n){return l("function"==typeof e?t.methods:t.properties,n)},t.resetLoggedProperties=function(){Object.keys(s).forEach(function(e){delete s[e]})};var r,o=n(726),i=n(566),a=(r=i)&&r.__esModule?r:{default:r},s=Object.create(null);function l(e,t){return void 0!==e.whitelist[t]?!0===e.whitelist[t]:void 0!==e.defaultValue?e.defaultValue:(function(e){!0!==s[e]&&(s[e]=!0,a.default.log("error",'Handlebars: Access has been denied to resolve the property "'+e+'" because it is not an "own property" of its parent.\nYou can add a runtime option to disable the check or this warning:\nSee https://handlebarsjs.com/api-reference/runtime-options.html#options-to-control-prototype-access for details'))}(t),!1)}},871:(e,t,n)=>{function r(e){return e&&e.__esModule?e:{default:e}}t.__esModule=!0,t.HandlebarsEnvironment=p;var o=n(849),i=r(n(769)),a=n(277),s=n(940),l=r(n(566)),c=n(865);t.VERSION="4.7.8";t.COMPILER_REVISION=8;t.LAST_COMPATIBLE_COMPILER_REVISION=7;t.REVISION_CHANGES={1:"<= 1.0.rc.2",2:"== 1.0.0-rc.3",3:"== 1.0.0-rc.4",4:"== 1.x.x",5:"== 2.0.0-alpha.x",6:">= 2.0.0-beta.1",7:">= 4.0.0 <4.3.0",8:">= 4.3.0"};var u="[object Object]";function p(e,t,n){this.helpers=e||{},this.partials=t||{},this.decorators=n||{},a.registerDefaultHelpers(this),s.registerDefaultDecorators(this)}p.prototype={constructor:p,logger:l.default,log:l.default.log,registerHelper:function(e,t){if(o.toString.call(e)===u){if(t)throw new i.default("Arg not supported with multiple helpers");o.extend(this.helpers,e)}else this.helpers[e]=t},unregisterHelper:function(e){delete this.helpers[e]},registerPartial:function(e,t){if(o.toString.call(e)===u)o.extend(this.partials,e);else{if(void 0===t)throw new i.default('Attempting to register a partial called "'+e+'" as undefined');this.partials[e]=t}},unregisterPartial:function(e){delete this.partials[e]},registerDecorator:function(e,t){if(o.toString.call(e)===u){if(t)throw new i.default("Arg not supported with multiple decorators");o.extend(this.decorators,e)}else this.decorators[e]=t},unregisterDecorator:function(e){delete this.decorators[e]},resetLoggedPropertyAccesses:function(){c.resetLoggedProperties()}};var d=l.default.log;t.log=d,t.createFrame=o.createFrame,t.logger=l.default},882:(e,t,n)=>{n.r(t),n.d(t,{SessionService:()=>h});var r=n(262);function o(e){return o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o(e)}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach(function(t){u(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function s(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,i,a,s=[],l=!0,c=!1;try{if(i=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;l=!1}else for(;!(l=(r=i.call(n)).done)&&(s.push(r.value),s.length!==t);l=!0);}catch(e){c=!0,o=e}finally{try{if(!l&&null!=n.return&&(a=n.return(),Object(a)!==a))return}finally{if(c)throw o}}return s}}(e,t)||function(e,t){if(e){if("string"==typeof e)return l(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?l(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function l(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function c(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,p(r.key),r)}}function u(e,t,n){return(t=p(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function p(e){var t=function(e,t){if("object"!=o(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=o(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==o(t)?t:t+""}var d="charCreator",h=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),u(this,"session",null),this.loadSession()}return t=e,o=[{key:"getInstance",value:function(){return e.instance||(e.instance=new e),e.instance}}],(n=[{key:"loadSession",value:function(){try{var e=localStorage.getItem(d);e?(this.session=JSON.parse(e),this.ensureSessionIntegrity()):this.createNewSession()}catch(e){console.error("Failed to load session:",e);try{localStorage.removeItem(d)}catch(e){console.error("Failed to remove corrupted session:",e)}this.createNewSession()}}},{key:"createNewSession",value:function(){var e=this;this.session={selectedCharacterIndexes:[],selectedWorldNames:[],fields:{},draftFields:{},lastLoadedCharacterId:"",creatorChatHistory:{messages:[]},imageThumbnails:{}},r.CHARACTER_FIELDS.forEach(function(t){e.session.fields[t]={value:"",prompt:"",label:r.CHARACTER_LABELS[t]}}),this.saveSession()}},{key:"ensureSessionIntegrity",value:function(){var e=this;this.session&&(this.session.selectedCharacterIndexes||(this.session.selectedCharacterIndexes=[]),this.session.selectedWorldNames||(this.session.selectedWorldNames=[]),this.session.fields||(this.session.fields={}),this.session.draftFields||(this.session.draftFields={}),this.session.lastLoadedCharacterId||(this.session.lastLoadedCharacterId=""),this.session.creatorChatHistory||(this.session.creatorChatHistory={messages:[]}),Array.isArray(this.session.creatorChatHistory.messages)||(this.session.creatorChatHistory.messages=[]),this.session.imageThumbnails||(this.session.imageThumbnails={}),r.CHARACTER_FIELDS.forEach(function(t){e.session.fields[t]||(e.session.fields[t]={value:"",prompt:"",label:r.CHARACTER_LABELS[t]})}))}},{key:"saveSession",value:function(){var e=this;if(this.session)try{localStorage.setItem(d,JSON.stringify(this.session))}catch(o){console.error("Failed to save session, attempting to prune and retry:",o);try{var t=this.session;if(t&&t.creatorChatHistory&&Array.isArray(t.creatorChatHistory.messages)&&(t.creatorChatHistory.messages=t.creatorChatHistory.messages.map(function(t){return e.sanitizeChatMessageForStorage(t)}),t.creatorChatHistory.messages.length>20&&(t.creatorChatHistory.messages=t.creatorChatHistory.messages.slice(-20)),t.imageThumbnails)){var n=Date.now()-36e5,r={};Object.entries(t.imageThumbnails).forEach(function(e){var t=s(e,2),o=t[0],i=t[1];parseInt(o.split("_")[1])>n&&(r[o]=i)}),t.imageThumbnails=r}localStorage.setItem(d,JSON.stringify(t))}catch(e){console.error("Failed to save session after pruning:",e);try{this.session&&(this.session.creatorChatHistory.messages=[],this.session.imageThumbnails={},localStorage.setItem(d,JSON.stringify(this.session)))}catch(e){console.error("Final fallback failed, clearing all data:",e),localStorage.removeItem(d)}}}}},{key:"getSession",value:function(){return this.session||this.loadSession(),this.session}},{key:"updateSession",value:function(e){this.session||this.loadSession(),this.session=a(a({},this.session),e),this.saveSession()}},{key:"updateField",value:function(e,t){var n=this.getSession();n.fields[e]||(n.fields[e]={value:"",prompt:"",label:e}),n.fields[e]=a(a({},n.fields[e]),t),this.saveSession()}},{key:"updateDraftField",value:function(e,t){var n=this.getSession();n.draftFields[e]||(n.draftFields[e]={value:"",prompt:"",label:e}),n.draftFields[e]=a(a({},n.draftFields[e]),t),this.saveSession()}},{key:"deleteDraftField",value:function(e){delete this.getSession().draftFields[e],this.saveSession()}},{key:"addChatMessage",value:function(e){var t=this.getSession();return t.creatorChatHistory.messages.push(this.sanitizeChatMessageForStorage(e)),this.saveSession(),t.creatorChatHistory.messages.length-1}},{key:"replaceChatMessage",value:function(e,t){var n=this.getSession();e>=0&&e<n.creatorChatHistory.messages.length&&(n.creatorChatHistory.messages[e]=this.sanitizeChatMessageForStorage(t),this.saveSession())}},{key:"deleteChatMessage",value:function(e){var t=this.getSession();e>=0&&e<t.creatorChatHistory.messages.length&&(t.creatorChatHistory.messages.splice(e,1),this.saveSession())}},{key:"clearChatHistory",value:function(){this.getSession().creatorChatHistory.messages=[],this.saveSession()}},{key:"getChatMessagesForUI",value:function(){var e=this;return this.getSession().creatorChatHistory.messages.filter(function(e){return"user"===e.role||"assistant"===e.role}).map(function(t,n){var r,o="";if("string"==typeof t.content)o=t.content;else if(Array.isArray(t.content)){var i,a=t.content.filter(function(e){return"text"===e.type}).map(function(e){return e.text}).join(""),s=t.content.find(function(e){return"image_url"===e.type});if(o=a,null!=s&&null!==(i=s.image_url)&&void 0!==i&&i.thumbnailUrl){var l=s.image_url.thumbnailUrl;r=e.getImageThumbnail(l)||s.image_url.url}else{var c;r=null==s||null===(c=s.image_url)||void 0===c?void 0:c.url}}return{id:String(n),role:t.role,content:o,inlineImageUrl:r,timestamp:Date.now()}})}},{key:"convertUIMessageToChatMessage",value:function(e,t){if(e.imageUrl){var n=[];return e.content.trim()&&n.push({type:"text",text:e.content}),n.push({type:"image_url",image_url:{url:e.imageUrl,detail:"auto"}}),{role:t,content:n}}return{role:t,content:e.content}}},{key:"storeImageThumbnail",value:function(e,t){var n=this.getSession();n.imageThumbnails||(n.imageThumbnails={});var r="img_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9));return n.imageThumbnails[r]=t,r}},{key:"getImageThumbnail",value:function(e){var t;return null===(t=this.getSession().imageThumbnails)||void 0===t?void 0:t[e]}},{key:"sanitizeChatMessageForStorage",value:function(e){var t=e.role,n=e.content;return"string"==typeof n?{role:t,content:n}:Array.isArray(n)?{role:t,content:n.map(function(e){var t;return"image_url"===e.type&&null!==(t=e.image_url)&&void 0!==t&&t.url?{type:"image_url",image_url:{url:"",detail:e.image_url.detail||"auto",thumbnailUrl:e.image_url.thumbnailUrl,originalSize:e.image_url.originalSize}}:e})}:{role:t,content:""}}},{key:"getMessageForAIContext",value:function(e){var t=this,n=e.role,r=e.content;return"string"==typeof r?{role:n,content:r}:Array.isArray(r)?{role:n,content:r.map(function(e){var n;return"image_url"===e.type&&null!==(n=e.image_url)&&void 0!==n&&n.thumbnailUrl&&!e.image_url.url?{type:"image_url",image_url:{url:t.getImageThumbnail(e.image_url.thumbnailUrl)||"",detail:e.image_url.detail||"auto"}}:e})}:{role:n,content:""}}},{key:"resetSession",value:function(){localStorage.removeItem(d),this.createNewSession()}}])&&c(t.prototype,n),o&&c(t,o),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,n,o}()},908:(e,t,n)=>{t.__esModule=!0;var r,o=n(849),i=n(769),a=(r=i)&&r.__esModule?r:{default:r};t.default=function(e){e.registerHelper("with",function(e,t){if(2!=arguments.length)throw new a.default("#with requires exactly one argument");o.isFunction(e)&&(e=e.call(this));var n=t.fn;if(o.isEmpty(e))return t.inverse(this);var r=t.data;return t.data&&t.ids&&((r=o.createFrame(t.data)).contextPath=o.appendContextPath(t.data.contextPath,t.ids[0])),n(e,{data:r,blockParams:o.blockParams([e],[r&&r.contextPath])})})},e.exports=t.default},915:(e,t,n)=>{t.__esModule=!0;var r,o=n(350),i=(r=o)&&r.__esModule?r:{default:r};function a(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];this.options=e}function s(e,t,n){void 0===t&&(t=e.length);var r=e[t-1],o=e[t-2];return r?"ContentStatement"===r.type?(o||!n?/\r?\n\s*?$/:/(^|\r?\n)\s*?$/).test(r.original):void 0:n}function l(e,t,n){void 0===t&&(t=-1);var r=e[t+1],o=e[t+2];return r?"ContentStatement"===r.type?(o||!n?/^\s*?\r?\n/:/^\s*?(\r?\n|$)/).test(r.original):void 0:n}function c(e,t,n){var r=e[null==t?0:t+1];if(r&&"ContentStatement"===r.type&&(n||!r.rightStripped)){var o=r.value;r.value=r.value.replace(n?/^\s+/:/^[ \t]*\r?\n?/,""),r.rightStripped=r.value!==o}}function u(e,t,n){var r=e[null==t?e.length-1:t-1];if(r&&"ContentStatement"===r.type&&(n||!r.leftStripped)){var o=r.value;return r.value=r.value.replace(n?/\s+$/:/[ \t]+$/,""),r.leftStripped=r.value!==o,r.leftStripped}}a.prototype=new i.default,a.prototype.Program=function(e){var t=!this.options.ignoreStandalone,n=!this.isRootSeen;this.isRootSeen=!0;for(var r=e.body,o=0,i=r.length;o<i;o++){var a=r[o],p=this.accept(a);if(p){var d=s(r,o,n),h=l(r,o,n),f=p.openStandalone&&d,m=p.closeStandalone&&h,g=p.inlineStandalone&&d&&h;p.close&&c(r,o,!0),p.open&&u(r,o,!0),t&&g&&(c(r,o),u(r,o)&&"PartialStatement"===a.type&&(a.indent=/([ \t]+$)/.exec(r[o-1].original)[1])),t&&f&&(c((a.program||a.inverse).body),u(r,o)),t&&m&&(c(r,o),u((a.inverse||a.program).body))}}return e},a.prototype.BlockStatement=a.prototype.DecoratorBlock=a.prototype.PartialBlockStatement=function(e){this.accept(e.program),this.accept(e.inverse);var t=e.program||e.inverse,n=e.program&&e.inverse,r=n,o=n;if(n&&n.chained)for(r=n.body[0].program;o.chained;)o=o.body[o.body.length-1].program;var i={open:e.openStrip.open,close:e.closeStrip.close,openStandalone:l(t.body),closeStandalone:s((r||t).body)};if(e.openStrip.close&&c(t.body,null,!0),n){var a=e.inverseStrip;a.open&&u(t.body,null,!0),a.close&&c(r.body,null,!0),e.closeStrip.open&&u(o.body,null,!0),!this.options.ignoreStandalone&&s(t.body)&&l(r.body)&&(u(t.body),c(r.body))}else e.closeStrip.open&&u(t.body,null,!0);return i},a.prototype.Decorator=a.prototype.MustacheStatement=function(e){return e.strip},a.prototype.PartialStatement=a.prototype.CommentStatement=function(e){var t=e.strip||{};return{inlineStandalone:!0,open:t.open,close:t.close}},t.default=a,e.exports=t.default},919:(e,t)=>{t.__esModule=!0;var n={helpers:{helperExpression:function(e){return"SubExpression"===e.type||("MustacheStatement"===e.type||"BlockStatement"===e.type)&&!!(e.params&&e.params.length||e.hash)},scopedId:function(e){return/^\.|this\b/.test(e.original)},simpleId:function(e){return 1===e.parts.length&&!n.helpers.scopedId(e)&&!e.depth}}};t.default=n,e.exports=t.default},940:(e,t,n)=>{t.__esModule=!0,t.registerDefaultDecorators=function(e){i.default(e)};var r,o=n(430),i=(r=o)&&r.__esModule?r:{default:r}},971:(e,t,n)=>{n.d(t,{gc:()=>a,rM:()=>pn,dK:()=>Z,Kq:()=>ee,fn:()=>re,h5:()=>un,OW:()=>o,tt:()=>i});class r extends Error{data;constructor(e,t){super(e),this.data=t}toString(){return this.message}}async function o(e,t){const n=SillyTavern.getContext(),o=new FormData;o.append("avatar",new Blob([JSON.stringify(e)],{type:"application/json"}),"character.json"),o.append("file_type","json");const i=n.getRequestHeaders();delete i["Content-Type"];const a=await fetch("/api/characters/import",{method:"POST",headers:i,body:o,cache:"no-cache"});if(!a.ok)throw new r(a.statusText,a);t&&await n.getCharacters()}async function i(e,t){const n=SillyTavern.getContext(),o=new FormData;o.append("ch_name",e.name),o.append("avatar_url",e.avatar??""),o.append("description",e.description??""),o.append("first_mes",e.first_mes??""),o.append("scenario",e.scenario??""),o.append("personality",e.personality??""),o.append("mes_example",e.mes_example??""),o.append("creatorcomment",e.creatorcomment??""),o.append("tags",(e.tags??[]).join(","));const i=n.getThumbnailUrl("avatar",e.avatar),a=await fetch(i).then(e=>e.blob()),s=new File([a],"avatar.png",{type:"image/png"});o.append("avatar",s);const l=e.data||{};o.append("creator",l.creator??""),o.append("character_version",l.character_version??""),o.append("creator_notes",l.creator_notes??""),o.append("system_prompt",l.system_prompt??""),o.append("post_history_instructions",l.post_history_instructions??"");const c=l.extensions||{};o.append("chat",e.chat??""),o.append("create_date",e.create_date??""),o.append("last_mes",e.last_mes??""),o.append("talkativeness",c.talkativeness??""),o.append("fav",String(c.fav??!1)),o.append("world",c.world??"");const u=c.depth_prompt||{};if(o.append("depth_prompt_prompt",u.prompt??""),o.append("depth_prompt_depth",String(u.depth??0)),o.append("depth_prompt_role",u.role??""),Array.isArray(l.alternate_greetings))for(const e of l.alternate_greetings)o.append("alternate_greetings",e);o.append("json_data",JSON.stringify(e));const p=n.getRequestHeaders();delete p["Content-Type"];const d=await fetch("/api/characters/edit",{method:"POST",headers:p,body:o,cache:"no-cache"});if(!d.ok)throw new r(d.statusText,d);t&&await n.getCharacters()}class a{settingsKey;defaultSettings;constructor(e,t){this.settingsKey=e,this.defaultSettings=t}async initializeSettings(e={}){const{strategy:t="recursive"}=e,n=this.defaultSettings.version,r=this.defaultSettings.formatVersion,o=SillyTavern.getContext().extensionSettings[this.settingsKey],i={version:{changed:!1,new:n??""},formatVersion:{changed:!1,new:r??""},oldSettings:null,newSettings:this.defaultSettings};if(!o)return SillyTavern.getContext().extensionSettings[this.settingsKey]=this.defaultSettings,this.saveSettings(),i;const a={...i,oldSettings:structuredClone(o),version:{changed:!1,old:o.version,new:o.version},formatVersion:{changed:!1,old:o.formatVersion,new:o.formatVersion}};if("recursive"===t){function s(e,t){let n=!1;for(const r of Object.keys(t))void 0===e[r]?(e[r]=t[r],n=!0):"object"==typeof t[r]&&null!==t[r]&&(e[r]=e[r]||{},s(e[r],t[r])&&(n=!0));return n}n&&o.version!==n&&(a.version.changed=!0,a.version.new=n,o.version=n),r&&"*"!==r&&o.formatVersion!==r&&(a.formatVersion.changed=!0,a.formatVersion.new=r,o.formatVersion=r),(s(o,this.defaultSettings)||a.version.changed||a.formatVersion.changed)&&this.saveSettings()}else if(Array.isArray(t)){n&&!o.version&&(o.version=n,a.version.changed=!0,a.version.new=n),r&&!o.formatVersion&&(o.formatVersion=r,a.formatVersion.changed=!0,a.formatVersion.new=r);let l=structuredClone(o),c=o.formatVersion;try{let u;do{u=!1;let p=t.find(e=>e.from===c);if(p&&p.to>c)l=await p.action(l),c=p.to,l.formatVersion=p.to,u=!0;else for(const d of t)if("*"===d.from&&d.to>c&&c!==d.to){l=await d.action(l),c=d.to,l.formatVersion=d.to,u=!0;break}}while(u);if(c!==o.formatVersion){a.formatVersion.changed=!0,a.formatVersion.new=c;const h=this.defaultSettings.version;h&&(l.version=h)}if(a.formatVersion.changed){for(const f of Object.keys(o))delete o[f];Object.assign(o,l),this.saveSettings()}}catch(m){throw console.error("Failed to apply version changes:",m),new Error(`Version migration failed: ${m instanceof Error?m.message:m}`,{cause:m})}}return a.newSettings=o,a}getSettings(){return SillyTavern.getContext().extensionSettings[this.settingsKey]}updateSetting(e,t){SillyTavern.getContext().extensionSettings[this.settingsKey][e]=t,this.saveSettings()}saveSettings(){SillyTavern.getContext().saveSettingsDebounced()}resetSettings(){SillyTavern.getContext().extensionSettings[this.settingsKey]=this.defaultSettings,this.saveSettings()}}function s(e){return Array.isArray?Array.isArray(e):"[object Array]"===f(e)}function l(e){return"string"==typeof e}function c(e){return"number"==typeof e}function u(e){return!0===e||!1===e||function(e){return p(e)&&null!==e}(e)&&"[object Boolean]"==f(e)}function p(e){return"object"==typeof e}function d(e){return null!=e}function h(e){return!e.trim().length}function f(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":Object.prototype.toString.call(e)}const m=Object.prototype.hasOwnProperty;class g{constructor(e){this._keys=[],this._keyMap={};let t=0;e.forEach(e=>{let n=v(e);this._keys.push(n),this._keyMap[n.id]=n,t+=n.weight}),this._keys.forEach(e=>{e.weight/=t})}get(e){return this._keyMap[e]}keys(){return this._keys}toJSON(){return JSON.stringify(this._keys)}}function v(e){let t=null,n=null,r=null,o=1,i=null;if(l(e)||s(e))r=e,t=y(e),n=b(e);else{if(!m.call(e,"name"))throw new Error((e=>`Missing ${e} property in key`)("name"));const a=e.name;if(r=a,m.call(e,"weight")&&(o=e.weight,o<=0))throw new Error((e=>`Property 'weight' in key '${e}' must be a positive integer`)(a));t=y(a),n=b(a),i=e.getFn}return{path:t,id:n,weight:o,src:r,getFn:i}}function y(e){return s(e)?e:e.split(".")}function b(e){return s(e)?e.join("."):e}const S={useExtendedSearch:!1,getFn:function(e,t){let n=[],r=!1;const o=(e,t,i)=>{if(d(e))if(t[i]){const a=e[t[i]];if(!d(a))return;if(i===t.length-1&&(l(a)||c(a)||u(a)))n.push(function(e){return null==e?"":function(e){if("string"==typeof e)return e;let t=e+"";return"0"==t&&1/e==-1/0?"-0":t}(e)}(a));else if(s(a)){r=!0;for(let e=0,n=a.length;e<n;e+=1)o(a[e],t,i+1)}else t.length&&o(a,t,i+1)}else n.push(e)};return o(e,l(t)?t.split("."):t,0),r?n:n[0]},ignoreLocation:!1,ignoreFieldNorm:!1,fieldNormWeight:1};var w={isCaseSensitive:!1,ignoreDiacritics:!1,includeScore:!1,keys:[],shouldSort:!0,sortFn:(e,t)=>e.score===t.score?e.idx<t.idx?-1:1:e.score<t.score?-1:1,includeMatches:!1,findAllMatches:!1,minMatchCharLength:1,location:0,threshold:.6,distance:100,...S};const x=/[^ ]+/g;class C{constructor({getFn:e=w.getFn,fieldNormWeight:t=w.fieldNormWeight}={}){this.norm=function(e=1,t=3){const n=new Map,r=Math.pow(10,t);return{get(t){const o=t.match(x).length;if(n.has(o))return n.get(o);const i=1/Math.pow(o,.5*e),a=parseFloat(Math.round(i*r)/r);return n.set(o,a),a},clear(){n.clear()}}}(t,3),this.getFn=e,this.isCreated=!1,this.setIndexRecords()}setSources(e=[]){this.docs=e}setIndexRecords(e=[]){this.records=e}setKeys(e=[]){this.keys=e,this._keysMap={},e.forEach((e,t)=>{this._keysMap[e.id]=t})}create(){!this.isCreated&&this.docs.length&&(this.isCreated=!0,l(this.docs[0])?this.docs.forEach((e,t)=>{this._addString(e,t)}):this.docs.forEach((e,t)=>{this._addObject(e,t)}),this.norm.clear())}add(e){const t=this.size();l(e)?this._addString(e,t):this._addObject(e,t)}removeAt(e){this.records.splice(e,1);for(let t=e,n=this.size();t<n;t+=1)this.records[t].i-=1}getValueForItemAtKeyId(e,t){return e[this._keysMap[t]]}size(){return this.records.length}_addString(e,t){if(!d(e)||h(e))return;let n={v:e,i:t,n:this.norm.get(e)};this.records.push(n)}_addObject(e,t){let n={i:t,$:{}};this.keys.forEach((t,r)=>{let o=t.getFn?t.getFn(e):this.getFn(e,t.path);if(d(o))if(s(o)){let e=[];const t=[{nestedArrIndex:-1,value:o}];for(;t.length;){const{nestedArrIndex:n,value:r}=t.pop();if(d(r))if(l(r)&&!h(r)){let t={v:r,i:n,n:this.norm.get(r)};e.push(t)}else s(r)&&r.forEach((e,n)=>{t.push({nestedArrIndex:n,value:e})})}n.$[r]=e}else if(l(o)&&!h(o)){let e={v:o,n:this.norm.get(o)};n.$[r]=e}}),this.records.push(n)}toJSON(){return{keys:this.keys,records:this.records}}}function _(e,t,{getFn:n=w.getFn,fieldNormWeight:r=w.fieldNormWeight}={}){const o=new C({getFn:n,fieldNormWeight:r});return o.setKeys(e.map(v)),o.setSources(t),o.create(),o}function k(e,{errors:t=0,currentLocation:n=0,expectedLocation:r=0,distance:o=w.distance,ignoreLocation:i=w.ignoreLocation}={}){const a=t/e.length;if(i)return a;const s=Math.abs(r-n);return o?a+s/o:s?1:a}const E=32;function P(e,t,n,{location:r=w.location,distance:o=w.distance,threshold:i=w.threshold,findAllMatches:a=w.findAllMatches,minMatchCharLength:s=w.minMatchCharLength,includeMatches:l=w.includeMatches,ignoreLocation:c=w.ignoreLocation}={}){if(t.length>E)throw new Error(`Pattern length exceeds max of ${E}.`);const u=t.length,p=e.length,d=Math.max(0,Math.min(r,p));let h=i,f=d;const m=s>1||l,g=m?Array(p):[];let v;for(;(v=e.indexOf(t,f))>-1;){let e=k(t,{currentLocation:v,expectedLocation:d,distance:o,ignoreLocation:c});if(h=Math.min(e,h),f=v+u,m){let e=0;for(;e<u;)g[v+e]=1,e+=1}}f=-1;let y=[],b=1,S=u+p;const x=1<<u-1;for(let r=0;r<u;r+=1){let i=0,s=S;for(;i<s;){k(t,{errors:r,currentLocation:d+s,expectedLocation:d,distance:o,ignoreLocation:c})<=h?i=s:S=s,s=Math.floor((S-i)/2+i)}S=s;let l=Math.max(1,d-s+1),v=a?p:Math.min(d+s,p)+u,w=Array(v+2);w[v+1]=(1<<r)-1;for(let i=v;i>=l;i-=1){let a=i-1,s=n[e.charAt(a)];if(m&&(g[a]=+!!s),w[i]=(w[i+1]<<1|1)&s,r&&(w[i]|=(y[i+1]|y[i])<<1|1|y[i+1]),w[i]&x&&(b=k(t,{errors:r,currentLocation:a,expectedLocation:d,distance:o,ignoreLocation:c}),b<=h)){if(h=b,f=a,f<=d)break;l=Math.max(1,2*d-f)}}if(k(t,{errors:r+1,currentLocation:d,expectedLocation:d,distance:o,ignoreLocation:c})>h)break;y=w}const C={isMatch:f>=0,score:Math.max(.001,b)};if(m){const e=function(e=[],t=w.minMatchCharLength){let n=[],r=-1,o=-1,i=0;for(let a=e.length;i<a;i+=1){let a=e[i];a&&-1===r?r=i:a||-1===r||(o=i-1,o-r+1>=t&&n.push([r,o]),r=-1)}return e[i-1]&&i-r>=t&&n.push([r,i-1]),n}(g,s);e.length?l&&(C.indices=e):C.isMatch=!1}return C}function O(e){let t={};for(let n=0,r=e.length;n<r;n+=1){const o=e.charAt(n);t[o]=(t[o]||0)|1<<r-n-1}return t}const I=String.prototype.normalize?e=>e.normalize("NFD").replace(/[\u0300-\u036F\u0483-\u0489\u0591-\u05BD\u05BF\u05C1\u05C2\u05C4\u05C5\u05C7\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06DC\u06DF-\u06E4\u06E7\u06E8\u06EA-\u06ED\u0711\u0730-\u074A\u07A6-\u07B0\u07EB-\u07F3\u07FD\u0816-\u0819\u081B-\u0823\u0825-\u0827\u0829-\u082D\u0859-\u085B\u08D3-\u08E1\u08E3-\u0903\u093A-\u093C\u093E-\u094F\u0951-\u0957\u0962\u0963\u0981-\u0983\u09BC\u09BE-\u09C4\u09C7\u09C8\u09CB-\u09CD\u09D7\u09E2\u09E3\u09FE\u0A01-\u0A03\u0A3C\u0A3E-\u0A42\u0A47\u0A48\u0A4B-\u0A4D\u0A51\u0A70\u0A71\u0A75\u0A81-\u0A83\u0ABC\u0ABE-\u0AC5\u0AC7-\u0AC9\u0ACB-\u0ACD\u0AE2\u0AE3\u0AFA-\u0AFF\u0B01-\u0B03\u0B3C\u0B3E-\u0B44\u0B47\u0B48\u0B4B-\u0B4D\u0B56\u0B57\u0B62\u0B63\u0B82\u0BBE-\u0BC2\u0BC6-\u0BC8\u0BCA-\u0BCD\u0BD7\u0C00-\u0C04\u0C3E-\u0C44\u0C46-\u0C48\u0C4A-\u0C4D\u0C55\u0C56\u0C62\u0C63\u0C81-\u0C83\u0CBC\u0CBE-\u0CC4\u0CC6-\u0CC8\u0CCA-\u0CCD\u0CD5\u0CD6\u0CE2\u0CE3\u0D00-\u0D03\u0D3B\u0D3C\u0D3E-\u0D44\u0D46-\u0D48\u0D4A-\u0D4D\u0D57\u0D62\u0D63\u0D82\u0D83\u0DCA\u0DCF-\u0DD4\u0DD6\u0DD8-\u0DDF\u0DF2\u0DF3\u0E31\u0E34-\u0E3A\u0E47-\u0E4E\u0EB1\u0EB4-\u0EB9\u0EBB\u0EBC\u0EC8-\u0ECD\u0F18\u0F19\u0F35\u0F37\u0F39\u0F3E\u0F3F\u0F71-\u0F84\u0F86\u0F87\u0F8D-\u0F97\u0F99-\u0FBC\u0FC6\u102B-\u103E\u1056-\u1059\u105E-\u1060\u1062-\u1064\u1067-\u106D\u1071-\u1074\u1082-\u108D\u108F\u109A-\u109D\u135D-\u135F\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17B4-\u17D3\u17DD\u180B-\u180D\u1885\u1886\u18A9\u1920-\u192B\u1930-\u193B\u1A17-\u1A1B\u1A55-\u1A5E\u1A60-\u1A7C\u1A7F\u1AB0-\u1ABE\u1B00-\u1B04\u1B34-\u1B44\u1B6B-\u1B73\u1B80-\u1B82\u1BA1-\u1BAD\u1BE6-\u1BF3\u1C24-\u1C37\u1CD0-\u1CD2\u1CD4-\u1CE8\u1CED\u1CF2-\u1CF4\u1CF7-\u1CF9\u1DC0-\u1DF9\u1DFB-\u1DFF\u20D0-\u20F0\u2CEF-\u2CF1\u2D7F\u2DE0-\u2DFF\u302A-\u302F\u3099\u309A\uA66F-\uA672\uA674-\uA67D\uA69E\uA69F\uA6F0\uA6F1\uA802\uA806\uA80B\uA823-\uA827\uA880\uA881\uA8B4-\uA8C5\uA8E0-\uA8F1\uA8FF\uA926-\uA92D\uA947-\uA953\uA980-\uA983\uA9B3-\uA9C0\uA9E5\uAA29-\uAA36\uAA43\uAA4C\uAA4D\uAA7B-\uAA7D\uAAB0\uAAB2-\uAAB4\uAAB7\uAAB8\uAABE\uAABF\uAAC1\uAAEB-\uAAEF\uAAF5\uAAF6\uABE3-\uABEA\uABEC\uABED\uFB1E\uFE00-\uFE0F\uFE20-\uFE2F]/g,""):e=>e;class T{constructor(e,{location:t=w.location,threshold:n=w.threshold,distance:r=w.distance,includeMatches:o=w.includeMatches,findAllMatches:i=w.findAllMatches,minMatchCharLength:a=w.minMatchCharLength,isCaseSensitive:s=w.isCaseSensitive,ignoreDiacritics:l=w.ignoreDiacritics,ignoreLocation:c=w.ignoreLocation}={}){if(this.options={location:t,threshold:n,distance:r,includeMatches:o,findAllMatches:i,minMatchCharLength:a,isCaseSensitive:s,ignoreDiacritics:l,ignoreLocation:c},e=s?e:e.toLowerCase(),e=l?I(e):e,this.pattern=e,this.chunks=[],!this.pattern.length)return;const u=(e,t)=>{this.chunks.push({pattern:e,alphabet:O(e),startIndex:t})},p=this.pattern.length;if(p>E){let e=0;const t=p%E,n=p-t;for(;e<n;)u(this.pattern.substr(e,E),e),e+=E;if(t){const e=p-E;u(this.pattern.substr(e),e)}}else u(this.pattern,0)}searchIn(e){const{isCaseSensitive:t,ignoreDiacritics:n,includeMatches:r}=this.options;if(e=t?e:e.toLowerCase(),e=n?I(e):e,this.pattern===e){let t={isMatch:!0,score:0};return r&&(t.indices=[[0,e.length-1]]),t}const{location:o,distance:i,threshold:a,findAllMatches:s,minMatchCharLength:l,ignoreLocation:c}=this.options;let u=[],p=0,d=!1;this.chunks.forEach(({pattern:t,alphabet:n,startIndex:h})=>{const{isMatch:f,score:m,indices:g}=P(e,t,n,{location:o+h,distance:i,threshold:a,findAllMatches:s,minMatchCharLength:l,includeMatches:r,ignoreLocation:c});f&&(d=!0),p+=m,f&&g&&(u=[...u,...g])});let h={isMatch:d,score:d?p/this.chunks.length:1};return d&&r&&(h.indices=u),h}}class A{constructor(e){this.pattern=e}static isMultiMatch(e){return D(e,this.multiRegex)}static isSingleMatch(e){return D(e,this.singleRegex)}search(){}}function D(e,t){const n=e.match(t);return n?n[1]:null}class N extends A{constructor(e,{location:t=w.location,threshold:n=w.threshold,distance:r=w.distance,includeMatches:o=w.includeMatches,findAllMatches:i=w.findAllMatches,minMatchCharLength:a=w.minMatchCharLength,isCaseSensitive:s=w.isCaseSensitive,ignoreDiacritics:l=w.ignoreDiacritics,ignoreLocation:c=w.ignoreLocation}={}){super(e),this._bitapSearch=new T(e,{location:t,threshold:n,distance:r,includeMatches:o,findAllMatches:i,minMatchCharLength:a,isCaseSensitive:s,ignoreDiacritics:l,ignoreLocation:c})}static get type(){return"fuzzy"}static get multiRegex(){return/^"(.*)"$/}static get singleRegex(){return/^(.*)$/}search(e){return this._bitapSearch.searchIn(e)}}class F extends A{constructor(e){super(e)}static get type(){return"include"}static get multiRegex(){return/^'"(.*)"$/}static get singleRegex(){return/^'(.*)$/}search(e){let t,n=0;const r=[],o=this.pattern.length;for(;(t=e.indexOf(this.pattern,n))>-1;)n=t+o,r.push([t,n-1]);const i=!!r.length;return{isMatch:i,score:i?0:1,indices:r}}}const M=[class extends A{constructor(e){super(e)}static get type(){return"exact"}static get multiRegex(){return/^="(.*)"$/}static get singleRegex(){return/^=(.*)$/}search(e){const t=e===this.pattern;return{isMatch:t,score:t?0:1,indices:[0,this.pattern.length-1]}}},F,class extends A{constructor(e){super(e)}static get type(){return"prefix-exact"}static get multiRegex(){return/^\^"(.*)"$/}static get singleRegex(){return/^\^(.*)$/}search(e){const t=e.startsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,this.pattern.length-1]}}},class extends A{constructor(e){super(e)}static get type(){return"inverse-prefix-exact"}static get multiRegex(){return/^!\^"(.*)"$/}static get singleRegex(){return/^!\^(.*)$/}search(e){const t=!e.startsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,e.length-1]}}},class extends A{constructor(e){super(e)}static get type(){return"inverse-suffix-exact"}static get multiRegex(){return/^!"(.*)"\$$/}static get singleRegex(){return/^!(.*)\$$/}search(e){const t=!e.endsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,e.length-1]}}},class extends A{constructor(e){super(e)}static get type(){return"suffix-exact"}static get multiRegex(){return/^"(.*)"\$$/}static get singleRegex(){return/^(.*)\$$/}search(e){const t=e.endsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[e.length-this.pattern.length,e.length-1]}}},class extends A{constructor(e){super(e)}static get type(){return"inverse-exact"}static get multiRegex(){return/^!"(.*)"$/}static get singleRegex(){return/^!(.*)$/}search(e){const t=-1===e.indexOf(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,e.length-1]}}},N],L=M.length,j=/ +(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/;const B=new Set([N.type,F.type]);class R{constructor(e,{isCaseSensitive:t=w.isCaseSensitive,ignoreDiacritics:n=w.ignoreDiacritics,includeMatches:r=w.includeMatches,minMatchCharLength:o=w.minMatchCharLength,ignoreLocation:i=w.ignoreLocation,findAllMatches:a=w.findAllMatches,location:s=w.location,threshold:l=w.threshold,distance:c=w.distance}={}){this.query=null,this.options={isCaseSensitive:t,ignoreDiacritics:n,includeMatches:r,minMatchCharLength:o,findAllMatches:a,ignoreLocation:i,location:s,threshold:l,distance:c},e=t?e:e.toLowerCase(),e=n?I(e):e,this.pattern=e,this.query=function(e,t={}){return e.split("|").map(e=>{let n=e.trim().split(j).filter(e=>e&&!!e.trim()),r=[];for(let e=0,o=n.length;e<o;e+=1){const o=n[e];let i=!1,a=-1;for(;!i&&++a<L;){const e=M[a];let n=e.isMultiMatch(o);n&&(r.push(new e(n,t)),i=!0)}if(!i)for(a=-1;++a<L;){const e=M[a];let n=e.isSingleMatch(o);if(n){r.push(new e(n,t));break}}}return r})}(this.pattern,this.options)}static condition(e,t){return t.useExtendedSearch}searchIn(e){const t=this.query;if(!t)return{isMatch:!1,score:1};const{includeMatches:n,isCaseSensitive:r,ignoreDiacritics:o}=this.options;e=r?e:e.toLowerCase(),e=o?I(e):e;let i=0,a=[],s=0;for(let r=0,o=t.length;r<o;r+=1){const o=t[r];a.length=0,i=0;for(let t=0,r=o.length;t<r;t+=1){const r=o[t],{isMatch:l,indices:c,score:u}=r.search(e);if(!l){s=0,i=0,a.length=0;break}if(i+=1,s+=u,n){const e=r.constructor.type;B.has(e)?a=[...a,...c]:a.push(c)}}if(i){let e={isMatch:!0,score:s/i};return n&&(e.indices=a),e}}return{isMatch:!1,score:1}}}const $=[];function H(e,t){for(let n=0,r=$.length;n<r;n+=1){let r=$[n];if(r.condition(e,t))return new r(e,t)}return new T(e,t)}const q="$and",U="$or",Y="$path",V="$val",W=e=>!(!e[q]&&!e[U]),G=e=>({[q]:Object.keys(e).map(t=>({[t]:e[t]}))});function X(e,t,{auto:n=!0}={}){const r=e=>{let o=Object.keys(e);const i=(e=>!!e[Y])(e);if(!i&&o.length>1&&!W(e))return r(G(e));if((e=>!s(e)&&p(e)&&!W(e))(e)){const r=i?e[Y]:o[0],a=i?e[V]:e[r];if(!l(a))throw new Error((e=>`Invalid value for key ${e}`)(r));const s={keyId:b(r),pattern:a};return n&&(s.searcher=H(a,t)),s}let a={children:[],operator:o[0]};return o.forEach(t=>{const n=e[t];s(n)&&n.forEach(e=>{a.children.push(r(e))})}),a};return W(e)||(e=G(e)),r(e)}function K(e,t){const n=e.matches;t.matches=[],d(n)&&n.forEach(e=>{if(!d(e.indices)||!e.indices.length)return;const{indices:n,value:r}=e;let o={indices:n,value:r};e.key&&(o.key=e.key.src),e.idx>-1&&(o.refIndex=e.idx),t.matches.push(o)})}function z(e,t){t.score=e.score}class J{constructor(e,t={},n){this.options={...w,...t},this.options.useExtendedSearch,this._keyStore=new g(this.options.keys),this.setCollection(e,n)}setCollection(e,t){if(this._docs=e,t&&!(t instanceof C))throw new Error("Incorrect 'index' type");this._myIndex=t||_(this.options.keys,this._docs,{getFn:this.options.getFn,fieldNormWeight:this.options.fieldNormWeight})}add(e){d(e)&&(this._docs.push(e),this._myIndex.add(e))}remove(e=()=>!1){const t=[];for(let n=0,r=this._docs.length;n<r;n+=1){const o=this._docs[n];e(o,n)&&(this.removeAt(n),n-=1,r-=1,t.push(o))}return t}removeAt(e){this._docs.splice(e,1),this._myIndex.removeAt(e)}getIndex(){return this._myIndex}search(e,{limit:t=-1}={}){const{includeMatches:n,includeScore:r,shouldSort:o,sortFn:i,ignoreFieldNorm:a}=this.options;let s=l(e)?l(this._docs[0])?this._searchStringList(e):this._searchObjectList(e):this._searchLogical(e);return function(e,{ignoreFieldNorm:t=w.ignoreFieldNorm}){e.forEach(e=>{let n=1;e.matches.forEach(({key:e,norm:r,score:o})=>{const i=e?e.weight:null;n*=Math.pow(0===o&&i?Number.EPSILON:o,(i||1)*(t?1:r))}),e.score=n})}(s,{ignoreFieldNorm:a}),o&&s.sort(i),c(t)&&t>-1&&(s=s.slice(0,t)),function(e,t,{includeMatches:n=w.includeMatches,includeScore:r=w.includeScore}={}){const o=[];return n&&o.push(K),r&&o.push(z),e.map(e=>{const{idx:n}=e,r={item:t[n],refIndex:n};return o.length&&o.forEach(t=>{t(e,r)}),r})}(s,this._docs,{includeMatches:n,includeScore:r})}_searchStringList(e){const t=H(e,this.options),{records:n}=this._myIndex,r=[];return n.forEach(({v:e,i:n,n:o})=>{if(!d(e))return;const{isMatch:i,score:a,indices:s}=t.searchIn(e);i&&r.push({item:e,idx:n,matches:[{score:a,value:e,norm:o,indices:s}]})}),r}_searchLogical(e){const t=X(e,this.options),n=(e,t,r)=>{if(!e.children){const{keyId:n,searcher:o}=e,i=this._findMatches({key:this._keyStore.get(n),value:this._myIndex.getValueForItemAtKeyId(t,n),searcher:o});return i&&i.length?[{idx:r,item:t,matches:i}]:[]}const o=[];for(let i=0,a=e.children.length;i<a;i+=1){const a=e.children[i],s=n(a,t,r);if(s.length)o.push(...s);else if(e.operator===q)return[]}return o},r=this._myIndex.records,o={},i=[];return r.forEach(({$:e,i:r})=>{if(d(e)){let a=n(t,e,r);a.length&&(o[r]||(o[r]={idx:r,item:e,matches:[]},i.push(o[r])),a.forEach(({matches:e})=>{o[r].matches.push(...e)}))}}),i}_searchObjectList(e){const t=H(e,this.options),{keys:n,records:r}=this._myIndex,o=[];return r.forEach(({$:e,i:r})=>{if(!d(e))return;let i=[];n.forEach((n,r)=>{i.push(...this._findMatches({key:n,value:e[r],searcher:t}))}),i.length&&o.push({idx:r,item:e,matches:i})}),o}_findMatches({key:e,value:t,searcher:n}){if(!d(t))return[];let r=[];if(s(t))t.forEach(({v:t,i:o,n:i})=>{if(!d(t))return;const{isMatch:a,score:s,indices:l}=n.searchIn(t);a&&r.push({score:s,key:e,value:t,idx:o,norm:i,indices:l})});else{const{v:o,n:i}=t,{isMatch:a,score:s,indices:l}=n.searchIn(o);a&&r.push({score:s,key:e,value:o,norm:i,indices:l})}return r}}function Z(e,t={}){const n="string"==typeof e?document.querySelector(e):e;if(!n)throw new Error(`Could not find container: ${e}`);const r=t.placeholderText||"Select items...",o=t.closeOnSelect??!1,i=t.enableSearch??!1,a=t.multiple??!0,s=t.searchPlaceholderText||"Search...",l=t.searchNoResultsText||"No results found",c=t.searchDebounceMs??200;let u=[...t.initialList||[]];n.innerHTML="",n.classList.add("fancy-dropdown-container"),Object.assign(n.style,{position:"relative",userSelect:"none"});const p=document.createElement("div");p.className="fancy-dropdown-trigger",Object.assign(p.style,{padding:"8px 12px",border:"1px solid var(--border-color)",backgroundColor:"var(--bg-color)",color:"var(--text-color)",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"space-between"});const d=document.createElement("span");d.className="fancy-dropdown-trigger-text",d.textContent=r;const h=document.createElement("i");h.className="fas fa-chevron-down",h.style.marginLeft="8px",p.append(d,h),n.append(p);const f=document.createElement("div");f.className="fancy-dropdown-list",Object.assign(f.style,{position:"absolute",top:"100%",left:"0",right:"0",maxHeight:"300px",display:"none",zIndex:"1050",border:"1px solid var(--border-color)",borderTop:"none",backgroundColor:"var(--bg-color-popup, var(--bg-color-secondary, var(--greyCAIbg, var(--grey30))))",color:"var(--text-color)",borderRadius:"0 0 4px 4px",boxShadow:"0 4px 8px var(--black50a)",overflowY:"auto"}),n.append(f);let m=null,g=null,v=null,y=null;i&&(g=document.createElement("div"),g.className="fancy-dropdown-search-wrapper",Object.assign(g.style,{padding:"8px",borderBottom:"1px solid var(--border-color)",position:"sticky",top:"0",backgroundColor:"inherit"}),m=document.createElement("input"),m.type="text",m.className="fancy-dropdown-search-input",m.placeholder=s,Object.assign(m.style,{width:"100%",padding:"6px 10px",border:"1px solid var(--border-color)",borderRadius:"3px",boxSizing:"border-box",backgroundColor:"var(--bg-color)",color:"var(--text-color)"}),m.addEventListener("click",e=>e.stopPropagation()),g.append(m),f.append(g),v=document.createElement("div"),v.className="fancy-dropdown-no-results",v.textContent=l,Object.assign(v.style,{padding:"8px 12px",textAlign:"center",color:"var(--text-color-secondary, var(--grey50))",display:"none"}),f.append(v));let b=!1,S=null;const w=e=>"string"==typeof e?e:e.label,x=e=>"string"==typeof e?e:e.value;let C=(t.initialValues||[]).filter(e=>u.some(t=>x(t)===e));const _=()=>{if(!i)return;const e={includeScore:!1,threshold:.4,isCaseSensitive:!1,findAllMatches:!0,...t.searchFuseOptions||{},keys:t.searchFuseOptions?.keys||[{name:"label",weight:.7},{name:"value",weight:.3}]},n=u.map(e=>"string"==typeof e?{value:e,label:e}:e);!t.searchFuseOptions?.keys&&u.every(e=>"string"==typeof e)&&(e.keys=["label"]),S=new J(n,e)},k=e=>{let t=!1;f.querySelectorAll(".fancy-dropdown-item").forEach(n=>{const r=n.dataset.value,o=C.includes(r),i=n.querySelector(".checkmark");o?(n.classList.add("selected"),i&&(i.style.display="inline-block")):(n.classList.remove("selected"),i&&(i.style.display="none")),void 0!==e?e.includes(r)?(n.style.display="flex",t=!0):n.style.display="none":(n.style.display="flex",t=!0)}),i&&v&&(v.style.display=void 0===e||t?"none":"block"),(()=>{if(0===C.length)d.textContent=r;else if(1===C.length){const e=C[0],t=u.find(t=>x(t)===e),n=t?w(t):e;d.textContent=n}else d.textContent=`${C.length} items selected`})()},E=e=>{if(!i||!S)return void k();const t=e.trim();if(""===t)return void k(void 0);const n=S.search(t).map(e=>e.item.value);k(n)},P=()=>{m&&(y&&clearTimeout(y),y=window.setTimeout(()=>{m&&E(m.value)},c))},O=()=>{b||(b=!0,f.style.display="block",h.classList.remove("fa-chevron-down"),h.classList.add("fa-chevron-up"),i&&m&&setTimeout(()=>m?.focus(),50))},I=()=>{b&&(b=!1,f.style.display="none",i&&m&&(m.value="",E("")),h.classList.remove("fa-chevron-up"),h.classList.add("fa-chevron-down"),y&&clearTimeout(y))};p.addEventListener("click",e=>{e.stopPropagation(),b?I():O()}),document.addEventListener("click",e=>{b&&n&&!n.contains(e.target)&&I()}),i&&m&&m.addEventListener("input",P);const T=(e,n)=>{const r=x(e),s=w(e),l=document.createElement("div");l.className="fancy-dropdown-item",l.dataset.value=r,Object.assign(l.style,{padding:"8px 12px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"space-between"}),l.addEventListener("mouseenter",()=>{l.style.backgroundColor="var(--hover-color, var(--white20a))"}),l.addEventListener("mouseleave",()=>{l.style.backgroundColor=""});const c=document.createElement("span");c.textContent=s,l.append(c);const u=document.createElement("i");return u.className="checkmark fa-solid fa-check",Object.assign(u.style,{marginLeft:"8px",display:n?"inline-block":"none"}),l.append(u),l.addEventListener("click",function(e){e.stopPropagation();const n=e.currentTarget.dataset.value,r=[...C];let s;s=a?C.includes(n)?C.filter(e=>e!==n):[...C,n]:C.includes(n)?[]:[n];(async()=>{if(t.onBeforeSelection)try{if(!await Promise.resolve(t.onBeforeSelection(r,s)))return!1}catch(e){return console.error("onBeforeSelection callback failed:",e),!1}return!0})().then(e=>{e&&(C=s,i&&m&&""!==m.value.trim()?E(m.value):k(void 0),t.onSelectChange&&Promise.resolve(t.onSelectChange(r,C)).catch(e=>console.error("onSelectChange callback failed:",e)),o&&I())})}),v?f.insertBefore(l,v):f.append(l),l};u.length>0&&u.forEach(e=>{const t=x(e);T(e,C.includes(t))}),_(),k();return{container:n,dropdownTrigger:p,dropdownList:f,getValues:()=>[...C],setValues:e=>{const n=[...C],r=e.filter(e=>u.some(t=>x(t)===e));C=[...r],i&&m&&""!==m.value?(m.value="",E("")):k();JSON.stringify(n.sort())!==JSON.stringify(C.sort())&&t.onSelectChange&&Promise.resolve(t.onSelectChange(n,C)).catch(e=>console.error("onSelectChange callback failed:",e))},getOptions:()=>u.map(e=>"string"==typeof e?{value:e,label:e}:e),addOption:(e,n=!1)=>{const r=x(e);if(u.some(e=>x(e)===r))return;u.push(e),T(e,n),_();let o=!1;const s=[...C];n&&!C.includes(r)?(a?C.push(r):C=[r],o=!0):n&&!a&&C.length>0&&C[0]!==r&&(C=[r],o=!0),i&&m&&""!==m.value?E(m.value):k(),o&&t.onSelectChange&&Promise.resolve(t.onSelectChange(s,C)).catch(e=>console.error("onSelectChange callback failed:",e))},removeOption:e=>{const n=u.length;if(u=u.filter(t=>x(t)!==e),u.length===n)return;let r=!1;const o=[...C],a=C.indexOf(e);a>-1&&(C.splice(a,1),r=!0);const s=f.querySelector(`.fancy-dropdown-item[data-value="${e}"]`);s?.remove(),_(),i&&m&&""!==m.value?E(m.value):k(),r&&t.onSelectChange&&Promise.resolve(t.onSelectChange(o,C)).catch(e=>console.error("onSelectChange callback failed:",e))},selectAll:()=>{if(!a)return;const e=[...C],n=u.map(x);C=[...new Set([...C,...n])];const r=JSON.stringify(e.sort())!==JSON.stringify(C.sort());i&&m&&""!==m.value?E(m.value):k(),r&&t.onSelectChange&&Promise.resolve(t.onSelectChange(e,C)).catch(e=>console.error("onSelectChange callback failed:",e))},deselectAll:()=>{const e=[...C];C.length>0&&(C=[],i&&m&&""!==m.value?E(m.value):k(),t.onSelectChange&&Promise.resolve(t.onSelectChange(e,C)).catch(e=>console.error("onSelectChange callback failed:",e)))},disable:()=>{n.style.pointerEvents="none",n.style.opacity="0.6",b&&I()},enable:()=>{n.style.pointerEvents="auto",n.style.opacity="1"},open:O,close:I,toggle:()=>b?I():O()}}J.version="7.1.0",J.createIndex=_,J.parseIndex=function(e,{getFn:t=w.getFn,fieldNormWeight:n=w.fieldNormWeight}={}){const{keys:r,records:o}=e,i=new C({getFn:t,fieldNormWeight:n});return i.setKeys(r),i.setIndexRecords(o),i},J.config=w,J.parseQuery=X,function(...e){$.push(...e)}(R);var Q=n(149);function ee(e,t={}){const n=SillyTavern.getContext(),r=t.readOnlyValues||[],o=document.querySelector(e);if(!o)throw new Error(`Could not find preset select: ${e}`);const i=e=>t.label?t.label(e):e,a=document.createElement("div");a.className="preset-select-container",a.style.display="flex",a.style.alignItems="center";const s=e=>r.includes(e);if(o.parentNode?.insertBefore(a,o),a.appendChild(o),t.initialList&&t.initialList.length>0){o.innerHTML="";const e=e=>"string"==typeof e?e:e.value;for(const n of t.initialList){const t=document.createElement("option"),r=e(n);t.value=r,t.textContent=i(r),s(r)&&(t.dataset.readonly="true"),o.appendChild(t)}}if(t.initialValue){const e=Array.from(o.options).find(e=>e.value===t.initialValue);e&&(o.value=e.value)}let l=o.value;if(o.addEventListener("change",async()=>{const e=o.value;t.onSelectChange&&l!==e&&await t.onSelectChange(l,e),l=e}),t.create){const e=document.createElement("i");e.className="menu_button fa-solid fa-file-circle-plus";const r=i("");e.title=`Create a new ${r}`,e.setAttribute("data-i18n",`[title]Create a new ${r}`),e.addEventListener("click",async()=>{t.create?.onPopupOpen&&await t.create.onPopupOpen();const e=i(""),r=await n.Popup.show.input(`Create a new ${e}`,`Please enter a name for the new ${e}:`,"");if(null===r||""===r.trim())return;let a=r.trim();if(Array.from(o.options).some(e=>e.value===a))return void await(0,Q.YC)("warning",`A ${i(a)} with this name already exists.`);if(t.create?.onBeforeCreate){if(!await t.create.onBeforeCreate(a))return}if(t.create?.onAfterCreate){const e=await t.create.onAfterCreate(a);"string"==typeof e&&(a=e)}const s=document.createElement("option");s.value=a,s.textContent=i(a),o.appendChild(s);const c=o.value;o.value=a,t.onSelectChange&&c!==a&&await t.onSelectChange(c,a),l=a}),a.appendChild(e)}if(t.rename){const e=document.createElement("i");e.className="menu_button fa-solid fa-pencil";const r=i("");e.title=`Rename a ${r}`,e.setAttribute("data-i18n",`[title]Rename a ${r}`),e.addEventListener("click",async()=>{if(-1===o.selectedIndex)return void await(0,Q.YC)("warning",`Please select a ${i("")} to rename.`);const e=o.options[o.selectedIndex];let r=e.value;if(s(r))return void await(0,Q.YC)("warning",`This ${i(r)} cannot be renamed as it is read-only.`);t.rename?.onPopupOpen&&await t.rename.onPopupOpen();const a=await n.Popup.show.input(`Rename ${i(r)}`,`Please enter a new name for "${r}":`,r);if(null===a||""===a.trim()||a===r)return;let c=a.trim();if(Array.from(o.options).some(t=>t.value===c&&t!==e))await(0,Q.YC)("warning",`A ${i(c)} with this name already exists.`);else{if(t.rename?.onBeforeRename){if(!await t.rename.onBeforeRename(r,c))return}if(t.rename?.onAfterRename){const e=await t.rename.onAfterRename(r,c);"string"==typeof e&&(c=e)}e.value=c,e.textContent=i(c),r===l&&(l=c),t.onSelectChange&&o.value===c&&await t.onSelectChange(r,c)}}),a.appendChild(e)}if(t.delete){const e=document.createElement("i");e.className="menu_button fa-solid fa-trash-can";const r=i("");e.title=`Delete a ${r}`,e.setAttribute("data-i18n",`[title]Delete a ${r}`),e.addEventListener("click",async()=>{if(-1===o.selectedIndex)return void await(0,Q.YC)("warning",`Please select a ${i("")} to delete.`);const e=o.options[o.selectedIndex],r=e.value,a=o.selectedIndex;if(s(r))return void await(0,Q.YC)("warning",`This ${i(r)} cannot be deleted as it is read-only.`);t.delete?.onPopupOpen&&await t.delete.onPopupOpen();if(!await n.Popup.show.confirm(`Delete ${i(r)}`,`Are you sure you want to delete "${r}"?`))return;if(t.delete?.onBeforeDelete){if(!await t.delete.onBeforeDelete(r))return}const c=r;let u,p=-1;o.options.length>1&&(p=a<o.options.length-1?a:a-1,u=o.options[p].value),o.removeChild(e),p>=0?(o.selectedIndex=p,l=u,t.onSelectChange&&await t.onSelectChange(c,u)):(t.onSelectChange&&await t.onSelectChange(c,void 0),l=void 0),t.delete?.onAfterDelete&&await t.delete.onAfterDelete(c)}),a.appendChild(e)}return{select:o,container:a}}class te{encode(e){const t=Math.ceil(e.length/4);return new Array(t).fill(" ")}decode(e){return e.join("")}}class ne{messages=[];tokenizer;maxContext;currentTokenCount=0;constructor(e){this.tokenizer=new te,this.maxContext=e}getTokenCount(e){return e.content?e.source?.extra?.token_count??this.tokenizer.encode(e.content).length:0}canFit(e){return this.currentTokenCount+this.getTokenCount(e)<=this.maxContext}add(e){if(!e.content)return!0;const t=this.getTokenCount(e);return!(this.currentTokenCount+t>this.maxContext)&&(this.messages.push(e),this.currentTokenCount+=t,!0)}addFront(e){if(!e.content)return!0;const t=this.getTokenCount(e);return!(this.currentTokenCount+t>this.maxContext)&&(this.messages.unshift(e),this.currentTokenCount+=t,!0)}addMany(e){let t=0;const n=e.filter(e=>{if(!e.content)return!0;const n=this.getTokenCount(e);return!(this.currentTokenCount+t+n>this.maxContext)&&(t+=n,!0)});return n.length>0&&(this.messages.push(...n),this.currentTokenCount+=t),n.length===e.length}insert(e,t){if(!t.content)return!0;const n=this.getTokenCount(t);return!(this.currentTokenCount+n>this.maxContext)&&(this.messages.splice(e,0,t),this.currentTokenCount+=n,!0)}getMessages(){return this.messages}}async function re(e,{targetCharacterId:t,presetName:n,instructName:r,contextName:o,syspromptName:i,maxContext:a,includeNames:s,ignoreCharacterFields:l,ignoreAuthorNote:c,ignoreWorldInfo:u,messageIndexesBetween:p}={}){if(!["textgenerationwebui","openai"].includes(e))throw new Error("Unsupported API");const d=SillyTavern.getContext();let{description:h,personality:f,persona:m,scenario:g,mesExamples:v,system:y,jailbreak:b}=l?{description:"",personality:"",persona:"",scenario:"",mesExamples:"",system:"",jailbreak:""}:d.getCharacterCardFields({chid:t});const S="textgenerationwebui"===e?d.getPresetManager("instruct")?.getCompletionPresetByName(r):void 0,w=!!S?.enabled;let x=(0,Q.up)(v,w);let C=[];const _=function(){if("number"==typeof a)return a;if(!a)return(0,Q.Rg)();if("active"===a||!n)return(0,Q.Rg)();if("number"==typeof a)return a;let t;if("textgenerationwebui"===e){const e=d.getPresetManager("textgenerationwebui")?.getCompletionPresetByName(n);t=e?.max_length}else{const e=d.getPresetManager("openai")?.getCompletionPresetByName(n);t=e?.openai_max_context}return"number"==typeof t?t:(0,Q.Rg)()}();if(_<=0)return{result:[],warnings:C};const k=new ne(_),E=d.ToolManager.isToolCallingSupported(),P=p?.start??0,O=p?.end?p.end+1:void 0;let I=-1===P&&0===O?[]:d.chat.slice(P,O).filter(e=>!e.is_system||E&&Array.isArray(e.extra?.tool_invocations));I=await Promise.all(I.map(async(e,t)=>{let n=e.mes,r=e.is_user?Q.gp.USER_INPUT:Q.gp.AI_OUTPUT;let o={isPrompt:!0,depth:I.length-t-1},i=(0,Q.Up)(n,r,o);return i=await(0,Q.ku)(e,i),e?.extra?.append_title&&e?.extra?.title&&(i=`${i}\n\n${e.extra.title}`),{...e,mes:i,index:t}}));const T=I.map(e=>Q.sr?`${e.name}: ${e.mes}`:e.mes).reverse(),{worldInfoString:A,worldInfoBefore:D,worldInfoAfter:N,worldInfoExamples:F,worldInfoDepth:M,anBefore:L,anAfter:j}=u?{worldInfoString:"",worldInfoBefore:"",worldInfoAfter:"",worldInfoExamples:[],worldInfoDepth:[],anBefore:[],anAfter:[]}:await d.getWorldInfoPrompt(T,_,!1);for(const H of F){const q=H.content;if(0===q.length)continue;const U=(0,Q.wn)(q,Q.py,Q.iQ),Y=(0,Q.up)(U,w);H.position===Q.H.before?x.unshift(...Y):x.push(...Y)}function B(){const e=[];for(let t=I.length-1;t>=0;t--){const n=I[t];e.unshift({role:n.is_user?"user":"assistant",content:s?`${n.name}: ${n.mes}`:n.mes,source:n})}k.addMany(e)}if("textgenerationwebui"===e){const V=[...x];x&&(x=(0,Q.IW)(x,Q.py,Q.iQ));const W=d.getPresetManager("sysprompt")?.getCompletionPresetByName(i);W&&(y=d.powerUserSettings.prefer_character_prompt&&y?y:(0,Q.wn)(W.content,Q.py,Q.iQ),y=w?(0,Q.UO)(d.substituteParams(y,Q.py,Q.iQ,W.content),S):y);const G={description:h,personality:f,persona:d.powerUserSettings.persona_description_position==Q.Dv.IN_PROMPT?m:"",scenario:g,system:y,char:Q.iQ,user:Q.py,wiBefore:D,wiAfter:N,loreBefore:D,loreAfter:N,mesExamples:x.join(""),mesExamplesRaw:V.join("")},X=d.getPresetManager("context")?.getCompletionPresetByName(o);let K=(0,Q.x_)(G,{customInstructSettings:S,customStoryString:X?.story_string});k.add({role:"system",content:K,ignoreInstruct:!0}),B()}else{let z=(0,Q.DA)(I),J=(0,Q.bz)(x);async function Z(){let[e,t]=await(0,Q.kt)({name2:Q.iQ,charDescription:h,charPersonality:f,Scenario:g,worldInfoBefore:D,worldInfoAfter:N,extensionPrompts:d.extensionPrompts,bias:"",type:"normal",quietPrompt:void 0,quietImage:void 0,cyclePrompt:"",systemPromptOverride:y,jailbreakPromptOverride:b,personaDescription:m,messages:z,messageExamples:J},!1);k.addMany(e)}if(!n)return C.push("No preset name provided. Using default preset."),await Z(),{result:k.getMessages(),warnings:C};const ee=d.getPresetManager("openai")?.getCompletionPresetByName(n);if(!ee)return console.warn(`Preset not found: ${n}. Using current preset.`),C.push(`Preset not found: ${n}. Using current preset.`),Z(),{result:k.getMessages(),warnings:C};let te=ee.prompt_order?.find(e=>e.character_id===Q.oP);if(!te&&ee.prompt_order&&ee.prompt_order.length>0&&(te=ee.prompt_order[0]),!te)return console.warn(`No prompt order found for preset: ${n}. Using current preset.`),C.push(`No prompt order found for preset: ${n}. Using current preset.`),Z(),{result:k.getMessages(),warnings:C};const re=g&&ee.scenario_format?d.substituteParams(ee.scenario_format):"",oe=f&&ee.personality_format?d.substituteParams(ee.personality_format):"",ie=d.substituteParams(ee.group_nudge_prompt),ae=ee.impersonation_prompt?d.substituteParams(ee.impersonation_prompt):"",se=[];u||se.push({role:"system",content:(0,Q.aC)(D,{wiFormat:ee.wi_format}),identifier:"worldInfoBefore"},{role:"system",content:(0,Q.aC)(N,{wiFormat:ee.wi_format}),identifier:"worldInfoAfter"}),l||se.push({role:"system",content:h,identifier:"charDescription"},{role:"system",content:oe,identifier:"charPersonality"},{role:"system",content:re,identifier:"scenario"}),se.push({role:"system",content:ae,identifier:"impersonate"},{role:"system",content:ie,identifier:"groupNudge"});const le=d.extensionPrompts["1_memory"];le&&le.value&&se.push({role:(0,Q.Rb)(le.role),content:le.value,identifier:"summary",position:(0,Q.w1)(le.position)});const ce=d.extensionPrompts["2_floating_prompt"];!c&&ce&&ce.value&&se.push({role:(0,Q.Rb)(ce.role),content:ce.value,identifier:"authorsNote",position:(0,Q.w1)(ce.position)});const ue=d.extensionPrompts["3_vectors"];ue&&ue.value&&se.push({role:"system",content:ue.value,identifier:"vectorsMemory",position:(0,Q.w1)(ue.position)});const pe=d.extensionPrompts["4_vectors_data_bank"];pe&&pe.value&&se.push({role:(0,Q.Rb)(pe.role),content:pe.value,identifier:"vectorsDataBank",position:(0,Q.w1)(pe.position)});const de=d.extensionPrompts.chromadb;function he(e){const t=se.find(t=>t.identifier===e);if(t)return t;const n=ee.prompts.find(t=>t.identifier===e);return n||void 0}de&&de.value&&se.push({role:"system",content:de.value,identifier:"smartContext",position:(0,Q.w1)(de.position)}),!l&&d.powerUserSettings.persona_description&&d.powerUserSettings.persona_description_position===Q.Dv.IN_PROMPT&&se.push({role:"system",content:d.powerUserSettings.persona_description,identifier:"personaDescription"}),te.order.forEach(e=>{if(!e.enabled)return;const t=he(e.identifier);t&&t.content?k.add({role:t.role??"system",content:d.substituteParams(t.content)}):"chatHistory"===e.identifier&&B()})}const R=["1_memory","2_floating_prompt","3_vectors","4_vectors_data_bank","chromadb","PERSONA_DESCRIPTION","QUIET_PROMPT","DEPTH_PROMPT"];for(const fe in d.extensionPrompts)if(Object.hasOwn(d.extensionPrompts,fe)){const me=d.extensionPrompts[fe];if(R.includes(fe))continue;if(!d.extensionPrompts[fe].value)continue;if(![Q.$O.BEFORE_PROMPT,Q.$O.IN_PROMPT].includes(me.position))continue;if("function"==typeof me.filter&&!await me.filter())continue;const ge={role:(0,Q.Rb)(me.role)??"system",content:me.value};if(me.position===Q.$O.BEFORE_PROMPT)k.insert(me.depth,ge);else if(me.position===Q.$O.IN_PROMPT){const ve=k.getMessages();k.insert(ve.length-me.depth,ge)}}for(const ye of M){const be=k.getMessages();k.insert(be.length-ye.depth,{role:(0,Q.Rb)(ye.role),content:ye.entries.join("\n")})}if(!l){const Se=(0,Q.O0)(Q.Yb,Number(Q.oP));if(Q.Yb&&Array.isArray(Se)&&Se.length>0)Se.filter(e=>e.text).forEach((e,t)=>{const n=k.getMessages();k.insert(n.length-e.depth,{role:e.role,content:e.text})});else{const we=(0,Q.wn)(d.characters[Q.oP]?.data?.extensions?.depth_prompt?.prompt?.trim(),Q.py,Q.iQ)||"";if(we){const xe=Q.p,Ce=d.characters[Q.oP]?.data?.extensions?.depth_prompt?.role??Q.wL,_e=k.getMessages();k.insert(_e.length-xe,{role:(0,Q.Rb)(Ce),content:we})}}}let $=-1;if(!c){const ke=(0,Q.mz)();if(ke.prompt){ke.prompt=(0,Q.wn)(ke.prompt,Q.py,Q.iQ);const Ee={role:(0,Q.Rb)(ke.role),content:ke.prompt};switch(ke.position){case Q.$O.IN_PROMPT:k.insert(1,Ee),$=1;break;case Q.$O.IN_CHAT:$=k.getMessages().length-ke.depth,k.insert($,Ee);break;case Q.$O.BEFORE_PROMPT:k.addFront(Ee),$=0}}}return $>=0&&(L.length>0&&(k.insert($,{role:"system",content:L.join("\n")}),$++),j.length>0&&k.insert($+1,{role:"system",content:j.join("\n")})),{result:k.getMessages(),warnings:C}}
/**!
 * Sortable 1.15.6
 * @author	RubaXa   <trash@rubaxa.org>
 * @author	owenm    <owen23355@gmail.com>
 * @license MIT
 */
function oe(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function ie(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?oe(Object(n),!0).forEach(function(t){se(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):oe(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function ae(e){return ae="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ae(e)}function se(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function le(){return le=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},le.apply(this,arguments)}function ce(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}function ue(e){if("undefined"!=typeof window&&window.navigator)return!!navigator.userAgent.match(e)}var pe=ue(/(?:Trident.*rv[ :]?11\.|msie|iemobile|Windows Phone)/i),de=ue(/Edge/i),he=ue(/firefox/i),fe=ue(/safari/i)&&!ue(/chrome/i)&&!ue(/android/i),me=ue(/iP(ad|od|hone)/i),ge=ue(/chrome/i)&&ue(/android/i),ve={capture:!1,passive:!1};function ye(e,t,n){e.addEventListener(t,n,!pe&&ve)}function be(e,t,n){e.removeEventListener(t,n,!pe&&ve)}function Se(e,t){if(t){if(">"===t[0]&&(t=t.substring(1)),e)try{if(e.matches)return e.matches(t);if(e.msMatchesSelector)return e.msMatchesSelector(t);if(e.webkitMatchesSelector)return e.webkitMatchesSelector(t)}catch(e){return!1}return!1}}function we(e){return e.host&&e!==document&&e.host.nodeType?e.host:e.parentNode}function xe(e,t,n,r){if(e){n=n||document;do{if(null!=t&&(">"===t[0]?e.parentNode===n&&Se(e,t):Se(e,t))||r&&e===n)return e;if(e===n)break}while(e=we(e))}return null}var Ce,_e=/\s+/g;function ke(e,t,n){if(e&&t)if(e.classList)e.classList[n?"add":"remove"](t);else{var r=(" "+e.className+" ").replace(_e," ").replace(" "+t+" "," ");e.className=(r+(n?" "+t:"")).replace(_e," ")}}function Ee(e,t,n){var r=e&&e.style;if(r){if(void 0===n)return document.defaultView&&document.defaultView.getComputedStyle?n=document.defaultView.getComputedStyle(e,""):e.currentStyle&&(n=e.currentStyle),void 0===t?n:n[t];t in r||-1!==t.indexOf("webkit")||(t="-webkit-"+t),r[t]=n+("string"==typeof n?"":"px")}}function Pe(e,t){var n="";if("string"==typeof e)n=e;else do{var r=Ee(e,"transform");r&&"none"!==r&&(n=r+" "+n)}while(!t&&(e=e.parentNode));var o=window.DOMMatrix||window.WebKitCSSMatrix||window.CSSMatrix||window.MSCSSMatrix;return o&&new o(n)}function Oe(e,t,n){if(e){var r=e.getElementsByTagName(t),o=0,i=r.length;if(n)for(;o<i;o++)n(r[o],o);return r}return[]}function Ie(){var e=document.scrollingElement;return e||document.documentElement}function Te(e,t,n,r,o){if(e.getBoundingClientRect||e===window){var i,a,s,l,c,u,p;if(e!==window&&e.parentNode&&e!==Ie()?(a=(i=e.getBoundingClientRect()).top,s=i.left,l=i.bottom,c=i.right,u=i.height,p=i.width):(a=0,s=0,l=window.innerHeight,c=window.innerWidth,u=window.innerHeight,p=window.innerWidth),(t||n)&&e!==window&&(o=o||e.parentNode,!pe))do{if(o&&o.getBoundingClientRect&&("none"!==Ee(o,"transform")||n&&"static"!==Ee(o,"position"))){var d=o.getBoundingClientRect();a-=d.top+parseInt(Ee(o,"border-top-width")),s-=d.left+parseInt(Ee(o,"border-left-width")),l=a+i.height,c=s+i.width;break}}while(o=o.parentNode);if(r&&e!==window){var h=Pe(o||e),f=h&&h.a,m=h&&h.d;h&&(l=(a/=m)+(u/=m),c=(s/=f)+(p/=f))}return{top:a,left:s,bottom:l,right:c,width:p,height:u}}}function Ae(e,t,n){for(var r=Le(e,!0),o=Te(e)[t];r;){var i=Te(r)[n];if(!("top"===n||"left"===n?o>=i:o<=i))return r;if(r===Ie())break;r=Le(r,!1)}return!1}function De(e,t,n,r){for(var o=0,i=0,a=e.children;i<a.length;){if("none"!==a[i].style.display&&a[i]!==Ht.ghost&&(r||a[i]!==Ht.dragged)&&xe(a[i],n.draggable,e,!1)){if(o===t)return a[i];o++}i++}return null}function Ne(e,t){for(var n=e.lastElementChild;n&&(n===Ht.ghost||"none"===Ee(n,"display")||t&&!Se(n,t));)n=n.previousElementSibling;return n||null}function Fe(e,t){var n=0;if(!e||!e.parentNode)return-1;for(;e=e.previousElementSibling;)"TEMPLATE"===e.nodeName.toUpperCase()||e===Ht.clone||t&&!Se(e,t)||n++;return n}function Me(e){var t=0,n=0,r=Ie();if(e)do{var o=Pe(e),i=o.a,a=o.d;t+=e.scrollLeft*i,n+=e.scrollTop*a}while(e!==r&&(e=e.parentNode));return[t,n]}function Le(e,t){if(!e||!e.getBoundingClientRect)return Ie();var n=e,r=!1;do{if(n.clientWidth<n.scrollWidth||n.clientHeight<n.scrollHeight){var o=Ee(n);if(n.clientWidth<n.scrollWidth&&("auto"==o.overflowX||"scroll"==o.overflowX)||n.clientHeight<n.scrollHeight&&("auto"==o.overflowY||"scroll"==o.overflowY)){if(!n.getBoundingClientRect||n===document.body)return Ie();if(r||t)return n;r=!0}}}while(n=n.parentNode);return Ie()}function je(e,t){return Math.round(e.top)===Math.round(t.top)&&Math.round(e.left)===Math.round(t.left)&&Math.round(e.height)===Math.round(t.height)&&Math.round(e.width)===Math.round(t.width)}function Be(e,t){return function(){if(!Ce){var n=arguments;1===n.length?e.call(this,n[0]):e.apply(this,n),Ce=setTimeout(function(){Ce=void 0},t)}}}function Re(e,t,n){e.scrollLeft+=t,e.scrollTop+=n}function $e(e){var t=window.Polymer,n=window.jQuery||window.Zepto;return t&&t.dom?t.dom(e).cloneNode(!0):n?n(e).clone(!0)[0]:e.cloneNode(!0)}function He(e,t,n){var r={};return Array.from(e.children).forEach(function(o){var i,a,s,l;if(xe(o,t.draggable,e,!1)&&!o.animated&&o!==n){var c=Te(o);r.left=Math.min(null!==(i=r.left)&&void 0!==i?i:1/0,c.left),r.top=Math.min(null!==(a=r.top)&&void 0!==a?a:1/0,c.top),r.right=Math.max(null!==(s=r.right)&&void 0!==s?s:-1/0,c.right),r.bottom=Math.max(null!==(l=r.bottom)&&void 0!==l?l:-1/0,c.bottom)}}),r.width=r.right-r.left,r.height=r.bottom-r.top,r.x=r.left,r.y=r.top,r}var qe="Sortable"+(new Date).getTime();function Ue(){var e,t=[];return{captureAnimationState:function(){(t=[],this.options.animation)&&[].slice.call(this.el.children).forEach(function(e){if("none"!==Ee(e,"display")&&e!==Ht.ghost){t.push({target:e,rect:Te(e)});var n=ie({},t[t.length-1].rect);if(e.thisAnimationDuration){var r=Pe(e,!0);r&&(n.top-=r.f,n.left-=r.e)}e.fromRect=n}})},addAnimationState:function(e){t.push(e)},removeAnimationState:function(e){t.splice(function(e,t){for(var n in e)if(e.hasOwnProperty(n))for(var r in t)if(t.hasOwnProperty(r)&&t[r]===e[n][r])return Number(n);return-1}(t,{target:e}),1)},animateAll:function(n){var r=this;if(!this.options.animation)return clearTimeout(e),void("function"==typeof n&&n());var o=!1,i=0;t.forEach(function(e){var t=0,n=e.target,a=n.fromRect,s=Te(n),l=n.prevFromRect,c=n.prevToRect,u=e.rect,p=Pe(n,!0);p&&(s.top-=p.f,s.left-=p.e),n.toRect=s,n.thisAnimationDuration&&je(l,s)&&!je(a,s)&&(u.top-s.top)/(u.left-s.left)===(a.top-s.top)/(a.left-s.left)&&(t=function(e,t,n,r){return Math.sqrt(Math.pow(t.top-e.top,2)+Math.pow(t.left-e.left,2))/Math.sqrt(Math.pow(t.top-n.top,2)+Math.pow(t.left-n.left,2))*r.animation}(u,l,c,r.options)),je(s,a)||(n.prevFromRect=a,n.prevToRect=s,t||(t=r.options.animation),r.animate(n,u,s,t)),t&&(o=!0,i=Math.max(i,t),clearTimeout(n.animationResetTimer),n.animationResetTimer=setTimeout(function(){n.animationTime=0,n.prevFromRect=null,n.fromRect=null,n.prevToRect=null,n.thisAnimationDuration=null},t),n.thisAnimationDuration=t)}),clearTimeout(e),o?e=setTimeout(function(){"function"==typeof n&&n()},i):"function"==typeof n&&n(),t=[]},animate:function(e,t,n,r){if(r){Ee(e,"transition",""),Ee(e,"transform","");var o=Pe(this.el),i=o&&o.a,a=o&&o.d,s=(t.left-n.left)/(i||1),l=(t.top-n.top)/(a||1);e.animatingX=!!s,e.animatingY=!!l,Ee(e,"transform","translate3d("+s+"px,"+l+"px,0)"),this.forRepaintDummy=function(e){return e.offsetWidth}(e),Ee(e,"transition","transform "+r+"ms"+(this.options.easing?" "+this.options.easing:"")),Ee(e,"transform","translate3d(0,0,0)"),"number"==typeof e.animated&&clearTimeout(e.animated),e.animated=setTimeout(function(){Ee(e,"transition",""),Ee(e,"transform",""),e.animated=!1,e.animatingX=!1,e.animatingY=!1},r)}}}}var Ye=[],Ve={initializeByDefault:!0},We={mount:function(e){for(var t in Ve)Ve.hasOwnProperty(t)&&!(t in e)&&(e[t]=Ve[t]);Ye.forEach(function(t){if(t.pluginName===e.pluginName)throw"Sortable: Cannot mount plugin ".concat(e.pluginName," more than once")}),Ye.push(e)},pluginEvent:function(e,t,n){var r=this;this.eventCanceled=!1,n.cancel=function(){r.eventCanceled=!0};var o=e+"Global";Ye.forEach(function(r){t[r.pluginName]&&(t[r.pluginName][o]&&t[r.pluginName][o](ie({sortable:t},n)),t.options[r.pluginName]&&t[r.pluginName][e]&&t[r.pluginName][e](ie({sortable:t},n)))})},initializePlugins:function(e,t,n,r){for(var o in Ye.forEach(function(r){var o=r.pluginName;if(e.options[o]||r.initializeByDefault){var i=new r(e,t,e.options);i.sortable=e,i.options=e.options,e[o]=i,le(n,i.defaults)}}),e.options)if(e.options.hasOwnProperty(o)){var i=this.modifyOption(e,o,e.options[o]);void 0!==i&&(e.options[o]=i)}},getEventProperties:function(e,t){var n={};return Ye.forEach(function(r){"function"==typeof r.eventProperties&&le(n,r.eventProperties.call(t[r.pluginName],e))}),n},modifyOption:function(e,t,n){var r;return Ye.forEach(function(o){e[o.pluginName]&&o.optionListeners&&"function"==typeof o.optionListeners[t]&&(r=o.optionListeners[t].call(e[o.pluginName],n))}),r}};function Ge(e){var t=e.sortable,n=e.rootEl,r=e.name,o=e.targetEl,i=e.cloneEl,a=e.toEl,s=e.fromEl,l=e.oldIndex,c=e.newIndex,u=e.oldDraggableIndex,p=e.newDraggableIndex,d=e.originalEvent,h=e.putSortable,f=e.extraEventProperties;if(t=t||n&&n[qe]){var m,g=t.options,v="on"+r.charAt(0).toUpperCase()+r.substr(1);!window.CustomEvent||pe||de?(m=document.createEvent("Event")).initEvent(r,!0,!0):m=new CustomEvent(r,{bubbles:!0,cancelable:!0}),m.to=a||n,m.from=s||n,m.item=o||n,m.clone=i,m.oldIndex=l,m.newIndex=c,m.oldDraggableIndex=u,m.newDraggableIndex=p,m.originalEvent=d,m.pullMode=h?h.lastPutMode:void 0;var y=ie(ie({},f),We.getEventProperties(r,t));for(var b in y)m[b]=y[b];n&&n.dispatchEvent(m),g[v]&&g[v].call(t,m)}}var Xe=["evt"],Ke=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=n.evt,o=ce(n,Xe);We.pluginEvent.bind(Ht)(e,t,ie({dragEl:Je,parentEl:Ze,ghostEl:Qe,rootEl:et,nextEl:tt,lastDownEl:nt,cloneEl:rt,cloneHidden:ot,dragStarted:vt,putSortable:ut,activeSortable:Ht.active,originalEvent:r,oldIndex:it,oldDraggableIndex:st,newIndex:at,newDraggableIndex:lt,hideGhostForTarget:jt,unhideGhostForTarget:Bt,cloneNowHidden:function(){ot=!0},cloneNowShown:function(){ot=!1},dispatchSortableEvent:function(e){ze({sortable:t,name:e,originalEvent:r})}},o))};function ze(e){Ge(ie({putSortable:ut,cloneEl:rt,targetEl:Je,rootEl:et,oldIndex:it,oldDraggableIndex:st,newIndex:at,newDraggableIndex:lt},e))}var Je,Ze,Qe,et,tt,nt,rt,ot,it,at,st,lt,ct,ut,pt,dt,ht,ft,mt,gt,vt,yt,bt,St,wt,xt=!1,Ct=!1,_t=[],kt=!1,Et=!1,Pt=[],Ot=!1,It=[],Tt="undefined"!=typeof document,At=me,Dt=de||pe?"cssFloat":"float",Nt=Tt&&!ge&&!me&&"draggable"in document.createElement("div"),Ft=function(){if(Tt){if(pe)return!1;var e=document.createElement("x");return e.style.cssText="pointer-events:auto","auto"===e.style.pointerEvents}}(),Mt=function(e,t){var n=Ee(e),r=parseInt(n.width)-parseInt(n.paddingLeft)-parseInt(n.paddingRight)-parseInt(n.borderLeftWidth)-parseInt(n.borderRightWidth),o=De(e,0,t),i=De(e,1,t),a=o&&Ee(o),s=i&&Ee(i),l=a&&parseInt(a.marginLeft)+parseInt(a.marginRight)+Te(o).width,c=s&&parseInt(s.marginLeft)+parseInt(s.marginRight)+Te(i).width;if("flex"===n.display)return"column"===n.flexDirection||"column-reverse"===n.flexDirection?"vertical":"horizontal";if("grid"===n.display)return n.gridTemplateColumns.split(" ").length<=1?"vertical":"horizontal";if(o&&a.float&&"none"!==a.float){var u="left"===a.float?"left":"right";return!i||"both"!==s.clear&&s.clear!==u?"horizontal":"vertical"}return o&&("block"===a.display||"flex"===a.display||"table"===a.display||"grid"===a.display||l>=r&&"none"===n[Dt]||i&&"none"===n[Dt]&&l+c>r)?"vertical":"horizontal"},Lt=function(e){function t(e,n){return function(r,o,i,a){var s=r.options.group.name&&o.options.group.name&&r.options.group.name===o.options.group.name;if(null==e&&(n||s))return!0;if(null==e||!1===e)return!1;if(n&&"clone"===e)return e;if("function"==typeof e)return t(e(r,o,i,a),n)(r,o,i,a);var l=(n?r:o).options.group.name;return!0===e||"string"==typeof e&&e===l||e.join&&e.indexOf(l)>-1}}var n={},r=e.group;r&&"object"==ae(r)||(r={name:r}),n.name=r.name,n.checkPull=t(r.pull,!0),n.checkPut=t(r.put),n.revertClone=r.revertClone,e.group=n},jt=function(){!Ft&&Qe&&Ee(Qe,"display","none")},Bt=function(){!Ft&&Qe&&Ee(Qe,"display","")};Tt&&!ge&&document.addEventListener("click",function(e){if(Ct)return e.preventDefault(),e.stopPropagation&&e.stopPropagation(),e.stopImmediatePropagation&&e.stopImmediatePropagation(),Ct=!1,!1},!0);var Rt=function(e){if(Je){e=e.touches?e.touches[0]:e;var t=(o=e.clientX,i=e.clientY,_t.some(function(e){var t=e[qe].options.emptyInsertThreshold;if(t&&!Ne(e)){var n=Te(e),r=o>=n.left-t&&o<=n.right+t,s=i>=n.top-t&&i<=n.bottom+t;return r&&s?a=e:void 0}}),a);if(t){var n={};for(var r in e)e.hasOwnProperty(r)&&(n[r]=e[r]);n.target=n.rootEl=t,n.preventDefault=void 0,n.stopPropagation=void 0,t[qe]._onDragOver(n)}}var o,i,a},$t=function(e){Je&&Je.parentNode[qe]._isOutsideThisEl(e.target)};function Ht(e,t){if(!e||!e.nodeType||1!==e.nodeType)throw"Sortable: `el` must be an HTMLElement, not ".concat({}.toString.call(e));this.el=e,this.options=t=le({},t),e[qe]=this;var n={group:null,sort:!0,disabled:!1,store:null,handle:null,draggable:/^[uo]l$/i.test(e.nodeName)?">li":">*",swapThreshold:1,invertSwap:!1,invertedSwapThreshold:null,removeCloneOnHide:!0,direction:function(){return Mt(e,this.options)},ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",ignore:"a, img",filter:null,preventOnFilter:!0,animation:0,easing:null,setData:function(e,t){e.setData("Text",t.textContent)},dropBubble:!1,dragoverBubble:!1,dataIdAttr:"data-id",delay:0,delayOnTouchOnly:!1,touchStartThreshold:(Number.parseInt?Number:window).parseInt(window.devicePixelRatio,10)||1,forceFallback:!1,fallbackClass:"sortable-fallback",fallbackOnBody:!1,fallbackTolerance:0,fallbackOffset:{x:0,y:0},supportPointer:!1!==Ht.supportPointer&&"PointerEvent"in window&&(!fe||me),emptyInsertThreshold:5};for(var r in We.initializePlugins(this,e,n),n)!(r in t)&&(t[r]=n[r]);for(var o in Lt(t),this)"_"===o.charAt(0)&&"function"==typeof this[o]&&(this[o]=this[o].bind(this));this.nativeDraggable=!t.forceFallback&&Nt,this.nativeDraggable&&(this.options.touchStartThreshold=1),t.supportPointer?ye(e,"pointerdown",this._onTapStart):(ye(e,"mousedown",this._onTapStart),ye(e,"touchstart",this._onTapStart)),this.nativeDraggable&&(ye(e,"dragover",this),ye(e,"dragenter",this)),_t.push(this.el),t.store&&t.store.get&&this.sort(t.store.get(this)||[]),le(this,Ue())}function qt(e,t,n,r,o,i,a,s){var l,c,u=e[qe],p=u.options.onMove;return!window.CustomEvent||pe||de?(l=document.createEvent("Event")).initEvent("move",!0,!0):l=new CustomEvent("move",{bubbles:!0,cancelable:!0}),l.to=t,l.from=e,l.dragged=n,l.draggedRect=r,l.related=o||t,l.relatedRect=i||Te(t),l.willInsertAfter=s,l.originalEvent=a,e.dispatchEvent(l),p&&(c=p.call(u,l,a)),c}function Ut(e){e.draggable=!1}function Yt(){Ot=!1}function Vt(e){for(var t=e.tagName+e.className+e.src+e.href+e.textContent,n=t.length,r=0;n--;)r+=t.charCodeAt(n);return r.toString(36)}function Wt(e){return setTimeout(e,0)}function Gt(e){return clearTimeout(e)}Ht.prototype={constructor:Ht,_isOutsideThisEl:function(e){this.el.contains(e)||e===this.el||(yt=null)},_getDirection:function(e,t){return"function"==typeof this.options.direction?this.options.direction.call(this,e,t,Je):this.options.direction},_onTapStart:function(e){if(e.cancelable){var t=this,n=this.el,r=this.options,o=r.preventOnFilter,i=e.type,a=e.touches&&e.touches[0]||e.pointerType&&"touch"===e.pointerType&&e,s=(a||e).target,l=e.target.shadowRoot&&(e.path&&e.path[0]||e.composedPath&&e.composedPath()[0])||s,c=r.filter;if(function(e){It.length=0;var t=e.getElementsByTagName("input"),n=t.length;for(;n--;){var r=t[n];r.checked&&It.push(r)}}(n),!Je&&!(/mousedown|pointerdown/.test(i)&&0!==e.button||r.disabled)&&!l.isContentEditable&&(this.nativeDraggable||!fe||!s||"SELECT"!==s.tagName.toUpperCase())&&!((s=xe(s,r.draggable,n,!1))&&s.animated||nt===s)){if(it=Fe(s),st=Fe(s,r.draggable),"function"==typeof c){if(c.call(this,e,s,this))return ze({sortable:t,rootEl:l,name:"filter",targetEl:s,toEl:n,fromEl:n}),Ke("filter",t,{evt:e}),void(o&&e.preventDefault())}else if(c&&(c=c.split(",").some(function(r){if(r=xe(l,r.trim(),n,!1))return ze({sortable:t,rootEl:r,name:"filter",targetEl:s,fromEl:n,toEl:n}),Ke("filter",t,{evt:e}),!0})))return void(o&&e.preventDefault());r.handle&&!xe(l,r.handle,n,!1)||this._prepareDragStart(e,a,s)}}},_prepareDragStart:function(e,t,n){var r,o=this,i=o.el,a=o.options,s=i.ownerDocument;if(n&&!Je&&n.parentNode===i){var l=Te(n);if(et=i,Ze=(Je=n).parentNode,tt=Je.nextSibling,nt=n,ct=a.group,Ht.dragged=Je,pt={target:Je,clientX:(t||e).clientX,clientY:(t||e).clientY},mt=pt.clientX-l.left,gt=pt.clientY-l.top,this._lastX=(t||e).clientX,this._lastY=(t||e).clientY,Je.style["will-change"]="all",r=function(){Ke("delayEnded",o,{evt:e}),Ht.eventCanceled?o._onDrop():(o._disableDelayedDragEvents(),!he&&o.nativeDraggable&&(Je.draggable=!0),o._triggerDragStart(e,t),ze({sortable:o,name:"choose",originalEvent:e}),ke(Je,a.chosenClass,!0))},a.ignore.split(",").forEach(function(e){Oe(Je,e.trim(),Ut)}),ye(s,"dragover",Rt),ye(s,"mousemove",Rt),ye(s,"touchmove",Rt),a.supportPointer?(ye(s,"pointerup",o._onDrop),!this.nativeDraggable&&ye(s,"pointercancel",o._onDrop)):(ye(s,"mouseup",o._onDrop),ye(s,"touchend",o._onDrop),ye(s,"touchcancel",o._onDrop)),he&&this.nativeDraggable&&(this.options.touchStartThreshold=4,Je.draggable=!0),Ke("delayStart",this,{evt:e}),!a.delay||a.delayOnTouchOnly&&!t||this.nativeDraggable&&(de||pe))r();else{if(Ht.eventCanceled)return void this._onDrop();a.supportPointer?(ye(s,"pointerup",o._disableDelayedDrag),ye(s,"pointercancel",o._disableDelayedDrag)):(ye(s,"mouseup",o._disableDelayedDrag),ye(s,"touchend",o._disableDelayedDrag),ye(s,"touchcancel",o._disableDelayedDrag)),ye(s,"mousemove",o._delayedDragTouchMoveHandler),ye(s,"touchmove",o._delayedDragTouchMoveHandler),a.supportPointer&&ye(s,"pointermove",o._delayedDragTouchMoveHandler),o._dragStartTimer=setTimeout(r,a.delay)}}},_delayedDragTouchMoveHandler:function(e){var t=e.touches?e.touches[0]:e;Math.max(Math.abs(t.clientX-this._lastX),Math.abs(t.clientY-this._lastY))>=Math.floor(this.options.touchStartThreshold/(this.nativeDraggable&&window.devicePixelRatio||1))&&this._disableDelayedDrag()},_disableDelayedDrag:function(){Je&&Ut(Je),clearTimeout(this._dragStartTimer),this._disableDelayedDragEvents()},_disableDelayedDragEvents:function(){var e=this.el.ownerDocument;be(e,"mouseup",this._disableDelayedDrag),be(e,"touchend",this._disableDelayedDrag),be(e,"touchcancel",this._disableDelayedDrag),be(e,"pointerup",this._disableDelayedDrag),be(e,"pointercancel",this._disableDelayedDrag),be(e,"mousemove",this._delayedDragTouchMoveHandler),be(e,"touchmove",this._delayedDragTouchMoveHandler),be(e,"pointermove",this._delayedDragTouchMoveHandler)},_triggerDragStart:function(e,t){t=t||"touch"==e.pointerType&&e,!this.nativeDraggable||t?this.options.supportPointer?ye(document,"pointermove",this._onTouchMove):ye(document,t?"touchmove":"mousemove",this._onTouchMove):(ye(Je,"dragend",this),ye(et,"dragstart",this._onDragStart));try{document.selection?Wt(function(){document.selection.empty()}):window.getSelection().removeAllRanges()}catch(e){}},_dragStarted:function(e,t){if(xt=!1,et&&Je){Ke("dragStarted",this,{evt:t}),this.nativeDraggable&&ye(document,"dragover",$t);var n=this.options;!e&&ke(Je,n.dragClass,!1),ke(Je,n.ghostClass,!0),Ht.active=this,e&&this._appendGhost(),ze({sortable:this,name:"start",originalEvent:t})}else this._nulling()},_emulateDragOver:function(){if(dt){this._lastX=dt.clientX,this._lastY=dt.clientY,jt();for(var e=document.elementFromPoint(dt.clientX,dt.clientY),t=e;e&&e.shadowRoot&&(e=e.shadowRoot.elementFromPoint(dt.clientX,dt.clientY))!==t;)t=e;if(Je.parentNode[qe]._isOutsideThisEl(e),t)do{if(t[qe]){if(t[qe]._onDragOver({clientX:dt.clientX,clientY:dt.clientY,target:e,rootEl:t})&&!this.options.dragoverBubble)break}e=t}while(t=we(t));Bt()}},_onTouchMove:function(e){if(pt){var t=this.options,n=t.fallbackTolerance,r=t.fallbackOffset,o=e.touches?e.touches[0]:e,i=Qe&&Pe(Qe,!0),a=Qe&&i&&i.a,s=Qe&&i&&i.d,l=At&&wt&&Me(wt),c=(o.clientX-pt.clientX+r.x)/(a||1)+(l?l[0]-Pt[0]:0)/(a||1),u=(o.clientY-pt.clientY+r.y)/(s||1)+(l?l[1]-Pt[1]:0)/(s||1);if(!Ht.active&&!xt){if(n&&Math.max(Math.abs(o.clientX-this._lastX),Math.abs(o.clientY-this._lastY))<n)return;this._onDragStart(e,!0)}if(Qe){i?(i.e+=c-(ht||0),i.f+=u-(ft||0)):i={a:1,b:0,c:0,d:1,e:c,f:u};var p="matrix(".concat(i.a,",").concat(i.b,",").concat(i.c,",").concat(i.d,",").concat(i.e,",").concat(i.f,")");Ee(Qe,"webkitTransform",p),Ee(Qe,"mozTransform",p),Ee(Qe,"msTransform",p),Ee(Qe,"transform",p),ht=c,ft=u,dt=o}e.cancelable&&e.preventDefault()}},_appendGhost:function(){if(!Qe){var e=this.options.fallbackOnBody?document.body:et,t=Te(Je,!0,At,!0,e),n=this.options;if(At){for(wt=e;"static"===Ee(wt,"position")&&"none"===Ee(wt,"transform")&&wt!==document;)wt=wt.parentNode;wt!==document.body&&wt!==document.documentElement?(wt===document&&(wt=Ie()),t.top+=wt.scrollTop,t.left+=wt.scrollLeft):wt=Ie(),Pt=Me(wt)}ke(Qe=Je.cloneNode(!0),n.ghostClass,!1),ke(Qe,n.fallbackClass,!0),ke(Qe,n.dragClass,!0),Ee(Qe,"transition",""),Ee(Qe,"transform",""),Ee(Qe,"box-sizing","border-box"),Ee(Qe,"margin",0),Ee(Qe,"top",t.top),Ee(Qe,"left",t.left),Ee(Qe,"width",t.width),Ee(Qe,"height",t.height),Ee(Qe,"opacity","0.8"),Ee(Qe,"position",At?"absolute":"fixed"),Ee(Qe,"zIndex","100000"),Ee(Qe,"pointerEvents","none"),Ht.ghost=Qe,e.appendChild(Qe),Ee(Qe,"transform-origin",mt/parseInt(Qe.style.width)*100+"% "+gt/parseInt(Qe.style.height)*100+"%")}},_onDragStart:function(e,t){var n=this,r=e.dataTransfer,o=n.options;Ke("dragStart",this,{evt:e}),Ht.eventCanceled?this._onDrop():(Ke("setupClone",this),Ht.eventCanceled||((rt=$e(Je)).removeAttribute("id"),rt.draggable=!1,rt.style["will-change"]="",this._hideClone(),ke(rt,this.options.chosenClass,!1),Ht.clone=rt),n.cloneId=Wt(function(){Ke("clone",n),Ht.eventCanceled||(n.options.removeCloneOnHide||et.insertBefore(rt,Je),n._hideClone(),ze({sortable:n,name:"clone"}))}),!t&&ke(Je,o.dragClass,!0),t?(Ct=!0,n._loopId=setInterval(n._emulateDragOver,50)):(be(document,"mouseup",n._onDrop),be(document,"touchend",n._onDrop),be(document,"touchcancel",n._onDrop),r&&(r.effectAllowed="move",o.setData&&o.setData.call(n,r,Je)),ye(document,"drop",n),Ee(Je,"transform","translateZ(0)")),xt=!0,n._dragStartId=Wt(n._dragStarted.bind(n,t,e)),ye(document,"selectstart",n),vt=!0,window.getSelection().removeAllRanges(),fe&&Ee(document.body,"user-select","none"))},_onDragOver:function(e){var t,n,r,o,i=this.el,a=e.target,s=this.options,l=s.group,c=Ht.active,u=ct===l,p=s.sort,d=ut||c,h=this,f=!1;if(!Ot){if(void 0!==e.preventDefault&&e.cancelable&&e.preventDefault(),a=xe(a,s.draggable,i,!0),I("dragOver"),Ht.eventCanceled)return f;if(Je.contains(e.target)||a.animated&&a.animatingX&&a.animatingY||h._ignoreWhileAnimating===a)return A(!1);if(Ct=!1,c&&!s.disabled&&(u?p||(r=Ze!==et):ut===this||(this.lastPutMode=ct.checkPull(this,c,Je,e))&&l.checkPut(this,c,Je,e))){if(o="vertical"===this._getDirection(e,a),t=Te(Je),I("dragOverValid"),Ht.eventCanceled)return f;if(r)return Ze=et,T(),this._hideClone(),I("revert"),Ht.eventCanceled||(tt?et.insertBefore(Je,tt):et.appendChild(Je)),A(!0);var m=Ne(i,s.draggable);if(!m||function(e,t,n){var r=Te(Ne(n.el,n.options.draggable)),o=He(n.el,n.options,Qe),i=10;return t?e.clientX>o.right+i||e.clientY>r.bottom&&e.clientX>r.left:e.clientY>o.bottom+i||e.clientX>r.right&&e.clientY>r.top}(e,o,this)&&!m.animated){if(m===Je)return A(!1);if(m&&i===e.target&&(a=m),a&&(n=Te(a)),!1!==qt(et,i,Je,t,a,n,e,!!a))return T(),m&&m.nextSibling?i.insertBefore(Je,m.nextSibling):i.appendChild(Je),Ze=i,D(),A(!0)}else if(m&&function(e,t,n){var r=Te(De(n.el,0,n.options,!0)),o=He(n.el,n.options,Qe),i=10;return t?e.clientX<o.left-i||e.clientY<r.top&&e.clientX<r.right:e.clientY<o.top-i||e.clientY<r.bottom&&e.clientX<r.left}(e,o,this)){var g=De(i,0,s,!0);if(g===Je)return A(!1);if(n=Te(a=g),!1!==qt(et,i,Je,t,a,n,e,!1))return T(),i.insertBefore(Je,g),Ze=i,D(),A(!0)}else if(a.parentNode===i){n=Te(a);var v,y,b,S=Je.parentNode!==i,w=!function(e,t,n){var r=n?e.left:e.top,o=n?e.right:e.bottom,i=n?e.width:e.height,a=n?t.left:t.top,s=n?t.right:t.bottom,l=n?t.width:t.height;return r===a||o===s||r+i/2===a+l/2}(Je.animated&&Je.toRect||t,a.animated&&a.toRect||n,o),x=o?"top":"left",C=Ae(a,"top","top")||Ae(Je,"top","top"),_=C?C.scrollTop:void 0;if(yt!==a&&(y=n[x],kt=!1,Et=!w&&s.invertSwap||S),v=function(e,t,n,r,o,i,a,s){var l=r?e.clientY:e.clientX,c=r?n.height:n.width,u=r?n.top:n.left,p=r?n.bottom:n.right,d=!1;if(!a)if(s&&St<c*o){if(!kt&&(1===bt?l>u+c*i/2:l<p-c*i/2)&&(kt=!0),kt)d=!0;else if(1===bt?l<u+St:l>p-St)return-bt}else if(l>u+c*(1-o)/2&&l<p-c*(1-o)/2)return function(e){return Fe(Je)<Fe(e)?1:-1}(t);if((d=d||a)&&(l<u+c*i/2||l>p-c*i/2))return l>u+c/2?1:-1;return 0}(e,a,n,o,w?1:s.swapThreshold,null==s.invertedSwapThreshold?s.swapThreshold:s.invertedSwapThreshold,Et,yt===a),0!==v){var k=Fe(Je);do{k-=v,b=Ze.children[k]}while(b&&("none"===Ee(b,"display")||b===Qe))}if(0===v||b===a)return A(!1);yt=a,bt=v;var E=a.nextElementSibling,P=!1,O=qt(et,i,Je,t,a,n,e,P=1===v);if(!1!==O)return 1!==O&&-1!==O||(P=1===O),Ot=!0,setTimeout(Yt,30),T(),P&&!E?i.appendChild(Je):a.parentNode.insertBefore(Je,P?E:a),C&&Re(C,0,_-C.scrollTop),Ze=Je.parentNode,void 0===y||Et||(St=Math.abs(y-Te(a)[x])),D(),A(!0)}if(i.contains(Je))return A(!1)}return!1}function I(s,l){Ke(s,h,ie({evt:e,isOwner:u,axis:o?"vertical":"horizontal",revert:r,dragRect:t,targetRect:n,canSort:p,fromSortable:d,target:a,completed:A,onMove:function(n,r){return qt(et,i,Je,t,n,Te(n),e,r)},changed:D},l))}function T(){I("dragOverAnimationCapture"),h.captureAnimationState(),h!==d&&d.captureAnimationState()}function A(t){return I("dragOverCompleted",{insertion:t}),t&&(u?c._hideClone():c._showClone(h),h!==d&&(ke(Je,ut?ut.options.ghostClass:c.options.ghostClass,!1),ke(Je,s.ghostClass,!0)),ut!==h&&h!==Ht.active?ut=h:h===Ht.active&&ut&&(ut=null),d===h&&(h._ignoreWhileAnimating=a),h.animateAll(function(){I("dragOverAnimationComplete"),h._ignoreWhileAnimating=null}),h!==d&&(d.animateAll(),d._ignoreWhileAnimating=null)),(a===Je&&!Je.animated||a===i&&!a.animated)&&(yt=null),s.dragoverBubble||e.rootEl||a===document||(Je.parentNode[qe]._isOutsideThisEl(e.target),!t&&Rt(e)),!s.dragoverBubble&&e.stopPropagation&&e.stopPropagation(),f=!0}function D(){at=Fe(Je),lt=Fe(Je,s.draggable),ze({sortable:h,name:"change",toEl:i,newIndex:at,newDraggableIndex:lt,originalEvent:e})}},_ignoreWhileAnimating:null,_offMoveEvents:function(){be(document,"mousemove",this._onTouchMove),be(document,"touchmove",this._onTouchMove),be(document,"pointermove",this._onTouchMove),be(document,"dragover",Rt),be(document,"mousemove",Rt),be(document,"touchmove",Rt)},_offUpEvents:function(){var e=this.el.ownerDocument;be(e,"mouseup",this._onDrop),be(e,"touchend",this._onDrop),be(e,"pointerup",this._onDrop),be(e,"pointercancel",this._onDrop),be(e,"touchcancel",this._onDrop),be(document,"selectstart",this)},_onDrop:function(e){var t=this.el,n=this.options;at=Fe(Je),lt=Fe(Je,n.draggable),Ke("drop",this,{evt:e}),Ze=Je&&Je.parentNode,at=Fe(Je),lt=Fe(Je,n.draggable),Ht.eventCanceled||(xt=!1,Et=!1,kt=!1,clearInterval(this._loopId),clearTimeout(this._dragStartTimer),Gt(this.cloneId),Gt(this._dragStartId),this.nativeDraggable&&(be(document,"drop",this),be(t,"dragstart",this._onDragStart)),this._offMoveEvents(),this._offUpEvents(),fe&&Ee(document.body,"user-select",""),Ee(Je,"transform",""),e&&(vt&&(e.cancelable&&e.preventDefault(),!n.dropBubble&&e.stopPropagation()),Qe&&Qe.parentNode&&Qe.parentNode.removeChild(Qe),(et===Ze||ut&&"clone"!==ut.lastPutMode)&&rt&&rt.parentNode&&rt.parentNode.removeChild(rt),Je&&(this.nativeDraggable&&be(Je,"dragend",this),Ut(Je),Je.style["will-change"]="",vt&&!xt&&ke(Je,ut?ut.options.ghostClass:this.options.ghostClass,!1),ke(Je,this.options.chosenClass,!1),ze({sortable:this,name:"unchoose",toEl:Ze,newIndex:null,newDraggableIndex:null,originalEvent:e}),et!==Ze?(at>=0&&(ze({rootEl:Ze,name:"add",toEl:Ze,fromEl:et,originalEvent:e}),ze({sortable:this,name:"remove",toEl:Ze,originalEvent:e}),ze({rootEl:Ze,name:"sort",toEl:Ze,fromEl:et,originalEvent:e}),ze({sortable:this,name:"sort",toEl:Ze,originalEvent:e})),ut&&ut.save()):at!==it&&at>=0&&(ze({sortable:this,name:"update",toEl:Ze,originalEvent:e}),ze({sortable:this,name:"sort",toEl:Ze,originalEvent:e})),Ht.active&&(null!=at&&-1!==at||(at=it,lt=st),ze({sortable:this,name:"end",toEl:Ze,originalEvent:e}),this.save())))),this._nulling()},_nulling:function(){Ke("nulling",this),et=Je=Ze=Qe=tt=rt=nt=ot=pt=dt=vt=at=lt=it=st=yt=bt=ut=ct=Ht.dragged=Ht.ghost=Ht.clone=Ht.active=null,It.forEach(function(e){e.checked=!0}),It.length=ht=ft=0},handleEvent:function(e){switch(e.type){case"drop":case"dragend":this._onDrop(e);break;case"dragenter":case"dragover":Je&&(this._onDragOver(e),function(e){e.dataTransfer&&(e.dataTransfer.dropEffect="move");e.cancelable&&e.preventDefault()}(e));break;case"selectstart":e.preventDefault()}},toArray:function(){for(var e,t=[],n=this.el.children,r=0,o=n.length,i=this.options;r<o;r++)xe(e=n[r],i.draggable,this.el,!1)&&t.push(e.getAttribute(i.dataIdAttr)||Vt(e));return t},sort:function(e,t){var n={},r=this.el;this.toArray().forEach(function(e,t){var o=r.children[t];xe(o,this.options.draggable,r,!1)&&(n[e]=o)},this),t&&this.captureAnimationState(),e.forEach(function(e){n[e]&&(r.removeChild(n[e]),r.appendChild(n[e]))}),t&&this.animateAll()},save:function(){var e=this.options.store;e&&e.set&&e.set(this)},closest:function(e,t){return xe(e,t||this.options.draggable,this.el,!1)},option:function(e,t){var n=this.options;if(void 0===t)return n[e];var r=We.modifyOption(this,e,t);n[e]=void 0!==r?r:t,"group"===e&&Lt(n)},destroy:function(){Ke("destroy",this);var e=this.el;e[qe]=null,be(e,"mousedown",this._onTapStart),be(e,"touchstart",this._onTapStart),be(e,"pointerdown",this._onTapStart),this.nativeDraggable&&(be(e,"dragover",this),be(e,"dragenter",this)),Array.prototype.forEach.call(e.querySelectorAll("[draggable]"),function(e){e.removeAttribute("draggable")}),this._onDrop(),this._disableDelayedDragEvents(),_t.splice(_t.indexOf(this.el),1),this.el=e=null},_hideClone:function(){if(!ot){if(Ke("hideClone",this),Ht.eventCanceled)return;Ee(rt,"display","none"),this.options.removeCloneOnHide&&rt.parentNode&&rt.parentNode.removeChild(rt),ot=!0}},_showClone:function(e){if("clone"===e.lastPutMode){if(ot){if(Ke("showClone",this),Ht.eventCanceled)return;Je.parentNode!=et||this.options.group.revertClone?tt?et.insertBefore(rt,tt):et.appendChild(rt):et.insertBefore(rt,Je),this.options.group.revertClone&&this.animate(Je,rt),Ee(rt,"display",""),ot=!1}}else this._hideClone()}},Tt&&ye(document,"touchmove",function(e){(Ht.active||xt)&&e.cancelable&&e.preventDefault()}),Ht.utils={on:ye,off:be,css:Ee,find:Oe,is:function(e,t){return!!xe(e,t,e,!1)},extend:function(e,t){if(e&&t)for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},throttle:Be,closest:xe,toggleClass:ke,clone:$e,index:Fe,nextTick:Wt,cancelNextTick:Gt,detectDirection:Mt,getChild:De,expando:qe},Ht.get=function(e){return e[qe]},Ht.mount=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];t[0].constructor===Array&&(t=t[0]),t.forEach(function(e){if(!e.prototype||!e.prototype.constructor)throw"Sortable: Mounted plugin must be a constructor function, not ".concat({}.toString.call(e));e.utils&&(Ht.utils=ie(ie({},Ht.utils),e.utils)),We.mount(e)})},Ht.create=function(e,t){return new Ht(e,t)},Ht.version="1.15.6";var Xt,Kt,zt,Jt,Zt,Qt,en=[],tn=!1;function nn(){en.forEach(function(e){clearInterval(e.pid)}),en=[]}function rn(){clearInterval(Qt)}var on=Be(function(e,t,n,r){if(t.scroll){var o,i=(e.touches?e.touches[0]:e).clientX,a=(e.touches?e.touches[0]:e).clientY,s=t.scrollSensitivity,l=t.scrollSpeed,c=Ie(),u=!1;Kt!==n&&(Kt=n,nn(),Xt=t.scroll,o=t.scrollFn,!0===Xt&&(Xt=Le(n,!0)));var p=0,d=Xt;do{var h=d,f=Te(h),m=f.top,g=f.bottom,v=f.left,y=f.right,b=f.width,S=f.height,w=void 0,x=void 0,C=h.scrollWidth,_=h.scrollHeight,k=Ee(h),E=h.scrollLeft,P=h.scrollTop;h===c?(w=b<C&&("auto"===k.overflowX||"scroll"===k.overflowX||"visible"===k.overflowX),x=S<_&&("auto"===k.overflowY||"scroll"===k.overflowY||"visible"===k.overflowY)):(w=b<C&&("auto"===k.overflowX||"scroll"===k.overflowX),x=S<_&&("auto"===k.overflowY||"scroll"===k.overflowY));var O=w&&(Math.abs(y-i)<=s&&E+b<C)-(Math.abs(v-i)<=s&&!!E),I=x&&(Math.abs(g-a)<=s&&P+S<_)-(Math.abs(m-a)<=s&&!!P);if(!en[p])for(var T=0;T<=p;T++)en[T]||(en[T]={});en[p].vx==O&&en[p].vy==I&&en[p].el===h||(en[p].el=h,en[p].vx=O,en[p].vy=I,clearInterval(en[p].pid),0==O&&0==I||(u=!0,en[p].pid=setInterval(function(){r&&0===this.layer&&Ht.active._onTouchMove(Zt);var t=en[this.layer].vy?en[this.layer].vy*l:0,n=en[this.layer].vx?en[this.layer].vx*l:0;"function"==typeof o&&"continue"!==o.call(Ht.dragged.parentNode[qe],n,t,e,Zt,en[this.layer].el)||Re(en[this.layer].el,n,t)}.bind({layer:p}),24))),p++}while(t.bubbleScroll&&d!==c&&(d=Le(d,!1)));tn=u}},30),an=function(e){var t=e.originalEvent,n=e.putSortable,r=e.dragEl,o=e.activeSortable,i=e.dispatchSortableEvent,a=e.hideGhostForTarget,s=e.unhideGhostForTarget;if(t){var l=n||o;a();var c=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:t,u=document.elementFromPoint(c.clientX,c.clientY);s(),l&&!l.el.contains(u)&&(i("spill"),this.onSpill({dragEl:r,putSortable:n}))}};function sn(){}function ln(){}sn.prototype={startIndex:null,dragStart:function(e){var t=e.oldDraggableIndex;this.startIndex=t},onSpill:function(e){var t=e.dragEl,n=e.putSortable;this.sortable.captureAnimationState(),n&&n.captureAnimationState();var r=De(this.sortable.el,this.startIndex,this.options);r?this.sortable.el.insertBefore(t,r):this.sortable.el.appendChild(t),this.sortable.animateAll(),n&&n.animateAll()},drop:an},le(sn,{pluginName:"revertOnSpill"}),ln.prototype={onSpill:function(e){var t=e.dragEl,n=e.putSortable||this.sortable;n.captureAnimationState(),t.parentNode&&t.parentNode.removeChild(t),n.animateAll()},drop:an},le(ln,{pluginName:"removeOnSpill"});Ht.mount(new function(){function e(){for(var e in this.defaults={scroll:!0,forceAutoScrollFallback:!1,scrollSensitivity:30,scrollSpeed:10,bubbleScroll:!0},this)"_"===e.charAt(0)&&"function"==typeof this[e]&&(this[e]=this[e].bind(this))}return e.prototype={dragStarted:function(e){var t=e.originalEvent;this.sortable.nativeDraggable?ye(document,"dragover",this._handleAutoScroll):this.options.supportPointer?ye(document,"pointermove",this._handleFallbackAutoScroll):t.touches?ye(document,"touchmove",this._handleFallbackAutoScroll):ye(document,"mousemove",this._handleFallbackAutoScroll)},dragOverCompleted:function(e){var t=e.originalEvent;this.options.dragOverBubble||t.rootEl||this._handleAutoScroll(t)},drop:function(){this.sortable.nativeDraggable?be(document,"dragover",this._handleAutoScroll):(be(document,"pointermove",this._handleFallbackAutoScroll),be(document,"touchmove",this._handleFallbackAutoScroll),be(document,"mousemove",this._handleFallbackAutoScroll)),rn(),nn(),clearTimeout(Ce),Ce=void 0},nulling:function(){Zt=Kt=Xt=tn=Qt=zt=Jt=null,en.length=0},_handleFallbackAutoScroll:function(e){this._handleAutoScroll(e,!0)},_handleAutoScroll:function(e,t){var n=this,r=(e.touches?e.touches[0]:e).clientX,o=(e.touches?e.touches[0]:e).clientY,i=document.elementFromPoint(r,o);if(Zt=e,t||this.options.forceAutoScrollFallback||de||pe||fe){on(e,this.options,i,t);var a=Le(i,!0);!tn||Qt&&r===zt&&o===Jt||(Qt&&rn(),Qt=setInterval(function(){var i=Le(document.elementFromPoint(r,o),!0);i!==a&&(a=i,nn()),on(e,n.options,i,t)},10),zt=r,Jt=o)}else{if(!this.options.bubbleScroll||Le(i,!0)===Ie())return void nn();on(e,this.options,Le(i,!1),!1)}}},le(e,{pluginName:"scroll",initializeByDefault:!0})}),Ht.mount(ln,sn);const cn=Ht;function un(e,t={}){const n="string"==typeof e?document.querySelector(e):e;if(!n)throw new Error(`Could not find container: ${e}`);const r=t.showToggleButton??!1,o=t.showDeleteButton??!1,i=t.showSelectInput??!1;let a=[...t.initialList||[]],s=null;n.innerHTML="",n.classList.add("sortable-list-container");const l=document.createElement("ul");l.className="sortable-list",Object.assign(l.style,{listStyle:"none",padding:"0",margin:"0"}),n.appendChild(l);const c=e=>l.querySelector(`li[data-id="${e}"]`),u=e=>{const n=document.createElement("li");n.className="sortable-list-item",n.dataset.id=e.id,Object.assign(n.style,{display:"flex",alignItems:"center",padding:"8px 12px",border:"1px solid var(--SmartThemeBorderColor, #ccc)",color:"var(--SmartThemeBodyColor, #333)",marginBottom:"2px"});const a=document.createElement("span");a.className="drag-handle",a.innerHTML='<i class="fas fa-bars"></i>',Object.assign(a.style,{cursor:"grab",marginRight:"10px",color:"var(--SmartThemeBodyColor, #555)",flexShrink:"0"}),n.appendChild(a);const s=document.createElement("span");s.className="item-label",s.style.flexGrow="1",s.style.marginRight="10px",s.style.overflow="hidden",s.style.textOverflow="ellipsis",s.style.whiteSpace="nowrap",t.renderLabel?t.renderLabel(s,e):s.textContent=e.label,n.appendChild(s);const l="10px",c=e.showSelect??!0,u=e.canSelect??!0;let p=null;if(i&&c)if(u){if(p=document.createElement("select"),p.className="select-input text_pole",p.style.marginRight=l,p.style.flexShrink="0",p.style.width="unset",e.selectOptions&&e.selectOptions.length>0)e.selectOptions.forEach(t=>{const n=document.createElement("option");n.value=t.value,n.textContent=t.label,t.value===e.selectValue&&(n.selected=!0),p.appendChild(n)});else{const e=document.createElement("option");e.textContent="--",e.disabled=!0,e.selected=!0,p.appendChild(e),p.disabled=!0}p.addEventListener("change",t=>{t.stopPropagation(),m(e.id,t)}),n.appendChild(p)}else{const e=document.createElement("span");e.style.marginRight=l,e.style.display="inline-block",e.style.flexShrink="0",n.appendChild(e)}else if(i&&!c){const e=document.createElement("span");e.style.marginRight=l,e.style.display="inline-block",e.style.flexShrink="0",n.appendChild(e)}const d=e.canToggle??!0;if(r&&d){const t=document.createElement("span");t.className="toggle-button",t.innerHTML=`<i class="fas ${e.enabled?"fa-toggle-on":"fa-toggle-off"}"></i>`,Object.assign(t.style,{cursor:"pointer",marginRight:l,fontSize:"1.2em",color:e.enabled?"var(--success-color, #4CAF50)":"var(--SmartThemeBodyColor, #555)",flexShrink:"0"}),t.addEventListener("click",t=>{t.stopPropagation(),h(e.id)}),n.appendChild(t)}else if(r&&!d){const e=document.createElement("span");e.style.marginRight=l,e.style.display="inline-block",e.style.flexShrink="0",n.appendChild(e)}const g=e.canDelete??!0;if(o&&g){const t=document.createElement("span");t.className="delete-button",t.innerHTML='<i class="fas fa-trash-can"></i>',Object.assign(t.style,{cursor:"pointer",color:"var(--error-color, #f44336)",flexShrink:"0"}),t.addEventListener("click",t=>{t.stopPropagation(),f(e.id)}),n.appendChild(t)}else if(o&&!g){const e=document.createElement("span");e.style.display="inline-block",e.style.flexShrink="0",n.appendChild(e)}return r&&(n.style.opacity=e.enabled?"1":"0.6"),n},p=()=>{l.innerHTML="",a.forEach(e=>{const t=u(e);l.appendChild(t)})},d=(e,n={})=>{const o=(e=>a.find(t=>t.id===e))(e),s=c(e);if(!o||!s)return;if("label"in n&&t.renderLabel||"selectOptions"in n||"showSelect"in n||"canSelect"in n||"canToggle"in n||"canDelete"in n){const e=u(o);return void s.replaceWith(e)}if("label"in n&&!t.renderLabel){const e=s.querySelector(".item-label");e&&(e.textContent=o.label)}if("selectValue"in n&&i){const e=s.querySelector(".select-input");e&&(e.value=o.selectValue??"")}if("enabled"in n&&r&&(o.canToggle??1)){const e=s.querySelector(".toggle-button i"),t=s.querySelector(".toggle-button");e&&(e.className="fas "+(o.enabled?"fa-toggle-on":"fa-toggle-off")),t&&(t.style.color=o.enabled?"var(--success-color, #4CAF50)":"var(--SmartThemeBodyColor, #555)")}if("enabled"in n&&r){s.style.opacity=o.enabled?"1":"0.6";const e=s.querySelector(".select-input");e&&(e.disabled=!o.enabled||!(o.canSelect??1))}},h=async e=>{const n=a.findIndex(t=>t.id===e);if(-1===n||!(a[n].canToggle??1))return;const r=a[n],o=!r.enabled;if(t.onToggle)try{await Promise.resolve(t.onToggle(e,o))}catch(e){return void console.error("onToggle callback failed:",e)}const i={enabled:o};a[n]={...r,...i},d(e,i)},f=async e=>{const n=a.findIndex(t=>t.id===e);if(-1===n||!(a[n].canDelete??1))return;let r=!0;if(t.onDelete)try{r=await Promise.resolve(t.onDelete(e))}catch(e){console.error("onDelete callback failed:",e),r=!1}r&&(a.splice(n,1),c(e)?.remove())},m=async(e,n)=>{const r=a.findIndex(t=>t.id===e);if(-1===r||!(a[r].canSelect??1))return;const o=a[r],i=n.target,s=i.value;if(t.onSelectChange)try{await Promise.resolve(t.onSelectChange(e,s))}catch(e){return console.error("onSelectChange callback failed:",e),void(i.value=o.selectValue??"")}const l={selectValue:s};a[r]={...o,...l}},g=()=>{s&&s.destroy();const e={handle:".drag-handle",animation:150,ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",filter:".select-input, .toggle-button, .delete-button",preventOnFilter:!1,onEnd:e=>{const{oldIndex:n,newIndex:r}=e;if(void 0===n||void 0===r||n===r)return;const o=Array.from(l.children).map(e=>e.dataset.id).filter(e=>void 0!==e);a.sort((e,t)=>o.indexOf(e.id)-o.indexOf(t.id));const i=a.map(e=>e.id);t.onOrderChange&&Promise.resolve(t.onOrderChange(i)).catch(e=>console.error("onOrderChange callback failed:",e))},...t.sortableJsOptions||{}};s=cn.create(l,e)};p(),g();const v={getList:()=>[...a],getOrder:()=>a.map(e=>e.id),addItem:(e,t)=>{if(a.some(t=>t.id===e.id))return void console.warn(`SortableList: Item with ID "${e.id}" already exists. Skipping add.`);const n=void 0===t||t<0||t>a.length?a.length:t;a.splice(n,0,e);const r=u(e),o=l.children[n];l.insertBefore(r,o??null)},removeItem:e=>{const t=a.findIndex(t=>t.id===e);t>-1&&(a.splice(t,1),c(e)?.remove())},updateItem:(e,t)=>{const n=a.findIndex(t=>t.id===e);if(n>-1){const r=a[n];"id"in t&&(console.warn("SortableList: Cannot change item ID via updateItem."),delete t.id),a[n]={...r,...t},d(e,t)}},setList:e=>{a=[...e],p(),g()},destroy:()=>{s&&(s.destroy(),s=null),n.innerHTML="",n.classList.remove("sortable-list-container"),a=[]},getSortableInstance:()=>s};return v}async function pn({entry:e,selectedWorldName:t,skipSave:n=!1,skipReload:r=!1,operation:o="auto"}){const i=SillyTavern.getContext(),a=await i.loadWorldInfo(t);if(!a)throw new Error("Failed to load world info");const s=Object.values(a.entries),l=s.length>0?s[s.length-1]:void 0;let c;if("update"===o||"auto"===o){const t=Object.values(a.entries).find(t=>t.uid===e.uid);if(t)("auto"===o||"update"===o)&&(c=t);else if("update"===o)throw new Error("Entry not found for update operation")}const u=c?"update":"add";if(!c){if(c=(0,Q.FB)(t,a),!c)throw new Error("Failed to create entry");if(l){const e=c.uid;Object.assign(c,l),c.uid=e}}return c.key=e.key,c.content=e.content,c.comment=e.comment,n||await i.saveWorldInfo(t,a),r||i.reloadWorldInfoEditor(t,!0),{entry:c,operation:u}}}},N={};function F(e){var t=N[e];if(void 0!==t)return t.exports;var n=N[e]={exports:{}};return D[e](n,n.exports,F),n.exports}F.m=D,F.d=(e,t)=>{for(var n in t)F.o(t,n)&&!F.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},F.f={},F.e=e=>Promise.all(Object.keys(F.f).reduce((t,n)=>(F.f[n](e,t),t),[])),F.u=e=>e+".index.js",F.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),F.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},T={792:0},A=e=>{var t,n,{__webpack_esm_ids__:r,__webpack_esm_modules__:o,__webpack_esm_runtime__:i}=e,a=0;for(t in o)F.o(o,t)&&(F.m[t]=o[t]);for(i&&i(F);a<r.length;a++)n=r[a],F.o(T,n)&&T[n]&&T[n][0](),T[r[a]]=0},F.f.j=(e,t)=>{var n=F.o(T,e)?T[e]:void 0;if(0!==n)if(n)t.push(n[1]);else{var r=import("./"+F.u(e)).then(A,t=>{throw 0!==T[e]&&(T[e]=void 0),t});r=Promise.race([r,new Promise(t=>n=T[e]=[t])]),t.push(n[1]=r)}};var M=F(971),L=F(149),j=F(452),B=F(262),R=F(882);function H(e){return H="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},H(e)}function q(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function i(n,r,o,i){var l=r&&r.prototype instanceof s?r:s,c=Object.create(l.prototype);return U(c,"_invoke",function(n,r,o){var i,s,l,c=0,u=o||[],p=!1,d={p:0,n:0,v:e,a:h,f:h.bind(e,4),d:function(t,n){return i=t,s=0,l=e,d.n=n,a}};function h(n,r){for(s=n,l=r,t=0;!p&&c&&!o&&t<u.length;t++){var o,i=u[t],h=d.p,f=i[2];n>3?(o=f===r)&&(l=i[(s=i[4])?5:(s=3,3)],i[4]=i[5]=e):i[0]<=h&&((o=n<2&&h<i[1])?(s=0,d.v=r,d.n=i[1]):h<f&&(o=n<3||i[0]>r||r>f)&&(i[4]=n,i[5]=r,d.n=f,s=0))}if(o||n>1)return a;throw p=!0,r}return function(o,u,f){if(c>1)throw TypeError("Generator is already running");for(p&&1===u&&h(u,f),s=u,l=f;(t=s<2?e:l)||!p;){i||(s?s<3?(s>1&&(d.n=-1),h(s,l)):d.n=l:d.v=l);try{if(c=2,i){if(s||(o="next"),t=i[o]){if(!(t=t.call(i,l)))throw TypeError("iterator result is not an object");if(!t.done)return t;l=t.value,s<2&&(s=0)}else 1===s&&(t=i.return)&&t.call(i),s<2&&(l=TypeError("The iterator does not provide a '"+o+"' method"),s=1);i=e}else if((t=(p=d.n<0)?l:n.call(r,d))!==a)break}catch(t){i=e,s=1,l=t}finally{c=1}}return{value:t,done:p}}}(n,o,i),!0),c}var a={};function s(){}function l(){}function c(){}t=Object.getPrototypeOf;var u=[][r]?t(t([][r]())):(U(t={},r,function(){return this}),t),p=c.prototype=s.prototype=Object.create(u);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,U(e,o,"GeneratorFunction")),e.prototype=Object.create(p),e}return l.prototype=c,U(p,"constructor",c),U(c,"constructor",l),l.displayName="GeneratorFunction",U(c,o,"GeneratorFunction"),U(p),U(p,o,"Generator"),U(p,r,function(){return this}),U(p,"toString",function(){return"[object Generator]"}),(q=function(){return{w:i,m:d}})()}function U(e,t,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}U=function(e,t,n,r){function i(t,n){U(e,t,function(e){return this._invoke(t,n,e)})}t?o?o(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(i("next",0),i("throw",1),i("return",2))},U(e,t,n,r)}function Y(e,t,n,r,o,i,a){try{var s=e[i](a),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function V(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var i=e.apply(t,n);function a(e){Y(i,r,o,a,s,"next",e)}function s(e){Y(i,r,o,a,s,"throw",e)}a(void 0)})}}function W(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,G(r.key),r)}}function G(e){var t=function(e,t){if("object"!=H(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=H(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==H(t)?t:t+""}var X=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return t=e,n=[{key:"generateImageId",value:function(){return"img_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9))}},{key:"createThumbnail",value:(i=V(q().m(function e(t){var n,r,o,i=arguments;return q().w(function(e){for(;;)if(0===e.n)return n=i.length>1&&void 0!==i[1]?i[1]:200,r=i.length>2&&void 0!==i[2]?i[2]:200,o=i.length>3&&void 0!==i[3]?i[3]:.7,e.a(2,new Promise(function(e,i){var a=new Image;a.onload=function(){var t=document.createElement("canvas"),s=t.getContext("2d");if(s){var l=a.width,c=a.height;l>c?l>n&&(c*=n/l,l=n):c>r&&(l*=r/c,c=r),t.width=l,t.height=c,s.drawImage(a,0,0,l,c);var u=t.toDataURL("image/jpeg",o);e(u)}else i(new Error("Could not get canvas context"))},a.onerror=function(){return i(new Error("Failed to load image for thumbnail creation"))},a.src=t}))},e)})),function(e){return i.apply(this,arguments)})},{key:"createImageContentPart",value:function(e){return{type:"image_url",image_url:{url:e,detail:arguments.length>1&&void 0!==arguments[1]?arguments[1]:"auto"}}}},{key:"createMessageContentParts",value:function(e,t){if(!t)return e;var n=[];return e.trim()&&n.push({type:"text",text:e.trim()}),n.push(this.createImageContentPart(t)),n}},{key:"extractTextFromContentParts",value:function(e){return"string"==typeof e?e:Array.isArray(e)?e.filter(function(e){return"text"===e.type}).map(function(e){return e.text}).join(""):""}},{key:"extractImageFromContentParts",value:function(e){if("string"!=typeof e&&Array.isArray(e)){var t,n=e.find(function(e){return"image_url"===e.type});return null==n||null===(t=n.image_url)||void 0===t?void 0:t.url}}},{key:"processImageFile",value:(o=V(q().m(function e(t){return q().w(function(e){for(;;)switch(e.n){case 0:if(t.type.startsWith("image/")){e.n=1;break}throw new Error("Please select an image file.");case 1:return e.a(2,new Promise(function(e,n){var r=new FileReader;r.onload=function(){e(r.result)},r.onerror=function(){n(new Error("Failed to read image file."))},r.readAsDataURL(t)}))}},e)})),function(e){return o.apply(this,arguments)})},{key:"createImagePreviewHtml",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"inline image";return'<div class="inline-image" style="margin-top:6px;">\n      <img src="'.concat(e,'" alt="').concat(t,'" style="max-width: 200px; max-height: 200px; border:1px solid var(--SmartThemeBorderColor); border-radius:4px;"/>\n    </div>')}}],r=[{key:"getInstance",value:function(){return e.instance||(e.instance=new e),e.instance}}],n&&W(t.prototype,n),r&&W(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,n,r,o,i}(),K=F(742),z=F(639);function J(e){return J="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},J(e)}function Z(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function Q(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Z(Object(n),!0).forEach(function(t){ee(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Z(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function ee(e,t,n){return(t=ae(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function te(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function i(n,r,o,i){var l=r&&r.prototype instanceof s?r:s,c=Object.create(l.prototype);return ne(c,"_invoke",function(n,r,o){var i,s,l,c=0,u=o||[],p=!1,d={p:0,n:0,v:e,a:h,f:h.bind(e,4),d:function(t,n){return i=t,s=0,l=e,d.n=n,a}};function h(n,r){for(s=n,l=r,t=0;!p&&c&&!o&&t<u.length;t++){var o,i=u[t],h=d.p,f=i[2];n>3?(o=f===r)&&(l=i[(s=i[4])?5:(s=3,3)],i[4]=i[5]=e):i[0]<=h&&((o=n<2&&h<i[1])?(s=0,d.v=r,d.n=i[1]):h<f&&(o=n<3||i[0]>r||r>f)&&(i[4]=n,i[5]=r,d.n=f,s=0))}if(o||n>1)return a;throw p=!0,r}return function(o,u,f){if(c>1)throw TypeError("Generator is already running");for(p&&1===u&&h(u,f),s=u,l=f;(t=s<2?e:l)||!p;){i||(s?s<3?(s>1&&(d.n=-1),h(s,l)):d.n=l:d.v=l);try{if(c=2,i){if(s||(o="next"),t=i[o]){if(!(t=t.call(i,l)))throw TypeError("iterator result is not an object");if(!t.done)return t;l=t.value,s<2&&(s=0)}else 1===s&&(t=i.return)&&t.call(i),s<2&&(l=TypeError("The iterator does not provide a '"+o+"' method"),s=1);i=e}else if((t=(p=d.n<0)?l:n.call(r,d))!==a)break}catch(t){i=e,s=1,l=t}finally{c=1}}return{value:t,done:p}}}(n,o,i),!0),c}var a={};function s(){}function l(){}function c(){}t=Object.getPrototypeOf;var u=[][r]?t(t([][r]())):(ne(t={},r,function(){return this}),t),p=c.prototype=s.prototype=Object.create(u);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,ne(e,o,"GeneratorFunction")),e.prototype=Object.create(p),e}return l.prototype=c,ne(p,"constructor",c),ne(c,"constructor",l),l.displayName="GeneratorFunction",ne(c,o,"GeneratorFunction"),ne(p),ne(p,o,"Generator"),ne(p,r,function(){return this}),ne(p,"toString",function(){return"[object Generator]"}),(te=function(){return{w:i,m:d}})()}function ne(e,t,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}ne=function(e,t,n,r){function i(t,n){ne(e,t,function(e){return this._invoke(t,n,e)})}t?o?o(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(i("next",0),i("throw",1),i("return",2))},ne(e,t,n,r)}function re(e,t,n,r,o,i,a){try{var s=e[i](a),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function oe(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var i=e.apply(t,n);function a(e){re(i,r,o,a,s,"next",e)}function s(e){re(i,r,o,a,s,"throw",e)}a(void 0)})}}function ie(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,ae(r.key),r)}}function ae(e){var t=function(e,t){if("object"!=J(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=J(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==J(t)?t:t+""}var se=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.sessionService=R.SessionService.getInstance(),this.imageService=X.getInstance()}return t=e,n=[{key:"generateField",value:(d=oe(te().m(function e(t){var n,r,o,i,a,s,l,c,u,p,d,h,f,m;return te().w(function(e){for(;;)switch(e.n){case 0:if(r=t.targetField,o=t.userPrompt,i=t.continueFrom,a=t.isDraft,s=void 0!==a&&a,l=t.imageUrl,c=K.fq.getSettings(),u=this.sessionService.getSession(),c.profileId){e.n=1;break}throw new Error("Please select a connection profile.");case 1:if(p=null===(n=B.globalContext.extensionSettings.connectionManager)||void 0===n||null===(n=n.profiles)||void 0===n?void 0:n.find(function(e){return e.id===c.profileId})){e.n=2;break}throw new Error("Connection profile not found.");case 2:return d={presetName:null==p?void 0:p.preset,contextName:null==p?void 0:p.context,instructName:null==p?void 0:p.instruct,targetCharacterId:L.oP,ignoreCharacterFields:!0,ignoreWorldInfo:!0,ignoreAuthorNote:!0,maxContext:this.getMaxContext(c),includeNames:!!L.Yb},this.applyMessageRangeOptions(d,c),h=this.getFormatDescription(c),e.n=3,this.loadWorldInfoEntries(u);case 3:return f=e.v,e.n=4,(0,B.runCharacterFieldGeneration)({profileId:c.profileId,userPrompt:o,buildPromptOptions:d,continueFrom:i,session:u,allCharacters:B.globalContext.characters,entriesGroupByWorldName:f,formatDescription:{content:h},includeUserMacro:c.contextToSend.persona,maxResponseToken:c.maxResponseToken,targetField:r,outputFormat:c.outputFormat,additionalContentPartsForCurrentUserMessage:l?[this.imageService.createImageContentPart(l)]:void 0});case 4:return m=e.v,s?this.sessionService.updateDraftField(r,{value:m}):this.sessionService.updateField(r,{value:m}),e.a(2,m)}},e,this)})),function(e){return d.apply(this,arguments)})},{key:"continueField",value:(p=oe(te().m(function e(t){var n;return te().w(function(e){for(;;)switch(e.n){case 0:if(null!==(n=t.continueFrom)&&void 0!==n&&n.trim()){e.n=1;break}throw new Error("No content to continue from");case 1:return e.a(2,this.generateField(t))}},e,this)})),function(e){return p.apply(this,arguments)})},{key:"getFieldComparison",value:function(e){var t=e.currentValue;return{originalHtml:e.characterValue,newHtml:t}}},{key:"loadCharacter",value:(u=oe(te().m(function e(t){var n,r,o,i,a,s,l,c,u,p,d,h,f=this;return te().w(function(e){for(;;)switch(e.n){case 0:if(u=B.globalContext,p=u.characters[parseInt(t)]){e.n=1;break}throw new Error("Selected character not found.");case 1:this.sessionService.getSession(),this.sessionService.updateField("name",{value:null!==(n=p.name)&&void 0!==n?n:""}),this.sessionService.updateField("description",{value:null!==(r=p.description)&&void 0!==r?r:""}),this.sessionService.updateField("personality",{value:null!==(o=p.personality)&&void 0!==o?o:""}),this.sessionService.updateField("scenario",{value:null!==(i=p.scenario)&&void 0!==i?i:""}),this.sessionService.updateField("first_mes",{value:null!==(a=p.first_mes)&&void 0!==a?a:""}),this.sessionService.updateField("mes_example",{value:null!==(s=p.mes_example)&&void 0!==s?s:""}),d=this.sessionService.getSession(),Object.keys(d.fields).filter(function(e){return e.startsWith("alternate_greetings_")}).forEach(function(e){delete d.fields[e]}),h=null!==(l=null===(c=p.data)||void 0===c?void 0:c.alternate_greetings)&&void 0!==l?l:[],Array.isArray(h)&&h.forEach(function(e,t){var n=t+1,r="alternate_greetings_".concat(n);f.sessionService.updateField(r,{value:e,prompt:"",label:"Alternate Greeting ".concat(n)})}),Object.keys(B.CHARACTER_LABELS).forEach(function(e){f.sessionService.updateField(e,{prompt:""})}),this.sessionService.updateSession({lastLoadedCharacterId:p.avatar});case 2:return e.a(2)}},e,this)})),function(e){return u.apply(this,arguments)})},{key:"resetFields",value:(c=oe(te().m(function e(){var t,n=this;return te().w(function(e){for(;;)switch(e.n){case 0:this.sessionService.getSession(),Object.keys(B.CHARACTER_LABELS).forEach(function(e){n.sessionService.updateField(e,{value:"",prompt:""})}),t=this.sessionService.getSession(),Object.keys(t.fields).filter(function(e){return e.startsWith("alternate_greetings_")}).forEach(function(e){delete t.fields[e]}),this.sessionService.updateSession({fields:t.fields,draftFields:{},creatorChatHistory:{messages:[]}});case 1:return e.a(2)}},e,this)})),function(){return c.apply(this,arguments)})},{key:"saveCharacter",value:(l=oe(te().m(function e(t){var n,r,o,i,a,s,l,c,u,p,d,h,f,m,g,v,y,b,S,w,x,C,_,k,E,P,O,I,T,A,D,N,F,j,R,$,H,q,U,Y,V,W,G,X,K,z,J,Z;return te().w(function(e){for(;;)switch(e.n){case 0:if(r=t.asNew,o=t.selectedCharacterId,i=this.sessionService.getSession(),null!==(n=i.fields.name)&&void 0!==n&&n.value){e.n=1;break}throw new Error("Please enter a name for the character.");case 1:if(a=Object.keys(i.fields).filter(function(e){return e.startsWith("alternate_greetings_")}).sort(function(e,t){return parseInt(e.split("_")[2]||"1")-parseInt(t.split("_")[2]||"1")}).map(function(e){var t,n;return null!==(t=null===(n=i.fields[e])||void 0===n?void 0:n.value)&&void 0!==t?t:""}).filter(function(e){return""!==e.trim()}),!r){e.n=3;break}return P={name:i.fields.name.value,description:null!==(s=null===(l=i.fields.description)||void 0===l?void 0:l.value)&&void 0!==s?s:"",personality:null!==(c=null===(u=i.fields.personality)||void 0===u?void 0:u.value)&&void 0!==c?c:"",scenario:null!==(p=null===(d=i.fields.scenario)||void 0===d?void 0:d.value)&&void 0!==p?p:"",first_mes:null!==(h=null===(f=i.fields.first_mes)||void 0===f?void 0:f.value)&&void 0!==h?h:"",mes_example:null!==(m=null===(g=i.fields.mes_example)||void 0===g?void 0:g.value)&&void 0!==m?m:"",data:{name:i.fields.name.value,description:null!==(v=null===(y=i.fields.description)||void 0===y?void 0:y.value)&&void 0!==v?v:"",personality:null!==(b=null===(S=i.fields.personality)||void 0===S?void 0:S.value)&&void 0!==b?b:"",scenario:null!==(w=null===(x=i.fields.scenario)||void 0===x?void 0:x.value)&&void 0!==w?w:"",first_mes:null!==(C=null===(_=i.fields.first_mes)||void 0===_?void 0:_.value)&&void 0!==C?C:"",mes_example:null!==(k=null===(E=i.fields.mes_example)||void 0===E?void 0:E.value)&&void 0!==k?k:"",tags:[],avatar:"none",alternate_greetings:a},avatar:"none",tags:[],spec:"chara_card_v3",spec_version:"3.0"},e.n=2,(0,M.OW)(P,!0);case 2:(0,L.YC)("success",'Character "'.concat(P.name,'" created successfully!')),e.n=7;break;case 3:if(o){e.n=4;break}throw new Error("Please load a character first to override.");case 4:if(J=B.globalContext.characters[parseInt(o)]){e.n=5;break}throw new Error("Selected character not found for override.");case 5:return Z=Q(Q({},J),{},{name:i.fields.name.value,description:null!==(O=null===(I=i.fields.description)||void 0===I?void 0:I.value)&&void 0!==O?O:"",personality:null!==(T=null===(A=i.fields.personality)||void 0===A?void 0:A.value)&&void 0!==T?T:"",scenario:null!==(D=null===(N=i.fields.scenario)||void 0===N?void 0:N.value)&&void 0!==D?D:"",first_mes:null!==(F=null===(j=i.fields.first_mes)||void 0===j?void 0:j.value)&&void 0!==F?F:"",mes_example:null!==(R=null===($=i.fields.mes_example)||void 0===$?void 0:$.value)&&void 0!==R?R:"",data:Q(Q({},J.data),{},{name:i.fields.name.value,description:null!==(H=null===(q=i.fields.description)||void 0===q?void 0:q.value)&&void 0!==H?H:"",personality:null!==(U=null===(Y=i.fields.personality)||void 0===Y?void 0:Y.value)&&void 0!==U?U:"",scenario:null!==(V=null===(W=i.fields.scenario)||void 0===W?void 0:W.value)&&void 0!==V?V:"",first_mes:null!==(G=null===(X=i.fields.first_mes)||void 0===X?void 0:X.value)&&void 0!==G?G:"",mes_example:null!==(K=null===(z=i.fields.mes_example)||void 0===z?void 0:z.value)&&void 0!==K?K:"",alternate_greetings:a})}),e.n=6,(0,M.tt)(Z,!0);case 6:(0,L.YC)("success",'Character "'.concat(Z.name,'" overridden successfully!'));case 7:return e.a(2)}},e,this)})),function(e){return l.apply(this,arguments)})},{key:"saveAsWorldInfo",value:(s=oe(te().m(function e(t){var n,r,o,i,a,s,l,c,u,p,d,h,f,m,g,v,y,b,S,w;return te().w(function(e){for(;;)switch(e.p=e.n){case 0:if(h=t.selectedWorldName,f=this.sessionService.getSession(),m=K.fq.getSettings(),null!==(n=f.fields.name)&&void 0!==n&&n.value){e.n=1;break}throw new Error("Please enter a name for the character.");case 1:g=Object.keys(f.fields).filter(function(e){return e.startsWith("alternate_greetings_")}).sort(function(e,t){return parseInt(e.split("_")[2]||"1")-parseInt(t.split("_")[2]||"1")}).map(function(e){var t,n;return null!==(t=null===(n=f.fields[e])||void 0===n?void 0:n.value)&&void 0!==t?t:""}).filter(function(e){return""!==e.trim()}),v={name:f.fields.name.value,description:null!==(r=null===(o=f.fields.description)||void 0===o?void 0:o.value)&&void 0!==r?r:"",first_mes:null!==(i=null===(a=f.fields.first_mes)||void 0===a?void 0:a.value)&&void 0!==i?i:"",scenario:null!==(s=null===(l=f.fields.scenario)||void 0===l?void 0:l.value)&&void 0!==s?s:"",personality:null!==(c=null===(u=f.fields.personality)||void 0===u?void 0:u.value)&&void 0!==c?c:"",mes_example:null!==(p=null===(d=f.fields.mes_example)||void 0===d?void 0:d.value)&&void 0!==p?p:"",alternate_greetings:g},y="",e.p=2,b=z.compile(m.prompts.charDefinitions.content,{noEscape:!0}),y=b({character:v}),e.n=4;break;case 3:throw e.p=3,w=e.v,new Error("Failed to compile character definition prompt: ".concat(w.message));case 4:return S={uid:-1,key:[f.fields.name.value],content:y,comment:f.fields.name.value,disable:!1,keysecondary:[]},e.n=5,(0,M.rM)({entry:S,selectedWorldName:h,operation:"add"});case 5:(0,L.YC)("success","World info entry added successfully!");case 6:return e.a(2)}},e,this,[[2,3]])})),function(e){return s.apply(this,arguments)})},{key:"exportDraftFields",value:function(){var e={draftFields:this.sessionService.getSession().draftFields,timestamp:(new Date).toISOString(),version:K.fq.getSettings().version},t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),n=URL.createObjectURL(t),r=document.createElement("a");r.href=n,r.download="draft-fields-".concat((new Date).toISOString().slice(0,10),".json"),document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(n)}},{key:"importDraftFields",value:(a=oe(te().m(function e(t){var n,r,o,i,a;return te().w(function(e){for(;;)switch(e.p=e.n){case 0:return n=this.sessionService.getSession(),e.p=1,e.n=2,t.text();case 2:if(r=e.v,(o=JSON.parse(r)).draftFields&&"object"===J(o.draftFields)){e.n=3;break}throw new Error("Invalid draft fields data");case 3:if(i=!0,!(Object.keys(n.draftFields).length>0)){e.n=5;break}return e.n=4,B.globalContext.Popup.show.confirm("Import Draft Fields","This will replace all existing draft fields. Continue?");case 4:i=e.v;case 5:i&&(this.sessionService.updateSession({draftFields:o.draftFields}),(0,L.YC)("success","Draft fields imported successfully")),e.n=7;break;case 6:throw e.p=6,a=e.v,new Error("Failed to import draft fields: ".concat(a.message));case 7:return e.a(2)}},e,this,[[1,6]])})),function(e){return a.apply(this,arguments)})},{key:"processImageFile",value:(i=oe(te().m(function e(t){return te().w(function(e){for(;;)if(0===e.n)return e.a(2,this.imageService.processImageFile(t))},e,this)})),function(e){return i.apply(this,arguments)})},{key:"createImagePreviewHtml",value:function(e){return this.imageService.createImagePreviewHtml(e)}},{key:"getMaxContext",value:function(e){switch(e.maxContextType){case"custom":return Number(e.maxContextValue);case"profile":default:return"preset";case"sampler":return"active"}}},{key:"applyMessageRangeOptions",value:function(e,t){var n,r,o,i,a,s,l,c,u=t.contextToSend.messages;switch(u.type){case"none":e.messageIndexesBetween={start:-1,end:-1};break;case"first":e.messageIndexesBetween={start:0,end:null!==(n=u.first)&&void 0!==n?n:10};break;case"last":var p=null!==(r=null===(o=B.globalContext.chat)||void 0===o?void 0:o.length)&&void 0!==r?r:0,d=null!==(i=u.last)&&void 0!==i?i:10;e.messageIndexesBetween={end:Math.max(0,p-1),start:Math.max(0,p-d)};break;case"range":e.messageIndexesBetween={start:null!==(a=null===(s=u.range)||void 0===s?void 0:s.start)&&void 0!==a?a:0,end:null!==(l=null===(c=u.range)||void 0===c?void 0:c.end)&&void 0!==l?l:10}}void 0!==L.oP||L.Yb||(e.messageIndexesBetween={start:-1,end:-1})}},{key:"getFormatDescription",value:function(e){switch(e.outputFormat){case"xml":return e.prompts.xmlFormat.content;case"json":return e.prompts.jsonFormat.content;case"none":return e.prompts.noneFormat.content;default:return""}}},{key:"loadWorldInfoEntries",value:(o=oe(te().m(function e(t){var n;return te().w(function(e){for(;;)switch(e.n){case 0:return n={},e.n=1,Promise.all(L.c3.filter(function(e){return t.selectedWorldNames.includes(e)}).map(function(){var e=oe(te().m(function e(t){var r;return te().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,B.globalContext.loadWorldInfo(t);case 1:(r=e.v)&&(n[t]=Object.values(r.entries));case 2:return e.a(2)}},e)}));return function(t){return e.apply(this,arguments)}}()));case 1:return e.a(2,n)}},e)})),function(e){return o.apply(this,arguments)})}],r=[{key:"getInstance",value:function(){return e.instance||(e.instance=new e),e.instance}}],n&&ie(t.prototype,n),r&&ie(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,n,r,o,i,a,s,l,c,u,p,d}();function le(e){return le="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},le(e)}function ce(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function i(n,r,o,i){var l=r&&r.prototype instanceof s?r:s,c=Object.create(l.prototype);return ue(c,"_invoke",function(n,r,o){var i,s,l,c=0,u=o||[],p=!1,d={p:0,n:0,v:e,a:h,f:h.bind(e,4),d:function(t,n){return i=t,s=0,l=e,d.n=n,a}};function h(n,r){for(s=n,l=r,t=0;!p&&c&&!o&&t<u.length;t++){var o,i=u[t],h=d.p,f=i[2];n>3?(o=f===r)&&(l=i[(s=i[4])?5:(s=3,3)],i[4]=i[5]=e):i[0]<=h&&((o=n<2&&h<i[1])?(s=0,d.v=r,d.n=i[1]):h<f&&(o=n<3||i[0]>r||r>f)&&(i[4]=n,i[5]=r,d.n=f,s=0))}if(o||n>1)return a;throw p=!0,r}return function(o,u,f){if(c>1)throw TypeError("Generator is already running");for(p&&1===u&&h(u,f),s=u,l=f;(t=s<2?e:l)||!p;){i||(s?s<3?(s>1&&(d.n=-1),h(s,l)):d.n=l:d.v=l);try{if(c=2,i){if(s||(o="next"),t=i[o]){if(!(t=t.call(i,l)))throw TypeError("iterator result is not an object");if(!t.done)return t;l=t.value,s<2&&(s=0)}else 1===s&&(t=i.return)&&t.call(i),s<2&&(l=TypeError("The iterator does not provide a '"+o+"' method"),s=1);i=e}else if((t=(p=d.n<0)?l:n.call(r,d))!==a)break}catch(t){i=e,s=1,l=t}finally{c=1}}return{value:t,done:p}}}(n,o,i),!0),c}var a={};function s(){}function l(){}function c(){}t=Object.getPrototypeOf;var u=[][r]?t(t([][r]())):(ue(t={},r,function(){return this}),t),p=c.prototype=s.prototype=Object.create(u);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,ue(e,o,"GeneratorFunction")),e.prototype=Object.create(p),e}return l.prototype=c,ue(p,"constructor",c),ue(c,"constructor",l),l.displayName="GeneratorFunction",ue(c,o,"GeneratorFunction"),ue(p),ue(p,o,"Generator"),ue(p,r,function(){return this}),ue(p,"toString",function(){return"[object Generator]"}),(ce=function(){return{w:i,m:d}})()}function ue(e,t,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}ue=function(e,t,n,r){function i(t,n){ue(e,t,function(e){return this._invoke(t,n,e)})}t?o?o(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(i("next",0),i("throw",1),i("return",2))},ue(e,t,n,r)}function pe(e,t,n,r,o,i,a){try{var s=e[i](a),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function de(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var i=e.apply(t,n);function a(e){pe(i,r,o,a,s,"next",e)}function s(e){pe(i,r,o,a,s,"throw",e)}a(void 0)})}}function he(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,me(r.key),r)}}function fe(e,t,n){return(t=me(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function me(e){var t=function(e,t){if("object"!=le(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=le(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==le(t)?t:t+""}var ge=function(){return e=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)},t=null,n=[{key:"bindFieldOperations",value:function(e,t){var n=this,r=t.fieldName,o=t.isDraft,i=void 0!==o&&o,a=t.getCharacterValue,s=e.textarea,l=e.generateButton,c=e.continueButton,u=e.compareButton,p=e.clearButton;l&&l.addEventListener("click",function(){n.handleFieldGeneration({targetField:r,button:l,textarea:s,isDraft:i})}),c&&c.addEventListener("click",function(){s.value.trim()?n.handleFieldGeneration({targetField:r,button:c,textarea:s,isDraft:i,continueFrom:s.value}):(0,L.YC)("warning","No content to continue from")}),u&&a&&u.addEventListener("click",function(){n.handleFieldComparison(r,s.value,a())}),p&&p.addEventListener("click",function(){s.value="",s.dispatchEvent(new Event("change"))})}},{key:"handleFieldGeneration",value:(a=de(ce().m(function e(t){var n,r,o,i,a,s,l,c,u,p,d,h;return ce().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=t.targetField,r=t.button,o=t.textarea,i=t.isDraft,a=void 0!==i&&i,s=t.continueFrom,r.disabled=!0,l=r.innerHTML,r.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i>',e.p=1,u=(null===(c=document.querySelector("#charCreator_prompt"))||void 0===c?void 0:c.value)||"",!s){e.n=3;break}return e.n=2,this.characterController.continueField({targetField:n,userPrompt:u,continueFrom:s,isDraft:a});case 2:d=e.v,e.n=5;break;case 3:return e.n=4,this.characterController.generateField({targetField:n,userPrompt:u,isDraft:a});case 4:d=e.v;case 5:p=d,o.value=p,o.dispatchEvent(new Event("change")),e.n=7;break;case 6:e.p=6,h=e.v,console.error("Error generating field ".concat(n,":"),h),(0,L.YC)("error","Failed to generate ".concat(n,": ").concat(h.message||h));case 7:return e.p=7,r.disabled=!1,r.innerHTML=l,e.f(7);case 8:return e.a(2)}},e,this,[[1,6,7,8]])})),function(e){return a.apply(this,arguments)})},{key:"handleFieldComparison",value:(i=de(ce().m(function e(t,n,r){var o,i,a,s,l,c,u,p,d,h,f,m,g;return ce().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,F.e(411).then(F.bind(F,411));case 1:return o=e.v,i=o.diffWords,(a=document.createElement("div")).classList.add("compare-popup"),(s=document.createElement("h3")).textContent="Compare ".concat(t),a.appendChild(s),l=i(r,n),(c=document.createElement("div")).innerHTML="<h4>Original (Character)</h4>",(u=document.createElement("div")).classList.add("diff-content"),(p=document.createElement("div")).innerHTML="<h4>New (Current)</h4>",(d=document.createElement("div")).classList.add("diff-content"),l.forEach(function(e){var t=document.createElement("span");if(t.textContent=e.value,e.added)t.style.backgroundColor="#d4edda",t.style.color="#155724",d.appendChild(t);else if(e.removed)t.style.backgroundColor="#f8d7da",t.style.color="#721c24",u.appendChild(t);else{var n=t.cloneNode(!0);u.appendChild(n),d.appendChild(t)}}),c.appendChild(u),p.appendChild(d),a.appendChild(c),a.appendChild(p),e.n=2,Promise.resolve().then(F.bind(F,262));case 2:return h=e.v,f=h.globalContext,e.n=3,Promise.resolve().then(F.bind(F,452));case 3:return m=e.v,g=m.POPUP_TYPE,e.n=4,f.callGenericPopup(a,g.DISPLAY,void 0,{wide:!0});case 4:return e.a(2)}},e)})),function(e,t,n){return i.apply(this,arguments)})},{key:"createTextChangeHandler",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return function(r){var o=r.target.value;n?t.sessionService.updateDraftField(e,{value:o}):t.sessionService.updateField(e,{value:o})}}},{key:"createPromptChangeHandler",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return function(r){var o=r.target.value;n?t.sessionService.updateDraftField(e,{prompt:o}):t.sessionService.updateField(e,{prompt:o})}}},{key:"showConfirmation",value:(o=de(ce().m(function e(t,n){var r,o;return ce().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,Promise.resolve().then(F.bind(F,262));case 1:return r=e.v,o=r.globalContext,e.a(2,o.Popup.show.confirm(t,n))}},e)})),function(e,t){return o.apply(this,arguments)})},{key:"showInput",value:(r=de(ce().m(function e(t){var n,r,o,i=arguments;return ce().w(function(e){for(;;)switch(e.n){case 0:return n=i.length>1&&void 0!==i[1]?i[1]:"",e.n=1,Promise.resolve().then(F.bind(F,262));case 1:return r=e.v,o=r.globalContext,e.a(2,o.Popup.show.input(t,n))}},e)})),function(e){return r.apply(this,arguments)})},{key:"setButtonLoading",value:function(e,t,n){t?(e.disabled=!0,e.dataset.originalContent||(e.dataset.originalContent=e.innerHTML),e.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i>'):(e.disabled=!1,e.innerHTML=e.dataset.originalContent||n||e.innerHTML,delete e.dataset.originalContent)}},{key:"getUserPrompt",value:function(){var e=document.querySelector("#charCreator_prompt");return(null==e?void 0:e.value)||""}},{key:"findFieldElements",value:function(e,t){var n=t||document,r=n.querySelector('[data-field="'.concat(e,'"] textarea, .').concat(e,"-textarea"));return r?{textarea:r,generateButton:n.querySelector('[data-field="'.concat(e,'"] .generate-button, .').concat(e,"-generate")),continueButton:n.querySelector('[data-field="'.concat(e,'"] .continue-button, .').concat(e,"-continue")),compareButton:n.querySelector('[data-field="'.concat(e,'"] .compare-button, .').concat(e,"-compare")),clearButton:n.querySelector('[data-field="'.concat(e,'"] .clear-button, .').concat(e,"-clear")),promptTextarea:n.querySelector('[data-field="'.concat(e,'"] .prompt-textarea, .').concat(e,"-prompt"))}:null}}],t&&he(e.prototype,t),n&&he(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,t,n,r,o,i,a}();function ve(e){return ve="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ve(e)}function ye(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function i(n,r,o,i){var l=r&&r.prototype instanceof s?r:s,c=Object.create(l.prototype);return be(c,"_invoke",function(n,r,o){var i,s,l,c=0,u=o||[],p=!1,d={p:0,n:0,v:e,a:h,f:h.bind(e,4),d:function(t,n){return i=t,s=0,l=e,d.n=n,a}};function h(n,r){for(s=n,l=r,t=0;!p&&c&&!o&&t<u.length;t++){var o,i=u[t],h=d.p,f=i[2];n>3?(o=f===r)&&(l=i[(s=i[4])?5:(s=3,3)],i[4]=i[5]=e):i[0]<=h&&((o=n<2&&h<i[1])?(s=0,d.v=r,d.n=i[1]):h<f&&(o=n<3||i[0]>r||r>f)&&(i[4]=n,i[5]=r,d.n=f,s=0))}if(o||n>1)return a;throw p=!0,r}return function(o,u,f){if(c>1)throw TypeError("Generator is already running");for(p&&1===u&&h(u,f),s=u,l=f;(t=s<2?e:l)||!p;){i||(s?s<3?(s>1&&(d.n=-1),h(s,l)):d.n=l:d.v=l);try{if(c=2,i){if(s||(o="next"),t=i[o]){if(!(t=t.call(i,l)))throw TypeError("iterator result is not an object");if(!t.done)return t;l=t.value,s<2&&(s=0)}else 1===s&&(t=i.return)&&t.call(i),s<2&&(l=TypeError("The iterator does not provide a '"+o+"' method"),s=1);i=e}else if((t=(p=d.n<0)?l:n.call(r,d))!==a)break}catch(t){i=e,s=1,l=t}finally{c=1}}return{value:t,done:p}}}(n,o,i),!0),c}var a={};function s(){}function l(){}function c(){}t=Object.getPrototypeOf;var u=[][r]?t(t([][r]())):(be(t={},r,function(){return this}),t),p=c.prototype=s.prototype=Object.create(u);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,be(e,o,"GeneratorFunction")),e.prototype=Object.create(p),e}return l.prototype=c,be(p,"constructor",c),be(c,"constructor",l),l.displayName="GeneratorFunction",be(c,o,"GeneratorFunction"),be(p),be(p,o,"Generator"),be(p,r,function(){return this}),be(p,"toString",function(){return"[object Generator]"}),(ye=function(){return{w:i,m:d}})()}function be(e,t,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}be=function(e,t,n,r){function i(t,n){be(e,t,function(e){return this._invoke(t,n,e)})}t?o?o(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(i("next",0),i("throw",1),i("return",2))},be(e,t,n,r)}function Se(e,t,n,r,o,i,a){try{var s=e[i](a),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function we(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var i=e.apply(t,n);function a(e){Se(i,r,o,a,s,"next",e)}function s(e){Se(i,r,o,a,s,"throw",e)}a(void 0)})}}function xe(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,Ce(r.key),r)}}function Ce(e){var t=function(e,t){if("object"!=ve(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=ve(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==ve(t)?t:t+""}fe(ge,"characterController",se.getInstance()),fe(ge,"sessionService",R.SessionService.getInstance());var _e=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.sessionService=R.SessionService.getInstance(),this.imageService=X.getInstance()}return t=e,n=[{key:"sendMessage",value:function(){var e=we(ye().m(function e(t){var n,r,o,i,a,s;return ye().w(function(e){for(;;)switch(e.n){case 0:if(n=t.content,r=t.imageUrl,K.fq.getSettings().profileId){e.n=1;break}throw new Error("No connection profile selected");case 1:return e.n=2,this.createAndStoreUserMessage({content:n.trim(),imageUrl:r});case 2:return o=e.v,e.n=3,this.generateChatResponse(n,r);case 3:return i=e.v,a=this.sessionService.addChatMessage({role:"assistant",content:i}),s={id:String(a),role:"assistant",content:i,timestamp:Date.now()},e.a(2,{userMessage:o,aiMessage:s})}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"editMessage",value:(l=we(ye().m(function e(t){var n,r,o,i,a;return ye().w(function(e){for(;;)switch(e.n){case 0:if(n=t.messageIndex,(r=t.newContent).trim()){e.n=1;break}throw new Error("Message cannot be empty");case 1:if(o=this.sessionService.getChatMessagesForUI(),!(n<0||n>=o.length)){e.n=2;break}throw new Error("Invalid message index");case 2:i=o[n],a=this.sessionService.convertUIMessageToChatMessage({content:r.trim(),imageUrl:i.inlineImageUrl},i.role),this.sessionService.replaceChatMessage(n,a);case 3:return e.a(2)}},e,this)})),function(e){return l.apply(this,arguments)})},{key:"deleteMessage",value:function(){var e=we(ye().m(function e(t){var n;return ye().w(function(e){for(;;)switch(e.n){case 0:if(n=this.sessionService.getChatMessagesForUI(),!(t<0||t>=n.length)){e.n=1;break}throw new Error("Invalid message index");case 1:this.sessionService.deleteChatMessage(t);case 2:return e.a(2)}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"regenerateMessage",value:function(){var e=we(ye().m(function e(t,n){var r,o,i,a,s,l,c,u,p,d,h;return ye().w(function(e){for(;;)switch(e.p=e.n){case 0:if(r=this.sessionService.getChatMessagesForUI(),!(t<0||t>=r.length)){e.n=1;break}throw new Error("Invalid message index");case 1:if("assistant"===r[t].role){e.n=2;break}throw new Error("Only AI messages can be regenerated");case 2:o=-1,i=t-1;case 3:if(!(i>=0)){e.n=5;break}if("user"!==r[i].role){e.n=4;break}return o=i,e.a(3,5);case 4:i--,e.n=3;break;case 5:if(-1!==o){e.n=6;break}throw new Error("Cannot regenerate: no user message found for context");case 6:return a=this.sessionService.getSession(),s=a.creatorChatHistory.messages[o],l=a.creatorChatHistory.messages[t],e.p=7,this.sessionService.deleteChatMessage(t),this.sessionService.deleteChatMessage(o),e.n=8,this.sendMessage(n);case 8:return(c=e.v).userMessage,u=c.aiMessage,e.a(2,u);case 9:e.p=9,h=e.v;try{p=this.sessionService.getSession(),(d=p.creatorChatHistory.messages).splice(o,0,s),d.splice(t,0,l),this.sessionService.updateSession({})}catch(e){console.error("Failed to restore messages after regeneration error:",e)}throw h;case 10:return e.a(2)}},e,this,[[7,9]])}));return function(t,n){return e.apply(this,arguments)}}()},{key:"clearChat",value:function(){var e=we(ye().m(function e(){return ye().w(function(e){for(;;)switch(e.n){case 0:this.sessionService.clearChatHistory();case 1:return e.a(2)}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"exportChat",value:function(){return{messages:this.sessionService.getChatMessagesForUI(),exportedAt:(new Date).toISOString()}}},{key:"getChatMessages",value:function(){return this.sessionService.getChatMessagesForUI()}},{key:"processImageFile",value:(s=we(ye().m(function e(t){return ye().w(function(e){for(;;)if(0===e.n)return e.a(2,this.imageService.processImageFile(t))},e,this)})),function(e){return s.apply(this,arguments)})},{key:"createImagePreviewHtml",value:function(e){return this.imageService.createImagePreviewHtml(e)}},{key:"generateChatResponse",value:(a=we(ye().m(function e(t,n){var r,o,i,a,s,l,c,u,p,d,h;return ye().w(function(e){for(;;)switch(e.n){case 0:return o=K.fq.getSettings(),i=this.sessionService.getSession(),a=B.globalContext,s={},e.n=1,Promise.all(L.c3.filter(function(e){return i.selectedWorldNames.includes(e)}).map(function(){var e=we(ye().m(function e(t){var n;return ye().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,B.globalContext.loadWorldInfo(t);case 1:(n=e.v)&&(s[t]=Object.values(n.entries));case 2:return e.a(2)}},e)}));return function(t){return e.apply(this,arguments)}}()));case 1:l=null===(r=a.extensionSettings.connectionManager)||void 0===r||null===(r=r.profiles)||void 0===r?void 0:r.find(function(e){return e.id===o.profileId}),c={presetName:null==l?void 0:l.preset,contextName:null==l?void 0:l.context,instructName:null==l?void 0:l.instruct,targetCharacterId:L.oP,ignoreCharacterFields:!0,ignoreWorldInfo:!0,ignoreAuthorNote:!0,maxContext:this.getMaxContext(o),includeNames:!!L.Yb,messageIndexesBetween:{start:-1,end:-1}},u="",h=o.outputFormat,e.n="xml"===h?2:"json"===h?3:"none"===h?4:5;break;case 2:return u=o.prompts.xmlFormat.content,e.a(3,5);case 3:return u=o.prompts.jsonFormat.content,e.a(3,5);case 4:return u=o.prompts.noneFormat.content,e.a(3,5);case 5:return p='This is a chat request. The user just said: "'.concat(t,'". Please respond naturally as an AI assistant helping with character creation to continue the conversation.'),e.n=6,(0,B.runCharacterFieldGeneration)({profileId:o.profileId,userPrompt:p,buildPromptOptions:c,session:i,allCharacters:a.characters,entriesGroupByWorldName:s,formatDescription:{content:u},includeUserMacro:o.contextToSend.persona,maxResponseToken:o.maxResponseToken,targetField:"chat_response",outputFormat:o.outputFormat,additionalContentPartsForCurrentUserMessage:n?[this.imageService.createImageContentPart(n)]:void 0});case 6:return d=e.v,e.a(2,d||"")}},e,this)})),function(e,t){return a.apply(this,arguments)})},{key:"getMaxContext",value:function(e){switch(e.maxContextType){case"custom":return Number(e.maxContextValue);case"profile":default:return"preset";case"sampler":return"active"}}},{key:"generateId",value:function(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}},{key:"createAndStoreUserMessage",value:(i=we(ye().m(function e(t){var n,r,o,i,a,s,l,c,u;return ye().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=t.content,r=t.imageUrl,o={content:n.trim(),imageUrl:r},!r){e.n=4;break}return e.p=1,e.n=2,this.imageService.createThumbnail(r);case 2:i=e.v,a=this.sessionService.storeImageThumbnail(r,i),o={content:n.trim(),imageUrl:r,thumbnailId:a},e.n=4;break;case 3:e.p=3,u=e.v,console.warn("Failed to create thumbnail, storing original image:",u);case 4:return s=this.createChatMessageWithImage(o,"user"),l=this.sessionService.addChatMessage(s),c={id:String(l),role:"user",content:n.trim(),inlineImageUrl:r,timestamp:Date.now()},e.a(2,c)}},e,this,[[1,3]])})),function(e){return i.apply(this,arguments)})},{key:"createChatMessageWithImage",value:function(e,t){if(e.imageUrl){var n=[];return e.content.trim()&&n.push({type:"text",text:e.content}),n.push({type:"image_url",image_url:{url:e.imageUrl,detail:"auto",thumbnailUrl:e.thumbnailId,originalSize:e.imageUrl.length}}),{role:t,content:n}}return{role:t,content:e.content}}},{key:"generateAndStoreAiResponse",value:(o=we(ye().m(function e(t){var n,r,o,i,a;return ye().w(function(e){for(;;)switch(e.n){case 0:return n=t.content,r=t.imageUrl,e.n=1,this.generateChatResponse(n,r);case 1:return o=e.v,i=this.sessionService.addChatMessage({role:"assistant",content:o}),a={id:String(i),role:"assistant",content:o,timestamp:Date.now()},e.a(2,a)}},e,this)})),function(e){return o.apply(this,arguments)})}],r=[{key:"getInstance",value:function(){return e.instance||(e.instance=new e),e.instance}}],n&&xe(t.prototype,n),r&&xe(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,n,r,o,i,a,s,l}();function ke(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function i(n,r,o,i){var l=r&&r.prototype instanceof s?r:s,c=Object.create(l.prototype);return Ee(c,"_invoke",function(n,r,o){var i,s,l,c=0,u=o||[],p=!1,d={p:0,n:0,v:e,a:h,f:h.bind(e,4),d:function(t,n){return i=t,s=0,l=e,d.n=n,a}};function h(n,r){for(s=n,l=r,t=0;!p&&c&&!o&&t<u.length;t++){var o,i=u[t],h=d.p,f=i[2];n>3?(o=f===r)&&(l=i[(s=i[4])?5:(s=3,3)],i[4]=i[5]=e):i[0]<=h&&((o=n<2&&h<i[1])?(s=0,d.v=r,d.n=i[1]):h<f&&(o=n<3||i[0]>r||r>f)&&(i[4]=n,i[5]=r,d.n=f,s=0))}if(o||n>1)return a;throw p=!0,r}return function(o,u,f){if(c>1)throw TypeError("Generator is already running");for(p&&1===u&&h(u,f),s=u,l=f;(t=s<2?e:l)||!p;){i||(s?s<3?(s>1&&(d.n=-1),h(s,l)):d.n=l:d.v=l);try{if(c=2,i){if(s||(o="next"),t=i[o]){if(!(t=t.call(i,l)))throw TypeError("iterator result is not an object");if(!t.done)return t;l=t.value,s<2&&(s=0)}else 1===s&&(t=i.return)&&t.call(i),s<2&&(l=TypeError("The iterator does not provide a '"+o+"' method"),s=1);i=e}else if((t=(p=d.n<0)?l:n.call(r,d))!==a)break}catch(t){i=e,s=1,l=t}finally{c=1}}return{value:t,done:p}}}(n,o,i),!0),c}var a={};function s(){}function l(){}function c(){}t=Object.getPrototypeOf;var u=[][r]?t(t([][r]())):(Ee(t={},r,function(){return this}),t),p=c.prototype=s.prototype=Object.create(u);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,Ee(e,o,"GeneratorFunction")),e.prototype=Object.create(p),e}return l.prototype=c,Ee(p,"constructor",c),Ee(c,"constructor",l),l.displayName="GeneratorFunction",Ee(c,o,"GeneratorFunction"),Ee(p),Ee(p,o,"Generator"),Ee(p,r,function(){return this}),Ee(p,"toString",function(){return"[object Generator]"}),(ke=function(){return{w:i,m:d}})()}function Ee(e,t,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}Ee=function(e,t,n,r){function i(t,n){Ee(e,t,function(e){return this._invoke(t,n,e)})}t?o?o(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(i("next",0),i("throw",1),i("return",2))},Ee(e,t,n,r)}function Pe(e,t,n,r,o,i,a){try{var s=e[i](a),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function Oe(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var i=e.apply(t,n);function a(e){Pe(i,r,o,a,s,"next",e)}function s(e){Pe(i,r,o,a,s,"throw",e)}a(void 0)})}}R.SessionService.getInstance();var Ie=_e.getInstance(),Te=null,Ae=null;function De(){$(document).on("click",'.tab-button[data-tab="charCreator_chatContainer"]',function(){Te||Ne()})}function Ne(){return Fe.apply(this,arguments)}function Fe(){return(Fe=Oe(ke().m(function e(){var t,n,r;return ke().w(function(e){for(;;)switch(e.p=e.n){case 0:return t=$("#charCreator_chatContainer"),e.p=1,e.n=2,B.globalContext.renderExtensionTemplateAsync("third-party/SillyTavern-Character-Creator-Chat","templates/chat");case 2:n=e.v,t.html(n),(Te=$("#chat_container")).show(),Me(),$e(),e.n=4;break;case 3:e.p=3,r=e.v,console.error("Failed to load chat template:",r),t.html('<div class="error">Failed to load chat interface</div>');case 4:return e.a(2)}},e,null,[[1,3]])}))).apply(this,arguments)}function Me(){$("#send_message").on("click",Le),$("#chat_input").on("keydown",function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),Le())}),$("#clear_chat").on("click",qe),$("#export_chat").on("click",Ye),$("#chat_messages").on("click",".edit-message-btn",function(){var e=$(this).closest(".chat-message").attr("data-message-id");e&&function(e){var t=Ie.getChatMessages().find(function(t){return t.id===e});if(!t)return;var n=$('.chat-message[data-message-id="'.concat(e,'"]')),r=n.find(".message-content"),o=n.find(".message-edit-container"),i=o.find(".message-edit-textarea");r.hide(),o.show(),i.val(t.content).focus(),i.css("height","auto"),i.css("height",i[0].scrollHeight+"px")}(e)}),$("#chat_messages").on("click",".delete-message-btn",function(){var e=$(this).closest(".chat-message").attr("data-message-id");e&&function(e){We.apply(this,arguments)}(e)}),$("#chat_messages").on("click",".regen-message-btn",function(){var e=$(this).closest(".chat-message").attr("data-message-id");e&&function(e){Ge.apply(this,arguments)}(e)}),$("#chat_messages").on("click",".save-edit-btn",function(){var e=$(this).closest(".chat-message").attr("data-message-id");e&&function(e){Ve.apply(this,arguments)}(e)}),$("#chat_messages").on("click",".cancel-edit-btn",function(){var e=$(this).closest(".chat-message").attr("data-message-id");e&&function(e){var t=$('.chat-message[data-message-id="'.concat(e,'"]')),n=t.find(".message-content"),r=t.find(".message-edit-container");n.show(),r.hide()}(e)}),$("#attach_image").on("click",function(){var e=document.getElementById("chat_image_input");null==e||e.click()}),$("#chat_image_input").on("change",function(){var e=Oe(ke().m(function e(t){var n,r,o,i,a;return ke().w(function(e){for(;;)switch(e.p=e.n){case 0:if(r=t.target,o=null===(n=r.files)||void 0===n?void 0:n[0]){e.n=1;break}return e.a(2);case 1:return e.p=1,e.n=2,Ie.processImageFile(o);case 2:Ae=e.v,(i=$("#chat_image_preview")).attr("src",Ae||""),i.closest(".chat-image-preview-container").show(),e.n=4;break;case 3:e.p=3,a=e.v,console.error("Failed to process image:",a),alert(a instanceof Error?a.message:"Failed to process image file."),r.value="";case 4:return e.a(2)}},e,null,[[1,3]])}));return function(t){return e.apply(this,arguments)}}()),$("#clear_image").on("click",function(){Ae=null;var e=document.getElementById("chat_image_input");e&&(e.value="");var t=$("#chat_image_preview");t.attr("src",""),t.closest(".chat-image-preview-container").hide()})}function Le(){return je.apply(this,arguments)}function je(){return(je=Oe(ke().m(function e(){var t,n,r,o,i,a;return ke().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=$("#chat_input"),r=null===(t=n.val())||void 0===t?void 0:t.toString().trim()){e.n=1;break}return e.a(2);case 1:return(o=$("#send_message")).prop("disabled",!0),n.prop("disabled",!0),e.p=2,i=null!=Ae?Ae:void 0,e.n=3,Ie.createAndStoreUserMessage({content:r,imageUrl:i});case 3:return Re(e.v),He(),n.val(""),Be(),e.n=4,Ie.generateAndStoreAiResponse({content:r,imageUrl:i});case 4:Re(e.v),He(),e.n=6;break;case 5:e.p=5,a=e.v,console.error("Failed to generate response:",a),alert("Failed to generate response. Please check your connection settings.");case 6:return e.p=6,o.prop("disabled",!1),n.prop("disabled",!1),n.focus(),e.f(6);case 7:return e.a(2)}},e,null,[[2,5,6,7]])}))).apply(this,arguments)}function Be(){Ae=null;var e=document.getElementById("chat_image_input");e&&(e.value="");var t=$("#chat_image_preview");t.attr("src",""),t.closest(".chat-image-preview-container").hide()}function Re(e){var t,n=$("#chat_message_template")[0].content.cloneNode(!0),r=$(n.querySelector(".chat-message"));r.attr("data-message-id",e.id),r.addClass("message-".concat(e.role)),r.find(".message-role").text("user"===e.role?"You":"AI"),r.find(".message-timestamp").text((t=e.timestamp,new Date(t).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}))),"assistant"===e.role&&r.find(".regen-message-btn").css("display","inline-block");var o=r.find(".message-content");if(o.html(Xe(e.content)),e.inlineImageUrl){var i=Ie.createImagePreviewHtml(e.inlineImageUrl);o.append($(i))}$("#chat_messages").append(r)}function $e(){$("#chat_messages").empty(),Ie.getChatMessages().forEach(function(e){return Re(e)}),He()}function He(){var e=$("#chat_messages")[0];e&&(e.scrollTop=e.scrollHeight)}function qe(){return Ue.apply(this,arguments)}function Ue(){return(Ue=Oe(ke().m(function e(){var t;return ke().w(function(e){for(;;)switch(e.p=e.n){case 0:if(confirm("Are you sure you want to clear the chat history?")){e.n=1;break}return e.a(2);case 1:return e.p=1,e.n=2,Ie.clearChat();case 2:$("#chat_messages").empty(),e.n=4;break;case 3:e.p=3,t=e.v,console.error("Failed to clear chat:",t),alert("Failed to clear chat history.");case 4:return e.a(2)}},e,null,[[1,3]])}))).apply(this,arguments)}function Ye(){try{var e=Ie.exportChat();if(0===e.messages.length)return void alert("No chat history to export");var t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),n=URL.createObjectURL(t),r=document.createElement("a");r.href=n,r.download="character-chat-".concat((new Date).toISOString().split("T")[0],".json"),document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(n)}catch(e){console.error("Failed to export chat:",e),alert("Failed to export chat history.")}}function Ve(){return(Ve=Oe(ke().m(function e(t){var n,r,o,i,a,s,l,c,u;return ke().w(function(e){for(;;)switch(e.p=e.n){case 0:if(r=$('.chat-message[data-message-id="'.concat(t,'"]')),o=r.find(".message-edit-container"),i=o.find(".message-edit-textarea"),a=null===(n=i.val())||void 0===n?void 0:n.toString().trim()){e.n=1;break}return alert("Message cannot be empty"),e.a(2);case 1:if(e.p=1,s=Ie.getChatMessages(),-1===(l=s.findIndex(function(e){return e.id===t}))){e.n=3;break}return e.n=2,Ie.editMessage({messageIndex:l,newContent:a});case 2:(c=r.find(".message-content")).html(Xe(a)),c.show(),o.hide();case 3:e.n=5;break;case 4:e.p=4,u=e.v,console.error("Failed to edit message:",u),alert("Failed to edit message.");case 5:return e.a(2)}},e,null,[[1,4]])}))).apply(this,arguments)}function We(){return(We=Oe(ke().m(function e(t){var n,r;return ke().w(function(e){for(;;)switch(e.p=e.n){case 0:if(confirm("Are you sure you want to delete this message?")){e.n=1;break}return e.a(2);case 1:if(e.p=1,-1===(n=parseInt(t,10))){e.n=3;break}return e.n=2,Ie.deleteMessage(n);case 2:$('.chat-message[data-message-id="'.concat(t,'"]')).fadeOut(200,function(){$(this).remove()});case 3:e.n=5;break;case 4:e.p=4,r=e.v,console.error("Failed to delete message:",r),alert("Failed to delete message.");case 5:return e.a(2)}},e,null,[[1,4]])}))).apply(this,arguments)}function Ge(){return(Ge=Oe(ke().m(function e(t){var n,r,o,i,a,s,l,c;return ke().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=parseInt(t,10),r=Ie.getChatMessages(),!(n<0||n>=r.length)){e.n=1;break}return console.error("Invalid message index for regeneration"),e.a(2);case 1:if("assistant"===r[n].role){e.n=2;break}return alert("Only AI messages can be regenerated"),e.a(2);case 2:o="",a=n-1;case 3:if(!(a>=0)){e.n=5;break}if("user"!==r[a].role){e.n=4;break}return o=r[a].content,i=r[a].inlineImageUrl,e.a(3,5);case 4:a--,e.n=3;break;case 5:if(o){e.n=6;break}return alert("Cannot regenerate: no user message found for context"),e.a(2);case 6:return s=$('.chat-message[data-message-id="'.concat(t,'"]')),l=s.find(".regen-message-btn"),l.html(),l.prop("disabled",!0),l.html('<i class="fa-solid fa-spinner fa-spin"></i>'),e.p=7,e.n=8,Ie.regenerateMessage(n,{content:o,imageUrl:i});case 8:$e(),e.n=10;break;case 9:e.p=9,c=e.v,console.error("Failed to regenerate message:",c),alert("Failed to regenerate message. Please check your connection settings."),$e();case 10:return e.p=10,e.f(10);case 11:return e.a(2)}},e,null,[[7,9,10,11]])}))).apply(this,arguments)}function Xe(e){var t=e;return t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=$("<div>").text(t).html()).replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>")).replace(/__(.+?)__/g,"<strong>$1</strong>")).replace(/\*(.+?)\*/g,"<em>$1</em>")).replace(/_(.+?)_/g,"<em>$1</em>")).replace(/```([^]+?)```/g,"<pre><code>$1</code></pre>")).replace(/`(.+?)`/g,"<code>$1</code>")).replace(/\n/g,"<br>")).replace(/^- (.+)$/gm,"• $1")).replace(/^\* (.+)$/gm,"• $1")).replace(/^\d+\. (.+)$/gm,"$&")}function Ke(e){return Ke="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Ke(e)}function ze(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function Je(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ze(Object(n),!0).forEach(function(t){Ze(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ze(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function Ze(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=Ke(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=Ke(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==Ke(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Qe(e){return function(e){if(Array.isArray(e))return nt(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||tt(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function et(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,i,a,s=[],l=!0,c=!1;try{if(i=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;l=!1}else for(;!(l=(r=i.call(n)).done)&&(s.push(r.value),s.length!==t);l=!0);}catch(e){c=!0,o=e}finally{try{if(!l&&null!=n.return&&(a=n.return(),Object(a)!==a))return}finally{if(c)throw o}}return s}}(e,t)||tt(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function tt(e,t){if(e){if("string"==typeof e)return nt(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?nt(e,t):void 0}}function nt(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function rt(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */var e,t,n="function"==typeof Symbol?Symbol:{},r=n.iterator||"@@iterator",o=n.toStringTag||"@@toStringTag";function i(n,r,o,i){var l=r&&r.prototype instanceof s?r:s,c=Object.create(l.prototype);return ot(c,"_invoke",function(n,r,o){var i,s,l,c=0,u=o||[],p=!1,d={p:0,n:0,v:e,a:h,f:h.bind(e,4),d:function(t,n){return i=t,s=0,l=e,d.n=n,a}};function h(n,r){for(s=n,l=r,t=0;!p&&c&&!o&&t<u.length;t++){var o,i=u[t],h=d.p,f=i[2];n>3?(o=f===r)&&(l=i[(s=i[4])?5:(s=3,3)],i[4]=i[5]=e):i[0]<=h&&((o=n<2&&h<i[1])?(s=0,d.v=r,d.n=i[1]):h<f&&(o=n<3||i[0]>r||r>f)&&(i[4]=n,i[5]=r,d.n=f,s=0))}if(o||n>1)return a;throw p=!0,r}return function(o,u,f){if(c>1)throw TypeError("Generator is already running");for(p&&1===u&&h(u,f),s=u,l=f;(t=s<2?e:l)||!p;){i||(s?s<3?(s>1&&(d.n=-1),h(s,l)):d.n=l:d.v=l);try{if(c=2,i){if(s||(o="next"),t=i[o]){if(!(t=t.call(i,l)))throw TypeError("iterator result is not an object");if(!t.done)return t;l=t.value,s<2&&(s=0)}else 1===s&&(t=i.return)&&t.call(i),s<2&&(l=TypeError("The iterator does not provide a '"+o+"' method"),s=1);i=e}else if((t=(p=d.n<0)?l:n.call(r,d))!==a)break}catch(t){i=e,s=1,l=t}finally{c=1}}return{value:t,done:p}}}(n,o,i),!0),c}var a={};function s(){}function l(){}function c(){}t=Object.getPrototypeOf;var u=[][r]?t(t([][r]())):(ot(t={},r,function(){return this}),t),p=c.prototype=s.prototype=Object.create(u);function d(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,ot(e,o,"GeneratorFunction")),e.prototype=Object.create(p),e}return l.prototype=c,ot(p,"constructor",c),ot(c,"constructor",l),l.displayName="GeneratorFunction",ot(c,o,"GeneratorFunction"),ot(p),ot(p,o,"Generator"),ot(p,r,function(){return this}),ot(p,"toString",function(){return"[object Generator]"}),(rt=function(){return{w:i,m:d}})()}function ot(e,t,n,r){var o=Object.defineProperty;try{o({},"",{})}catch(e){o=0}ot=function(e,t,n,r){function i(t,n){ot(e,t,function(e){return this._invoke(t,n,e)})}t?o?o(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r}):e[t]=n:(i("next",0),i("throw",1),i("return",2))},ot(e,t,n,r)}function it(e,t,n,r,o,i,a){try{var s=e[i](a),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function at(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var i=e.apply(t,n);function a(e){it(i,r,o,a,s,"next",e)}function s(e){it(i,r,o,a,s,"throw",e)}a(void 0)})}}function st(){return st=at(rt().m(function e(){var t,n,r,o,i,a,s,l,c,u,p,d,h,f,m,g,v,y,b,S;return rt().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,B.globalContext.renderExtensionTemplateAsync("third-party/".concat(K.Zi),"templates/settings");case 1:if(t=e.v,$("#extensions_settings").append(t),n=document.querySelector(".charCreator_settings")){e.n=2;break}return e.a(2);case 2:r=K.fq.getSettings(),o=R.SessionService.getInstance(),s=n.querySelector("#charCreator_mainContextTemplatePreset"),l=n.querySelector("#charCreator_mainContextList"),c=n.querySelector("#charCreator_restoreMainContextTemplateDefault"),(0,M.Kq)("#charCreator_mainContextTemplatePreset",{initialList:Object.keys(r.mainContextTemplatePresets),initialValue:r.mainContextTemplatePreset,readOnlyValues:["default"],onSelectChange:function(e,t){var n=null!=t?t:"default";d(r.mainContextTemplatePresets[n].prompts.map(function(e){var t=e.promptName;return r.prompts[e.promptName]&&(t="".concat(r.prompts[e.promptName].label," (").concat(e.promptName,")")),{enabled:e.enabled,id:e.promptName,label:t,selectOptions:[{value:"user",label:"User"},{value:"assistant",label:"Assistant"},{value:"system",label:"System"}],selectValue:e.role}})),r.mainContextTemplatePreset=n,K.fq.saveSettings()},create:{onAfterCreate:function(e){var t=r.mainContextTemplatePresets[r.mainContextTemplatePreset];t||(t=r.mainContextTemplatePresets.default),r.mainContextTemplatePresets[e]=structuredClone(t)}},rename:{onAfterRename:function(e,t){r.mainContextTemplatePresets[t]=r.mainContextTemplatePresets[e],delete r.mainContextTemplatePresets[e]}},delete:{onAfterDelete:function(e){delete r.mainContextTemplatePresets[e]}}}),u=r.mainContextTemplatePresets[r.mainContextTemplatePreset].prompts.map(function(e){var t=e.promptName;return r.prompts[e.promptName]&&(t="".concat(r.prompts[e.promptName].label," (").concat(e.promptName,")")),{enabled:e.enabled,id:e.promptName,label:t,selectOptions:[{value:"user",label:"User"},{value:"assistant",label:"Assistant"},{value:"system",label:"System"}],selectValue:e.role}}),p=(0,M.h5)(l,{initialList:u,showSelectInput:!0,showToggleButton:!0,onSelectChange:function(e,t){var n=r.mainContextTemplatePresets[r.mainContextTemplatePreset].prompts.find(function(t){return t.promptName===e});n&&(n.role=t,K.fq.saveSettings())},onToggle:function(e,t){var n=r.mainContextTemplatePresets[r.mainContextTemplatePreset].prompts.find(function(t){return t.promptName===e});n&&(n.enabled=t,K.fq.saveSettings())},onOrderChange:function(e){var t=e.map(function(e){return r.mainContextTemplatePresets[r.mainContextTemplatePreset].prompts.find(function(t){return t.promptName===e})}).filter(function(e){return void 0!==e});r.mainContextTemplatePresets[r.mainContextTemplatePreset].prompts=t,K.fq.saveSettings()}}),d=p.setList,h=p.getList,i=d,a=h,c.addEventListener("click",at(rt().m(function e(){return rt().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,B.globalContext.Popup.show.confirm("Restore default","Are you sure you want to restore the default prompt?");case 1:if(e.v){e.n=2;break}return e.a(2);case 2:r.mainContextTemplatePresets.default={prompts:K.a$.mainContextTemplatePresets.default.prompts},"default"!==s.value?(s.value="default",s.dispatchEvent(new Event("change"))):(d(r.mainContextTemplatePresets.default.prompts.map(function(e){var t=e.promptName;return r.prompts[e.promptName]&&(t="".concat(r.prompts[e.promptName].label," (").concat(e.promptName,")")),{enabled:e.enabled,id:e.promptName,label:t,selectOptions:[{value:"user",label:"User"},{value:"assistant",label:"Assistant"},{value:"system",label:"System"}],selectValue:e.role}})),K.fq.saveSettings());case 3:return e.a(2)}},e)}))),f=n.querySelector("#charCreator_systemPromptPreset"),m=n.querySelector("#charCreator_systemPromptContent"),g=n.querySelector("#charCreator_restoreSystemPromptDefault"),(0,M.Kq)("#charCreator_systemPromptPreset",{initialList:Object.keys(r.prompts),readOnlyValues:K.Yd,initialValue:K.Yd[0],label:function(e){if(""===e)return"prompt";var t=r.prompts[e];return t?"".concat(t.label," (").concat(e,")"):e},create:{onBeforeCreate:function(e){var t=(0,K.C$)(e);return t?!r.prompts[t]||((0,L.YC)("error","Prompt name already exists: ".concat(t)),!1):((0,L.YC)("error","Invalid prompt name: ".concat(e)),!1)},onAfterCreate:function(e){var t=(0,K.C$)(e);return r.prompts[t]={content:m.value,isDefault:!1,label:e},Object.entries(r.mainContextTemplatePresets).forEach(function(e){var n=et(e,2);n[0];n[1].prompts.push({enabled:!0,promptName:t,role:"user"})}),i([].concat(Qe(a()),[{enabled:!0,id:t,label:"".concat(e," (").concat(t,")"),selectOptions:[{value:"user",label:"User"},{value:"assistant",label:"Assistant"},{value:"system",label:"System"}],selectValue:"user"}])),t}},rename:{onBeforeRename:function(e,t){var n=(0,K.C$)(t);return n?!r.prompts[n]||((0,L.YC)("error","Prompt name already exists: ".concat(n)),!1):((0,L.YC)("error","Invalid prompt name: ".concat(t)),!1)},onAfterRename:function(e,t){var n=(0,K.C$)(t);return r.prompts[n]=Je(Je({},r.prompts[e]),{},{label:t}),delete r.prompts[e],Object.entries(r.mainContextTemplatePresets).forEach(function(t){var r=et(t,2);r[0];r[1].prompts.forEach(function(t){t.promptName===e&&(t.promptName=n)})}),i(a().map(function(r){return r.id===e?Je(Je({},r),{},{id:n,label:"".concat(t," (").concat(n,")")}):r})),n}},delete:{onAfterDelete:function(e){delete r.prompts[e],Object.entries(r.mainContextTemplatePresets).forEach(function(t){var n=et(t,2),r=(n[0],n[1]);r.prompts=r.prompts.filter(function(t){return t.promptName!==e})}),i(a().filter(function(t){return t.id!==e}))}},onSelectChange:function(e,t){var n,o=null!=t?t:"",i=r.prompts[o];i&&(m.value=null!==(n=i.content)&&void 0!==n?n:"",g.style.display=K.Yd.includes(o)?"block":"none",K.fq.saveSettings())}}),v=f.value,(y=r.prompts[v])&&(m.value=null!==(b=y.content)&&void 0!==b?b:"",g.style.display=K.Yd.includes(v)?"block":"none"),m.addEventListener("change",function(){var e=f.value,t=m.value,n=r.prompts[e];n&&(n.content=t,n.isDefault=!!K.Yd.includes(e)&&K.c9[e]===t,g.style.display=K.Yd.includes(e)?"block":"none",K.fq.saveSettings())}),g.addEventListener("click",at(rt().m(function e(){var t,n,o;return rt().w(function(e){for(;;)switch(e.n){case 0:if(t=f.value,n=K.c9[t],!(o=r.prompts[t])){e.n=2;break}return e.n=1,B.globalContext.Popup.show.confirm("Restore Default",'Are you sure you want to restore the default for "'.concat(o.label,'"?'));case 1:e.v&&(m.value=n,m.dispatchEvent(new Event("change"))),e.n=3;break;case 2:(0,L.YC)("warning","No prompt selected.");case 3:return e.a(2)}},e)}))),(S=n.querySelector("#charCreator_showSaveAsWorldInfo"))&&(S.checked=r.showSaveAsWorldInfoEntry.show,S.addEventListener("change",function(){r.showSaveAsWorldInfoEntry.show=S.checked,K.fq.saveSettings()})),n.querySelector("#charCreator_resetEverything").addEventListener("click",at(rt().m(function e(){return rt().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,B.globalContext.Popup.show.confirm("Reset Everything","Are you sure? This will reset all settings to default and clear your data in popup. This cannot be undone. This is a destructive action.");case 1:e.v&&(o.resetSession(),K.fq.resetSettings(),setTimeout(function(){(0,L.YC)("success","Everything has been reset to default. Please reload the page.")},1500));case 2:return e.a(2)}},e)})));case 3:return e.a(2)}},e)})),st.apply(this,arguments)}function lt(){return lt=at(rt().m(function e(){var t,n,r;return rt().w(function(e){for(;;)switch(e.n){case 0:n='<div class="menu_button fa-solid fa-user-astronaut interactable charCreator-icon" title="Character Creator"></div>',(r=null!==(t=document.getElementById("rm_buttons_container"))&&void 0!==t?t:document.getElementById("form_character_search_form"))&&$(r).prepend(n),$(".form_create_bottom_buttons_block").prepend(n),$("#GroupFavDelOkBack").prepend(n),document.querySelectorAll(".charCreator-icon").forEach(function(e){e.addEventListener("click",at(rt().m(function e(){var t,n,r,o,i,a,s,l,c,u,p,d,h,f,m,g,v,y,b,S,w,x,C,_,k,E,P,O,I,T,A,D,N,F,$,H,q,U,Y,V,W,G,X,z,J,Z,Q,ee,te,ne,re,oe,ie,ae,le,ce,ue,pe,de,he,fe,me,ve,ye,be,Se,we,xe,Ce,_e;return rt().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,B.globalContext.renderExtensionTemplateAsync("third-party/".concat(K.Zi),"templates/popup");case 1:if(c=e.v,B.globalContext.callGenericPopup(c,j.POPUP_TYPE.DISPLAY,void 0,{large:!0,wide:!0}),u=document.getElementById("charCreatorPopup")){e.n=2;break}return e.a(2);case 2:if(p=document.querySelector(".popup-button-close")){e.n=3;break}return e.a(2);case 3:p.style.right="0px",p.style.top="5px",d=K.fq.getSettings(),B.globalContext.ConnectionManagerRequestService.handleDropdown("#charCreatorPopup #charCreator_connectionProfile",d.profileId,function(e){var t;d.profileId=null!==(t=null==e?void 0:e.id)&&void 0!==t?t:"",K.fq.saveSettings()}),h=u.querySelector("#charCreator_stDescription"),f=u.querySelector("#charCreator_includePersona"),m=u.querySelector("#charCreator_includeChars"),g=u.querySelector("#charCreator_charIncludeContainer"),v=u.querySelector("#charCreator_includeWorldInfo"),y=u.querySelector("#charCreator_worldInfoIncludeContainer"),b=u.querySelector("#charCreator_includeExistingFields"),h.checked=d.contextToSend.stDescription,f.checked=d.contextToSend.persona,m.checked=d.contextToSend.charCard,b.checked=d.contextToSend.existingFields,v.checked=d.contextToSend.worldInfo,(S=u.querySelector("#charCreator_dontSendOtherGreetings")).checked=d.contextToSend.dontSendOtherGreetings,g.style.display=m.checked?"block":"none",y.style.display=v.checked?"block":"none",h.addEventListener("change",function(){d.contextToSend.stDescription=h.checked,K.fq.saveSettings()}),f.addEventListener("change",function(){d.contextToSend.persona=f.checked,K.fq.saveSettings()}),m.addEventListener("change",function(){d.contextToSend.charCard=m.checked,g.style.display=m.checked?"block":"none",K.fq.saveSettings()}),v.addEventListener("change",function(){d.contextToSend.worldInfo=v.checked,y.style.display=v.checked?"block":"none",K.fq.saveSettings()}),b.addEventListener("change",function(){d.contextToSend.existingFields=b.checked,K.fq.saveSettings()}),S.addEventListener("change",function(){d.contextToSend.dontSendOtherGreetings=S.checked,K.fq.saveSettings()}),w=u.querySelector(".message-options"),x=u.querySelector("#charCreator_messageType"),C=u.querySelector("#charCreator_firstX"),_=u.querySelector("#charCreator_lastX"),k=u.querySelector("#charCreator_rangeX"),E=u.querySelector("#charCreator_firstXMessages"),P=u.querySelector("#charCreator_lastXMessages"),O=u.querySelector("#charCreator_rangeStart"),I=u.querySelector("#charCreator_rangeEnd"),x.value=d.contextToSend.messages.type,E.value=String(null!==(t=d.contextToSend.messages.first)&&void 0!==t?t:10),P.value=String(null!==(n=d.contextToSend.messages.last)&&void 0!==n?n:10),O.value=String(null!==(r=null===(o=d.contextToSend.messages.range)||void 0===o?void 0:o.start)&&void 0!==r?r:0),I.value=String(null!==(i=null===(a=d.contextToSend.messages.range)||void 0===a?void 0:a.end)&&void 0!==i?i:10),(T=function(e){C.style.display="first"===e?"block":"none",_.style.display="last"===e?"block":"none",k.style.display="range"===e?"block":"none"})(x.value),void 0!==L.oP||L.Yb||(w.style.display="none"),x.addEventListener("change",function(){var e=x.value;d.contextToSend.messages.type=e,K.fq.saveSettings(),T(e)}),E.addEventListener("change",function(){d.contextToSend.messages.first=parseInt(E.value)||10,K.fq.saveSettings()}),P.addEventListener("change",function(){d.contextToSend.messages.last=parseInt(P.value)||10,K.fq.saveSettings()}),O.addEventListener("change",function(){var e,t;d.contextToSend.messages.range={start:parseInt(O.value)||0,end:null!==(e=null===(t=d.contextToSend.messages.range)||void 0===t?void 0:t.end)&&void 0!==e?e:10},K.fq.saveSettings()}),I.addEventListener("change",function(){var e,t;d.contextToSend.messages.range={start:null!==(e=null===(t=d.contextToSend.messages.range)||void 0===t?void 0:t.start)&&void 0!==e?e:0,end:parseInt(I.value)||10},K.fq.saveSettings()}),A=u.querySelector("#charCreator_maxContextType"),D=u.querySelector("#charCreator_maxTokens_container"),N=u.querySelector("#charCreator_maxTokens"),A.value=d.maxContextType,D.style.display="custom"===d.maxContextType?"block":"none",N.value=String(d.maxContextValue),A.addEventListener("change",function(){var e=A.value;d.maxContextType=e,K.fq.saveSettings(),D.style.display="custom"===e?"block":"none"}),N.addEventListener("change",function(){d.maxContextValue=Number(N.value)||16384,K.fq.saveSettings()}),(F=u.querySelector("#charCreator_maxResponseTokens")).value=String(d.maxResponseToken),F.addEventListener("change",function(){d.maxResponseToken=Number(F.value)||1024,K.fq.saveSettings()}),($=u.querySelector("#charCreator_outputFormat")).value=d.outputFormat,$.addEventListener("change",function(){d.outputFormat=$.value,K.fq.saveSettings()}),H=R.SessionService.getInstance(),q=H.getSession(),U=SillyTavern.getContext(),q.selectedCharacterIndexes=q.selectedCharacterIndexes.filter(function(e){return U.characters[Number(e)]}),u.querySelector("#charCreator_characterSelector")&&(Y=U.characters.map(function(e){return{value:U.characters.indexOf(e).toString(),label:e.name}}),V=(0,M.dK)("#charCreator_characterSelector",{initialList:Y,initialValues:q.selectedCharacterIndexes,placeholderText:"Select characters...",enableSearch:Y.length>10,onSelectChange:function(e,t){H.updateSession({selectedCharacterIndexes:t})}}),u.querySelector("#charCreator_clear-includeChars-button").addEventListener("click",function(){V.deselectAll()})),W=u.querySelector("#charCreator_worldInfoSelector"),G=structuredClone(L.c3);try{W&&G.length>0?(0,M.dK)("#charCreator_worldInfoSelector",{initialList:G,initialValues:q.selectedWorldNames,placeholderText:"Select lorebooks...",enableSearch:G.length>10,onSelectChange:function(e,t){H.updateSession({selectedWorldNames:t})}}):W&&(W.textContent="No active lorebooks found.")}catch(e){console.error("Failed to get active world info:",e),W&&(W.textContent="Error loading lorebooks.")}X=u.querySelector("#charCreator_prompt"),(0,M.Kq)("#charCreatorPopup #charCreator_promptPreset",{initialValue:d.promptPreset,initialList:Object.keys(d.promptPresets),readOnlyValues:["default"],onSelectChange:function(){var e=at(rt().m(function e(t,n){var r,o,i;return rt().w(function(e){for(;;)switch(e.n){case 0:i=null!=n?n:"default",d.promptPreset=i,K.fq.saveSettings(),X.value=null!==(r=null===(o=d.promptPresets[i])||void 0===o?void 0:o.content)&&void 0!==r?r:"";case 1:return e.a(2)}},e)}));return function(t,n){return e.apply(this,arguments)}}(),create:{onAfterCreate:function(e){var t,n=d.promptPresets[d.promptPreset];d.promptPresets[e]={content:null!==(t=null==n?void 0:n.content)&&void 0!==t?t:""}}},rename:{onAfterRename:function(e,t){d.promptPresets[t]=d.promptPresets[e],delete d.promptPresets[e]}},delete:{onAfterDelete:function(e){delete d.promptPresets[e]}}}),X.value=null!==(s=null===(l=d.promptPresets[d.promptPreset])||void 0===l?void 0:l.content)&&void 0!==s?s:"",X.addEventListener("change",function(){d.promptPresets[d.promptPreset]&&(d.promptPresets[d.promptPreset].content=X.value,K.fq.saveSettings())}),z={name:{label:B.CHARACTER_LABELS.name,rows:1,large:!1,promptEnabled:!1},description:{label:B.CHARACTER_LABELS.description,rows:5,large:!0,promptEnabled:!0},personality:{label:B.CHARACTER_LABELS.personality,rows:4,large:!0,promptEnabled:!0},scenario:{label:B.CHARACTER_LABELS.scenario,rows:3,large:!0,promptEnabled:!0},first_mes:{label:B.CHARACTER_LABELS.first_mes,rows:3,large:!0,promptEnabled:!0},mes_example:{label:B.CHARACTER_LABELS.mes_example,rows:6,large:!0,promptEnabled:!0}},J=u.querySelector("#charCreator_coreFieldTemplate"),Z=u.querySelector("#charCreator_draftFieldTemplate"),Q=u.querySelector("#charCreator_coreFieldsContainer"),ee=u.querySelector("#charCreator_draftFieldsList"),te=u.querySelectorAll(".tab-button"),ne=u.querySelectorAll(".tab-content"),re=u.querySelector("#charCreator_addDraftField"),oe=u.querySelector("#charCreator_exportDraftFields"),ie=u.querySelector("#charCreator_importDraftFields"),ae={},le=function(e){te.forEach(function(t){t.classList.toggle("active",t.getAttribute("data-tab")===e)}),ne.forEach(function(t){t.classList.toggle("active",t.id===e)});var t="charCreator_draftFieldsContainer"===e;if(re.style.display=t?"block":"none",oe.style.display=t?"block":"none",ie.style.display=t?"block":"none","charCreator_chatContainer"===e){var n=document.querySelector("#charCreator_chatContainer");n&&!n.querySelector("#chat_container")&&Ne()}},te.forEach(function(e){e.addEventListener("click",function(){var t=e.getAttribute("data-tab");t&&le(t)})}),le("charCreator_coreFieldsContainer"),ce=function(){return Object.keys(q.fields).filter(function(e){return e.startsWith("alternate_greetings_")}).sort(function(e,t){return parseInt(e.split("_")[2]||"1")-parseInt(t.split("_")[2]||"1")})},ue=0,pe=function(e){var t,n,r,o,i,a,s=u.querySelector("#charCreator_alternateGreetingTabContentTemplate"),l=e.querySelector(".alternate-greetings-tabs"),c=e.querySelector(".alternate-greetings-content-area"),p=e.querySelector(".no-greetings-placeholder"),d=e.querySelector(".add-alternate-greeting-button"),h=e.querySelector(".delete-alternate-greeting-button"),f=e.querySelector(".field-container > div:last-child"),m=null==f?void 0:f.querySelector(".generate-alternate-greeting-button"),g=null==f?void 0:f.querySelector(".continue-alternate-greeting-button"),v=null==f?void 0:f.querySelector(".compare-alternate-greeting-button"),y=null==f?void 0:f.querySelector(".clear-alternate-greeting-button");l.innerHTML="",c.innerHTML="";var b=ce(),S=function(e){ue=e,l.querySelectorAll(".alternate-greeting-tab-button").forEach(function(t,n){t.classList.toggle("active",n===e)}),c.querySelectorAll(".alternate-greeting-tab-content").forEach(function(t,n){t.style.display=n===e?"block":"none"});var t=b.length>0;m.disabled=!t,g.disabled=!t,v.disabled=!t,y.disabled=!t,h.disabled=!t};0===b.length?(p.style.display="block",c.style.display="none",m.disabled=!0,y.disabled=!0,h.disabled=!0):(p.style.display="none",c.style.display="block",b.forEach(function(e,t){var n,r,o=q.fields[e];if(o){var i=document.createElement("button");i.className="menu_button alternate-greeting-tab-button";var a=parseInt(e.split("_")[2])||1;i.textContent="Greeting ".concat(a),i.dataset.index=t.toString(),i.addEventListener("click",function(){return S(t)}),l.appendChild(i);var u=s.content.cloneNode(!0),p=u.querySelector(".alternate-greeting-textarea"),d=u.querySelector(".alternate-greeting-prompt-textarea");p.value=null!==(n=o.value)&&void 0!==n?n:"",d.value=null!==(r=o.prompt)&&void 0!==r?r:"",p.rows=8,p.addEventListener("change",function(){H.updateField(e,{value:p.value})}),d.addEventListener("change",function(){H.updateField(e,{prompt:d.value})}),c.appendChild(u)}}),S(0));var w=d.cloneNode(!0);null===(t=d.parentNode)||void 0===t||t.replaceChild(w,d);var x=h.cloneNode(!0);null===(n=h.parentNode)||void 0===n||n.replaceChild(x,h);var C=m.cloneNode(!0);null===(r=m.parentNode)||void 0===r||r.replaceChild(C,m);var _=g.cloneNode(!0);null===(o=g.parentNode)||void 0===o||o.replaceChild(_,g);var k=v.cloneNode(!0);null===(i=v.parentNode)||void 0===i||i.replaceChild(k,v);var E=y.cloneNode(!0);null===(a=y.parentNode)||void 0===a||a.replaceChild(E,y),w.addEventListener("click",function(){var t=b.length+1,n="alternate_greetings_".concat(t);H.updateField(n,{prompt:"",value:"",label:"Alternate Greeting ".concat(t)}),pe(e),S(b.length)}),x.addEventListener("click",at(rt().m(function t(){var n,r,o;return rt().w(function(t){for(;;)switch(t.n){case 0:if(!(ue<0||ue>=b.length)){t.n=1;break}return t.a(2);case 1:return n=b[ue],t.n=2,B.globalContext.Popup.show.confirm("Delete Greeting","Are you sure you want to delete Greeting ".concat(ue+1,"? This cannot be undone."));case 2:t.v&&(delete(r=H.getSession()).fields[n],b.slice(ue+1).forEach(function(e,t){var n=ue+t+1,o="alternate_greetings_".concat(n);e!==o&&(r.fields[o]=r.fields[e],r.fields[o].label="Alternate Greeting ".concat(n),delete r.fields[e])}),H.updateSession({fields:r.fields}),pe(e),(o=ce()).length>0&&S(Math.min(ue,o.length-1)));case 3:return t.a(2)}},t)}))),C.addEventListener("click",function(){if(!(ue<0||ue>=b.length)){var e=b[ue],t=c.querySelectorAll(".alternate-greeting-tab-content")[ue],n=null==t?void 0:t.querySelector(".alternate-greeting-textarea");ge.handleFieldGeneration({targetField:e,button:C,textarea:n,isDraft:!1})}}),_.addEventListener("click",function(){if(!(ue<0||ue>=b.length)){var e=b[ue],t=c.querySelectorAll(".alternate-greeting-tab-content")[ue],n=null==t?void 0:t.querySelector(".alternate-greeting-textarea");null!=n&&n.value.trim()?ge.handleFieldGeneration({targetField:e,button:_,textarea:n,isDraft:!1,continueFrom:n.value}):(0,L.YC)("warning","No content to continue from")}}),k.addEventListener("click",function(){var e,t,n,r;if(!(ue<0||ue>=b.length)){var o=b[ue],i=c.querySelectorAll(".alternate-greeting-tab-content")[ue],a=null==i?void 0:i.querySelector(".alternate-greeting-textarea");if(null!=a&&a.value.trim()){var s=null===(e=ye)||void 0===e||null===(e=e.getValues())||void 0===e?void 0:e[0];if(s){var l=U.characters[parseInt(s)];if(l){var u=null!==(r=(null!==(t=null===(n=l.data)||void 0===n?void 0:n.alternate_greetings)&&void 0!==t?t:[])[ue])&&void 0!==r?r:"";ge.handleFieldComparison(o,a.value,u)}else(0,L.YC)("warning","Selected character not found.")}else(0,L.YC)("warning","Please select a character first to compare against.")}else(0,L.YC)("warning","No content to compare")}}),E.addEventListener("click",function(){if(!(ue<0||ue>=b.length)){var e=b[ue],t=c.querySelectorAll(".alternate-greeting-tab-content")[ue],n=null==t?void 0:t.querySelector(".alternate-greeting-textarea");null==t||t.querySelector(".alternate-greeting-prompt-textarea");q.fields[e]&&(n.value="",H.updateField(e,{value:""}))}})},B.CHARACTER_FIELDS.forEach(function(e){var t,n;if(e in z){var r=z[e],o=J.content.cloneNode(!0),i=o.querySelector("label"),a=o.querySelector(".field-value-textarea"),s=o.querySelector(".generate-field-button"),l=o.querySelector(".continue-field-button"),c=o.querySelector(".clear-field-button"),u=o.querySelector(".field-prompt-textarea");a.id="charCreator_field_".concat(e),u.id="charCreator_prompt_".concat(e),i.textContent=r.label,i.htmlFor=a.id,a.rows=r.rows;var p,d,h=q.fields[e];if(a.value=null!==(t=null==h?void 0:h.value)&&void 0!==t?t:"",s.dataset.field=e,s.title="Generate ".concat(r.label),u.placeholder="Enter additional prompt for ".concat(r.label.toLowerCase(),"..."),u.value=null!==(n=null==h?void 0:h.prompt)&&void 0!==n?n:"",!r.promptEnabled)null===(p=u.closest(".field-prompt-container"))||void 0===p||p.remove();if(r.large)null===(d=a.closest(".field-container"))||void 0===d||d.classList.add("large-field");null==c||c.addEventListener("click",function(){a.value="",a.dispatchEvent(new Event("change"))}),ae[e]={textarea:a,button:s,continueButton:l,promptTextarea:u,clearButton:c},Q.appendChild(o)}else console.warn("Skipping unknown core field: ".concat(e))}),de=u.querySelector("#charCreator_alternateGreetingsTemplate"),he=de.content.cloneNode(!0),fe=he.querySelector(".alternate-greetings-field"),Q.appendChild(he),pe(fe),me=function(e,t){var n,r;if(Z&&ee){var o=Z.content.cloneNode(!0),i=o.querySelector(".character-field"),a=o.querySelector("label"),s=o.querySelector(".field-value-textarea"),l=o.querySelector(".field-prompt-textarea"),c=o.querySelector(".delete-draft-field-button"),u=o.querySelector(".generate-field-button"),p=o.querySelector(".continue-field-button"),d=o.querySelector(".clear-field-button");i.dataset.draftFieldName=e,a.textContent=t.label,a.htmlFor="charCreator_draft_field_".concat(e),s.id="charCreator_draft_field_".concat(e),s.value=null!==(n=t.value)&&void 0!==n?n:"",l.value=null!==(r=t.prompt)&&void 0!==r?r:"",l.id="charCreator_draft_prompt_".concat(e),l.placeholder="Enter additional prompt for ".concat(t.label,"..."),c.dataset.draftFieldName=e,u.dataset.field=e,d.dataset.draftFieldName=e,s.addEventListener("change",ge.createTextChangeHandler(e,!0)),l.addEventListener("change",ge.createPromptChangeHandler(e,!0)),d.addEventListener("click",function(){s.value="",H.updateDraftField(e,{value:""})}),c.addEventListener("click",at(rt().m(function n(){return rt().w(function(n){for(;;)switch(n.n){case 0:return n.n=1,ge.showConfirmation("Delete Draft Field",'Are you sure you want to delete the draft field "'.concat(t.label,'"? This cannot be undone.'));case 1:n.v&&(H.deleteDraftField(e),i.remove());case 2:return n.a(2)}},n)}))),u.addEventListener("click",function(){ge.handleFieldGeneration({targetField:e,button:u,textarea:s,isDraft:!0})}),p.addEventListener("click",function(){s.value.trim()?ge.handleFieldGeneration({targetField:e,button:p,textarea:s,isDraft:!0,continueFrom:s.value}):(0,L.YC)("warning","No content to continue from")}),ee.appendChild(o)}},(ve=function(){ee&&(ee.innerHTML="",Object.entries(q.draftFields||{}).forEach(function(e){var t=et(e,2),n=t[0],r=t[1];me(n,r)}))})(),null==oe||oe.addEventListener("click",function(){se.getInstance().exportDraftFields()}),null==ie||ie.addEventListener("click",at(rt().m(function e(){var t;return rt().w(function(e){for(;;)switch(e.n){case 0:(t=document.createElement("input")).type="file",t.accept=".json",t.addEventListener("change",at(rt().m(function e(){var n,r,o,i;return rt().w(function(e){for(;;)switch(e.p=e.n){case 0:if(r=null===(n=t.files)||void 0===n?void 0:n[0]){e.n=1;break}return e.a(2);case 1:return e.p=1,o=se.getInstance(),e.n=2,o.importDraftFields(r);case 2:ve(),e.n=4;break;case 3:e.p=3,i=e.v,(0,L.YC)("error","Failed to import draft fields: ".concat(i.message));case 4:return e.a(2)}},e,null,[[1,3]])}))),t.click();case 1:return e.a(2)}},e)}))),re&&re.addEventListener("click",at(rt().m(function e(){var t,n,r;return rt().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,ge.showInput("Enter Draft Field Name","");case 1:if((t=e.v)&&t.trim()){e.n=2;break}return e.a(2);case 2:if(n=(0,K.C$)(t.trim())){e.n=3;break}return(0,L.YC)("error","Invalid field name provided."),e.a(2);case 3:if(!q.draftFields[n]&&!B.CHARACTER_LABELS[n]){e.n=4;break}return(0,L.YC)("warning",'Field name "'.concat(n,'" already exists.')),e.a(2);case 4:H.updateDraftField(n,{value:"",prompt:"",label:t}),r=H.getSession(),me(n,r.draftFields[n]);case 5:return e.a(2)}},e)}))),ye=null,u.querySelector("#charCreator_loadCharSelector")&&(be=U.characters.map(function(e){return{value:U.characters.indexOf(e).toString(),label:e.name}}),Se=q.lastLoadedCharacterId?U.characters.findIndex(function(e){return e.avatar===q.lastLoadedCharacterId}):-1,we=Se>=0?[Se.toString()]:[],ye=(0,M.dK)("#charCreator_loadCharSelector",{initialList:be,initialValues:we,placeholderText:"Load Character Data...",enableSearch:be.length>10,multiple:!1,closeOnSelect:!0,onBeforeSelection:function(e,t){return at(rt().m(function e(){return rt().w(function(e){for(;;)switch(e.n){case 0:if(0!==t.length){e.n=1;break}return e.a(2,!1);case 1:if(0!==t[0].length){e.n=2;break}return e.a(2,!1);case 2:if(B.CHARACTER_FIELDS.every(function(e){var t,n=null===(t=ae[e])||void 0===t?void 0:t.textarea;return n&&""===n.value.trim()})){e.n=4;break}return e.n=3,B.globalContext.Popup.show.confirm("Load Character Data","Are you sure you want to overwrite existing data? This cannot be undone.");case 3:if(e.v){e.n=4;break}return e.a(2,!1);case 4:return e.a(2,!0)}},e)}))()},onSelectChange:function(){var e=at(rt().m(function e(t,n){var r,o,i,a,s;return rt().w(function(e){for(;;)switch(e.p=e.n){case 0:if(0!==n.length){e.n=1;break}return e.a(2);case 1:if(0!==(r=n[0]).length){e.n=2;break}return e.a(2);case 2:return e.p=2,o=se.getInstance(),e.n=3,o.loadCharacter(r);case 3:i=H.getSession(),B.CHARACTER_FIELDS.forEach(function(e){var t=ae[e];if(t){var n=t.textarea,r=t.promptTextarea,o=i.fields[e];n&&o&&(n.value=o.value||""),r&&o&&(r.value=o.prompt||"")}}),(a=null==Q?void 0:Q.querySelector(".alternate-greetings-field"))&&pe(a),e.n=5;break;case 4:e.p=4,s=e.v,(0,L.YC)("error","Failed to load character: ".concat(s.message));case 5:return e.a(2)}},e,null,[[2,4]])}));return function(t,n){return e.apply(this,arguments)}}()})),u.querySelector("#charCreator_reset").addEventListener("click",at(rt().m(function e(){var t,n,r;return rt().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.n=1,ge.showConfirmation("Reset Fields","Are you sure? This will reset core fields and remove draft fields. This cannot be undone.");case 1:if(!e.v){e.n=5;break}return e.p=2,t=se.getInstance(),e.n=3,t.resetFields();case 3:B.CHARACTER_FIELDS.forEach(function(e){var t=ae[e];t&&(t.textarea&&(t.textarea.value=""),t.promptTextarea&&(t.promptTextarea.value=""))}),(n=null==Q?void 0:Q.querySelector(".alternate-greetings-field"))&&pe(n),ye.deselectAll(),ve(),e.n=5;break;case 4:e.p=4,r=e.v,(0,L.YC)("error","Failed to reset fields: ".concat(r.message));case 5:return e.a(2)}},e,null,[[2,4]])}))),u.querySelector("#charCreator_loadCurrentCharacter").addEventListener("click",at(rt().m(function e(){var t,n,r,o,i,a,s;return rt().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,void 0!==L.oP&&null!==L.oP&&""!==L.oP){e.n=1;break}return(0,L.YC)("error","No character is currently selected in SillyTavern."),e.a(2);case 1:if(t=B.globalContext,n=parseInt(L.oP.toString()),r=t.characters[n]){e.n=2;break}return(0,L.YC)("error","Current character not found."),e.a(2);case 2:return e.n=3,ge.showConfirmation("Load Current Character",'Load data from "'.concat(r.name,'"? This will replace any existing field content.'));case 3:if(e.v){e.n=4;break}return e.a(2);case 4:return o=se.getInstance(),e.n=5,o.loadCharacter(L.oP.toString());case 5:i=H.getSession(),B.CHARACTER_FIELDS.forEach(function(e){var t=ae[e];if(t){var n=t.textarea,r=t.promptTextarea,o=i.fields[e];n&&o&&(n.value=o.value||""),r&&o&&(r.value=o.prompt||"")}}),(a=null==Q?void 0:Q.querySelector(".alternate-greetings-field"))&&pe(a),ye&&ye.setValues([L.oP.toString()]),(0,L.YC)("success",'Successfully loaded character "'.concat(r.name,'"')),e.n=7;break;case 6:e.p=6,s=e.v,(0,L.YC)("error","Failed to load current character: ".concat(s.message));case 7:return e.a(2)}},e,null,[[0,6]])}))),u.querySelector("#charCreator_saveAsNewCharacter").addEventListener("click",at(rt().m(function e(){var t,n;return rt().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.n=1,ge.showConfirmation("Save as New Character","Are you sure?");case 1:if(e.v){e.n=2;break}return e.a(2);case 2:return e.p=2,t=se.getInstance(),e.n=3,t.saveCharacter({asNew:!0});case 3:e.n=5;break;case 4:e.p=4,n=e.v,(0,L.YC)("error","Failed to create character: ".concat(n.message));case 5:return e.a(2)}},e,null,[[2,4]])}))),u.querySelector("#charCreator_overrideCharacter").addEventListener("click",at(rt().m(function e(){var t,n,r,o,i;return rt().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=null===(t=ye)||void 0===t||null===(t=t.getValues())||void 0===t?void 0:t[0]){e.n=1;break}return(0,L.YC)("warning","Please load a character first to override."),e.a(2);case 1:if(r=U.characters[parseInt(n)]){e.n=2;break}return(0,L.YC)("warning","Selected character not found for override."),e.a(2);case 2:return e.n=3,ge.showConfirmation("Override Character",'Are you sure you want to override "'.concat(r.name,'"? This cannot be undone.'));case 3:if(e.v){e.n=4;break}return e.a(2);case 4:return e.p=4,o=se.getInstance(),e.n=5,o.saveCharacter({asNew:!1,selectedCharacterId:n});case 5:e.n=7;break;case 6:e.p=6,i=e.v,(0,L.YC)("error","Failed to override character: ".concat(i.message));case 7:return e.a(2)}},e,null,[[4,6]])}))),xe=u.querySelector("#charCreator_saveAsWorldInfoSelector"),d.showSaveAsWorldInfoEntry.show?(Ce=(0,M.dK)(xe,{placeholderText:"Save as World Info Entry",initialList:L.c3,closeOnSelect:!0,multiple:!1,enableSearch:!0,onBeforeSelection:function(e,t){return at(rt().m(function e(){var n,r,o;return rt().w(function(e){for(;;)switch(e.p=e.n){case 0:if(0!==t.length){e.n=1;break}return e.a(2,!1);case 1:return n=t[0],e.p=2,r=se.getInstance(),e.n=3,r.saveAsWorldInfo({selectedWorldName:n});case 3:e.n=5;break;case 4:e.p=4,o=e.v,(0,L.YC)("error","Failed to create world info entry: ".concat(o.message));case 5:return _e(),e.a(2,!1)}},e,null,[[2,4]])}))()}}),_e=Ce.close):xe.style.display="none",Object.entries(ae).forEach(function(e){var t,n=et(e,2),r=n[0],o=n[1],i=o.textarea,a=o.button,s=o.continueButton,l=o.promptTextarea,c=null===(t=i.closest(".field-container"))||void 0===t?void 0:t.querySelector(".compare-field-button");c&&c.addEventListener("click",at(rt().m(function e(){var t,n,o,a,s,l,c;return rt().w(function(e){for(;;)switch(e.n){case 0:return l=null===(t=ye)||void 0===t||null===(t=t.getValues())||void 0===t?void 0:t[0],c=l&&null!==(n=null!==(o=null===(a=U.characters[parseInt(l)])||void 0===a?void 0:a[r])&&void 0!==o?o:null===(s=U.characters[parseInt(l)])||void 0===s||null===(s=s.data)||void 0===s?void 0:s[r])&&void 0!==n?n:"",e.n=1,ge.handleFieldComparison(r,i.value,c);case 1:return e.a(2)}},e)}))),s&&s.addEventListener("click",function(){i.value.trim()?ge.handleFieldGeneration({targetField:r,button:s,textarea:i,continueFrom:i.value,isDraft:!1}):(0,L.YC)("warning","No content to continue from")}),a&&(a.addEventListener("click",function(){ge.handleFieldGeneration({targetField:r,button:a,textarea:i,isDraft:!1})}),i.addEventListener("change",ge.createTextChangeHandler(r,!1)),l&&l.addEventListener("change",ge.createPromptChangeHandler(r,!1)))});case 4:return e.a(2)}},e)})))});case 1:return e.a(2)}},e)})),lt.apply(this,arguments)}function ct(){!function(){st.apply(this,arguments)}(),function(){lt.apply(this,arguments)}(),De()}z.helpers.join||z.registerHelper("join",function(e,t){return Array.isArray(e)?e.join("string"==typeof t?t:", "):""}),B.globalContext.ConnectionManagerRequestService?(0,K.Yq)().then(function(){ct()}):(0,L.YC)("error","[".concat(K.Zi,"] Make sure ST is updated."));
//# sourceMappingURL=index.js.map